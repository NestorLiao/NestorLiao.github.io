<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="" class="TridactylThemeAuto tndoyml idc0_343" style="scroll-behavior: unset;"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Beej's Guide to Network Concepts</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!-- BG custom styling -->
  <style type="text/css">
  /* Fix for line numbers not visible */
  pre.numberSource code > span {
      left: -1em;
  }
  pre.numberSource {
      margin-left: initial;
  }

  /* Put some space after the section numbers */
  span.toc-section-number::after {
      content: "\a0\a0\a0";  /* non-breaking whitespace */
  }

  /* Hide underlines on code number links */
  pre > code.sourceCode > span > a:first-child::before {
      text-decoration: none;
  }

  /* Color the source blocks */
  div.sourceCode {
      background-color: #f0f0f0;
  }

  /* Fix iOS big text rendering issue */
  pre > code.sourceCode > span {
      display: initial;
  }


  /* Color the inline code */
  code:not(.sourceCode) {
      background: #f0f0f0;
      padding-left: 0.2em;
      padding-right: 0.2em;
      border-radius: 0.2em;
  }

  pre.sourceCode {
      border: 1px solid #ccc;
      padding: 0.5em;
      border-radius: 0.2em;
  }

  /* Keep code tags from wrapping in tables */
  tbody code {
      white-space: nowrap;
  }

  /* Prevent hyphenation and hyphen breaks in code*/
  code {
      word-break: keep-all;
  }

  td {
      vertical-align: top;
  }

  body {
      font-size: 12pt;
      max-width: 43em;
      font-family: sans-serif;
  }

  html {
      background: #f9f9f9;
  }

  figure > embed {
      max-width: 100%;
  }

  figure {
      text-align: center;
      margin-top: 2em;
      margin-bottom: 2em;
  }

  figcaption {
      font-size: 0.9em;
      font-style: italic;
      margin-top: 0.6em;
  }

  body {
      counter-reset: figure-counter-major;
      counter-reset: figure-counter-minor;
  }

  figure {
      counter-increment: figure-counter-minor;
  }

  figcaption::before {
      content: "Figure " counter(figure-counter-major) "." counter(figure-counter-minor) ": ";
  }

  blockquote {
      border-left: 2px solid #bbb;
      color: #444;
  }

  /*
  In multipage, we need to reset the figure counter to the chapter
  number. Luckily, this is in the <h1 data-number> attribute. Unluckily,
  there is no way to get this in a general way.

  This doesn't work:

    h1[data-number] {
      counter-set: figure-counter-major attr(data-number);
    }

  Nor this:

    h1[data-number] {
      --figure-counter-major-value: attr(data-number);
      counter-set: figure-counter-major var(--figure-counter-major-value);
    }

  So, dumbly, we have a bunch of rules for all these sections, up to the
  maximum possible section.

  Here's a program to generate them:

    for (let i = 1; i < 100; i++)
        console.log(`h1[data-number="${i}"]{counter-set:figure-counter-major ${i};counter-reset:figure-counter-minor;}`);

  Note to self: never write a book with more than 99 frickin' chapters.
  */

  h1[data-number="1"]{counter-set:figure-counter-major 1;counter-reset:figure-counter-minor;}
  h1[data-number="2"]{counter-set:figure-counter-major 2;counter-reset:figure-counter-minor;}
  h1[data-number="3"]{counter-set:figure-counter-major 3;counter-reset:figure-counter-minor;}
  h1[data-number="4"]{counter-set:figure-counter-major 4;counter-reset:figure-counter-minor;}
  h1[data-number="5"]{counter-set:figure-counter-major 5;counter-reset:figure-counter-minor;}
  h1[data-number="6"]{counter-set:figure-counter-major 6;counter-reset:figure-counter-minor;}
  h1[data-number="7"]{counter-set:figure-counter-major 7;counter-reset:figure-counter-minor;}
  h1[data-number="8"]{counter-set:figure-counter-major 8;counter-reset:figure-counter-minor;}
  h1[data-number="9"]{counter-set:figure-counter-major 9;counter-reset:figure-counter-minor;}
  h1[data-number="10"]{counter-set:figure-counter-major 10;counter-reset:figure-counter-minor;}
  h1[data-number="11"]{counter-set:figure-counter-major 11;counter-reset:figure-counter-minor;}
  h1[data-number="12"]{counter-set:figure-counter-major 12;counter-reset:figure-counter-minor;}
  h1[data-number="13"]{counter-set:figure-counter-major 13;counter-reset:figure-counter-minor;}
  h1[data-number="14"]{counter-set:figure-counter-major 14;counter-reset:figure-counter-minor;}
  h1[data-number="15"]{counter-set:figure-counter-major 15;counter-reset:figure-counter-minor;}
  h1[data-number="16"]{counter-set:figure-counter-major 16;counter-reset:figure-counter-minor;}
  h1[data-number="17"]{counter-set:figure-counter-major 17;counter-reset:figure-counter-minor;}
  h1[data-number="18"]{counter-set:figure-counter-major 18;counter-reset:figure-counter-minor;}
  h1[data-number="19"]{counter-set:figure-counter-major 19;counter-reset:figure-counter-minor;}
  h1[data-number="20"]{counter-set:figure-counter-major 20;counter-reset:figure-counter-minor;}
  h1[data-number="21"]{counter-set:figure-counter-major 21;counter-reset:figure-counter-minor;}
  h1[data-number="22"]{counter-set:figure-counter-major 22;counter-reset:figure-counter-minor;}
  h1[data-number="23"]{counter-set:figure-counter-major 23;counter-reset:figure-counter-minor;}
  h1[data-number="24"]{counter-set:figure-counter-major 24;counter-reset:figure-counter-minor;}
  h1[data-number="25"]{counter-set:figure-counter-major 25;counter-reset:figure-counter-minor;}
  h1[data-number="26"]{counter-set:figure-counter-major 26;counter-reset:figure-counter-minor;}
  h1[data-number="27"]{counter-set:figure-counter-major 27;counter-reset:figure-counter-minor;}
  h1[data-number="28"]{counter-set:figure-counter-major 28;counter-reset:figure-counter-minor;}
  h1[data-number="29"]{counter-set:figure-counter-major 29;counter-reset:figure-counter-minor;}
  h1[data-number="30"]{counter-set:figure-counter-major 30;counter-reset:figure-counter-minor;}
  h1[data-number="31"]{counter-set:figure-counter-major 31;counter-reset:figure-counter-minor;}
  h1[data-number="32"]{counter-set:figure-counter-major 32;counter-reset:figure-counter-minor;}
  h1[data-number="33"]{counter-set:figure-counter-major 33;counter-reset:figure-counter-minor;}
  h1[data-number="34"]{counter-set:figure-counter-major 34;counter-reset:figure-counter-minor;}
  h1[data-number="35"]{counter-set:figure-counter-major 35;counter-reset:figure-counter-minor;}
  h1[data-number="36"]{counter-set:figure-counter-major 36;counter-reset:figure-counter-minor;}
  h1[data-number="37"]{counter-set:figure-counter-major 37;counter-reset:figure-counter-minor;}
  h1[data-number="38"]{counter-set:figure-counter-major 38;counter-reset:figure-counter-minor;}
  h1[data-number="39"]{counter-set:figure-counter-major 39;counter-reset:figure-counter-minor;}
  h1[data-number="40"]{counter-set:figure-counter-major 40;counter-reset:figure-counter-minor;}
  h1[data-number="41"]{counter-set:figure-counter-major 41;counter-reset:figure-counter-minor;}
  h1[data-number="42"]{counter-set:figure-counter-major 42;counter-reset:figure-counter-minor;}
  h1[data-number="43"]{counter-set:figure-counter-major 43;counter-reset:figure-counter-minor;}
  h1[data-number="44"]{counter-set:figure-counter-major 44;counter-reset:figure-counter-minor;}
  h1[data-number="45"]{counter-set:figure-counter-major 45;counter-reset:figure-counter-minor;}
  h1[data-number="46"]{counter-set:figure-counter-major 46;counter-reset:figure-counter-minor;}
  h1[data-number="47"]{counter-set:figure-counter-major 47;counter-reset:figure-counter-minor;}
  h1[data-number="48"]{counter-set:figure-counter-major 48;counter-reset:figure-counter-minor;}
  h1[data-number="49"]{counter-set:figure-counter-major 49;counter-reset:figure-counter-minor;}
  h1[data-number="50"]{counter-set:figure-counter-major 50;counter-reset:figure-counter-minor;}
  h1[data-number="51"]{counter-set:figure-counter-major 51;counter-reset:figure-counter-minor;}
  h1[data-number="52"]{counter-set:figure-counter-major 52;counter-reset:figure-counter-minor;}
  h1[data-number="53"]{counter-set:figure-counter-major 53;counter-reset:figure-counter-minor;}
  h1[data-number="54"]{counter-set:figure-counter-major 54;counter-reset:figure-counter-minor;}
  h1[data-number="55"]{counter-set:figure-counter-major 55;counter-reset:figure-counter-minor;}
  h1[data-number="56"]{counter-set:figure-counter-major 56;counter-reset:figure-counter-minor;}
  h1[data-number="57"]{counter-set:figure-counter-major 57;counter-reset:figure-counter-minor;}
  h1[data-number="58"]{counter-set:figure-counter-major 58;counter-reset:figure-counter-minor;}
  h1[data-number="59"]{counter-set:figure-counter-major 59;counter-reset:figure-counter-minor;}
  h1[data-number="60"]{counter-set:figure-counter-major 60;counter-reset:figure-counter-minor;}
  h1[data-number="61"]{counter-set:figure-counter-major 61;counter-reset:figure-counter-minor;}
  h1[data-number="62"]{counter-set:figure-counter-major 62;counter-reset:figure-counter-minor;}
  h1[data-number="63"]{counter-set:figure-counter-major 63;counter-reset:figure-counter-minor;}
  h1[data-number="64"]{counter-set:figure-counter-major 64;counter-reset:figure-counter-minor;}
  h1[data-number="65"]{counter-set:figure-counter-major 65;counter-reset:figure-counter-minor;}
  h1[data-number="66"]{counter-set:figure-counter-major 66;counter-reset:figure-counter-minor;}
  h1[data-number="67"]{counter-set:figure-counter-major 67;counter-reset:figure-counter-minor;}
  h1[data-number="68"]{counter-set:figure-counter-major 68;counter-reset:figure-counter-minor;}
  h1[data-number="69"]{counter-set:figure-counter-major 69;counter-reset:figure-counter-minor;}
  h1[data-number="70"]{counter-set:figure-counter-major 70;counter-reset:figure-counter-minor;}
  h1[data-number="71"]{counter-set:figure-counter-major 71;counter-reset:figure-counter-minor;}
  h1[data-number="72"]{counter-set:figure-counter-major 72;counter-reset:figure-counter-minor;}
  h1[data-number="73"]{counter-set:figure-counter-major 73;counter-reset:figure-counter-minor;}
  h1[data-number="74"]{counter-set:figure-counter-major 74;counter-reset:figure-counter-minor;}
  h1[data-number="75"]{counter-set:figure-counter-major 75;counter-reset:figure-counter-minor;}
  h1[data-number="76"]{counter-set:figure-counter-major 76;counter-reset:figure-counter-minor;}
  h1[data-number="77"]{counter-set:figure-counter-major 77;counter-reset:figure-counter-minor;}
  h1[data-number="78"]{counter-set:figure-counter-major 78;counter-reset:figure-counter-minor;}
  h1[data-number="79"]{counter-set:figure-counter-major 79;counter-reset:figure-counter-minor;}
  h1[data-number="80"]{counter-set:figure-counter-major 80;counter-reset:figure-counter-minor;}
  h1[data-number="81"]{counter-set:figure-counter-major 81;counter-reset:figure-counter-minor;}
  h1[data-number="82"]{counter-set:figure-counter-major 82;counter-reset:figure-counter-minor;}
  h1[data-number="83"]{counter-set:figure-counter-major 83;counter-reset:figure-counter-minor;}
  h1[data-number="84"]{counter-set:figure-counter-major 84;counter-reset:figure-counter-minor;}
  h1[data-number="85"]{counter-set:figure-counter-major 85;counter-reset:figure-counter-minor;}
  h1[data-number="86"]{counter-set:figure-counter-major 86;counter-reset:figure-counter-minor;}
  h1[data-number="87"]{counter-set:figure-counter-major 87;counter-reset:figure-counter-minor;}
  h1[data-number="88"]{counter-set:figure-counter-major 88;counter-reset:figure-counter-minor;}
  h1[data-number="89"]{counter-set:figure-counter-major 89;counter-reset:figure-counter-minor;}
  h1[data-number="90"]{counter-set:figure-counter-major 90;counter-reset:figure-counter-minor;}
  h1[data-number="91"]{counter-set:figure-counter-major 91;counter-reset:figure-counter-minor;}
  h1[data-number="92"]{counter-set:figure-counter-major 92;counter-reset:figure-counter-minor;}
  h1[data-number="93"]{counter-set:figure-counter-major 93;counter-reset:figure-counter-minor;}
  h1[data-number="94"]{counter-set:figure-counter-major 94;counter-reset:figure-counter-minor;}
  h1[data-number="95"]{counter-set:figure-counter-major 95;counter-reset:figure-counter-minor;}
  h1[data-number="96"]{counter-set:figure-counter-major 96;counter-reset:figure-counter-minor;}
  h1[data-number="97"]{counter-set:figure-counter-major 97;counter-reset:figure-counter-minor;}
  h1[data-number="98"]{counter-set:figure-counter-major 98;counter-reset:figure-counter-minor;}
  h1[data-number="99"]{counter-set:figure-counter-major 99;counter-reset:figure-counter-minor;}


  </style>
<style id="_fc_">[d__],[d__][style]{color:rgba(0, 0, 0, 1)!important}[s__='1']{font-size: calc(1px + 15%)!important}
[s__='2']{font-size: calc(2px + 15%)!important}
[s__='3']{font-size: calc(3px + 15%)!important}
[s__='4']{font-size: calc(4px + 15%)!important}
[s__='5']{font-size: calc(5px + 15%)!important}
[s__='6']{font-size: calc(6px + 15%)!important}
[s__='7']{font-size: calc(7px + 15%)!important}
[s__='8']{font-size: calc(8px + 15%)!important}
[s__='9']{font-size: calc(9px + 15%)!important}
[s__='10']{font-size: calc(10px + 15%)!important}
[s__='11']{font-size: calc(11px + 15%)!important}
[s__='12']{font-size: calc(12px + 15%)!important}
[s__='13']{font-size: calc(13px + 15%)!important}
[s__='14']{font-size: calc(14px + 15%)!important}
::placeholder{opacity:1!important;}[b__]{border:1px solid black!important}</style></head>
<body>
<header id="title-block-header">
<h1 class="title" d__="">Beej's Guide to Network Concepts</h1>
<p class="author" d__="">Brian “Beej Jorgensen” Hall</p>
<p class="date" d__="">v1.0.27, Copyright © November 17, 2024</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#foreword" id="toc-foreword" d__=""><span class="toc-section-number" d__="">1</span> Foreword</a>
<ul>
<li><a href="#audience" id="toc-audience" d__=""><span class="toc-section-number" d__="">1.1</span> Audience</a></li>
<li><a href="#official-homepage" id="toc-official-homepage" d__=""><span class="toc-section-number" d__="">1.2</span> Official Homepage</a></li>
<li><a href="#email-policy" id="toc-email-policy" d__=""><span class="toc-section-number" d__="">1.3</span> Email Policy</a></li>
<li><a href="#mirroring" id="toc-mirroring" d__=""><span class="toc-section-number" d__="">1.4</span> Mirroring</a></li>
<li><a href="#note-for-translators" id="toc-note-for-translators" d__=""><span class="toc-section-number" d__="">1.5</span> Note for Translators</a></li>
<li><a href="#copyright-and-distribution" id="toc-copyright-and-distribution" d__=""><span class="toc-section-number" d__="">1.6</span> Copyright and Distribution</a></li>
<li><a href="#dedication" id="toc-dedication" d__=""><span class="toc-section-number" d__="">1.7</span> Dedication</a></li>
</ul></li>
<li><a href="#networking-overview" id="toc-networking-overview" d__=""><span class="toc-section-number" d__="">2</span> Networking Overview</a>
<ul>
<li><a href="#circuit-switched" id="toc-circuit-switched" d__=""><span class="toc-section-number" d__="">2.1</span> Circuit Switched</a></li>
<li><a href="#packet-switched" id="toc-packet-switched" d__=""><span class="toc-section-number" d__="">2.2</span> Packet Switched</a></li>
<li><a href="#clientserver-architecture" id="toc-clientserver-architecture" d__=""><span class="toc-section-number" d__="">2.3</span> Client/Server Architecture</a></li>
<li><a href="#the-os-network-programming-and-sockets" id="toc-the-os-network-programming-and-sockets" d__=""><span class="toc-section-number" d__="">2.4</span> The OS, Network Programming, and Sockets</a></li>
<li><a href="#protocols" id="toc-protocols" d__=""><span class="toc-section-number" d__="">2.5</span> Protocols</a></li>
<li><a href="#network-layers-and-abstraction" id="toc-network-layers-and-abstraction" d__=""><span class="toc-section-number" d__="">2.6</span> Network Layers and Abstraction</a></li>
<li><a href="#wired-versus-wireless" id="toc-wired-versus-wireless" d__=""><span class="toc-section-number" d__="">2.7</span> Wired versus Wireless</a></li>
<li><a href="#reflect" id="toc-reflect" d__=""><span class="toc-section-number" d__="">2.8</span> Reflect</a></li>
</ul></li>
<li><a href="#introducing-the-sockets-api" id="toc-introducing-the-sockets-api" d__=""><span class="toc-section-number" d__="">3</span> Introducing The Sockets API</a>
<ul>
<li><a href="#client-connection-process" id="toc-client-connection-process" d__=""><span class="toc-section-number" d__="">3.1</span> Client Connection Process</a></li>
<li><a href="#server-listening-process" id="toc-server-listening-process" d__=""><span class="toc-section-number" d__="">3.2</span> Server Listening Process</a></li>
<li><a href="#reflect-1" id="toc-reflect-1" d__=""><span class="toc-section-number" d__="">3.3</span> Reflect</a></li>
<li><a href="#resources" id="toc-resources" d__=""><span class="toc-section-number" d__="">3.4</span> Resources</a></li>
</ul></li>
<li><a href="#the-layered-network-model" id="toc-the-layered-network-model" d__=""><span class="toc-section-number" d__="">4</span> The Layered Network Model</a>
<ul>
<li><a href="#the-layered-network-model-1" id="toc-the-layered-network-model-1" d__=""><span class="toc-section-number" d__="">4.1</span> The Layered Network Model</a></li>
<li><a href="#an-example-of-layering-of-protocols-on-data" id="toc-an-example-of-layering-of-protocols-on-data" d__=""><span class="toc-section-number" d__="">4.2</span> An Example of Layering of Protocols on Data</a></li>
<li><a href="#the-internet-layer-model" id="toc-the-internet-layer-model" d__=""><span class="toc-section-number" d__="">4.3</span> The Internet Layer Model</a></li>
<li><a href="#the-iso-osi-network-layer-model" id="toc-the-iso-osi-network-layer-model" d__=""><span class="toc-section-number" d__="">4.4</span> The ISO OSI Network Layer Model</a></li>
<li><a href="#reflect-2" id="toc-reflect-2" d__=""><span class="toc-section-number" d__="">4.5</span> Reflect</a></li>
</ul></li>
<li><a href="#project-http-client-and-server" id="toc-project-http-client-and-server" d__=""><span class="toc-section-number" d__="">5</span> Project: HTTP Client and Server</a>
<ul>
<li><a href="#restrictions" id="toc-restrictions" d__=""><span class="toc-section-number" d__="">5.1</span> Restrictions</a></li>
<li><a href="#python-character-encoding" id="toc-python-character-encoding" d__="" style=""><span class="toc-section-number" d__="">5.2</span> Python Character Encoding</a></li>
<li><a href="#http-summary" id="toc-http-summary" d__=""><span class="toc-section-number" d__="">5.3</span> HTTP Summary</a></li>
<li><a href="#the-client" id="toc-the-client" d__=""><span class="toc-section-number" d__="">5.4</span> The Client</a></li>
<li><a href="#the-server" id="toc-the-server" d__=""><span class="toc-section-number" d__="">5.5</span> The Server</a></li>
<li><a href="#hints-and-help" id="toc-hints-and-help" d__=""><span class="toc-section-number" d__="">5.6</span> Hints and Help</a>
<ul>
<li><a href="#address-already-in-use" id="toc-address-already-in-use" d__=""><span class="toc-section-number" d__="">5.6.1</span> Address Already In Use</a></li>
<li><a href="#receiving-partial-data" id="toc-receiving-partial-data" d__=""><span class="toc-section-number" d__="">5.6.2</span> Receiving Partial Data</a></li>
<li><a href="#http-301-http-302" id="toc-http-301-http-302" d__=""><span class="toc-section-number" d__="">5.6.3</span> HTTP 301, HTTP 302</a></li>
<li><a href="#http-400-http-501-or-any-500s" id="toc-http-400-http-501-or-any-500s" d__=""><span class="toc-section-number" d__="">5.6.4</span> HTTP 400, HTTP 501 (or any 500s)</a></li>
<li><a href="#http-404-not-found" id="toc-http-404-not-found" d__=""><span class="toc-section-number" d__="">5.6.5</span> HTTP 404 Not Found!</a></li>
</ul></li>
<li><a href="#extensions" id="toc-extensions" d__=""><span class="toc-section-number" d__="">5.7</span> Extensions</a></li>
</ul></li>
<li><a href="#the-internet-protocol-ip" id="toc-the-internet-protocol-ip" d__=""><span class="toc-section-number" d__="">6</span> The Internet Protocol (IP)</a>
<ul>
<li><a href="#terminology" id="toc-terminology" d__=""><span class="toc-section-number" d__="">6.1</span> Terminology</a></li>
<li><a href="#two-common-versions" id="toc-two-common-versions" d__=""><span class="toc-section-number" d__="">6.2</span> Two Common Versions</a></li>
<li><a href="#subnets" id="toc-subnets" d__=""><span class="toc-section-number" d__="">6.3</span> Subnets</a></li>
<li><a href="#additional-ip-layer-protocols" id="toc-additional-ip-layer-protocols" d__=""><span class="toc-section-number" d__="">6.4</span> Additional IP-layer Protocols</a></li>
<li><a href="#private-networks" id="toc-private-networks" d__=""><span class="toc-section-number" d__="">6.5</span> Private Networks</a></li>
<li><a href="#static-versus-dynamic-ip-addresses-and-dhcp" id="toc-static-versus-dynamic-ip-addresses-and-dhcp" d__=""><span class="toc-section-number" d__="">6.6</span> Static versus Dynamic IP Addresses, and DHCP</a></li>
<li><a href="#reflect-3" id="toc-reflect-3" d__=""><span class="toc-section-number" d__="">6.7</span> Reflect</a></li>
</ul></li>
<li><a href="#the-internet-protocol-version-4" id="toc-the-internet-protocol-version-4" d__=""><span class="toc-section-number" d__="">7</span> The Internet Protocol version 4</a>
<ul>
<li><a href="#ip-addresses" id="toc-ip-addresses" d__=""><span class="toc-section-number" d__="">7.1</span> IP Addresses</a></li>
<li><a href="#subnets-1" id="toc-subnets-1" d__=""><span class="toc-section-number" d__="">7.2</span> Subnets</a></li>
<li><a href="#subnet-masks" id="toc-subnet-masks" d__=""><span class="toc-section-number" d__="">7.3</span> Subnet Masks</a></li>
<li><a href="#historic-subnets" id="toc-historic-subnets" d__=""><span class="toc-section-number" d__="">7.4</span> Historic Subnets</a></li>
<li><a href="#special-addresses" id="toc-special-addresses" d__=""><span class="toc-section-number" d__="">7.5</span> Special Addresses</a></li>
<li><a href="#special-subnets" id="toc-special-subnets" d__=""><span class="toc-section-number" d__="">7.6</span> Special Subnets</a></li>
<li><a href="#reflect-4" id="toc-reflect-4" d__=""><span class="toc-section-number" d__="">7.7</span> Reflect</a></li>
</ul></li>
<li><a href="#the-internet-protocol-version-6" id="toc-the-internet-protocol-version-6" d__=""><span class="toc-section-number" d__="">8</span> The Internet Protocol version 6</a>
<ul>
<li><a href="#representation" id="toc-representation" d__=""><span class="toc-section-number" d__="">8.1</span> Representation</a></li>
<li><a href="#link-local-addresses" id="toc-link-local-addresses" d__=""><span class="toc-section-number" d__="">8.2</span> Link-Local Addresses</a></li>
<li><a href="#special-ipv6-addresses-and-subnets" id="toc-special-ipv6-addresses-and-subnets" d__=""><span class="toc-section-number" d__="">8.3</span> Special IPv6 Addresses and Subnets</a></li>
<li><a href="#ipv6-and-dns" id="toc-ipv6-and-dns" d__=""><span class="toc-section-number">8.4</span> IPv6 and DNS</a></li>
<li><a href="#ipv6-and-urls" id="toc-ipv6-and-urls" d__=""><span class="toc-section-number">8.5</span> IPv6 and URLs</a></li>
<li><a href="#reflect-5" id="toc-reflect-5" d__=""><span class="toc-section-number">8.6</span> Reflect</a></li>
</ul></li>
<li><a href="#project-a-better-web-server" id="toc-project-a-better-web-server" d__=""><span class="toc-section-number">9</span> Project: A Better Web Server</a>
<ul>
<li><a href="#restrictions-1" id="toc-restrictions-1" d__=""><span class="toc-section-number">9.1</span> Restrictions</a></li>
<li><a href="#the-process" id="toc-the-process" d__=""><span class="toc-section-number">9.2</span> The Process</a></li>
<li><a href="#parsing-the-request-header" id="toc-parsing-the-request-header" d__=""><span class="toc-section-number">9.3</span> Parsing the Request Header</a></li>
<li><a href="#stripping-the-path-down-to-the-filename" id="toc-stripping-the-path-down-to-the-filename" d__=""><span class="toc-section-number">9.4</span> Stripping the Path down to the Filename</a></li>
<li><a href="#mime-and-getting-the-content-type" id="toc-mime-and-getting-the-content-type" d__=""><span class="toc-section-number">9.5</span> MIME and Getting the <code s__="13">Content-Type</code></a></li>
<li><a href="#reading-the-file-content-length-and-handling-not-found" id="toc-reading-the-file-content-length-and-handling-not-found" d__=""><span class="toc-section-number">9.6</span> Reading the File, <code s__="13">Content-Length</code>, and Handling Not Found</a></li>
<li><a href="#extensions-1" id="toc-extensions-1" d__=""><span class="toc-section-number">9.7</span> Extensions</a></li>
<li><a href="#example-files" id="toc-example-files" d__=""><span class="toc-section-number">9.8</span> Example Files</a>
<ul>
<li><a href="#file1.txt" id="toc-file1.txt"><span class="toc-section-number" d__="">9.8.1</span> <code s__="13" d__="">file1.txt</code></a></li>
<li><a href="#file2.html" id="toc-file2.html"><span class="toc-section-number" d__="">9.8.2</span> <code s__="13" d__="">file2.html</code></a></li>
</ul></li>
</ul></li>
<li><a href="#endianness-and-integers" id="toc-endianness-and-integers" d__=""><span class="toc-section-number">10</span> Endianness and Integers</a>
<ul>
<li><a href="#integer-representations" id="toc-integer-representations" d__=""><span class="toc-section-number">10.1</span> Integer Representations</a>
<ul>
<li><a href="#decimal-byte-representation" id="toc-decimal-byte-representation" d__=""><span class="toc-section-number">10.1.1</span> Decimal Byte Representation</a></li>
<li><a href="#binary-byte-representations" id="toc-binary-byte-representations" d__=""><span class="toc-section-number">10.1.2</span> Binary Byte Representations</a></li>
<li><a href="#hexadecimal-byte-representations" id="toc-hexadecimal-byte-representations" d__=""><span class="toc-section-number">10.1.3</span> Hexadecimal Byte Representations</a></li>
</ul></li>
<li><a href="#endianness" id="toc-endianness" d__=""><span class="toc-section-number">10.2</span> Endianness</a></li>
<li><a href="#python-and-endianness" id="toc-python-and-endianness" d__="" style=""><span class="toc-section-number">10.3</span> Python and Endianness</a>
<ul>
<li><a href="#converting-a-number-to-bytes" id="toc-converting-a-number-to-bytes" d__=""><span class="toc-section-number">10.3.1</span> Converting a Number to Bytes</a></li>
<li><a href="#convert-bytes-back-to-a-number" id="toc-convert-bytes-back-to-a-number" d__=""><span class="toc-section-number">10.3.2</span> Convert Bytes Back to a Number</a></li>
</ul></li>
<li><a href="#reflect-6" id="toc-reflect-6" d__=""><span class="toc-section-number">10.4</span> Reflect</a></li>
</ul></li>
<li><a href="#parsing-packets" id="toc-parsing-packets" d__=""><span class="toc-section-number">11</span> Parsing Packets</a>
<ul>
<li><a href="#you-know-what-would-make-this-easy" id="toc-you-know-what-would-make-this-easy" d__=""><span class="toc-section-number">11.1</span> You Know What Would Make This Easy?</a></li>
<li><a href="#processing-a-stream-into-packets" id="toc-processing-a-stream-into-packets" d__=""><span class="toc-section-number">11.2</span> Processing a Stream into Packets</a></li>
<li><a href="#the-sentences-example-again" id="toc-the-sentences-example-again" d__=""><span class="toc-section-number">11.3</span> The Sentences Example Again</a>
<ul>
<li><a href="#what-if-you-receive-multiple-sentences-at-once" id="toc-what-if-you-receive-multiple-sentences-at-once" d__=""><span class="toc-section-number">11.3.1</span> What If You Receive Multiple Sentences at Once?</a></li>
</ul></li>
<li><a href="#the-grand-scheme" id="toc-the-grand-scheme" d__=""><span class="toc-section-number">11.4</span> The Grand Scheme</a></li>
<li><a href="#reflect-7" id="toc-reflect-7" d__=""><span class="toc-section-number">11.5</span> Reflect</a></li>
</ul></li>
<li><a href="#project-atomic-time" id="toc-project-atomic-time" d__=""><span class="toc-section-number">12</span> Project: Atomic Time</a>
<ul>
<li><a href="#note-on-legality" id="toc-note-on-legality" d__=""><span class="toc-section-number">12.1</span> Note On Legality</a></li>
<li><a href="#note-on-allowable-use" id="toc-note-on-allowable-use" d__=""><span class="toc-section-number">12.2</span> Note On Allowable Use</a></li>
<li><a href="#epoch" id="toc-epoch" d__=""><span class="toc-section-number">12.3</span> Epoch</a></li>
<li><a href="#a-dire-warning-about-zeros" id="toc-a-dire-warning-about-zeros" d__=""><span class="toc-section-number">12.4</span> A Dire Warning about Zeros</a></li>
<li><a href="#the-gameplan" id="toc-the-gameplan" d__=""><span class="toc-section-number">12.5</span> The Gameplan</a>
<ul>
<li><a href="#connect-to-the-server" id="toc-connect-to-the-server" d__=""><span class="toc-section-number">12.5.1</span> 1. Connect to the Server</a></li>
<li><a href="#receive-the-data" id="toc-receive-the-data" d__=""><span class="toc-section-number">12.5.2</span> 2. Receive the Data</a></li>
<li><a href="#decode-the-data" id="toc-decode-the-data" d__=""><span class="toc-section-number">12.5.3</span> 3. Decode the Data</a></li>
<li><a href="#print-out-nists-time" id="toc-print-out-nists-time" d__=""><span class="toc-section-number">12.5.4</span> 4. Print Out NIST’s Time</a></li>
<li><a href="#print-out-the-system-time" id="toc-print-out-the-system-time" d__=""><span class="toc-section-number">12.5.5</span> 5. Print Out the System Time</a></li>
</ul></li>
</ul></li>
<li><a href="#project-the-word-server" id="toc-project-the-word-server" d__=""><span class="toc-section-number">13</span> Project: The Word Server</a>
<ul>
<li><a href="#overview" id="toc-overview" d__=""><span class="toc-section-number">13.1</span> Overview</a></li>
<li><a href="#what-is-a-word-packet" id="toc-what-is-a-word-packet" d__=""><span class="toc-section-number">13.2</span> What is a “Word Packet”?</a></li>
<li><a href="#implementation-get_next_word_packet" id="toc-implementation-get_next_word_packet" d__=""><span class="toc-section-number">13.3</span> Implementation: <code s__="13">get_next_word_packet()</code></a></li>
<li><a href="#implementation-extract_word" id="toc-implementation-extract_word" d__=""><span class="toc-section-number">13.4</span> Implementation: <code s__="13">extract_word()</code></a></li>
</ul></li>
<li><a href="#transmission-control-protocol-tcp" id="toc-transmission-control-protocol-tcp" d__=""><span class="toc-section-number">14</span> Transmission Control Protocol (TCP)</a>
<ul>
<li><a href="#goals-of-tcp" id="toc-goals-of-tcp" d__=""><span class="toc-section-number">14.1</span> Goals of TCP</a></li>
<li><a href="#location-in-the-network-stack" id="toc-location-in-the-network-stack" d__=""><span class="toc-section-number">14.2</span> Location in the Network Stack</a></li>
<li><a href="#tcp-ports" id="toc-tcp-ports" d__=""><span class="toc-section-number">14.3</span> TCP Ports</a></li>
<li><a href="#tcp-overview" id="toc-tcp-overview" d__=""><span class="toc-section-number">14.4</span> TCP Overview</a>
<ul>
<li><a href="#making-the-connection" id="toc-making-the-connection" d__=""><span class="toc-section-number">14.4.1</span> Making the Connection</a></li>
<li><a href="#transmitting-data" id="toc-transmitting-data" d__=""><span class="toc-section-number">14.4.2</span> Transmitting Data</a></li>
<li><a href="#closing-the-connection" id="toc-closing-the-connection" d__=""><span class="toc-section-number">14.4.3</span> Closing the Connection</a></li>
</ul></li>
<li><a href="#data-integrity" id="toc-data-integrity" d__=""><span class="toc-section-number">14.5</span> Data Integrity</a>
<ul>
<li><a href="#packet-ordering" id="toc-packet-ordering" d__=""><span class="toc-section-number">14.5.1</span> Packet Ordering</a></li>
<li><a href="#error-detection" id="toc-error-detection" d__=""><span class="toc-section-number">14.5.2</span> Error Detection</a></li>
</ul></li>
<li><a href="#flow-control" id="toc-flow-control" d__=""><span class="toc-section-number">14.6</span> Flow Control</a></li>
<li><a href="#congestion-control" id="toc-congestion-control" d__=""><span class="toc-section-number">14.7</span> Congestion Control</a>
<ul>
<li><a href="#slow-start" id="toc-slow-start" d__=""><span class="toc-section-number">14.7.1</span> Slow Start</a></li>
<li><a href="#congestion-avoidance" id="toc-congestion-avoidance" d__=""><span class="toc-section-number">14.7.2</span> Congestion Avoidance</a></li>
</ul></li>
<li><a href="#reflect-8" id="toc-reflect-8" d__=""><span class="toc-section-number">14.8</span> Reflect</a></li>
</ul></li>
<li><a href="#user-datagram-protocol-udp" id="toc-user-datagram-protocol-udp" d__=""><span class="toc-section-number">15</span> User Datagram Protocol (UDP)</a>
<ul>
<li><a href="#goals-of-udp" id="toc-goals-of-udp" d__=""><span class="toc-section-number">15.1</span> Goals of UDP</a></li>
<li><a href="#location-in-the-network-stack-1" id="toc-location-in-the-network-stack-1" d__=""><span class="toc-section-number">15.2</span> Location in the Network Stack</a></li>
<li><a href="#udp-ports" id="toc-udp-ports" d__=""><span class="toc-section-number">15.3</span> UDP Ports</a></li>
<li><a href="#udp-overview" id="toc-udp-overview" d__=""><span class="toc-section-number">15.4</span> UDP Overview</a></li>
<li><a href="#data-integrity-1" id="toc-data-integrity-1" d__=""><span class="toc-section-number">15.5</span> Data Integrity</a>
<ul>
<li><a href="#error-detection-1" id="toc-error-detection-1" d__=""><span class="toc-section-number">15.5.1</span> Error Detection</a></li>
</ul></li>
<li><a href="#maximum-payload-without-fragmentation" id="toc-maximum-payload-without-fragmentation" d__=""><span class="toc-section-number">15.6</span> Maximum Payload Without Fragmentation</a></li>
<li><a href="#whats-the-use" id="toc-whats-the-use" d__=""><span class="toc-section-number">15.7</span> What’s the Use?</a></li>
<li><a href="#udp-datagram-sockets" id="toc-udp-datagram-sockets" d__=""><span class="toc-section-number">15.8</span> UDP (Datagram) Sockets</a>
<ul>
<li><a href="#server-procedure" id="toc-server-procedure" d__=""><span class="toc-section-number">15.8.1</span> Server Procedure</a></li>
<li><a href="#client-procedure" id="toc-client-procedure" d__=""><span class="toc-section-number">15.8.2</span> Client Procedure</a></li>
</ul></li>
<li><a href="#reflect-9" id="toc-reflect-9" d__=""><span class="toc-section-number">15.9</span> Reflect</a></li>
</ul></li>
<li><a href="#project-validating-a-tcp-packet" id="toc-project-validating-a-tcp-packet" d__=""><span class="toc-section-number">16</span> Project: Validating a TCP Packet</a>
<ul>
<li><a href="#banned-functions" id="toc-banned-functions" d__=""><span class="toc-section-number">16.1</span> Banned Functions</a></li>
<li><a href="#how-to-code-this" id="toc-how-to-code-this" d__=""><span class="toc-section-number">16.2</span> How To Code This</a></li>
<li><a href="#checksum-in-general" id="toc-checksum-in-general" d__=""><span class="toc-section-number">16.3</span> Checksum in General</a></li>
<li><a href="#input-file-details" id="toc-input-file-details" d__=""><span class="toc-section-number">16.4</span> Input File Details</a>
<ul>
<li><a href="#the-.txt-file" id="toc-the-.txt-file" d__=""><span class="toc-section-number">16.4.1</span> The <code s__="13">.txt</code> File</a></li>
<li><a href="#the-.dat-file" id="toc-the-.dat-file" d__=""><span class="toc-section-number">16.4.2</span> The <code s__="13">.dat</code> File</a></li>
</ul></li>
<li><a href="#how-on-earth-do-you-compute-a-tcp-checksum" id="toc-how-on-earth-do-you-compute-a-tcp-checksum" d__=""><span class="toc-section-number">16.5</span> How On Earth Do You Compute A TCP Checksum?</a></li>
<li><a href="#the-ip-pseudo-header" id="toc-the-ip-pseudo-header" d__=""><span class="toc-section-number">16.6</span> The IP Pseudo Header</a>
<ul>
<li><a href="#example-pseudo-header" id="toc-example-pseudo-header" d__=""><span class="toc-section-number">16.6.1</span> Example Pseudo Header</a></li>
<li><a href="#getting-the-ip-address-bytes" id="toc-getting-the-ip-address-bytes" d__=""><span class="toc-section-number">16.6.2</span> Getting the IP Address Bytes</a></li>
<li><a href="#getting-the-tcp-data-length" id="toc-getting-the-tcp-data-length" d__=""><span class="toc-section-number">16.6.3</span> Getting the TCP Data Length</a></li>
</ul></li>
<li><a href="#the-tcp-header-checksum" id="toc-the-tcp-header-checksum" d__=""><span class="toc-section-number">16.7</span> The TCP Header Checksum</a></li>
<li><a href="#actually-computing-the-checksum" id="toc-actually-computing-the-checksum" d__=""><span class="toc-section-number">16.8</span> Actually Computing the Checksum</a></li>
<li><a href="#final-comparison" id="toc-final-comparison" d__=""><span class="toc-section-number">16.9</span> Final Comparison</a></li>
<li><a href="#output" id="toc-output" d__=""><span class="toc-section-number">16.10</span> Output</a></li>
<li><a href="#success" id="toc-success" d__=""><span class="toc-section-number">16.11</span> Success</a></li>
</ul></li>
<li><a href="#ip-subnets-and-subnet-masks" id="toc-ip-subnets-and-subnet-masks" d__=""><span class="toc-section-number">17</span> IP Subnets and Subnet Masks</a>
<ul>
<li><a href="#address-representation" id="toc-address-representation" d__=""><span class="toc-section-number">17.1</span> Address Representation</a></li>
<li><a href="#converting-from-dots-and-numbers" id="toc-converting-from-dots-and-numbers" d__=""><span class="toc-section-number">17.2</span> Converting from Dots-and-Numbers</a></li>
<li><a href="#converting-to-dots-and-numbers" id="toc-converting-to-dots-and-numbers" d__=""><span class="toc-section-number">17.3</span> Converting to Dots-and-Numbers</a></li>
<li><a href="#subnet-and-host-refresher" id="toc-subnet-and-host-refresher" d__=""><span class="toc-section-number">17.4</span> Subnet and Host Refresher</a></li>
<li><a href="#subnet-mask-refresher" id="toc-subnet-mask-refresher" d__=""><span class="toc-section-number">17.5</span> Subnet Mask Refresher</a></li>
<li><a href="#computing-the-subnet-mask-from-slash-notation" id="toc-computing-the-subnet-mask-from-slash-notation" d__=""><span class="toc-section-number">17.6</span> Computing the Subnet Mask from Slash Notation</a></li>
<li><a href="#finding-the-subnet-for-an-ip-address" id="toc-finding-the-subnet-for-an-ip-address" d__=""><span class="toc-section-number">17.7</span> Finding the Subnet for an IP address</a></li>
<li><a href="#reflect-10" id="toc-reflect-10" d__=""><span class="toc-section-number">17.8</span> Reflect</a></li>
</ul></li>
<li><a href="#ip-routing" id="toc-ip-routing" d__=""><span class="toc-section-number">18</span> IP Routing</a>
<ul>
<li><a href="#routing-protocols" id="toc-routing-protocols" d__=""><span class="toc-section-number">18.1</span> Routing Protocols</a>
<ul>
<li><a href="#interior-gateway-protocols" id="toc-interior-gateway-protocols" d__=""><span class="toc-section-number">18.1.1</span> Interior Gateway Protocols</a></li>
<li><a href="#exterior-gateway-protocols" id="toc-exterior-gateway-protocols" d__=""><span class="toc-section-number">18.1.2</span> Exterior Gateway Protocols</a></li>
</ul></li>
<li><a href="#routing-tables" id="toc-routing-tables" d__=""><span class="toc-section-number">18.2</span> Routing tables</a></li>
<li><a href="#routing-algorithm" id="toc-routing-algorithm" d__=""><span class="toc-section-number">18.3</span> Routing Algorithm</a></li>
<li><a href="#routing-example" id="toc-routing-example" d__=""><span class="toc-section-number">18.4</span> Routing Example</a></li>
<li><a href="#routing-loops-and-time-to-live" id="toc-routing-loops-and-time-to-live" d__=""><span class="toc-section-number">18.5</span> Routing Loops and Time-To-Live</a></li>
<li><a href="#the-broadcast-address" id="toc-the-broadcast-address" d__=""><span class="toc-section-number">18.6</span> The Broadcast Address</a></li>
<li><a href="#reflect-11" id="toc-reflect-11" d__=""><span class="toc-section-number">18.7</span> Reflect</a></li>
</ul></li>
<li><a href="#project-computing-and-finding-subnets" id="toc-project-computing-and-finding-subnets" d__=""><span class="toc-section-number">19</span> Project: Computing and Finding Subnets</a>
<ul>
<li><a href="#restrictions-2" id="toc-restrictions-2" d__=""><span class="toc-section-number">19.1</span> Restrictions</a></li>
<li><a href="#what-to-do" id="toc-what-to-do" d__=""><span class="toc-section-number">19.2</span> What To Do</a></li>
<li><a href="#testing-as-you-go" id="toc-testing-as-you-go" d__=""><span class="toc-section-number">19.3</span> Testing as you Go</a></li>
<li><a href="#running-the-program" id="toc-running-the-program" d__=""><span class="toc-section-number">19.4</span> Running the Program</a></li>
</ul></li>
<li><a href="#the-link-layer-and-ethernet" id="toc-the-link-layer-and-ethernet" d__=""><span class="toc-section-number">20</span> The Link Layer and Ethernet</a>
<ul>
<li><a href="#a-quick-note-on-octets" id="toc-a-quick-note-on-octets" d__=""><span class="toc-section-number">20.1</span> A Quick Note on Octets</a></li>
<li><a href="#frames-versus-packets" id="toc-frames-versus-packets" d__=""><span class="toc-section-number">20.2</span> Frames versus Packets</a></li>
<li><a href="#mac-addresses" id="toc-mac-addresses" d__=""><span class="toc-section-number">20.3</span> MAC Addresses</a></li>
<li><a href="#were-all-in-the-same-room-typically" id="toc-were-all-in-the-same-room-typically" d__=""><span class="toc-section-number">20.4</span> We’re All In The Same Room (Typically)</a></li>
<li><a href="#multiple-access-method" id="toc-multiple-access-method" d__=""><span class="toc-section-number">20.5</span> Multiple Access Method</a></li>
<li><a href="#ethernet" id="toc-ethernet" d__=""><span class="toc-section-number">20.6</span> Ethernet</a>
<ul>
<li><a href="#two-layers-of-ethernet" id="toc-two-layers-of-ethernet" d__=""><span class="toc-section-number">20.6.1</span> Two Layers of Ethernet?</a></li>
</ul></li>
<li><a href="#reflect-12" id="toc-reflect-12" d__=""><span class="toc-section-number">20.7</span> Reflect</a></li>
</ul></li>
<li><a href="#arp-the-address-resolution-protocol" id="toc-arp-the-address-resolution-protocol" d__=""><span class="toc-section-number">21</span> ARP: The Address Resolution Protocol</a>
<ul>
<li><a href="#ethernet-broadcast-frames" id="toc-ethernet-broadcast-frames" d__=""><span class="toc-section-number">21.1</span> Ethernet Broadcast Frames</a></li>
<li><a href="#arpthe-address-resolution-protocol" id="toc-arpthe-address-resolution-protocol" d__=""><span class="toc-section-number">21.2</span> ARP–The Address Resolution Protocol</a></li>
<li><a href="#arp-caching" id="toc-arp-caching" d__=""><span class="toc-section-number">21.3</span> ARP Caching</a></li>
<li><a href="#arp-structure" id="toc-arp-structure" d__=""><span class="toc-section-number">21.4</span> ARP Structure</a></li>
<li><a href="#arp-requestresponse" id="toc-arp-requestresponse" d__=""><span class="toc-section-number">21.5</span> ARP Request/Response</a></li>
<li><a href="#other-arp-features" id="toc-other-arp-features" d__=""><span class="toc-section-number">21.6</span> Other ARP Features</a>
<ul>
<li><a href="#arp-announcements" id="toc-arp-announcements" d__=""><span class="toc-section-number">21.6.1</span> ARP Announcements</a></li>
<li><a href="#arp-probe" id="toc-arp-probe" d__=""><span class="toc-section-number">21.6.2</span> ARP Probe</a></li>
</ul></li>
<li><a href="#ipv6-and-arp" id="toc-ipv6-and-arp" d__=""><span class="toc-section-number">21.7</span> IPv6 and ARP</a></li>
<li><a href="#reflect-13" id="toc-reflect-13" d__=""><span class="toc-section-number">21.8</span> Reflect</a></li>
</ul></li>
<li><a href="#project-6-routing-with-dijkstras" id="toc-project-6-routing-with-dijkstras" d__=""><span class="toc-section-number">22</span> Project 6: Routing with Dijkstra’s</a>
<ul>
<li><a href="#banned-functions-1" id="toc-banned-functions-1" d__=""><span class="toc-section-number">22.1</span> Banned Functions</a></li>
<li><a href="#graphs-refresher" id="toc-graphs-refresher" d__=""><span class="toc-section-number">22.2</span> Graphs Refresher</a></li>
<li><a href="#dijkstras-algorithm-overview" id="toc-dijkstras-algorithm-overview" d__=""><span class="toc-section-number">22.3</span> Dijkstra’s Algorithm Overview</a></li>
<li><a href="#dijkstras-implementation" id="toc-dijkstras-implementation" d__=""><span class="toc-section-number">22.4</span> Dijkstra’s Implementation</a>
<ul>
<li><a href="#getting-the-minimum-distance" id="toc-getting-the-minimum-distance" d__=""><span class="toc-section-number">22.4.1</span> Getting the Minimum Distance</a></li>
</ul></li>
<li><a href="#what-about-our-project" id="toc-what-about-our-project" d__=""><span class="toc-section-number">22.5</span> What About Our Project?</a>
<ul>
<li><a href="#the-function-inputs-and-outputs" id="toc-the-function-inputs-and-outputs" d__=""><span class="toc-section-number">22.5.1</span> The Function, Inputs, and Outputs</a></li>
<li><a href="#the-graph-representation" id="toc-the-graph-representation" d__=""><span class="toc-section-number">22.5.2</span> The Graph Representation</a></li>
</ul></li>
<li><a href="#input-file-and-example-output" id="toc-input-file-and-example-output" d__=""><span class="toc-section-number">22.6</span> Input File and Example Output</a></li>
<li><a href="#hints" id="toc-hints" d__=""><span class="toc-section-number">22.7</span> Hints</a></li>
</ul></li>
<li><a href="#project-sniff-arp-packets-with-wireshark" id="toc-project-sniff-arp-packets-with-wireshark" d__=""><span class="toc-section-number">23</span> Project: Sniff ARP packets with WireShark</a>
<ul>
<li><a href="#what-to-create" id="toc-what-to-create" d__=""><span class="toc-section-number">23.1</span> What to Create</a></li>
<li><a href="#step-by-step" id="toc-step-by-step" d__=""><span class="toc-section-number">23.2</span> Step by Step</a></li>
</ul></li>
<li><a href="#network-hardware" id="toc-network-hardware" d__=""><span class="toc-section-number">24</span> Network Hardware</a>
<ul>
<li><a href="#terminology-and-components" id="toc-terminology-and-components" d__=""><span class="toc-section-number">24.1</span> Terminology and Components</a></li>
<li><a href="#reflect-14" id="toc-reflect-14" d__=""><span class="toc-section-number">24.2</span> Reflect</a></li>
</ul></li>
<li><a href="#project-packet-tracer-connect-two-computers" id="toc-project-packet-tracer-connect-two-computers" d__=""><span class="toc-section-number">25</span> Project: Packet Tracer: Connect Two Computers</a>
<ul>
<li><a href="#adding-computers-to-the-lan" id="toc-adding-computers-to-the-lan" d__=""><span class="toc-section-number">25.1</span> Adding Computers to the LAN</a></li>
<li><a href="#wiring-pcs-directly-together" id="toc-wiring-pcs-directly-together" d__=""><span class="toc-section-number">25.2</span> Wiring PCs Directly Together</a></li>
<li><a href="#setting-up-the-ip-network" id="toc-setting-up-the-ip-network" d__=""><span class="toc-section-number">25.3</span> Setting Up the IP Network</a></li>
<li><a href="#pinging-across-the-network" id="toc-pinging-across-the-network" d__=""><span class="toc-section-number">25.4</span> Pinging Across the Network</a></li>
<li><a href="#saving-the-project" id="toc-saving-the-project" d__=""><span class="toc-section-number">25.5</span> Saving the Project</a></li>
</ul></li>
<li><a href="#project-packet-tracer-using-a-switch" id="toc-project-packet-tracer-using-a-switch" d__=""><span class="toc-section-number">26</span> Project: Packet Tracer: Using a Switch</a>
<ul>
<li><a href="#add-some-pcs" id="toc-add-some-pcs" d__=""><span class="toc-section-number">26.1</span> Add Some PCs</a></li>
<li><a href="#add-a-switch" id="toc-add-a-switch" d__=""><span class="toc-section-number">26.2</span> Add a Switch</a></li>
<li><a href="#wire-it-up" id="toc-wire-it-up" d__=""><span class="toc-section-number">26.3</span> Wire It Up</a></li>
<li><a href="#test-pings" id="toc-test-pings" d__=""><span class="toc-section-number">26.4</span> Test Pings!</a></li>
</ul></li>
<li><a href="#project-packet-tracer-using-a-router" id="toc-project-packet-tracer-using-a-router" d__=""><span class="toc-section-number">27</span> Project: Packet Tracer: Using a Router</a>
<ul>
<li><a href="#build-the-lans" id="toc-build-the-lans" d__=""><span class="toc-section-number">27.1</span> Build the LANs</a></li>
<li><a href="#adding-a-router" id="toc-adding-a-router" d__=""><span class="toc-section-number">27.2</span> Adding a Router</a></li>
<li><a href="#adding-a-default-route" id="toc-adding-a-default-route" d__=""><span class="toc-section-number">27.3</span> Adding a Default Route</a></li>
<li><a href="#try-it-out" id="toc-try-it-out" d__=""><span class="toc-section-number">27.4</span> Try It Out!</a></li>
</ul></li>
<li><a href="#project-packet-tracer-multiple-routers" id="toc-project-packet-tracer-multiple-routers" d__=""><span class="toc-section-number">28</span> Project: Packet Tracer: Multiple Routers</a>
<ul>
<li><a href="#what-were-building" id="toc-what-were-building" d__=""><span class="toc-section-number">28.1</span> What We’re Building</a></li>
<li><a href="#drag-out-the-components" id="toc-drag-out-the-components" d__=""><span class="toc-section-number">28.2</span> Drag Out the Components</a></li>
<li><a href="#setting-up-the-middle-router" id="toc-setting-up-the-middle-router" d__=""><span class="toc-section-number">28.3</span> Setting Up the Middle Router</a></li>
<li><a href="#set-up-the-three-lan-subnets" id="toc-set-up-the-three-lan-subnets" d__=""><span class="toc-section-number">28.4</span> Set up the Three LAN Subnets</a></li>
<li><a href="#set-the-default-gateway-on-all-pcs" id="toc-set-the-default-gateway-on-all-pcs" d__=""><span class="toc-section-number">28.5</span> Set the Default Gateway on All PCs</a></li>
<li><a href="#setting-up-the-router-subnets" id="toc-setting-up-the-router-subnets" d__=""><span class="toc-section-number">28.6</span> Setting Up the Router Subnets</a></li>
<li><a href="#setting-up-the-routing-tables" id="toc-setting-up-the-routing-tables" d__=""><span class="toc-section-number">28.7</span> Setting Up the Routing Tables</a></li>
<li><a href="#test-it-out" id="toc-test-it-out" d__=""><span class="toc-section-number">28.8</span> Test It Out!</a></li>
</ul></li>
<li><a href="#select" id="toc-select" d__=""><span class="toc-section-number">29</span> Select</a>
<ul>
<li><a href="#the-problem-were-solving" id="toc-the-problem-were-solving" d__=""><span class="toc-section-number">29.1</span> The Problem We’re Solving</a></li>
<li><a href="#using-select" id="toc-using-select" d__=""><span class="toc-section-number">29.2</span> Using <code s__="13">select()</code></a></li>
<li><a href="#using-select-with-listening-sockets" id="toc-using-select-with-listening-sockets" d__=""><span class="toc-section-number">29.3</span> Using <code s__="13">select()</code> with Listening Sockets</a></li>
<li><a href="#the-main-algorithm" id="toc-the-main-algorithm" d__=""><span class="toc-section-number">29.4</span> The Main Algorithm</a></li>
<li><a href="#what-about-those-other-arguments-to-select" id="toc-what-about-those-other-arguments-to-select" d__=""><span class="toc-section-number">29.5</span> What About Those Other Arguments to <code s__="13">select()</code>?</a>
<ul>
<li><a href="#the-timeout" id="toc-the-timeout" d__=""><span class="toc-section-number">29.5.1</span> The Timeout</a></li>
</ul></li>
<li><a href="#using-select-with-send" id="toc-using-select-with-send" d__=""><span class="toc-section-number">29.6</span> Using <code s__="13">select()</code> with <code s__="13">send()</code></a></li>
<li><a href="#reflect-15" id="toc-reflect-15" d__=""><span class="toc-section-number">29.7</span> Reflect</a></li>
</ul></li>
<li><a href="#project-using-select" id="toc-project-using-select" d__=""><span class="toc-section-number">30</span> Project: Using Select</a>
<ul>
<li><a href="#demo-code" id="toc-demo-code" d__=""><span class="toc-section-number">30.1</span> Demo Code</a></li>
<li><a href="#features-to-add" id="toc-features-to-add" d__=""><span class="toc-section-number">30.2</span> Features to Add</a></li>
<li><a href="#example-run" id="toc-example-run" d__=""><span class="toc-section-number">30.3</span> Example Run</a></li>
</ul></li>
<li><a href="#domain-name-system-dns" id="toc-domain-name-system-dns" d__=""><span class="toc-section-number">31</span> Domain Name System (DNS)</a>
<ul>
<li><a href="#typical-usage" id="toc-typical-usage" d__=""><span class="toc-section-number">31.1</span> Typical Usage</a></li>
<li><a href="#domains-and-ip-addresses" id="toc-domains-and-ip-addresses" d__=""><span class="toc-section-number">31.2</span> Domains and IP Addresses</a></li>
<li><a href="#domain-name-servers" id="toc-domain-name-servers" d__=""><span class="toc-section-number">31.3</span> (Domain) Name Servers</a></li>
<li><a href="#root-name-servers" id="toc-root-name-servers" d__=""><span class="toc-section-number">31.4</span> Root Name Servers</a></li>
<li><a href="#example-run-1" id="toc-example-run-1" d__=""><span class="toc-section-number">31.5</span> Example Run</a></li>
<li><a href="#zones" id="toc-zones" d__=""><span class="toc-section-number">31.6</span> Zones</a></li>
<li><a href="#resolver-library" id="toc-resolver-library" d__=""><span class="toc-section-number">31.7</span> Resolver Library</a></li>
<li><a href="#caching-servers" id="toc-caching-servers" d__=""><span class="toc-section-number">31.8</span> Caching Servers</a>
<ul>
<li><a href="#time-to-live" id="toc-time-to-live" d__=""><span class="toc-section-number">31.8.1</span> Time To Live</a></li>
</ul></li>
<li><a href="#record-types" id="toc-record-types" d__=""><span class="toc-section-number">31.9</span> Record Types</a></li>
<li><a href="#dynamic-dns" id="toc-dynamic-dns" d__=""><span class="toc-section-number">31.10</span> Dynamic DNS</a></li>
<li><a href="#reverse-dns" id="toc-reverse-dns" d__=""><span class="toc-section-number">31.11</span> Reverse DNS</a></li>
<li><a href="#reflect-16" id="toc-reflect-16" d__=""><span class="toc-section-number">31.12</span> Reflect</a></li>
</ul></li>
<li><a href="#network-address-translation-nat" id="toc-network-address-translation-nat" d__=""><span class="toc-section-number">32</span> Network Address Translation (NAT)</a>
<ul>
<li><a href="#a-snail-mail-analogy" id="toc-a-snail-mail-analogy" d__=""><span class="toc-section-number">32.1</span> A Snail-Mail Analogy</a></li>
<li><a href="#why" id="toc-why" d__=""><span class="toc-section-number">32.2</span> Why?</a>
<ul>
<li><a href="#hiding-your-network" id="toc-hiding-your-network" d__=""><span class="toc-section-number">32.2.1</span> Hiding Your Network</a></li>
<li><a href="#ipv4-exhaustion" id="toc-ipv4-exhaustion" d__=""><span class="toc-section-number">32.2.2</span> IPv4 Exhaustion</a></li>
</ul></li>
<li><a href="#private-networks-1" id="toc-private-networks-1" d__=""><span class="toc-section-number">32.3</span> Private Networks</a></li>
<li><a href="#how-it-works" id="toc-how-it-works" d__=""><span class="toc-section-number">32.4</span> How it Works</a></li>
<li><a href="#nat-and-ipv6" id="toc-nat-and-ipv6" d__=""><span class="toc-section-number">32.5</span> NAT and IPv6</a></li>
<li><a href="#port-forwarding" id="toc-port-forwarding" d__=""><span class="toc-section-number">32.6</span> Port Forwarding</a></li>
<li><a href="#review" id="toc-review" d__=""><span class="toc-section-number">32.7</span> Review</a></li>
</ul></li>
<li><a href="#dynamic-host-configuration-protocol-dhcp" id="toc-dynamic-host-configuration-protocol-dhcp" d__=""><span class="toc-section-number">33</span> Dynamic Host Configuration Protocol (DHCP)</a>
<ul>
<li><a href="#operation" id="toc-operation" d__=""><span class="toc-section-number">33.1</span> Operation</a></li>
<li><a href="#reflect-17" id="toc-reflect-17" d__=""><span class="toc-section-number">33.2</span> Reflect</a></li>
</ul></li>
<li><a href="#project-digging-dns-info" id="toc-project-digging-dns-info" d__=""><span class="toc-section-number">34</span> Project: Digging DNS Info</a>
<ul>
<li><a href="#installation" id="toc-installation" d__=""><span class="toc-section-number">34.1</span> Installation</a></li>
<li><a href="#try-it-out-1" id="toc-try-it-out-1" d__=""><span class="toc-section-number">34.2</span> Try it Out</a></li>
<li><a href="#time-to-live-ttl" id="toc-time-to-live-ttl" d__=""><span class="toc-section-number">34.3</span> Time To Live (TTL)</a></li>
<li><a href="#authoritative-servers" id="toc-authoritative-servers" d__=""><span class="toc-section-number">34.4</span> Authoritative Servers</a></li>
<li><a href="#getting-the-root-name-servers" id="toc-getting-the-root-name-servers" d__=""><span class="toc-section-number">34.5</span> Getting the Root Name Servers</a></li>
<li><a href="#digging-at-a-specific-name-server" id="toc-digging-at-a-specific-name-server" d__=""><span class="toc-section-number">34.6</span> Digging at a Specific Name Server</a></li>
<li><a href="#digging-at-a-root-name-server" id="toc-digging-at-a-root-name-server" d__=""><span class="toc-section-number">34.7</span> Digging at a Root Name Server</a></li>
<li><a href="#what-to-do-1" id="toc-what-to-do-1" d__=""><span class="toc-section-number">34.8</span> What to Do</a></li>
</ul></li>
<li><a href="#port-scanning" id="toc-port-scanning" d__=""><span class="toc-section-number">35</span> Port Scanning</a>
<ul>
<li><a href="#mechanics-of-a-portscanner" id="toc-mechanics-of-a-portscanner" d__=""><span class="toc-section-number">35.1</span> Mechanics of a Portscanner</a>
<ul>
<li><a href="#portscanning-udp" id="toc-portscanning-udp" d__=""><span class="toc-section-number">35.1.1</span> Portscanning UDP</a></li>
</ul></li>
<li><a href="#reflect-18" id="toc-reflect-18" d__=""><span class="toc-section-number">35.2</span> Reflect</a></li>
</ul></li>
<li><a href="#firewalls" id="toc-firewalls" d__=""><span class="toc-section-number">36</span> Firewalls</a>
<ul>
<li><a href="#firewall-operation" id="toc-firewall-operation" d__=""><span class="toc-section-number">36.1</span> Firewall Operation</a></li>
<li><a href="#firewalls-and-nat" id="toc-firewalls-and-nat" d__=""><span class="toc-section-number">36.2</span> Firewalls and NAT</a></li>
<li><a href="#local-firewalls" id="toc-local-firewalls" d__=""><span class="toc-section-number">36.3</span> Local Firewalls</a></li>
<li><a href="#reflect-19" id="toc-reflect-19" d__=""><span class="toc-section-number">36.4</span> Reflect</a></li>
</ul></li>
<li><a href="#trusting-user-data" id="toc-trusting-user-data" d__=""><span class="toc-section-number">37</span> Trusting User Data</a>
<ul>
<li><a href="#buffer-overflowoverrun" id="toc-buffer-overflowoverrun" d__=""><span class="toc-section-number">37.1</span> Buffer Overflow/Overrun</a></li>
<li><a href="#injection-attacks" id="toc-injection-attacks" d__=""><span class="toc-section-number">37.2</span> Injection Attacks</a>
<ul>
<li><a href="#system-commands" id="toc-system-commands" d__=""><span class="toc-section-number">37.2.1</span> System Commands</a></li>
<li><a href="#sql-commands" id="toc-sql-commands" d__=""><span class="toc-section-number">37.2.2</span> SQL Commands</a></li>
<li><a href="#cross-site-scripting" id="toc-cross-site-scripting" d__=""><span class="toc-section-number">37.2.3</span> Cross-Site Scripting</a></li>
</ul></li>
<li><a href="#reflect-20" id="toc-reflect-20" d__=""><span class="toc-section-number">37.3</span> Reflect</a></li>
</ul></li>
<li><a href="#project-port-scanning" id="toc-project-port-scanning" d__=""><span class="toc-section-number">38</span> Project: Port Scanning</a></li>
<li><a href="#project-multiuser-chat-client-and-server" id="toc-project-multiuser-chat-client-and-server" d__=""><span class="toc-section-number">39</span> Project: Multiuser Chat Client and Server</a>
<ul>
<li><a href="#overall-architecture" id="toc-overall-architecture" d__=""><span class="toc-section-number">39.1</span> Overall Architecture</a>
<ul>
<li><a href="#server" id="toc-server" d__=""><span class="toc-section-number">39.1.1</span> Server</a></li>
<li><a href="#client" id="toc-client" d__=""><span class="toc-section-number">39.1.2</span> Client</a></li>
</ul></li>
<li><a href="#client-io" id="toc-client-io" d__=""><span class="toc-section-number">39.2</span> Client I/O</a>
<ul>
<li><a href="#special-user-input" id="toc-special-user-input" d__=""><span class="toc-section-number">39.2.1</span> Special User Input</a></li>
</ul></li>
<li><a href="#the-client-tui" id="toc-the-client-tui" d__=""><span class="toc-section-number">39.3</span> The Client TUI</a>
<ul>
<li><a href="#curses-variant-of-chatui" id="toc-curses-variant-of-chatui" d__=""><span class="toc-section-number">39.3.1</span> Curses Variant of <code s__="13">chatui</code></a></li>
</ul></li>
<li><a href="#packet-structure" id="toc-packet-structure" d__=""><span class="toc-section-number">39.4</span> Packet Structure</a></li>
<li><a href="#json-payloads" id="toc-json-payloads" d__=""><span class="toc-section-number">39.5</span> JSON Payloads</a>
<ul>
<li><a href="#hello-payload" id="toc-hello-payload" d__=""><span class="toc-section-number">39.5.1</span> “Hello” Payload</a></li>
<li><a href="#chat-payload" id="toc-chat-payload" d__=""><span class="toc-section-number">39.5.2</span> “Chat” Payload</a></li>
<li><a href="#join-payload" id="toc-join-payload" d__=""><span class="toc-section-number">39.5.3</span> “Join” Payload</a></li>
<li><a href="#leave-payload" id="toc-leave-payload" d__=""><span class="toc-section-number">39.5.4</span> “Leave” Payload</a></li>
</ul></li>
<li><a href="#extensions-2" id="toc-extensions-2" d__=""><span class="toc-section-number">39.6</span> Extensions</a></li>
<li><a href="#some-recommendations" id="toc-some-recommendations" d__=""><span class="toc-section-number">39.7</span> Some Recommendations</a></li>
</ul></li>
<li><a href="#appendix-bitwise" id="toc-appendix-bitwise" d__=""><span class="toc-section-number">40</span> Appendix: Bitwise Operations</a>
<ul>
<li><a href="#coding-different-bases-in-python" id="toc-coding-different-bases-in-python" d__="" style=""><span class="toc-section-number">40.1</span> Coding Different Bases in Python</a></li>
<li><a href="#printing-and-converting" id="toc-printing-and-converting" d__=""><span class="toc-section-number">40.2</span> Printing and Converting</a></li>
<li><a href="#bitwise-and" id="toc-bitwise-and" d__=""><span class="toc-section-number">40.3</span> Bitwise-AND</a></li>
<li><a href="#bitwise-or" id="toc-bitwise-or" d__=""><span class="toc-section-number">40.4</span> Bitwise-OR</a></li>
<li><a href="#bitwise-not" id="toc-bitwise-not" d__=""><span class="toc-section-number">40.5</span> Bitwise-NOT</a></li>
<li><a href="#bitwise-shift" id="toc-bitwise-shift" d__=""><span class="toc-section-number">40.6</span> Bitwise shift</a></li>
<li><a href="#setting-a-given-number-of-1-bits" id="toc-setting-a-given-number-of-1-bits" d__=""><span class="toc-section-number">40.7</span> Setting a Given Number of <code s__="13">1</code> bits</a></li>
<li><a href="#reflect-21" id="toc-reflect-21" d__=""><span class="toc-section-number">40.8</span> Reflect</a></li>
</ul></li>
<li><a href="#appendix-packettracer" id="toc-appendix-packettracer" d__=""><span class="toc-section-number">41</span> Appendix: Installing Packet Tracer</a>
<ul>
<li><a href="#download-packet-tracer" id="toc-download-packet-tracer" d__=""><span class="toc-section-number">41.1</span> Download Packet Tracer</a></li>
<li><a href="#run-packet-tracer" id="toc-run-packet-tracer" d__=""><span class="toc-section-number">41.2</span> Run Packet Tracer</a></li>
</ul></li>
<li><a href="#appendix-threading" id="toc-appendix-threading" d__=""><span class="toc-section-number">42</span> Appendix: Multithreading</a>
<ul>
<li><a href="#concepts" id="toc-concepts" d__=""><span class="toc-section-number">42.1</span> Concepts</a></li>
<li><a href="#multithreading-in-python" id="toc-multithreading-in-python" d__=""><span class="toc-section-number">42.2</span> Multithreading In Python</a></li>
<li><a href="#daemon-threads" id="toc-daemon-threads" d__=""><span class="toc-section-number">42.3</span> Daemon Threads</a>
<ul>
<li><a href="#this-is-somehow-related-to-ctrl-c" id="toc-this-is-somehow-related-to-ctrl-c" d__=""><span class="toc-section-number">42.3.1</span> This is Somehow Related to <code s__="13">CTRL-C</code></a></li>
</ul></li>
<li><a href="#reflect-22" id="toc-reflect-22" d__=""><span class="toc-section-number">42.4</span> Reflect</a></li>
<li><a href="#threading-project" id="toc-threading-project" d__=""><span class="toc-section-number">42.5</span> Threading Project</a>
<ul>
<li><a href="#what-were-building-1" id="toc-what-were-building-1" d__=""><span class="toc-section-number">42.5.1</span> What We’re Building</a></li>
<li><a href="#overall-structure" id="toc-overall-structure" d__=""><span class="toc-section-number">42.5.2</span> Overall Structure</a></li>
<li><a href="#useful-functions" id="toc-useful-functions" d__=""><span class="toc-section-number">42.5.3</span> Useful Functions</a></li>
<li><a href="#things-the-thread-running-function-needs" id="toc-things-the-thread-running-function-needs" d__=""><span class="toc-section-number">42.5.4</span> Things the Thread Running Function Needs</a></li>
<li><a href="#example-run-2" id="toc-example-run-2" d__=""><span class="toc-section-number">42.5.5</span> Example Run</a></li>
<li><a href="#extensions-3" id="toc-extensions-3" d__=""><span class="toc-section-number">42.5.6</span> Extensions</a></li>
</ul></li>
</ul></li>
<li><a href="#appendix-json" id="toc-appendix-json" d__=""><span class="toc-section-number">43</span> Appendix: JSON</a>
<ul>
<li><a href="#json-versus-native" id="toc-json-versus-native" d__=""><span class="toc-section-number">43.1</span> JSON versus Native</a></li>
<li><a href="#converting-back-and-forth" id="toc-converting-back-and-forth" d__=""><span class="toc-section-number">43.2</span> Converting Back and Forth</a></li>
<li><a href="#pretty-printing" id="toc-pretty-printing" d__=""><span class="toc-section-number">43.3</span> Pretty Printing</a></li>
<li><a href="#double-quotes-are-important" id="toc-double-quotes-are-important" d__=""><span class="toc-section-number">43.4</span> Double Quotes are Important</a></li>
<li><a href="#reflect-23" id="toc-reflect-23" d__=""><span class="toc-section-number">43.5</span> Reflect</a></li>
</ul></li>
</ul>
</nav>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to Network Concepts

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- No hyphenation -->
<!-- \hyphenation{scalbn} -->
<!-- Index see alsos -->
<!--
\index{String|see {\texttt{char *}}}
\index{New line|see {\texttt{{\backslash}n} newline}}
\index{Ternary operator|see {\texttt{?:} ternary operator}}
\index{Addition operator|see {\texttt{+} addition operator}}
\index{Subtraction operator|see {\texttt{-} subtraction operator}}
\index{Multiplication operator|see {\texttt{*} multiplication operator}}
\index{Division operator|see {\texttt{/} division operator}}
\index{Modulus operator|see {\texttt{\%} modulus operator}}
\index{Boolean NOT|see {\texttt{"!} operator}}
\index{Boolean AND|see {\texttt{\&\&} operator}}
\index{Boolean OR|see {\texttt{\textbar{}\textbar{}} operator}}
\index{Bell|see {\texttt{{\backslash}a} operator}}
\index{Tab (is better)|see {\texttt{{\backslash}t} operator}}
\index{Carriage return|see {\texttt{{\backslash}r} operator}}
\index{Hexadecimal|see {\texttt{0x} hexadecimal}}
-->
<h1 data-number="1" id="foreword" d__=""><span class="header-section-number">1</span> Foreword</h1>
<p d__="">What is this? Well, it’s a guide to a bunch of concepts that you might see in networking. It’s not Network Programming in C—see <a href="https://beej.us/guide/bgnet"><em d__="">Beej’s Guide to Network Programming</em></a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup s__="13" d__="">1</sup></a> for that. But it is here to help make sense of the terminology, and also to do a bit of network programming in Python.</p>
<p d__="">Is it <em>Beej’s Guide to Network Programming in Python</em>? 
Well, kinda, actually. The C book is more about how C’s (well, Unix’s) 
network API works. And this book is more about the concepts underlying 
it, using Python as a vehicle.</p>
<p d__="">I trust that’s perfectly confusing. Maybe just skip to the <em>Audience</em> section, below.</p>
<h2 data-number="1.1" id="audience" d__=""><span class="header-section-number">1.1</span> Audience</h2>
<p d__="">Are you completely new to networking and are confused by all 
these terms like ISO-OSI, TCP/IP, ports, Ethernet, LANs, and all that? 
And maybe you want to write some network-capable code in Python? 
Congrats! You’re the target audience!</p>
<p d__="">But be forewarned: this guide assumes that you’ve already got some Python programming knowledge under your belt.</p>
<h2 data-number="1.2" id="official-homepage" d__=""><span class="header-section-number">1.2</span> Official Homepage</h2>
<p d__="">This official location of this document is (currently) <a href="https://beej.us/guide/bgnet0/" d__="">https://beej.us/guide/bgnet0/</a><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup s__="13" d__="">2</sup></a>.</p>
<h2 data-number="1.3" id="email-policy" d__=""><span class="header-section-number">1.3</span> Email Policy</h2>
<p d__="">I’m generally available to help out with email questions so 
feel free to write in, but I can’t guarantee a response. I lead a pretty
 busy life and there are times when I just can’t answer a question you 
have. When that’s the case, I usually just delete the message. It’s 
nothing personal; I just won’t ever have the time to give the detailed 
answer you require.</p>
<p d__="">As a rule, the more complex the question, the less likely I am
 to respond. If you can narrow down your question before mailing it and 
be sure to include any pertinent information (like platform, compiler, 
error messages you’re getting, and anything else you think might help me
 troubleshoot), you’re much more likely to get a response.</p>
<p d__="">If you don’t get a response, hack on it some more, try to find
 the answer, and if it’s still elusive, then write me again with the 
information you’ve found and hopefully it will be enough for me to help 
out.</p>
<p d__="">Now that I’ve badgered you about how to write and not write me, I’d just like to let you know that I <em>fully</em>
 appreciate all the praise the guide has received over the years. It’s a
 real morale boost, and it gladdens me to hear that it is being used for
 good! <code s__="13">:-)</code> Thank you!</p>
<h2 data-number="1.4" id="mirroring" d__=""><span class="header-section-number">1.4</span> Mirroring</h2>
<p d__="">You are more than welcome to mirror this site, whether 
publicly or privately. If you publicly mirror the site and want me to 
link to it from the main page, drop me a line at <a href="mailto:beej@beej.us"><code s__="13" d__="">beej@beej.us</code></a>.</p>
<h2 data-number="1.5" id="note-for-translators" d__=""><span class="header-section-number">1.5</span> Note for Translators</h2>
<p d__="">If you want to translate the guide into another language, write me at <a href="https://beej.us/guide/bgnet0/html/beej@beej.us"><code s__="13" d__="">beej@beej.us</code></a> and I’ll link to your translation from the main page. Feel free to add your name and contact info to the translation.</p>
<p d__="">Please note the license restrictions in the Copyright and Distribution section, below.</p>
<h2 data-number="1.6" id="copyright-and-distribution" d__=""><span class="header-section-number">1.6</span> Copyright and Distribution</h2>
<p d__="">Beej’s Guide to Networking Concepts is Copyright © 2023 Brian “Beej Jorgensen” Hall.</p>
<p d__="">With specific exceptions for source code and translations, 
below, this work is licensed under the Creative Commons 
Attribution-Noncommercial-No Derivative Works 3.0 License. To view a 
copy of this license, visit <a href="https://creativecommons.org/licenses/by-nc-nd/3.0/"><code s__="13" d__="">https://creativecommons.org/licenses/by-nc-nd/3.0/</code></a> or send a letter to Creative Commons, 171 Second Street, Suite 300, San Francisco, California, 94105, USA.</p>
<p d__="">One specific exception to the “No Derivative Works” portion of
 the license is as follows: this guide may be freely translated into any
 language, provided the translation is accurate, and the guide is 
reprinted in its entirety. The same license restrictions apply to the 
translation as to the original guide. The translation may also include 
the name and contact information for the translator.</p>
<p d__="">The programming source code presented in this document is 
hereby granted to the public domain, and is completely free of any 
license restriction.</p>
<p d__="">Educators are freely encouraged to recommend or supply copies of this guide to their students.</p>
<p d__="">Contact <a href="https://beej.us/guide/bgnet0/html/beej@beej.us"><code s__="13" d__="">beej@beej.us</code></a> for more information.</p>
<h2 data-number="1.7" id="dedication" d__=""><span class="header-section-number">1.7</span> Dedication</h2>
<p d__="">The hardest things about writing these guides are:</p>
<ul>
<li d__="">Learning the material in enough detail to be able to explain it</li>
<li d__="">Figuring out the best way to explain it clearly, a seemingly-endless iterative process</li>
<li d__="">Putting myself out there as a so-called <em>authority</em>, when really I’m just a regular human trying to make sense of it all, just like everyone else</li>
<li d__="">Keeping at it when so many other things draw my attention</li>
</ul>
<p d__="">A lot of people have helped me through this process, and I want to acknowledge those who have made this book possible.</p>
<ul>
<li d__="">Everyone on the Internet who decided to help share their 
knowledge in one form or another. The free sharing of instructive 
information is what makes the Internet the great place that it is.</li>
<li d__="">Everyone who submitted corrections and pull-requests on everything from misleading instructions to typos.</li>
</ul>
<p d__="">Thank you! ♥</p>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="2" id="networking-overview" d__=""><span class="header-section-number">2</span> Networking Overview</h1>
<p d__="">The Big Idea of networking is that we’re going to get 
arbitrary bytes of data exchanged between two (or more) computers on the
 Internet or LAN.</p>
<p d__="">So we need:</p>
<ul>
<li d__="">A way of identifying the source and destination computers.</li>
<li d__="">A way of maintaining data integrity.</li>
<li d__="">A way of routing data from one computer to another (out of billions).</li>
</ul>
<p d__="">And we need all the hardware and software support to make this happen.</p>
<p d__="">Let’s take a look at two basic kinds of communications networks.</p>
<h2 data-number="2.1" id="circuit-switched" d__=""><span class="header-section-number">2.1</span> Circuit Switched</h2>
<p d__="">Don’t be alarmed! The Internet doesn’t use this type of 
network (at least not as far as it is aware). So you can read the rest 
of this section with the confident knowledge that you won’t have to use 
it again.</p>
<p d__="">For this type of network, visualize an old-school telephone 
operator (like a human operator). Back before you could dial numbers 
directly, a call went something like this:</p>
<p d__="">You’d pick up the receiver and turn a crank on it to generate 
an electrical signal that rang a bell at the other end of the phone 
line, which was in some telephone exchange office somewhere.</p>
<p d__="">An operator would hear the bell and pick up the other end and say something appropriate like, “Operator.”</p>
<p d__="">And you’d tell (like with your voice) the operator what number you wanted to connect to.</p>
<p d__="">Then the operator would physically plug jumper wires into the 
switchboard in front of them to physically complete an electrical 
connection between your phone and the phone of the person you wanted to 
call. You’d have a direct wire from your phone to their phone.</p>
<p d__="">This scales very poorly. And if you had to make a long 
distance call, that cost extra, because an operator would have to call 
another operator over a limited number of long-distance lines.</p>
<p d__="">Eventually, people figured out they could replace the human 
operators with electro-mechanical relays and switches that you could 
control by sending carefully coded signals down the line, either 
electrical pulses (sent by old rotary dial phones) or the 
still-recognizable “touch” tones.</p>
<p d__="">But we still had problems:</p>
<ul>
<li d__="">A dedicated circuit was needed for every call.</li>
<li d__="">Even if you sat there quietly saying nothing, the circuit was still occupied and couldn’t be used by anyone else.</li>
<li d__="">Multiple people couldn’t use the same line at the same time.</li>
<li d__="">There were a limited number of wires you could string up.</li>
</ul>
<p d__="">So the Internet took a different approach.</p>
<h2 data-number="2.2" id="packet-switched" d__=""><span class="header-section-number">2.2</span> Packet Switched</h2>
<p d__="">In a <em>packet switched</em> network, the data you want to 
send is split up into individual packets of varying numbers of bytes. If
 you want to send 83,234 bytes of data, that might be split up into 50 
or 60 packets.</p>
<p d__="">Then each of these packets are individually sent over the lines as space permits.</p>
<p d__="">Imagine little packets of data from computers all over North 
America arriving at a router at the edge of the Atlantic Ocean which 
sends them, one at a time, over a thousands-of-miles-long undersea cable
 to Europe.</p>
<p d__="">Once the packets arrive at their destination computer, that computer reconstructs the data from the individual packets.</p>
<p d__="">This is analogous to writing a snail-mail letter and putting 
it in the post. It ends up in a truck with a bunch of other pieces of 
mail that aren’t going to the same place as yours.</p>
<p d__="">The post office routes the letters through the appropriate mailing facilities until they arrive.</p>
<p d__="">Maybe your letter gets on a plane headed for the opposite side
 of the country with a bunch of other letters. And when the plane 
arrives, those letters might part, with some going north and some going 
south.</p>
<p d__="">They don’t use a whole plane for a single letter–the letters 
are like packets, and they get switched from one transportation medium 
to another.</p>
<p d__="">In the same way, packets of data on the Internet will move 
from computer to computer, sharing the lines between those computers 
with other traffic, until they finally get where they’re going.</p>
<p d__="">And this affords some great advantages in a computer network:</p>
<ul>
<li><p d__="">You don’t need a dedicated circuit between every 
communicating pair of computers (this would likely be a physical 
impossibility if we wanted to support the amount of traffic we currently
 have today).</p></li>
<li><p d__="">Multiple computers can all use the same wire to send data 
at the “same” time. (The packets actually go one at a time, but they’re 
interleaved so it looks simultaneous.)</p></li>
<li><p d__="">A wire can be utilized to full capacity; there’s no “dead 
air” that goes unused if someone wants to use it. One computer’s silence
 is another computer’s opportunity to transmit on the same wire.</p></li>
</ul>
<h2 data-number="2.3" id="clientserver-architecture" d__=""><span class="header-section-number">2.3</span> Client/Server Architecture</h2>
<p d__="">You know this from using the web–you’ve heard of web servers.</p>
<p d__="">A <em>server</em> is a program that <em>listens</em> for incoming connections, <em>accepts</em> them, and then typically receives a request from the <em>client</em> and sends back a response to the client.</p>
<p d__="">Actual conversations between the server and client might be far more complex depending on what the server does.</p>
<p d__="">But both the client and server are network programs. The 
practical difference is the server is the program sitting there waiting 
for clients to call.</p>
<p d__="">Typically one server exists for many clients. Many servers might exist in a <em>server farm</em> to serve many, many, many clients. Think about how many people use Google at the same time.</p>
<h2 data-number="2.4" id="the-os-network-programming-and-sockets" d__=""><span class="header-section-number">2.4</span> The OS, Network Programming, and Sockets</h2>
<p d__="">The network is hardware, and the OS controls all access to 
hardware. So if you want to write software to use the network, you have 
to do it through the OS.</p>
<p d__="">Historically, and modernly, this was done using an API called the <em>sockets</em> API that was pioneered on Unix.</p>
<p d__="">The Unix sockets API is very general purpose, but one of the 
many things it can do is give you a way to read and write data over the 
Internet.</p>
<p d__="">Other languages and operating systems have added the same 
Internet functionality over time, and many of them use different calls 
in their APIs. But as an homage to the original, many of these APIs are 
still called “sockets” APIs even if they don’t match the original.</p>
<p d__="">If you want to use the original sockets API, you can do it programming with C in Unix.</p>
<h2 data-number="2.5" id="protocols" d__=""><span class="header-section-number">2.5</span> Protocols</h2>
<p d__="">You know that conversation that the client and server have? 
It’s written down very specifically what bytes get sent when and from 
and to whom. You can’t just send any old data to a web server–it has to 
be wrapped up a certain way.</p>
<p d__="">Just like you can’t take a letter, wrap it up in aluminum foil
 with no address, and expect the post office to deliver it to your 
intended recipient. That’s breaking post office <em>protocol</em>.</p>
<p d__="">Both the sender and recipient have to be speaking the same protocol for correct communication to occur.</p>
<blockquote>
<p d__="">“Thank you for calling The Pizza Restaurant. Can I help you?” “Would you like fries with that?”</p>
<p d__="">A person calling a pizza restaurant breaks protocol.</p>
</blockquote>
<p d__="">There are many protocols, and we’ll cover a few of them in 
detail later. These were invented by people to solve different sorts of 
problems. If you need to pass data between two specialized programs you 
write, you’ll have to define a protocol for that, too!</p>
<p d__="">Here are some common ones you might have heard of:</p>
<ul>
<li d__="">TCP - used to transmit data reliably.</li>
<li d__="">UDP - used to transmit data quickly and unreliably.</li>
<li d__="">IP - used to route packets over the network from one computer to another.</li>
<li d__="">HTTP - used to get web pages and make other web requests.</li>
<li d__="">Ethernet - used to send data over a LAN.</li>
</ul>
<p d__="">As we’ll see in a moment, these protocols “live” at different layers of the network software.</p>
<h2 data-number="2.6" id="network-layers-and-abstraction" d__=""><span class="header-section-number">2.6</span> Network Layers and Abstraction</h2>
<p d__="">Here’s a quick overview of what happens when data goes out on 
the network. We’ll cover this in much more detail in the coming modules.</p>
<ol type="1">
<li><p d__="">A user program says, “I want to send the bytes ‘GET / HTTP/1.1’ to that web server over there.” (Servers are identified by <em>IP address</em> and a <em>port</em> on the Internet–more on that later.)</p></li>
<li><p d__="">The OS takes the data and wraps it up in a <em>header</em>
 (that is, prepends some data) that provides error detection (and maybe 
ordering) information. The exact structure of this header would be 
defined by a protocol such as TCP or UDP.</p></li>
<li><p d__="">The OS takes all of <em>that</em>, and wraps it up in another header that helps with routing. This header would be defined by the IP protocol.</p></li>
<li><p d__="">The OS hands all that data to the network interface card (the <em>NIC</em>–the piece of hardware that’s responsible for networking).</p></li>
<li><p d__="">The NIC wraps all <em>that</em> data up into another header that’s defined by a protocol such as Ethernet that helps with delivery on the LAN.</p></li>
<li><p d__="">The NIC sends the entire, multiply-wrapped data out over the wire, or over the air (with WiFi).</p></li>
</ol>
<p d__="">When the receiving computer gets the packet, the reverse 
process happens. Its NIC strips the Ethernet header, the OS makes sure 
the IP address is correct, figures out which program is listening on 
that port, and sends it the fully unwrapped data.</p>
<p d__="">All these different layers that do all this wrapping are together called the <em>protocol stack</em>. (This is a different usage of the word “stack” than the stack abstract data type.)</p>
<p d__="">This works well because each layer is responsible for 
different parts of the process, e.g.&nbsp;one layer handles data 
integrity, and another handles routing the packet over the network, and 
another handles the data itself that is being transmitted between the 
programs. And each layer doesn’t care about what the layers below it are
 doing with the data.</p>
<p d__="">It’s that last concept that’s really important: when data is 
going over WiFi, the WiFi hardware doesn’t even care what the data is, 
if it’s Internet data or not, how integrity is assured (or not). All 
WiFi cares about is getting a big chunk of data transmitted over the air
 to another computer. When it arrives at the other computer, that 
computer will strip off the Ethernet stuff and look deeper in the 
packet, deciding what to do with it.</p>
<p d__="">And since the layers don’t care what data is encapsulated 
below them, you can swap out protocols at various layers and still have 
the rest of them work. So if you’re writing a program at the top layer 
(where we tend to write them most commonly), you don’t care what’s 
happening at the layers below that. It’s Somebody Else’s Problem.</p>
<p d__="">For example, you might be getting a web page with 
HTTP/TCP/IP/Ethernet, or you might be transmitting a file to another 
computer with TFTP/UDP/IP/Ethernet. IP and Ethernet work fine in both 
cases, because they are indifferent about the data they are sending.</p>
<p d__="">There are many, many details omitted from this description, but we’re still in high-level overview land.</p>
<h2 data-number="2.7" id="wired-versus-wireless" d__=""><span class="header-section-number">2.7</span> Wired versus Wireless</h2>
<p d__="">When we’re talking about LANs, we can think about network programming as if these two things were the same:</p>
<ul>
<li d__="">Computers on a LAN connected by physical Ethernet cables[1].</li>
<li d__="">Computers on a LAN all connected to the same WiFi access point.</li>
</ul>
<p d__="">Turns out they both use the Ethernet protocol for low-level communication.</p>
<p d__="">So when we say the computers are on the same LAN, we mean they
 are either wired together or they are using the same WiFi access point.</p>
<p d__="">[1] It’s a bit wrong to call them “Ethernet cables” because 
they are just wires, and Ethernet is a protocol that effectively defines
 patterns of electricity that go over those wires. But what I mean is, 
“a cable that is commonly used with Ethernet”.</p>
<h2 data-number="2.8" id="reflect" d__=""><span class="header-section-number">2.8</span> Reflect</h2>
<ul>
<li><p d__="">Is the Internet circuit-switched or packet-switched?</p></li>
<li><p d__="">What is the relationship between a client program and a server program?</p></li>
<li><p d__="">What role does the OS play when you’re writing networked programs?</p></li>
<li><p d__="">What is a protocol?</p></li>
<li><p d__="">What are the reasons for having a protocol stack and data encapsulation?</p></li>
<li><p d__="">What are the practical differences between a WiFi network and a wired network?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="3" id="introducing-the-sockets-api" d__=""><span class="header-section-number">3</span> Introducing The Sockets API</h1>
<p d__="">In Unix, the sockets API generally gives processes a way to 
communicate with one another. It supports a variety of methods of 
communication, and one of those methods is over the Internet.</p>
<p d__="">And that’s the one we’re interested in right now.</p>
<p d__="">In C and Unix, the sockets API is a blend of library calls and system calls (functions that call the OS directly).</p>
<p d__="">In Python, the Python sockets API is a library that calls the 
lower-level C sockets API.&nbsp;At least on Unix-likes. On other 
platforms, it will call whatever API that OS exposes for network 
communication.</p>
<p d__="">We’re going to use this to write programs that communicate over the Internet!</p>
<h2 data-number="3.1" id="client-connection-process" d__=""><span class="header-section-number">3.1</span> Client Connection Process</h2>
<p d__="">The most confusing thing about using sockets is that there are
 generally several steps you have to take to connect to another 
computer, and they’re not obvious.</p>
<p d__="">But they are:</p>
<ol type="1">
<li><p d__=""><strong>Ask the OS for a socket</strong>. In C, this is 
just a file descriptor (an integer) that will be used from here on to 
refer to this network connection. Python will return an object 
representing the socket. Other language APIs might return different 
things.</p>
<p d__="">But the important thing about this step is that you have a way
 to refer to this socket for upcoming data transmission. Note that it’s 
not connected to anything yet at all.</p></li>
<li><p d__=""><strong>Perform a DNS lookup</strong> to convert the human-readable name (like <code s__="13">example.com</code>)
 into an IP address (like 198.51.100.12). DNS is the distributed 
database that holds this mapping, and we query it to get the IP address.</p>
<p d__="">We need the IP address so that we know the machine to connect to.</p>
<p d__="">Python Hint: While you can do DNS lookups in Python with <code s__="13">socket.getaddrinfo()</code>, just calling <code s__="13">socket.connect()</code> with a hostname will do the DNS lookup for you. So you can skip this step.</p>
<p d__="">Optional C Hint: Use <code s__="13">getaddrinfo()</code> to perform this lookup.</p></li>
<li><p d__=""><strong>Connect the socket</strong> to that IP address on a specific port.</p>
<p d__="">Think of a port number like an open door that you can connect through. They’re integers that range from 0 to 65535.</p>
<p d__="">A good example port to remember is 80, which is the standard port used for servers that speak the HTTP protocol (unencrypted).</p>
<p d__="">There must be a server listening on that port on that remote computer, or the connection will fail.</p></li>
<li><p d__=""><strong>Send data and receive data</strong>. This is the part we’ve been waiting for.</p>
<p d__="">Data is sent as a sequence of bytes.</p></li>
<li><p d__="">Close the connection. When we’re done, we close the socket
 indicating to the remote side that we have nothing more to say. The 
remote side can also close the connection any time it wishes.</p></li>
</ol>
<h2 data-number="3.2" id="server-listening-process" d__=""><span class="header-section-number">3.2</span> Server Listening Process</h2>
<p d__="">Writing a server program is a little bit different.</p>
<ol type="1">
<li><p d__=""><strong>Ask the OS for a socket</strong>. Just like with the client.</p></li>
<li><p d__=""><strong>Bind the socket to a port</strong>. This is where 
you assign a port number to the server that other clients can connect 
to. “I’m going to be listening on port 80!” for instance.</p>
<p d__="">Caveat: programs that aren’t run as root/administrator can’t 
bind to ports under 1024–those are reserved. Choose a big, uncommon port
 number for your servers, like something in the 15,000-30,000 range. If 
you try to bind to a port another server is using, you’ll get an 
“Address already in use” error.</p>
<p d__="">Ports are per-computer. It’s OK if two different computers use
 the same port. But two programs on the same computer cannot use the 
same port on that computer.</p>
<p d__="">Fun fact: clients are bound to a port, as well. If you don’t 
explicitly bind them, they get assigned an unused port when the 
connect–which is usually what we want.</p></li>
<li><p d__=""><strong>Listen for incoming connections</strong>. We have to let the OS know when it gets an incoming connection request on the port we selected.</p></li>
<li><p d__=""><strong>Accept incoming connections</strong>. The server 
will block (it will sleep) when you try to accept a new connection if 
none are pending. Then it wakes up when someone tries to connect.</p>
<p d__="">Accept returns a new socket! This is confusing. The original 
socket the server made in step 1 is still there listening for new 
connections. When the connection arrives, the OS makes a new socket <em>specifically for that one connection</em>. This way the server can handle multiple clients at once.</p>
<p d__="">Sometimes the server spawns a new thread or process to handle each new client. But there’s no law that says it has to.</p></li>
<li><p d__=""><strong>Send data and receive data</strong>. This is 
typically where the server would receive a request from the client, and 
the server would send back the response to that request.</p></li>
<li><p d__=""><strong>Go back and accept another connection</strong>. Servers tend to be long-running processes and handle many requests over their lifetimes.</p></li>
</ol>
<h2 data-number="3.3" id="reflect-1" d__=""><span class="header-section-number">3.3</span> Reflect</h2>
<ul>
<li><p d__="">What role does <code s__="13">bind()</code> play on the server side?</p></li>
<li><p d__="">Would a client ever call <code s__="13">bind()</code>? (Might have to search this one on the Internet.)</p></li>
<li><p d__="">Speculate on why <code s__="13">accept()</code> returns a new socket as opposed to just reusing the one we called <code s__="13">listen()</code> with.</p></li>
<li><p d__="">What would happen if the server didn’t loop to another <code s__="13">accept()</code> call? What would happen when a second client tried to connect?</p></li>
<li><p d__="">If one computer is using TCP port 3490, can another computer use port 3490?</p></li>
<li><p d__="">Speculate about why ports exist. What functionality do they make possible that plain IP addresses do not?</p></li>
</ul>
<h2 data-number="3.4" id="resources" d__=""><span class="header-section-number">3.4</span> Resources</h2>
<ul>
<li><a href="https://docs.python.org/3/library/socket.html" d__="">Python Sockets Documentation</a></li>
<li d__=""><a href="https://beej.us/guide/bgnet"><em d__="">Beej’s Guide to Network Programming</em></a><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup s__="13" d__="">3</sup></a>–optional, for C devs</li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="4" id="the-layered-network-model" d__=""><span class="header-section-number">4</span> The Layered Network Model</h1>
<p d__="">Before we get started, here are some terms to know:</p>
<ul>
<li><p d__=""><strong>IP Address</strong> – historically 4-byte number 
uniquely identifying your computer on the Internet. Written in 
dots-and-numbers notation, like so: <code s__="13">198.51.100.99</code>.</p>
<p d__="">These are IP version 4 (“IPv4”) addresses. Typically “v4” is implied in the absence of any other version identifier.</p></li>
<li><p d__=""><strong>Port</strong> – Programs talk through ports, which are numbered 0-65535 and are associated with the TCP or UDP protocols.</p>
<p d__="">Since multiple programs can be running on the same IP address,
 the port provides a way to uniquely identify those programs on the 
network.</p>
<p d__="">For example, it’s very common for a web server to listen for incoming connections on port 80.</p>
<p d__="">Publishing the port number is really important for server programs since client programs need to know where to connect to them.</p>
<p d__="">Clients usually let the OS choose an unused port for them to use since no one tries to connect to clients.</p>
<p d__="">In a URL, the port number is after a colon. Here we try to connect to <code s__="13">example.com</code> on port <code s__="13">3490</code>: <code s__="13">http://example.com:3490/foo.html</code></p>
<p d__="">Ports under 1024 need root/administrator privileges to bind to (but not to connect to).</p></li>
<li><p d__=""><strong>TCP</strong> – Transmission Control Protocol, 
responsible for reliable, in-order data transmission. From a higher-up 
perspective, makes a packet-switched network feel more like a 
circuit-switched network.</p>
<p d__="">TCP uses port numbers to identify senders and receivers of data.</p>
<p d__="">This protocol was invented in 1974 and is still in extremely heavy use today.</p>
<p d__="">In the sockets API, TCP sockets are called <em>stream sockets</em>.</p></li>
<li><p d__=""><strong>UDP</strong> – sibling of TCP, except lighter 
weight. Doesn’t guarantee data will arrive, or that it will be in order,
 or that it won’t be duplicated. If it arrives, it will be error-free, 
but that’s all you get.</p>
<p d__="">In the sockets API, UDP sockets are called <em>datagram sockets</em>.</p></li>
<li><p d__=""><strong>IPv6 Address</strong> – Four bytes isn’t enough to
 hold a unique address, so IP version 6 expands the address size 
considerably to 16 bytes. IPv6 addresses look like this: <code s__="13">::1</code> or <code s__="13">2001:db8::8a2e:370:7334</code>, or even bigger.</p></li>
<li><p d__=""><strong>NAT</strong> – Network Address Translation. A way 
to allow organizations to have private subnets with non-globally-unique 
addresses that get translated to globally-unique addresses as they pass 
through the router.</p>
<p d__="">Private subnets commonly start with addresses <code s__="13">192.168.x.x</code> or <code s__="13">10.x.x.x</code>.</p></li>
<li><p d__=""><strong>Router</strong> – A specialized computer that 
forwards packets through the packet switching network. It inspects 
destination IP addresses to determine which route will get the packet 
closer to its goal.</p></li>
<li><p d__=""><strong>IP</strong> – Internet Protocol. This is 
responsible for identifying computers by IP address and using those 
addresses to route data to recipients through a variety of routers.</p></li>
<li><p d__=""><strong>LAN</strong> – Local Area Network. A network where all the computers are effectively directly connected, not via a router.</p></li>
<li><p d__=""><strong>Interface</strong> – physical networking hardware 
on a computer. A computer might have a number of interfaces. Your 
computer likely has two: a wired Ethernet interface and a wireless 
Ethernet interface.</p>
<p d__="">A router might have a large number of interfaces to be able to
 route packets to a large number of destinations. Your home router 
probably only has two interfaces: one facing inward to your LAN and the 
other facing outward to the rest of the Internet.</p>
<p d__="">Each interface typically has one IP address and one MAC address.</p>
<p d__="">The OS names the interfaces on your local machine. They might be something like <code s__="13">wlan0</code> or <code s__="13">eth2</code> or something else. It depends on the hardware and the OS.</p></li>
<li><p d__=""><strong>Header</strong> – Some data that is prepended to 
some other data by a particular protocol. The header contains 
information appropriate for that protocol. A TCP header would include 
some error detection and correction information and a source and 
destination port number. IP would include the source and destination IP 
addresses. Ethernet would include the source and destination MAC 
addresses. And an HTTP response would include things like the length of 
the data, the date modified, and whether or not the request was 
successful.</p>
<p d__="">Putting a header in front of the data is analogous to putting 
your letter in an envelope in the snail-mail analogy. Or putting that 
envelope in another envelope.</p>
<p d__="">As data moves through the network, additional headers are 
added and removed. Typically only the top-most (front-most?) header is 
removed or added in normal operation, like a stack. (But some software 
and hardware peeks deeper.)</p>
<p d__=""><strong>Network Adapter</strong> – Another name for “network card”, the hardware on your computer that does network stuff.</p>
<p d__=""><strong>MAC Address</strong> – Ethernet interfaces have MAC addresses, which take the form <code s__="13">aa:bb:cc:dd:ee:ff</code>,
 where the fields are random-ish one-byte hex numbers. MAC addresses are
 6 bytes long, and must be unique on the LAN. When a network adapter is 
manufactured, it is given a unique MAC address that it keeps for life, 
typically.</p></li>
</ul>
<h2 data-number="4.1" id="the-layered-network-model-1" d__=""><span class="header-section-number">4.1</span> The Layered Network Model</h2>
<p d__="">When you send data over the Internet, that data is <em>encapsulated</em> in different layers of protocols.</p>
<p d__="">The layers of the conceptual layered network model correspond to various classes of protocols.</p>
<p d__="">And those protocols are responsible for different things, e.g.
 describing data, preserving data integrity, routing, local delivery, 
etc.</p>
<p d__="">So it’s a little chicken-and-eggy, because we can’t really discuss one without the other.</p>
<p d__="">Best just to dive in and take a look at protocols layering headers on top of some data.</p>
<h2 data-number="4.2" id="an-example-of-layering-of-protocols-on-data" d__=""><span class="header-section-number">4.2</span> An Example of Layering of Protocols on Data</h2>
<p d__="">Let’s consider what happens with an HTTP request.</p>
<ol type="1">
<li><p d__="">The web browser builds the HTTP request that looks like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb1-1" d__=""><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>GET / HTTP/1.1</span>
<span id="cb1-2" d__=""><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>Host: example.com</span>
<span id="cb1-3" d__=""><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>Connection: close</span></code></pre></div>
<p d__="">And that’s all the browser cares about. It doesn’t care about IP routing or TCP data integrity or Ethernet.</p>
<p d__="">It just says “Send this data to that computer on port 80”.</p></li>
<li><p d__="">The OS takes over and says, “OK, you asked me to send this
 over a stream-oriented socket, and I’m going to use the TCP protocol to
 do that and ensure all the data arrives intact and in order.”</p>
<p d__="">So the OS takes the HTTP data and wraps it in a TCP header which includes the port number.</p></li>
<li><p d__="">And then the OS says, “And you wanted to send it to this 
remote computer whose IP address is 198.51.100.2, so we’ll use the IP 
protocol to do that.”</p>
<p d__="">And it takes the entire TCP-HTTP data and wraps it up in an IP header. So now we have data that looks like this: IP-TCP-HTTP.</p></li>
<li><p d__="">After that, the OS takes a look at its routing table and 
decides where to send the data next. Maybe the web server is on the LAN,
 conveniently. More likely, it’s somewhere else, so the data would be 
sent to the router for your house destined for the greater Internet.</p>
<p d__="">In either case, it’s going to send the data to a server on the
 LAN, or to your outbound router, also on the LAN. So it’s going to a 
computer on the LAN.</p>
<p d__="">And computers on the LAN have an Ethernet address (AKA <em>MAC address</em>–
which stands for “Media Access Control”), so the sending OS looks up the
 MAC address that corresponds to the next destination IP address, 
whether that’s a local web server or the outbound router. (This happens 
via a lookup in something called the <em>ARP Cache</em>, but we’ll get to that part of the story another time.)</p>
<p d__="">And it wraps the whole IP-TCP-HTTP packet in an Ethernet 
header, so it becomes Ethernet-IP-TCP-HTTP. The web request is still in 
there, buried under layers of protocols!</p></li>
<li><p d__="">And finally, the data goes out on the wire (even if it’s WiFi, we still say “on the wire”).</p></li>
</ol>
<p d__="">The computer with the destination MAC address, listening 
carefully, sees the Ethernet packet on the wire and reads it in. 
(Ethernet packets are called <em>Ethernet frames</em>.)</p>
<p d__="">It strips off the Ethernet header, exposing the IP header below it. It looks at the destination IP address.</p>
<ol type="1">
<li><p d__="">If the inspecting computer is a server and it has that IP 
address, its OS strips off the IP header and looks deeper. (If it 
doesn’t have that IP address, something’s wrong and it discards the 
packet.)</p></li>
<li><p d__="">It looks at the TCP header and does all the TCP magic 
needed to make sure the data isn’t corrupted. If it is, it replies back 
with the magic TCP incantations, saying, “Hey, I need you to send that 
data again, please.”</p>
<p d__="">Note that the web browser or server never knows about this TCP
 conversation that’s happening. It’s all behind the scenes. For all it 
can see, the data is just magically arriving intact and in order.</p>
<p d__="">The reason is that they’re on a higher layer of the network. 
They don’t have to worry about routing or anything. The lower layers 
take care of it.</p></li>
<li><p d__="">If everything’s good with TCP, that header gets stripped 
and the OS is left with the HTTP data. It wakes up the process (the web 
server) that was waiting to read it, and gives it the HTTP data.</p></li>
</ol>
<p d__="">But what if the destination Ethernet address was an intermediate router?</p>
<ol type="1">
<li><p d__="">The router strips off the Ethernet frame as always.</p></li>
<li><p d__="">The router looks at the destination IP address. It 
consults its routing table and decides to which interface to forward the
 packet.</p></li>
<li><p d__="">It sends it out to that interface, which wraps it up in another Ethernet frame and sends it to the next router in line.</p>
<p d__="">(Or maybe it’s not Ethernet! Ethernet is a protocol, and there
 are other low-level protocols in use with fiber optic lines and so on. 
This is part of the beauty of these layers of abstraction–you can switch
 protocols partway through transmission and the HTTP data above it is 
completely unaware that any such thing has happened.)</p></li>
</ol>
<h2 data-number="4.3" id="the-internet-layer-model" d__=""><span class="header-section-number">4.3</span> The Internet Layer Model</h2>
<p d__="">Let’s start with the easier model that splits this 
transmission up into different layers from the top down. (Note that the 
list of protocols is far from exhaustive.)</p>
<!-- CAPTION: Internet Layered Network Model -->
<table>
<colgroup>
<col style="width: 11%">
<col style="width: 44%">
<col style="width: 43%">
</colgroup>
<thead>
<tr>
<th style="text-align: center;" d__="">Layer</th>
<th d__="">Responsibility</th>
<th d__="">Example Protocols</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;" d__="">Application</td>
<td d__="">Structured application data</td>
<td d__="">HTTP, FTP, TFTP, Telnet, SSH, SMTP, POP, IMAP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Transport</td>
<td d__="">Data Integrity, packet splitting and reassembly</td>
<td d__="">TCP, UDP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Internet</td>
<td d__="">Routing</td>
<td d__="">IP, IPv6, ICMP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Link</td>
<td d__="">Physical, signals on wires</td>
<td d__="">Ethernet, PPP, token ring</td>
</tr>
</tbody>
</table>
<p d__="">You can see how different protocols take on the responsibilities of each layer in the model.</p>
<p d__="">Another way to think of this is that all the programs that 
implement HTTP or FTP or SMTP can use TCP or UDP to transmit data. 
(Typically all sockets programs and applications you write that 
implement any protocol will live at the application layer.)</p>
<p d__="">And all data that’s transmitted with TCP or UDP can use IP or IPv6 for routing.</p>
<p d__="">And all data that uses IP or IPv6 for routing can use Ethernet or PPP, etc. for going over the wire.</p>
<p d__="">And as a packet moves down through the layers before being 
transmitted over the wire, the protocols add their own headers on top of
 everything else so far.</p>
<p d__="">This model is complex enough for working on the Internet. You know what they say: as simple as possible, but no simpler.</p>
<p d__="">But there might be other networks in the Universe that aren’t 
the Internet, so there’s a more general model out there that folks 
sometimes use: the OSI model.</p>
<h2 data-number="4.4" id="the-iso-osi-network-layer-model" d__=""><span class="header-section-number">4.4</span> The ISO OSI Network Layer Model</h2>
<p d__="">This is important to know if you’re taking a certification 
test or if you’re going into the field as more than a regular 
programmer.</p>
<p d__="">The Internet Layer Model is a special case of this 
more-detailed model called the ISO OSI model. (Bonus points for being a 
palindrome.) It’s the International Organization for Standardization 
Open Systems Interconnect model. I know that “ISO” is not a direct 
English abbreviation for “International Organization for 
Standardization”, but I don’t have enough global political influence to 
change that.</p>
<p d__="">Coming back to reality, the OSI model is like the Internet model, but more granular.</p>
<p d__="">The Internet model maps to the OSI model, like so, with a 
single layer of the Internet model mapping to multiple layers of the OSI
 model:</p>
<!-- CAPTION: OSI to Internet Layer Mapping -->
<table>
<thead>
<tr>
<th style="text-align: center;" d__="">ISO OSI Layer</th>
<th style="text-align: center;" d__="">Internet Layer</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;" d__="">Application</td>
<td style="text-align: center;" d__="">Application</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Presentation</td>
<td style="text-align: center;" d__="">Application</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Session</td>
<td style="text-align: center;" d__="">Application</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Transport</td>
<td style="text-align: center;" d__="">Transport</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Network</td>
<td style="text-align: center;" d__="">Network</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Data link</td>
<td style="text-align: center;" d__="">Link</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Physical</td>
<td style="text-align: center;" d__="">Link</td>
</tr>
</tbody>
</table>
<p d__="">And if we look at the OSI model, we can see some of the 
protocols that exist at those various layers, similar to what we saw 
with the Internet model, above.</p>
<!-- CAPTION: ISO OSI Network Layer Model -->
<table>
<colgroup>
<col style="width: 12%">
<col style="width: 52%">
<col style="width: 34%">
</colgroup>
<thead>
<tr>
<th style="text-align: center;" d__="">ISO OSI Layer</th>
<th d__="">Responsibility</th>
<th d__="">Example Protocols</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;" d__="">Application</td>
<td d__="">Structured application data</td>
<td d__="">HTTP, FTP, TFTP, Telnet, SMTP, POP, IMAP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Presentation</td>
<td d__="">Encoding translation, encryption, compression</td>
<td d__="">MIME, SSL/TLS, XDR</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Session</td>
<td d__="">Suspending, terminating, restarting sessions between computers</td>
<td d__="">Sockets, TCP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Transport</td>
<td d__="">Data integrity, packet splitting and reassembly</td>
<td d__="">TCP, UDP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Network</td>
<td d__="">Routing</td>
<td d__="">IP IPv6, ICMP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Data link</td>
<td d__="">Encapsulation into frames</td>
<td d__="">Ethernet, PPP, SLIP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Physical</td>
<td d__="">Physical, signals on wires</td>
<td d__="">Ethernet physical layer, DSL, ISDN</td>
</tr>
</tbody>
</table>
<p d__="">We’re going to stick with the Internet model for this course 
since it’s good enough for 99.9% of the network programming work you’d 
ever be likely to do. But please be aware of the OSI model if you’re 
going into an interview for a network-specific programming position.</p>
<h2 data-number="4.5" id="reflect-2" d__=""><span class="header-section-number">4.5</span> Reflect</h2>
<ul>
<li><p d__="">When a router sees an IP address, how does it know where to forward it?</p></li>
<li><p d__="">If an IPv4 address is 4 bytes, roughly how many different 
computers can that represent in total, assuming each computer has a 
unique IP address?</p></li>
<li><p d__="">Same question, except for IPv6 and its 16-byte addresses?</p></li>
<li><p d__="">Bonus question for stats nerds: The odds of winning the 
super lotto jackpot are approximately 300 million to 1. What are the 
odds of randomly picking my pre-selected 16-byte (128-bit) number?</p></li>
<li><p d__="">Speculate on why the IP header wraps up the TCP header in the layered model, and not the other way around.</p></li>
<li><p d__="">If UDP is unreliable and TCP is reliable, speculate on why one might ever use UDP.</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="5" id="project-http-client-and-server" d__=""><span class="header-section-number">5</span> Project: HTTP Client and Server</h1>
<p d__="">We’re going to write a sockets program that can download files
 from a web server! This is going to be our “web client”. This will work
 with almost any web server out there, if we code it right.</p>
<p d__="">And as if that’s not enough, we’re going to follow it up by 
writing a simple web server! This program will be able to handle 
requests from the web client we write… or indeed any other web client 
such as Chrome or Firefox!</p>
<p d__="">These programs are going to speak a protocol you have probably heard of: HTTP, the HyperText Transport Protocol.</p>
<p d__="">And because they speak HTTP, and web browsers like Chrome speak HTTP, they should be able to communicate!</p>
<h2 data-number="5.1" id="restrictions" d__=""><span class="header-section-number">5.1</span> Restrictions</h2>
<p d__="">In order to better understand the sockets API at a lower level, this project may <strong>not</strong> use any of the following helper functions:</p>
<ul>
<li d__="">The <code s__="13">socket.create_connection()</code> function.</li>
<li d__="">The <code s__="13">socket.create_server()</code> function.</li>
<li d__="">Anything in the <code s__="13">urllib</code> modules.</li>
</ul>
<p d__="">After coding up the project, it should be more obvious how these helper functions are implemented.</p>
<h2 data-number="5.2" id="python-character-encoding" d__=""><span class="header-section-number">5.2</span> Python Character Encoding</h2>
<p d__="">The sockets in Python send and receive sequences of bytes, 
which are different than Python strings. You’ll have to convert back and
 forth when you want to send a string, or when you want to print a byte 
sequence as a string.</p>
<p d__="">The sequences of bytes depend on the <em>character encoding</em>
 used by the string. The character encoding defines which bytes 
correspond to which characters. Some encodings you might have heard of 
are ASCII and UTF-8. There are hundreds.</p>
<p d__="">The default character encoding of the web is “ISO-8859-1”.</p>
<p d__="">This is important because you have to encode your Python 
strings into a sequence of bytes and you can tell it the encoding when 
you do that. (It defaults to UTF-8.)</p>
<p d__="">To convert from a Python string to an ISO-8859-1 sequence of bytes:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb2-1" d__=""><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>s <span class="op" d__="">=</span> <span class="st" d__="">"Hello, world!"</span>          <span class="co" d__=""># String</span></span>
<span id="cb2-2" d__=""><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>b <span class="op" d__="">=</span> s.encode(<span class="st" d__="">"ISO-8859-1"</span>)   <span class="co" d__=""># Sequence of bytes</span></span></code></pre></div>
<p d__="">That sequence of bytes is ready to send over the socket.</p>
<p d__="">To convert from a byte sequence you received from a socket in ISO-8859-1 format to a string:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb3-1" d__=""><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>s <span class="op" d__="">=</span> b.decode(<span class="st" d__="">"ISO-8859-1"</span>)</span></code></pre></div>
<p d__="">And then it’s ready to print.</p>
<p d__="">Of course, if the data is not encoded with ISO-8859-1, you’ll get weird characters in your string or an error.</p>
<p d__="">The encodings ASCII, UTF-8, and ISO-8859-1 are all the same 
for your basic latin letters, numbers, and punctuation, so your strings 
will all work as expected unless you start getting into some weird 
Unicode characters.</p>
<p d__="">If you’re writing this is C, it’s probably best just not to 
worry about it and print the bytes out as you get them. A few might be 
garbage, but it’ll work for the most part.</p>
<h2 data-number="5.3" id="http-summary" d__=""><span class="header-section-number">5.3</span> HTTP Summary</h2>
<p d__="">HTTP operates on the concept of <em>requests</em> and <em>responses</em>. The client requests a web page, the server responds by sending it back.</p>
<p d__="">A simple HTTP request from a client looks like this:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb4-1" d__=""><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>GET / HTTP/1.1</span>
<span id="cb4-2" d__=""><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>Host: example.com</span>
<span id="cb4-3" d__=""><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>Connection: close</span></code></pre></div>
<p d__="">That shows the request <em>header</em> which consists of the 
request method, path, and protocol on the first line, followed by any 
number of header fields. There is a blank line at the end of the header.</p>
<p d__="">This request is saying “Get the root web page from the server 
example.com and I’m going to close the connection as soon as I get your 
response.”</p>
<p d__="">Ends-of-line are delimited by a Carriage Return/Linefeed combination. In Python or C, you write a CRLF like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">"</span><span class="ch" d__="">\r\n</span><span class="co" d__="">"</span></span></code></pre></div>
<p d__="">If you were requesting a specific file, it would be on that first line, for example:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb6-1" d__=""><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>GET /path/to/file.html HTTP/1.1</span></code></pre></div>
<p d__="">(And if there were a payload to go with this header, it would go just after the blank line. There would also be a <code s__="13">Content-Length</code> header giving the length of the payload in bytes. We don’t have to worry about this for this project.)</p>
<p d__="">A simple HTTP response from a server looks like:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb7-1" d__=""><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>HTTP/1.1 200 OK</span>
<span id="cb7-2" d__=""><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>Content-Type: text/plain</span>
<span id="cb7-3" d__=""><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>Content-Length: 6</span>
<span id="cb7-4" d__=""><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>Connection: close</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6" d__=""><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>Hello!</span></code></pre></div>
<p d__="">This response says, “Your request succeeded and here’s a 
response that’s 6 bytes of plain text. Also, I’m going to close the 
connection right after I send this to you. And the response payload is 
‘Hello!’.”</p>
<p d__="">Notice that the <code s__="13">Content-Length</code> is set to the size of the payload: 6 bytes for <code s__="13">Hello!</code>.</p>
<p d__="">Another common <code s__="13">Content-Type</code> is <code s__="13">text/html</code> when the payload has HTML data in it.</p>
<h2 data-number="5.4" id="the-client" d__=""><span class="header-section-number">5.4</span> The Client</h2>
<p d__="">The client should be named <code s__="13">webclient.py</code>.</p>
<p d__="">You can write the client before the server first and then test
 it on a real, existing webserver. No need to write both the client and 
server before you test this.</p>
<p d__="">The goal with the client is that you can run it from the command line, like so:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb8-1" d__=""><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python webclient.py example.com</span></code></pre></div>
<p d__="">for output like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb9-1" d__=""><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>HTTP/1.1 200 OK</span>
<span id="cb9-2" d__=""><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>Age: 586480</span>
<span id="cb9-3" d__=""><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>Cache-Control: max-age=604800</span>
<span id="cb9-4" d__=""><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>Content-Type: text/html; charset=UTF-8</span>
<span id="cb9-5" d__=""><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>Date: Thu, 22 Sep 2022 22:20:41 GMT</span>
<span id="cb9-6" d__=""><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>Etag: "3147526947+ident"</span>
<span id="cb9-7" d__=""><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>Expires: Thu, 29 Sep 2022 22:20:41 GMT</span>
<span id="cb9-8" d__=""><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>Last-Modified: Thu, 17 Oct 2019 07:18:26 GMT</span>
<span id="cb9-9" d__=""><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>Server: ECS (sec/96EE)</span>
<span id="cb9-10" d__=""><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>Vary: Accept-Encoding</span>
<span id="cb9-11" d__=""><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>X-Cache: HIT</span>
<span id="cb9-12" d__=""><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>Content-Length: 1256</span>
<span id="cb9-13" d__=""><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>Connection: close</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15" d__=""><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>&lt;!doctype html&gt;</span>
<span id="cb9-16" d__=""><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>&lt;html&gt;</span>
<span id="cb9-17" d__=""><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>&lt;head&gt;</span>
<span id="cb9-18" d__=""><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    &lt;title&gt;Example Domain&lt;/title&gt;</span>
<span id="cb9-19" d__=""><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    ...</span></code></pre></div>
<p d__="">(Output truncated, but it would show the rest of the HTML for the site.)</p>
<p d__="">Notice how the first part of the output is the HTTP response 
with all those fields from the server, and then there’s a blank line, 
and everything following the blank line is the response payload.</p>
<p d__="">ALSO: you need to be able specify a port number to connect to 
on the command line. This defaults to port 80 if not specified. So you 
could connect to a webserver on a different port like so:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb10-1" d__=""><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python webclient.py example.com 8088</span></code></pre></div>
<p d__="">Which would get you to port 8088.</p>
<p d__="">First things first, you need the socket module in Python, so</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb11-1" d__=""><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">import</span> socket</span></code></pre></div>
<p d__="">at the top. Then you have access to the functionality.</p>
<p d__="">Here are some Python-specifics:</p>
<ul>
<li><p d__="">Use <code s__="13">socket.socket()</code> to make a new socket. You don’t have to pass it anything–the default parameter values work for this project.</p></li>
<li><p d__="">Use <code s__="13">s.connect()</code> to connect the new socket to a destination. You can bypass the DNS step since <code s__="13">.connect()</code> does it for you.</p>
<p d__="">This function takes a tuple as an argument that contains the host and port to connect to, e.g.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb12-1" d__=""><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(<span class="st" d__="">"example.com"</span>, <span class="dv" d__="">80</span>)</span></code></pre></div></li>
<li><p d__="">Build and send the HTTP request. You can use the simple HTTP request shown above. <strong>Don’t forget the blank line at the end of the header, and don’t forget to end all lines with <code s__="13">"\r\n"</code>!</strong></p>
<p d__="">I recommend using the <code s__="13">s.sendall()</code> method to do this. You could use <code s__="13">.send()</code> instead but it might only send part of the data.</p>
<p d__="">(C programmers will find an implementation of <code s__="13">sendall()</code> in Beej’s Guide.)</p></li>
<li><p d__="">Receive the web response with the <code s__="13">s.recv()</code>
 method. It will return some bytes in response. You’ll have to call it 
several times in a loop to get all the data from bigger sites.</p>
<p d__="">It will return a byte array of zero elements when the server closes the connection and there’s no more data to read, e.g.:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb13-1" d__=""><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>d <span class="op" d__="">=</span> s.recv(<span class="dv" d__="">4096</span>)  <span class="co" d__=""># Receive up to 4096 bytes</span></span>
<span id="cb13-2" d__=""><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">if</span> <span class="bu" d__="">len</span>(d) <span class="op" d__="">==</span> <span class="dv" d__="">0</span>:</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># all done!</span></span></code></pre></div></li>
<li><p d__="">Call <code s__="13">s.close()</code> on your socket when you’re done.</p></li>
</ul>
<p d__="">Test the client by hitting some websites with it:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb14-1" d__=""><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python webclient.py example.com</span>
<span id="cb14-2" d__=""><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python webclient.py google.com</span>
<span id="cb14-3" d__=""><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python webclient.py oregonstate.edu</span></code></pre></div>
<h2 data-number="5.5" id="the-server" d__=""><span class="header-section-number">5.5</span> The Server</h2>
<p d__="">The server should be named <code s__="13">webserver.py</code>.</p>
<p d__="">You’ll launch the webserver from the command line like so:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb15-1" d__=""><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python webserver.py</span></code></pre></div>
<p d__="">and that should start it listening on port 28333.</p>
<p d__="">Code it so we could also specify an optional port number like this:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb16-1" d__=""><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python webserver.py 12399</span></code></pre></div>
<p d__="">The server is going to going to run forever, handling incoming requests. (Forever means “until you hit CTRL-C”.)</p>
<p d__="">And it’s only going to send back one thing no matter what the 
request is. Have it send back the simple server response, shown above.</p>
<p d__="">So it’s not a very full-featured webserver. But it’s the start of one!</p>
<p d__="">Here are some Python specifics:</p>
<ul>
<li><p d__="">Get a socket just like you did for the client.</p></li>
<li><p d__="">After the call to <code s__="13">socket()</code>, you should add this crazy-looking line:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb17-1" d__=""><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="dv" d__="">1</span>)</span></code></pre></div>
<p d__="">where <code s__="13">s</code> is the socket descriptor you got from <code s__="13">socket()</code>. This will prevent an “Address already in use” error on the <code s__="13">bind()</code>
 in certain circumstances which would certainly be confusing at the 
time. Usually it happens after the server crashes. Later on we’ll figure
 out why that error occurs.</p>
<p d__="">If you do get that error and don’t feel like adding this line 
of code because you’re feeling contrary, you can also just wait a few 
minutes for the OS to give up on the broken connection..</p></li>
<li><p d__="">Bind the socket to a port with <code s__="13">s.bind()</code>.
 This takes one argument, a tuple containing the address and port you 
want to bind to. The address can be left blank to have it choose a local
 address. For example, “Any local address, port 28333” would be passed 
like so:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb18-1" d__=""><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>(<span class="st" d__="">''</span>, <span class="dv" d__="">28333</span>)</span></code></pre></div></li>
<li><p d__="">Set the socket up to listen with <code s__="13">s.listen()</code>.</p></li>
<li><p d__="">Accept new connections with <code s__="13">s.accept()</code>.
 Note that this returns a tuple. The first item in the tuple is a new 
socket representing the new connection. (The old socket is still 
listening and you will call <code s__="13">s.accept()</code> on it again after you’re done handling this request.)</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb19-1" d__=""><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>new_conn <span class="op" d__="">=</span> s.accept()</span>
<span id="cb19-2" d__=""><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>new_socket <span class="op" d__="">=</span> new_conn[<span class="dv" d__="">0</span>]  <span class="co" d__=""># This is what we'll recv/send on</span></span></code></pre></div></li>
<li><p d__="">Receive the request from the client. You should call <code s__="13">new_socket.recv()</code> in a loop similar to how you did it with the client.</p>
<p d__="">When you see a blank line (i.e.&nbsp;<code s__="13">"\r\n\r\n"</code>) in the request, you’ve read enough and can quit receiving.</p>
<p d__="">(We don’t handle payloads in the request for this project. The <em>right</em> thing to do would be to look for a <code s__="13">Content-Length</code> header and then receive the header plus that many bytes. But that’s a stretch goal for you.)</p>
<p d__=""><strong>Beware</strong>: you can’t just loop until <code s__="13">recv()</code>
 returns an empty string this time! This would only happen if the client
 closed the connection, but the client isn’t closing the connection and 
it’s waiting for a response. So you have to call <code s__="13">recv()</code> repeatedly until you see that blank line delimiting the end of the header.</p></li>
<li><p d__="">Send the response. You should just send the “simple server reponse”, from above.</p></li>
<li><p d__="">Close the new socket with <code s__="13">new_socket.close()</code>.</p></li>
<li><p d__="">Loop back to <code s__="13">s.accept()</code> to get the next request.</p></li>
</ul>
<p d__="">Now run the web server in one window and run the client in another, and see if it connects!</p>
<p d__="">Once it’s working with <code s__="13">webclient.py</code>, try it with a web browser!</p>
<p d__="">Run the server on an unused port (choose a big one at random):</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb20-1" d__=""><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python webserver.py 20123</span></code></pre></div>
<p d__="">Go to the URL <a href="http://localhost:20123/"><code s__="13" d__="">http://localhost:20123/</code></a> to view the page. (<code s__="13">localhost</code> is the name of “this computer”.)</p>
<p d__="">If it works, great!</p>
<p d__="">Try printing out the value returned by <code s__="13">.accept()</code>. What’s in there?</p>
<p d__="">Did you notice that if you use a web browser to connect to 
your server, the browser actually makes two connections? Dig into it and
 see if you can figure out why!</p>
<h2 data-number="5.6" id="hints-and-help" d__=""><span class="header-section-number">5.6</span> Hints and Help</h2>
<h3 data-number="5.6.1" id="address-already-in-use" d__=""><span class="header-section-number">5.6.1</span> Address Already In Use</h3>
<p d__="">If your server crashes and then you start getting an “Address 
already in use” error when you try to restart it, it means the system 
hasn’t finished cleaning up the port. (In this case “address” refers to 
the port.) Either switch to a different port for the server, or wait a 
minute or two for it to timeout and clean up.</p>
<h3 data-number="5.6.2" id="receiving-partial-data" d__=""><span class="header-section-number">5.6.2</span> Receiving Partial Data</h3>
<p d__="">Even if you tell <code s__="13">recv()</code> that you want to
 get 4096 bytes, there’s no guarantee that you’ll get all of those. 
Maybe the server sent fewer. Maybe the data got split in transit and 
only part of it is here.</p>
<p d__="">This can get tricky when processing an HTTP request or response because you might call <code s__="13">recv()</code>
 and only get part of the data. Worse, the data might get split in the 
middle of the blank line delimiter at the end of the header!</p>
<p d__="">Don’t assume that a single <code s__="13">recv()</code> call gets you all the data. Always call it in a loop, appending the data to a buffer, until you have the data you want.</p>
<p d__=""><code s__="13">recv()</code> will return an empty string (in Python) or <code s__="13">0</code> (in C) if you try to read from a connection that the other side has closed. This is how you can detect that closure.</p>
<h3 data-number="5.6.3" id="http-301-http-302" d__=""><span class="header-section-number">5.6.3</span> HTTP 301, HTTP 302</h3>
<p d__="">If you run the client and get a server response with code <code s__="13">301</code> or <code s__="13">302</code>, probably along with a message that says <code s__="13">Moved Permanently</code> or <code s__="13">Moved Temporarily</code>,
 this is the server indicating to you that the particular resource 
you’re trying to get at the URL has moved to a different URL.</p>
<p d__="">If you look at the headers below that, you’ll find a <code s__="13">Location:</code> header field.</p>
<p d__="">For example, attempting to run <code s__="13">webclient.py google.com</code> results in:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb21-1" d__=""><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>HTTP/1.1 301 Moved Permanently</span>
<span id="cb21-2" d__=""><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>Location: http://www.google.com/</span>
<span id="cb21-3" d__=""><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>Content-Type: text/html; charset=UTF-8</span>
<span id="cb21-4" d__=""><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>Date: Wed, 28 Sep 2022 20:41:09 GMT</span>
<span id="cb21-5" d__=""><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>Expires: Fri, 28 Oct 2022 20:41:09 GMT</span>
<span id="cb21-6" d__=""><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>Cache-Control: public, max-age=2592000</span>
<span id="cb21-7" d__=""><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>Server: gws</span>
<span id="cb21-8" d__=""><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>Content-Length: 219</span>
<span id="cb21-9" d__=""><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>X-XSS-Protection: 0</span>
<span id="cb21-10" d__=""><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>X-Frame-Options: SAMEORIGIN</span>
<span id="cb21-11" d__=""><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>Connection: close</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13" d__=""><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv="content-type" content="text/html;charset=utf-8"&gt;</span>
<span id="cb21-14" d__=""><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>&lt;TITLE&gt;301 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;</span>
<span id="cb21-15" d__=""><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>&lt;H1&gt;301 Moved&lt;/H1&gt;</span>
<span id="cb21-16" d__=""><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>The document has moved</span>
<span id="cb21-17" d__=""><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>&lt;A HREF="http://www.google.com/"&gt;here&lt;/A&gt;.</span>
<span id="cb21-18" d__=""><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>&lt;/BODY&gt;&lt;/HTML&gt;</span>
<span id="cb21-19" d__=""><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>Connection closed by foreign host.</span></code></pre></div>
<p d__="">Notice the first line is telling us the resource we’re looking for has moved.</p>
<p d__="">The second line with the <code s__="13">Location:</code> field tells us to where it has moved.</p>
<p d__="">When a web browser sees a <code s__="13">301</code> redirect, it automatically goes to the other URL so you don’t have to worry about it.</p>
<p d__="">Try it! Enter <code s__="13">google.com</code> in your browser and watch it update to <code s__="13">www.google.com</code> after a moment.</p>
<h3 data-number="5.6.4" id="http-400-http-501-or-any-500s" d__=""><span class="header-section-number">5.6.4</span> HTTP 400, HTTP 501 (or any 500s)</h3>
<p d__="">If you run the client and get a response from a server that has the code <code s__="13">400</code> or any of the <code s__="13">500</code>s, odds are you have made a bad request. That is, the request data you sent was malformed in some way.</p>
<p d__="">Make sure every field of the header ends in <code s__="13">\r\n</code> and that the header is terminated by a blank line (i.e.&nbsp;<code s__="13">\r\n\r\n</code> are the last 4 bytes of the header).</p>
<h3 data-number="5.6.5" id="http-404-not-found" d__=""><span class="header-section-number">5.6.5</span> HTTP 404 Not Found!</h3>
<p d__="">Make sure you have the <code s__="13">Host:</code> field set correctly to the same hostname as you passed in on the command line. If this is wrong, it’ll <code s__="13">404</code>.</p>
<h2 data-number="5.7" id="extensions" d__=""><span class="header-section-number">5.7</span> Extensions</h2>
<p d__="">These are here if you have time to give yourself the 
additional challenge for greater understanding of the material. Push 
yourself!</p>
<ul>
<li><p d__="">Modify the server to print out the IP address and port of 
the client that just connected to it. Hint: look at the value returned 
by <code s__="13">accept()</code> in Python.</p></li>
<li><p d__="">Modify the client to be able to send payloads. You’ll need to be able to set the <code s__="13">Content-Type</code> and <code s__="13">Content-Length</code> based on the payload.</p></li>
<li><p d__="">Modify the server to extract and print the “request method” from the request. This is most often <code s__="13">GET</code>, but it could also be <code s__="13">POST</code> or <code s__="13">DELETE</code> or many others.</p></li>
<li><p d__="">Modify the server to extract and print a payload sent by the client.</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="6" id="the-internet-protocol-ip" d__=""><span class="header-section-number">6</span> The Internet Protocol (IP)</h1>
<p d__="">This protocol is responsible for routing packets of data 
around the Internet, analogous to how the post office is responsible for
 routing letters around the mail network.</p>
<p d__="">Like with the post office, data on the Internet has to be labeled with a source and destination address, called the <em>IP address</em>.</p>
<p d__="">The IP address is a sequence of bytes that uniquely identifies every computer on the Internet.</p>
<h2 data-number="6.1" id="terminology" d__=""><span class="header-section-number">6.1</span> Terminology</h2>
<ul>
<li d__=""><strong>Host</strong> - another name for “computer”.</li>
</ul>
<h2 data-number="6.2" id="two-common-versions" d__=""><span class="header-section-number">6.2</span> Two Common Versions</h2>
<p d__="">There are two commonly used versions of IP: version 4 and version 6.</p>
<p d__="">IP version 4 is referred to as “IPv4” or just plain “IP”.</p>
<p d__="">IP version 6 is usually explicitly specified as “IPv6”.</p>
<p d__="">You can tell the difference between the two by glancing at an IP address:</p>
<ul>
<li><p d__="">Version 4 IP address example: 192.168.1.3</p></li>
<li><p d__="">Version 6 IP address example: fe80::c2b6:f9ff:fe7e:4b4</p></li>
</ul>
<p d__="">The main difference is the number of bytes that make up the 
address space. IPv4 uses 4 bytes per address, and IPv6 uses 16 bytes.</p>
<h2 data-number="6.3" id="subnets" d__=""><span class="header-section-number">6.3</span> Subnets</h2>
<p d__="">Every IP address is split into two portions.</p>
<p d__="">The initial bits of the IP address identify individual networks.</p>
<p d__="">The trailing bits of an IP address identify individual hosts (i.e. computers) on that network.</p>
<p d__="">These individual networks are called <em>subnets</em> and the number of hosts they can support depends on how many bits they’re reserved for identifying hosts on that subnet.</p>
<p d__="">As a contrived non-Internet example, let’s look at an 8-bit 
“address”, and we’ll say the first 6 bits are the network number and the
 last 2 bits are the host number.</p>
<p d__="">So an address like this:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb22-1" d__=""><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>00010111</span></code></pre></div>
<p d__="">is split into two parts (because we said the first 6 bits were the network number):</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb23-1" d__=""><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>Network  Host</span>
<span id="cb23-2" d__=""><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>-------  ----</span>
<span id="cb23-3" d__=""><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>000101   11</span></code></pre></div>
<p d__="">So this is network 5 (<code s__="13">101</code> binary), host 3 (<code s__="13">11</code> binary).</p>
<p d__="">The network part always comes before the host part.</p>
<p d__="">Note that if there are only two “host” bits, there can only be 4 hosts on the network, numbered 0, 1, 2, and 3 (or <code s__="13">00</code>, <code s__="13">01</code>, <code s__="13">10</code>, and <code s__="13">11</code> in binary).</p>
<p d__="">And with IP, it would actually only be two hosts, because hosts with all zero bits or all one bits are reserved.</p>
<p d__="">The next chapters will look at specific subnet examples for 
IPv4 and IPv6. The important part now is that each address is split into
 network and host parts, with the network part first.</p>
<h2 data-number="6.4" id="additional-ip-layer-protocols" d__=""><span class="header-section-number">6.4</span> Additional IP-layer Protocols</h2>
<p d__="">There are some related protocols that also work in concert with IP and at the same layer in the network stack.</p>
<ul>
<li><p d__=""><strong>ICMP</strong>: Internet Control Message Protocol, a mechanism for communicating IP nodes to talk about IP control metadata with one another.</p></li>
<li><p d__=""><strong>IPSec</strong>: Internet Protocol Security, encryption and authentication functionality. Commonly used with VPNs (Virtual Private Networks).</p></li>
</ul>
<p d__="">Users commonly interface with ICMP when using the <code s__="13">ping</code> utility. This uses ICMP “echo request” and “echo response” messages.</p>
<p d__="">The <code s__="13">traceroute</code> utility uses ICMP “time exceeded” messages to find out how packets are being routed.</p>
<h2 data-number="6.5" id="private-networks" d__=""><span class="header-section-number">6.5</span> Private Networks</h2>
<p d__="">There are private networks hidden behind routers that do not 
have globally unique IP addresses on their machines. (Though they do 
have unique addresses within the LAN itself.)</p>
<p d__="">This is made possible through the magic of a mechanism called 
NAT (Network Address Translation). But this is a story for the future.</p>
<p d__="">For now, let’s just pretend all our addresses are globally unique.</p>
<h2 data-number="6.6" id="static-versus-dynamic-ip-addresses-and-dhcp" d__=""><span class="header-section-number">6.6</span> Static versus Dynamic IP Addresses, and DHCP</h2>
<p d__="">If you have clients hitting your website, or you have a server that you want to SSH into repeatedly, you’ll need a <em>static IP</em>. This means you get a globally-unique IP address assigned to you and it never changes.</p>
<p d__="">This is like having a house number that never changes. If you 
need people to be able to find your house repeatedly, this needs to be 
the case.</p>
<p d__="">But since there are a limited number of IPv4 addresses, static
 IPs cost more money. Often an ISP will have a block of IPs on a subnet 
that they <em>dynamically</em> allocate on-demand.</p>
<p d__="">This means when you reboot your broadband modem, it might end 
up with a different public-facing IP address when it comes back to life.
 (Unless you’ve paid for a static IP.)</p>
<p d__="">Indeed, when you connect your laptop to WiFi, you also 
typically get a dynamic IP address. Your computer connects to the LAN 
and broadcasts a packet saying, “Hey, I’m here! Can anyone tell me my IP
 address? Pretty please with sugar on top?”</p>
<p d__="">And this is OK because people aren’t generally trying to 
connect to servers on your laptop. It’s usually the laptop that’s 
connecting to other servers.</p>
<p d__="">How does it work? On one of the servers on the LAN is a program that is listening for such requests, which conform to DHCP (the <em>Dynamic Host Configuration Protocol</em>).
 The DHCP server keeps track of which IP addresses on the subnet are 
already allocated for use, and which are free. It allocates a free one 
and sends back a DHCP response that has your laptop’s new IP address, as
 well as other data about the LAN your computer needs (like subnet mask,
 etc.).</p>
<p d__="">If you have WiFi at home, you very likely already have a DHCP 
server. Most routers come from your ISP with DHCP already set up, which 
is how your laptop gets its IP address on your LAN.</p>
<h2 data-number="6.7" id="reflect-3" d__=""><span class="header-section-number">6.7</span> Reflect</h2>
<ul>
<li><p d__="">How many times more IPv6 addresses are there than IPv4 addresses?</p></li>
<li><p d__="">Applications commonly also implement their own encryption 
(e.g.&nbsp;ssh or web browsers with HTTPS). Speculate on the advantages 
or disadvantages for having IPSec at the Internet layer instead of doing
 encryption at the Application layer.</p></li>
<li><p d__="">If subnet reserved 5 bits to identify hosts, how many 
hosts can it support? Don’t forget that all-zero-bits and all-one-bits 
for the host are reserved.</p></li>
<li><p d__="">What is the benefit to having a static IP? How does it relate to DNS?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="7" id="the-internet-protocol-version-4" d__=""><span class="header-section-number">7</span> The Internet Protocol version 4</h1>
<p d__="">This is the first popular version of the Internet Protocol, and it lives to this day in common use.</p>
<h2 data-number="7.1" id="ip-addresses" d__=""><span class="header-section-number">7.1</span> IP Addresses</h2>
<p d__="">An IPv4 address is written in “dots and numbers” notation, like so:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb24-1" d__=""><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>198.51.100.125</span></code></pre></div>
<p d__="">It’s always four numbers. Each number represents a byte, so it can go from 0 to 255 (<code s__="13">00000000</code> to <code s__="13">11111111</code> binary).</p>
<p d__="">This means that every IPv4 address is four bytes (32 bits) in size.</p>
<h2 data-number="7.2" id="subnets-1" d__=""><span class="header-section-number">7.2</span> Subnets</h2>
<p d__="">The entire space of IP addresses is split up into <em>subnets</em>.
 The first part of the IP address indicates the subnet number we’re 
talking about. The remaining part indicates the computer on that subnet 
in question.</p>
<p d__="">And how many bits “the first part of the IP” constitutes is variable.</p>
<p d__="">When you set up a network with public-facing IP addresses, you
 are allocated a subnet by whomever you are paying to provide you with a
 connection. The more hosts your subnet supports, the more expensive it 
is.</p>
<p d__="">So you might say, “I need 180 IP static IP addresses.”</p>
<p d__="">And your provider says, OK, that means you’ll have 180 IPs and
 2 reserved (0 and the highest number), so 182 total. We need 8 bits to 
represent the numbers 0-255, which is the smallest number of bits that 
includes 182.</p>
<p d__="">And so they allocate you a subnet that has 24 network bits and 8 host bits.</p>
<p d__="">They could write out something like:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb25-1" d__=""><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>Your subnet is 198.51.100.0 and there are 24 network bits and 8 host</span>
<span id="cb25-2" d__=""><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>bits.</span></code></pre></div>
<p d__="">But that’s really verbose. So we use slash notation:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb26-1" d__=""><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>198.51.100.0/24</span></code></pre></div>
<p d__="">This tells us that 24 bits of the IP address represent the network number. (And therefore <code s__="13">32-24=8</code> bits represent the host.) But what does that mean?</p>
<p d__="">Drawing it out:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb27-1" d__=""><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>24 network bits</span>
<span id="cb27-2" d__=""><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>----------</span>
<span id="cb27-3" d__=""><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>198.51.100.0</span>
<span id="cb27-4" d__=""><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>           -</span>
<span id="cb27-5" d__=""><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>         8 host bits</span></code></pre></div>
<p d__="">Or converting all those numbers to binary:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb28-1" d__=""><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>       24 network bits         | 8 host bits</span>
<span id="cb28-2" d__=""><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>-------------------------------+---------</span>
<span id="cb28-3" d__=""><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>11000110 . 00110011 . 01100100 . 00000000</span>
<span id="cb28-4" d__=""><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>     198         51        100          0</span></code></pre></div>
<p d__="">The upshot is that every single IP on our make-believe network here is going to start with <code s__="13">198.51.100.x</code>. And that last byte is going to indicate which host we’re talking about.</p>
<p d__="">Here are some example IPs on our network:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb29-1" d__=""><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>198.51.100.2</span>
<span id="cb29-2" d__=""><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>198.51.100.3</span>
<span id="cb29-3" d__=""><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>198.51.100.4</span>
<span id="cb29-4" d__=""><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>198.51.100.30</span>
<span id="cb29-5" d__=""><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>198.51.100.212</span></code></pre></div>
<p d__="">But these two addresses have special meaning (see below):</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb30-1" d__=""><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>198.51.100.0     Reserved</span>
<span id="cb30-2" d__=""><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>198.51.100.255   Broadcast (see below)</span></code></pre></div>
<p d__="">but other than those, we can use the other IPs as we see fit.</p>
<p d__="">Now, I deliberately chose an example there where the subnet 
ended on a byte boundary because it’s easier to see if the entire last 
byte is the host number.</p>
<p d__="">But there’s no law about that. We could easily have a subnet like this:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb31-1" d__=""><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>198.51.100.96/28</span></code></pre></div>
<p d__="">In that case we have:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb32-1" d__=""><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>           28 network bits           | 4 host bits</span>
<span id="cb32-2" d__=""><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>-------------------------------------+----</span>
<span id="cb32-3" d__=""><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>11000110 . 00110011 . 01100100 . 0110 0000</span>
<span id="cb32-4" d__=""><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>     198         51        100          96</span></code></pre></div>
<p d__="">and we could only fill those last 4 bits with different numbers to represent our hosts.</p>
<p d__=""><code s__="13">0000</code> and <code s__="13">1111</code> are reserved and broadcast, leaving us with 14 more we could use for host numbers.</p>
<p d__="">For example, we could fill in those last <a href="https://en.wikipedia.org/wiki/Nibble" d__="">4 bits</a> with host number 2 (which is <code s__="13">0010</code> binary):</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb33-1" d__=""><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>           28 network bits           | 4 host bits</span>
<span id="cb33-2" d__=""><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>-------------------------------------+----</span>
<span id="cb33-3" d__=""><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>11000110 . 00110011 . 01100100 . 0110 0010</span>
<span id="cb33-4" d__=""><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>     198         51        100          98</span></code></pre></div>
<p d__="">Giving the IP address <code s__="13">198.51.100.98</code>.</p>
<p d__="">All the IP addresses on this subnet are, exhaustively <code s__="13">198.51.100.96</code> through <code s__="13">198.51.100.111</code> (though these first are last IPs are reserved and broadcast, respectively).</p>
<p d__="">Finally, if you have a subnet you own, there’s nothing 
stopping you for further subnetting it down–declaring that more bits are
 reserved for the network portion of the address.</p>
<p d__="">ISPs (Internet Service Providers, like your cable or DSL 
company) do this all the time. They’ve given a big subnet with, say, 12 
network bits (20 host bits, for 1 million possible hosts). And they have
 customers who want their own subnets. So the ISP decides the next 9 
bits (for example) are going to be used to uniquely identify additional 
subnets within the ISP’s subnet. And it sells those to customers, and 
each customer gets 11 bits for hosts (supporting 2048 hosts).</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb34-1" d__=""><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>  ISP network  |   Subnets  |    Hosts</span>
<span id="cb34-2" d__=""><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>   (12 bits)   |  (9 bits)  |  (11 bits)</span>
<span id="cb34-3" d__=""><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>---------------+------------+--------------</span>
<span id="cb34-4" d__=""><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>11010110 . 1100 0101 . 11011 001 . 00101101   [example IP]</span></code></pre></div>
<p d__="">But it doesn’t even stop there, necessarily. Maybe one of 
those customers you sold an 11-bit subnet to wants to further subdivide 
it–they can add more network bits to define their own subnets. Of 
course, every time you add more network bits, you’re taking away from 
the number of hosts you can have, but that’s the tradeoff you have to 
make with subnetting.</p>
<h2 data-number="7.3" id="subnet-masks" d__=""><span class="header-section-number">7.3</span> Subnet Masks</h2>
<p d__="">Another way of writing subnet is with a <em>subnet mask</em>. This is a number that when bitwise-ANDed with any IP address will give you the subnet number.</p>
<p d__="">What does that mean? And why?</p>
<p d__="">The subnet mask is also written with dots-and-numbers notation, and looks like an IP address with all the subnet bits set to <code s__="13">1</code>.</p>
<p d__="">For example, if we have the subnet <code s__="13">198.51.100.0/24</code>, that means we have:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb35-1" d__=""><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>       24 network bits         | 8 host bits</span>
<span id="cb35-2" d__=""><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>-------------------------------+---------</span>
<span id="cb35-3" d__=""><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>11000110 . 00110011 . 01100100 . 00000000</span>
<span id="cb35-4" d__=""><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>     198         51        100          0</span></code></pre></div>
<p d__="">Putting a <code s__="13">1</code> in for all the network bits, we end up with:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb36-1" d__=""><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>       24 network bits         | 8 host bits</span>
<span id="cb36-2" d__=""><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>-------------------------------+---------</span>
<span id="cb36-3" d__=""><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>11111111 . 11111111 . 11111111 . 00000000</span>
<span id="cb36-4" d__=""><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>     255        255        255          0</span></code></pre></div>
<p d__="">So the subnet mask for <code s__="13">198.51.100.0/24</code> is <code s__="13">255.255.255.0</code>. It’s the same subnet mask for <em>any</em> <code s__="13">/24</code> subnet.</p>
<p d__="">The subnet mask for a <code s__="13">/16</code> subnet has the first 16 bits set to <code s__="13">1</code>: <code s__="13">255.255.0.0</code>.</p>
<p d__="">But why? Turns out a router can take any IP address and 
quickly determine its destination subnet by ANDing the IP address with 
the subnet mask.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb37-1" d__=""><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>         24 network bits         | 8 host bits</span>
<span id="cb37-2" d__=""><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  -------------------------------+---------</span>
<span id="cb37-3" d__=""><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  11000110 . 00110011 . 01100100 . 01000011    198. 51.100.67</span>
<span id="cb37-4" d__=""><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>&amp; 11111111 . 11111111 . 11111111 . 00000000  &amp; 255.255.255. 0</span>
<span id="cb37-5" d__=""><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>-------------------------------------------  ----------------</span>
<span id="cb37-6" d__=""><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  11000110 . 00110011 . 01100100 . 00000000    198. 51.100. 0</span></code></pre></div>
<p d__="">And so the subnet for the IP address <code s__="13">198.51.100.67</code> with subnet mask <code s__="13">255.255.255.0</code> is <code s__="13">198.51.100.0</code>.</p>
<h2 data-number="7.4" id="historic-subnets" d__=""><span class="header-section-number">7.4</span> Historic Subnets</h2>
<p><em d__="">(This information is only included for historical interest.)</em></p>
<p d__="">Before the idea that any number of bits could be reserved for the network, subnets were split into 3 main classes:</p>
<ul>
<li d__=""><strong>Class A</strong> - Subnet mask <code s__="13">255.0.0.0</code> (or <code s__="13">/8</code>), supports 16,777,214 hosts</li>
<li d__=""><strong>Class B</strong> - Subnet mask <code s__="13">255.255.0.0</code> (or <code s__="13">/16</code>), supports 65,534 hosts</li>
<li d__=""><strong>Class C</strong> - Subnet mask <code s__="13">255.255.255.0</code> (or <code s__="13">/24</code>) supports 254 hosts</li>
</ul>
<p d__="">The problem was that this caused a really uneven distribution 
of subnets, with some large companies getting 16 million hosts (that 
they didn’t need), and there was no subnet class that supported a 
sensible number of computers, like 1,000.</p>
<p d__="">So we switched to the more-flexible “any number of bits in the mask” approach.</p>
<h2 data-number="7.5" id="special-addresses" d__=""><span class="header-section-number">7.5</span> Special Addresses</h2>
<p d__="">There are a few common addresses that are worth noting:</p>
<ul>
<li><p d__=""><strong>127.0.0.1</strong> - this is the computer you are on now. It’s often mapped to the name <code s__="13">localhost</code>.</p></li>
<li><p d__=""><strong>0.0.0.0</strong> - Reserved. Host 0 on any subnet is reserved.</p></li>
<li><p d__=""><strong>255.255.255.255</strong> - Broadcast. Intended for
 all hosts on a subnet. Though it seems like this would broadcast to the
 entire Internet, routers don’t forward packets intended for this 
address.</p>
<p d__="">You can also broadcast to your local subnet by sending to the 
host with all bits set to 1. For example, the subnet broadcast address 
for <code s__="13">198.51.100.0/24</code> is <code s__="13">198.51.100.255</code>.</p></li>
</ul>
<h2 data-number="7.6" id="special-subnets" d__=""><span class="header-section-number">7.6</span> Special Subnets</h2>
<p d__="">There are some reserved subnets you might come across:</p>
<ul>
<li d__=""><strong>10.0.0.0/8</strong> - Private network addresses (<em>very common</em>)</li>
<li d__=""><strong>127.0.0.0/8</strong> - This computer, via the <em>loopback</em> device.</li>
<li d__=""><strong>172.16.0.0/12</strong> - Private network addresses</li>
<li d__=""><strong>192.0.0.0/24</strong> - Private network addresses</li>
<li d__=""><strong>192.0.2.0/24</strong> - Documentation</li>
<li d__=""><strong>192.168.0.0/16</strong> - Private network addresses (<em>very common</em>)</li>
<li d__=""><strong>198.18.0.0/15</strong> - Private network addresses</li>
<li d__=""><strong>198.51.100.0/24</strong> - Documentation</li>
<li d__=""><strong>203.0.113.0/24</strong> - Documentation</li>
<li d__=""><strong>233.252.0.0/24</strong> - Documentation</li>
</ul>
<p d__="">You’ll find your home IPs are in one of the “Private” address ranges. Probably <code s__="13">192.168.x.x</code>.</p>
<p d__="">Any documentation that you write that requires example (not 
real) IP addresses should use any of the ones marked “Documentation”, 
above.</p>
<h2 data-number="7.7" id="reflect-4" d__=""><span class="header-section-number">7.7</span> Reflect</h2>
<ul>
<li><p d__=""><code s__="13">192.168.262.12</code> is not a valid IP address. Why?</p></li>
<li><p d__="">Reflect on some of the advantages of the subnet concept as a way of dividing the global address space.</p></li>
<li><p d__="">What is your computer’s IPv4 address and subnet mask right
 now? (You might have to search how to find this for your particular 
OS.)</p></li>
<li><p d__="">If a IP address is listed as 10.37.129.212/17, how many bits are used to represent the hosts?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="8" id="the-internet-protocol-version-6" d__=""><span class="header-section-number">8</span> The Internet Protocol version 6</h1>
<p d__="">This is the new big thing! Since there are so few addresses 
representable in 32 bits (only 4,294,967,296 not counting the reserved 
ones), the Powers That Be decided we needed a new addressing scheme. One
 with more bits. One that could last, for all intents and purposes, 
forever.</p>
<p d__="">There was a problem: we were running out of IP addresses. Back
 in the 1970s, a world with billions of computers was beyond 
imagination. But today, we’ve already exceeded this by orders of 
magnitude.</p>
<p d__="">So they decided to increase the size of IP addresses from 32 
bits to 128 bits, which gives us 79,228,162,514,264,337,593,543,950,336 
times as much address space. This should genuinely last a looooooong 
time.</p>
<blockquote>
<p d__="">Lots of this address space is reserved, so there aren’t really that many addresses. But there are still a <strong>LOT</strong>, both imperial and metric.</p>
</blockquote>
<p d__="">That’s the main difference between IPv4 and IPv6.</p>
<p d__="">For demonstration purposes, we’ll stick with IPv4 because it’s
 still common and a little easier to write out. But this is good 
background information to know, since someday IPv6 will be the only game
 in town.</p>
<p d__="">Someday.</p>
<h2 data-number="8.1" id="representation" d__=""><span class="header-section-number">8.1</span> Representation</h2>
<p d__="">With that much address space, dots-and-decimal numbers won’t 
cut it. So they came up with a new way of displaying IPv6 addresses: 
colons-and-hex numbers. And each hex number is 16 bits (4 hex digits), 
so we need 8 of those numbers to get us to 128 bits.</p>
<p d__="">For example:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb38-1" d__=""><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>2001:0db8:6ffa:8939:163b:4cab:98bf:070a</span></code></pre></div>
<p d__="">Slash notation is used for subnetting just like IPv4. Here’s an example with 64 bits for network (as specified with <code s__="13">/64</code>) and 64 bits for host (since <code s__="13">128-64=64</code>):</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb39-1" d__=""><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>2001:0db8:6ffa:8939:163b:4cab:98bf:070a/64</span></code></pre></div>
<p d__="">64 bits for host! That means this subnet can have 18,446,744,073,709,551,616 hosts!</p>
<p d__="">There’s a lot of space in an IPv6 address!</p>
<blockquote>
<p d__="">When we’re talking about standard IPv6 addresses for particular hosts, <code s__="13">/64</code> is the strongly-suggested rule for how big your subnet is. Some protocols rely on it.</p>
<p d__="">But when we’re just talking about subnets, you might see 
smaller numbers there representing larger address spaces. But the 
expectation is that eventually that space will be partitioned down into <code s__="13">/64</code> subnets for use by individual hosts.</p>
</blockquote>
<p d__="">Now, writing all those hex numbers can be unwieldy, especially
 if there are large runs of zeros in them. So there are a couple 
shortcut rules.</p>
<ol type="1">
<li d__="">Leading zeros on any 16-bit number can be removed.</li>
<li d__="">Runs of multiple zeros after rule 1 has been applied can be replaced with two sequential colons.</li>
</ol>
<p d__="">For example, we might have the address:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb40-1" d__=""><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>2001:0db8:6ffa:0000:0000:00ab:98bf:070a</span></code></pre></div>
<p d__="">And we apply the first rule and get rid of leading zeros:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb41-1" d__=""><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>2001:db8:6ffa:0:0:ab:98bf:70a</span></code></pre></div>
<p d__="">And we see we have a run of two <code s__="13">0</code>s in the middle, and we can replace that with two colons:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb42-1" d__=""><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>2001:db8:6ffa::ab:98bf:70a</span></code></pre></div>
<p d__="">In this way we can get a more compact representation.</p>
<h2 data-number="8.2" id="link-local-addresses" d__=""><span class="header-section-number">8.2</span> Link-Local Addresses</h2>
<p d__="">[This is “good to know” information, but just file it away under “IPv6 automatically gives all interfaces an IP address”.]</p>
<p d__="">There are addresses in IPv6 and IPv4 that are reserved for 
hosts on this particular LAN. These aren’t commonly used in IPv4, but 
they’re required in IPv6. The addresses are all on subnet <code s__="13">fe80::/10</code>.</p>
<blockquote>
<p d__="">Expanded out, this is:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb43-1" d__=""><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fe80:0000:0000:0000:0000:0000:0000:0000</span></code></pre></div>
</blockquote>
<p d__="">The first 10 bits being the network portion. In an IPv6 link-local address, the next 54 bits are reserved (<code s__="13">0</code>) and then there are 64 bits remaining to identify the host.</p>
<p d__="">When an IPv6 interface is brought up, it automatically 
computes its link-local address based on its Ethernet address and other 
things.</p>
<p d__="">Link-local addresses are unique on the LAN, but might not be 
globally-unique. Routers do not forward any link-local packets out of 
the LAN to prevent issues with duplicate IPs.</p>
<p d__="">An interface might get a different IP later if a DHCP server hands one out, for example, in which case it’ll have two IPs.</p>
<h2 data-number="8.3" id="special-ipv6-addresses-and-subnets" d__=""><span class="header-section-number">8.3</span> Special IPv6 Addresses and Subnets</h2>
<p d__="">Like with IPv4, there are a lot of addresses that have special meaning.</p>
<ul>
<li d__=""><strong><code s__="13">::1</code></strong> - localhost, this computer, IPv6 version of <code s__="13">127.0.0.1</code></li>
<li d__=""><strong><code s__="13">2001:db8::/32</code></strong> - for use in documentation</li>
<li d__=""><strong><code s__="13">fe80::/10</code></strong> - link local address</li>
</ul>
<p d__="">There are IPv6 ranges with special meanings, but those are the common ones you’ll see.</p>
<h2 data-number="8.4" id="ipv6-and-dns" d__=""><span class="header-section-number">8.4</span> IPv6 and DNS</h2>
<p d__="">DNS maps human-readable names to IPv6 addresses, as well. You can look them up with <code s__="13">dig</code> by telling it to look for an <code s__="13">AAAA</code> record (which is what DNS calls IPv6 address records).</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb44-1" d__=""><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>$ dig example.com AAAA</span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb45-1" d__=""><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; example.com AAAA</span>
<span id="cb45-2" d__=""><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>;; global options: +cmd</span>
<span id="cb45-3" d__=""><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>;; Got answer:</span>
<span id="cb45-4" d__=""><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 13491</span>
<span id="cb45-5" d__=""><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7" d__=""><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>;; OPT PSEUDOSECTION:</span>
<span id="cb45-8" d__=""><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>; EDNS: version: 0, flags:; udp: 1232</span>
<span id="cb45-9" d__=""><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>;; QUESTION SECTION:</span>
<span id="cb45-10" d__=""><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>;example.com.            IN    AAAA</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-12" d__=""><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>;; ANSWER SECTION:</span>
<span id="cb45-13" d__=""><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>example.com.        81016    IN    AAAA    2606:2800:220:1:248:1893:25c8:1946</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-15" d__=""><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>;; Query time: 14 msec</span>
<span id="cb45-16" d__=""><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>;; SERVER: 1.1.1.1#53(1.1.1.1)</span>
<span id="cb45-17" d__=""><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>;; WHEN: Wed Sep 28 16:05:16 PDT 2022</span>
<span id="cb45-18" d__=""><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>;; MSG SIZE  rcvd: 68</span></code></pre></div>
<p d__="">You can see the IPv6 address of <code s__="13">example.com</code> in the <code s__="13">ANSWER SECTION</code>, above.</p>
<h2 data-number="8.5" id="ipv6-and-urls" d__=""><span class="header-section-number">8.5</span> IPv6 and URLs</h2>
<p d__="">Since a URL uses the <code s__="13">:</code> character to delimit a port number, that meaning collides with the <code s__="13">:</code> characters used in an IPv6 address.</p>
<p d__="">If you run your server on port 33490, you can connect to it in
 your web browser by putting the IPv6 address in square brackets. For 
example, to connect to localhost on address <code s__="13">::1</code>, you can:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb46-1" d__=""><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>http://[::1]:33490/</span></code></pre></div>
<h2 data-number="8.6" id="reflect-5" d__=""><span class="header-section-number">8.6</span> Reflect</h2>
<ul>
<li><p d__="">What are some benefits of IPv6 over IPv4?</p></li>
<li><p d__="">How can the address <code s__="13">2001:0db8:004a:0000:0000:00ab:ab4d:000a</code> be written more simply?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="9" id="project-a-better-web-server" d__=""><span class="header-section-number">9</span> Project: A Better Web Server</h1>
<p d__="">Time to improve the web server so that it serves actual files!</p>
<p d__="">We’re going to make it so that when a web client (in this case
 we’ll use a browser) requests a specific file, the webserver will 
return that file.</p>
<p d__="">There are some interesting details to be found along the way.</p>
<h2 data-number="9.1" id="restrictions-1" d__=""><span class="header-section-number">9.1</span> Restrictions</h2>
<p d__="">In order to better understand the sockets API at a lower level, this project may <strong>not</strong> use any of the following helper functions:</p>
<ul>
<li d__="">The <code s__="13">socket.create_connection()</code> function.</li>
<li d__="">The <code s__="13">socket.create_server()</code> function.</li>
<li d__="">Anything in the <code s__="13">urllib</code> modules.</li>
</ul>
<p d__="">After coding up the project, it should be more obvious how these helper functions are implemented.</p>
<h2 data-number="9.2" id="the-process" d__=""><span class="header-section-number">9.2</span> The Process</h2>
<p d__="">If you go to your browser and enter a URL like this (substituting the port number of your running server):</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb47-1" d__=""><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>http://localhost:33490/file1.txt</span></code></pre></div>
<p d__="">The client will send a request to your server that looks like this:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb48-1" d__=""><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>GET /file1.txt HTTP/1.1</span>
<span id="cb48-2" d__=""><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>Host: localhost</span>
<span id="cb48-3" d__=""><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>Connection: close</span></code></pre></div>
<p d__="">Notice the file name is right there in the <code s__="13">GET</code> request on the first line!</p>
<p d__="">Your server will:</p>
<ol type="1">
<li d__="">Parse that request header to get the file name.</li>
<li d__="">Strip the path off for security reasons.</li>
<li d__="">Read the data from the named file.</li>
<li d__="">Determine the type of data in the file, HTML or text.</li>
<li d__="">Build an HTTP response packet with the file data in the payload.</li>
<li d__="">Send that HTTP response back to the client.</li>
</ol>
<p d__="">The response will look like this example file:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb49-1" d__=""><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>HTTP/1.1 200 OK</span>
<span id="cb49-2" d__=""><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>Content-Type: text/html</span>
<span id="cb49-3" d__=""><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>Content-Length: 357</span>
<span id="cb49-4" d__=""><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>Connection: close</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6" d__=""><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>&lt;!DOCtype html&gt;</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8" d__=""><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>&lt;html&gt;</span>
<span id="cb49-9" d__=""><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>&lt;head&gt;</span>
<span id="cb49-10" d__=""><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>...</span></code></pre></div>
<p d__="">[The rest of the HTML file has been truncated in this example.]</p>
<p d__="">At this point, the browser should display the file.</p>
<p d__="">Notice a couple things in the header that need to be computed: the <code s__="13">Content-Type</code> will be set according to the type of data in the file being served, and the <code s__="13">Content-Length</code> will be set to the length in bytes of that data.</p>
<p d__="">We’re going to want to be able to display at least two different types of files: HTML and text files.</p>
<h2 data-number="9.3" id="parsing-the-request-header" d__=""><span class="header-section-number">9.3</span> Parsing the Request Header</h2>
<p d__="">You’ll want to read in the full request header, so your probably doing something like accumulating data from all your <code s__="13">recv()</code>s in a single variable and searching it (with something like string’s <code s__="13">.find()</code> method to find the <code s__="13">"\r\n\r\n"</code> that marks the end of the header.</p>
<p d__="">At that point, you can <code s__="13">.split()</code> the header data on <code s__="13">"\r\n"</code> to get individual lines.</p>
<p d__="">The first line is the <code s__="13">GET</code> line.</p>
<p d__="">You can <code s__="13">.split()</code> that single line into its three parts: the request method (<code s__="13">GET</code>), the path (e.g.&nbsp;<code s__="13">/file1.txt</code>), and the protocol (<code s__="13">HTTP/1.1</code>).</p>
<p d__="">Don’t forget to <code s__="13">.decode("ISO-8859-1")</code> the first line of the request so that you can use it as a string.</p>
<p d__="">We only really need the path.</p>
<h2 data-number="9.4" id="stripping-the-path-down-to-the-filename" d__=""><span class="header-section-number">9.4</span> Stripping the Path down to the Filename</h2>
<p d__=""><strong>SECURITY RISK!</strong> If we don’t strip the path 
off, a malicious attacker could use it to accesss arbitrary files on 
your system. Can you think of how they might build a URL that reads <code s__="13">/etc/password</code>?</p>
<p d__="">Real web servers just check to make sure the path is 
restricted to a certain directory hierarchy, but we’ll take the easy way
 and just strip all the path information off and only serve files from 
the directory the webserver is running in.</p>
<p d__="">The path is going to be made up of directory names separated by a slash (<code s__="13">/</code>), so the easiest thing to do at this point is to use <code s__="13">.split('/')</code> on your path and filename, and then look at the last element.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb50-1" d__=""><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>fullpath <span class="op" d__="">=</span> <span class="st" d__="">"/foo/bar/baz.txt"</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3" d__=""><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>file_name <span class="op" d__="">=</span> fullpath.split(<span class="st" d__="">"/"</span>)[<span class="op" d__="">-</span><span class="dv" d__="">1</span>]</span></code></pre></div>
<p d__="">A more portable way is to use the standard library function <code s__="13">os.path.split</code>. The value returned by <code s__="13">os.path.split</code> is will be a tuple with two elements, the second of which is the file name:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb51-1" d__=""><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>fullpath <span class="op" d__="">=</span> <span class="st" d__="">"/foo/bar/baz.txt"</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3" d__=""><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>os.path.split(fullpath)</span>
<span id="cb51-4" d__=""><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">=&gt;</span> (<span class="st" d__="">'/foo/bar'</span>, <span class="st" d__="">'baz.txt'</span>)</span></code></pre></div>
<p d__="">Select the last element:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb52-1" d__=""><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>fullpath <span class="op" d__="">=</span> <span class="st" d__="">"/foo/bar/baz.txt"</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3" d__=""><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>file_name <span class="op" d__="">=</span> os.path.split(fullpath)[<span class="op" d__="">-</span><span class="dv" d__="">1</span>]</span></code></pre></div>
<p d__="">Use that to get the file name you want to serve.</p>
<h2 data-number="9.5" id="mime-and-getting-the-content-type" d__=""><span class="header-section-number">9.5</span> MIME and Getting the <code>Content-Type</code></h2>
<p d__="">In HTTP, the payload can be anything–any collection of bytes. So how does the web browser know how to display it?</p>
<p d__="">The answer is in the <code s__="13">Content-Type</code> header, which gives the <a href="https://en.wikipedia.org/wiki/MIME" d__="">MIME</a> type of the data. This is enough for the client to know how to display it.</p>
<p d__="">Some example MIME types:</p>
<!-- CAPTION: MIME Types -->
<table>
<thead>
<tr>
<th d__="">MIME Type</th>
<th d__="">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code s__="13" d__="">text/plain</code></td>
<td d__="">Plain text file</td>
</tr>
<tr>
<td><code s__="13" d__="">text/html</code></td>
<td d__="">HTML file</td>
</tr>
<tr>
<td><code s__="13" d__="">application/pdf</code></td>
<td d__="">PDF file</td>
</tr>
<tr>
<td><code s__="13" d__="">image/jpeg</code></td>
<td d__="">JPEG image</td>
</tr>
<tr>
<td><code s__="13" d__="">image/gif</code></td>
<td d__="">GIF image</td>
</tr>
<tr>
<td><code s__="13" d__="">application/octet-stream</code></td>
<td d__="">Generic unclassified data</td>
</tr>
</tbody>
</table>
<p d__="">There are <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types" d__="">a lot of MIME types</a> to identify any kind of data.</p>
<p d__="">You put these right in the HTTP response in the <code s__="13">Content-Type</code> header:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb53-1" d__=""><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>Content-Type: application/pdf</span></code></pre></div>
<p d__="">But how do you know what type of data a file holds?</p>
<p d__="">The classic way to do this is by looking at the file extension, everything after the last period in the file name.</p>
<p d__="">Luckily, <a href="https://docs.python.org/3/library/os.path.html#os.path.splitext"><code s__="13" d__="">os.path.splitext()</code></a> gives us an easy way to pull the extension off a file name:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb54-1" d__=""><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>os.path.splitext(<span class="st" d__="">'keyboardcat.gif'</span>)</span></code></pre></div>
<p d__="">returns a tuple containing:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb55-1" d__=""><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>(<span class="st" d__="">'keyboardcat'</span>, <span class="st" d__="">'.gif'</span>)</span></code></pre></div>
<p d__="">You can just map the following extensions for this assignment:</p>
<!-- CAPTION: Extension Mapping -->
<table>
<thead>
<tr>
<th d__="">Extension</th>
<th d__="">MIME Type</th>
</tr>
</thead>
<tbody>
<tr>
<td><code s__="13" d__="">.txt</code></td>
<td><code s__="13" d__="">text/plain</code></td>
</tr>
<tr>
<td><code s__="13" d__="">.html</code></td>
<td><code s__="13" d__="">text/html</code></td>
</tr>
</tbody>
</table>
<p d__="">So if the file has a <code s__="13">.txt</code> extension, be sure to send back:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb56-1" d__=""><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>Content-Type: text/plain</span></code></pre></div>
<p d__="">in your response.</p>
<p d__="">If you really want to be correct, add <code s__="13">charset</code> to your header to specify the character encoding:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb57-1" d__=""><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>Content-Type: text/plain; charset=iso-8859-1</span></code></pre></div>
<p d__="">but that’s not necessary, since browsers typically default to that encoding.</p>
<h2 data-number="9.6" id="reading-the-file-content-length-and-handling-not-found" d__=""><span class="header-section-number">9.6</span> Reading the File, <code>Content-Length</code>, and Handling Not Found</h2>
<p d__="">Here’s some code to read an entire file and check for errors:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb58-1" d__=""><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">try</span>:</span>
<span id="cb58-2" d__=""><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf" d__="">with</span> <span class="bu" d__="">open</span>(filename, <span class="st" d__="">"rb"</span>) <span class="im" d__="">as</span> fp:</span>
<span id="cb58-3" d__=""><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>        data <span class="op" d__="">=</span> fp.read()   <span class="co" d__=""># Read entire file</span></span>
<span id="cb58-4" d__=""><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf" d__="">return</span> data</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6" d__=""><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">except</span>:</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># File not found or other error</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># </span><span class="al" d__="">TODO</span><span class="co" d__=""> send a 404</span></span></code></pre></div>
<p d__="">The data you get back from <code s__="13">.read()</code> is what will be the payload. Use <code s__="13">len()</code> to compute the number of bytes.</p>
<p d__="">The number of bytes will be send back in the <code s__="13">Content-Length</code> header, like so:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb59-1" d__=""><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>Content-Length: 357</span></code></pre></div>
<p d__="">(with the number of bytes of your file).</p>
<blockquote>
<p d__="">You might be wondering what the <code s__="13">"rb"</code> thing is in the <code s__="13">open()</code>
 call. This causes the file to open for reading in binary mode. In 
Python, a file open for reading in binary mode will return a bytestring 
representing the file that you can send straight out on the socket.</p>
</blockquote>
<p d__="">What about this <code s__="13">404 Not Found</code> thing? It’s common enough that you’ve probably seen it in normal web usage from time to time.</p>
<p d__="">This just means you’ve requested a file or other resource that doesn’t exist.</p>
<p d__="">In our case, we’ll detect some kind of file open error (with the <code s__="13">except</code> block, above) and return a <code s__="13">404</code> response.</p>
<p d__="">The <code s__="13">404</code> response is an HTTP response, except instead of</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb60-1" d__=""><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>HTTP/1.1 200 OK</span></code></pre></div>
<p d__="">our response will start with</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb61-1" d__=""><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>HTTP/1.1 404 Not Found</span></code></pre></div>
<p d__="">So when you try to open the file and it fails, you’re going to just return the following (verbatim) and close the connection:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb62-1" d__=""><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>HTTP/1.1 404 Not Found</span>
<span id="cb62-2" d__=""><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>Content-Type: text/plain</span>
<span id="cb62-3" d__=""><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>Content-Length: 13</span>
<span id="cb62-4" d__=""><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>Connection: close</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6" d__=""><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>404 not found</span></code></pre></div>
<p d__="">(Both the content length and the payload can just be hardcoded in this case, but of course have to be <code s__="13">.encode()</code>’d to bytes.)</p>
<h2 data-number="9.7" id="extensions-1" d__=""><span class="header-section-number">9.7</span> Extensions</h2>
<p d__="">These are here if you have time to give yourself the 
additional challenge for greater understanding of the material. Push 
yourself!</p>
<ul>
<li><p d__="">Add MIME support for other file types so you can serve JPEGs and other files.</p></li>
<li><p d__="">Add support for showing a directory listing. If the user 
doesn’t specify a file in the URL, show a directory listing where each 
file name is a link to that file.</p>
<p d__="">Hint: <a href="https://docs.python.org/3/library/os.html#os.listdir"><code s__="13" d__="">os.listdir</code></a> and <a href="https://docs.python.org/3/library/os.path.html#os.path.join"><code s__="13" d__="">os.path.join()</code></a></p></li>
<li><p d__="">Instead of just dropping the entire path, allow serving out of subdirectories from a root directory your specify on the server.</p>
<p d__=""><strong>SECURITY RISK!</strong> Make sure the user can’t break out of the root directory by using a bunch of <code s__="13">..</code>s in the path!</p>
<p d__="">Normally you’d have some kind of configuration variable that 
specified the server root directory as an absolute path. But if you’re 
in one of my classes, that would make my life miserable when I went to 
grade projects. So if that’s the case, please use a relative path for 
your server root directory and create a full path with the <a href="https://docs.python.org/3/library/os.path.html#os.path.abspath"><code s__="13" d__="">os.path.abspath()</code></a> function.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb63-1" d__=""><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>server_root <span class="op" d__="">=</span> os.path.abspath(<span class="st" d__="">'.'</span>)        <span class="co" d__=""># This...</span></span>
<span id="cb63-2" d__=""><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>server_root <span class="op" d__="">=</span> os.path.abspath(<span class="st" d__="">'./root'</span>)   <span class="co" d__=""># or something like this</span></span></code></pre></div>
<p d__="">This would set <code s__="13">server_root</code> to a full path to where you ran your server. For example, on my machine, I might get:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb64-1" d__=""><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>/home/beej/src/webserver                  # This...</span>
<span id="cb64-2" d__=""><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>/home/beej/src/webserver/root             # or something like this</span></code></pre></div>
<p d__="">Then when the user tries to <code s__="13">GET</code> some path, you can just append it to server root to get the path to the file.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb65-1" d__=""><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>file_path <span class="op" d__="">=</span> os.path.sep.join(server_root, get_path)</span></code></pre></div>
<p d__="">So if they tried to <code s__="13">GET /foo/bar/index.html</code>, then <code s__="13">file_path</code> would get set to:</p>
<pre><code s__="13" d__="">/home/beej/src/webserver/foo/bar/index.html</code></pre>
<p d__=""><strong>And now the security crux!</strong> You have to make sure that <code s__="13">file_path</code> is within the server root directory. See, a villain might try to:</p>
<pre class="http"><code s__="13" d__="">GET /../../../../../etc/passwd HTTP/1.1</code></pre>
<p d__="">And if they did that, we’d unknowingly serve out this file:</p>
<pre><code s__="13" d__="">/home/beej/src/webserver/../../../../../etc/passwd</code></pre>
<p d__="">which would get them to my password file in <code s__="13">/etc/passwd</code>. I don’t want that.</p>
<p d__="">So I need to make sure that wherever they end up is still within my <code s__="13">server_root</code> hierarchy. How? We can use <code s__="13">abspath()</code> again.</p>
<p d__="">If I run the crazy <code s__="13">..</code> path above through <code s__="13">abspath()</code>, it just returns <code s__="13">/etc/passwd</code> to me. It resolves all the <code s__="13">..</code>s and other things and returns the “real” path.</p>
<p d__="">But I know my server root in this example is <code s__="13">/home/beej/src/webserver</code>, so I can just verify that the absolute file path begins with that. And 404 if it doesn’t.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Convert to absolute path</span></span>
<span id="cb69-2" d__=""><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>file_path <span class="op" d__="">=</span> os.path.abspath(file_path)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># See if the user is trying to break out of the server root</span></span>
<span id="cb69-5" d__=""><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">if</span> <span class="kw" d__="">not</span> file_path.startswith(server_root):</span>
<span id="cb69-6" d__=""><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    send_404()</span></code></pre></div></li>
</ul>
<h2 data-number="9.8" id="example-files" d__=""><span class="header-section-number">9.8</span> Example Files</h2>
<p d__="">You can copy and paste these into files for testing purposes:</p>
<h3 data-number="9.8.1" id="file1.txt"><span class="header-section-number" d__="">9.8.1</span> <code d__="">file1.txt</code></h3>
<div class="sourceCode" id="cb70"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb70-1" d__=""><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>This is a sample text file that has all kinds of words in it that</span>
<span id="cb70-2" d__=""><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>seemingly go on for a long time but really don't say much at all.</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4" d__=""><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>And as that weren't enough, here is a second paragraph that continues</span>
<span id="cb70-5" d__=""><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>the tradition. And then goes for a further sentence, besides.</span></code></pre></div>
<h3 data-number="9.8.2" id="file2.html"><span class="header-section-number" d__="">9.8.2</span> <code d__="">file2.html</code></h3>
<div class="sourceCode" id="cb71"><pre class="sourceCode html"><code class="sourceCode html" s__="13"><span id="cb71-1" d__=""><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;!DOCTYPE</span> html<span class="dt" d__="">&gt;</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;</span><span class="kw" d__="">html</span><span class="dt" d__="">&gt;</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;</span><span class="kw" d__="">head</span><span class="dt" d__="">&gt;</span></span>
<span id="cb71-5" d__=""><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;</span><span class="kw" d__="">title</span><span class="dt" d__="">&gt;</span>Test HTML File<span class="dt" d__="">&lt;/</span><span class="kw" d__="">title</span><span class="dt" d__="">&gt;</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;/</span><span class="kw" d__="">head</span><span class="dt" d__="">&gt;</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;</span><span class="kw" d__="">body</span><span class="dt" d__="">&gt;</span></span>
<span id="cb71-9" d__=""><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;</span><span class="kw" d__="">h1</span><span class="dt" d__="">&gt;</span>Test HTML<span class="dt" d__="">&lt;/</span><span class="kw" d__="">h1</span><span class="dt" d__="">&gt;</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-11" d__=""><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;</span><span class="kw" d__="">p</span><span class="dt" d__="">&gt;</span>This is my test file that has <span class="dt" d__="">&lt;</span><span class="kw" d__="">i</span><span class="dt" d__="">&gt;</span>some<span class="dt" d__="">&lt;/</span><span class="kw" d__="">i</span><span class="dt" d__="">&gt;</span> HTML in in that the browser</span>
<span id="cb71-12" d__=""><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>should render as HTML.</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-14" d__=""><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;</span><span class="kw" d__="">p</span><span class="dt" d__="">&gt;</span>If you're seeing HTML tags that look like this <span class="dt" d__="">&lt;</span><span class="kw" d__="">tt</span><span class="dt" d__="">&gt;</span><span class="dv" d__="">&amp;lt;</span>p<span class="dv" d__="">&amp;gt;</span><span class="dt" d__="">&lt;/</span><span class="kw" d__="">tt</span><span class="dt" d__="">&gt;</span>,</span>
<span id="cb71-15" d__=""><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>you're sending it out as the wrong MIME type! It should be</span>
<span id="cb71-16" d__=""><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;</span><span class="kw" d__="">tt</span><span class="dt" d__="">&gt;</span>text/html<span class="dt" d__="">&lt;/</span><span class="kw" d__="">tt</span><span class="dt" d__="">&gt;</span>!</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;</span><span class="kw" d__="">hr</span><span class="dt" d__="">&gt;</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;/</span><span class="kw" d__="">body</span><span class="dt" d__="">&gt;</span></span></code></pre></div>
<p d__="">The idea is that these URLs would retrieve the above files (with the appropriate port given):</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb72-1" d__=""><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>http://localhost:33490/file1.txt</span>
<span id="cb72-2" d__=""><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>http://localhost:33490/file2.html</span></code></pre></div>
<!--
Rubric

100 points

10 File name parsed from request header.
20 File path is either stripped off or sandboxed properly.
10 Data is read from the file named in the URL
15 Proper Content-Type set in header
15 Proper Content-Length set in header
15 HTTP response header is constructed correctly and ISO-8859-1 encoded
15 HTTP response payload is constructed correctly
-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="10" id="endianness-and-integers" d__=""><span class="header-section-number">10</span> Endianness and Integers</h1>
<p d__="">We’ve done some work transmitting text over the network. But 
now we want to do something else: we want to transfer binary integer 
data.</p>
<p d__="">Sure we <em>could</em> just convert the numbers to strings, 
but this is more wasteful than it needs to be. Binary representation is 
more compact and saves bandwidth.</p>
<p d__="">But the network can only send and receive bytes! How can we convert arbitrary numbers to single bytes?</p>
<p d__="">That’s what this chapter is all about.</p>
<p d__="">We want to:</p>
<ul>
<li d__="">Convert integers to byte sequences</li>
<li d__="">Convert byte sequences back into integers</li>
</ul>
<p d__="">And in this chapter we’ll look at:</p>
<ul>
<li d__="">How numbers are represented by sequences of bytes</li>
<li d__="">What order those bytes go in</li>
<li d__="">How to convert a number to a sequence of bytes in Python</li>
<li d__="">How to convert a sequence of bytes to a number in Python</li>
</ul>
<p d__="">Key points to look out for:</p>
<ul>
<li d__="">Integers can be represented by sequences of bytes.</li>
<li d__="">We’ll convert integers to sequences of bytes before we transmit them over the network.</li>
<li d__="">We’ll convert sequences of bytes back into integers when we receive them over the network.</li>
<li d__=""><em>Big-Endian</em> and <em>Little-Endian</em> are two different ways of ordering those sequences of bytes.</li>
<li d__="">Python offers built-in functionality for converting integers to sequences of bytes and back again.</li>
</ul>
<h2 data-number="10.1" id="integer-representations" d__=""><span class="header-section-number">10.1</span> Integer Representations</h2>
<p d__="">In this section we’ll dive deep into how an integer can be represented by a sequence of individual bytes.</p>
<h3 data-number="10.1.1" id="decimal-byte-representation" d__=""><span class="header-section-number">10.1.1</span> Decimal Byte Representation</h3>
<p d__="">Let’s look at how integers are represented as sequences of 
bytes. These sequences of bytes are what we’ll send across the network 
to send integer values to other systems.</p>
<p d__="">A single byte (in this context well define a byte to be the usual 8 bits) can encode binary values from <code s__="13">00000000</code> to <code s__="13">11111111</code>. In decimal, these numbers go from 0 to 255.</p>
<p d__="">So what happens if you want to store number larger than 255? 
Like 256? In that case, you need to use a second byte to store the 
additional value.</p>
<p d__="">The more bytes you use to represent an integer, the larger the
 range of integers you can represent. One byte can store from 0 to 255. 
Two bytes can store from 0 to 65535.</p>
<p d__="">Thinking about it another way, 65536 is the number of combinations of 1s and 0s you can have in a 16-bit number.</p>
<blockquote>
<p d__="">This section is talking about <strong>non-negative integers</strong> only. Floating point numbers use a <a href="https://en.wikipedia.org/wiki/IEEE_754#Basic_and_interchange_formats" d__="">different encoding</a>. Negative integers use a similar technique to positive, but we’ll keep it simple for now and ignore them.</p>
</blockquote>
<p d__="">Let’s take a look what happens when we count up from 253 to 
259 in a 16-bit number. Since 259 is bigger than a single byte can hold,
 we’ll use two bytes (holding numbers from 0 to 255), with the 
corresponding decimal value represented on the right:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb73-1" d__=""><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>  0 253   represents 253</span>
<span id="cb73-2" d__=""><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  0 254   represents 254</span>
<span id="cb73-3" d__=""><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  0 255   represents 255</span>
<span id="cb73-4" d__=""><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>  1   0   represents 256</span>
<span id="cb73-5" d__=""><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>  1   1   represents 257</span>
<span id="cb73-6" d__=""><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>  1   2   represents 258</span>
<span id="cb73-7" d__=""><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>  1   3   represents 259</span></code></pre></div>
<p d__="">Notice that the byte on the right “rolled over” from <code s__="13">255</code> to <code s__="13">0</code>
 like an odometer. It’s almost like that byte is the “ones place” and 
the byte on the left is the “256s place”… like looking at a base-256 
numbering system, almost.</p>
<p d__="">We could compute the decimal value of the number by taking the
 first byte and multiplying it by 256, then adding on the value of the 
second byte:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb74-1" d__=""><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>1  * 256 +   3 = 259</span></code></pre></div>
<p d__="">Or in this example, where two bytes with values <code s__="13">17</code> and <code s__="13">178</code> represent the value <code s__="13">4530</code>:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb75-1" d__=""><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>17 * 256 + 178 = 4530</span></code></pre></div>
<p d__="">Neither <code s__="13">17</code> not <code s__="13">178</code> are larger than <code s__="13">255</code>, so they both fit in a single byte each.</p>
<p d__="">So every integer can be perfectly represented by a sequence of
 bytes. You just need more bytes in the sequence to represent larger 
numbers.</p>
<h3 data-number="10.1.2" id="binary-byte-representations" d__=""><span class="header-section-number">10.1.2</span> Binary Byte Representations</h3>
<p d__="">Binary, hexadecimal, and decimal are just all different “languages” for writing down values.</p>
<p d__="">So we could rewrite the entire previous section of the 
document by merely translating all the decimal numbers to binary, and it
 would still be just as true.</p>
<p d__="">In fact, let’s do it for the example from the previous 
section. Remember: this is numerically equivalent–we just changed the 
numbers from decimal to binary. All other concepts are identical.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb76-1" d__=""><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>00000000 11111101    represents  11111101 (253 decimal)</span>
<span id="cb76-2" d__=""><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>00000000 11111110    represents  11111110 (254 decimal)</span>
<span id="cb76-3" d__=""><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>00000000 11111111    represents  11111101 (255 decimal)</span>
<span id="cb76-4" d__=""><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>00000001 00000000    represents 100000000 (256 decimal)</span>
<span id="cb76-5" d__=""><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>00000001 00000001    represents 100000001 (257 decimal)</span>
<span id="cb76-6" d__=""><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>00000001 00000010    represents 100000010 (258 decimal)</span>
<span id="cb76-7" d__=""><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>00000001 00000011    represents 100000011 (259 decimal)</span></code></pre></div>
<p d__="">But wait a second–see the pattern? If you just stick the two 
bytes together you end up with the exact same number as the binary 
representation! (Ignoring leading zeros.)</p>
<p d__="">Really all we’ve done is take the binary representation of a 
number and split it up into chunks of 8 bits. We could take any 
arbitrary number like 1,256,616,290,962 decimal and convert it to 
binary:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb77-1" d__=""><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>10010010010010100001010101110101010010010</span></code></pre></div>
<p d__="">and do the same thing, split it up into chunks of 8 bits:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb78-1" d__=""><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>1 00100100 10010100 00101010 11101010 10010010</span></code></pre></div>
<p d__="">Since we’re packing it into bytes, we should pad that leading <code s__="13">1</code> out to 8 bits like so:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb79-1" d__=""><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>00000001 00100100 10010100 00101010 11101010 10010010</span></code></pre></div>
<p d__="">And there you have it, the byte-by-byte representation of the number 1,256,616,290,962.</p>
<h3 data-number="10.1.3" id="hexadecimal-byte-representations" d__=""><span class="header-section-number">10.1.3</span> Hexadecimal Byte Representations</h3>
<p d__="">Again, it doesn’t matter what number base we use–they’re just all different “languages” for representing a numeric value.</p>
<p d__="">Programmers like hex because it’s very compatible with bytes 
(each byte is 2 hex digits). Let’s do the same chart again, this time in
 hex:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb80-1" d__=""><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>00 fd    represents 00fd (253 decimal)</span>
<span id="cb80-2" d__=""><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>00 fe    represents 00fe (254 decimal)</span>
<span id="cb80-3" d__=""><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>00 ff    represents 00ff (255 decimal)</span>
<span id="cb80-4" d__=""><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>01 00    represents 0100 (256 decimal)</span>
<span id="cb80-5" d__=""><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>01 01    represents 0101 (257 decimal)</span>
<span id="cb80-6" d__=""><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>01 02    represents 0102 (258 decimal)</span>
<span id="cb80-7" d__=""><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>01 03    represents 0103 (259 decimal)</span></code></pre></div>
<p d__="">Look at that again! The hex representation of the number is 
the same as the two bytes just crammed together! Super-duper convenient.</p>
<h2 data-number="10.2" id="endianness" d__=""><span class="header-section-number">10.2</span> Endianness</h2>
<p d__="">Ready to get a wrench thrown in the works?</p>
<p d__="">I just finished telling you that a number like (in hex):</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb81-1" d__=""><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>45f2</span></code></pre></div>
<p d__="">can be represented by these two bytes:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb82-1" d__=""><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>45 f2</span></code></pre></div>
<p d__="">But guess what! Some systems will represent <code s__="13">0x45f2</code> as:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb83-1" d__=""><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>f2 45</span></code></pre></div>
<p d__="">It’s backwards! This is analogous to me saying “I want 123 pieces of toast” when in fact I really wanted 321!</p>
<p d__="">There’s a name for putting the bytes backward like this. We say such representations are <em>little endian</em>.</p>
<p d__="">This means the “little end” of the number (the “ones” byte, if I can call it that) comes at the front end.</p>
<p d__="">The more-normal, more-forward way to write it (like we did at first, where the number <code s__="13">0x45f2</code> was reasonably represented in the order <code s__="13">45 f2</code>) is called <em>big endian</em>. The byte in the largest value slot (also called the <em>most-significant byte</em>) is at the front end.</p>
<p d__="">The bad news is that virtually all Intel CPU models are little-endian.</p>
<p d__="">The good news is that Mac M1s are big-endian.</p>
<p d__="">The even better news is that <strong>all network numbers are transmitted as big-endian</strong>, the sensible way.</p>
<blockquote>
<p d__="">And when I say “all”, I mean “a certain amount”[^—Monty 
Python]. If both sides agree to transmit in little endian, there’s no 
law against that. This would make sense if the sender and receiver were 
both little-endian architectures—why waste time reversing bytes just to 
reverse them back? But the majority of protocols specify big-endian.</p>
</blockquote>
<p d__="">Big-endian byte order is called <em>network byte order</em> in network contexts for this reason.</p>
<h2 data-number="10.3" id="python-and-endianness" d__=""><span class="header-section-number">10.3</span> Python and Endianness</h2>
<p d__="">What if you have some number in Python, how do you convert it into a byte sequence?</p>
<p d__="">Luckily, there’s a built-in function to help with that: <code s__="13">.to_bytes()</code>.</p>
<p d__="">And there’s one to go the other way: <code s__="13">.from_bytes()</code></p>
<p d__="">It even allows you to specify the endianness! Since we’ll be using this to transmit bytes over the network, we’ll always use <code s__="13">"big"</code> endian.</p>
<h3 data-number="10.3.1" id="converting-a-number-to-bytes" d__=""><span class="header-section-number">10.3.1</span> Converting a Number to Bytes</h3>
<p d__="">Here’s a demo where we take the number 3490 and store it as bytestring of 2 bytes in big-endian order.</p>
<p d__="">Note that we pass two things into the <code s__="13">.to_bytes()</code> method: the number of bytes for the result, and <code s__="13">"big"</code> if it’s to be big-endian, or <code s__="13">"little"</code> if it’s to be little endian.</p>
<blockquote>
<p d__="">Newer versions of Python default to <code s__="13">"big"</code>. In older versions, you still have to be explicit.</p>
</blockquote>
<div class="sourceCode" id="cb84"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb84-1" d__=""><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>n = 3490</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3" d__=""><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>bytes = n.to_bytes(2, "big")</span></code></pre></div>
<p d__="">If we print them out we’ll see the byte values:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb85-1" d__=""><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>for b in bytes:</span>
<span id="cb85-2" d__=""><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    print(b)</span></code></pre></div>
<div class="sourceCode" id="cb86"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb86-1" d__=""><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>13</span>
<span id="cb86-2" d__=""><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>162</span></code></pre></div>
<p d__="">Those are the big-endian byte values that make up the number 3490. We can verify that <code s__="13">13 * 256 + 162 == 3490</code> easily enough.</p>
<p d__="">If you try to store the number 70,000 in two bytes, you’ll get an <code s__="13">OverflowError</code>. Two bytes isn’t large enough to store values over 65535–you’ll need to add another byte.</p>
<p d__="">Let’s do one more example in hex:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb87-1" d__=""><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>n <span class="op" d__="">=</span> <span class="bn" d__="">0xABCD</span></span>
<span id="cb87-2" d__=""><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="bu" d__="">bytes</span> <span class="op" d__="">=</span> n.to_bytes(<span class="dv" d__="">2</span>, <span class="st" d__="">"big"</span>)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-4" d__=""><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">for</span> b <span class="kw" d__="">in</span> <span class="bu" d__="">bytes</span>:</span>
<span id="cb87-5" d__=""><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu" d__="">print</span>(<span class="ss" d__="">f"</span><span class="sc" d__="">{</span>b<span class="sc" d__="">:02X}</span><span class="ss" d__="">"</span>)  <span class="co" d__=""># Print in hex</span></span></code></pre></div>
<p d__="">prints:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb88-1" d__=""><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>AB</span>
<span id="cb88-2" d__=""><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>CD</span></code></pre></div>
<p d__="">It’s the same digits as the original value stored in <code s__="13">n</code>!</p>
<h3 data-number="10.3.2" id="convert-bytes-back-to-a-number" d__=""><span class="header-section-number">10.3.2</span> Convert Bytes Back to a Number</h3>
<p d__="">Let’s take the full tour. We’re going to make a hex number and
 convert it to bytes, like we did in the previous section. Then we’ll 
even print out the bytestring to see what it looks like.</p>
<p d__="">Then we’ll convert that bytestring back to a number and print it out to make sure it matches the original.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb89-1" d__=""><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>n <span class="op" d__="">=</span> <span class="bn" d__="">0x0102</span></span>
<span id="cb89-2" d__=""><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="bu" d__="">bytes</span> <span class="op" d__="">=</span> n.to_bytes(<span class="dv" d__="">2</span>, <span class="st" d__="">"big"</span>)</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4" d__=""><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="bu" d__="">print</span>(<span class="bu" d__="">bytes</span>)</span></code></pre></div>
<p d__="">gives the output:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="st" d__="">b'</span><span class="ch" d__="">\x01\x02</span><span class="st" d__="">'</span></span></code></pre></div>
<p d__="">The <code s__="13">b</code> at the front means this is a bytestring (as opposed to a regular string) and the <code s__="13">\x</code> is an escape sequence that appears before a 2-digit hex number.</p>
<p d__="">Since our original number was <code s__="13">0x0102</code>, it makes sense that the two bytes in the byte string have values <code s__="13">\x01</code> and <code s__="13">\x02</code>.</p>
<p d__="">Now let’s convert that string back and print in hex:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb91-1" d__=""><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>v <span class="op" d__="">=</span> <span class="bu" d__="">int</span>.from_bytes(<span class="bu" d__="">bytes</span>, <span class="st" d__="">"big"</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3" d__=""><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="bu" d__="">print</span>(<span class="ss" d__="">f"</span><span class="sc" d__="">{</span>v<span class="sc" d__="">:04x}</span><span class="ss" d__="">"</span>)</span></code></pre></div>
<p d__="">And that prints:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb92-1" d__=""><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>0102</span></code></pre></div>
<p d__="">just like our original value!</p>
<h2 data-number="10.4" id="reflect-6" d__=""><span class="header-section-number">10.4</span> Reflect</h2>
<ul>
<li><p d__="">Using only the <code s__="13">.to_bytes()</code> and <code s__="13">.from_bytes()</code>
 methods, how can you swap the byte order in a 2-byte number? (That is 
reverse the bytes.) How can you do that without using any loops or other
 methods? (Hint: <code s__="13">"big"</code> and <code s__="13">"little"</code>!)</p></li>
<li><p d__="">Describe in your own words the difference between Big-Endian and Little-Endian.</p></li>
<li><p d__="">What is Network Byte Order?</p></li>
<li><p d__="">Why not just send an entire number at once instead of breaking it into bytes?</p></li>
<li><p d__="">Little-endian just seems backwards. Why does it even exist? Do a little Internet searching to answer this question.</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="11" id="parsing-packets" d__=""><span class="header-section-number">11</span> Parsing Packets</h1>
<p d__="">We’ve already seen some issues with receiving structured data from a server. You call <code s__="13">recv(4096)</code>, and you only get 20 bytes back. Or you call <code s__="13">recv(4096)</code> and it turns out the data is longer than that, and you need to call it again.</p>
<p d__="">There’s an even worse issue there, too. If the server is sending you multiple pieces of data, you might receive the first <em>and part of the next</em>. You’ll have a complete packet and the next partially complete one! How do you reconstruct this?</p>
<p d__="">An analogy might be if I needed you to split up individual 
sentences from a block of text I give you, but you can only get 20 
characters at a time.</p>
<p d__="">You call <code s__="13">recv(20)</code> and you get:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb93-1" d__=""><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>This is a test of th</span></code></pre></div>
<p d__="">That’s not a full sentence, so you can’t print it yet. So you call <code s__="13">recv(20)</code> again:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb94-1" d__=""><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>This is a test of the emergency broadcas</span></code></pre></div>
<p d__="">Still not a sentence. Call it again:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb95-1" d__=""><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>This is a test of the emergency broadcast system. This is on</span></code></pre></div>
<p d__="">Hey! There’s a period in there, so we have a complete 
sentence. So we can print it out. But we also have part of the next 
sentence already received!</p>
<p d__="">How are we going to handle all this in a graceful way?</p>
<h2 data-number="11.1" id="you-know-what-would-make-this-easy" d__=""><span class="header-section-number">11.1</span> You Know What Would Make This Easy?</h2>
<p d__="">You know what would make this easy? If we abstracted it out and then we could do something like this:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb96-1" d__=""><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">while</span> the connection isn<span class="st" d__="">'t closed:</span></span>
<span id="cb96-2" d__=""><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="er" d__="">    sentence = get_next_packet</span>()</span>
<span id="cb96-3" d__=""><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu" d__="">print</span>(sentence)</span></code></pre></div>
<p d__="">Isn’t that easier to think about? Once we have that code the 
extracts the next complete packet from the data stream, we can just use 
it.</p>
<p d__="">And if that code is complex enough, it could actually extract different types of packets from the stream:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb97-1" d__=""><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>packet <span class="op" d__="">=</span> get_next_packet()</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-3" d__=""><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">if</span> packet.<span class="bu" d__="">type</span> <span class="op" d__="">==</span> PLAYER_POSITION:</span>
<span id="cb97-4" d__=""><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    set_player_position(packet.player_index, packet.player_position)</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-6" d__=""><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">elif</span> packet.<span class="bu" d__="">type</span> <span class="op" d__="">==</span> PRIVATE_CHAT:</span>
<span id="cb97-7" d__=""><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>    display_chat(packet.player_from, packet.message, private<span class="op" d__="">=</span><span class="va" d__="">True</span>)</span></code></pre></div>
<p d__="">and so on.</p>
<p d__="">Makes things soooo much easier than trying to reason about packets as collections of bytes that might or might not be complete.</p>
<p d__="">Of course, doing that processing is the real trick. Let’s talk about how to make it happen.</p>
<h2 data-number="11.2" id="processing-a-stream-into-packets" d__=""><span class="header-section-number">11.2</span> Processing a Stream into Packets</h2>
<p d__="">The big secret to making this work is this: make a big global buffer.</p>
<blockquote>
<p d__="">A buffer is just another word for a storage area for a bunch 
of bytes. In Python, it would be a bytestring, which is convenient since
 you’re already getting those back from <code s__="13">recv()</code>.</p>
</blockquote>
<p d__="">This buffer will hold the bytes you’ve seen so far. You will inspect the buffer to see if it holds a complete data packet.</p>
<p d__="">If there is a complete packet in there, you’ll return it (as a
 bytestring or processed). And also, critically, you’ll strip it off the
 front of the buffer.</p>
<p d__="">Otherwise, you’ll call <code s__="13">recv()</code> again to try to fill up the buffer until you have a complete packet.</p>
<p d__="">In Python, remember to use the <code s__="13">global</code> keyword to access global variables, e.g.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb98-1" d__=""><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>packet_buffer <span class="op" d__="">=</span> <span class="st" d__="">b''</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-3" d__=""><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">def</span> get_next_packet(s):</span>
<span id="cb98-4" d__=""><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw" d__="">global</span> packet_buffer</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># Now we can use the global version in here</span></span></code></pre></div>
<p d__="">Otherwise Python will just make another local variable that shadows the global one.</p>
<h2 data-number="11.3" id="the-sentences-example-again" d__=""><span class="header-section-number">11.3</span> The Sentences Example Again</h2>
<p d__="">Let’s look at that sentences example from the beginning of this chapter.</p>
<p d__="">We’ll call our <code s__="13">get_sentence()</code> function, and it’ll look at all the data received so far and see if there’s a period in it.</p>
<p d__="">So far we have:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>  </span></code></pre></div>
<p d__="">Nothing. No data is received. There’s no period in there so we don’t have a sentence, so we have to call <code s__="13">recv(20)</code> again to get more bytes:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb100-1" d__=""><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>This is a test of th</span></code></pre></div>
<p d__="">Still no period. Call <code s__="13">recv(20)</code> again:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb101-1" d__=""><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>This is a test of the emergency broadcas</span></code></pre></div>
<p d__="">Still no period. Call <code s__="13">recv(20)</code> again:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb102-1" d__=""><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>This is a test of the emergency broadcast system. This is on</span></code></pre></div>
<p d__="">There’s one! So we do two things:</p>
<ol type="1">
<li><p d__="">Copy the sentence out so we can return it, and:</p></li>
<li><p d__="">Strip the sentence from the buffer.</p></li>
</ol>
<p d__="">After step two, the first sentence is gone and the buffer looks like this:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb103-1" d__=""><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>This is on</span></code></pre></div>
<p d__="">and we return the first sentence “This is a test of the emergency broadcast system.”</p>
<p d__="">And the function that called <code s__="13">get_sentence()</code> can print it.</p>
<p d__="">And then call <code s__="13">get_sentence()</code> again!</p>
<p d__="">In <code s__="13">get_sentence()</code>, we look at the buffer again. (Remember, the buffer is global so it still has the data in it from the last call.)</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb104-1" d__=""><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>This is on</span></code></pre></div>
<p d__="">There’s no period, so we call <code s__="13">recv(20)</code> again, but this time we only get 10 bytes back:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb105-1" d__=""><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>This is only a test.</span></code></pre></div>
<p d__="">But it’s a complete sentence, so we strip it from the buffer, leaving it empty, and then return it to the caller for printing.</p>
<h3 data-number="11.3.1" id="what-if-you-receive-multiple-sentences-at-once" d__=""><span class="header-section-number">11.3.1</span> What If You Receive Multiple Sentences at Once?</h3>
<p d__="">What if I call <code s__="13">recv(20)</code> and get this back:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb106-1" d__=""><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>Part 1. Part 2. Part</span></code></pre></div>
<p d__="">Well, it still works! The <code s__="13">get_sentence()</code> function will see the first period in there, strip off the first sentence from the buffer so it contains:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb107-1" d__=""><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>Part 2. Part</span></code></pre></div>
<p d__="">and then return <code s__="13">Part 1.</code>.</p>
<p d__="">The next time you call <code s__="13">get_sentence()</code>, as always, the first thing it does is check to see if the buffer contains a full sentence. It does! So we strip it off:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb108-1" d__=""><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>Part</span></code></pre></div>
<p d__="">and return <code s__="13">Part 2.</code></p>
<p d__="">The next time you call <code s__="13">get_sentence()</code>, it sees no period in the buffer, so there is no complete sentence, so it calls <code s__="13">recv(20)</code> again to get more data.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb109-1" d__=""><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>Part 3. Part 4. Part 5.</span></code></pre></div>
<p d__="">And now we have a complete sentence, so we strip it off the front:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb110-1" d__=""><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>Part 4. Part 5.</span></code></pre></div>
<p d__="">and return <code s__="13">Part 3</code> to the caller. And so on.</p>
<h2 data-number="11.4" id="the-grand-scheme" d__=""><span class="header-section-number">11.4</span> The Grand Scheme</h2>
<p d__="">Overall, you could think of this abstraction as a pipe full of
 data. When there is a complete packet in the pipe, it’s pulled off the 
front and returned.</p>
<p d__="">But if there’s not, the pipe receives more data at the back and keeps checking to see if it has an entire packet yet.</p>
<p d__="">Here’s some pseudocode:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">global</span> <span class="bu" d__="">buffer</span> <span class="op" d__="">=</span> <span class="st" d__="">b''</span>    <span class="co" d__=""># Empty bytestring</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3" d__=""><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>function get_packet():</span>
<span id="cb111-4" d__=""><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf" d__="">while</span> <span class="va" d__="">True</span>:</span>
<span id="cb111-5" d__=""><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf" d__="">if</span> <span class="bu" d__="">buffer</span> starts <span class="cf" d__="">with</span> a complete packet</span>
<span id="cb111-6" d__=""><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>            extract the packet data</span>
<span id="cb111-7" d__=""><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>            strip the packet data off the front of the <span class="bu" d__="">buffer</span></span>
<span id="cb111-8" d__=""><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf" d__="">return</span> the packet data</span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-10" d__=""><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>        receive more data</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-12" d__=""><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf" d__="">if</span> amount of data received <span class="kw" d__="">is</span> zero <span class="bu" d__="">bytes</span></span>
<span id="cb111-13" d__=""><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf" d__="">return</span> connection closed indicator</span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-15" d__=""><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>        append received data onto the <span class="bu" d__="">buffer</span></span></code></pre></div>
<p d__="">In Python, you can slice off the buffer to get rid of the packet data from the front.</p>
<p d__="">For example, if you know the packet data is 12 bytes, you can slice it off with:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb112-1" d__=""><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>packet <span class="op" d__="">=</span> <span class="bu" d__="">buffer</span>[:<span class="dv" d__="">12</span>]   <span class="co" d__=""># Grab the packet</span></span>
<span id="cb112-2" d__=""><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="bu" d__="">buffer</span> <span class="op" d__="">=</span> <span class="bu" d__="">buffer</span>[<span class="dv" d__="">12</span>:]   <span class="co" d__=""># Slice it off the front</span></span></code></pre></div>
<h2 data-number="11.5" id="reflect-7" d__=""><span class="header-section-number">11.5</span> Reflect</h2>
<ul>
<li d__="">Describe the advantages from a programming perspective to abstracting packets out of a stream of data.</li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="12" id="project-atomic-time" d__=""><span class="header-section-number">12</span> Project: Atomic Time</h1>
<p d__="">You’re going to reach out to the atomic clock at NIST 
(National Institute of Standards and Technology) and get the number of 
seconds since January 1, 1900 from their clocks. (That’s a lot of 
seconds.)</p>
<p d__="">And you’ll print it out.</p>
<p d__="">And then you’re going to print out the system time from the clock on your computer.</p>
<p d__="">If your computer’s clock is accurate, the numbers should be very close in the output:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb113-1" d__=""><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>NIST time  : 3874089043</span>
<span id="cb113-2" d__=""><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>System time: 3874089043</span></code></pre></div>
<p d__="">We’re just writing a client in this case. The server already exists and is already running.</p>
<h2 data-number="12.1" id="note-on-legality" d__=""><span class="header-section-number">12.1</span> Note On Legality</h2>
<p d__="">The NIST runs this server for public use. Generally speaking, 
you don’t want to be connecting to servers where the owner doesn’t want 
you to. It’s a quick way to run afoul of the law.</p>
<p d__="">But in this case, the general public is welcome to use it.</p>
<h2 data-number="12.2" id="note-on-allowable-use" d__=""><span class="header-section-number">12.2</span> Note On Allowable Use</h2>
<p d__=""><strong>The NIST server should never be queried more than once every four seconds</strong>. They might start refusing service if you exceed this rate.</p>
<p d__="">If you’re running the code frequently and want to be sure you’ve waited 4 seconds, you can buffer the run with a <code s__="13">sleep</code> call on the command line:</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb114-1" d__=""><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">sleep</span> 4<span class="kw" d__="">;</span> <span class="ex">python3</span> timeclient.py</span></code></pre></div>
<h2 data-number="12.3" id="epoch" d__=""><span class="header-section-number">12.3</span> Epoch</h2>
<p d__="">In computer parlance, we refer to “epoch” as meaning “the beginning of time” from a computer perspective.</p>
<p d__="">Lots of libraries measure time in “number of seconds since epoch”, meaning since the dawn of time.</p>
<p d__="">What do we mean by the dawn of time? Well, it’s depends.</p>
<p d__="">But in Unix-land, the dawn of time is very specifically January 1, 1970 at 00:00 UTC (AKA Greenwich Mean Time).</p>
<p d__="">In other epochs, the dawn of time might be another date. For 
example, the Time Protocol that we’ll be speaking uses January 1, 1900 
00:00 UTC, 70 years before Unix’s.</p>
<p d__="">This means we’ll have to do some conversion. But luckily for 
you, we’ll just give you the code that will return the value for you and
 you don’t have to worry about it.</p>
<h2 data-number="12.4" id="a-dire-warning-about-zeros" d__=""><span class="header-section-number">12.4</span> A Dire Warning about Zeros</h2>
<p d__="">For reasons I don’t understand, sometimes the NIST server will
 return 4 bytes of all zeros. And other times it will just send zero 
bytes and close the connection.</p>
<p d__="">If this happens, you’ll probably see <code s__="13">0</code> show up as the NIST time.</p>
<p d__="">Just try running your client again to see if you get good 
results after one or two more tries, keeping in mind the restriction of 
one query every 4 seconds.</p>
<p d__="">They’re on a rotating IP for <code s__="13">time.nist.gov</code> and it seems like one or two of the servers might not be working right.</p>
<p d__="">If it keeps coming up zero, something else might be wrong.</p>
<h2 data-number="12.5" id="the-gameplan" d__=""><span class="header-section-number">12.5</span> The Gameplan</h2>
<p d__="">The is what we’ll be doing:</p>
<ol type="1">
<li><p d__="">Connect to the server <code s__="13">time.nist.gov</code> on port <code s__="13">37</code> (the Time Protocol port).</p></li>
<li><p d__="">Receive data. (You don’t need to send anything.) You should get 4 bytes.</p></li>
<li><p d__="">The 4 bytes represent a 4-byte big-endian number. Decode the 4 bytes with <code s__="13">.from_bytes()</code> into a numeric variable.</p></li>
<li><p d__="">Print out the value from the time server, which should be the number of seconds since January 1, 1900 00:00.</p></li>
<li><p d__="">Print the system time as number of seconds since January 1, 1900 00:00.</p></li>
</ol>
<p d__="">The two times should loosely (or exactly) agree if your computer’s clock is accurate.</p>
<p d__="">The number should be a bit over 3,870,000,000, to give you a ballpark idea. And it should increment once per second.</p>
<h3 data-number="12.5.1" id="connect-to-the-server" d__=""><span class="header-section-number">12.5.1</span> 1. Connect to the Server</h3>
<p d__="">The Time Protocol in general works with both UDP and TCP. For 
this project you must use TCP sockets, just like we have been for other 
projects.</p>
<p d__="">So make a socket and connect to <code s__="13">time.nist.gov</code> on port <code s__="13">37</code>, the Time Protocol port.</p>
<h3 data-number="12.5.2" id="receive-the-data" d__=""><span class="header-section-number">12.5.2</span> 2. Receive the Data</h3>
<p d__="">Technically you should use a loop to do this, but it’s very 
unlikely that such a small amount of data will be split into multiple 
packets.</p>
<p d__="">You’ll receive 4 bytes max, no matter how many you ask for.</p>
<p d__="">You can close the socket right after the data is received.</p>
<h3 data-number="12.5.3" id="decode-the-data" d__=""><span class="header-section-number">12.5.3</span> 3. Decode the Data</h3>
<p d__="">The data is an integer encoded as 4 bytes, big-endian.</p>
<p d__="">Use the <code s__="13">.from_bytes()</code> method mentioned in the earlier chapters to convert the bytestream from <code s__="13">recv()</code> to a value.</p>
<h3 data-number="12.5.4" id="print-out-nists-time" d__=""><span class="header-section-number">12.5.4</span> 4. Print Out NIST’s Time</h3>
<p d__="">It should be in this format:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb115-1" d__=""><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>NIST time  : 3874089043</span></code></pre></div>
<h3 data-number="12.5.5" id="print-out-the-system-time" d__=""><span class="header-section-number">12.5.5</span> 5. Print Out the System Time</h3>
<p d__="">Here’s some Python code that get the number of seconds since January 1 1900 00:00 from your system clock.</p>
<p d__="">You can paste this right into your code and call it to get the system time.</p>
<p d__="">Print the system time right after the NIST time in the following format:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb116-1" d__=""><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>System time: 3874089043</span></code></pre></div>
<p d__="">Here’s the code:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb117-1" d__=""><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">import</span> time</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3" d__=""><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">def</span> system_seconds_since_1900():</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__="">"""</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">    The time server returns the number of seconds since 1900, but Unix</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">    systems return the number of seconds since 1970. This function</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">    computes the number of seconds since 1900 on the system.</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">    """</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># Number of seconds between 1900-01-01 and 1970-01-01</span></span>
<span id="cb117-11" d__=""><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>    seconds_delta <span class="op" d__="">=</span> <span class="dv" d__="">2208988800</span></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-13" d__=""><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a>    seconds_since_unix_epoch <span class="op" d__="">=</span> <span class="bu" d__="">int</span>(time.time())</span>
<span id="cb117-14" d__=""><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>    seconds_since_1900_epoch <span class="op" d__="">=</span> seconds_since_unix_epoch <span class="op" d__="">+</span> seconds_delta</span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-16" d__=""><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf" d__="">return</span> seconds_since_1900_epoch</span></code></pre></div>
<p d__="">Assuming NIST’s number isn’t zero:</p>
<ul>
<li><p d__="">If this number is within 10 seconds of NIST’s number, that’s great.</p></li>
<li><p d__="">If it’s within 86,400 seconds, that’s OK. And I’d like to hear about it because it might be a bug in the above code.</p></li>
<li><p d__="">If it’s within a million seconds, I really want to hear about it.</p></li>
<li><p d__="">If it’s outside of that, it’s probably a bug in your code. Did you use <code s__="13">"big"</code> endian? Are you receiving 4 bytes?</p></li>
</ul>
<!-- Rubric

55 points

-5 Program uses TCP sockets
-10 Program connects successfully to time.nist.gov port 37
-10 Program receives data from the server
-5 Program close()s the socket after receiving data
-10 Program properly decodes data from server
-5 Program properly prints out results
-10 Results are within 86,400 seconds of each other

 -->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="13" id="project-the-word-server" d__=""><span class="header-section-number">13</span> Project: The Word Server</h1>
<p d__="">This is a project that is all about reading packets.</p>
<p d__="">You’ll receive a stream of encoded data from a server 
(provided) and you’ll have to write code to determine when you’ve 
received a complete packet and the print out that data.</p>
<h2 data-number="13.1" id="overview" d__=""><span class="header-section-number">13.1</span> Overview</h2>
<p d__=""><strong>First:</strong> download these files:</p>
<ul>
<li><p d__=""><a href="https://beej.us/guide/bgnet0/source/exercises/word/wordserver.py"><strong><code s__="13" d__="">wordserver.py</code></strong></a><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup s__="13" d__="">4</sup></a>: a ready-to-run server that hands out lists of random words.</p></li>
<li><p d__=""><a href="https://beej.us/guide/bgnet0/source/exercises/word/wordclient.py"><strong><code s__="13" d__="">wordclient.py</code></strong></a><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup s__="13" d__="">5</sup></a>: skeleton code for the client.</p></li>
</ul>
<p d__=""><strong>RESTRICTION! Do not modify any of the existing code!</strong> Just search for <code s__="13">TODO</code> and fill in that code. You may add additional functions and variables if you wish.</p>
<p d__=""><strong>REQUIREMENT! The code should work with any positive value passed to <code s__="13">recv()</code> between <code s__="13">1</code> and <code s__="13">4096</code>!</strong> You might want to test values like <code s__="13">1</code>, <code s__="13">5</code>, and <code s__="13">4096</code> to make sure they all work.</p>
<p d__=""><strong>REQUIREMENT! The code must work with words from length 1 to length 65535.</strong>
 The server won’t send very long words, but you can modify it to test. 
To build a string in Python of a specific number of characters, you can:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb118-1" d__=""><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>long_str <span class="op" d__="">=</span> <span class="st" d__="">"a"</span> <span class="op" d__="">*</span> <span class="dv" d__="">256</span>   <span class="co" d__=""># Make a string of 256 "a"s</span></span></code></pre></div>
<p d__=""><strong>PROTIP! Read and understand all the existing client code before you start.</strong>
 This will save you all kinds of trouble. And note how the structure of 
the main code doesn’t even care about bytes and streams–it’s only 
concerned with entire packets. Cleaner, right?</p>
<p d__="">You are going to complete two functions:</p>
<ul>
<li><p d__=""><strong><code s__="13">get_next_word_packet()</code></strong>: gets the next complete word packet from the stream. This should return the <em>complete packet</em>, the header and the data.</p></li>
<li><p d__=""><strong><code s__="13">extract_word()</code></strong>: extract and return the word from a complete word packet.</p></li>
</ul>
<p d__="">What do they do? Keep reading!</p>
<h2 data-number="13.2" id="what-is-a-word-packet" d__=""><span class="header-section-number">13.2</span> What is a “Word Packet”?</h2>
<p d__="">When you connect to the server, it will send you a stream of data.</p>
<p d__="">This stream is made up of a random number (1 to 10 inclusive) of words prefixed by the length of the word in bytes.</p>
<p d__="">Each word is UTF-8 encoded.</p>
<p d__="">The length of the word is encoded as a big-endian 2-byte number.</p>
<p d__="">For example, the word “hello” with length 5 would be encoded as the following bytes (in hex):</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb119-1" d__=""><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>length 5</span>
<span id="cb119-2" d__=""><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>  |</span>
<span id="cb119-3" d__=""><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>+-+-+</span>
<span id="cb119-4" d__=""><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>|   | h  e  l  l  o</span>
<span id="cb119-5" d__=""><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>00 05 68 65 6C 6C 6F</span></code></pre></div>
<p d__="">The numbers corresponding to the letters are the UTF-8 encoding of those letters.</p>
<blockquote>
<p d__="">Fun fact: for alphabetic letters and numbers, UTF-8, ASCII, and ISO-8859-1 are all the same encoding.</p>
</blockquote>
<p d__="">The word “hi” followed by “encyclopedia” would be encoded as two word packets, transmitted in the stream like so:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb120-1" d__=""><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>length 2   length 12</span>
<span id="cb120-2" d__=""><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  |           |</span>
<span id="cb120-3" d__=""><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>+-+-+       +-+-+</span>
<span id="cb120-4" d__=""><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>|   | h  i  |   | e  n  c  y  c  l  o  p  e  d  i  a</span>
<span id="cb120-5" d__=""><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>00 02 68 69 00 0C 65 6E 63 79 63 6C 6F 70 65 64 69 61</span></code></pre></div>
<h2 data-number="13.3" id="implementation-get_next_word_packet" d__=""><span class="header-section-number">13.3</span> Implementation: <code>get_next_word_packet()</code></h2>
<p d__="">This function takes the connected socket as argument. It will 
return the next word packet (the length plus the word, as received) as a
 bytestring.</p>
<p d__="">It will follow the process outlined in the <a href="#parsing-packets" d__="">Parsing Packets chapter</a> for extracting packets from a stream of data.</p>
<p d__="">For example, if the words were “hi” and “encyclopedia” from 
the example above, and we received the first 5 bytes, the packet buffer 
would contain:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb121-1" d__=""><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>      h  i  </span>
<span id="cb121-2" d__=""><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>00 02 68 69 00</span></code></pre></div>
<p d__="">We see the first word is 2 bytes long, and we have captured those 2 bytes.</p>
<p d__="">We would extract and return the first word (“hi”) and its length (bytes <code s__="13">00</code> <code s__="13">02</code>) and return this bytestring:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb122-1" d__=""><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>      h  i</span>
<span id="cb122-2" d__=""><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>00 02 68 69</span></code></pre></div>
<p d__="">We’d also strip those bytes out of the packet buffer so that all that remained was the zero that was at the end.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb123-1" d__=""><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>00</span></code></pre></div>
<p d__="">At that point, lacking a complete word in the buffer, a subsequent call to the function would trigger a <code s__="13">recv(5)</code> for the next chunk of data, giving us:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb124-1" d__=""><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>      e  n  c  y</span>
<span id="cb124-2" d__=""><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>00 0C 65 6E 63 79</span></code></pre></div>
<p d__="">And so on.</p>
<h2 data-number="13.4" id="implementation-extract_word" d__=""><span class="header-section-number">13.4</span> Implementation: <code>extract_word()</code></h2>
<p d__="">This function takes a complete word packet as input, such as:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb125-1" d__=""><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>      h  i</span>
<span id="cb125-2" d__=""><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>00 02 68 69</span></code></pre></div>
<p d__="">and returns a string of the word, <code s__="13">"hi"</code>.</p>
<p d__="">This involves slicing off everything past the two length bytes to get the word bytes.</p>
<p d__="">But remember: the word is UTF-8 encoded! So you have to call <code s__="13">.decode()</code> to turn it back into a string. (The default decoding is UTF-8, so you don’t have to pass an argument to <code s__="13">.decode()</code>.)</p>
<!-- Rubric

55 points

-10 Code that was required to be unmodified was not modified
-5 Recv only called with 5 as the argument
-15 Function get_next_word_packet() returns only the next single complete packet as a bytestring
-5 Function get_next_word_packet() properly removes the complete single packet from the front of the global buffer
-5 Function get_next_word_packet() returns None when the connection was closed by the server
-5 Function extract_word() extracts the word from the packet
-10 Function extract_word() returns the word as a decoded UTF-8 string

 -->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="14" id="transmission-control-protocol-tcp" d__=""><span class="header-section-number">14</span> Transmission Control Protocol (TCP)</h1>
<p d__="">When someone puts a backhoe through a fiber optic cable, 
packets might be lost. (Entire countries have been brought offline by 
having a boat anchor dragged through an undersea network cable!) 
Software errors and computer crashes and router malfunctions can all 
cause problems.</p>
<p d__="">But we don’t want to have to think about that. We want an 
entity to deal with all that and then let us know when the data is 
complete and intact and in order.</p>
<p d__="">TCP is that entity. It worries about lost packets so we don’t have to. And when it is sure it has all the correct data, <em>then</em> it gives it to us.</p>
<p d__="">We’ll look at:</p>
<ul>
<li d__="">The overall goals of TCP</li>
<li d__="">Where it fits in the network stack</li>
<li d__="">A refresher on TCP ports</li>
<li d__="">How TCP makes, uses, and closes connections</li>
<li d__="">Data integrity mechanisms
<ul>
<li>Maintaining packet order</li>
<li>Detecting errors</li>
</ul></li>
<li d__="">Flow control–how a receiver keeps from getting overwhelmed</li>
<li d__="">Congestion Control–how senders avoid overloading the Internet</li>
</ul>
<p d__="">TCP is a very complex topic and we’re only skimming the highlights here. If you want to learn more, the go-to book is <em>TCP/IP Illustrated Volume 1</em> by the late, great W. Richard Stevens.</p>
<h2 data-number="14.1" id="goals-of-tcp" d__=""><span class="header-section-number">14.1</span> Goals of TCP</h2>
<ul>
<li d__="">Provide reliable communication</li>
<li d__="">Simulate a circuit-like connection on a packet-switched network</li>
<li d__="">Provide flow control</li>
<li d__="">Provide congestion control</li>
<li d__="">Support out-of-band data</li>
</ul>
<h2 data-number="14.2" id="location-in-the-network-stack" d__=""><span class="header-section-number">14.2</span> Location in the Network Stack</h2>
<p d__="">Recall the layers of the Network Stack:</p>
<!-- CAPTION: Internet Layered Network Model -->
<table>
<colgroup>
<col style="width: 60%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr>
<th style="text-align: center;" d__="">Layer</th>
<th d__="">Responsibility</th>
<th d__="">Example Protocols</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;" d__="">Application</td>
<td d__="">Structured application data</td>
<td d__="">HTTP, FTP, TFTP, Telnet, SSH, SMTP, POP, IMAP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Transport</td>
<td d__="">Data Integrity, packet splitting and reassembly</td>
<td d__="">TCP, UDP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Internet</td>
<td d__="">Routing</td>
<td d__="">IP, IPv6, ICMP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Link</td>
<td d__="">Physical, signals on wires</td>
<td d__="">Ethernet, PPP, token ring</td>
</tr>
</tbody>
</table>
<p d__="">You can see TCP in there at the Transport Layer. IP below it 
is responsible for routing. And the application layer above it takes 
advantage of all the features TCP has to offer.</p>
<p d__="">That’s why when we wrote our HTTP client and server, we didn’t
 have to worry about data integrity at all. We used TCP so that took 
care of it for us!</p>
<h2 data-number="14.3" id="tcp-ports" d__=""><span class="header-section-number">14.3</span> TCP Ports</h2>
<p d__="">Recall that when we used TCP we had to specify port numbers to
 connect to. And even our clients were automatically assigned local 
ports by the operating system (if we didn’t <code s__="13">bind()</code> them ourselves).</p>
<p d__="">IP uses IP addresses to identify hosts.</p>
<p d__="">But once on that host, the port number is what the OS uses to deliver the data to the correct process.</p>
<p d__="">By analogy, the IP address is like a street address, and the port number is like an apartment number at that street address.</p>
<h2 data-number="14.4" id="tcp-overview" d__=""><span class="header-section-number">14.4</span> TCP Overview</h2>
<p d__="">There are three main things TCP does during a connection:</p>
<ol type="1">
<li d__="">Make the connection</li>
<li d__="">Transmit data</li>
<li d__="">Close the connection</li>
</ol>
<p d__="">Each of these involves the sending of special non-user-data 
packets back and forth between the client and server. We’ll look at 
special packet types SYN, SYN-ACK, ACK, and FIN.</p>
<h3 data-number="14.4.1" id="making-the-connection" d__=""><span class="header-section-number">14.4.1</span> Making the Connection</h3>
<p d__="">This involves the famous “three-way handshake”. Since any 
packets can be lost during transmission, TCP takes extra care to make 
sure both sides of the connection are ready for data before proceeding.</p>
<ol type="1">
<li d__="">The client sends a SYN (synchronize) packet to the server.</li>
<li d__="">The server replies with a SYN-ACK (synchronize acknowledge) packet back to the client.</li>
<li d__="">The client replies with an ACK (acknowledge) packet back to the server.</li>
</ol>
<p d__="">If there is no reply in a reasonable time to any one of these steps, the packet is resent.</p>
<h3 data-number="14.4.2" id="transmitting-data" d__=""><span class="header-section-number">14.4.2</span> Transmitting Data</h3>
<p d__="">TCP takes a stream of data and splits it into chunks. Each 
chunk gets a TCP header attached to it, and is then sent on to the IP 
layer for delivery. The header and the chunk together are called a TCP <em>segment</em>.</p>
<p d__="">(We’ll use “TCP packet” and “TCP segment” interchangeably, but segment is more correct.)</p>
<p d__="">When TCP sends a segment, it expects the recipient of that 
data to respond with an acknowledgment, hereafter known as an ACK. If 
TCP doesn’t get the ACK, it’s going to assume something has gone wrong 
and it needs to resend that segment.</p>
<p d__="">Segments are numbered so even if they arrive out of order, TCP can put them back in the proper sequence.</p>
<h3 data-number="14.4.3" id="closing-the-connection" d__=""><span class="header-section-number">14.4.3</span> Closing the Connection</h3>
<p d__="">When a side wants to close the connection, it sends a FIN (finis [<em>sic</em>])
 packet. The remote side will typically reply with an ACK and a FIN of 
its own. The local side would then complete the hangup with another ACK.</p>
<p d__="">In some OSes, if a host closes a connection with unread data, 
it sends back a RST (reset) to indicate that condition. Socket programs 
might print the message “Connection reset by peer” when this happens.</p>
<h2 data-number="14.5" id="data-integrity" d__=""><span class="header-section-number">14.5</span> Data Integrity</h2>
<p d__="">There are a lot of things that can go wrong. Data can arrive 
out of order. It can be corrupted. It might be duplicated. Or maybe it 
doesn’t arrive at all.</p>
<p d__="">TCP has mechanisms to handle all these contingencies.</p>
<h3 data-number="14.5.1" id="packet-ordering" d__=""><span class="header-section-number">14.5.1</span> Packet Ordering</h3>
<p d__="">The sender places an ever-increasing sequence number on each segment. “Here’s segment 3490. Here’s segment 3491.”</p>
<p d__="">The receiver replies to the sender with an ACK packet containing that sequence number. “I got segment 3490. I got segment 3491.”</p>
<p d__="">If two segments arrive out of order, TCP can put them back in order by sorting them by sequence number.</p>
<blockquote>
<p d__="">Analogy time! If you had a stack of papers and threw them in 
the air, how could you possibly know their original order? Well, if you 
numbered all the pages correctly, you just have to sort them. That’s the
 role the sequence number plays in TCP.</p>
</blockquote>
<p d__="">If a duplicate segment arrives, TCP knows it’s already seen that sequence number, so it can safely discard the duplicate.</p>
<p d__="">If a segment is missing, TCP can ask for a retransmission. It 
does this by repeatedly ACKing the previous segment. The sender will 
retransmit the next one.</p>
<p d__="">Alternately, if the sender doesn’t get an ACK for a particular
 segment for some time, it might retransmit that segment on its own, 
thinking the segment might have been lost. This retransmission gets more
 and more pessimistic with each timeout; the server doubles the timeout 
each time it happens.</p>
<p d__="">Lastly, sequence numbers are initialized to random values during the three-way handshake as the connection is being made.</p>
<h3 data-number="14.5.2" id="error-detection" d__=""><span class="header-section-number">14.5.2</span> Error Detection</h3>
<p d__="">Before the sender sends out a segment, a <em>checksum</em> is computed for that segment.</p>
<p d__="">When the receiver gets the segment, it computes its own checksum of that segment.</p>
<p d__="">If the two checksums match, the data is assumed to be 
error-free. If they differ, the data is discarded and the sender must 
timeout and retransmit.</p>
<p d__="">The checksum is a 16-bit number that is the result of piping 
all the TCP header and payload data and the IP addresses involved into a
 function that digests them down.</p>
<p d__="">The details are in this week’s project.</p>
<h2 data-number="14.6" id="flow-control" d__=""><span class="header-section-number">14.6</span> Flow Control</h2>
<p d__=""><em>Flow Control</em> is the mechanism by which two 
communicating devices alert one another that data needs to be sent more 
slowly. You can’t pour 1000 Mbs (megabits per second) at a device that 
can only handle 100 Mbs. The device needs a way to alert the sender that
 to slow it down.</p>
<blockquote>
<p d__="">Analogy time: you do this on the phone when you tell the other party “You’re talking too fast for me to understand! Slow down!”</p>
</blockquote>
<p d__="">The most simple way to do this (and this is not what TCP does)
 is for the sender to send the data, then wait for the receiver to send 
back an ACK packet with that sequence number. Then send another data 
packet. This way the receiver can delay the ACK if it needs the sender 
to slow down.</p>
<p d__="">But this is a slow back and forth, and the network is usually 
reliable enough for the sender to push out multiple segments without 
waiting for a response.</p>
<p d__="">However, if we do this, we risk the sender sending data more quickly than the receiver can handle it!</p>
<p d__="">In TCP, this is solved with something called a <em>sliding window</em>. This goes in the “window” field of the TCP header in the receiver’s ACK packet.</p>
<p d__="">In that field, the data receiver can specify how much more 
data (in bytes) it is willing to receive. The sender must not send more 
than this without before getting an ACK from the receiver. And the ACK 
it gets will contain new window information.</p>
<p d__="">Using the mechanism, the receiver can get the sender “once 
you’ve sent X bytes, you have to wait for an ACK telling you how many 
more you can send”.</p>
<p d__="">It’s important to note that this is a byte count, not a 
segment count. The sender is free to send multiple segments without 
receiving an ACK as long as the total bytes doesn’t exceed the 
receiver’s advertised window size.</p>
<h2 data-number="14.7" id="congestion-control" d__=""><span class="header-section-number">14.7</span> Congestion Control</h2>
<p d__="">Flow control operates between two computers, but there’s a 
greater issue of the Internet as a whole. If a router becomes 
overwhelmed, it might start dropping packets which causes the sender to 
begin retransmitting, which does nothing to alleviate the problem. And 
it’s not even on flow control’s radar since the packets aren’t reaching 
the receiver.</p>
<p d__="">This happened in 1986 when <a href="https://en.wikipedia.org/wiki/National_Science_Foundation_Network" d__="">NSFNET</a>
 (basically the pre-commercial Internet, may it rest in peace) was 
overwhelmed by insistent senders who didn’t know when to quit with the 
retransmissions. Throughput dropped to 0.1% of normal. It wasn’t great.</p>
<p d__="">To fix this, a number of mechanisms were implemented by TCP to
 estimate and eliminate network congestion. Note that these are in 
addition to the Flow Control window advertised by a receiver. The sender
 must obey the Flow Control limit <strong>and</strong> the computed 
network congestion limit, whichever is lower. It cannot have more 
unacknowledged segments out on the network than this limit. If it does, 
it has to stop sending and wait for some ACKs to come in.</p>
<p d__="">Another way to think about this is that when a sender puts out
 a new TCP segment, that adds to network congestion. When it receives an
 ACK, that indicates that the segment has been removed from the network,
 decreasing congestion.</p>
<p d__="">In order to alleviate the problems that hit NFSNET, two big algorithms were added: Slow Start and Congestion Avoidance.</p>
<p d__=""><strong>NOTE:</strong> This is a simplified view of these two 
algorithms. For full details on the complex interplay between them and 
even more on congestion avoidance, see <a href="https://www.rfc-editor.org/rfc/rfc5681.html" d__=""><em>TCP Congestion Control</em> (RFC 5681)</a>.</p>
<h3 data-number="14.7.1" id="slow-start" d__=""><span class="header-section-number">14.7.1</span> Slow Start</h3>
<p d__="">When the connection first comes up, the sender has no way of 
knowing how congested the network is. This first phase is all about 
getting a rough guess sorted out.</p>
<p d__="">And so it’s going to start conservatively, assuming there’s a 
high congestion level. (If there is already a high congestion level, 
liberally flooding it with data wouldn’t be helpful.)</p>
<p d__="">It starts by allowing itself an initial <em>congestion window</em> which is how many unACKed bytes (and segments, but let’s just think of bytes for now) it is allowed to have outstanding.</p>
<p d__="">As the ACKs come in, the size of the congestion window 
increases by the number of acknowledged bytes. So, loosely, after one 
segment gets ACKed, two can be sent out. If those two are successfully 
ACKed, four can be sent out.</p>
<p d__="">So it starts with a very limited number of unACKed segments allowed to be outstanding, but grows very rapidly.</p>
<p d__="">Eventually one of those ACKs is lost and that’s when Slow 
Start decides to slow way down. It cuts the congestion window size by 
half and then TCP switches to the Congestion Avoidance algorithm.</p>
<h3 data-number="14.7.2" id="congestion-avoidance" d__=""><span class="header-section-number">14.7.2</span> Congestion Avoidance</h3>
<p d__="">This algorithm is similar to Slow Start, but it makes much more controlled moves. No more of this exponential growth stuff.</p>
<p d__="">Each time a congestion window’s-worth of data is successfully 
transmitted, it pushes a little harder by adding another segment’s worth
 of bytes to the window. This allows it to have another unACKed segment 
out on the network. If that works fine, it allows itself one more. And 
so on.</p>
<p d__="">So it’s pushing the limits of what can be successfully sent 
without congesting the network, but it’s pushing slowly. We call this <em>additive-increase</em> and it’s generally linear (compared to Slow Start which was generally exponential).</p>
<p d__="">Eventually, though, it pushes too far, and has to retransmit a
 packet. At this point, the congestion window is set to a small size and
 the algorithm drops back to Slow Start.</p>
<h2 data-number="14.8" id="reflect-8" d__=""><span class="header-section-number">14.8</span> Reflect</h2>
<ul>
<li><p d__="">Name a few protocols that rely on TCP for data integrity.</p></li>
<li><p d__="">Why is there a three-way handshake to set up a connection? Why not just start transmitting?</p></li>
<li><p d__="">How does a checksum protect against data corruption?</p></li>
<li><p d__="">What’s the main difference in the goals of Flow Control and Congestion Control?</p></li>
<li><p d__="">Reflect on the reasons for switching between Slow Start 
and Congestion Avoidance. What advantages does each have in different 
phases of congestion detection?</p></li>
<li><p d__="">What is the purpose of Flow Control?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="15" id="user-datagram-protocol-udp" d__=""><span class="header-section-number">15</span> User Datagram Protocol (UDP)</h1>
<p d__="">If you like to keep things simple and are a positive thinker, 
UDP is for you. It’s the near-ultimate in lightweight data transfer over
 the Internet.</p>
<p d__="">You fire UDP packets off and hope they arrive. Maybe they do, 
or maybe someone put a backhoe through a fiber optic cable, or there 
were cosmic rays, or a router got too congested or irate and just 
dropped it. Unceremoniously.</p>
<p d__="">It’s living on the Internet data edge! Virtually all the pleasant and reliable guarantees of TCP–gone!</p>
<h2 data-number="15.1" id="goals-of-udp" d__=""><span class="header-section-number">15.1</span> Goals of UDP</h2>
<ul>
<li d__="">Provide a way to send error-free data from one computer to another.</li>
</ul>
<p d__="">That’s about it.</p>
<p d__="">The following are <strong>not</strong> goals of UDP:</p>
<ul>
<li d__="">Provide data in order</li>
<li d__="">Provide data without loss</li>
<li d__="">Provide data without duplicates</li>
</ul>
<p d__="">If those are needed, TCP is a better choice. UDP offers zero 
protection against lost or misordered data. The only guarantee is that <em>if</em> the data arrives, it will be correct.</p>
<p d__="">But what it does give you is really low overhead and quick 
response times. It doesn’t have any of the packet reassembly or flow 
control or ACK packets or any of the stuff TCP does. As a consequence, 
the header is much smaller.</p>
<h2 data-number="15.2" id="location-in-the-network-stack-1" d__=""><span class="header-section-number">15.2</span> Location in the Network Stack</h2>
<p d__="">Recall the layers of the Network Stack:</p>
<!-- CAPTION: Internet Layered Network Model -->
<table>
<colgroup>
<col style="width: 60%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr>
<th style="text-align: center;" d__="">Layer</th>
<th d__="">Responsibility</th>
<th d__="">Example Protocols</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;" d__="">Application</td>
<td d__="">Structured application data</td>
<td d__="">HTTP, FTP, TFTP, Telnet, SSH, SMTP, POP, IMAP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Transport</td>
<td d__="">Data Integrity, packet splitting and reassembly</td>
<td d__="">TCP, UDP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Internet</td>
<td d__="">Routing</td>
<td d__="">IP, IPv6, ICMP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Link</td>
<td d__="">Physical, signals on wires</td>
<td d__="">Ethernet, PPP, token ring</td>
</tr>
</tbody>
</table>
<p d__="">You can see UDP in there at the Transport Layer. IP below it 
is responsible for routing. And the application layer above it takes 
advantage of all the features UDP has to offer. Which isn’t a lot.</p>
<h2 data-number="15.3" id="udp-ports" d__=""><span class="header-section-number">15.3</span> UDP Ports</h2>
<p d__="">UDP uses ports, similar to TCP. In fact, you can have a TCP program using the same port number as a different UDP program.</p>
<p d__="">IP uses IP addresses to identify hosts.</p>
<p d__="">But once on that host, the port number is what the OS uses to deliver the data to the correct process.</p>
<p d__="">By analogy, the IP address is like a street address, and the port number is like an apartment number at that street address.</p>
<h2 data-number="15.4" id="udp-overview" d__=""><span class="header-section-number">15.4</span> UDP Overview</h2>
<p d__="">UDP is <em>connectionless</em>. You know how TCP takes the 
packet-switched network and makes it look like it’s a reliable 
connection between two computers? UDP doesn’t do that.</p>
<p d__="">You send a UDP datagram to an IP address and port. IP routes 
it there and the receiving computer sends it to the program that’s bound
 to that port.</p>
<p d__="">There’s no connection. It’s all on an individual packet basis.</p>
<p d__="">When the packet arrives, the receiver can tell which IP and port it came from. This way the receiver can send a response.</p>
<h2 data-number="15.5" id="data-integrity-1" d__=""><span class="header-section-number">15.5</span> Data Integrity</h2>
<p d__="">There are a lot of things that can go wrong. Data can arrive 
out of order. It can be corrupted. It might be duplicated. Or maybe it 
doesn’t arrive at all.</p>
<p d__="">UDP barely has any mechanisms to handle all these contingencies.</p>
<p d__="">In fact, all it does is error detection.</p>
<h3 data-number="15.5.1" id="error-detection-1" d__=""><span class="header-section-number">15.5.1</span> Error Detection</h3>
<p d__="">Before the sender sends out a segment, a <em>checksum</em> is computed for that packet.</p>
<p d__="">The checksum works exactly the same way as with TCP, except 
the UDP header is used. Compared to the TCP header, the UDP header is 
dead simple:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb126-1" d__=""><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a> 0      7 8     15 16    23 24    31  </span>
<span id="cb126-2" d__=""><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>+--------+--------+--------+--------+ </span>
<span id="cb126-3" d__=""><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>|     Source      |   Destination   | </span>
<span id="cb126-4" d__=""><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>|      Port       |      Port       | </span>
<span id="cb126-5" d__=""><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>+--------+--------+--------+--------+ </span>
<span id="cb126-6" d__=""><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>|                 |                 | </span>
<span id="cb126-7" d__=""><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>|     Length      |    Checksum     | </span>
<span id="cb126-8" d__=""><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>+--------+--------+--------+--------+ </span>
<span id="cb126-9" d__=""><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>|                                     </span>
<span id="cb126-10" d__=""><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>|          data octets ...            </span>
<span id="cb126-11" d__=""><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>+---------------- ...                 </span></code></pre></div>
<p d__="">When the receiver gets the packet, it computes its own checksum of that packet.</p>
<p d__="">If the two checksums match, the data is assumed to be error-free. If they differ, the data is discarded.</p>
<p d__="">That’s it. The receiver never even knows that there was some data aimed at it. It just vanishes into the ether.</p>
<p d__="">The checksum is a 16-bit number that is the result of piping 
all the UDP header and payload data and the IP addresses involved into a
 function that digests them down.</p>
<p d__="">This works the same way as the TCP checksum. (Jon Postel wrote
 the first RFCs for both TCP and UDP so it’s no surprise they use the 
same algorithm.)</p>
<p d__="">The details of how the checksum works are in this week’s project. Just substitute the UDP header for the TCP header.</p>
<h2 data-number="15.6" id="maximum-payload-without-fragmentation" d__=""><span class="header-section-number">15.6</span> Maximum Payload Without Fragmentation</h2>
<p d__="">It’s a little ahead of schedule, but lower layers can decide 
to split a UDP packet up into smaller packets. Maybe there’s a part of 
the internet the UDP packet has to pass through that can only handle 
sending data of a certain size.</p>
<p d__="">We call this “fragmentation”, when a UDP packet is split among multiple IP packets.</p>
<p d__="">The maximum size packet that can be sent on any particular 
wire is called its MTU (maximum transmission unit). The smallest 
possible MTU on the Internet (IPv4) is 576 bytes. The biggest IP header 
is 60 bytes. And the UDP header is 8 bytes. So that leaves 576-60-8 = 
508 bytes of payload that you can guarantee won’t be fragmented[^If 
you’re sending through a VPN, it might be less than this, but we’ll 
ignore that for sake of simplicity.]. Since the IP header is sometimes 
smaller than 60 bytes, lots of source say 512 bytes is the limit.</p>
<p d__="">Is fragmentation bad? Some routers might drop fragmented UDP 
packets. So staying under the minimum MTU is often a good idea with UDP.</p>
<h2 data-number="15.7" id="whats-the-use" d__=""><span class="header-section-number">15.7</span> What’s the Use?</h2>
<p d__="">If UDP can drop packets all over the place, why ever use it?</p>
<p d__="">Well, the performance gain is notable, so that’s a draw.</p>
<p d__="">There are a number of circumstances you would use UDP:</p>
<ol type="1">
<li><p d__="">If you don’t care if you lose a few packets. If you’re 
transmitting voice or video or even game frame information, it might be 
OK to drop a few packets. The stream will just glitch out for a moment 
and then continue when the next packets arrive.</p>
<p d__="">This is the most common use. Multiplayer high-framerate games 
use this from frame-by-frame updates, and also use TCP for lower 
bandwidth needs like chat messages and player inventory changes.</p></li>
<li><p d__="">If you can’t have packet loss, you can implement another 
protocol on top of UDP. The TFTP (Trivial File Transfer Protocol) does 
this. It puts a sequence number in each packet, and waits for the other 
side to respond with a TFTP ACK packet before sending another. It’s not 
fast because the sender has to wait for an ACK before sending the next 
packet, but it’s really simple to implement.</p>
<p d__="">This is a rarer use. TFTP is used by diskless computers that 
don’t have an OS installed. They transfer the OS over the network on 
boot, and need a small built-in network stack to make that happen. It’s a
 lot easier to implement an Ethernet/IP/UDP stack than an 
Ethernet/IP/TCP stack.</p></li>
<li><p d__="">You want to multiplex different data “streams” without 
having multiple TCP connections. You could tag each UDP packet with an 
identifier so that they all go in the right buckets upon arrival.</p></li>
<li><p d__="">Early processing is possible. Maybe you can start processing packet 4 even if packet 3 hasn’t arrived yet.</p></li>
<li><p d__="">Etc.</p></li>
</ol>
<h2 data-number="15.8" id="udp-datagram-sockets" d__=""><span class="header-section-number">15.8</span> UDP (Datagram) Sockets</h2>
<p d__="">With UDP sockets, there are some differences from TCP:</p>
<ul>
<li d__="">You no longer call <code s__="13">listen()</code>, <code s__="13">connect()</code>, <code s__="13">accept()</code>, <code s__="13">send()</code>, or <code s__="13">recv()</code> because there’s no “connection”.</li>
<li d__="">You call <code s__="13">sendto()</code> to send UDP data.</li>
<li d__="">You call <code s__="13">recvfrom()</code> to receive UDP data.</li>
</ul>
<h3 data-number="15.8.1" id="server-procedure" d__=""><span class="header-section-number">15.8.1</span> Server Procedure</h3>
<p d__="">The general procedure for a server is to make a new socket of type <code s__="13">SOCK_DGRAM</code>, which is a datagram/UDP socket. (We have been using the default of <code s__="13">SOCK_STREAM</code> which is a TCP socket.)</p>
<p d__="">Then the server calls <code s__="13">bind()</code> to bind to a port. This port is where the client will send packets.</p>
<p d__="">After that, the server can loop receiving data and sending responses.</p>
<p d__="">When it receives data, <code s__="13">recvfrom()</code> will return the host and port the data was sent from. This can be used to reply, sending data back to the sender.</p>
<p d__="">Here’s an example server:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># UDP Server</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-3" d__=""><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">import</span> sys</span>
<span id="cb127-4" d__=""><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">import</span> socket</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Parse command line</span></span>
<span id="cb127-7" d__=""><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">try</span>:</span>
<span id="cb127-8" d__=""><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>    port <span class="op" d__="">=</span> <span class="bu" d__="">int</span>(sys.argv[<span class="dv" d__="">1</span>])</span>
<span id="cb127-9" d__=""><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">except</span>:</span>
<span id="cb127-10" d__=""><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu" d__="">print</span>(<span class="st" d__="">"usage: udpserver.py port"</span>, <span class="bu" d__="">file</span><span class="op" d__="">=</span>sys.stderr)</span>
<span id="cb127-11" d__=""><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>    sys.exit(<span class="dv" d__="">1</span>)</span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Make new UDP (datagram) socket</span></span>
<span id="cb127-14" d__=""><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a>s <span class="op" d__="">=</span> socket.socket(<span class="bu" d__="">type</span><span class="op" d__="">=</span>socket.SOCK_DGRAM)</span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Bind to a port</span></span>
<span id="cb127-17" d__=""><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a>s.bind((<span class="st" d__="">""</span>, port))</span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Loop receiving data</span></span>
<span id="cb127-20" d__=""><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">while</span> <span class="va" d__="">True</span>:</span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># Get data</span></span>
<span id="cb127-22" d__=""><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a>    data, sender <span class="op" d__="">=</span> s.recvfrom(<span class="dv" d__="">4096</span>)</span>
<span id="cb127-23" d__=""><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu" d__="">print</span>(<span class="ss" d__="">f"Got data from </span><span class="sc" d__="">{</span>sender[<span class="dv" d__="">0</span>]<span class="sc" d__="">}</span><span class="ss" d__="">:</span><span class="sc" d__="">{</span>sender[<span class="dv" d__="">1</span>]<span class="sc" d__="">}</span><span class="ss" d__="">: </span><span class="ch" d__="">\"</span><span class="sc" d__="">{</span>data<span class="sc" d__="">.</span>decode()<span class="sc" d__="">}</span><span class="ch" d__="">\"</span><span class="ss" d__="">"</span>)</span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># Send a reply back to the original sender</span></span>
<span id="cb127-26" d__=""><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a>    s.sendto(<span class="ss" d__="">f"Got your </span><span class="sc" d__="">{</span><span class="bu" d__="">len</span>(data)<span class="sc" d__="">}</span><span class="ss" d__=""> byte(s) of data!"</span>.encode(), sender)</span></code></pre></div>
<h3 data-number="15.8.2" id="client-procedure" d__=""><span class="header-section-number">15.8.2</span> Client Procedure</h3>
<p d__="">It’s about the same as the server procedure, except it’s not going to <code s__="13">bind()</code> to a specific port. It’ll let the OS choose bind port for it the first time it calls <code s__="13">sendto()</code>.</p>
<p d__="">Remember: UDP is unreliable, so there’s a chance the data 
might not arrive! If it doesn’t, just try again. (But it will almost 
certainly arrive running on localhost.)</p>
<p d__="">Example client that can communicate with the above server:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># UDP Client</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-3" d__=""><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">import</span> socket</span>
<span id="cb128-4" d__=""><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">import</span> sys</span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Parse command line</span></span>
<span id="cb128-7" d__=""><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">try</span>:</span>
<span id="cb128-8" d__=""><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a>    server <span class="op" d__="">=</span> sys.argv[<span class="dv" d__="">1</span>]</span>
<span id="cb128-9" d__=""><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    port <span class="op" d__="">=</span> <span class="bu" d__="">int</span>(sys.argv[<span class="dv" d__="">2</span>])</span>
<span id="cb128-10" d__=""><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>    message <span class="op" d__="">=</span> sys.argv[<span class="dv" d__="">3</span>]</span>
<span id="cb128-11" d__=""><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">except</span>:</span>
<span id="cb128-12" d__=""><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu" d__="">print</span>(<span class="st" d__="">"usage: udpclient.py server port message"</span>, <span class="bu" d__="">file</span><span class="op" d__="">=</span>sys.stderr)</span>
<span id="cb128-13" d__=""><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>    sys.exit(<span class="dv" d__="">1</span>)</span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Make new UDP (datagram) socket</span></span>
<span id="cb128-16" d__=""><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>s <span class="op" d__="">=</span> socket.socket(<span class="bu" d__="">type</span><span class="op" d__="">=</span>socket.SOCK_DGRAM)</span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Send data to the server</span></span>
<span id="cb128-19" d__=""><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a><span class="bu" d__="">print</span>(<span class="st" d__="">"Sending message..."</span>)</span>
<span id="cb128-20" d__=""><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>s.sendto(message.encode(), (server, port))</span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Wait for a reply</span></span>
<span id="cb128-23" d__=""><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>data, sender <span class="op" d__="">=</span> s.recvfrom(<span class="dv" d__="">4096</span>)</span>
<span id="cb128-24" d__=""><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a><span class="bu" d__="">print</span>(<span class="ss" d__="">f"Got reply: </span><span class="ch" d__="">\"</span><span class="sc" d__="">{</span>data<span class="sc" d__="">.</span>decode()<span class="sc" d__="">}</span><span class="ch" d__="">\"</span><span class="ss" d__="">"</span>)</span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-26" d__=""><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>s.close()</span></code></pre></div>
<h2 data-number="15.9" id="reflect-9" d__=""><span class="header-section-number">15.9</span> Reflect</h2>
<ul>
<li><p d__="">What does TCP provide that UDP does not in terms of delivery guarantees?</p></li>
<li><p d__="">Why do people recommend keeping UDP packets small?</p></li>
<li><p d__="">Why is the UDP header so much smaller than the TCP header?</p></li>
<li><p d__=""><code s__="13">sendto()</code> requires you specify a destination IP and port. Why does the TCP-oriented <code s__="13">send()</code> function not require those arguments?</p></li>
<li><p d__="">Why would people use UDP over TCP if it’s relatively unreliable?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="16" id="project-validating-a-tcp-packet" d__=""><span class="header-section-number">16</span> Project: Validating a TCP Packet</h1>
<p d__="">In this project you’ll write some code that validates a TCP packet, making sure it hasn’t been corrupted in transit.</p>
<p d__=""><strong>Inputs</strong>: A sequence of pairs of files:</p>
<ul>
<li><p d__="">One contains the source and destination IPv4 addresses in dots-and-numbers notation.</p></li>
<li><p d__="">The other contains the raw TCP packet, both the TCP header and the payload.</p></li>
</ul>
<p d__="">You can <a href="https://beej.us/guide/bgnet0/source/exercises/tcpcksum/tcp_data.zip" d__="">download the input files from the exercises folder</a><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup s__="13" d__="">6</sup></a>.</p>
<p d__=""><strong>Outputs</strong>:</p>
<ul>
<li d__="">For each pair of files, print <code s__="13">PASS</code> if the TCP checksum is correct. Otherwise print <code s__="13">FAIL</code>.</li>
</ul>
<p d__="">There are a lot of parts to this project, so it is suggested you write and test as you go.</p>
<p><strong d__="">You should understand this specification 100% before 
you begin to plan your approach! Get clarification before proceeding to 
the planning stage!</strong></p>
<p><strong d__="">The ABSOLUTE HARDEST PART of this project is understanding it! Your code will never work before you understand it!</strong></p>
<p d__=""><strong>The model solution is 37 lines of code!</strong> (Not 
including whitespace and comments.) This is not a number to beat, but is
 an indication of how much effort you need to put in to understanding 
this spec versus typing in code!</p>
<h2 data-number="16.1" id="banned-functions" d__=""><span class="header-section-number">16.1</span> Banned Functions</h2>
<p d__="">You may not use anything in the <code s__="13">socket</code> library.</p>
<h2 data-number="16.2" id="how-to-code-this" d__=""><span class="header-section-number">16.2</span> How To Code This</h2>
<p d__="">You can do this however you like, but I recommend this order. 
Details for each of these steps is included in the following sections.</p>
<ol type="1">
<li d__="">Read in the <code s__="13">tcp_addrs_0.txt</code> file.</li>
<li d__="">Split the line in two, the source and destination addresses.</li>
<li d__="">Write a function that converts the dots-and-numbers IP addresses into bytestrings.</li>
<li d__="">Read in the <code s__="13">tcp_data_0.dat</code> file.</li>
<li d__="">Write a function that generates the IP pseudo header bytes from the IP addresses from <code s__="13">tcp_addrs_0.txt</code> and the TCP length from the <code s__="13">tcp_data_0.dat</code> file.</li>
<li d__="">Build a new version of the TCP data that has the checksum set to zero.</li>
<li d__="">Concatenate the pseudo header and the TCP data with zero checksum.</li>
<li d__="">Compute the checksum of that concatenation</li>
<li d__="">Extract the checksum from the original data in <code s__="13">tcp_data_0.dat</code>.</li>
<li d__="">Compare the two checksums. If they’re identical, it works!</li>
<li d__="">Modify your code to run it on all 10 of the data files. <strong>The first 5 files should have matching checksums! The second five files should not!</strong> That is, the second five files are simulating being corrupted in transit.</li>
</ol>
<h2 data-number="16.3" id="checksum-in-general" d__=""><span class="header-section-number">16.3</span> Checksum in General</h2>
<p d__="">The checksum in TCP is a 16-bit value that represents a “sum 
total” of all the bytes in the packet. (Plus a bit more. And it’s not 
just the total of the bytes–don’t just add them up!!! More below.)</p>
<p d__="">The TCP header itself contains the checksum from the sending host.</p>
<p d__="">The receiving host (which is what you’re pretending to be, 
here) computes its own checksum from the incoming data, and makes sure 
it matches the value in the packet.</p>
<p d__="">If it does, the packet is good. If it doesn’t, it means 
something got corrupted. Either the source or destination IP addresses 
are wrong, or the TCP header is corrupted, or the data is wrong. Or the 
checksum itself got corrupted.</p>
<p d__="">In any case, the TCP software in the OS will request a resend if the checksums don’t match.</p>
<p d__="">Your job in this project is to re-compute the checksum of the 
given data, and make sure it matches (or doesn’t) the checksum already 
in the given data.</p>
<h2 data-number="16.4" id="input-file-details" d__=""><span class="header-section-number">16.4</span> Input File Details</h2>
<p d__=""><strong>Download <a href="https://beej.us/guide/bgnet0/source/exercises/tcpcksum/tcp_data.zip" d__="">this ZIP</a><a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup s__="13" d__="">7</sup></a> with the input files</strong>.</p>
<p d__="">There are 10 sets of them. The first 5 have valid checksums. The second 5 are corrupted.</p>
<p d__="">In case you didn’t notice, the previous line tells you what you have to do to get 100% on this project!</p>
<p d__="">The files are named like so:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb129-1" d__=""><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>tcp_addrs_0.txt</span>
<span id="cb129-2" d__=""><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>tcp_addrs_0.dat</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-4" d__=""><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>tcp addrs_1.txt</span>
<span id="cb129-5" d__=""><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>tcp addrs_1.dat</span></code></pre></div>
<p d__="">and so on, up to the index number 9. Each pair of files is related.</p>
<h3 data-number="16.4.1" id="the-.txt-file" d__=""><span class="header-section-number">16.4.1</span> The <code>.txt</code> File</h3>
<p d__="">You can look at the <code s__="13">tcp_addrs_n.txt</code> files in an editor and you’ll see it contains a pair of random IP addresses, similar to the following:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb130-1" d__=""><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>192.0.2.207 192.0.2.244</span></code></pre></div>
<p d__="">These are the <em>source IP address</em> and <em>destination IP address</em> for this TCP packet.</p>
<p d__="">Why do we need to know IP information if this is a TCP checksum? Stay tuned!</p>
<h3 data-number="16.4.2" id="the-.dat-file" d__=""><span class="header-section-number">16.4.2</span> The <code>.dat</code> File</h3>
<p d__="">This is a binary file containing the raw TCP header followed 
by payload data. It’ll look like garbage in an editor. If you have a 
hexdump program, you can view the bytes with that. For example, here’s 
the output from <code s__="13">hexdump</code>:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb131-1" d__=""><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">hexdump</span> <span class="at" d__="">-C</span> tcp_data_0.dat</span></code></pre></div>
<div class="sourceCode" id="cb132"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb132-1" d__=""><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>00000000  3f d7 c9 c5 ed d8 23 52  6a 15 32 96 50 d9 78 d8  |?.....#Rj.2.P.x.|</span>
<span id="cb132-2" d__=""><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>00000010  67 be ba aa 2a 63 25 2d  7c 4f 2a 39 52 69 4b 75  |g...*c%-|O*9RiKu|</span>
<span id="cb132-3" d__=""><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>00000020  42 39 53                                          |B9S|</span>
<span id="cb132-4" d__=""><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>00000023</span></code></pre></div>
<p d__="">But for this project, the only things in that file you really will care about are:</p>
<ul>
<li d__="">The length (in bytes) of the data</li>
<li d__="">The 16-bit big-endian checksum that’s stored at offset 16-17</li>
</ul>
<p d__="">More on that later!</p>
<p d__="">Note: these files contain “semi-correct” TCP headers. All the 
parts are there, but the various values (especially in the flags and 
options fields) might make no sense.</p>
<h2 data-number="16.5" id="how-on-earth-do-you-compute-a-tcp-checksum" d__=""><span class="header-section-number">16.5</span> How On Earth Do You Compute A TCP Checksum?</h2>
<p d__="">It’s not easy.</p>
<p d__="">The TCP checksum is there to verify the integrity of several things:</p>
<ul>
<li d__="">The TCP header</li>
<li d__="">The TCP payload</li>
<li d__="">The source and destination IP addresses (to protect against misrouted data ending up in the TCP stream).</li>
</ul>
<p d__="">The last part is interesting, because the IP addresses aren’t 
in the TCP header or data at all, so how do we get them included in the 
checksum?</p>
<p d__="">A TCP checksum is a two-byte number that is computed like 
this, given TCP header data, the payload, and the source and IP 
addresses:</p>
<ul>
<li><p d__="">Build a sequence of bytes representing the IP Pseudo header (see below).</p></li>
<li><p d__="">Set the existing TCP header checksum to zero.</p></li>
<li><p d__="">Concatenate the IP pseudo header + the TCP header and payload.</p></li>
<li><p d__="">Compute the checksum of that concatenation.</p></li>
</ul>
<p d__="">That’s how you compute a TCP checksum.</p>
<p d__="">But there are a lot of details.</p>
<h2 data-number="16.6" id="the-ip-pseudo-header" d__=""><span class="header-section-number">16.6</span> The IP Pseudo Header</h2>
<p d__="">Since we want to make sure that the IP addresses are correct 
for this data, as well, we need to include the IP header in our 
checksum.</p>
<p d__="">Except we don’t include the real IP header. We make a fake one. And it looks like this (stolen straight out of the TCP RFC):</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb133-1" d__=""><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>+--------+--------+--------+--------+</span>
<span id="cb133-2" d__=""><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>|           Source Address          |</span>
<span id="cb133-3" d__=""><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>+--------+--------+--------+--------+</span>
<span id="cb133-4" d__=""><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>|         Destination Address       |</span>
<span id="cb133-5" d__=""><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>+--------+--------+--------+--------+</span>
<span id="cb133-6" d__=""><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>|  Zero  |  PTCL  |    TCP Length   |</span>
<span id="cb133-7" d__=""><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>+--------+--------+--------+--------+</span></code></pre></div>
<p d__="">Don’t let the grid layout fool you: the IP pseudo header is a 
string of bytes. It’s just in this layout for easier human consumption.</p>
<p d__="">Each <code s__="13">+</code> sign in diagram represents a byte delimiter.</p>
<p d__="">So the Source Address is 4 bytes. (Hey! IPv4 addresses are 4 bytes long!) <strong>You get this out of the <code s__="13">tcp_addrs_n.txt</code> files</strong>.</p>
<p d__="">The Destination Address is 4 bytes. <strong>You get this out of the <code s__="13">tcp_addrs_n.txt</code> files, as well</strong>.</p>
<p d__="">Zero is one byte, just set to byte value <code s__="13">0x00</code>.</p>
<p d__="">PTCL is the protocol, and that is always set to a byte value of <code s__="13">0x06</code>. (IP has some magic numbers that represent the higher level protocol above it. TCP’s number is 6. That’s where it comes from.)</p>
<p d__="">TCP Length is the total length, in bytes of the TCP packet and data, big-endian. <strong>This is the length of the data you’ll read out of the <code s__="13">tcp_data_n.dat</code> files</strong>.</p>
<p d__="">So before you can compute the TCP checksum, you have to fabricate an IP pseudo header!</p>
<h3 data-number="16.6.1" id="example-pseudo-header" d__=""><span class="header-section-number">16.6.1</span> Example Pseudo Header</h3>
<p d__="">If the source IP is <code s__="13">255.0.255.1</code> and the dest IP is <code s__="13">127.255.0.1</code>, and the TCP length is 3490 (hex 0x0da2), the pseudo header would be this sequence of bytes:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb134-1" d__=""><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a> Source IP |  Dest IP  |Z |P |TCP length</span>
<span id="cb134-2" d__=""><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>           |           |  |  |  </span>
<span id="cb134-3" d__=""><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>ff 00 ff 01 7f ff 00 01 00 06 0d a2</span></code></pre></div>
<p d__=""><code s__="13">Z</code> is the zero section. And <code s__="13">P</code> is the protocol (always 6).</p>
<p d__="">See how the bytes line up to the inputs? (255 is hex 0xff, 127 is hex 0x7f, etc.)</p>
<h3 data-number="16.6.2" id="getting-the-ip-address-bytes" d__=""><span class="header-section-number">16.6.2</span> Getting the IP Address Bytes</h3>
<p d__="">If you noticed, the IP addresses in the <code s__="13">tcp_addrs_n.txt</code> files are in dots and numbers format, not binary.</p>
<p><strong d__="">You’re going to need to write a function that turns a dots-and-numbers string into a sequence of 4 bytes.</strong></p>
<p d__="">Algorithm:</p>
<ul>
<li d__="">Split the dots and numbers into an array of 4 integers.</li>
<li d__="">Convert each of those to a byte with <code s__="13">.to_bytes()</code></li>
<li d__="">Concatenate them all together into a single bytestring.</li>
</ul>
<p d__="">This function will take a dots-and-numbers IPv4 address and return a four-byte bytestring with the result.</p>
<p d__="">Here’s a test:</p>
<ul>
<li d__="">Input: <code s__="13">"1.2.3.4"</code></li>
<li d__="">Output: <code s__="13">b'\x01\x02\x03\x04'</code></li>
</ul>
<p d__="">Then you can run this function on each of the IP addresses in the input file and append them to the pseudoheader.</p>
<h3 data-number="16.6.3" id="getting-the-tcp-data-length" d__=""><span class="header-section-number">16.6.3</span> Getting the TCP Data Length</h3>
<p d__="">This is easy: once you read in one of the <code s__="13">tcp_data_n.dat</code> files, just get the length of the data.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb135-1" d__=""><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">with</span> <span class="bu" d__="">open</span>(<span class="st" d__="">"tcp_data_0.dat"</span>, <span class="st" d__="">"rb"</span>) <span class="im" d__="">as</span> fp:</span>
<span id="cb135-2" d__=""><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>    tcp_data <span class="op" d__="">=</span> fp.read()</span>
<span id="cb135-3" d__=""><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>    tcp_length <span class="op" d__="">=</span> <span class="bu" d__="">len</span>(tcp_data)  <span class="co" d__=""># &lt;-- right here</span></span></code></pre></div>
<p><strong d__="">Be sure to use <code s__="13">"rb"</code> when reading binary data! That’s what the <code s__="13">b</code> is for! If you don’t do this, it might break everything!</strong></p>
<h2 data-number="16.7" id="the-tcp-header-checksum" d__=""><span class="header-section-number">16.7</span> The TCP Header Checksum</h2>
<p d__="">When computing the checksum, we need a TCP header with its checksum field set to zero.</p>
<p d__="">And we also need to extract the existing checksum from the TCP
 header we received so that we can compare it against the one we 
compute!</p>
<p d__="">This diagram is massive, but we actually only care about one part. So skim this and move on to the next paragraph:</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb136-1" d__=""><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a> 0                   1                   2                   3</span>
<span id="cb136-2" d__=""><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
<span id="cb136-3" d__=""><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span id="cb136-4" d__=""><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>|          Source Port          |       Destination Port        |</span>
<span id="cb136-5" d__=""><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span id="cb136-6" d__=""><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>|                        Sequence Number                        |</span>
<span id="cb136-7" d__=""><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span id="cb136-8" d__=""><a href="#cb136-8" aria-hidden="true" tabindex="-1"></a>|                    Acknowledgment Number                      |</span>
<span id="cb136-9" d__=""><a href="#cb136-9" aria-hidden="true" tabindex="-1"></a>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span id="cb136-10" d__=""><a href="#cb136-10" aria-hidden="true" tabindex="-1"></a>|  Data |           |U|A|P|R|S|F|                               |</span>
<span id="cb136-11" d__=""><a href="#cb136-11" aria-hidden="true" tabindex="-1"></a>| Offset| Reserved  |R|C|S|S|Y|I|            Window             |</span>
<span id="cb136-12" d__=""><a href="#cb136-12" aria-hidden="true" tabindex="-1"></a>|       |           |G|K|H|T|N|N|                               |</span>
<span id="cb136-13" d__=""><a href="#cb136-13" aria-hidden="true" tabindex="-1"></a>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span id="cb136-14" d__=""><a href="#cb136-14" aria-hidden="true" tabindex="-1"></a>|           Checksum            |         Urgent Pointer        |</span>
<span id="cb136-15" d__=""><a href="#cb136-15" aria-hidden="true" tabindex="-1"></a>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span id="cb136-16" d__=""><a href="#cb136-16" aria-hidden="true" tabindex="-1"></a>|                    Options                    |    Padding    |</span>
<span id="cb136-17" d__=""><a href="#cb136-17" aria-hidden="true" tabindex="-1"></a>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span id="cb136-18" d__=""><a href="#cb136-18" aria-hidden="true" tabindex="-1"></a>|                             data                              |</span>
<span id="cb136-19" d__=""><a href="#cb136-19" aria-hidden="true" tabindex="-1"></a>+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></code></pre></div>
<p d__="">(Again, like the IP pseudo header, this is encoded as a stream
 of bytes and the grid is only here to make our human lives easier. This
 grid is 32-bits across, numbered along the top.)</p>
<p d__="">See where it says <code s__="13">Checksum</code>? That’s the 
bit we care about for this project. And it’s a two-byte number 
(big-endian) at byte offsets 16 and 17 inside the TCP header.</p>
<p d__="">It will also be at byte offset 16-17 in the files <code s__="13">tcp_data_n.dat</code> since those files start with the TCP header. (Followed by the TCP payload.)</p>
<p><strong d__="">You’ll need the checksum from that file. Use a slice to get those two bytes and then use <code s__="13">.from_bytes()</code> to convert it into a number. This is the original checksum you’ll compare against at the end of the day!</strong></p>
<p><strong d__="">You’ll also need to generate a version of that TCP header and data where the checksum is set to zero. You can do it like this:</strong></p>
<div class="sourceCode" id="cb137"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb137-1" d__=""><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>tcp_zero_cksum <span class="op" d__="">=</span> tcp_data[:<span class="dv" d__="">16</span>] <span class="op" d__="">+</span> <span class="st" d__="">b'</span><span class="ch" d__="">\x00\x00</span><span class="st" d__="">'</span> <span class="op" d__="">+</span> tcp_data[<span class="dv" d__="">18</span>:]</span></code></pre></div>
<p d__="">See how we made a new version of the TCP data there? We sliced
 everything before and after the existing checksum, and put two zero 
bytes in the middle.</p>
<h2 data-number="16.8" id="actually-computing-the-checksum" d__=""><span class="header-section-number">16.8</span> Actually Computing the Checksum</h2>
<p d__="">We’re getting there. So far we’ve done these steps:</p>
<ul>
<li d__="">Build the IP pseudo header</li>
<li d__="">Extract the checksum from the existing TCP header</li>
<li d__="">Build a version of the TCP header with a zero checksum</li>
</ul>
<p d__="">And now we get to the do the math. Here’s what the spec says to do:</p>
<blockquote>
<p d__="">The checksum field is the 16 bit one’s complement of the one’s complement sum of all 16 bit words in the header and text.</p>
</blockquote>
<p d__="">All right, we’re already in trouble. The what of the what?</p>
<p d__="">One’s complement is a way of representing positive and 
negative integers in binary. We don’t need to know the details for this,
 gratefully.</p>
<p d__="">But one thing we do need to notice is that we’re talking about all the “16 bit words”… what is that?</p>
<p d__="">It means that instead of considering all this data to be a 
bunch of bytes, we’re considering it to be a bunch of 16-bit values 
packed together.</p>
<p d__="">So if you have the bytes:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb138-1" d__=""><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>01 02 03 04 05 06</span></code></pre></div>
<p d__="">we’re going to think of that as 3 16-bit values:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb139-1" d__=""><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>0102 0304 0506</span></code></pre></div>
<p d__="">And we’re going to be adding those together. With one’s complement addition. Whatever that means.</p>
<p d__="">Hey–but what if there are an odd number of bytes?</p>
<blockquote>
<p d__="">If a segment contains an odd number of header and text octets 
to be checksummed, the last octet is padded on the right with zeros to 
form a 16 bit word for checksum purposes.</p>
</blockquote>
<p d__="">So we’re going to have to look at the <code s__="13">tcp_length</code> we got from taking the length of the data from the <code s__="13">tcp_data_0.dat</code> file. If it’s odd, just add a zero to the end of the entire data.</p>
<p d__="">Conveniently, we have a copy of the TCP data we can use 
already: the version we made with the checksum zeroed out. Since we’re 
going to be iterating over this anyway, might as well append the zero 
byte to that:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb140-1" d__=""><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">if</span> <span class="bu" d__="">len</span>(tcp_zero_cksum) <span class="op" d__="">%</span> <span class="dv" d__="">2</span> <span class="op" d__="">==</span> <span class="dv" d__="">1</span>:</span>
<span id="cb140-2" d__=""><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    tcp_zero_cksum <span class="op" d__="">+=</span> <span class="st" d__="">b'</span><span class="ch" d__="">\x00</span><span class="st" d__="">'</span></span></code></pre></div>
<p d__="">That will force it to be even length.</p>
<p d__="">We can extract all those 16-bit values doing something like 
the following. Remember that the data to be checksummed includes the 
pseudo header and TCP data (with the checksum field set to zero):</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb141-1" d__=""><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>data <span class="op" d__="">=</span> pseudoheader <span class="op" d__="">+</span> tcp_zero_cksum</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-3" d__=""><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>offset <span class="op" d__="">=</span> <span class="dv" d__="">0</span>   <span class="co" d__=""># byte offset into data</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-5" d__=""><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">while</span> offset <span class="op" d__="">&lt;</span> <span class="bu" d__="">len</span>(data):</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># Slice 2 bytes out and get their value:</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-8" d__=""><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>    word <span class="op" d__="">=</span> <span class="bu" d__="">int</span>.from_bytes(data[offset:offset <span class="op" d__="">+</span> <span class="dv" d__="">2</span>], <span class="st" d__="">"big"</span>)</span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-10" d__=""><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>    offset <span class="op" d__="">+=</span> <span class="dv" d__="">2</span>   <span class="co" d__=""># Go to the next 2-byte value</span></span></code></pre></div>
<p d__="">Great. That iterates over all the words in the whole chunk of data. But what does that buy us?</p>
<p d__="">What’s the checksum, already?</p>
<p d__="">Let’s take that loop above and add the checksum code to it.</p>
<p d__="">Here we’re back to that one’s-complement stuff. And some 
16-bit stuff, which is tricky in Python because it uses 
arbitrary-precision integers.</p>
<p d__="">But here’s how we want to do it. In the following example, <code s__="13">tcp_data</code> is the TCP data padded to an even length with zero for the checksum.</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Pseudocode</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3" d__=""><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>function checksum(pseudo_header, tcp_data)</span>
<span id="cb142-4" d__=""><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>    data <span class="op" d__="">=</span> pseudo_header <span class="op" d__="">+</span> tcp_data</span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-6" d__=""><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>    total <span class="op" d__="">=</span> <span class="dv" d__="">0</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-8" d__=""><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf" d__="">for</span> each <span class="dv" d__="">16</span><span class="op" d__="">-</span>bit word of data:  <span class="co" d__=""># See code above</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-10" d__=""><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>        total <span class="op" d__="">+=</span> word</span>
<span id="cb142-11" d__=""><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>        total <span class="op" d__="">=</span> (total <span class="op" d__="">&amp;</span> <span class="bn" d__="">0xffff</span>) <span class="op" d__="">+</span> (total <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">16</span>)  <span class="co" d__=""># carry around</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-13" d__=""><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf" d__="">return</span> (<span class="op" d__="">~</span>total) <span class="op" d__="">&amp;</span> <span class="bn" d__="">0xffff</span>  <span class="co" d__=""># one's complement</span></span></code></pre></div>
<p d__="">That “carry around” thing is part of the one’s complement math. The <code s__="13">&amp;0xffff</code> stuff all over the place is forcing Python to give us 16-bit integers.</p>
<p d__="">Remember what the spec said?</p>
<blockquote>
<p d__="">The checksum field is the 16 bit one’s complement of the one’s complement sum of all 16 bit words in the header and text.</p>
</blockquote>
<p d__="">The loop is getting us the “one’s complement sum”. The <code s__="13">~total</code> at the end is getting us the “one’s complement” of that.</p>
<h2 data-number="16.9" id="final-comparison" d__=""><span class="header-section-number">16.9</span> Final Comparison</h2>
<p d__="">Now that you’ve computed the checksum for the TCP data and 
extracted the existing checksum from the TCP data, it’s time to compare 
the two.</p>
<p d__="">If they are equal, the data is intact and correct. If they are unequal, the data corrupted.</p>
<p d__="">In the sample data, the first 5 files are intact, and the last 5 are corrupted.</p>
<h2 data-number="16.10" id="output" d__=""><span class="header-section-number">16.10</span> Output</h2>
<p d__="">The output of your program should show which TCP data passes and which fails. That is, this should be your output:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb143-1" d__=""><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>PASS</span>
<span id="cb143-2" d__=""><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>PASS</span>
<span id="cb143-3" d__=""><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>PASS</span>
<span id="cb143-4" d__=""><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a>PASS</span>
<span id="cb143-5" d__=""><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>PASS</span>
<span id="cb143-6" d__=""><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>FAIL</span>
<span id="cb143-7" d__=""><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>FAIL</span>
<span id="cb143-8" d__=""><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>FAIL</span>
<span id="cb143-9" d__=""><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>FAIL</span>
<span id="cb143-10" d__=""><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a>FAIL</span></code></pre></div>
<h2 data-number="16.11" id="success" d__=""><span class="header-section-number">16.11</span> Success</h2>
<p d__="">That was no easy thing. Treat yourself! You earned it.</p>
<!-- Rubric

100 points

10
Function converts dots-and-numbers to 4 big-endian bytes

5
Pseudo header contains source and destination IP addresses in binary format

5
Pseudo header contains zero in zero field

5
Psudeo header contains binary value 0x06 in the protocol field

5
Pseudo header contains proper TCP segment length as a 16-bit big-endian number

5
Checksum concatenates the pseudo header and TCP header and data

5
Checksum pads complete data to an even byte length

10
Checksum computation operates on 16-bit words

10
Checksum computation is correct one's complement math

5
Checksum is inverted before returning

5
Checksum results are masked correctly to 16 bits

10
All 10 file sets are read and processed

5
Original checksum is extracted correctly

5
A version of the TCP data with checksum zeroed is constructed correctly

10
"PASS"/"FAIL" output is correct.

-->
<!-- BG_NEW_CHAPTER -->
<!-- IP, Subnet, and Subnet Mask Review -->
<!--
Documentation subnets: 192.0.2.0/24, 198.51.100.0/24, 203.0.113.0/24
-->
<h1 data-number="17" id="ip-subnets-and-subnet-masks" d__=""><span class="header-section-number">17</span> IP Subnets and Subnet Masks</h1>
<p d__="">[<em>Everything in this chapter will use IPv4, not IPv6. The concepts are basically the same; it’s just easier to learn with IPv4.</em>]</p>
<p><strong d__="">If you’re needing to review your Bitwise Operations, please see the <a href="#appendix-bitwise" d__="">Appendix: Bitwise Operations</a>.</strong></p>
<p d__="">In this chapter:</p>
<ul>
<li d__="">Address representation</li>
<li d__="">Converting from dots-and-numbers to a value</li>
<li d__="">Converting from a value to dots-and-numbers</li>
<li d__="">Subnet and host refresher</li>
<li d__="">Subnet Mask refresher</li>
<li d__="">Finding the subnet mask from slash notation</li>
<li d__="">Finding the subnet for an IP address, given that address and a subnet mask</li>
</ul>
<h2 data-number="17.1" id="address-representation" d__=""><span class="header-section-number">17.1</span> Address Representation</h2>
<p d__="">Remember that IPv4 addresses are commonly shown in dots-and-numbers notation, e.g.&nbsp;<code s__="13">198.51.100.10</code>.</p>
<p d__="">And recall that each of those numbers is a byte, which can 
have values 0-255, decimal (which is the same as 00-FF hexadecimal, and 
00000000-11111111 binary).</p>
<p d__="">So really, the dots-and-numbers is just there for our human convenience.</p>
<blockquote>
<p d__="">Protip: remember that different number bases like hex, binary,
 and decimal are just different ways of writing a value down. Kind of 
like different languages for representing the same numeric value.</p>
<p d__="">When a value is stored in a variable, it’s best to think of it
 as existing in a pure numeric sense–no base at all. It’s only when you 
write it down (in code or print it out) that the base matters.</p>
<p d__="">For instance, Python prints everything in decimal (base 10) by
 default. It has various methods to override that and output in another 
base.</p>
</blockquote>
<p d__="">Let’s look at that address <code s__="13">198.51.100.10</code> in hex: <code s__="13">c6.33.64.0a</code>.</p>
<p d__="">Now let’s cram those bytes together into a single hex number: <code s__="13">c633640a</code>.</p>
<p d__="">Converting <code s__="13">c633640a</code> into decimal, we get: <code s__="13">3325256714</code>.</p>
<p d__="">So in a way, these all represent the same IP address:</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb144-1" d__=""><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>198.51.100.10</span>
<span id="cb144-2" d__=""><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>c6.33.64.0a</span>
<span id="cb144-3" d__=""><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>c633640a</span>
<span id="cb144-4" d__=""><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>3325256714</span></code></pre></div>
<p d__="">Fair enough?</p>
<p d__="">But why?</p>
<p d__="">Well, we’re about to do some math on IP addresses. Now, we <em>could</em> do that math one byte at a time and it would work just fine.</p>
<p d__="">But it turns out that if we pack all those bytes into a single
 number, we can do the math on all the bytes at once, and it becomes 
easier. Stay tuned!</p>
<h2 data-number="17.2" id="converting-from-dots-and-numbers" d__=""><span class="header-section-number">17.2</span> Converting from Dots-and-Numbers</h2>
<p d__="">Our goal in this section is to take a dots-and-numbers string like <code s__="13">198.51.100.10</code> and convert it into the corresponding value, like <code s__="13">3325256714</code> (decimal).</p>
<p d__="">We could do it with string manipulation like in the previous section, but let’s do it in a more <em>bitwise</em> sense.</p>
<p d__="">Let’s extract the individual numbers from an IP address (Python can do this with <code s__="13">.split()</code>.)</p>
<p d__="">The string:</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">"198.51.100.10"</span></span></code></pre></div>
<p d__="">becomes the list of strings:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb146-1" d__=""><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>[<span class="st" d__="">"198"</span>, <span class="st" d__="">"51"</span>, <span class="st" d__="">"100"</span>, <span class="st" d__="">"10"</span>]</span></code></pre></div>
<p d__="">Now let’s convert each of those to integers. (Python could do this with a loop and the <code s__="13">int()</code> function, or <code s__="13">map()</code>, or a list comprehension.)</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb147-1" d__=""><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>[<span class="dv" d__="">198</span>, <span class="dv" d__="">51</span>, <span class="dv" d__="">100</span>, <span class="dv" d__="">10</span>]</span></code></pre></div>
<p d__="">Now I’m going to write these numbers in hex because it makes 
the future steps more clear. But remember that they’re just stored as 
numeric values, so Python won’t print them as hex unless you ask it to.</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb148-1" d__=""><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>[<span class="bn" d__="">0xc6</span>, <span class="bn" d__="">0x33</span>, <span class="bn" d__="">0x64</span>, <span class="bn" d__="">0x0a</span>]</span></code></pre></div>
<p d__="">To build our number, we’re going to rely on a couple bitwise operations: bitwise-OR and bitwise-shift.</p>
<p d__="">For the sake of example, let’s hardcode the math:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb149-1" d__=""><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>(<span class="bn" d__="">0xc6</span> <span class="op" d__="">&lt;&lt;</span> <span class="dv" d__="">24</span>) <span class="op" d__="">|</span> (<span class="bn" d__="">0x33</span> <span class="op" d__="">&lt;&lt;</span> <span class="dv" d__="">16</span>) <span class="op" d__="">|</span> (<span class="bn" d__="">0x64</span> <span class="op" d__="">&lt;&lt;</span> <span class="dv" d__="">8</span>) <span class="op" d__="">|</span> <span class="bn" d__="">0x0a</span></span></code></pre></div>
<p d__="">Running that in Python gives the decimal number <code s__="13">3325256714</code>. Converted to hex, we’re back to <code s__="13">0xc633640a</code>.</p>
<p d__="">You can use the above formula to convert any set of 4 bytes to a packed number.</p>
<blockquote>
<p d__="">There’s also a clever loop you can run to do it one byte at a 
time. See if you can figure that out as an added challenge! DM the 
instructor to see how clever you were.</p>
</blockquote>
<h2 data-number="17.3" id="converting-to-dots-and-numbers" d__=""><span class="header-section-number">17.3</span> Converting to Dots-and-Numbers</h2>
<p d__="">What if you have that value from the previous section, <code s__="13">3325256714</code>, and you want to get it back as an IP address?</p>
<p d__="">We can use some shifting to make that happen, too! But we have
 to do some AND masking to get just the parts of the number we want.</p>
<p d__="">Let’s convert to hex because each byte is exactly 2 hex digits and it’s a little easier to see them: <code s__="13">0xc633640a</code>.</p>
<p d__="">Now let’s look at that number shifted by 0 bits, 8 bits, 16 bits, and 24 bits:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">24</span> <span class="op" d__="">==</span> <span class="bn" d__="">0x000000c6</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">16</span> <span class="op" d__="">==</span> <span class="bn" d__="">0x0000c633</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a><span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">8</span>  <span class="op" d__="">==</span> <span class="bn" d__="">0x00c63364</span></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">0</span>  <span class="op" d__="">==</span> <span class="bn" d__="">0xc633640a</span></span></code></pre></div>
<p d__="">If you look at just the two digits on the right, you’ll see they’re the bytes of the original number:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb151-1" d__=""><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">24</span> <span class="op" d__="">==</span> <span class="bn" d__="">0x000000</span> c6</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">16</span> <span class="op" d__="">==</span> <span class="bn" d__="">0x0000c6</span> <span class="dv" d__="">33</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a><span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">8</span>  <span class="op" d__="">==</span> <span class="bn" d__="">0x00c633</span> <span class="dv" d__="">64</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">0</span>  <span class="op" d__="">==</span> <span class="bn" d__="">0xc63364</span> <span class="dv" d__="">0</span><span class="er" d__="">a</span></span></code></pre></div>
<p d__="">So we’re onto something, except looking at the right shift 8, for example, we get this:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">8</span>  <span class="op" d__="">==</span> <span class="bn" d__="">0x00c63364</span></span></code></pre></div>
<p d__="">So yes, I’m interested in the byte <code s__="13">0x64</code> like we see on the right, but not the <code s__="13">0xc633</code> part of it. How can I zero that higher part out, leaving just the <code s__="13">0x64</code>?</p>
<p d__="">We can use an <em>AND mask</em>! The bitwise-AND operator can 
work like a stencil letting some of the number through and zeroing other
 parts of it. Let’s do a bitwise-AND on that number with the byte <code s__="13">0xff</code>, which is all 8 bits set to <code s__="13">1</code> and all bits over the first 8 have implied value <code s__="13">0</code>.</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb153-1" d__=""><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>  0x00c63364</span>
<span id="cb153-2" d__=""><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>&amp; 0x000000ff</span>
<span id="cb153-3" d__=""><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>------------</span>
<span id="cb153-4" d__=""><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a>  0x00000064</span></code></pre></div>
<p d__="">Hey! <code s__="13">0x64</code> is the byte from the IP address we wanted! See how where there were binary <code s__="13">1</code>s
 in the mask (except here represented in hex) it let the value “show 
through”, while everywhere that had a zero it was masked out?</p>
<p d__="">Now we can extract our digits:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb154-1" d__=""><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>(<span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">24</span>) <span class="op" d__="">&amp;</span> <span class="bn" d__="">0xff</span> <span class="op" d__="">==</span> <span class="bn" d__="">0x000000c6</span> <span class="op" d__="">==</span> <span class="bn" d__="">0xc6</span></span>
<span id="cb154-2" d__=""><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>(<span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">16</span>) <span class="op" d__="">&amp;</span> <span class="bn" d__="">0xff</span> <span class="op" d__="">==</span> <span class="bn" d__="">0x00000033</span> <span class="op" d__="">==</span> <span class="bn" d__="">0x33</span></span>
<span id="cb154-3" d__=""><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>(<span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">8</span>)  <span class="op" d__="">&amp;</span> <span class="bn" d__="">0xff</span> <span class="op" d__="">==</span> <span class="bn" d__="">0x00000064</span> <span class="op" d__="">==</span> <span class="bn" d__="">0x64</span></span>
<span id="cb154-4" d__=""><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>(<span class="bn" d__="">0xc633640a</span> <span class="op" d__="">&gt;&gt;</span> <span class="dv" d__="">0</span>)  <span class="op" d__="">&amp;</span> <span class="bn" d__="">0xff</span> <span class="op" d__="">==</span> <span class="bn" d__="">0x0000000a</span> <span class="op" d__="">==</span> <span class="bn" d__="">0x0a</span></span></code></pre></div>
<p d__="">And those are the individual bytes of the IP address.</p>
<p d__="">To get from there to dots-and-numbers, you can use an f-string or <code s__="13">.join()</code> in Python.</p>
<h2 data-number="17.4" id="subnet-and-host-refresher" d__=""><span class="header-section-number">17.4</span> Subnet and Host Refresher</h2>
<p d__="">Recall that IP addresses are split into two portions: the 
subnet number and the host number. Some of the bits on the left side of 
the IP address are the network number, and the remaining bits on the 
right are the host number.</p>
<p d__="">Let’s look at an example where the left 24 bits (3 bytes) are 
the subnet number and the right 8 bits (1 byte) holds the host number.</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb155-1" d__=""><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a> Subnet   | Host</span>
<span id="cb155-2" d__=""><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>          | </span>
<span id="cb155-3" d__=""><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>198.51.100.10</span></code></pre></div>
<p d__="">So that represents host <code s__="13">10</code> on subnet <code s__="13">198.51.100.0</code>. (We replace the host bits with <code s__="13">0</code> when talking about the subnet number.)</p>
<p d__="">But I just said above, unilaterally, that there were 24 
network bits in that IP address. That’s not very concise. So they 
invented slash notation.</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb156-1" d__=""><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a>198.51.100.0/24    24 bits are used for subnet</span></code></pre></div>
<p d__="">Or you could use it with an IP address:</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb157-1" d__=""><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>198.51.100.10/24   Host 10 on subnet 198.51.100.0</span></code></pre></div>
<p d__="">Let’s try it with 16 bits for the network:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb158-1" d__=""><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>10.121.2.17/16    Host 2.17 on subnet 10.121.0.0</span></code></pre></div>
<p d__="">Get it?</p>
<p d__="">In those examples we used a multiple of 8 so it would align 
visually on a byte boundary, but there’s no reason you can’t have a 
fractional part of a byte left over for a subnet:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb159-1" d__=""><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>10.121.2.68/28    Host 4 on subnet 10.121.2.64</span></code></pre></div>
<p d__="">If you don’t see where the 4 and 64 came from in the previous example, try writing the bytes out in binary!</p>
<h2 data-number="17.5" id="subnet-mask-refresher" d__=""><span class="header-section-number">17.5</span> Subnet Mask Refresher</h2>
<p d__="">What is the <em>subnet mask</em>? This is a run of <code s__="13">1</code> bits in binary that indicates which part of the IP address is the network portion. It is followed by a run of <code s__="13">0</code>s in binary that indicate which part is the host portion.</p>
<p d__="">It’s used to determine what subnet an IP address belongs to, or what part of the IP represents the host number.</p>
<p d__="">Let’s draw one in binary. We’ll use this example IP address:</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb160-1" d__=""><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>198.51.100.10/24   Host 10 on subnet 198.51.100.0</span></code></pre></div>
<p d__="">Let’s first convert to binary. (There’s a hint here that the subnet mask is a bitwise-AND mask!)</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb161-1" d__=""><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>11000110.00110011.01100100.00001010   198.51.100.10</span></code></pre></div>
<p d__="">And now, above it, let’s draw a run of 24 <code s__="13">1</code>s (because this is a <code s__="13">/24</code> subnet) followed by 8 <code s__="13">0</code>s (because the IP address is 32 bits total).</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb162-1" d__=""><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>11111111.11111111.11111111.00000000   255.255.255.0  subnet mask!</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb162-3" d__=""><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>11000110.00110011.01100100.00001010   198.51.100.10</span></code></pre></div>
<p d__="">That is the subnet mask that corresponds to a <code s__="13">/24</code> subnet! <code s__="13">255.255.255.0</code>!</p>
<h2 data-number="17.6" id="computing-the-subnet-mask-from-slash-notation" d__=""><span class="header-section-number">17.6</span> Computing the Subnet Mask from Slash Notation</h2>
<p d__="">If I tell you a subnet is <code s__="13">/24</code>, how can you determine the subnet mask is <code s__="13">255.255.255.0</code>? Or if I tell you it’s <code s__="13">/28</code> that the mask is <code s__="13">255.255.255.240</code>?</p>
<p d__="">For a subnet <code s__="13">/24</code>, we need a run of 24 <code s__="13">1</code>s, followed by 8 <code s__="13">0</code>s.</p>
<p d__="">Look at the <a href="#appendix-bitwise" d__="">Appendix: Bitwise</a> for ways to generate runs of <code s__="13">1</code>s in binary and shift them over.</p>
<p d__="">Once you have that big binary number, it’s a matter of 
switching it back to dots-and-numbers notation, using the technique we 
outlined, above.</p>
<p d__="">Remember that subnets can end on any bit boundary. <code s__="13">/17</code> is a fine subnet. It doesn’t have to be a multiple of 8!</p>
<h2 data-number="17.7" id="finding-the-subnet-for-an-ip-address" d__=""><span class="header-section-number">17.7</span> Finding the Subnet for an IP address</h2>
<p d__="">If you’re given an IP address with slash notation like this:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb163-1" d__=""><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>198.51.100.10/24   Host 10 on subnet 198.51.100.0</span></code></pre></div>
<p d__="">How can you extract just the subnet (198.51.100.0) and just the host</p>
<p d__="">You can do it with bitwise-AND!</p>
<p d__="">We can compute the subnet mask for <code s__="13">/24</code> and get <code s__="13">255.255.255.0</code>, as above.</p>
<p d__="">After that, let’s take a look in binary and AND these together:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb164-1" d__=""><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>  11111111.11111111.11111111.00000000   255.255.255.0  subnet mask</span>
<span id="cb164-2" d__=""><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>&amp; 11000110.00110011.01100100.00001010   198.51.100.10  IP address</span>
<span id="cb164-3" d__=""><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>-------------------------------------</span>
<span id="cb164-4" d__=""><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>  11000110.00110011.01100100.00000000   198.51.100.0  network number!</span></code></pre></div>
<p d__="">We can operate on the whole thing at once instead of a byte at
 a time, as well… we just need to cram those numbers together into a 
single value, like we did in the section above:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb165-1" d__=""><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>  11111111111111111111111100000000   255.255.255.0  subnet mask</span>
<span id="cb165-2" d__=""><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>&amp; 11000110001100110110010000001010   198.51.100.10  IP address</span>
<span id="cb165-3" d__=""><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>-------------------------------------</span>
<span id="cb165-4" d__=""><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>  11000110001100110110010000000000   198.51.100.0  network number</span></code></pre></div>
<p d__="">The AND works on the whole thing at once! Then we can convert 
back to dots-and-numbers notation like we did in the previous sections.</p>
<p d__="">Now what if you had the IP address and the subnet mask and wanted to get the <em>host</em> bits out of the IP address, not the network bits. Do you see how you could do it? (Hint: bitwise NOT!)</p>
<p d__="">Routers use this all the time–they are given an IP address and
 they need to know if it matches any subnets the router is connected to.
 So it masks out the IP address’s network number and compares it to all 
the subnets that router knows. And then forwards it toward the right 
one.</p>
<h2 data-number="17.8" id="reflect-10" d__=""><span class="header-section-number">17.8</span> Reflect</h2>
<ul>
<li><p d__="">What is the 32-bit (4-byte) representation of the IP address <code s__="13">10.100.30.90</code> in hex? In decimal? In binary? <!-- 0x0a641e5a, 174333530, 0b1010011001000001111001011010 --></p></li>
<li><p d__="">What is the dots-and-numbers IP address represented by the 32-bit number <code s__="13">0xc0a88225</code>? <!-- 192.168.130.37 --></p></li>
<li><p d__="">What is the dots-and-numbers IP address represented by the 32-bit decimal number <code s__="13">180229186</code>? <!-- 10.190.20.66 --></p></li>
<li><p d__="">What bitwise operations do you need to extract the second byte from the left (<code s__="13">0xff</code>) of the number <code s__="13">0x12ff5678</code>? <!--
  shift, AND
  (n >> 16) & 0xff  or  (n & 0xff0000) >> 16
  --></p></li>
<li><p d__="">What is the slash notation for subnet mask <code s__="13">255.255.0.0</code>? <!-- /16 --></p></li>
<li><p d__="">What is the subnet mask for network <code s__="13">192.168.1.12/24</code>? <!-- 255.255.255.0 --></p></li>
<li><p d__="">What are the numeric operations necessary to convert a slash subnet mask to a binary value? <!--
  shift, subtract 1
  ((1 << m) - 1) << (32 - m)
  --></p></li>
<li><p d__="">Given an IP address value (in a single 32-bit number) and a
 subnet mask value (in a single 32-bit number), what bitwise operation 
do you need to perform to get the subnet number from the IP address? <!-- AND the two together --></p></li>
</ul>
<p d__="">192.168.1.0 is the network number, but it’s not the subnet 
mask. The subnet mask is the dots-and-numbers value obtained from the 
slash notation. In this case it’s <code s__="13">/24</code>, which gives us <code s__="13">255.255.255.0</code>.</p>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="18" id="ip-routing" d__=""><span class="header-section-number">18</span> IP Routing</h1>
<p d__="">This chapter is all about routing over IP. This task is handled by computers called <em>routers</em> that know how to direct traffic down different lines that are connected to them.</p>
<p d__="">As we’ll see, every computer attached to the Internet is 
actually a router, but they all rely on other routers to get the packets
 to their destinations.</p>
<p d__="">We’re going to talk about two big ideas:</p>
<ul>
<li><p d__=""><strong>Routing Protocols</strong>: how routers learn the “map” of the network.</p></li>
<li><p d__=""><strong>Routing Algorithm</strong>: how routers decide which direction to send packets after they’ve learned the map.</p></li>
</ul>
<p d__="">Let’s get into it!</p>
<h2 data-number="18.1" id="routing-protocols" d__=""><span class="header-section-number">18.1</span> Routing Protocols</h2>
<p d__="">Routing protocols in general have this goal: give routers enough information to make routing decisions.</p>
<p d__="">That is, when a router receives a packet on one interface, how
 does it decide which interface to forward it to? How does it know which
 route leads to the packet’s eventual destination?</p>
<h3 data-number="18.1.1" id="interior-gateway-protocols" d__=""><span class="header-section-number">18.1.1</span> Interior Gateway Protocols</h3>
<p d__="">When it comes to routing packets over the Internet, we’ll take
 a higher view. Let’s look at the Internet as a bunch of clumps of 
networks that are more loosely connected. “Clump” is not an official 
industry term, for the record. The official term is <em>autonomous system</em> (AS), which Wikipedia defines as:</p>
<blockquote>
<p d__="">[…] a collection of connected Internet Protocol (IP) routing 
prefixes under the control of one or more network operators on behalf of
 a single administrative entity or domain, that presents a common and 
clearly defined routing policy to the Internet.</p>
</blockquote>
<p d__="">But let’s think of it as a clump for now.</p>
<p d__="">For example, OSU has a clump of network. It has its own internal routers and subnets that are “on the Internet”. A <a href="https://en.wikipedia.org/wiki/Big_Tech#FAANG" d__="">FAANG company</a> might have another clump of Internet.</p>
<p d__="">Within these clumps of Internet, an <em>interior gateway protocol</em> is used for routing. It’s a routing algorithm that is optimized for smaller networks with a small number of subnets.</p>
<p d__="">Here are some examples of interior gateway protocols</p>
<!-- CAPTION: Interior Gateway Protocols -->
<table>
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr>
<th d__="">Abbreviation</th>
<th d__="">Name</th>
<th d__="">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td d__="">OSPF</td>
<td d__="">Open Shortest Path First</td>
<td d__="">Most commonly used, IP layer</td>
</tr>
<tr>
<td d__="">IS-IS</td>
<td d__="">Intermediate System to Intermediate System</td>
<td d__="">Link layer</td>
</tr>
<tr>
<td d__="">EIGRP</td>
<td d__="">Enhanced Interior Gateway Routing Protocol</td>
<td d__="">Cisco semi-proprietary</td>
</tr>
<tr>
<td d__="">RIP</td>
<td d__="">Routing Information Protocol</td>
<td d__="">Old, rarely used</td>
</tr>
</tbody>
</table>
<p d__="">But of course you need to be able to communicate between these
 clumps of Internet–the whole Internet is connected after all. It would 
be a bummer if you couldn’t use Google’s servers from Oregon State. But 
clearly Google’s servers don’t have a map of OSU’s network… so how do 
they know how to route traffic?</p>
<h3 data-number="18.1.2" id="exterior-gateway-protocols" d__=""><span class="header-section-number">18.1.2</span> Exterior Gateway Protocols</h3>
<p d__="">Having every router have a complete map of the Internet isn’t 
practical. Works fine on smaller clumps, but not on the whole thing.</p>
<p d__="">So we change it up for communication between these clumps and use an <em>exterior gateway protocol</em> for routing between the clumps.</p>
<p d__="">Remember the official term for “clump”? Autonomous Systems. Each autonomous system on the Internet is assigned an <em>autonomous system number</em> (ASN) that is used by the <em>border gateway protocol</em> (BGP) to help determine where to route packets.</p>
<!-- CAPTION: Exterior Gateway Protocols -->
<table>
<thead>
<tr>
<th d__="">Abbreviation</th>
<th d__="">Name</th>
<th d__="">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td d__="">BGP</td>
<td d__="">Border Gateway Protocol</td>
<td d__="">Used everywhere</td>
</tr>
<tr>
<td d__="">EGP</td>
<td d__="">Exterior Gateway Protocol</td>
<td d__="">Obsolete</td>
</tr>
</tbody>
</table>
<p d__="">BGP can work in two different modes: internal BGP and external
 BGP. In internal mode, it acts as an interior gateway protocol, while 
external mode acts as an external gateway protocol.</p>
<p d__="">There’s a <a href="https://www.youtube.com/watch?v=A1KXPpqlNZ4" d__="">great video from <em>Eye on Tech</em></a><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup s__="13" d__="">8</sup></a> that concisely covers it. I highly recommend spending the two minutes watching this to tie it all together.</p>
<h2 data-number="18.2" id="routing-tables" d__=""><span class="header-section-number">18.2</span> Routing tables</h2>
<p d__="">A routing table is a definition of where to forward packets to
 get them farther along to their destination. Or, if the router is on 
the destination LAN, the routing table directs the router to send the 
traffic out locally at the physical layer (e.g.&nbsp;Ethernet).</p>
<p d__="">The goal of the routing protocols we talked about above is to help routers across the Internet build their routing tables.</p>
<p d__="">All computers connected to the Internet–routers and 
otherwise–have routing tables. Even on your laptop, the OS has to know 
what to do with different destination addresses. What if the destination
 is localhost? What if it’s another computer on the same subnet? What if
 it’s something else?</p>
<p d__="">Looking at the typical laptop as an example, the OS keeps localhost traffic on the <em>loopback device</em>
 and it typically doesn’t go out on the network at all. From our 
programmer standpoint, it looks like it’s doing network stuff, but the 
OS knows to route <code s__="13">127.0.0.1</code> traffic internally.</p>
<p d__="">But what if you ping another computer on the same LAN as you? 
In that case, the OS checks the routing table, determines it’s on the 
same LAN, and sends it out over Ethernet to the destination.</p>
<p d__="">But what if you ping another computer on a completely 
different LAN than you? When that happens, the OS can’t just send out an
 Ethernet frame and have it reach the destination. The destination isn’t
 on the same Ethernet network! So your computer instead forwards the 
packet to its <em>default gateway</em>, that is, the router of last 
resort. If your computer doesn’t have a routing table entry for the 
destination subnet in question, it sends it to the default gateway, 
which forwards it to the greater Internet.</p>
<p d__="">Let’s look at an example routing table from my Linux machine, which in this example has been assigned address <code s__="13">192.168.1.230</code>.</p>
<!-- CAPTION: Example Routing Table -->
<table>
<thead>
<tr>
<th></th>
<th d__="">Source</th>
<th d__="">Destination</th>
<th d__="">Gateway</th>
<th d__="">Device</th>
</tr>
</thead>
<tbody>
<tr>
<td d__="">1</td>
<td><code s__="13" d__="">127.0.0.1</code></td>
<td><code s__="13" d__="">127.0.0.1</code></td>
<td></td>
<td><code s__="13" d__="">lo</code></td>
</tr>
<tr>
<td d__="">2</td>
<td><code s__="13" d__="">127.0.0.1</code></td>
<td><code s__="13" d__="">127.0.0.0/8</code></td>
<td></td>
<td><code s__="13" d__="">lo</code></td>
</tr>
<tr>
<td d__="">3</td>
<td><code s__="13" d__="">127.0.0.1</code></td>
<td><code s__="13" d__="">127.255.255.255</code></td>
<td></td>
<td><code s__="13" d__="">lo</code></td>
</tr>
<tr>
<td d__="">4</td>
<td><code s__="13" d__="">192.168.1.230</code></td>
<td><code s__="13" d__="">192.168.1.230</code></td>
<td></td>
<td><code s__="13" d__="">wlan0</code></td>
</tr>
<tr>
<td d__="">5</td>
<td><code s__="13" d__="">192.168.1.230</code></td>
<td><code s__="13" d__="">192.168.1.0/24</code></td>
<td></td>
<td><code s__="13" d__="">wlan0</code></td>
</tr>
<tr>
<td d__="">6</td>
<td><code s__="13" d__="">192.168.1.230</code></td>
<td><code s__="13" d__="">192.168.1.255</code></td>
<td></td>
<td><code s__="13" d__="">wlan0</code></td>
</tr>
<tr>
<td d__="">7</td>
<td><code s__="13" d__="">192.168.1.230</code></td>
<td><code s__="13" d__="">default</code></td>
<td><code s__="13" d__="">192.168.1.1</code></td>
<td><code s__="13" d__="">wlan0</code></td>
</tr>
</tbody>
</table>
<p d__="">Let’s take a look at connecting from <code s__="13">localhost</code> to <code s__="13">localhost</code> (<code s__="13">127.0.0.1</code>). In that case, the OS looks up what route matches and sends the data on the corresponding interface. In this case, that’s the <em>loopback</em> interface (<code s__="13">lo</code>), a “fake” interface that the OS pretends is a network interface. (For performance reasons.)</p>
<p d__="">But what if we send data from <code s__="13">127.0.0.1</code> to anything on the <code s__="13">127.0.0.0/8</code> subnet? It uses the <code s__="13">lo</code> interface as well. And the same thing happens if we send data to the <code s__="13">127.255.255.255</code> broadcast address (on the <code s__="13">127.0.0.0/8</code> subnet).</p>
<p d__="">The other entries are more interesting. Remember as you look at these that my machine has been assigned <code s__="13">192.168.1.230</code>.</p>
<p d__="">So if we look at line 4, above, we’re looking at the case where I send from my machine to itself. This is like <code s__="13">localhost</code> except I’m deliberately using the IP attached to my wireless LAN device, <code s__="13">wlan0</code>. So the OS is going to use that system, but is smart enough to not bother sending it over the wire–after all, <em>this</em> is the destination.</p>
<p d__="">After that, we have the case where we’re sending to any other host on the <code s__="13">192.168.1.0/24</code> subnet. So this is like my sending from my machine as <code s__="13">192.168.1.230</code> to another machine, for example <code s__="13">192.168.1.22</code>, say. Or any other machine on that subnet.</p>
<p d__="">And then on line 6 we have a broadcast address for the LAN, which also goes out on the WiFi device.</p>
<p d__="">But what if all that fails? What if I’m sending from <code s__="13">192.168.1.230</code> to <code s__="13">203.0.113.37</code>? That’s not an IP or subnet listed on my destinations in my routing table.</p>
<p d__="">This is what line 7 is for: the <em>default gateway</em>. This is where a router sends packets if it doesn’t know how to otherwise route them.</p>
<p d__="">At your house, this is the router that you got from your ISP. Or that you bought and installed yourself if you were so-inclined.</p>
<p d__="">So when I ping <code s__="13">example.com</code> (<code s__="13">93.184.216.34</code>
 as of this writing) from my home computer, those packets get sent to my
 default gateway because that IP and its corresponding subnet don’t 
appear in my computer’s routing table.</p>
<p d__="">(And they don’t appear in my default gateway’s routing table, either. So it forwards them to its default route.)</p>
<h2 data-number="18.3" id="routing-algorithm" d__=""><span class="header-section-number">18.3</span> Routing Algorithm</h2>
<p d__="">Let’s assume now that the routing protocols have done their 
job and all the routers have the information they need to know where to 
forward packets along the way.</p>
<p d__="">When the packet arrives, the router follows a sequence of 
steps to decide what to do with it next. (For this discussion we’ll 
ignore the loopback device and assume all traffic is on an actual 
network.)</p>
<figure>
<embed src="Beej's%20Guide%20to%20Network%20Concepts_files/ip-routing.svg">
<figcaption aria-hidden="true" s__="14" d__="">IP Routing Algorithm</figcaption>
</figure>
<ul>
<li d__="">If the destination IP is on the local network attached to the router
<ul>
<li>Deliver the packet on the link (physical layer, e.g.&nbsp;Ethernet)</li>
</ul></li>
<li d__="">Else If the routing table has an entry for the destination IP’s network
<ul>
<li>Deliver to the next router toward that destination</li>
</ul></li>
<li d__="">Else If a default route exists:
<ul>
<li>Deliver to default gateway router</li>
</ul></li>
<li d__="">Else
<ul>
<li>Drop packet</li>
<li>Send an <a href="https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol" d__="">ICMP</a> “Destination Unreachable” error message back to the sender</li>
</ul></li>
</ul>
<p d__="">If multiple matching routes exist, the one with the longest subnet mask is chosen.</p>
<p d__="">If there is still a tie, the one with the lowest metric is used.</p>
<p d__="">If there is still a tie, ECMP (Equal Cost Multi-Path) routing can be used–send the packet down both paths.</p>
<h2 data-number="18.4" id="routing-example" d__=""><span class="header-section-number">18.4</span> Routing Example</h2>
<p d__="">Let’s run some examples. <a href="https://beej.us/guide/bgnet0/source/examples/ip-routing-demo.pdf" d__="">You can download a PDF of this diagram for greater clarity</a><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup s__="13" d__="">9</sup></a>.</p>
<p d__="">In this diagram there are lot of missing things. Notably that every router interface has an IP address attached to it.</p>
<p d__="">Also note that, for example, Router 1 is directly connected to 3 subnets, and it has an IP address on each of them.</p>
<figure>
<embed src="Beej's%20Guide%20to%20Network%20Concepts_files/ip-routing-demo.svg">
<figcaption aria-hidden="true" s__="14" d__="">Network Diagram</figcaption>
</figure>
<p d__="">Trace the route of these packets:</p>
<!-- Example Sources and Destinations -->
<table>
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr>
<th d__="">Source</th>
<th d__="">Destination</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><code s__="13" d__="">10.1.23.12</code></td>
<td><code s__="13" d__="">10.2.1.16</code></td>
<td></td>
</tr>
<tr>
<td><code s__="13" d__="">10.1.99.2</code></td>
<td><code s__="13" d__="">10.1.99.6</code></td>
<td></td>
</tr>
<tr>
<td><code s__="13" d__="">192.168.2.30</code></td>
<td><code s__="13" d__="">8.8.8.8</code></td>
<td></td>
</tr>
<tr>
<td><code s__="13" d__="">10.2.12.37</code></td>
<td><code s__="13" d__="">192.168.2.12</code></td>
<td d__=""><code s__="13">10.0.0.0/8</code> and <code s__="13">192.168.0.0/16</code> are private networks and don’t get routed over the outside Internet</td>
</tr>
<tr>
<td><code s__="13" d__="">10.1.17.22</code></td>
<td><code s__="13" d__="">10.1.17.23</code></td>
<td></td>
</tr>
<tr>
<td><code s__="13" d__="">10.2.12.2</code></td>
<td><code s__="13" d__="">10.1.23.12</code></td>
<td></td>
</tr>
</tbody>
</table>
<h2 data-number="18.5" id="routing-loops-and-time-to-live" d__=""><span class="header-section-number">18.5</span> Routing Loops and Time-To-Live</h2>
<p d__="">It should be apparent that it would be possible to set up a loop where a packet traveled in a circle forever.</p>
<p d__="">To solve this problem, IP has a field in its header: <em>time to live</em> (TTL). This is a one-byte counter that starts at 255 and gets decremented every time a router forwards a packet.</p>
<p d__="">When the counter reaches zero, the packet is discarded and an <a href="https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol" d__="">ICMP</a> “Time Exceeded” error message is returned to the sender.</p>
<p d__="">So the most hops that a packet can make is 255, even in a loop.</p>
<p d__="">The <code s__="13">traceroute</code> utility function works by
 sending a packet toward a destination with a TTL of 1 and seeing who 
sends back the ICMP message. Then it sends out another with a TTL of 2 
and sees who responds. And it keeps increasing the TTL on subsequent 
packets until the ultimate destination responds.</p>
<h2 data-number="18.6" id="the-broadcast-address" d__=""><span class="header-section-number">18.6</span> The Broadcast Address</h2>
<p d__="">There’s a special address in IPv4 called the <em>broadcast address</em>. This is an address that sends a packet to every computer on the LAN.</p>
<p d__="">This is an address on a subnet with all the host bits set to <code s__="13">1</code>.</p>
<p d__="">For example:</p>
<!-- CAPTION Broadcast Addresses -->
<table>
<thead>
<tr>
<th d__="">Subnet</th>
<th d__="">Subnet Mask</th>
<th d__="">Broadcast Address</th>
</tr>
</thead>
<tbody>
<tr>
<td><code s__="13" d__="">10.20.30.0/24</code></td>
<td><code s__="13" d__="">255.255.255.0</code></td>
<td><code s__="13" d__="">10.20.30.255</code></td>
</tr>
<tr>
<td><code s__="13" d__="">10.20.0.0/16</code></td>
<td><code s__="13" d__="">255.255.0.0</code></td>
<td><code s__="13" d__="">10.20.255.255</code></td>
</tr>
<tr>
<td><code s__="13" d__="">10.0.0.0/8</code></td>
<td><code s__="13" d__="">255.0.0.0</code></td>
<td><code s__="13" d__="">10.255.255.255</code></td>
</tr>
</tbody>
</table>
<p d__="">There’s also <em>the</em> broadcast address: <code s__="13">255.255.255.255</code>. This goes to everyone…</p>
<p d__="">…And by everyone I mean everyone on the LAN. None of these broadcast packets make it past the router, not even <code s__="13">255.255.255.255</code>. The routers don’t forward them anywhere.</p>
<p d__="">The world would be a very noisy place if they did.</p>
<p d__="">One of the main uses for it is when you first open your laptop
 on WiFi. The laptop doesn’t know its IP, the subnet mask, the default 
gateway, or even whom to ask. So it sends out a broadcast packet to <code s__="13">255.255.255.255</code> with a <a href="https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol" d__="">DHCP</a> packet asking for that information. A DHCP server is listening and can then reply with the info.</p>
<p d__="">And since you’re all wondering: IPv6 doesn’t have a broadcast 
address; its obviated by a thing called IPv6 multicast. Same idea, just 
more focused.</p>
<h2 data-number="18.7" id="reflect-11" d__=""><span class="header-section-number">18.7</span> Reflect</h2>
<ul>
<li><p d__="">What is the difference between an interior gateway protocol and an external gateway protocol?</p></li>
<li><p d__="">What is the goal of a routing protocol in general?</p></li>
<li><p d__="">What’s an example of a place where an interior gateway protocol would be used? And exterior?</p></li>
<li><p d__="">What does a router use its routing table to determine?</p></li>
<li><p d__="">What does an IP router do next with a packet if the destination IP address is not on one of its local subnets?</p></li>
<li><p d__="">Why would a process send anything to the broadcast address?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="19" id="project-computing-and-finding-subnets" d__=""><span class="header-section-number">19</span> Project: Computing and Finding Subnets</h1>
<p d__="">In preparation for our subsequent project that finds routes 
across the network, we need to do some work in figuring out how IP 
addresses, subnet masks, and subnets all work together.</p>
<p d__="">In this project we’ll put some of the work from the chapters into practice. We’ll:</p>
<ul>
<li><p d__="">Write functions to convert dots-and-numbers IP addresses into single 32-bit values–and back again.</p></li>
<li><p d__="">Write a function that converts a subnet mask in slash notation into a single 32-bit value representing that mask.</p></li>
<li><p d__="">Write a function to see if two IP addresses are on the same subnet.</p></li>
</ul>
<h2 data-number="19.1" id="restrictions-2" d__=""><span class="header-section-number">19.1</span> Restrictions</h2>
<p d__="">You may <strong>not</strong> use:</p>
<ul>
<li d__="">Any functionality from the <code s__="13">socket</code> module.</li>
<li d__="">Any functionality from the <code s__="13">struct</code> module.</li>
<li d__="">Any functionality from the <code s__="13">netaddr</code> module.</li>
<li d__="">The <code s__="13">.to_bytes()</code> or <code s__="13">.from_bytes()</code> methods.</li>
</ul>
<p d__="">Keep it in the realm of your own home-cooked bitwise operations.</p>
<h2 data-number="19.2" id="what-to-do" d__=""><span class="header-section-number">19.2</span> What To Do</h2>
<p d__=""><a href="https://beej.us/guide/bgnet0/source/exercises/netfuncs/netfuncs.zip" d__="">Grab the skeleton code and other files in this ZIP archive</a><a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup s__="13" d__="">10</sup></a>. This is what you’ll fill in for this project.</p>
<p d__="">Implement the following functions in <code s__="13">netfuncs.py</code>:</p>
<ul>
<li><code s__="13" d__="">ipv4_to_value(ipv4_addr)</code></li>
<li><code s__="13" d__="">value_to_ipv4(addr)</code></li>
<li><code s__="13" d__="">get_subnet_mask_value(slash)</code></li>
<li><code s__="13" d__="">ips_same_subnet(ip1, ip2, slash)</code></li>
<li><code s__="13" d__="">get_network(ip_value, netmask)</code></li>
<li><code s__="13" d__="">find_router_for_ip(routers, ip)</code></li>
</ul>
<p d__="">The descriptions of the functions are in the file in their 
respective docstrings. Be sure to pay special attention to the input and
 output <em>types</em> in the examples shown there.</p>
<p d__="">Note that none of the functions need be more than 5-15 lines 
long. If you’re getting a much bigger function implementation, you might
 be off track.</p>
<h2 data-number="19.3" id="testing-as-you-go" d__=""><span class="header-section-number">19.3</span> Testing as you Go</h2>
<p d__="">I encourage you to <em>write one function at a time</em> and test it out by calling it with your own sample data before moving on to the next function.</p>
<p d__="">You can add your own calls to the functions to help you verify
 that they’re doing what they’re supposed to do. Use the inputs and 
outputs from the example comments for tests.</p>
<p d__="">There is a function called <code s__="13">my_tests()</code> in <code s__="13">netfuncs.py</code> that will run instead of the default main function if you uncomment it.</p>
<p d__="">If you uncomment <code s__="13">my_tests()</code>, you can run the program with:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb166-1" d__=""><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> netfuncs.py</span></code></pre></div>
<p d__="">and see the output from that function.</p>
<p d__="">Be sure to comment out <code s__="13">my_tests()</code> and run it with the included main code before you submit, as shown in the next section.</p>
<h2 data-number="19.4" id="running-the-program" d__=""><span class="header-section-number">19.4</span> Running the Program</h2>
<p d__="">You’ll run it like this:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb167-1" d__=""><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> netfuncs.py example1.json</span></code></pre></div>
<p d__="">It will read in the JSON data from the included <code s__="13">example1.json</code> and run your functions on various parts of it.</p>
<p d__="">The output, included in <code s__="13">example1_output.txt</code>, should look exactly like this if everything is working correctly:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb168-1" d__=""><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>Routers:</span>
<span id="cb168-2" d__=""><a href="#cb168-2" aria-hidden="true" tabindex="-1"></a>     10.34.166.1: netmask 255.255.255.0: network 10.34.166.0</span>
<span id="cb168-3" d__=""><a href="#cb168-3" aria-hidden="true" tabindex="-1"></a>     10.34.194.1: netmask 255.255.255.0: network 10.34.194.0</span>
<span id="cb168-4" d__=""><a href="#cb168-4" aria-hidden="true" tabindex="-1"></a>     10.34.209.1: netmask 255.255.255.0: network 10.34.209.0</span>
<span id="cb168-5" d__=""><a href="#cb168-5" aria-hidden="true" tabindex="-1"></a>     10.34.250.1: netmask 255.255.255.0: network 10.34.250.0</span>
<span id="cb168-6" d__=""><a href="#cb168-6" aria-hidden="true" tabindex="-1"></a>      10.34.46.1: netmask 255.255.255.0: network 10.34.46.0</span>
<span id="cb168-7" d__=""><a href="#cb168-7" aria-hidden="true" tabindex="-1"></a>      10.34.52.1: netmask 255.255.255.0: network 10.34.52.0</span>
<span id="cb168-8" d__=""><a href="#cb168-8" aria-hidden="true" tabindex="-1"></a>      10.34.53.1: netmask 255.255.255.0: network 10.34.53.0</span>
<span id="cb168-9" d__=""><a href="#cb168-9" aria-hidden="true" tabindex="-1"></a>      10.34.79.1: netmask 255.255.255.0: network 10.34.79.0</span>
<span id="cb168-10" d__=""><a href="#cb168-10" aria-hidden="true" tabindex="-1"></a>      10.34.91.1: netmask 255.255.255.0: network 10.34.91.0</span>
<span id="cb168-11" d__=""><a href="#cb168-11" aria-hidden="true" tabindex="-1"></a>      10.34.98.1: netmask 255.255.255.0: network 10.34.98.0</span>
<span id="cb168-12"><a href="#cb168-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-13" d__=""><a href="#cb168-13" aria-hidden="true" tabindex="-1"></a>IP Pairs:</span>
<span id="cb168-14" d__=""><a href="#cb168-14" aria-hidden="true" tabindex="-1"></a>   10.34.194.188    10.34.91.252: different subnets</span>
<span id="cb168-15" d__=""><a href="#cb168-15" aria-hidden="true" tabindex="-1"></a>   10.34.209.189    10.34.91.120: different subnets</span>
<span id="cb168-16" d__=""><a href="#cb168-16" aria-hidden="true" tabindex="-1"></a>   10.34.209.229    10.34.166.26: different subnets</span>
<span id="cb168-17" d__=""><a href="#cb168-17" aria-hidden="true" tabindex="-1"></a>   10.34.250.213    10.34.91.184: different subnets</span>
<span id="cb168-18" d__=""><a href="#cb168-18" aria-hidden="true" tabindex="-1"></a>   10.34.250.228    10.34.52.119: different subnets</span>
<span id="cb168-19" d__=""><a href="#cb168-19" aria-hidden="true" tabindex="-1"></a>   10.34.250.234     10.34.46.73: different subnets</span>
<span id="cb168-20" d__=""><a href="#cb168-20" aria-hidden="true" tabindex="-1"></a>     10.34.46.25   10.34.166.228: different subnets</span>
<span id="cb168-21" d__=""><a href="#cb168-21" aria-hidden="true" tabindex="-1"></a>    10.34.52.118     10.34.91.55: different subnets</span>
<span id="cb168-22" d__=""><a href="#cb168-22" aria-hidden="true" tabindex="-1"></a>    10.34.52.158     10.34.166.1: different subnets</span>
<span id="cb168-23" d__=""><a href="#cb168-23" aria-hidden="true" tabindex="-1"></a>    10.34.52.187    10.34.52.244: same subnet</span>
<span id="cb168-24" d__=""><a href="#cb168-24" aria-hidden="true" tabindex="-1"></a>     10.34.52.23    10.34.46.130: different subnets</span>
<span id="cb168-25" d__=""><a href="#cb168-25" aria-hidden="true" tabindex="-1"></a>     10.34.52.60    10.34.46.125: different subnets</span>
<span id="cb168-26" d__=""><a href="#cb168-26" aria-hidden="true" tabindex="-1"></a>    10.34.79.218     10.34.79.58: same subnet</span>
<span id="cb168-27" d__=""><a href="#cb168-27" aria-hidden="true" tabindex="-1"></a>     10.34.79.81    10.34.46.142: different subnets</span>
<span id="cb168-28" d__=""><a href="#cb168-28" aria-hidden="true" tabindex="-1"></a>     10.34.79.99    10.34.46.205: different subnets</span>
<span id="cb168-29" d__=""><a href="#cb168-29" aria-hidden="true" tabindex="-1"></a>    10.34.91.205    10.34.53.190: different subnets</span>
<span id="cb168-30" d__=""><a href="#cb168-30" aria-hidden="true" tabindex="-1"></a>     10.34.91.68    10.34.79.122: different subnets</span>
<span id="cb168-31" d__=""><a href="#cb168-31" aria-hidden="true" tabindex="-1"></a>     10.34.91.97    10.34.46.255: different subnets</span>
<span id="cb168-32" d__=""><a href="#cb168-32" aria-hidden="true" tabindex="-1"></a>    10.34.98.184     10.34.209.6: different subnets</span>
<span id="cb168-33" d__=""><a href="#cb168-33" aria-hidden="true" tabindex="-1"></a>     10.34.98.33   10.34.166.170: different subnets</span>
<span id="cb168-34"><a href="#cb168-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb168-35" d__=""><a href="#cb168-35" aria-hidden="true" tabindex="-1"></a>Routers and corresponding IPs:</span>
<span id="cb168-36" d__=""><a href="#cb168-36" aria-hidden="true" tabindex="-1"></a>     10.34.166.1: ['10.34.166.1', '10.34.166.170', '10.34.166.228', '10.34.166.26']</span>
<span id="cb168-37" d__=""><a href="#cb168-37" aria-hidden="true" tabindex="-1"></a>     10.34.194.1: ['10.34.194.188']</span>
<span id="cb168-38" d__=""><a href="#cb168-38" aria-hidden="true" tabindex="-1"></a>     10.34.209.1: ['10.34.209.189', '10.34.209.229', '10.34.209.6']</span>
<span id="cb168-39" d__=""><a href="#cb168-39" aria-hidden="true" tabindex="-1"></a>     10.34.250.1: ['10.34.250.213', '10.34.250.228', '10.34.250.234']</span>
<span id="cb168-40" d__=""><a href="#cb168-40" aria-hidden="true" tabindex="-1"></a>      10.34.46.1: ['10.34.46.125', '10.34.46.130', '10.34.46.142', '10.34.46.205', '10.34.46.25', '10.34.46.255', '10.34.46.73']</span>
<span id="cb168-41" d__=""><a href="#cb168-41" aria-hidden="true" tabindex="-1"></a>      10.34.52.1: ['10.34.52.118', '10.34.52.119', '10.34.52.158', '10.34.52.187', '10.34.52.23', '10.34.52.244', '10.34.52.60']</span>
<span id="cb168-42" d__=""><a href="#cb168-42" aria-hidden="true" tabindex="-1"></a>      10.34.53.1: ['10.34.53.190']</span>
<span id="cb168-43" d__=""><a href="#cb168-43" aria-hidden="true" tabindex="-1"></a>      10.34.79.1: ['10.34.79.122', '10.34.79.218', '10.34.79.58', '10.34.79.81', '10.34.79.99']</span>
<span id="cb168-44" d__=""><a href="#cb168-44" aria-hidden="true" tabindex="-1"></a>      10.34.91.1: ['10.34.91.120', '10.34.91.184', '10.34.91.205', '10.34.91.252', '10.34.91.55', '10.34.91.68', '10.34.91.97']</span>
<span id="cb168-45" d__=""><a href="#cb168-45" aria-hidden="true" tabindex="-1"></a>      10.34.98.1: ['10.34.98.184', '10.34.98.33']</span></code></pre></div>
<p d__="">If you’re getting different output, try to look through the 
code and see what functions are being used with the incorrect output. 
Then test those in more detail in the <code s__="13">my_tests()</code> function.</p>
<!--
New Rubric

5 points each, 100 points

ipv4_to_value(): returns single numeric integer type
value_to_ipv4(): returns correct string
get_subnet_mask_value(): uses bitwise operations to make mask
ipv4_to_value(): Successfully converts any IP address in dots-and-numbers format into a single value representing that IP packed into a 4-byte 32-bit integer.
value_to_ipv4(): Successfully converts a single value representing an IP packed into a 4-byte 32-bit integer into a string in dots-and-numbers format.
value_to_ipv4(): No leading zeros on any of the numbers in the string.
value_to_ipv4(): No padding--only digits and periods in the string.
get_subnet_mask_value(): Returns a single integer representing the subnet mask defined by the slash notation.
get_subnet_mask_value(): Handles both plain slash notation like "/16" and IP/slash notation like "198.51.100.12/22".
ips_same_subnet(): Returns True if both numbers are on the same subnet.
ips_same_subnet(): Uses get_subnet_mask_value() to get the subnet mask.
ips_same_subnet(): Uses ipv4_to_value() to get the values of the IP addresses.
ips_same_subnet(): Does the proper bitwise arithmetic to determine if the IP addresses are on the same subnet.
get_network(): Returns the network portion of the IP address as an integer.
get_network(): Uses the correct bitwise arithmetic to perform this computation.
find_router_for_ip(): Correctly finds the router that's on the same subnet as the given IP.
find_router_for_ip(): Returns the router IP as a dots-and-numbers strings
find_router_for_ip(): Returns None if no router is found on the same subnet as the given IP.
find_router_for_ip(): Calls ips_same_subnet() to make the determination.
No code below the do-not-modify line was modified.
-->
<!--
Fall 2022 Rubric

* `ipv4_to_value(ipv4_addr)`

10
ipv4_to_value(): Successfully converts any IP address in dots-and-numbers format into a single value representing that IP packed into a 4-byte 32-bit integer.

* `value_to_ipv4(addr)`

10
value_to_ipv4(): Successfully converts a single value representing an IP packed into a 4-byte 32-bit integer into a string in dots-and-numbers format.

1
value_to_ipv4(): No leading zeros on any of the numbers in the string.

1
value_to_ipv4(): No padding--only digits and periods in the string.

* `get_subnet_mask_value(slash)`

10
get_subnet_mask_value(): Returns a single integer representing the subnet mask defined by the slash notation.

5
get_subnet_mask_value(): Handles both plain slash notation like "/16" and IP/slash notation like "198.51.100.12/22".

* `ips_same_subnet(ip1, ip2, slash)`

10
ips_same_subnet(): Returns True if both numbers are on the same subnet.

5
ips_same_subnet(): Uses get_subnet_mask_value() to get the subnet mask.

5
ips_same_subnet(): Uses ipv4_to_value() to get the values of the IP addresses.

10
ips_same_subnet(): Does the proper bitwise arithmetic to determine if the IP addresses are on the same subnet.

* `get_network(ip_value, netmask)`

5
get_network(): Returns the network portion of the IP address as an integer.

5
get_network(): Uses the correct bitwise arithmetic to perform this computation.

* `find_router_for_ip(routers, ip)`

10
find_router_for_ip(): Correctly finds the router that's on the same subnet as the given IP.

3
find_router_for_ip(): Returns the router IP as a dots-and-numbers strings

3
find_router_for_ip(): Returns None if no router is found on the same subnet as the given IP.

5
find_router_for_ip(): Calls ips_same_subnet() to make the determination.

* Additional:

5
No code below the do-not-modify line was modified.

-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="20" id="the-link-layer-and-ethernet" d__=""><span class="header-section-number">20</span> The Link Layer and Ethernet</h1>
<p d__="">We’re getting down to the guts of the thing: The Link Layer.</p>
<!-- CAPTION: Internet Layered Network Model -->
<table>
<colgroup>
<col style="width: 60%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr>
<th style="text-align: center;" d__="">Layer</th>
<th d__="">Responsibility</th>
<th d__="">Example Protocols</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;" d__="">Application</td>
<td d__="">Structured application data</td>
<td d__="">HTTP, FTP, TFTP, Telnet, SSH, SMTP, POP, IMAP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Transport</td>
<td d__="">Data Integrity, packet splitting and reassembly</td>
<td d__="">TCP, UDP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Internet</td>
<td d__="">Routing</td>
<td d__="">IP, IPv6, ICMP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Link</td>
<td d__="">Physical, signals on wires</td>
<td d__="">Ethernet, PPP, token ring</td>
</tr>
</tbody>
</table>
<p d__="">The link layer is where all the action happens, where bytes turn into electricity.</p>
<p d__="">This is where Ethernet lives, as we’ll soon see.</p>
<h2 data-number="20.1" id="a-quick-note-on-octets" d__=""><span class="header-section-number">20.1</span> A Quick Note on Octets</h2>
<p d__="">We’ve been using “byte” as a word meaning 8 bits, but now it’s time to get more specific.</p>
<p d__="">Historically, see, a byte didn’t have to be 8 bits. (Famously,
 the C programming language doesn’t specify how many bits are in a byte,
 exactly.) And there’s nothing preventing computer designers from just 
making things up. It only so happens that basically every modern 
computer uses 8 bits for a byte.</p>
<p d__="">In order to be more precise, people sometimes use the word <em>octet</em> to represent 8 bits. It’s defined to be exactly 8 bits, period.</p>
<p d__="">When someone casually says (or writes) “byte”, they probably 
mean 8 bits. When someone says “octet” they most definitely mean exactly
 8 bits, end of story.</p>
<h2 data-number="20.2" id="frames-versus-packets" d__=""><span class="header-section-number">20.2</span> Frames versus Packets</h2>
<p d__="">When we get to the Link Layer, we’ve got a bit more 
terminology to get used to. Data sent out over Ethernet is a packet, but
 within that packet is a <em>frame</em>. It’s like a sub-packet.</p>
<p d__="">Conversationally, people use Ethernet “frame” and “packet” 
interchangeably. But as we’ll see later, there is a differentiation in 
the full ISO OSI layered network model.</p>
<p d__="">In the simplified Internet layered network model, the differentiation is not made, thus leading to the confusing terminology.</p>
<p d__="">More on this captivating tale later in this chapter.</p>
<h2 data-number="20.3" id="mac-addresses" d__=""><span class="header-section-number">20.3</span> MAC Addresses</h2>
<p d__="">Every network interface device has a MAC (Media Access 
Control) address. This is an address that’s unique on the LAN (local 
area network) that’s used for sending and receiving data.</p>
<p d__="">An Ethernet MAC address comes in the form of 6 hex bytes (12 
hex digits) separated by colons (or hyphens or periods). For example, 
these are all ways you might see a MAC address represented:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb169-1" d__=""><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>ac:d1:b8:df:20:85</span>
<span id="cb169-2" d__=""><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>ac-d1-b8-df-20-85</span>
<span id="cb169-3" d__=""><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>acd1.b8df.2085</span></code></pre></div>
<p d__="">MAC address must be unique on the LAN. The numbers are 
assigned at manufacturer and are not typically changed by the end user. 
(You’d only want to change them if you happened to get unlucky and buy 
two network cards that happened to have been assigned the same MAC 
address.)</p>
<p d__="">The first three bytes of an Ethernet MAC address are called the <em>OUI</em>
 (Organizationally Unique Identifier) that is assigned to a 
manufacturer. This leaves each manufacturer three bytes to uniquely 
represent the cards they make. (That’s 16,777,216 possible unique 
combinations. If a manufacturer runs out, they can always get another 
OUI–there are 16 million of those available, too!)</p>
<blockquote>
<p d__="">Funny Internet rumor: there was once a manufacturer of 
knockoffs of a network card called the NE2000, itself already known as a
 “bargain” network card. The knockoff manufacturer took the shortcut of 
burning the same MAC address into every card they made. This was 
discovered when a company bought a large number of them and found that 
only one computer would work at a time. Of course, in a home LAN where 
someone was only likely to have one of these cards, it wouldn’t be a 
problem–which is what the manufacturer was banking on. To add insult (or
 perhaps injury) to injury, there was no way to change the MAC address 
in the knockoff cards. The company was forced to discard them all.</p>
<p d__="">Except one, presumably.</p>
</blockquote>
<h2 data-number="20.4" id="were-all-in-the-same-room-typically" d__=""><span class="header-section-number">20.4</span> We’re All In The Same Room (Typically)</h2>
<p d__="">Lots of modern link layer protocols that you’ll be directly 
exposed to operate on the idea that they’re all broadcasting into a 
shared medium and listening for traffic that’s addressed to them.</p>
<p d__="">It’s like being in a room full of talkative people and someone
 shouts your name–you get the data that’s addressed to you and everyone 
else ignores it.</p>
<p d__="">This works in real life and in protocols like Ethernet. When 
you transmit a packet on an Ethernet network, everyone else on the same 
Ethernet LAN can see that traffic. It’s just that their network cards 
ignore the traffic unless it’s specifically addressed to them.</p>
<blockquote>
<p d__="">Asterisks: there are a couple handwavey things in that paragraph.</p>
<p d__="">One is that in a modern wired Ethernet, a device called a <em>switch</em>
 typically prevents packets from going out to nodes that they’re not 
supposed to. So the network isn’t really as loud as the crowded-room 
analogy suggests. Back before switches, we used things called <code s__="13">hubs</code>, which didn’t have the brains to discriminate between destinations. They’d broadcast all Ethernet packets to all destinations.</p>
</blockquote>
<p d__="">Not every link layer protocol works this way, however. The 
common goal of all of them is that we’re going to send and receive data 
at the wire level.</p>
<h2 data-number="20.5" id="multiple-access-method" d__=""><span class="header-section-number">20.5</span> Multiple Access Method</h2>
<p d__="">Ready for some more backstory?</p>
<p d__="">If everyone on the same Ethernet is in the same room yelling 
at other people, how does that actually work on the wire? How do 
multiple entities access a shared medium in a way that they don’t 
conflict?</p>
<blockquote>
<p d__="">When we’re talking “medium” here, we mean wires (if you’ve plugged your computer into the network) or radio (if you’re on WiFi).</p>
</blockquote>
<p d__="">The method particular link layer protocols use to allow multiple entities access the shared medium is called the <em>multiple access method</em>, or <em>channel access method</em>.</p>
<p d__="">There are <a href="https://en.wikipedia.org/wiki/Channel_access_method" d__="">a number of ways of doing this</a>. On the same medium:</p>
<ul>
<li d__="">You could transmit packets on different frequencies.</li>
<li d__="">You could send packets at different times, like timesharing.</li>
<li d__="">You could use spread spectrum or frequency hopping.</li>
<li d__="">You could split the network into different “cells”.</li>
<li d__="">You could add another wire to allow traffic to flow both directions at once.</li>
</ul>
<p d__="">Let’s again use Ethernet as an example. Ethernet is most like the “timesharing” mode, above.</p>
<p d__="">But that still leaves a lot of options open for exactly how we do <em>that</em>.</p>
<p d__="">Wired Ethernet uses something called <a href="https://en.wikipedia.org/wiki/Carrier-sense_multiple_access_with_collision_detection" d__="">CSMA/CD</a> (Carrier-Sense Multiple Access with Collision Detection). Easy for you to say.</p>
<p d__="">This method works like this:</p>
<ol type="1">
<li><p d__="">The Ethernet card waits for quiet in the room–when no other network card is transmitting. (This is the “CSMA” part of CSMA/CD.)</p></li>
<li><p d__="">It starts sending.</p></li>
<li><p d__="">It also listens while it’s sending.</p></li>
<li><p d__="">If it receives the same thing that it sent, all is well.</p>
<p d__="">If it doesn’t receive the same thing it sent, it means that 
another network device also started transmitting at the same time. This 
is a collision detection, the “CD” part of CSMA/CD.</p></li>
<li><p d__="">To resolve the situation, the network card transmits a 
special signal called the “jam signal” to alert other cards on the 
network that a collision has occurred and they should stop transmitting.
 The network card then waits a small, partly random amount of time, and 
then goes back to step 1 to retry the transmission.</p></li>
</ol>
<p d__="">WiFi (wireless) Ethernet uses something similar, except it’s <a href="https://en.wikipedia.org/wiki/Carrier-sense_multiple_access_with_collision_avoidance" d__="">CSMA/CA</a> (Carrier-Sense Multiple Access with Collision Avoidance). Also easy for you to say.</p>
<p d__="">This method works like this:</p>
<ol type="1">
<li><p d__="">The Ethernet card waits for quiet in the room–when no other network card is transmitting. (This is the “CSMA” part of CSMA/CA.)</p></li>
<li><p d__="">If the channel isn’t quiet, the network card waits a small, random amount of time, then goes back to step 1 to retry.</p></li>
</ol>
<p d__="">There are a few more details omitted there, but that’s the gist of it.</p>
<h2 data-number="20.6" id="ethernet" d__=""><span class="header-section-number">20.6</span> Ethernet</h2>
<p d__="">Remember with the layered network model how each layer <em>encapsulates</em> the previous layer’s data into its own header?</p>
<p d__="">For example, HTTP data (Application Layer) gets wrapped up in a
 TCP (Transport Layer) header. And then all of that gets wrapped up in 
an IP (Network Layer) header. And then <strong>all</strong> of that gets wrapped up in an Ethernet (Link Layer) frame.</p>
<p d__="">And recall that each protocol had its own header structure that helped it perform its job.</p>
<p d__="">Ethernet is no different. It’s going to encapsulate the data from the layer above it.</p>
<p d__="">Now, I want to get a little picky about terminology. The whole chunk of data that’s transmitted is the Ethernet <em>packet</em>. But within it is the Ethernet <em>frame</em>.
 As we’ll see later, these correspond to two layers of the ISO OSI 
layered network model (that have been condensed into a single “Link 
layer” in the Internet layered network model).</p>
<p d__="">Though I’ve written the frame “inside” the packet here, note that they are all transmitted as a single bitstream.</p>
<ul>
<li><strong d__="">The Packet:</strong>
<ul>
<li d__="">7 octets: Preamble (in hex: <code s__="13">AA AA AA AA AA AA AA</code>)</li>
<li d__="">1 octet: Start frame delimiter (in hex: <code s__="13">AB</code>)</li>
<li><strong d__="">The Frame:</strong>
<ul>
<li d__="">6 octets: Destination MAC address</li>
<li d__="">6 octets: Source MAC address</li>
<li d__="">4 octets: <a href="https://en.wikipedia.org/wiki/IEEE_802.1Q" d__="">“Dot1q” tag</a> for <a href="https://en.wikipedia.org/wiki/VLAN" d__="">virtual LAN</a> differentiation.</li>
<li d__="">2 octets: Payload Length/Ethertype (see below)</li>
<li d__="">46-1500 octets: Payload</li>
<li d__="">4 octets: <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check#CRC-32_algorithm" d__="">CRC-32 checksum</a></li>
</ul></li>
<li d__="">End of frame marker, loss of carrier signal</li>
<li d__="">Interpacket gap, enough time to transmit 12 octets</li>
</ul></li>
</ul>
<p d__="">The Payload Length/<a href="https://en.wikipedia.org/wiki/EtherType" d__="">EtherType</a>
 field is used for the payload length in normal usage. But other values 
can be put there that indicate an alternate payload structure.</p>
<p d__="">The largest payload that can be transmitted is 1500 octets. 
This is known as the MTU (Maximum Transmission Unit) of the network. 
Data that is larger must be fragmented down to this size.</p>
<blockquote>
<p d__="">Ethernet hardware can use this 1500 number to differentiate 
the Payload Length/EtherType header field. If it’s 1500 octets or fewer,
 it’s a length. Otherwise it’s an EtherType value.</p>
</blockquote>
<p d__="">After the frame, there’s an end-of-frame marker. This is 
indicated by loss of carrier signal on the wire, or by some explicit 
transmission in some versions of Ethernet.</p>
<p d__="">Lastly, there’s a time gap between Ethernet packets which corresponds to the amount of time it would take to transmit 12 octets.</p>
<h3 data-number="20.6.1" id="two-layers-of-ethernet" d__=""><span class="header-section-number">20.6.1</span> Two Layers of Ethernet?</h3>
<p d__="">If you recall, our simplified layer model is actually a crammed-down version of the full ISO OSI 7-Layer model:</p>
<!-- CAPTION: ISO OSI Network Layer Model -->
<table>
<colgroup>
<col style="width: 60%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr>
<th style="text-align: center;" d__="">ISO OSI Layer</th>
<th d__="">Responsibility</th>
<th d__="">Example Protocols</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;" d__="">Application</td>
<td d__="">Structured application data</td>
<td d__="">HTTP, FTP, TFTP, Telnet, SMTP, POP, IMAP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Presentation</td>
<td d__="">Encoding translation, encryption, compression</td>
<td d__="">MIME, SSL/TLS, XDR</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Session</td>
<td d__="">Suspending, terminating, restarting sessions between computers</td>
<td d__="">Sockets, TCP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Transport</td>
<td d__="">Data integrity, packet splitting and reassembly</td>
<td d__="">TCP, UDP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Network</td>
<td d__="">Routing</td>
<td d__="">IP IPv6, ICMP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Data link</td>
<td d__="">Encapsulation into frames</td>
<td d__="">Ethernet, PPP, SLIP</td>
</tr>
<tr>
<td style="text-align: center;" d__="">Physical</td>
<td d__="">Physical, signals on wires</td>
<td d__="">Ethernet physical layer, DSL, ISDN</td>
</tr>
</tbody>
</table>
<p d__="">What we call the Internet “Link Layer” is the “Data Link” layer <em>and</em> the “Physical” layer.</p>
<p d__="">The Data Link layer of Ethernet is the <em>frame</em>. It’s a subset of the entire <em>packet</em> (outlined above) which is defined at the Physical Layer.</p>
<p d__="">Another way to consider this is that the Data Link Layer is 
busy thinking about logical entities like who has what MAC address and 
what the payload checksum is. And that that Physical Layer is all about 
figuring out which patterns of signals to send that correspond to the 
start and end of the packet and frame, when to lower the carrier signal,
 and how long to delay between transmissions.</p>
<h2 data-number="20.7" id="reflect-12" d__=""><span class="header-section-number">20.7</span> Reflect</h2>
<ul>
<li><p d__="">What’s your MAC address on your computer? Do an Internet search to find how to look it up.</p></li>
<li><p d__="">What’s the deal with <em>frames</em> versus <em>packets</em> in Ethernet? Where in the ISO OSI network stack do they live?</p></li>
<li><p d__="">What’s the difference between a byte and an octet?</p></li>
<li><p d__="">What’s the main difference between CSMA/CD and CSMA/CA?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="21" id="arp-the-address-resolution-protocol" d__=""><span class="header-section-number">21</span> ARP: The Address Resolution Protocol</h1>
<p d__="">As a networked computer, we have a problem.</p>
<p d__="">We want to send data on the LAN to another computer on the same subnet.</p>
<p d__="">Here’s what we need to know in order to build an Ethernet frame:</p>
<ul>
<li d__="">The data we want to send and its length</li>
<li d__="">Our source MAC address</li>
<li d__="">Their destination MAC address</li>
</ul>
<p d__="">Here’s what we know:</p>
<ul>
<li d__="">The data we want to send and its length</li>
<li d__="">Our source MAC address</li>
<li d__="">Our source IP address</li>
<li d__="">Their destination IP address</li>
</ul>
<p d__="">What’s missing? Even though we know the other computer’s IP address, <em>we don’t know their MAC address</em>. How can we build an Ethernet frame without their MAC address? We can’t. We must get it somehow.</p>
<blockquote>
<p d__="">Again, for this section we’re talking about sending on the 
LAN, the local Ethernet. Not over the Internet with IP. This is between 
two computers on the same Physical Layer network.</p>
</blockquote>
<p d__="">This section is all about ARP, the Address Resolution 
Protocol. This is how one computer can map a different computer’s IP 
address to that computer’s MAC address.</p>
<h2 data-number="21.1" id="ethernet-broadcast-frames" d__=""><span class="header-section-number">21.1</span> Ethernet Broadcast Frames</h2>
<p d__="">We need some background first, though.</p>
<p d__="">Recall that network hardware listens for Ethernet frames that 
are addressed specifically to it. Ethernet frames for other MAC address 
destinations are ignored.</p>
<blockquote>
<p d__="">Side note: they are ignored unless the network card is placed into <a href="https://en.wikipedia.org/wiki/Promiscuous_mode"><em d__="">promiscuous mode</em></a>, in which case it receives <strong>all</strong> traffic on the LAN and forwards it to the OS.</p>
</blockquote>
<p d__="">But there’s a way to override: the <em>broadcast frame</em>. This is a frame that has a destination MAC address of <code s__="13">ff:ff:ff:ff:ff:ff</code>. All devices on the LAN will receive that frame.</p>
<p d__="">We’re going to make use of this with ARP.</p>
<h2 data-number="21.2" id="arpthe-address-resolution-protocol" d__=""><span class="header-section-number">21.2</span> ARP–The Address Resolution Protocol</h2>
<p d__="">So we have the destination’s IP address, but not its MAC address. We want its MAC address.</p>
<p d__="">Here’s what’s going to happen:</p>
<ol type="1">
<li><p d__="">The source computer will broadcast a specialized Ethernet frame that contains the destination IP address. This is the <em>ARP request</em>.</p>
<p d__="">(Remember the EtherType field from the previous chapter? ARP 
packets have EtherType 0x0806 to differentiate them from regular data 
Ethernet packets.)</p></li>
<li><p d__="">All computers on the LAN receive the ARP request and 
examine it. But only the computer with the IP address specified in the 
ARP request will continue. The other computers discard the packet.</p></li>
<li><p d__="">The destination computer with the specified IP address builds an <em>ARP response</em>. This Ethernet frame contains the destination computer’s MAC address.</p></li>
<li><p d__="">The destination computer sends the ARP response back to the source computer.</p></li>
<li><p d__="">The source computer receives the ARP response, and now it knows the destination computer’s MAC address.</p></li>
</ol>
<p d__="">And it’s game-on! Now that we know the MAC address, we can send with impunity.</p>
<h2 data-number="21.3" id="arp-caching" d__=""><span class="header-section-number">21.3</span> ARP Caching</h2>
<p d__="">Since it’s a pain to ask a computer for its MAC address every time we want to send it something, we’ll <em>cache</em> the result for a while.</p>
<p d__="">Then, when we want to send to a particular IP on the LAN, we can look in the <em>ARP cache</em>
 and see if the IP/Ethernet pair is already there. If so, no need to 
send out an ARP request–we can just transmit the data right away.</p>
<p d__="">The entries in the cache will timeout and be removed after a 
certain amount of time. There’s no standard time to expiration, but I’ve
 seen numbers from 60 seconds to 4 hours.</p>
<p d__="">Entries could go stale if the MAC address changes for a given 
IP address. Then the cache entry would be out of date. The easiest way 
for that to happen would be if someone closed their laptop and left the 
network (taking their MAC address with them), and then another person 
with a different laptop (and different MAC address) showed up and was 
assigned the same IP address. If that happened, computers with the stale
 entry would send the frames for that IP to the wrong (old) MAC address.</p>
<h2 data-number="21.4" id="arp-structure" d__=""><span class="header-section-number">21.4</span> ARP Structure</h2>
<p d__="">The ARP data goes in the payload portion of the Ethernet 
frame. It’s fixed length. As mentioned before, it’s identified by 
setting the EtherType/packet length field to 0x0806.</p>
<p d__="">In the payload structure below, when it says “Hardware” it 
means the Link Layer (e.g.&nbsp;Ethernet in this example) and when it 
says “Protocol” it means Network Layer (e.g.&nbsp;IP in this example). 
It uses those generalized names for the fields since there’s no 
requirement that ARP use Ethernet or IP–it can work with other 
protocols, too.</p>
<p d__="">The payload structure, with a total fixed length of 28 octets:</p>
<ul>
<li d__="">2 octets: Hardware Type (Ethernet is <code s__="13">0x0001</code>)</li>
<li d__="">2 octets: Protocol Type (IPv4 is <code s__="13">0x8000</code>)</li>
<li d__="">1 octet: Hardware address length in octets (Ethernet is <code s__="13">0x06</code>)</li>
<li d__="">1 octet: Protocol address length in octets (IPv4 is <code s__="13">0x04</code>)</li>
<li d__="">2 octets: Operation (<code s__="13">0x01</code> for request, <code s__="13">0x02</code> for reply)</li>
<li d__="">6 octets: Sender hardware address (Sender MAC address)</li>
<li d__="">4 octets: Sender protocol address (Sender IP address)</li>
<li d__="">6 octets: Target hardware address (Target MAC address)</li>
<li d__="">4 octets: Target protocol address (Target IP address)</li>
</ul>
<h2 data-number="21.5" id="arp-requestresponse" d__=""><span class="header-section-number">21.5</span> ARP Request/Response</h2>
<p d__="">This gets a little confusing, because the “Sender” fields are 
always set up from the point of view of the computer doing the 
transmitting, not from the point of view of who is the requester.</p>
<p d__="">So we’re going to declare that Computer 1 is the sending the ARP request, and Computer 2 is going to respond to it.</p>
<p d__="">In an ARP request from Computer 1 (“If you have this IP, 
what’s your MAC?”), the following fields are set up (in addition to the 
rest of the boilerplate ARP request fields mentioned above):</p>
<ul>
<li d__=""><strong>Sender hardware address</strong>: Computer 1’s MAC address</li>
<li d__=""><strong>Sender protocol address</strong>: Computer 1’s IP address</li>
<li d__=""><strong>Target hardware address</strong>: unused</li>
<li d__=""><strong>Target protocol address</strong>: the IP address Computer 1 is curious about</li>
</ul>
<p d__="">In an ARP response from Computer 2 (“I have that IP, and this is my MAC.”), the following fields are set up:</p>
<ul>
<li d__=""><strong>Sender hardware address</strong>: Computer 2’s MAC address</li>
<li d__=""><strong>Sender protocol address</strong>: Computer 2’s IP address</li>
<li d__=""><strong>Target hardware address</strong>: Computer 1’s MAC address</li>
<li d__=""><strong>Target protocol address</strong>: Computer 1’s IP address</li>
</ul>
<p d__="">When Computer 1 receives the ARP reply that names it as the 
target, it can look in the Sender fields and get the MAC address and its
 corresponding IP address.</p>
<p d__="">After that, Computer 1 is able to send Ethernet traffic to Computer 2’s now-known MAC address.</p>
<p d__="">And that is how MAC addresses are discovered for a particular IP address!</p>
<h2 data-number="21.6" id="other-arp-features" d__=""><span class="header-section-number">21.6</span> Other ARP Features</h2>
<h3 data-number="21.6.1" id="arp-announcements" d__=""><span class="header-section-number">21.6.1</span> ARP Announcements</h3>
<p d__="">It’s not uncommon for computers that have just come online to 
announce their ARP information unsolicited. This gives everyone else a 
chance to add the data to their caches, and it overwrites potentially 
stale data in those caches.</p>
<h3 data-number="21.6.2" id="arp-probe" d__=""><span class="header-section-number">21.6.2</span> ARP Probe</h3>
<p d__="">A computer can send out a specially-constructed ARP request that basically asks, “Is anyone else using this IP address?”</p>
<p d__="">Typically it asks using its own IP address; if it gets a response, it knows it has an IP conflict.</p>
<h2 data-number="21.7" id="ipv6-and-arp" d__=""><span class="header-section-number">21.7</span> IPv6 and ARP</h2>
<p d__="">IPv6 has its own version of ARP called <a href="https://en.wikipedia.org/wiki/Neighbor_Discovery_Protocol" d__="">NDP</a> (the Neighbor Discovery Protocol).</p>
<p d__="">The eagle-eyed among you might have noticed that ARP only 
supports protocol addresses (e.g.&nbsp;IP addresses) of up to 4 bytes, 
and IPv6 addresses are 16 bytes.</p>
<p d__="">NDP addresses this issue and more, defining a number of <a href="https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol_for_IPv6" d__="">ICMPv6</a> (Internet Message Control Protocol for IPv6) that can be used to take the place of ARP, among other things.</p>
<h2 data-number="21.8" id="reflect-13" d__=""><span class="header-section-number">21.8</span> Reflect</h2>
<ul>
<li><p d__="">Describe the problem ARP is solving.</p></li>
<li><p d__="">Why do entries in ARP caches have to expire?</p></li>
<li><p d__="">Why can’t IPv6 use ARP?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="22" id="project-6-routing-with-dijkstras" d__=""><span class="header-section-number">22</span> Project 6: Routing with Dijkstra’s</h1>
<p d__="">Internal Gateway Protocols share information with one another 
such that every router has a complete make of the network they’re a part
 of. This way, each router can make autonomous routing decisions given 
an IP address. No matter where it’s going, the router can always forward
 the packet in the right direction.</p>
<p d__="">IGPs like Open Shortest Path First (OSPF) use Dijkstra’s Algorithm to find the shortest path along a weighted graph.</p>
<p d__="">In this project, we’re going to simulate that routing. Were 
going to implement Dijkstra’s Algorithm to print out the shortest path 
from one IP to another IP, showing the IPs of all the routers in 
between.</p>
<p d__="">We won’t be using a real network for this. Rather, your 
program will read in a JSON file that contains the network description 
and then compute the route from that.</p>
<h2 data-number="22.1" id="banned-functions-1" d__=""><span class="header-section-number">22.1</span> Banned Functions</h2>
<p d__="">You’re going to implement Dijkstra’s yourself. No credit for using an existing library!</p>
<h2 data-number="22.2" id="graphs-refresher" d__=""><span class="header-section-number">22.2</span> Graphs Refresher</h2>
<p d__="">Graphs are made of <em>vertices</em> and <em>edges</em>. Sometimes vertices are called “vertexes” or “verts” or “nodes”. Edges are connections from one node to another.</p>
<p d__="">Any node on the graph can be connected to any number of other 
nodes, even zero. A node can be connected to every single other node. It
 could even connect to itself.</p>
<p d__="">An edge can have a <em>weight</em> which generally means the cost of traversing that edge when you’re walking a path through the graph.</p>
<p d__="">For example, imagine a highway map that shows cities and 
highways between the cities. And each highway is labeled with its 
length. In this example, the cities would be vertices, the highways 
would be edges, and the highway length would be the edge weight.</p>
<p d__="">When traversing a graph, the goal is to minimize the total of 
all the edge weights that you encounter along the way. On our map, the 
goal would be to choose edges from our starting city through all the 
intermediate cities to our destination city that had us driving the 
minimum total distance.</p>
<h2 data-number="22.3" id="dijkstras-algorithm-overview" d__=""><span class="header-section-number">22.3</span> Dijkstra’s Algorithm Overview</h2>
<p d__="">Edsger Dijkstra (<em>DIKE-struh</em>) was a famous computer 
scientist who came up with a lot of things, but one of them was so 
influential it came to be known by only his name: Dijkstra’s Algorithm.</p>
<blockquote>
<p d__="">Protip: The secret to spelling “Dijkstra” is remembering that “ijk” appears in order.</p>
</blockquote>
<p d__="">If you want to find the shortest path between nodes in an 
unweighted graph, you merely need to perform a breadth-first traversal 
until you find what you’re looking for. Distances are only measured in 
“hops”.</p>
<p d__="">But if you add weights to the edges between the nodes, BFT 
can’t help you differentiate them. Maybe some paths are very desirable, 
and others are very undesirable.</p>
<p d__="">Dijkstra’s <em>can</em> differentiate. It’s a BFT with a twist.</p>
<p d__="">The gist of the algorithm is this: explore outward from the 
starting point, pursuing only the path with the shortest total length so
 far.</p>
<p d__="">Each path’s total weight is the sum of the weights of all its edges.</p>
<p d__="">In a well-connected graph, there will be a <em>lot</em> of 
potential paths from the start to the destination. But since we only 
pursue the shortest known path so far, we’ll never pursue one that takes
 us a million miles out of the way, assuming we know of a path that is 
shorter than a million miles.</p>
<h2 data-number="22.4" id="dijkstras-implementation" d__=""><span class="header-section-number">22.4</span> Dijkstra’s Implementation</h2>
<p d__="">Dijkstra’s builds a tree structure on top of a graph. When you
 find the shortest path from any node back toward the start, that node 
records the prior node in its path as its <em>parent</em>.</p>
<p d__="">If another shorter path comes to be found later, the parent is switched to the new shorter path’s node.</p>
<p d__=""><a href="https://en.wikipedia.org/wiki/Dijkstra's_algorithm" d__="">Wikipedia has some great diagrams that show it in action</a><a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup s__="13" d__="">11</sup></a>.</p>
<p d__="">Now how do make it work?</p>
<p d__="">Dijkstra’s itself only builds the tree representing the 
shortest paths back to the start. We’ll follow that shortest path tree 
later to find a particular path.</p>
<ul>
<li d__="">Dijkstra’s Algorithm to compute all shortest paths over a graph from a source point:
<ul>
<li>Initialization:
<ul>
<li>Create an empty <code s__="13">to_visit</code> set. This is the set of all nodes we still need to visit.</li>
<li>Create a <code s__="13">distance</code> dictionary. For any given node (as a key), it will hold the distance from that node to the starting node</li>
<li>Create a <code s__="13">parent</code> dictionary. For any given node
 (as a key), it lists the key for the node that leads back to the 
starting node (along the shortest path).</li>
<li>For every node:
<ul>
<li>Set its <code s__="13">parent</code> to <code s__="13">None</code>.</li>
<li>Set its <code s__="13">distance</code> to infinity. (Python has infinity in <code s__="13">math.inf</code>, but you could also use just a very large number, e.g.&nbsp;4 billion.)</li>
<li>Add the node to the <code s__="13">to_visit</code> set.</li>
</ul></li>
<li>Set the distance to the starting node to <code s__="13">0</code>.</li>
</ul></li>
<li>Running:
<ul>
<li>While <code s__="13">to_visit</code> isn’t empty:
<ul>
<li>Find the node in <code s__="13">to_visit</code> with the smallest <code s__="13">distance</code>. Call this the “current node”.</li>
<li>Remove the current node from the <code s__="13">to_visit</code> set.</li>
<li>For each one of the current node’s neighbors still in <code s__="13">to_visit</code>:
<ul>
<li>Compute the distance from the starting node to the neighbor. This is
 the distance of the current node plus the edge weight to the neighbor.</li>
<li>If the computed distance is less than the neighbor’s current value in <code s__="13">distance</code>:
<ul>
<li>Set the neighbor’s value in <code s__="13">distance</code> to the computed distance.</li>
<li>Set the neighbor’s <code s__="13">parent</code> to the current node.</li>
</ul></li>
<li>[This process is called “relaxing”. The node distances start at infinity and “relax” down to their shortest distances.]</li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<p d__="">Wikipedia offers this pseudocode, if that’s easier to digest:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb170-1" d__=""><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a> <span class="dv" d__="">1</span>  function Dijkstra(Graph, source):</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a> <span class="dv" d__="">2</span></span>
<span id="cb170-3" d__=""><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a> <span class="dv" d__="">3</span>      <span class="cf" d__="">for</span> each vertex v <span class="kw" d__="">in</span> Graph.Vertices:</span>
<span id="cb170-4" d__=""><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a> <span class="dv" d__="">4</span>          dist[v] ← INFINITY</span>
<span id="cb170-5" d__=""><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a> <span class="dv" d__="">5</span>          prev[v] ← UNDEFINED</span>
<span id="cb170-6" d__=""><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a> <span class="dv" d__="">6</span>          add v to Q</span>
<span id="cb170-7" d__=""><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a> <span class="dv" d__="">7</span>      dist[source] ← <span class="dv" d__="">0</span></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a> <span class="dv" d__="">8</span></span>
<span id="cb170-9" d__=""><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a> <span class="dv" d__="">9</span>      <span class="cf" d__="">while</span> Q <span class="kw" d__="">is</span> <span class="kw" d__="">not</span> empty:</span>
<span id="cb170-10" d__=""><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">10</span>          u ← vertex <span class="kw" d__="">in</span> Q <span class="cf" d__="">with</span> <span class="bu" d__="">min</span> dist[u]</span>
<span id="cb170-11" d__=""><a href="#cb170-11" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">11</span>          remove u <span class="im" d__="">from</span> Q</span>
<span id="cb170-12"><a href="#cb170-12" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">12</span></span>
<span id="cb170-13" d__=""><a href="#cb170-13" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">13</span>          <span class="cf" d__="">for</span> each neighbor v of u still <span class="kw" d__="">in</span> Q:</span>
<span id="cb170-14" d__=""><a href="#cb170-14" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">14</span>              alt ← dist[u] <span class="op" d__="">+</span> Graph.Edges(u, v)</span>
<span id="cb170-15" d__=""><a href="#cb170-15" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">15</span>              <span class="cf" d__="">if</span> alt <span class="op" d__="">&lt;</span> dist[v]:</span>
<span id="cb170-16" d__=""><a href="#cb170-16" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">16</span>                  dist[v] ← alt</span>
<span id="cb170-17" d__=""><a href="#cb170-17" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">17</span>                  prev[v] ← u</span>
<span id="cb170-18"><a href="#cb170-18" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">18</span></span>
<span id="cb170-19" d__=""><a href="#cb170-19" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">19</span>      <span class="cf" d__="">return</span> dist[], prev[]</span></code></pre></div>
<p d__="">At this point, we have constructed our tree made up of all the <code s__="13">parent</code> pointers.</p>
<p d__="">To find the shortest path from one point back to the start (at the root of the tree), you need to just follow the <code s__="13">parent</code> pointers from that point back up the tree.</p>
<ul>
<li d__="">Get Shortest Path from source to destination:
<ul>
<li>Set our current node to the <strong>destination</strong> node.</li>
<li>Set our <code s__="13">path</code> to be an empty array.</li>
<li>While current node is not starting node:
<ul>
<li>Append current node to <code s__="13">path</code>.</li>
<li>current node = the <code s__="13">parent</code> of current node</li>
</ul></li>
<li>Append the starting node to the path.</li>
</ul></li>
</ul>
<p d__="">Of course, this will build the path in reverse order. It has 
to, since the parent pointers all point back to the starting node at the
 root of the tree. Either reverse it at the end, or run the main 
Dijkstra’s algorithm passing the destination in for the source.</p>
<h3 data-number="22.4.1" id="getting-the-minimum-distance" d__=""><span class="header-section-number">22.4.1</span> Getting the Minimum Distance</h3>
<p d__="">Part of the algorithm is to find the node with the minimum <code s__="13">distance</code> that is still in the <code s__="13">to_visit</code> set.</p>
<p d__="">For this project, you can just do a <code s__="13">O(n)</code> linear search to find the node with the shortest distance so far.</p>
<p d__="">In real life, this is too expensive–<code s__="13">O(n²)</code> performance over the number of vertices. So implementations will use a <a href="https://en.wikipedia.org/wiki/Binary_heap" d__="">min heap</a> which will effectively get us the minimum in far-superior <code s__="13">O(log n)</code> time. This gets us to <code s__="13">O(n log n)</code> over the number of verts.</p>
<p d__="">If you wish the additional challenge, use a min heap.</p>
<h2 data-number="22.5" id="what-about-our-project" d__=""><span class="header-section-number">22.5</span> What About Our Project?</h2>
<p d__="">[<em>All IP addresses in this project are IPv4 addresses.</em>]</p>
<p d__=""><a href="https://beej.us/guide/bgnet0/source/exercises/dijkstra/dijkstra.zip" d__="">Download the skeleton code ZIP here</a><a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup s__="13" d__="">12</sup></a>.</p>
<p d__="">OK, so that was a lot of general stuff.</p>
<p d__="">So what does that correspond to in the project?</p>
<h3 data-number="22.5.1" id="the-function-inputs-and-outputs" d__=""><span class="header-section-number">22.5.1</span> The Function, Inputs, and Outputs</h3>
<p d__="">You have to implement this function:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb171-1" d__=""><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">def</span> dijkstras_shortest_path(routers, src_ip, dest_ip):</span></code></pre></div>
<p d__="">The function inputs are:</p>
<ul>
<li d__=""><code s__="13">routers</code>: A dictionary representing the graph.</li>
<li d__=""><code s__="13">src_ip</code>: A source IP address as a dots-and-numbers string.</li>
<li d__=""><code s__="13">dest_ip</code>: A destination IP address as a dots-and-numbers string.</li>
</ul>
<p d__="">The function output is:</p>
<ul>
<li d__="">An array of strings showing all the router IP addresses along the route.
<ul>
<li><strong>Note: If the source IP and destination IP are on the same subnet as one another, return an empty array.</strong> No routers would be involved in this case.</li>
</ul></li>
</ul>
<p d__="">Code to drive your function is already included in the 
skeleton code above. It will output to the console lines like this 
showing the source, destination, and all routers in between:</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb172-1" d__=""><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>10.34.46.25 -&gt; 10.34.166.228    ['10.34.46.1', '10.34.98.1', '10.34.166.1']</span></code></pre></div>
<h3 data-number="22.5.2" id="the-graph-representation" d__=""><span class="header-section-number">22.5.2</span> The Graph Representation</h3>
<p d__="">The graph dictionary in <code s__="13">routers</code> looks like this excerpt:</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode json"><code class="sourceCode json" s__="13"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">{</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">"10.34.98.1"</span><span class="fu" d__="">:</span> <span class="fu" d__="">{</span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt" d__="">"connections"</span><span class="fu" d__="">:</span> <span class="fu" d__="">{</span></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>            <span class="dt" d__="">"10.34.166.1"</span><span class="fu" d__="">:</span> <span class="fu" d__="">{</span></span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>                <span class="dt" d__="">"netmask"</span><span class="fu" d__="">:</span> <span class="st" d__="">"/24"</span><span class="fu" d__="">,</span></span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>                <span class="dt" d__="">"interface"</span><span class="fu" d__="">:</span> <span class="st" d__="">"en0"</span><span class="fu" d__="">,</span></span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>                <span class="dt" d__="">"ad"</span><span class="fu" d__="">:</span> <span class="dv" d__="">70</span></span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu" d__="">},</span></span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt" d__="">"10.34.194.1"</span><span class="fu" d__="">:</span> <span class="fu" d__="">{</span></span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>                <span class="dt" d__="">"netmask"</span><span class="fu" d__="">:</span> <span class="st" d__="">"/24"</span><span class="fu" d__="">,</span></span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>                <span class="dt" d__="">"interface"</span><span class="fu" d__="">:</span> <span class="st" d__="">"en1"</span><span class="fu" d__="">,</span></span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>                <span class="dt" d__="">"ad"</span><span class="fu" d__="">:</span> <span class="dv" d__="">93</span></span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu" d__="">},</span></span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>            <span class="dt" d__="">"10.34.46.1"</span><span class="fu" d__="">:</span> <span class="fu" d__="">{</span></span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>                <span class="dt" d__="">"netmask"</span><span class="fu" d__="">:</span> <span class="st" d__="">"/24"</span><span class="fu" d__="">,</span></span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>                <span class="dt" d__="">"interface"</span><span class="fu" d__="">:</span> <span class="st" d__="">"en2"</span><span class="fu" d__="">,</span></span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>                <span class="dt" d__="">"ad"</span><span class="fu" d__="">:</span> <span class="dv" d__="">64</span></span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu" d__="">}</span></span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu" d__="">},</span></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a>        <span class="dt" d__="">"netmask"</span><span class="fu" d__="">:</span> <span class="st" d__="">"/24"</span><span class="fu" d__="">,</span></span>
<span id="cb173-21"><a href="#cb173-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt" d__="">"if_count"</span><span class="fu" d__="">:</span> <span class="dv" d__="">3</span><span class="fu" d__="">,</span></span>
<span id="cb173-22"><a href="#cb173-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt" d__="">"if_prefix"</span><span class="fu" d__="">:</span> <span class="st" d__="">"en"</span></span>
<span id="cb173-23"><a href="#cb173-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu" d__="">},</span></span>
<span id="cb173-24"><a href="#cb173-24" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb173-25"><a href="#cb173-25" aria-hidden="true" tabindex="-1"></a>    <span class="er" d__="">#</span> <span class="er" d__="">...</span> <span class="er" d__="">etc.</span> <span class="er" d__="">...</span></span></code></pre></div>
<p d__="">The top-level keys (e.g.&nbsp;<code s__="13">"10.34.98.1"</code>) are the router IPs. These are the vertices of the graph.</p>
<p d__="">For each of those, you have a list of <code s__="13">"connections"</code> which are the edges of the graph.</p>
<p d__="">In each connection, you have a field <code s__="13">"ad"</code> which is the edge weight.</p>
<blockquote>
<p d__="">“AD” is short for <em>Administrative Distance</em>. This is a 
weight set manually or automatically (or a mix of both) that defines how
 expensive a particular segment of the route is. The default value is 
110. Higher numbers are more expensive.</p>
<p d__="">The metric encompasses a number of ideas about the route, 
including how much bandwidth it provides, how congested it is, how much 
the administrators want it used (or not), and so on.</p>
</blockquote>
<p d__="">The netmask for the router IP is in the <code s__="13">"netmask"</code> field, and there are additional <code s__="13">"netmask"</code> fields for all the connection routers, as well.</p>
<p d__="">The <code s__="13">"interface"</code> says which network device on the router is used to reach a neighboring router. It is unused in this project.</p>
<p d__=""><code s__="13">"if_count"</code> and <code s__="13">"if_prefix"</code> are also unused in this project.</p>
<h2 data-number="22.6" id="input-file-and-example-output" d__=""><span class="header-section-number">22.6</span> Input File and Example Output</h2>
<p d__="">The skeleton archive includes an example input file (<code s__="13">example1.json</code>) and expected output for that file (<code s__="13">example1_output.json</code>).</p>
<h2 data-number="22.7" id="hints" d__=""><span class="header-section-number">22.7</span> Hints</h2>
<ul>
<li d__="">Rely heavily on the network functions you wrote in the previous project!</li>
<li d__="">Fully understand this project description before coming up with a plan!</li>
<li d__="">Come up with a plan as much as possible before writing any code!</li>
</ul>
<!--
Rubric:

12
Starting router IP is correctly determined from source IP address.

12
Ending router IP is correctly determined from destination IP address.

8
Shortest path array does not include start IP

8
Shortest path array does not include end IP

20
Shortest path array includes all router IPs from source to destination in order source-to-destination.

20
Shortest path array contains the actual shortest path.

12
Empty shortest path is returned when source and destination are on the same subnet.

5
Code requested to be unmodified is unmodified
-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="23" id="project-sniff-arp-packets-with-wireshark" d__=""><span class="header-section-number">23</span> Project: Sniff ARP packets with WireShark</h1>
<p d__="">We’re going to take a look at some live network traffic with <a href="https://www.wireshark.org/" d__="">WireShark</a><a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup s__="13" d__="">13</sup></a> and see if we can capture some ARP requests and replies.</p>
<p d__="">Wireshark is a great tool for <em>sniffing</em> network packets. It gives you a way to trace packets as that move across the LAN.</p>
<p d__="">We’ll set up a filter in WireShark so that we’re only looking 
for ARP packets to and from our specific machines so we don’t have to 
search for a needle in a haystack.</p>
<h2 data-number="23.1" id="what-to-create" d__=""><span class="header-section-number">23.1</span> What to Create</h2>
<p d__="">A document that contains 4 things:</p>
<ol type="1">
<li><p d__="">Your MAC address of your currently active connection.</p></li>
<li><p d__="">Your IP address of your currently active connection.</p></li>
<li><p d__="">A human-readable WireShark packet capture of an ARP request.</p></li>
<li><p d__="">A human-readable WireShark packet capture of an ARP reply.</p></li>
</ol>
<p d__="">Details below!</p>
<h2 data-number="23.2" id="step-by-step" d__=""><span class="header-section-number">23.2</span> Step by Step</h2>
<p d__="">Here’s what we’ll do:</p>
<ol type="1">
<li><p><strong d__="">Look Up Your Ethernet (MAC) Address</strong></p>
<p d__="">Your computer might have multiple Ethernet interfaces (e.g.&nbsp;one for WiFi and one for wired–the Ethernet jack on the side).</p>
<p d__="">Since you’re almost certainly using wireless right now, look 
up the MAC address for your wireless interface. (You might have to 
search online for how to do this.)</p>
<p d__="">For both this step and step 2, below, the information can be found with this command on Unix-likes:</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="ex" d__="">ifconfig</span></span></code></pre></div>
<p d__="">and this command on Windows:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="ex" d__="">ipconfig</span></span></code></pre></div></li>
<li><p><strong d__="">Look Up Your IP Address</strong></p>
<p d__="">Again, we want the IP address of your active network interface, probably your WiFi device.</p></li>
<li><p><strong d__="">Launch WireShark</strong></p>
<p d__="">On initial launch, set up WireShark to look at your active Ethernet device. On Linux, this might be <code s__="13">wlan0</code>. On Mac, it could be <code s__="13">en0</code>. On Windows, it’s likely just <code s__="13">Wi-Fi</code>.</p>
<p d__="">Set up a display filter in WireShark to filter ARP packets 
that are only either to or from your machine. Type this in the bar near 
the top of the window, just under the blue sharkfin button.</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb176-1" d__=""><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>arp and eth.addr==[your MAC address]</span></code></pre></div>
<p d__="">Don’t forget to hit <code s__="13">RETURN</code> after typing in the filter.</p>
<p d__="">Start capturing by hitting the blue sharkfin button.</p></li>
<li><p><strong d__="">Find more IPs on your subnet</strong></p>
<p d__="">For this section it doesn’t matter if there’s actually a 
computer at the remote IP, but it’s nice if there is. Watch the 
Wireshark log for a while to see what other IPs are active on your LAN.</p>
<blockquote>
<p d__="">Your IP ANDed with the subnet mask is your subnet number. Try 
putting various numbers for the host portion. Try your default gateway 
(search the Internet for how to find your default gateway in your OS.)</p>
</blockquote>
<p d__="">On the command line, <code s__="13">ping</code> another IP on your LAN:</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb177-1" d__=""><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">ping</span> [IP address]</span></code></pre></div>
<p d__="">(Hit <code s__="13">CONTROL-C</code> to break out of ping.)</p>
<p d__="">On the first ping, did you see any ARP packets go by in Wireshark? If not, try other IP addresses on the subnet, as noted above.</p>
<p d__="">No matter how many pings you send, you should only see one ARP
 reply. (You’ll see one request per ping if there are no replies!) This 
is because after the first reply, your computer caches the ARP reply and
 no longer needs to send them out!</p>
<p d__="">After a minute or five, your computer should expire that ARP 
cache entry and you’ll see another ARP exchange if you ping that IP 
again.</p></li>
<li><p><strong d__="">Write Down the Request and Reply</strong></p>
<p d__="">In the timeline, the ARP request will look something like this excerpt (with different IP addresses, obviously):</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb178-1" d__=""><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>ARP 60 Who has 192.168.1.230? Tell 192.168.1.1</span></code></pre></div>
<p d__="">And if all goes well, you’ll have a reply that looks like this:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb179-1" d__=""><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>ARP 42 192.168.1.230 is at ac:d1:b8:df:20:85</span></code></pre></div>
<p d__="">[If you’re not seeing anything, try changing your display 
filter to just say “arp”. Watch for a while and see if you see a 
request/reply pair go by.]</p>
<p d__="">Click on the request and look at the details in the lower left panel. Expand the “Address Resolution Protocol (request)” panel.</p>
<p d__="">Right click any line in that panel and select “Copy-&gt;All Visible Items”.</p>
<p d__="">Here’s an example request (truncated for line length):</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb180-1" d__=""><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>Frame 221567: 42 bytes on wire (336 bits), 42 bytes captured  [...]</span>
<span id="cb180-2" d__=""><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>Ethernet II, Src: HonHaiPr_df:20:85 (ac:d1:b8:df:20:85), Dst: [...]</span>
<span id="cb180-3" d__=""><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>Address Resolution Protocol (request)</span>
<span id="cb180-4" d__=""><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>    Hardware type: Ethernet (1)</span>
<span id="cb180-5" d__=""><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>    Protocol type: IPv4 (0x0800)</span>
<span id="cb180-6" d__=""><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>    Hardware size: 6</span>
<span id="cb180-7" d__=""><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>    Protocol size: 4</span>
<span id="cb180-8" d__=""><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a>    Opcode: request (1)</span>
<span id="cb180-9" d__=""><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>    Sender MAC address: HonHaiPr_df:20:85 (ac:d1:b8:df:20:85)</span>
<span id="cb180-10" d__=""><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>    Sender IP address: 192.168.1.230</span>
<span id="cb180-11" d__=""><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>    Target MAC address: 00:00:00_00:00:00 (00:00:00:00:00:00)</span>
<span id="cb180-12" d__=""><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a>    Target IP address: 192.168.1.148</span></code></pre></div>
<p d__="">Click on the reply in the timeline. Copy the reply information in the same way.</p>
<p d__="">Here’s an example reply (truncated for line length):</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb181-1" d__=""><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>Frame 221572: 42 bytes on wire (336 bits), 42 bytes captured  [...]</span>
<span id="cb181-2" d__=""><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>Ethernet II, Src: Apple_63:3c:ef (8c:85:90:63:3c:ef), Dst:    [...]</span>
<span id="cb181-3" d__=""><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>Address Resolution Protocol (reply)</span>
<span id="cb181-4" d__=""><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>    Hardware type: Ethernet (1)</span>
<span id="cb181-5" d__=""><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>    Protocol type: IPv4 (0x0800)</span>
<span id="cb181-6" d__=""><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>    Hardware size: 6</span>
<span id="cb181-7" d__=""><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a>    Protocol size: 4</span>
<span id="cb181-8" d__=""><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a>    Opcode: reply (2)</span>
<span id="cb181-9" d__=""><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a>    Sender MAC address: Apple_63:3c:ef (8c:85:90:63:3c:ef)</span>
<span id="cb181-10" d__=""><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>    Sender IP address: 192.168.1.148</span>
<span id="cb181-11" d__=""><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>    Target MAC address: HonHaiPr_df:20:85 (ac:d1:b8:df:20:85)</span>
<span id="cb181-12" d__=""><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a>    Target IP address: 192.168.1.230</span></code></pre></div></li>
</ol>
<!--

Rubric

10
Submission includes your MAC address of your currently active connection.

10
Submission includes your IP address of your currently active connection.

20
Submission includes a human-readable WireShark packet capture of an ARP request.

20
Submission includes a human-readable WireShark packet capture of an ARP reply.

-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="24" id="network-hardware" d__=""><span class="header-section-number">24</span> Network Hardware</h1>
<p d__="">In this chapter we’ll take a look at a number of hardware networking components.</p>
<p d__="">Some of these you have at home or on your computer already.</p>
<h2 data-number="24.1" id="terminology-and-components" d__=""><span class="header-section-number">24.1</span> Terminology and Components</h2>
<ul>
<li><p d__=""><strong>Network Topology</strong>: describes the layout of
 a network, how devices and nodes are connected, and how data flows from
 one part of the network to another.</p></li>
<li><p d__=""><strong>Mbs</strong>: Megabits per second (compare to “MBs”, megabytes per second).</p></li>
<li><p d__=""><strong>Gbs</strong>: Gigabits per second, 1000 Mbs (compare to “GBs”, gigabytes per second).</p></li>
<li><p d__=""><strong>Bandwidth</strong>: Measured in bits per second, how much data a certain type of cable can carry over a certain amount of time. e.g.&nbsp;500 Mbs.</p></li>
<li><p d__=""><strong>ISP</strong>: Internet Service Provider, the 
company that you pay for your Internet connection. (Or that provides it,
 even if you aren’t paying!)</p></li>
<li><p d__=""><strong>Twisted Pair Cable</strong>: What people typically
 think of as “Ethernet cable”. It’s a cable with plug-in jacks on either
 end. Internally, pairs of wires are twisted together to reduce 
interference. These cables have published maximum length “runs” that 
determine how far you can string a cable before you run into trouble, 
usually 50-100 meters depending on the cable and traffic speed.</p>
<ul>
<li d__=""><strong>10baseT</strong>: 10 Mbs twisted-pair for Ethernet</li>
<li d__=""><strong>100baseTX</strong>: 100 Mbs twisted-pair for <em>Fast Ethernet</em>.</li>
<li d__=""><strong>1000baseT</strong>: 1 Gbs twisted-pair for <em>Gigabit Ethernet</em>.</li>
<li d__=""><strong>10GbaseT</strong>: 10 Gbs twisted-pair for <em>10 Gigabit Ethernet</em>.</li>
<li d__=""><strong>Category-5</strong>: Called <em>cat-5</em> for short, a twisted pair wire built to category-5 specs. Good for Fast Ethernet.</li>
<li d__=""><strong>Category-6</strong>: Called <em>cat-6</em> for short, a twisted pair wire built to category-6 specs. Good for Gigabit Ethernet.</li>
</ul></li>
<li><p d__=""><strong>Network Port</strong>: Not to be confused with TCP
 or UDP port numbers, which are completely different, in this context 
refers to a physical socket on a device where you can plug in a network 
cable.</p></li>
<li><p d__=""><strong>Ethernet Cable</strong>: Conversational term meaning a twisted pair cable that you plug into Ethernet devices.</p></li>
<li><p d__=""><strong>Crossover Cable</strong>: Cable where the transmit
 and receive pins are swapped on one end of the cable. This is typically
 used when connecting two devices directly to each other when normally a
 switch or hub would be used as an intermediary. If you’re plugging one 
computer directly into another with an Ethernet cable, it should 
probably be a crossover cable. Opposite of <em>straight-through</em> cable.</p></li>
<li><p d__=""><strong>Auto-sensing</strong>: A network port that can 
tell if it has a straight-through or cross-over cable plugged into it, 
and can reverse the transmit and receive signals if it has to.</p></li>
<li><p d__=""><strong>Thin-net/Thick-net</strong>: Obsolete coaxial cabling used for Ethernet.</p></li>
<li><p d__=""><strong>LAN</strong>: Local Area Network. For Ethernet, this would be the network at your house. Think of a single IP subnet.</p></li>
<li><p d__=""><strong>WAN</strong>: Wide Area Network. Network that’s not LAN. Think of a collection of LANs on University of company campus.</p></li>
<li><p d__=""><strong>Dynamic IP</strong>: This is when your IP gets set automatically with <a href="https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol" d__="">DHCP</a>, for example. Your IP address might change over time.</p></li>
<li><p d__=""><strong>Static IP</strong>: This is when you hardcode the 
IP address for a certain device. The IP address doesn’t change until you
 actively enter a new one.</p></li>
<li><p d__=""><strong>Network Interface Controller (NIC)</strong>, <strong>Network Interface Card</strong>, <strong>Network Adapter</strong>, <strong>LAN Adapter</strong>, <strong>Network Card</strong>:
 A bunch of different names for a hardware device that allows a computer
 to get on the network. This card might have Ethernet ports on it, or 
maybe it’s just pure wireless. It’s probably not even be a proper <a href="https://en.wikipedia.org/wiki/Expansion_card" d__="">card</a> these days–maybe it’s all on-board the same chip as a bunch of other I/O devices built into the motherboard.</p></li>
<li><p d__=""><strong>Network Device (OS)</strong>: A software device structure in the operating system that typically maps to a NIC. Some network devices like the <em>loopback device</em>
 don’t actually use a physical piece of hardware and just “transmit” 
data internally within the OS. On Unix-likes, these devices are named 
things like <code s__="13">eth0</code>, <code s__="13">en1</code>, <code s__="13">wlan2</code> and so on. The loopback device is typically called <code s__="13">lo</code>.</p></li>
<li><p d__=""><strong>MAC address</strong>: Media Access Control 
address. A unique Link Layer address for computers. With Ethernet, the 
MAC address is 6 bytes, and is usually written as hex bytes separated by
 colons: <code s__="13">12:34:56:78:9A:BC</code>. These address must be unique on a LAN for Ethernet to function correctly.</p></li>
<li><p d__=""><strong>Hub</strong>: A device that allows you to connect 
several computers via Ethernet cables. It’ll have 4, 8, or more ports on
 the front. All these devices plugged into those ports are effectively 
on the same “wire” once connected, which is to say that any Ethernet 
packet transmitted is seen by <strong>all</strong> devices plugged into the HUB. You don’t typically see these any longer, since switches perform the same role better.</p></li>
<li><p d__=""><strong>Switch</strong>: A hub with some brains. It knows 
the MAC addresses on the other side of the ports so it doesn’t have to 
retransmit Ethernet packets to <em>everyone</em>. It just sends them down the proper wire to the correct destination. Help prevent network overload.</p></li>
<li><p d__=""><strong>Router</strong>: A Network Layer device that have 
multiple interfaces and chooses the correct one to send traffic down so 
that it will eventually reach its destination. Routers contain <em>routing tables</em> that let them decide where to forward a packet with a given IP address.</p></li>
<li><p d__=""><strong>Default Gateway</strong>: A router that handles 
traffic to all other destinations, if a specific route to the 
destination isn’t known. A computer’s routing table specifies the 
default gateway. On a home LAN, this is the IP of the “router” the ISP 
gave you.</p>
<p d__="">Imagine an island with a small town on it. The island is 
connected to the mainland by a single bridge. If someone wants to know 
where to go in town, you give them directions in town. For <strong>all other destinations</strong>, they drive across the bridge. In this analogy, the bridge is the default gateway for traffic.</p></li>
<li><p d__=""><strong>Broadcast</strong>: To send traffic to everyone on the LAN. This can be done at the Link Layer by sending an Ethernet frame to MAC address <code s__="13">ff:ff:ff:ff:ff</code>, or at the Network Layer by sending an IP packet with all the host bits set to <code s__="13">1</code>. For instance, if the network is <code s__="13">192.168.0.0/16</code>, the broadcast address would be <code s__="13">192.168.255.255</code>. You can also broadcast to <code s__="13">255.255.255.255</code> for the same effect. IP routers do not forward IP broadcast packets, so they are always restricted to the LAN.</p></li>
<li><p d__=""><strong>Wi-Fi</strong>: Short for <em>Wireless Fidelity</em> (a non-technical marketing trademark presumably meant to pun <a href="https://en.wikipedia.org/wiki/High_fidelity" d__="">Hi-Fi</a>),
 this is your wireless LAN connection. Speaks Ethernet at the Link 
Layer. Very similar to using an Ethernet cable, except instead of 
electricity over copper, it uses radio waves.</p></li>
<li><p d__=""><strong>Firewall</strong>: A computer or device at or near
 where your LAN connects to your ISP that filters traffic, preventing 
unwanted traffic from being transmitted on your LAN. Keeps the bad guys 
out, hopefully.</p></li>
<li><p d__=""><strong>NAT</strong>: Network Address Translation. A way 
to have a private IP subnet behind the NAT device that is not visible to
 the rest of the Internet. The NAT device translates internal IP 
addresses and ports to an external IP on the router. This is why if you 
go to Google and ask “what is my ip”, you’ll get a different number than
 you’ll see when you look at the settings on your computer. NAT is in 
the middle, translating between your internal LAN IP address and the 
external, publicly-visible IP address. We’ll talk more about the details
 of this mechanism later.</p></li>
<li><p d__=""><strong>Private Network IPv4 Addresses</strong>: For LANs not connected to the Internet or LANs behind NAT, there are three common subnets that are used: <code s__="13">10.0.0.0/8</code>, <code s__="13">172.16.0.0/12</code>, <code s__="13">192.168.0.0/16</code>.
 These are reserved for private use; no public sites will ever use them,
 so you can put them on your LAN without worrying about conflicts.</p></li>
<li><p d__=""><strong>WiFi Modem/WiFi Router</strong>: Loosely refers to
 a consumer-grade device that you get when you sign up with an ISP for 
service. Often does a variety of things</p></li>
<li><p d__=""><strong>Rack-mount</strong>: If a device doesn’t come in a
 nice plastic case or isn’t meant to be plugged directly into a 
computer, it might be rack-mount. These are larger non-consumer devices 
like routers, switches, or banks of disks, that get stacked up in 
“racks”.</p></li>
<li><p d__=""><strong>Upload</strong>: Transferring a file from your local device to a remote device.</p></li>
<li><p d__=""><strong>Download</strong>: Transferring a file from a remote device to your local device.</p></li>
<li><p d__=""><strong>Symmetric</strong>: In the context of transfer 
speeds, means that a connection offers the same speeds in both 
directions. “1 Gbs symmetric” means that upload and download speeds are 1
 Gbs.</p></li>
<li><p d__=""><strong>Asymmetric</strong>: In the context of transfer 
speeds, means that a connection offers different speeds in either 
direction. Usually written as something like “600 Mbs down, 20 Mbs up”, 
for example, indicating download and upload speeds. Often shortened to 
“600 by 20” conversationally. Most general usage is people download 
things, not uploading, so companies that provide service allocate more 
of their total bandwidth on the download side.</p></li>
<li><p d__=""><strong>Cable</strong> (from the cable company): Many 
cable television companies offer Internet connectivity over the coaxial 
cable line they’ve run to your house. Speeds up to 1 Gbs aren’t unheard 
of. Typically a neighborhood shares bandwidth, so your speeds will drop 
in the evening when everyone living around you is watching movies. Most 
cable offerings are asymmetric.</p></li>
<li><p d__=""><strong>DSL</strong>: Digital Subscriber Line. Many 
telephone companies offer Internet connectivity over the phone lines 
they’ve run to your house. It’s slower than cable at around 100 Mbs, but
 bandwidth is not shared with neighbors. Most DSL offerings are 
asymmetric.</p></li>
<li><p d__=""><strong>Fiber</strong>: Short for <em>optical fiber</em>, 
uses light through glass “wires” instead of electricity through copper 
wires. Very quick. Many ISPs that offer relatively-cheap fiber have 
packages that deliver 1 Gbs symmetric.</p></li>
<li><p d__=""><strong>Modem</strong>: Short for <em>Modulator/Demodulator</em>,
 converts signals in one form to signals in another form. Historically, 
this meant turning sounds transmitted over a telephone landline into 
data. In modern usage, it means converting the signals on your Ethernet 
LAN to whatever form is needed by the ISP, e.g.&nbsp;cable or DSL.</p></li>
<li><p d__=""><strong>Bridge</strong>: A device that connects two 
networks at the link level, allowing them to behave as a single network.
 Some bridges blindly forward all traffic, other bridges are smarter 
about it. Cable modems are a type of bridge, though they often come 
built into the same box as a router and switch.</p></li>
<li><p d__=""><strong>Vampire Tap</strong>: Back in the old days, when you wanted to connect a computer to a thicknet cable, you used one of <a href="https://en.wikipedia.org/wiki/Vampire_tap" d__="">these awesomely-named devices</a> to do it. Included here just for fun.</p></li>
</ul>
<h2 data-number="24.2" id="reflect-14" d__=""><span class="header-section-number">24.2</span> Reflect</h2>
<ul>
<li><p d__="">What’s the difference between a hub and a switch?</p></li>
<li><p d__="">What does a router do?</p></li>
<li><p d__="">Why would a router with only one network connection not make any sense?</p></li>
<li><p d__="">What kind of device do you connect to with your laptop where you live? Do you use a physical cable to connect?</p></li>
<li><p d__="">No need to write anything for this reflection point unless you’re inclined, but ponder what life was like <a href="https://www.youtube.com/watch?v=PjwnIm5Y6XE" d__="">with 300 bps modems</a>. The author’s first modem was a <a href="https://www.oldcomputr.com/commodore-vicmodem-1982/" d__="">VICMODEM</a>,
 literally two million times slower than a modern cable connection. That
 was 40 years ago. Now imagine network speeds in the year 2062.</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="25" id="project-packet-tracer-connect-two-computers" d__=""><span class="header-section-number">25</span> Project: Packet Tracer: Connect Two Computers</h1>
<p d__="">In this project, we’re going to build a simple network between two computers using Cisco’s <a href="https://www.netacad.com/courses/packet-tracer" d__="">Packet Tracer</a><a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup s__="13" d__="">14</sup></a> tool. It’s free!</p>
<p d__="">If you don’t have it installed, check out <a href="#appendix-packettracer" d__="">Appendix: Packet Tracer</a> for installation information.</p>
<p d__="">If at any time you make a mistake that you need to delete, choose the “Delete” tool from the second icon row down.</p>
<h2 data-number="25.1" id="adding-computers-to-the-lan" d__=""><span class="header-section-number">25.1</span> Adding Computers to the LAN</h2>
<p d__="">Select “End Devices” lower left.</p>
<figure>
<img src="Beej's%20Guide%20to%20Network%20Concepts_files/end_devices_icon.svg" alt="End Devices Icon">
<figcaption aria-hidden="true" s__="14" d__="">End Devices Icon</figcaption>
</figure>
<p d__="">Then drag two “PC”s out onto the work area from the panel in the lower middle.</p>
<figure>
<img src="Beej's%20Guide%20to%20Network%20Concepts_files/pc_tool.svg" alt="PC Tool Icon">
<figcaption aria-hidden="true" s__="14" d__="">PC Tool Icon</figcaption>
</figure>
<h2 data-number="25.2" id="wiring-pcs-directly-together" d__=""><span class="header-section-number">25.2</span> Wiring PCs Directly Together</h2>
<p d__="">Now that you have two PCs in the workspace, let’s wire them together.</p>
<p d__="">Click on the “Connections” icon in the lower left.</p>
<figure>
<img src="Beej's%20Guide%20to%20Network%20Concepts_files/connections_icon.svg" alt="Connections Icon">
<figcaption aria-hidden="true" s__="14" d__="">Connections Icon</figcaption>
</figure>
<p d__="">Click on the “Copper Cross-Over” icon in the lower middle. (The icon will change to an “anti” symbol.)</p>
<figure>
<img src="Beej's%20Guide%20to%20Network%20Concepts_files/xo_wire_tool.svg" alt="Copper Cross-Over Selection">
<figcaption aria-hidden="true" s__="14" d__="">Copper Cross-Over Selection</figcaption>
</figure>
<p d__="">Click on one of the PCs. Select “FastEthernet0”.</p>
<p d__="">Click on the other PC. Select “FastEthernet0”.</p>
<p d__="">You should now see something like this:</p>
<figure>
<img src="Beej's%20Guide%20to%20Network%20Concepts_files/2-pcs.svg" alt="Two PCs wired up">
<figcaption aria-hidden="true" s__="14" d__="">Two PCs wired up</figcaption>
</figure>
<h2 data-number="25.3" id="setting-up-the-ip-network" d__=""><span class="header-section-number">25.3</span> Setting Up the IP Network</h2>
<p d__="">Neither of these computers have IP addresses yet. We’ll set them up with static IPs of our choosing.</p>
<ol type="1">
<li><p d__="">Click on PC0.</p></li>
<li><p d__="">Click the “Config” tab.</p></li>
<li><p d__="">Click “FastEthernet0” in the sidebar.</p></li>
<li><p d__="">For “IPv4 Address”, enter <code s__="13">192.168.0.2</code>.</p></li>
<li><p d__="">For “Subnet Mask”, enter <code s__="13">255.255.255.0</code>.</p></li>
</ol>
<p d__="">Close the configuration window.</p>
<p d__="">Click on PC1 and do the same steps, except enter <code s__="13">192.168.0.3</code> for the IP address. Close the configuration window when you’re done.</p>
<h2 data-number="25.4" id="pinging-across-the-network" d__=""><span class="header-section-number">25.4</span> Pinging Across the Network</h2>
<p d__="">Let’s ping from PC0 to PC1 to make sure the network is connected.</p>
<ol type="1">
<li><p d__="">Click on PC0. Select the “Desktop” tab.</p></li>
<li><p d__="">Click on “Command Prompt”.</p></li>
<li><p d__="">In the command prompt, type <code s__="13">ping 192.168.0.3</code>.</p></li>
</ol>
<blockquote>
<p d__="">When you ping, the first ping might timeout because ARP needs 
to do its work first. In more complex networks, multiple pings might 
timeout before getting through.</p>
</blockquote>
<p d__="">You should see successful ping output:</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb182-1" d__=""><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="ex">C:\&gt;ping</span> 192.168.0.3</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-3" d__=""><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Pinging</span> 192.168.0.3 with 32 bytes of data:</span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-5" d__=""><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Reply</span> from 192.168.0.3: bytes=32 time<span class="op" d__="">&lt;</span>1ms TTL=128</span>
<span id="cb182-6" d__=""><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Reply</span> from 192.168.0.3: bytes=32 time<span class="op" d__="">&lt;</span>1ms TTL=128</span>
<span id="cb182-7" d__=""><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Reply</span> from 192.168.0.3: bytes=32 time<span class="op" d__="">&lt;</span>1ms TTL=128</span>
<span id="cb182-8" d__=""><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Reply</span> from 192.168.0.3: bytes=32 time<span class="op" d__="">&lt;</span>1ms TTL=128</span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-10" d__=""><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Ping</span> statistics for 192.168.0.3:</span>
<span id="cb182-11" d__=""><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Packets:</span> Sent = 4, Received = 4, Lost = 0 <span class="er" d__="">(</span><span class="ex">0%</span> loss<span class="kw" d__="">)</span><span class="ex">,</span></span>
<span id="cb182-12" d__=""><a href="#cb182-12" aria-hidden="true" tabindex="-1"></a><span class="ex">Approximate</span> round trip times in milli-seconds:</span>
<span id="cb182-13" d__=""><a href="#cb182-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Minimum</span> = 0ms, Maximum = 0ms, Average = 0ms</span></code></pre></div>
<p d__="">If you see <code s__="13">Request timed out.</code> more than twice, something is misconfigured.</p>
<h2 data-number="25.5" id="saving-the-project" d__=""><span class="header-section-number">25.5</span> Saving the Project</h2>
<p d__="">Be sure to save the project. This will save a file with <code s__="13">.pkt</code> extension.</p>
<!-- Rubric

5
Crossover cable used

5
Two PCs used

5
PCs set up with correct IP addresses.

5
PCs can ping one another.

-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="26" id="project-packet-tracer-using-a-switch" d__=""><span class="header-section-number">26</span> Project: Packet Tracer: Using a Switch</h1>
<p d__="">It’s not typical to wire two PCs directly together. Usually they’re connected through a <em>switch</em>.</p>
<p d__="">Let’s set that up in the lab.</p>
<h2 data-number="26.1" id="add-some-pcs" d__=""><span class="header-section-number">26.1</span> Add Some PCs</h2>
<p d__="">Choose “End Devices” in the lower left, and drag three PCs onto the workspace.</p>
<p d__="">Click on each in turn, going to their “Config” tabs for their <code s__="13">FastEthernet0</code> devices and giving them IP addresses:</p>
<ul>
<li d__="">PC0: <code s__="13">192.168.0.2</code></li>
<li d__="">PC1: <code s__="13">192.168.0.3</code></li>
<li d__="">PC2: <code s__="13">192.168.0.4</code></li>
</ul>
<p d__="">They should all use subnet mask <code s__="13">255.255.255.0</code>.</p>
<h2 data-number="26.2" id="add-a-switch" d__=""><span class="header-section-number">26.2</span> Add a Switch</h2>
<p d__="">Click on “Network Devices” in the lower left. The bottom left row of icons will change.</p>
<p d__="">Select “Switches”, second left on bottom row. The middle panel will change.</p>
<p d__="">Drag a <code s__="13">2960</code> switch onto the workspace.</p>
<p d__="">If you click on the switch and look under the “Physical” tab, you’ll see the switch is a device with a <em>lot</em>
 of Ethernet ports on it. (This is a pretty high-end switch. Home 
switches typically have 4 or 8 ports. The back of your WiFi router at 
home probably has 4 ports like this–that’s a switch built into it!)</p>
<p d__="">We can connect PCs to these ports and they’ll be able to talk to one another.</p>
<h2 data-number="26.3" id="wire-it-up" d__=""><span class="header-section-number">26.3</span> Wire It Up</h2>
<p d__="">None of the PCs will be directly connected. They’ll all connect directly to the switch.</p>
<p d__="">We don’t use crossover cables here; the switch knows what it’s doing.</p>
<blockquote>
<p d__="">Note that when you first wire up the LAN, you might not have 
two green up arrows shown on the connection. One or both of them might 
be orange circles indicating the link is in the process of coming up. 
You can hit the <code s__="13">&gt;&gt;</code> fast-forward button in the lower left to jump ahead in time until you get two green up arrows.</p>
</blockquote>
<p d__="">Choose the “Connections” selector in the lower left.</p>
<p d__="">Choose the “Copper Straight-Through” cable. (The icon will change to an “anti” symbol.)</p>
<p d__="">Click on PC0, then select <code s__="13">FastEthernet0</code>.</p>
<p d__="">Click on the switch, then select any <code s__="13">FastEthernet0</code> port.</p>
<p d__="">Do the same for the other 2 PCs.</p>
<h2 data-number="26.4" id="test-pings" d__=""><span class="header-section-number">26.4</span> Test Pings!</h2>
<p d__="">Click on one of the PCs and go to the “Desktop” tab and run a Command Prompt. Make sure you can <code s__="13">ping</code> the other two PCs.</p>
<!-- Rubric

5
Straight-through cable used

5
Three PCs used

5
Switch used

10
Can ping from any PC to any other PC

-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="27" id="project-packet-tracer-using-a-router" d__=""><span class="header-section-number">27</span> Project: Packet Tracer: Using a Router</h1>
<p d__="">We’re going to add a router between two independent networks in Packet Tracer.</p>
<p d__="">The goal will be something that looks like this:</p>
<figure>
<img src="Beej's%20Guide%20to%20Network%20Concepts_files/1router-2net.svg" alt="Single Router, Two Networks">
<figcaption aria-hidden="true" s__="14" d__="">Single Router, Two Networks</figcaption>
</figure>
<h2 data-number="27.1" id="build-the-lans" d__=""><span class="header-section-number">27.1</span> Build the LANs</h2>
<p d__="">First of all, build two separate LANs. Each will have three PCs and a 2960 switch like before.</p>
<p d__="">The left subnet will be <code s__="13">192.168.0.0/24</code>. The right subnet will be <code s__="13">192.168.1.0/24</code>.</p>
<p d__="">Assign the left PCs the IP addresses on their <code s__="13">FastEthernet0</code> interfaces:</p>
<ul>
<li><code s__="13" d__="">192.168.0.2</code></li>
<li><code s__="13" d__="">192.168.0.3</code></li>
<li><code s__="13" d__="">192.168.0.4</code></li>
</ul>
<p d__="">Assign the right PCs the IP addresses on their <code s__="13">FastEthernet0</code> interfaces:</p>
<ul>
<li><code s__="13" d__="">192.168.1.2</code></li>
<li><code s__="13" d__="">192.168.1.3</code></li>
<li><code s__="13" d__="">192.168.1.4</code></li>
</ul>
<p d__="">All of them have subnet mask <code s__="13">255.255.255.0</code>.</p>
<p d__="">Connect the left PCs to one switch on any unused <code s__="13">FastEthernet</code> ports. Connect the right PCs to the other switch in the same way.</p>
<p d__="">At this point, you should have two separate LANs.</p>
<p d__="">Hit the fast-forward button if all the links aren’t green yet. If they stay red, something is wrong–double-check your settings.</p>
<p d__="">For sanity, make sure <code s__="13">192.168.0.2</code> can ping the other two machines on its LAN. And make sure <code s__="13">192.168.1.3</code> can ping the other two machines on its LAN.</p>
<h2 data-number="27.2" id="adding-a-router" d__=""><span class="header-section-number">27.2</span> Adding a Router</h2>
<p d__="">The router is going to route traffic between these two networks.</p>
<p d__="">Click the “Network Devices” icon in the lower left. Then click “Routers” in the bottom left. Then drag a <code s__="13">4331</code> router in between the two.</p>
<p d__="">This router is going to be connected to both switches. Each “side” of the router will have a different IP address.</p>
<p d__="">We’re going to connect some wires here, but <em>the link won’t come up yet</em>. We’ll deal with that in a minute.</p>
<p d__="">On the switch on LAN <code s__="13">192.168.0.0/24</code>, use a Copper Straight-Through connector to connect the switch’s <code s__="13">GigabitEthernet0/1</code> port to the router’s <code s__="13">GigabitEthernet0/0/0</code> port.</p>
<p d__="">On the switch on LAN <code s__="13">192.168.1.0/24</code>, use the same type of connector to connect the switch’s <code s__="13">GigabitEthernet0/1</code> port to the router’s <code s__="13">GigabitEthernet0/0/1</code> port.</p>
<p d__="">Note this is a different port on the router than the other 
switch is connected to! Both switches are plugged into different ports 
on the router.</p>
<p d__="">We have the hardware in place now, but we don’t yet have any IP addresses assigned on the router. So let’s do that.</p>
<p d__="">In the “Config” for the router, choose the <code s__="13">GigabitEthernet0/0/0</code> interface and give it the IP address <code s__="13">192.168.0.1</code>–it’s now part of the <code s__="13">192.168.0.0/24</code>
 subnet. While you’re here, click the “On” checkbox to power the port. 
This should bring up the connection and get you the green arrows.</p>
<p d__="">Then go to the <code s__="13">GigabitEthernet0/0/1</code> interface and give it the IP address <code s__="13">192.168.1.1</code>–it’s now part of the <code s__="13">192.168.1.0/24</code> subnet. While you’re here, click the “On” checkbox to power the port.</p>
<p d__="">Let’s try pinging the router. Go to any PC on the <code s__="13">192.168.0.0/24</code> LAN and trying pinging <code s__="13">192.168.0.1</code> (the router). It should reply.</p>
<p d__="">Then go to any PC on the <code s__="13">192.168.1.0/24</code> subnet and try pinging <code s__="13">192.168.1.1</code>. It should reply.</p>
<p d__="">Now the ultimate test: get a console on PC <code s__="13">192.168.0.2</code> and try to ping <code s__="13">192.168.1.2</code> on the other subnet!</p>
<p d__="">It… doesn’t work!</p>
<p d__="">Why?</p>
<h2 data-number="27.3" id="adding-a-default-route" d__=""><span class="header-section-number">27.3</span> Adding a Default Route</h2>
<p d__="">All the computers need to know two things:</p>
<ul>
<li d__="">What the LAN’s subnet number is so it knows to route local traffic on the LAN.</li>
<li d__="">A <em>default gateway</em>, the computer on the LAN that should get traffic for destinations outside the LAN.</li>
</ul>
<p d__="">We’ve put the subnet in, but not the default gateway.</p>
<p d__="">For all the PCs on the <code s__="13">192.168.0.0/24</code> subnet, go into the “Config”, then choose the “Global” sidebar item. Enter <code s__="13">192.168.0.1</code> (the router!) in the “Default Gateway” field.</p>
<p d__="">Do the same for all the PCs on the other subnet, except enter <code s__="13">192.168.1.1</code> as the default gateway.</p>
<h2 data-number="27.4" id="try-it-out" d__=""><span class="header-section-number">27.4</span> Try It Out!</h2>
<p d__="">Now you should be able to ping any PC from any other PC!</p>
<p d__="">If you can’t, try pinging just on one LAN to make sure it works. And ping the router on that LAN to make sure that works.</p>
<!-- Rubric

5
Three PCs used in two subnets

5
All PCs on the same subnet can ping one another

5
Two switches used in two subnets

10
Router configured on both subnets in different ports

10
Each subnet can ping its own router.

5 
Any computer can ping any other computer on either subnet

-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="28" id="project-packet-tracer-multiple-routers" d__=""><span class="header-section-number">28</span> Project: Packet Tracer: Multiple Routers</h1>
<p d__="">In the last Packet Tracer project, we had a single router 
between two subnets. In this project, we’ll have multiple routers 
between subnets.</p>
<p d__="">This complicates matters, because each router’s routing table 
needs to be edited so that it knows out which connection to forward 
packets.</p>
<p d__="">In a larger LAN, a gateway protocol could be used to quickly distribute the information the routers needed.</p>
<p d__="">But in our case, to keep it conceptually simple, we’ll just 
manually configure the routes in each of the three routers we’ll have.</p>
<h2 data-number="28.1" id="what-were-building" d__=""><span class="header-section-number">28.1</span> What We’re Building</h2>
<p d__="">FIVE subnets!</p>
<ul>
<li d__="">Three of them are LANs:
<ul>
<li><code s__="13">192.168.0.0/24</code></li>
<li><code s__="13">192.168.1.0/24</code></li>
<li><code s__="13">192.168.2.0/24</code></li>
</ul></li>
<li d__="">Two of them exist between routers:
<ul>
<li><code s__="13">10.0.0.0/16</code></li>
<li><code s__="13">10.1.0.0/16</code></li>
</ul></li>
</ul>
<p d__="">And here’s a picture of it:</p>
<figure>
<img src="Beej's%20Guide%20to%20Network%20Concepts_files/mult_routers_net_diagram.svg" alt="Multiple Routers Network Diagram">
<figcaption aria-hidden="true" s__="14" d__="">Multiple Routers Network Diagram</figcaption>
</figure>
<h2 data-number="28.2" id="drag-out-the-components" d__=""><span class="header-section-number">28.2</span> Drag Out the Components</h2>
<p d__="">We’ll need:</p>
<ul>
<li d__="">2 PCs per LAN, so 6 PCs total</li>
<li d__="">3 2960 switches</li>
<li d__="">3 4331 routers</li>
</ul>
<p d__="">Each LAN is connected to one router.</p>
<p d__="">Two of the routers also connect to another router.</p>
<p d__="">But, <strong>and this is the fun bit</strong>, the middle router is connected to two routers <strong>and</strong> another LAN!</p>
<p d__="">Put straight-through copper connections between the components as shown in the diagram, above.</p>
<h2 data-number="28.3" id="setting-up-the-middle-router" d__=""><span class="header-section-number">28.3</span> Setting Up the Middle Router</h2>
<p d__="">That router in the middle that connects to two other routers 
and a LAN? It doesn’t come with enough ports by default. We need to add 
one.</p>
<p d__="">Luckily this is a virtual simulation, so you’re allowed to 
simulate virtual payment for the new components and won’t have to open 
your real wallet.</p>
<p d__="">Select that router and go to the “Physical” tab.</p>
<p d__="">Click “Zoom In” to get a better view.</p>
<p d__="">The power switch is on the right side. Scroll over there and click it. (You can’t add components until you power it down.)</p>
<p d__="">Two of the Ethernet connectors are in the upper left. Just 
right of those, there are two more ports that we can plug components 
into.</p>
<p d__="">From the left sidebar, drag a “GLC-T” into the lower one of 
those ports (apparently it doesn’t work in the upper one), as shown 
below:</p>
<figure>
<img src="Beej's%20Guide%20to%20Network%20Concepts_files/adding-glc-component.svg" alt="Adding a GLC-T component">
<figcaption aria-hidden="true" s__="14" d__="">Adding a GLC-T component</figcaption>
</figure>
<p d__="">Then power the router back on.</p>
<h2 data-number="28.4" id="set-up-the-three-lan-subnets" d__=""><span class="header-section-number">28.4</span> Set up the Three LAN Subnets</h2>
<p d__="">Use these subnet numbers:</p>
<ul>
<li><code s__="13" d__="">192.168.0.0/24</code></li>
<li><code s__="13" d__="">192.168.1.0/24</code></li>
<li><code s__="13" d__="">192.168.2.0/24</code></li>
</ul>
<p d__="">By convention, routers often are the <code s__="13">.1</code> on their subnet, e.g. <code s__="13">192.168.2.1</code>. This isn’t a requirement.</p>
<p d__="">Assign the 2 PCs and 1 of the routers IP addresses on the subnet. Connect them all to a switch.</p>
<p d__="">Make sure the correct Ethernet port on the router has been set “On” in its config!</p>
<p d__="">Sanity check: all computers on a subnet should be able to ping each other <strong>and</strong> their router.</p>
<h2 data-number="28.5" id="set-the-default-gateway-on-all-pcs" d__=""><span class="header-section-number">28.5</span> Set the Default Gateway on All PCs</h2>
<p d__="">Remember that when PCs send out traffic, they either know 
they’re sending it on the LAN (because the destination is on the same 
LAN), or they don’t know where the IP is. If they don’t recognize the IP
 as being on the same subnet, they send the traffic to their <em>default gateway</em>, i.e.&nbsp;the router that knows what to do with it.</p>
<p d__="">Click on each PC in turn. Under “Config” in sidebar “Global/Settings”, set a static “Default Gateway” of that LAN’s router IP.</p>
<p d__="">For example, if I’m on PC <code s__="13">192.168.1.2</code> and my router on that LAN is <code s__="13">192.168.1.1</code>, I’ll set the PC’s default gateway to <code s__="13">192.168.1.1</code>.</p>
<p d__="">In fact, I’ll set the default gateway for all the PCs on the LAN to that value.</p>
<p d__="">Do the same for the other two LANs.</p>
<h2 data-number="28.6" id="setting-up-the-router-subnets" d__=""><span class="header-section-number">28.6</span> Setting Up the Router Subnets</h2>
<p d__="">In order to route properly, we need one subnet between the left and middle router, and another between the middle and right.</p>
<p d__="">Use these subnets:</p>
<ul>
<li><code s__="13" d__="">10.0.0.0/16</code></li>
<li><code s__="13" d__="">10.1.0.0/16</code></li>
</ul>
<p d__="">This means the left and right routers will have TWO IP addresses because they’re attached to two subnets.</p>
<p d__="">But the middle router will have THREE IP addresses because 
it’s attached to three subnets! (i.e.&nbsp;attached to one LAN, and 
attached to two other routers.</p>
<p d__="">Connect the subnets with copper straight-through connectors if you haven’t done so already..</p>
<h2 data-number="28.7" id="setting-up-the-routing-tables" d__=""><span class="header-section-number">28.7</span> Setting Up the Routing Tables</h2>
<p d__="">We’re almost there, but if you’re on <code s__="13">192.168.0.2</code> and you try to ping <code s__="13">192.168.1.2</code>, the traffic won’t get through.</p>
<p d__="">This is because the router on subnet <code s__="13">192.168.0.0/24</code> doesn’t know where to send so that it arrives at <code s__="13">192.168.1.2</code>.</p>
<p d__="">We have to put that in.</p>
<p d__="">We’re going to manually add “static routes” to each of the 
routers so that they know where to send things. As mentioned earlier, in
 real-life LANs, it would be more common to use gateway protocols to 
automatically get these routing tables set up.</p>
<p d__="">But this is a lab–what would the fun be in that? (Actually it would be a very useful exercise, but this one is <em>usefuller</em> as an introduction.)</p>
<p d__="">Let’s look at the network diagram again:</p>
<figure>
<img src="Beej's%20Guide%20to%20Network%20Concepts_files/mult_routers_net_diagram.svg" alt="Multiple Routers Network Diagram">
<figcaption aria-hidden="true" s__="14" d__="">Multiple Routers Network Diagram</figcaption>
</figure>
<p d__="">If a packet destined for <code s__="13">192.168.1.2</code> (on the right) leaves from <code s__="13">192.168.0.3</code> on the left, how does it get there?</p>
<p d__="">We can see it must travel through all three routers. But when it arrives at the first one at <code s__="13">192.168.0.1</code> (the router for the LAN), where does that router send it?</p>
<p d__="">Well, from there, we’ll head out on the <code s__="13">10.0.0.0/16</code> subnet to router <code s__="13">10.0.0.2</code>.</p>
<p d__="">So we have to add a route for the leftmost router saying, “Hey, if you get anything for subnet <code s__="13">192.168.0.0/24</code>, forward it to <code s__="13">10.0.0.2</code> because that’s the next hop on the way.”</p>
<p d__="">We do this by clicking on the leftmost router, then going to “Config”, and “Routing/Static” in the left sidebar.</p>
<p d__="">The “Network” and “Mask” fields are the destination, and “Next Hop” is the router we should forward that traffic to.</p>
<p d__="">In the case of the diagram, we’d add a route to the leftmost router like so (recalling that a <code s__="13">\24</code> network has netmask <code s__="13">255.255.255.0</code>):</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb183-1" d__=""><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>Network:  192.168.1.0</span>
<span id="cb183-2" d__=""><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>Mask:     255.255.255.0</span>
<span id="cb183-3" d__=""><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>Next Hop: 10.0.0.2</span></code></pre></div>
<p d__="">And that gets us partway there! But, sadly and importantly, that middle router doesn’t know where to send traffic for <code s__="13">192.168.1.0/24</code>, either.</p>
<p d__="">So we have to add a route to that middle router that sends it on the next hop, but this time out its <code s__="13">10.1.0.0/16</code> interface:</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb184-1" d__=""><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>Network:  192.168.1.0</span>
<span id="cb184-2" d__=""><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>Mask:     255.255.255.0</span>
<span id="cb184-3" d__=""><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>Next Hop: 10.1.0.2</span></code></pre></div>
<p d__="">And now we’re there! The router with IP <code s__="13">10.1.0.2</code> has an interface that is connected to <code s__="13">192.168.1.0/24</code>. Our original packet is going to <code s__="13">192.168.1.2</code>, and that’s on the same subnet! The router knows it can just send the traffic out on that interface.</p>
<p d__="">Of course, that’s not all we have to do.</p>
<p d__="">Add routing table entries for all the non-directly-connected subnets to each router.</p>
<p d__="">Each router should have two static routing table entries so that all inbound and outbound traffic is covered.</p>
<h2 data-number="28.8" id="test-it-out" d__=""><span class="header-section-number">28.8</span> Test It Out!</h2>
<p d__="">If it’s all configured correctly, you should be able to ping 
any PC from any other PC! The routers forward the traffic to the other 
LANs!</p>
<!-- Rubric

15
All three LANs set up correctly

15
All three routers connected correctly with proper subnets

18
All three routing tables set up correctly

-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="29" id="select" d__=""><span class="header-section-number">29</span> Select</h1>
<p d__="">In this chapter we’re taking a look at the <code s__="13">select()</code>
 function. This is a function that looks at a whole set of sockets and 
lets you know which ones have sent you data. That is, which ones are 
ready to call <code s__="13">recv()</code> on.</p>
<p d__="">This enables us to wait for data on a large number of sockets at the same time.</p>
<h2 data-number="29.1" id="the-problem-were-solving" d__=""><span class="header-section-number">29.1</span> The Problem We’re Solving</h2>
<p d__="">Let’s say the server is connected to three clients. It wants to <code s__="13">recv()</code> data from whichever client sends it next.</p>
<p d__="">But the server has no way of knowing which client will send data next.</p>
<p d__="">In addition, when the server calls <code s__="13">recv()</code> on a socket with no data ready to read, the <code s__="13">recv()</code> call <em>blocks</em>, preventing anything else from running.</p>
<blockquote>
<p d__="">To <em>block</em> means that the process will stop executing here and goes to sleep until some condition is met. In the case of <code s__="13">recv()</code>, the process goes to sleep until there’s some data to receive.</p>
</blockquote>
<p d__="">So we have this problem where if we do something like this:</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb185-1" d__=""><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>data1 <span class="op" d__="">=</span> s1.recv(<span class="dv" d__="">4096</span>)</span>
<span id="cb185-2" d__=""><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a>data2 <span class="op" d__="">=</span> s2.recv(<span class="dv" d__="">4096</span>)</span>
<span id="cb185-3" d__=""><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>data3 <span class="op" d__="">=</span> s3.recv(<span class="dv" d__="">4096</span>)</span></code></pre></div>
<p d__="">but there’s no data ready on <code s__="13">s1</code>, then the process will block there and not call <code s__="13">recv()</code> on <code s__="13">s2</code> or <code s__="13">s3</code> even if there’s data to be received on those sockets.</p>
<p d__="">We need a way to monitor <code s__="13">s1</code>, <code s__="13">s2</code>, and <code s__="13">s3</code> at the same time, determine which of them have data ready to receive, and then call <code s__="13">recv()</code> only on those sockets.</p>
<p d__="">The <code s__="13">select()</code> function does this. Calling <code s__="13">select()</code>
 on a set of sockets will block until one or more of those sockets is 
ready-to-read. And then it returns to you which sockets are ready and 
you can call <code s__="13">recv()</code> specifically on those.</p>
<h2 data-number="29.2" id="using-select" d__=""><span class="header-section-number">29.2</span> Using <code>select()</code></h2>
<p d__="">First of all, you need the <code s__="13">select</code> module.</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb186-1" d__=""><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">import</span> select</span></code></pre></div>
<p d__="">If you have a bunch of connected sockets you want to test for being ready to <code s__="13">recv()</code>, you can add those to a <code s__="13">set()</code> and pass that to <code s__="13">select()</code>. It will block until one is ready to read.</p>
<p d__="">This set can be used as your canonical list of connected 
sockets. You need to keep track of them all somewhere, and this set is a
 good place. As you get new connections, you add them to the set, and as
 the connections hang up, you remove them from the set. In this way, it 
always holds the sockets of all the current connections.</p>
<p d__="">Here’s an example. <code s__="13">select()</code> takes three arguments and return three values. We’ll just look at the first of each of these for now, ignoring the other ones.</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb187-1" d__=""><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>read_set <span class="op" d__="">=</span> {s1, s2, s3}</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-3" d__=""><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a>ready_to_read, _, _ <span class="op" d__="">=</span> select.select(read_set, {}, {})</span></code></pre></div>
<p d__="">At this point, we can go through the sockets that are ready and receive data.</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb188-1" d__=""><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">for</span> s <span class="kw" d__="">in</span> ready_to_read:</span>
<span id="cb188-2" d__=""><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>    data <span class="op" d__="">=</span> s.recv(<span class="dv" d__="">4096</span>)</span></code></pre></div>
<h2 data-number="29.3" id="using-select-with-listening-sockets" d__=""><span class="header-section-number">29.3</span> Using <code>select()</code> with Listening Sockets</h2>
<p d__="">If you’ve been looking closely, you might have the following question: if the server is blocked on a <code s__="13">select()</code> call waiting for incoming data, how can it also call <code s__="13">accept()</code> to accept incoming connections? Won’t the incoming connections have to wait? Furthermore, <code s__="13">accept()</code> blocks… how will we get back to the <code s__="13">select()</code> if we’re blocked on that?</p>
<p d__="">Fortunately, <code s__="13">select()</code> provides us with an answer: <em>you can add a listening socket to the set!</em> When the listening socket shows up as “ready-to-read”, it means there’s a new incoming connection to <code s__="13">accept()</code>.</p>
<h2 data-number="29.4" id="the-main-algorithm" d__=""><span class="header-section-number">29.4</span> The Main Algorithm</h2>
<p d__="">Putting it all together, we get the core of any main loop that uses <code s__="13">select()</code>:</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb189-1" d__=""><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>add the listener socket to the set</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-3" d__=""><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>main loop:</span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-5" d__=""><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>    call select() and get the sockets that are ready to read</span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-7" d__=""><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>    for all sockets that are ready to read:</span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-9" d__=""><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a>        if the socket is the listener socket:</span>
<span id="cb189-10" d__=""><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>            accept() a new connection</span>
<span id="cb189-11" d__=""><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a>            add the new socket to our set!</span>
<span id="cb189-12"><a href="#cb189-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-13" d__=""><a href="#cb189-13" aria-hidden="true" tabindex="-1"></a>        else the socket is a regular socket:</span>
<span id="cb189-14" d__=""><a href="#cb189-14" aria-hidden="true" tabindex="-1"></a>            recv() the data from the socket</span>
<span id="cb189-15"><a href="#cb189-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-16" d__=""><a href="#cb189-16" aria-hidden="true" tabindex="-1"></a>            if you receive zero bytes</span>
<span id="cb189-17" d__=""><a href="#cb189-17" aria-hidden="true" tabindex="-1"></a>                the client hung up</span>
<span id="cb189-18" d__=""><a href="#cb189-18" aria-hidden="true" tabindex="-1"></a>                remove the socket from tbe set!</span></code></pre></div>
<h2 data-number="29.5" id="what-about-those-other-arguments-to-select" d__=""><span class="header-section-number">29.5</span> What About Those Other Arguments to <code>select()</code>?</h2>
<p d__=""><code s__="13">select()</code> actually takes three arguments.
 (Though for this project we only need to use the first one, so this 
section is purely informational.)</p>
<p d__="">They correspond to:</p>
<ul>
<li d__="">Which sockets you want to monitor for ready-to-read</li>
<li d__="">Which sockets you want to monitor for ready-to-write</li>
<li d__="">Which sockets you want to monitor for exception conditions</li>
</ul>
<p d__="">And the return values map to these, as well.</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb190-1" d__=""><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>read, write, exc <span class="op" d__="">=</span> select.select(read_set, write_set, exc_set)</span></code></pre></div>
<p d__="">But again, for this project, we just use the first and ignore the rest.</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb191-1" d__=""><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>read, _, _ <span class="op" d__="">=</span> select.select(read_set, {}, {})</span></code></pre></div>
<h3 data-number="29.5.1" id="the-timeout" d__=""><span class="header-section-number">29.5.1</span> The Timeout</h3>
<p d__="">I told a bit of a lie. There’s an optional fourth arguments, the <code s__="13">timeout</code>. It’s a floating point number of seconds to wait for an event to occur; if nothing occurs in that timeframe, <code s__="13">select()</code> returns and none of the returned sockets are shown as ready.</p>
<p d__="">You can also specify a timeout of <code s__="13">0</code> if you want to just poll the sockets.</p>
<h2 data-number="29.6" id="using-select-with-send" d__=""><span class="header-section-number">29.6</span> Using <code>select()</code> with <code>send()</code></h2>
<p d__="">If your computer tries to send too much too fast, the call to <code s__="13">send()</code> might block. That is, the OS will have it sleep while it processes the backlog of data to be sent.</p>
<p d__="">But let’s say you really don’t want to have the call block and want to keep processing.</p>
<p d__="">You can query with <code s__="13">select()</code> to make sure a socket won’t block with a <code s__="13">send()</code> call by passing a set containing the socket descriptor as the second argument.</p>
<p d__="">And it’ll work in much the same way as the “ready to read” set works, above.</p>
<h2 data-number="29.7" id="reflect-15" d__=""><span class="header-section-number">29.7</span> Reflect</h2>
<ul>
<li><p d__="">Why can’t we just call <code s__="13">recv()</code> on all the connected sockets? What does <code s__="13">select()</code> buy us?</p></li>
<li><p d__="">When <code s__="13">select()</code> shows a socket “ready-to-read”, what does it mean if the socket is a listening socket versus a non-listening socket?</p></li>
<li><p d__="">Why do we have to add the listener socket to the set, anyway? Why not just call <code s__="13">accept()</code> and then call <code s__="13">select()</code>?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="30" id="project-using-select" d__=""><span class="header-section-number">30</span> Project: Using Select</h1>
<p d__="">In this project we’re going to write a server that uses <code s__="13">select()</code> to handle multiple simultaneous connections.</p>
<p d__="">The client is already provided. You fill in the server.</p>
<h2 data-number="30.1" id="demo-code" d__=""><span class="header-section-number">30.1</span> Demo Code</h2>
<p d__="">Grab <a href="https://beej.us/guide/bgnet0/source/exercises/select/select.zip" d__="">this ZIP file</a><a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup s__="13" d__="">15</sup></a> with all the input files.</p>
<p d__="">The <code s__="13">select_client.py</code> file is already complete.</p>
<p d__="">You have to fill in the <code s__="13">select_server.py</code> file to get it going.</p>
<h2 data-number="30.2" id="features-to-add" d__=""><span class="header-section-number">30.2</span> Features to Add</h2>
<p d__="">Your server should do the following:</p>
<ul>
<li><p d__="">When a client connects, the server prints out the client 
connection info in this form (it’s the client IP and port number in 
front):</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb192-1" d__=""><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457): connected</span></code></pre></div></li>
<li><p d__="">When a client disconnects, the server prints out the late client’s connection info in this form:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb193-1" d__=""><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457): disconnected</span></code></pre></div>
<p d__=""><strong>Hint</strong>: You can use the <code s__="13">.getpeername()</code> method on a socket to get the address of the remote side even after it has disconnected. It’ll come back as a tuple containing <code s__="13">("host", port)</code>, just like what you pass to <code s__="13">connect()</code>.</p></li>
<li><p d__="">When a client sends data, the server should print out the length of the data as well as the raw bytestring object received:</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb194-1" d__=""><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457) 22 bytes: b'test1: xajrxttphhlwmjf'</span></code></pre></div></li>
</ul>
<h2 data-number="30.3" id="example-run" d__=""><span class="header-section-number">30.3</span> Example Run</h2>
<p d__="">Running the server:</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb195-1" d__=""><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> select_server.py 3490</span></code></pre></div>
<p d__="">Running the clients:</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb196-1" d__=""><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> select_client.py alice localhost 3490</span>
<span id="cb196-2" d__=""><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> select_client.py bob localhost 3490</span>
<span id="cb196-3" d__=""><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> select_client.py chris localhost 3490</span></code></pre></div>
<p d__="">The first argument to the client can be any string–the server 
prints it out with the data to help you identify which client it came 
from.</p>
<p d__="">Example output:</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb197-1" d__=""><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>waiting for connections</span>
<span id="cb197-2" d__=""><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457): connected</span>
<span id="cb197-3" d__=""><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457) 22 bytes: b'test1: xajrxttphhlwmjf'</span>
<span id="cb197-4" d__=""><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457) 22 bytes: b'test1: geqtgopbayogenz'</span>
<span id="cb197-5" d__=""><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457) 23 bytes: b'test1: jquijcatyhvfpydn'</span>
<span id="cb197-6" d__=""><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457) 23 bytes: b'test1: qbavdzfihualuxzu'</span>
<span id="cb197-7" d__=""><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457) 24 bytes: b'test1: dyqmzawthxjpkgpcg'</span>
<span id="cb197-8" d__=""><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457) 23 bytes: b'test1: mhxebjpmsmjsycmj'</span>
<span id="cb197-9" d__=""><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61458): connected</span>
<span id="cb197-10" d__=""><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61458) 23 bytes: b'test2: bejnrwxftgzcgdyg'</span>
<span id="cb197-11" d__=""><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457) 24 bytes: b'test1: ptcavvhroihmgdfyw'</span>
<span id="cb197-12" d__=""><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61458) 24 bytes: b'test2: qrumcrmqxauwtcuaj'</span>
<span id="cb197-13" d__=""><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457) 26 bytes: b'test1: tzoitpusjaxljkfxfvw'</span>
<span id="cb197-14" d__=""><a href="#cb197-14" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457) 17 bytes: b'test1: mtcwokwquc'</span>
<span id="cb197-15" d__=""><a href="#cb197-15" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61458) 18 bytes: b'test2: whvqnzgtaem'</span>
<span id="cb197-16" d__=""><a href="#cb197-16" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61457): disconnected</span>
<span id="cb197-17" d__=""><a href="#cb197-17" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61458) 21 bytes: b'test2: raqlvexhimxfgl'</span>
<span id="cb197-18" d__=""><a href="#cb197-18" aria-hidden="true" tabindex="-1"></a>('127.0.0.1', 61458): disconnected</span></code></pre></div>
<!-- Rubric:

5
Server prints proper client connection message

5
Server prints proper client disconnection message

5
Server prints proper client data received message

5
Server uses select() to wait for incoming connections

5
Server uses select() to wait for incoming client data

-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="31" id="domain-name-system-dns" d__=""><span class="header-section-number">31</span> Domain Name System (DNS)</h1>
<p d__="">We’ve learned that IP is responsible for routing traffic around the Internet. We’ve also learned that it does it with <em>IP addresses</em>, which we commonly show in dots-and-numbers format for IPv4, such as <code s__="13">10.1.2.3</code>.</p>
<p d__="">But as humans, we rarely use IP addresses. When you use your 
web browser, you don’t typically put an IP address in the address bar.</p>
<p d__="">Even in our projects, we tended to type <code s__="13">localhost</code> instead of our localhost address of <code s__="13">127.0.0.1</code>.</p>
<p d__="">The general process for converting a name like <code s__="13">www.example.com</code> that humans use into an IP address that computers use is called <em>domain name resolution</em>, and is provided by a distributed group of servers that comprise the <em>Domain Name System</em>, or DNS.</p>
<h2 data-number="31.1" id="typical-usage" d__=""><span class="header-section-number">31.1</span> Typical Usage</h2>
<p d__="">From a user standpoint, we configure our devices to have a 
“name server” that they contact to convert those names to IP addresses. 
(Probably this is configured with DHCP, but more on that later.)</p>
<p d__="">When you try to connect to <code s__="13">example.com</code>, your computer contacts that name server to get the IP address.</p>
<p d__="">If that name server knows the answer, it supplies it. But if it doesn’t, then a whole bunch of wheels get put into motion.</p>
<p d__="">Let’s start diving down into that process.</p>
<h2 data-number="31.2" id="domains-and-ip-addresses" d__=""><span class="header-section-number">31.2</span> Domains and IP Addresses</h2>
<p d__="">If haven’t ever registered a domain (such as <code s__="13">example.com</code> or <code s__="13">oregonstate.edu</code> or <code s__="13">google.com</code> or <code s__="13">army.mil</code>), the process is something like this:</p>
<ol type="1">
<li d__="">Contact a <em>domain registrar</em> (i.e.&nbsp;some company that has the authority to sell domains).</li>
<li d__="">Choose a domain no one has picked yet.</li>
<li d__="">Pay them some money annually to use the domain.</li>
<li d__="">…</li>
<li d__="">Profit!</li>
</ol>
<p d__="">But doing this is completely disconnected from the idea of an 
IP address. Indeed, domains can exist without IP addresses–they just 
can’t be used.</p>
<p d__="">Once you have your domain, you can contact a hosting company 
that will provide you with an IP address on a server that you can use.</p>
<p d__="">Now you have the two pieces: the domain and the IP address.</p>
<p d__="">But you still have to connect them so people can look up your IP if they have your domain name.</p>
<p d__="">To do this, you add a database record with the pertinent information to a server that’s part of the DNS landscape: a <em>domain name server</em>.</p>
<h2 data-number="31.3" id="domain-name-servers" d__=""><span class="header-section-number">31.3</span> (Domain) Name Servers</h2>
<p d__="">Usually called <em>name servers</em> for short, these servers contain IP records for the domain in which they are an <em>authority</em>. That is, a name server doesn’t have records for the entire world; it just has them for a particular domain or subdomain.</p>
<blockquote>
<p d__="">A <em>subdomain</em> is a domain administered by the owner of a domain. For example, the owner of <code s__="13">example.com</code> might make subdomains <code s__="13">sub1.example.com</code> and <code s__="13">sub2.example.com</code>. These aren’t hosts in this case–but they can have their own hosts, e.g. <code s__="13">host1.sub1.example.com</code>, <code s__="13">host2.sub1.example.com</code>, <code s__="13">somecompy.sub2.example.com</code>.</p>
<p d__="">Domain owners can make as many subdomains as they want. They 
just have to make sure they have a name server set up to handle them.</p>
</blockquote>
<p d__="">A name server that’s authoritative for a specific domain can be asked about any host on that domain.</p>
<p d__="">The host is often the first “word” of a domain name, though it’s not necessarily.</p>
<p d__="">For example with <code s__="13">www.example.com</code>, the host is a computer called <code s__="13">www</code> on a domain <code s__="13">example.com</code>.</p>
<p d__="">A single name server might be authoritative for many domains.</p>
<p d__="">But even if a name server doesn’t know the IP address of the 
domain it’s been asked to provide, it can contact some other name 
servers to figure it out. From a user perspective, this process is 
transparent.</p>
<p d__="">So, easy-peasy. If I don’t know the domain in question, I’ll 
just contact the name server for that domain and get the answer from 
them, right?</p>
<h2 data-number="31.4" id="root-name-servers" d__=""><span class="header-section-number">31.4</span> Root Name Servers</h2>
<p d__="">We have an issue, though. How can I connect to the name server
 for a domain if I don’t know what the name server is for a domain?</p>
<p d__="">To solve this, we have a number of <em>root name servers</em> 
that can help us on our way. When we don’t know an IP, we can start with
 them and ask them to tell us the IP, or tell us which other server to 
ask. More on that process in a minute.</p>
<p d__="">Computers are preconfigured with the IP addresses of the 13 
root name servers. These IPs rarely ever change, and only one of them is
 needed to work. Computers that perform DNS frequently retrieve the list
 to keep it up to date.</p>
<p d__="">The root name servers themselves are named <code s__="13">a</code> to <code s__="13">m</code>:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb198-1" d__=""><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>a.root-servers.net</span>
<span id="cb198-2" d__=""><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>b.root-servers.net</span>
<span id="cb198-3" d__=""><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>c.root-servers.net</span>
<span id="cb198-4" d__=""><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb198-5" d__=""><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>k.root-servers.net</span>
<span id="cb198-6" d__=""><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>l.root-servers.net</span>
<span id="cb198-7" d__=""><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>m.root-servers.net</span></code></pre></div>
<h2 data-number="31.5" id="example-run-1" d__=""><span class="header-section-number">31.5</span> Example Run</h2>
<p d__="">Let’s start by doing a query on a computer called <code s__="13">www.example.com</code>. We need to know its IP address. We don’t know which name server is responsible for the <code s__="13">example.com</code> domain. All we know is our list of root name servers.</p>
<ol type="1">
<li><p d__="">Let’s choose a random root server, say <code s__="13">c.root-servers.net</code>. We’ll contact it and say, “Hey, we’re looking for <code s__="13">www.example.com</code>. Can you help us?”</p>
<p d__="">But the root name server doesn’t know that. It says, “I don’t know about that, but I can tell you if you’re looking for any <code s__="13">.com</code> domain, you can contact any one of these name servers.” It attaches a list of name servers who know about the <code s__="13">.com</code> domains:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb199-1" d__=""><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>a.gtld-servers.net</span>
<span id="cb199-2" d__=""><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>b.gtld-servers.net</span>
<span id="cb199-3" d__=""><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>c.gtld-servers.net</span>
<span id="cb199-4" d__=""><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>d.gtld-servers.net</span>
<span id="cb199-5" d__=""><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>e.gtld-servers.net</span>
<span id="cb199-6" d__=""><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a>f.gtld-servers.net</span>
<span id="cb199-7" d__=""><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>g.gtld-servers.net</span>
<span id="cb199-8" d__=""><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a>h.gtld-servers.net</span>
<span id="cb199-9" d__=""><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>i.gtld-servers.net</span>
<span id="cb199-10" d__=""><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a>j.gtld-servers.net</span>
<span id="cb199-11" d__=""><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a>k.gtld-servers.net</span>
<span id="cb199-12" d__=""><a href="#cb199-12" aria-hidden="true" tabindex="-1"></a>l.gtld-servers.net</span>
<span id="cb199-13" d__=""><a href="#cb199-13" aria-hidden="true" tabindex="-1"></a>m.gtld-servers.net</span></code></pre></div></li>
<li><p d__="">So we choose one of the <code s__="13">.com</code> name servers.</p>
<p d__="">“Hey <code s__="13">h.gtld-servers.net</code>, we’re looking for <code s__="13">www.example.com</code>. Can you help us?”</p>
<p d__="">And it answers, “I don’t know that name, but I do know the name servers for <code s__="13">example.com</code>. You can talk to one of them. It attaches the list of name servers who know about the <code s__="13">example.com</code> domain:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb200-1" d__=""><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>a.iana-servers.net</span>
<span id="cb200-2" d__=""><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a>b.iana-servers.net</span></code></pre></div></li>
<li><p d__="">So we choose one of those servers.</p>
<p d__="">“Hey <code s__="13">a.iana-servers.net</code>, we’re looking for <code s__="13">www.example.com</code>. Can you help us?”</p>
<p d__="">And that name server answers, “Yes, I can! I know that name! Its IP address is <code s__="13">93.184.216.34</code>!”</p></li>
</ol>
<p d__="">So for any lookup, we start with root name server and it 
directs us on where to go to find more info. (Unless the information has
 been cached somewhere, but more on that later.)</p>
<h2 data-number="31.6" id="zones" d__=""><span class="header-section-number">31.6</span> Zones</h2>
<p d__="">The Domain Name System is split into logical administrative <em>zones</em>. A zone is, loosely, a collection of domains under the authority of a particular name server.</p>
<p d__="">But that’s an oversimplification. There could be one or more 
domains in the same zone. And there could be a number of name servers 
working in that same zone.</p>
<p d__="">Think of the zones as all the domains and subdomains some administration is responsible for.</p>
<p d__="">For example, in the root zone, we saw there were a number of name servers responsible for that lookup. And also in the <code s__="13">.com</code> zone, there were a number of different name servers there with authority.</p>
<h2 data-number="31.7" id="resolver-library" d__=""><span class="header-section-number">31.7</span> Resolver Library</h2>
<p d__="">When you write software that uses domain names, it calls a 
library to do the DNS lookup. You might have noticed that in Python when
 you called:</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb201-1" d__=""><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>s.<span class="ex">connect</span>((<span class="st" d__="">"example.com"</span>, <span class="dv" d__="">80</span>))</span></code></pre></div>
<p d__="">you didn’t have to worry about DNS at all. Behind the scenes, Python did all that work of looking up that domain in DNS.</p>
<p d__="">In C, there’s a function called <code s__="13">getaddrinfo()</code> that does the same thing.</p>
<p d__="">The short of it is that there’s a library that we can use and we don’t have to write all that code ourselves.</p>
<p d__="">The OS also has a record containing its default name server to
 use for lookups. (This is sometimes configured by hand, but more 
commonly is configured through <a href="https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol" d__="">DHCP</a>.) So when you request a lookup, your computer first goes to this server.</p>
<p d__="">But wait a minute–how does that tie into the whole root server hierarchy thing?</p>
<p d__="">The answer: caching!</p>
<h2 data-number="31.8" id="caching-servers" d__=""><span class="header-section-number">31.8</span> Caching Servers</h2>
<p d__="">Imagine all the DNS lookups that are happening globally. If we had to go to the root servers for <em>every</em> request, not only would that take a long time for repeated requests, but the root servers would get absolutely hammered.</p>
<p d__="">To avoid this, all DNS resolver libraries and DNS servers <em>cache</em> their results.</p>
<blockquote>
<p d__="">As it is, the root servers handle literally trillions of requests per day.</p>
</blockquote>
<p d__="">This way we can avoid overloading the root servers with repeated requests.</p>
<p d__="">So we’re going to have to amend the outline we already went over.</p>
<ol type="1">
<li><p d__="">Ask our resolver library for the IP address. If it has it cached, it will return it.</p></li>
<li><p d__="">If it doesn’t have it, ask our local name server for the IP address. If it has it cached, it will return it.</p></li>
<li><p d__="">If it’s not cached <strong>and</strong> if this name 
server has another upstream name server (that is, another nameserver it 
can appeal to for answers), it asks that name server for the answer.</p></li>
<li><p d__="">If it’s not cached <strong>and</strong> if this name 
server does not have another upstream name server, it goes to the root 
servers and the process continues as before.</p></li>
</ol>
<p d__="">With all these possible opportunities to get a cached result, it really helps take the load off the root name servers./</p>
<p d__="">Lots of WiFi routers you get also run caching name servers. So
 when DHCP configures your computer, your computer uses your router as a
 DNS server for the computers on your LAN. This gives you a snappy 
response for DNS lookups since you have a really short ping time to your
 router.</p>
<h3 data-number="31.8.1" id="time-to-live" d__=""><span class="header-section-number">31.8.1</span> Time To Live</h3>
<p d__="">Since the IP address for a domain or host might change, we have to have a way to expire cache entries.</p>
<p d__="">This is done through a field in the DNS record called <em>time to live</em>
 (TTL). This is the number of seconds a server should cache the results.
 It’s commonly set to 86400 seconds (1 day), but could be more or less 
depending on how often a zone administrator thinks an IP address will 
change.</p>
<p d__="">When a cache entry expires, the name server will have to once 
again ask for the data from upstream or the root servers if someone 
requests it.</p>
<h2 data-number="31.9" id="record-types" d__=""><span class="header-section-number">31.9</span> Record Types</h2>
<p d__="">So far, we’ve talked about using DNS to map a host or domain 
name to an IP address. This is one of the types of records stored for a 
domain on a DNS server.</p>
<p d__="">The common record types are:</p>
<ul>
<li><p d__=""><code s__="13">A</code>: An address record for IPv4. This 
is the type of record we’ve been talking about this whole time. Answers 
the question, “What is the IPv4 address for this host or domain?”</p></li>
<li><p d__=""><code s__="13">AAAA</code>: An address record for IPv6. Answers the question, “What is the IPv6 address for this host or domain?”</p></li>
<li><p d__=""><code s__="13">NS</code>: A name server record for a 
particular domain. Answers the question, “What are the name servers 
answering for this host or domain?”</p></li>
<li><p d__=""><code s__="13">MX</code>: A mail exchange record. Answers the question, “What computers are responsible for handling mail on this domain?”</p></li>
<li><p d__=""><code s__="13">TXT</code>: A text record. Holds free-form text information. Is sometimes used for anti-spam purposes and proof-of-ownership of a domain.</p></li>
<li><p d__=""><code s__="13">CNAME</code>: A canonical name record. 
Think of this as an alias. Makes the statement, “Domain xyz.example.com 
is an alias for abc.example.com.”</p></li>
<li><p d__=""><code s__="13">SOA</code>: A start of authority record. This contains information about a domain, including its main name server and contact information.</p></li>
</ul>
<p d__="">There are <a href="https://en.wikipedia.org/wiki/List_of_DNS_record_types" d__="">a lot of DNS record types</a>.</p>
<h2 data-number="31.10" id="dynamic-dns" d__=""><span class="header-section-number">31.10</span> Dynamic DNS</h2>
<p d__="">Typical users of the Internet don’t have a <em>static IP address</em>
 (that is, dedicated or unchanging) at their house. If they reboot their
 modem, their ISP might hand them a different IP address.</p>
<p d__="">This causes a ruckus with DNS because any DNS records pointing to their public IPs would be out of date.</p>
<p d__="">Dynamic DNS (DDNS) aims to solve this problem.</p>
<p d__="">In a nutshell, there are two mechanisms at play:</p>
<ol type="1">
<li><p d__="">A way for a client to tell the DDNS server what their IP address is.</p></li>
<li><p d__="">A very short TTL on the DDNS server for that record.</p></li>
</ol>
<p d__="">While DNS defines a way to send update records, a common other
 way is for a computer on your LAN to periodically (e.g.&nbsp;every 10 
minutes) contact the DDNS provider with an authenticated HTTP request. 
The DDNS server will see the IP address it came from and use that to 
update its record.</p>
<h2 data-number="31.11" id="reverse-dns" d__=""><span class="header-section-number">31.11</span> Reverse DNS</h2>
<p d__="">What if you have a dots-and-numbers IP address and want the host name for that IP? You can do a <em>reverse DNS</em> lookup.</p>
<p d__="">Note that not all IP addresses have such records, and often a reverse DNS query will come up empty.</p>
<h2 data-number="31.12" id="reflect-16" d__=""><span class="header-section-number">31.12</span> Reflect</h2>
<ul>
<li><p d__="">What is your name server for your computer right now? Search the net for how to look it up on your particular OS.</p></li>
<li><p d__="">Do the root name servers know every IP address in the world?</p></li>
<li><p d__="">Why would anyone use dynamic DNS?</p></li>
<li><p d__="">What is TTL used for?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="32" id="network-address-translation-nat" d__=""><span class="header-section-number">32</span> Network Address Translation (NAT)</h1>
<p d__="">In this chapter we’ll be taking a look at <em>network address translation</em>, or NAT.</p>
<p d__="">This is a service provided on a router which hides a “private” LAN from the rest of the world.</p>
<p d__="">The router acts as a middleman, translating internal IP 
addresses to a single external IP address. It keeps a table of these 
connections so when packets arrive on either interface, the router can 
rewrite them appropriately.</p>
<p d__="">We say the LAN behind the NAT router is a “private network”, 
and the external IP address the router presents for that LAN is the 
“public IP”.</p>
<h2 data-number="32.1" id="a-snail-mail-analogy" d__=""><span class="header-section-number">32.1</span> A Snail-Mail Analogy</h2>
<p d__="">Imagine how an anonymous snail-mail program might work.</p>
<p d__="">You write a letter addressed to the recipient with your return address on it.</p>
<p d__="">Instead of mailing it directly, you hand the letter to an 
anonymizer. The anonymizer removes your letter from the envelope and 
puts it in another envelope with the same recipient, but replaces the 
return address with the anonymnizer’s address. It also records that this
 sender wrote a letter to this recipient.</p>
<p d__="">The recipient gets the letter. All they see is the anonymizer’s return address on the letter.</p>
<p d__="">The recipient responds to the letter, and sends the response 
back to the anonymizer. The recipient lists themselves as the return 
address.</p>
<p d__="">The anonymizer receives the mail and notes it’s from the 
recipient. It looks in its records to determine the person who 
originally sent a message to the recipient.</p>
<p d__="">The anonymizer takes the response out of the envelope and puts
 it in a new envelope with the destination address being the original 
sender, and the return address remaining the original recipient.</p>
<p d__="">The original sender receives the response.</p>
<p d__="">Note that the original recipient never knew the original sender’s address; they only knew the anonymizer’s address.</p>
<h2 data-number="32.2" id="why" d__=""><span class="header-section-number">32.2</span> Why?</h2>
<p d__="">NAT is very, very common. It almost certainly runs on every IPv4 LAN.</p>
<p d__="">But why?</p>
<p d__="">There are two main reasons to use this type of service.</p>
<ol type="1">
<li><p d__="">You want to hide your network details from the rest of the world.</p></li>
<li><p d__="">You need more IP addresses than either (a) anyone is willing to allocate to you or (b) you’re willing to pay for.</p></li>
</ol>
<h3 data-number="32.2.1" id="hiding-your-network" d__=""><span class="header-section-number">32.2.1</span> Hiding Your Network</h3>
<p d__="">There’s no easy way to get random, unsolicited packets onto the private network through the gateway running NAT.</p>
<blockquote>
<p d__="">You can possibly do it with something called <em>source routing</em>, but that’s not commonly enabled by ISPs.</p>
</blockquote>
<p d__="">You’d have to have the private IP on the packet <strong>and</strong>
 get that packet to the router. There’s no way to do this unless you’re 
on the same LAN as the router, and that’s really unlikely.</p>
<p d__="">Regarding the second point, we should talk about the phenomenon known as <em>address space exhaustion</em>.</p>
<h3 data-number="32.2.2" id="ipv4-exhaustion" d__=""><span class="header-section-number">32.2.2</span> IPv4 Exhaustion</h3>
<p d__="">There are really a limited number of IPv4 addresses in the world. As such, getting a large block of them costs a lot of money.</p>
<p d__="">It’s a lot cheaper to get just a handful of addresses (e.g.&nbsp;a <code s__="13">/20</code> or <code s__="13">/24</code> or <code s__="13">/4</code> network) and then have large private networks behind NAT routers. This way you can have a <em>lot</em> of IPs, but they all present to the world as coming from the single public IP.</p>
<p d__="">This is really the motivation behind using NAT everywhere. 
There was a time when we were genuinely about to run out of IPv4 
addresses, and NAT saved us.</p>
<h2 data-number="32.3" id="private-networks-1" d__=""><span class="header-section-number">32.3</span> Private Networks</h2>
<p d__="">There are subnets that are reserved for use as private 
networks. Routers don’t forward these addresses directly. If a router on
 the greater Internet sees an IP from one of these subnets, it will drop
 it.</p>
<p d__="">For IPv4 there are three such subnets:</p>
<ul>
<li><code s__="13" d__="">10.0.0.0/8</code></li>
<li><code s__="13" d__="">172.16.0.0/12</code></li>
<li><code s__="13" d__="">192.168.0.0/16</code></li>
</ul>
<p d__="">The last of these is really common on household LANs.</p>
<p d__="">Again, routers on the Internet will drop packets with these 
addresses. The only way data gets from these IPs onto the Internet is 
via NAT.</p>
<h2 data-number="32.4" id="how-it-works" d__=""><span class="header-section-number">32.4</span> How it Works</h2>
<p d__="">For this demo, we’re going to use <code s__="13">IP:port</code> notation. The number after the colon is the port number.</p>
<p d__="">Also, we’ll use the term “Local Computer” to refer to the 
computer on the LAN, and “Remote Computer” or “Remote Server” to refer 
to the distant computer it’s connecting to.</p>
<p d__="">And finally, the local LAN router will just be called “The Router” or the “NAT Router”.</p>
<p d__="">Let’s go!</p>
<p d__="">On my LAN, I want to go from <code s__="13">192.168.1.2:1234</code> on my private LAN to the public address <code s__="13">203.0.113.24:80</code>–that’s port <code s__="13">80</code>, the HTTP server.</p>
<p d__="">The first thing my computer does is check to see if the destination IP address is on my LAN… Since my LAN is <code s__="13">192.168.0.0/16</code> or smaller, then no, it’s not.</p>
<p d__="">So my computer sends it to the default gateway, my router that has NAT enabled.</p>
<p d__="">The router is going to play the role of the “anonymizer” 
middleman in the earlier analogy example. And recall that the router has
 two interfaces on it–one faces the internal <code s__="13">192.168.0.0/16</code> private LAN, and the other faces the greater Internet with a public, external IP. Let’s use <code s__="13">192.168.1.1</code> as the private IP address on the router and <code s__="13">198.51.100.99</code> as the public IP.</p>
<p d__="">So the LAN looks like this:</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb202-1" d__=""><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>+----------+-------------+</span>
<span id="cb202-2" d__=""><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a>|  Local   |             |</span>
<span id="cb202-3" d__=""><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a>| Computer | 192.168.1.2 |&gt;-------+</span>
<span id="cb202-4" d__=""><a href="#cb202-4" aria-hidden="true" tabindex="-1"></a>+----------+-------------+        |</span>
<span id="cb202-5" d__=""><a href="#cb202-5" aria-hidden="true" tabindex="-1"></a>                                  |</span>
<span id="cb202-6" d__=""><a href="#cb202-6" aria-hidden="true" tabindex="-1"></a>                                  ^</span>
<span id="cb202-7" d__=""><a href="#cb202-7" aria-hidden="true" tabindex="-1"></a>                          +---------------+</span>
<span id="cb202-8" d__=""><a href="#cb202-8" aria-hidden="true" tabindex="-1"></a>                          |  192.168.1.1  |  Internal IP</span>
<span id="cb202-9" d__=""><a href="#cb202-9" aria-hidden="true" tabindex="-1"></a>                          +---------------+</span>
<span id="cb202-10" d__=""><a href="#cb202-10" aria-hidden="true" tabindex="-1"></a>                          |    Router     |  NAT-enabled</span>
<span id="cb202-11" d__=""><a href="#cb202-11" aria-hidden="true" tabindex="-1"></a>                          +---------------+</span>
<span id="cb202-12" d__=""><a href="#cb202-12" aria-hidden="true" tabindex="-1"></a>                          | 198.51.100.99 |  External IP</span>
<span id="cb202-13" d__=""><a href="#cb202-13" aria-hidden="true" tabindex="-1"></a>                          +---------------+</span>
<span id="cb202-14" d__=""><a href="#cb202-14" aria-hidden="true" tabindex="-1"></a>                                  v</span>
<span id="cb202-15" d__=""><a href="#cb202-15" aria-hidden="true" tabindex="-1"></a>                                  |</span>
<span id="cb202-16" d__=""><a href="#cb202-16" aria-hidden="true" tabindex="-1"></a>                                  |</span>
<span id="cb202-17" d__=""><a href="#cb202-17" aria-hidden="true" tabindex="-1"></a>                       {The Greater Internet}</span></code></pre></div>
<p d__="">The router now has to “repackage” the data for the greater 
Internet. This means rewriting the packet source to be from the router’s
 public IP and some unused port on the public interface of the router. 
(The port doesn’t need to be the same as the port originally on the 
packet. The router allocates a random unused port when the new packet is
 sent out.))</p>
<p d__="">So the router records all this information:</p>
<!-- CAPTION: NAT router connection record -->
<table>
<thead>
<tr>
<th d__="">Computer</th>
<th d__="">IP</th>
<th d__="">Port</th>
<th d__="">Protocol</th>
</tr>
</thead>
<tbody>
<tr>
<td d__="">Local Private Address</td>
<td d__="">192.168.1.2</td>
<td d__="">1234</td>
<td d__="">TCP</td>
</tr>
<tr>
<td d__="">Remote Public Address</td>
<td d__="">203.0.113.24</td>
<td d__="">80</td>
<td d__="">TCP</td>
</tr>
<tr>
<td d__="">Router Public Address</td>
<td d__="">198.51.100.99</td>
<td d__="">5678</td>
<td d__="">TCP</td>
</tr>
</tbody>
</table>
<p d__="">(Note: except for <code s__="13">80</code>, since we’re connecting to HTTP in this example, all port numbers were randomly chosen.)</p>
<p d__="">So while the original packet was:</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb203-1" d__=""><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>192.168.1.2:1234 --&gt; 203.0.113.24:80</span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-3" d__=""><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>     Local               Remote</span>
<span id="cb203-4" d__=""><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>    Computer            Computer</span></code></pre></div>
<p d__="">the NAT router rewrites it to be the same destination, but the router as the source.</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb204-1" d__=""><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>198.51.100.99:5678 --&gt; 203.0.113.24:80</span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-3" d__=""><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>    NAT router             Remote</span>
<span id="cb204-4" d__=""><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>                          Computer</span></code></pre></div>
<p d__="">From the destination’s point of view, it is completely unaware that this isn’t originally from the router itself.</p>
<p d__="">So the destination replies with some HTTP data, sending it back to the router:</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb205-1" d__=""><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>203.0.113.24:80 --&gt; 198.51.100.99:5678</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-3" d__=""><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>    Remote              NAT router</span>
<span id="cb205-4" d__=""><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>   Computer</span></code></pre></div>
<p d__="">The router then looks at its records. It says, “Wait a moment–if I get data on port <code s__="13">5678</code>, that means I need to translate this back to a private IP on the LAN!</p>
<p d__="">So it translates the message so that it’s no longer addressed 
to the router, but instead is sent to the private source IP recorded 
earlier:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb206-1" d__=""><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>203.0.113.24:80 --&gt; 192.168.1.2:1234</span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-3" d__=""><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>    Remote               Local</span>
<span id="cb206-4" d__=""><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a>   Computer             Computer</span></code></pre></div>
<p d__="">And sends that out on the LAN. And its received! The LAN 
computer thinks it’s talking to the remote server, and the remote server
 thinks it’s talking to the router! NAT!</p>
<p d__="">It might be a little confusing in that last step that the 
packet is coming from the NAT router but is actually IP addressed like 
it came from the Remote Computer. This is OK on the LAN because the NAT 
router sends that IP packet out with an Ethernet address of the Local 
Computer on the LAN. Or, put another way, the NAT router can use link 
layer addressing to get the packet delivered to the Local Computer and 
the IP address of where that packet came from doesn’t have to match the 
internet IP of the NAT router.</p>
<h2 data-number="32.5" id="nat-and-ipv6" d__=""><span class="header-section-number">32.5</span> NAT and IPv6</h2>
<p d__="">Since IPv6 has <em>tons</em> of addresses, do we really need 
NAT? And the technical answer is “no”. Part of the reason IPv6 came 
about was to get rid of this nasty NAT middleman business.</p>
<p d__="">That said, there is a reserved IPv6 subnet for private networks:</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb207-1" d__=""><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a>fd00::/8</span></code></pre></div>
<p d__="">There’s some additional structure in the “host” portion of the address, but you can <a href="https://en.wikipedia.org/wiki/Unique_local_address#Definition" d__="">read about it on Wikipedia</a> if you want.</p>
<p d__="">Like the IPv4 private subnets, IP addresses from this subnet are dropped by routers on the greater Internet.</p>
<p d__="">NAT doesn’t work for IPv6, but there is another way to do the translation with <a href="https://en.wikipedia.org/wiki/IPv6-to-IPv6_Network_Prefix_Translation" d__="">network prefix translation</a>.</p>
<p d__="">But what about the whole idea that people can’t easily get 
unsolicited packets onto your LAN? Well, you’re just going to have to 
configure your firewall properly to keep people out. But that’s a story 
for another time.</p>
<h2 data-number="32.6" id="port-forwarding" d__=""><span class="header-section-number">32.6</span> Port Forwarding</h2>
<p d__="">If you have a server running behind the NAT router, how can it
 serve content to the outside world? After all, no one on the outside 
can refer to it by its internal IP address–all they can see is the 
router’s external IP.</p>
<p d__="">But you can configure the NAT router to do something called <em>port forwarding</em>.</p>
<p d__="">For example, you could tell it that traffic sent to its public IP port 80 should be <em>forwarded</em>
 to some private IP on port 80. The router forwards the traffic, and the
 original sender is unaware that its traffic is ultimately arriving at a
 private IP.</p>
<p d__="">There’s no reason the same port must be used.</p>
<p d__="">For example, SSH uses port 22, and that’s fine on the computer
 on the private network. But if you forward from the public port 22, 
you’ll find malicious actors are continuously trying to log in through 
it. (Yes, even on your computer at home.) So it’s more common to use 
some other uncommon port as the public SSH port, and then forward it to 
port 22 on the LAN.</p>
<h2 data-number="32.7" id="review" d__=""><span class="header-section-number">32.7</span> Review</h2>
<ul>
<li><p d__="">Look up your computer’s internal IP address. (Might have to search the net to see how to do this.) Then go to <a href="https://google.com/" d__="">google.com</a> and type “what is my ip”. The numbers are (very probably) different. Why?</p></li>
<li><p d__="">What problems does NAT solve?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="33" id="dynamic-host-configuration-protocol-dhcp" d__=""><span class="header-section-number">33</span> Dynamic Host Configuration Protocol (DHCP)</h1>
<p d__="">When you first open your laptop at the coffee shop, it doesn’t have an IP address. It doesn’t even know what IP address it <em>should</em> have. Or what its name servers are. Or what its subnet mask is.</p>
<p d__="">Of course, you could manually configure it! Just type in the numbers that the cashier hands you with your coffee!</p>
<p d__="">OK, that doesn’t happen. No one would bother. Or they’d use a 
duplicate address. And things wouldn’t work. And they’d probably 
rage-drink their coffee and never return.</p>
<p d__="">It would be better if there were a way to automatically configure a computer that just arrived on the network, wouldn’t it?</p>
<p d__="">That’s what the <em>Dynamic Host Configuration Protocol</em> (DHCP) is for.</p>
<h2 data-number="33.1" id="operation" d__=""><span class="header-section-number">33.1</span> Operation</h2>
<p d__="">The overview:</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb208-1" d__=""><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>Client --&gt; [DHCPDISCOVER packet] --&gt; Server</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-3" d__=""><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>Client &lt;-- [DHCPOFFER packet] &lt;-- Server</span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-5" d__=""><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>Client --&gt; [DHCPREQUEST packet] --&gt; Server</span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-7" d__=""><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>Client &lt;-- [DHCPACK packet] &lt;-- Server</span></code></pre></div>
<p d__="">The details:</p>
<p d__="">When your laptop first tries to connect to the network, it sends a <code s__="13">DHCPDISCOVER</code> packet to the broadcast address (<code s__="13">255.255.255.255</code>) over UDP to port <code s__="13">67</code>, the DHCP server port.</p>
<p d__="">Recall that the broadcast address only propagates on the LAN–the default gateway does not forward it.</p>
<p d__="">On the LAN is another computer acting as the DHCP server. There’s a process running on it waiting on port <code s__="13">67</code>.</p>
<p d__="">The DHCP server process sees the DISCOVER and decides what to do with it.</p>
<p d__="">The typical use is that the client wants an IP address. We call this <em>leasing</em> an IP from the DHCP server. The DHCP server is tracking which IPs have been allocated and which are free out of its pool.</p>
<p d__="">In response to the <code s__="13">DHCPDISCOVER</code> packet, the DHCP server sends a <code s__="13">DHCPOFFER</code> response back to the client on port <code s__="13">68</code>.</p>
<p d__="">The offer contains an IP address and potentially a lot of other pieces of information including, but not limited to:</p>
<ul>
<li d__="">Subnet mask</li>
<li d__="">Default gateway address</li>
<li d__="">The lease time</li>
<li d__="">DNS servers</li>
</ul>
<p d__="">The client can accept or ignore the offer. (Maybe there are 
multiple DHCP servers making offers, but the client may only accept one 
of them.)</p>
<p d__="">If the offer is accepted, the client sends a <code s__="13">DHCPREQUEST</code> back to the server notifying it that it wants that particular IP address.</p>
<p d__="">Finally, if all’s well, the server replies with an acknowledgment packet, <code s__="13">DHCPACK</code>.</p>
<p d__="">At that point, the client has all the information it needs to participate on the network.</p>
<h2 data-number="33.2" id="reflect-17" d__=""><span class="header-section-number">33.2</span> Reflect</h2>
<ul>
<li><p d__="">Reflect on the advantages of using something like DHCP over manually configuring the devices on your LAN.</p></li>
<li><p d__="">What types of information does a DHCP client receive from the DHCP server?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="34" id="project-digging-dns-info" d__=""><span class="header-section-number">34</span> Project: Digging DNS Info</h1>
<p d__="">The <code s__="13">dig</code> utility is a great command line tool for getting DNS information from your default name server, or from any name server.</p>
<h2 data-number="34.1" id="installation" d__=""><span class="header-section-number">34.1</span> Installation</h2>
<p d__="">On Macs:</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb209-1" d__=""><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install bind</span></code></pre></div>
<p d__="">On WSL:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb210-1" d__=""><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">sudo</span> apt install dnsutils</span></code></pre></div>
<h2 data-number="34.2" id="try-it-out-1" d__=""><span class="header-section-number">34.2</span> Try it Out</h2>
<p d__="">Type:</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb211-1" d__=""><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dig</span> example.com</span></code></pre></div>
<p d__="">and see what it gives back.</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb212-1" d__=""><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; example.com</span>
<span id="cb212-2" d__=""><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>;; global options: +cmd</span>
<span id="cb212-3" d__=""><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>;; Got answer:</span>
<span id="cb212-4" d__=""><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 60465</span>
<span id="cb212-5" d__=""><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a>;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-7" d__=""><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a>;; OPT PSEUDOSECTION:</span>
<span id="cb212-8" d__=""><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a>; EDNS: version: 0, flags:; udp: 1232</span>
<span id="cb212-9" d__=""><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a>;; QUESTION SECTION:</span>
<span id="cb212-10" d__=""><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a>;example.com.                   IN      A</span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-12" d__=""><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a>;; ANSWER SECTION:</span>
<span id="cb212-13" d__=""><a href="#cb212-13" aria-hidden="true" tabindex="-1"></a>example.com.            79753   IN      A       93.184.216.34</span>
<span id="cb212-14"><a href="#cb212-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-15" d__=""><a href="#cb212-15" aria-hidden="true" tabindex="-1"></a>;; Query time: 23 msec</span>
<span id="cb212-16" d__=""><a href="#cb212-16" aria-hidden="true" tabindex="-1"></a>;; SERVER: 1.1.1.1#53(1.1.1.1)</span>
<span id="cb212-17" d__=""><a href="#cb212-17" aria-hidden="true" tabindex="-1"></a>;; WHEN: Fri Nov 18 18:37:13 PST 2022</span>
<span id="cb212-18" d__=""><a href="#cb212-18" aria-hidden="true" tabindex="-1"></a>;; MSG SIZE  rcvd: 56</span></code></pre></div>
<p d__="">That’s a lot of stuff. But let’s look at these lines:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb213-1" d__=""><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>;; ANSWER SECTION:</span>
<span id="cb213-2" d__=""><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>example.com.            79753   IN      A       93.184.216.34</span></code></pre></div>
<p d__="">That’s the IP address for <code s__="13">example.com</code>! Notice the <code s__="13">A</code>? That means this is an address record.</p>
<p d__="">You can get other record types, as well. What if you want the mail exchange server for <code s__="13">oregonstate.edu</code>? You can put that on the command line:</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb214-1" d__=""><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dig</span> mx oregonstate.edu</span></code></pre></div>
<p d__="">We get:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb215-1" d__=""><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a>;; ANSWER SECTION:</span>
<span id="cb215-2" d__=""><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a>oregonstate.edu. 600 IN MX 5 oregonstate-edu.mail.protection.outlook.com.</span></code></pre></div>
<p d__="">Or if we want the name servers for <code s__="13">example.com</code>, we can:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb216-1" d__=""><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dig</span> ns example.com</span></code></pre></div>
<h2 data-number="34.3" id="time-to-live-ttl" d__=""><span class="header-section-number">34.3</span> Time To Live (TTL)</h2>
<p d__="">If you <code s__="13">dig</code> an <code s__="13">A</code> record, you’ll see a number on the line:</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb217-1" d__=""><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>;; ANSWER SECTION:</span>
<span id="cb217-2" d__=""><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>example.com.            78236   IN      A       93.184.216.34</span></code></pre></div>
<p d__="">In this case, it’s <code s__="13">78236</code>. This is the 
TTL of an entry in the cache. This is telling you that the name server 
you used has cached that IP address, and it won’t expire that cache 
entry until 78,236 more seconds have elapsed. (For reference, there are 
86,400 seconds in a day.)</p>
<h2 data-number="34.4" id="authoritative-servers" d__=""><span class="header-section-number">34.4</span> Authoritative Servers</h2>
<p d__="">If you get an entry that’s cached in your name server, you’ll see <code s__="13">AUTHORITY: 0</code> in the <code s__="13">dig</code> output:</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb218-1" d__=""><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>;; flags: qr rd ra ad; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span>
<span id="cb218-2" d__=""><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>                                            ^^^^^^^^^^^^</span></code></pre></div>
<p d__="">But if the entry comes directly from the name server that’s responsible for the domain, you’ll see <code s__="13">AUTHORITY: 1</code> (or some positive number).</p>
<h2 data-number="34.5" id="getting-the-root-name-servers" d__=""><span class="header-section-number">34.5</span> Getting the Root Name Servers</h2>
<p d__="">Just type <code s__="13">dig</code> and hit return and you’ll see all the root DNS servers, probably both their IPv4 (record type <code s__="13">A</code>) and IPv6 (record type <code s__="13">AAAA</code>) addresses</p>
<h2 data-number="34.6" id="digging-at-a-specific-name-server" d__=""><span class="header-section-number">34.6</span> Digging at a Specific Name Server</h2>
<p d__="">If you know a name server that you want to query, you can use an <code s__="13">@</code> sign to specify that server.</p>
<p d__="">Two popular free-to-use name servers are <code s__="13">1.1.1.1</code> and <code s__="13">8.8.8.8</code>.</p>
<p d__="">Let’s ask one of them for the IP of <code s__="13">example.com</code></p>
<div class="sourceCode" id="cb219"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb219-1" d__=""><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dig</span> @8.8.8.8 example.com</span></code></pre></div>
<p d__="">And we get our expected answer. (Though the TTL is probably 
different–these are different servers and their cache entries have 
different ages, after all.)</p>
<h2 data-number="34.7" id="digging-at-a-root-name-server" d__=""><span class="header-section-number">34.7</span> Digging at a Root Name Server</h2>
<p d__="">There were a bunch of root name servers, so let’s dig <code s__="13">example.com</code> at one of them:</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb220-1" d__=""><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dig</span> @l.root-servers.net example.com</span></code></pre></div>
<p d__="">We get some interesting results:</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb221-1" d__=""><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a>com.                    172800  IN      NS      a.gtld-servers.net.</span>
<span id="cb221-2" d__=""><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a>com.                    172800  IN      NS      b.gtld-servers.net.</span>
<span id="cb221-3" d__=""><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a>com.                    172800  IN      NS      c.gtld-servers.net.</span>
<span id="cb221-4" d__=""><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a>com.                    172800  IN      NS      d.gtld-servers.net.</span></code></pre></div>
<p d__="">and then some.</p>
<p d__="">That’s not <code s__="13">example.com</code>… and look–those are <code s__="13">NS</code> records, name servers.</p>
<p d__="">This is the root server telling us, “I don’t know who <code s__="13">example.com</code> is, but here are some name servers that know what <code s__="13">.com</code> is.”</p>
<p d__="">So we choose one of those and <code s__="13">dig</code> there:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb222-1" d__=""><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dig</span> @c.gtld-servers.net example.com</span></code></pre></div>
<p d__="">And we get:</p>
<div class="sourceCode" id="cb223"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb223-1" d__=""><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>example.com.            172800  IN      NS      a.iana-servers.net.</span>
<span id="cb223-2" d__=""><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a>example.com.            172800  IN      NS      b.iana-servers.net.</span></code></pre></div>
<p d__="">Same thing again, more <code s__="13">NS</code> name server records. This is the <code s__="13">c.gtld-servers.net</code> name server telling us, I don’t know the IP for <code s__="13">example.com</code>, but here are some name servers that might!”</p>
<p d__="">So we try again:</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb224-1" d__=""><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dig</span> @a.iana-servers.net example.com</span></code></pre></div>
<p d__="">And at last we get the <code s__="13">A</code> record with the IP!</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb225-1" d__=""><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>example.com.            86400   IN      A       93.184.216.34</span></code></pre></div>
<p d__="">You can also use <code s__="13">+trace</code> on the command line to watch the entire query from start to end:</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb226-1" d__=""><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dig</span> +trace example.com</span></code></pre></div>
<h2 data-number="34.8" id="what-to-do-1" d__=""><span class="header-section-number">34.8</span> What to Do</h2>
<p d__="">Try to answer the following:</p>
<ul>
<li><p d__="">What’s the IP address of <code s__="13">microsoft.com</code>?</p></li>
<li><p d__="">What’s the mail exchange for <code s__="13">google.com</code>?</p></li>
<li><p d__="">What are the name servers for <code s__="13">duckduckgo.com</code>?</p></li>
<li><p d__="">Following the process in the Digging from a Root Name 
Server in the section above, start with a root name server and dig your 
way down to <code s__="13">www.yahoo.com</code> (<strong>NOT</strong> <code s__="13">yahoo.com</code>).</p>
<p d__="">Note that this ends in a <code s__="13">CNAME</code> record! You’ll have to repeat the process with the alias named by the <code s__="13">CNAME</code> record starting from the root servers again.</p>
<p d__="">Add to your document the <code s__="13">dig</code> commands you used to get the IP address. Each <code s__="13">dig</code> command should be <code s__="13">@</code> a different name server, starting with the root.</p></li>
</ul>
<!-- Rubric

5
Submission properly shows IP of www.oregonstate.edu

5
Submission properly shows MX for google.com

5
Submission properly shows name servers for oregonstate.edu

15
Submission properly shows all dig queries to get the IP address of www.yahoo.com

-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="35" id="port-scanning" d__=""><span class="header-section-number">35</span> Port Scanning</h1>
<p d__=""><strong>A NOTE ON LEGALITY</strong>: It’s unclear whether or not it is legal to portscan a computer you do not own. We’ll be doing all our portscanning on <code s__="13">localhost</code>. <strong>Don’t portscan computers you do not have permission to!</strong></p>
<p d__="">A port scan is a method of determining which ports on a 
computer a ready to accept connections. In other words, which ports have
 a server listening on them.</p>
<p d__="">The port scan is often the first line of attack on a system. 
Before being able to connect to see if some vulnerabilities can be found
 in any listening servers, we need to know which servers are running in 
the first place.</p>
<h2 data-number="35.1" id="mechanics-of-a-portscanner" d__=""><span class="header-section-number">35.1</span> Mechanics of a Portscanner</h2>
<p d__="">A portscanner will attempt to find listening server processes 
on a range of ports on a specified IP. (Sometimes the range is all 
ports.)</p>
<p d__="">With TCP, the general approach is to try to set up a connection with the <code s__="13">connect()</code>
 call on the candidate port. If it works, we have an open port, and the 
portscanner outputs that information. Nothing is sent over the 
connection, and it is closed immediately.</p>
<blockquote>
<p d__="">The job of the portscanner is to identify open ports, not to send or receive other data unnecessarily.</p>
</blockquote>
<p d__="">Calling <code s__="13">connect()</code> causes the TCP 
connection to complete its three-way handshake. This isn’t strictly 
necessary, since if the portscanner gets any reply from the server 
(i.e.&nbsp;the second part of the three way handshake) then we know the 
port is open. Completing the handshake would cause the remote OS to wake
 up the server on that port for a connection we know we’re just going to
 close anyway.</p>
<p d__="">Some TCP portscanners will instead build a TCP SYN packet to 
start the handshake and send that to the port. If they get a SYN-ACK 
reply, they know the port is open. But then, instead of completing the 
handshake with an ACK, they send a RST (reset) causing the remote OS to 
terminate the nascent connection entirely–and causing it to not wake up 
the server on that port.</p>
<blockquote>
<p d__="">You can write software that builds custom TCP packets with <a href="https://en.wikipedia.org/wiki/Network_socket#Types" d__="">raw sockets</a>. Usually you need to be a superuser/admin to use these.</p>
</blockquote>
<h3 data-number="35.1.1" id="portscanning-udp" d__=""><span class="header-section-number">35.1.1</span> Portscanning UDP</h3>
<p d__="">Since there is no connection with UDP, port scans are a little less exact.</p>
<p d__="">One technique is to send a UDP packet to a port and see if you get an <a href="https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol" d__="">ICMP</a> “destination unreachable” message back. If so, the port is not open.</p>
<p d__="">If you don’t get a response, <em>maybe</em> the port is open. Or maybe the UDP packet is being filtered out and dropped with no ICMP response.</p>
<p d__="">Another option is to send a UDP packet to a known port that 
might have a server behind it. If you get a response from the server, 
you know the port is open. If not, it’s closed or your traffic was 
filtered out.</p>
<h2 data-number="35.2" id="reflect-18" d__=""><span class="header-section-number">35.2</span> Reflect</h2>
<ul>
<li><p d__="">Why shouldn’t you portscan random computers on the Internet?</p></li>
<li><p d__="">What’s the purpose of using a portscanner?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="36" id="firewalls" d__=""><span class="header-section-number">36</span> Firewalls</h1>
<p d__="">A favorite component of every bad hacker movie ever is the <em>firewall</em>.
 It’s clear from those bad movies that it has something to do with 
security, but the exact role is ambiguous; it’s only apparent that a bad
 guy getting through the firewall is a bad thing.</p>
<p d__="">But back to reality: a firewall is a computer (often a router)
 that restricts certain types of traffic between one interface and 
another. So instead of forwarding every packet of every type from every 
port, it might decide to drop those packets instead.</p>
<p d__="">The upshot is that if someone in trying to connect to a port 
on the far side of a firewall, the firewall might prevent that 
connection depending on how it is configured.</p>
<p d__="">In this chapter, we’ll be speaking conceptually about 
firewalls, but won’t get into any specifics about practical 
configuration. There are many implementations of firewalls out there, 
and they all tend to have different methods of configuration.</p>
<h2 data-number="36.1" id="firewall-operation" d__=""><span class="header-section-number">36.1</span> Firewall Operation</h2>
<p d__="">If you think about a packet arriving at a router, that router 
has the capability to inspect that packet all it wants. It can look at 
the source and destination IPs, or the ports, or even the application 
layer data.</p>
<p d__="">So that gives it the opportunity to make a decision about 
whether or not to keep forwarding that packet based on any of that data.</p>
<p d__="">For example, the firewall might be configured to allow any 
port 80 (HTTP) traffic to come from the outside of the firewall to the 
inside, but block incoming traffic on all other destination ports.</p>
<p d__="">Or maybe it’ll be configured to only allow certain IP addresses to connect.</p>
<p d__="">So the firewall, on receipt of a packet, looks at its 
configured rules and decides whether or not to drop the packet (if it’s 
being filtered out), or forward the packet normally.</p>
<p d__="">When it decides to drop the packet, it has a more options. It can either silently drop it, or it can reply with a <a href="https://en.wikipedia.org/wiki/Internet_Control_Message_Protocol" d__="">ICMP</a> “destination unreachable” message.</p>
<p d__="">That basic filtering gives some a control, but there are still some things you might want to do that it can’t manage.</p>
<p d__="">For example, if someone behind the firewall establishes a TCP 
connection over the Internet from a random port, we want to be able to 
get traffic back to that host from that random port.</p>
<p d__="">With plain filtering, we’d just have to allow traffic on all those ports.</p>
<p d__="">But with <em>stateful filtering</em>, the firewall tracks the 
state of TCP connections that have been initiated from behind the 
firewall. The firewall sees the TCP three-way handshake and knows then 
that there is a valid connection. It can then safely allow traffic back 
that’s destined for the inside computer’s random port number.</p>
<p d__="">Stateful filtering is also used with UDP traffic, even though 
it’s connectionless. The firewall sees a UDP packet go out, and it’ll 
allow incoming UDP packets to that port. (For a while. Since it’s 
connectionless, there’s no way to tell when the server and client and 
done. So the firewall will timeout UDP rules after they haven’t been 
used for a while.)</p>
<blockquote>
<p d__="">In order to keep the firewall from timing-out on any of its rules, the programs can send <em>keepalive</em> messages. TCP actually has a specific message type for this, and the OS will periodically send empty <code s__="13">ACK</code> packets out to keep anyone from timing out. (If programming with sockets, you will likely need to set the <code s__="13">SO_KEEPALIVE</code> option.)</p>
<p d__="">The keepalive can also be effectively implemented by a program
 using UDP, as well. It could be configured to send a custom keepalive 
packet to the receiver (who would reply with some kind of ACK) every so 
often.</p>
<p d__="">Keepalive is only an issue for programs that have long periods of no network traffic.</p>
</blockquote>
<p d__="">Finally, filtering could also be done at the application 
layer. If the firewall digs deeply enough into the packet, it might see 
that it’s HTTP or FTP data, for example. With that knowledge, it could 
allow or deny all HTTP traffic, even if it’s arriving on a non-standard 
port.</p>
<h2 data-number="36.2" id="firewalls-and-nat" d__=""><span class="header-section-number">36.2</span> Firewalls and NAT</h2>
<p d__="">In a home network, it’s really common for the firewall to also be the router and the switch and do NAT.</p>
<p d__="">It’s all rolled into one.</p>
<p d__="">But there’s nothing stopping us from having a separate 
firewall computer on the network that only decides whether or not to 
allow traffic.</p>
<p d__="">And there’s no rule that one side of the firewall must be a 
private network and the other side a public network. Both sides could be
 private networks or public networks, or one private and one public.</p>
<p d__="">The role of the firewall at its core is not to separate public
 and private networks–that’s NAT’s role–but rather to control which 
traffic is allowed to pass through the firewall.</p>
<h2 data-number="36.3" id="local-firewalls" d__=""><span class="header-section-number">36.3</span> Local Firewalls</h2>
<p d__="">You can also set up a firewall just on your computer (and this
 is commonly done). Typically this is set up to allow all connections 
from the computer going out, but to restrict connections from other 
computers coming in.</p>
<p d__="">In MacOS and Windows, the firewall is something that can 
simply be turned on and then it will start blocking traffic based on 
some common rules.</p>
<p d__="">If you need some specific ports unblocked, you’ll have to manually add those.</p>
<p d__="">Linux has firewall support through a mechanism called <a href="https://en.wikipedia.org/wiki/Iptables" d__="">iptables</a>. This isn’t the most straightforward thing to configure, but it’s powerful enough to build a NAT router/firewall from scratch.</p>
<h2 data-number="36.4" id="reflect-19" d__=""><span class="header-section-number">36.4</span> Reflect</h2>
<ul>
<li><p d__="">What’s the difference/relationship between a firewall and a router?</p></li>
<li><p d__="">What’s the difference/relationship between a firewall and NAT?</p></li>
<li><p d__="">What’s the funniest or most painful thing in <a href="https://www.youtube.com/watch?v=u8qgehH3kEQ" d__="">this NCIS clip</a>?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="37" id="trusting-user-data" d__=""><span class="header-section-number">37</span> Trusting User Data</h1>
<blockquote>
<p d__="">“You won’t know who to trust…”</p>
<p d__="">–Gregor Ivanovich, <em>Sneakers</em></p>
</blockquote>
<p d__="">When your server receives data from someone on the Internet, it’s not good enough to trust that they have good intentions.</p>
<p d__="">There are lots of bad actors out there. You have to take steps
 to prevent them from sending things that crash your server processes 
or, worse, give them access to your server machine itself.</p>
<p d__="">In this chapter we’re going to take a high-level look at some issues that might arise from users trying to send malicious data.</p>
<p d__="">The two big ideas here are:</p>
<ul>
<li><p d__=""><em>Think like a villain</em>. What could someone pass your code that would crash it or make it behave in an unexpected way?</p></li>
<li><p d__="">Don’t trust <strong>anything</strong> from the remote side. Don’t trust that it will be a reasonable length. Don’t trust that it will contain reasonable data.</p></li>
</ul>
<h2 data-number="37.1" id="buffer-overflowoverrun" d__=""><span class="header-section-number">37.1</span> Buffer Overflow/Overrun</h2>
<p d__="">This is something that mostly affects memory-unsafe languages like C or C++.</p>
<p d__="">The idea is:</p>
<ol type="1">
<li><p d__="">Your program allocates a fixed size region of memory to use.</p></li>
<li><p d__="">Your program reads some data into that memory region over a network connection.</p></li>
<li><p d__="">The attacker sends more data than can fit in that memory region. This data is carefully constructed to contain a payload.</p></li>
<li><p d__="">Your program, without thinking about it, writes the data 
from the attacker, filling the memory region and overflowing into 
whatever is in memory after that.</p></li>
<li><p d__="">Depending on how things are written, the attacker could 
overwrite the return address value on the stack, causing the function to
 return into the attacker’s payload and run that. The payload 
manipulates the system to install a virus or change the system to 
otherwise allow remote access.</p></li>
</ol>
<p d__="">Modern OSes try to mitigate by making the stack and heap 
regions of memory non-executable, and the code region of memory 
non-writable.</p>
<p d__="">As a developer, you need to write code in C that properly 
performs bounds-checking and never writes to memory it doesn’t intend 
to.</p>
<h2 data-number="37.2" id="injection-attacks" d__=""><span class="header-section-number">37.2</span> Injection Attacks</h2>
<p d__="">These attacks are ones where you build a command using some data the user has provided to you. And then run that command.</p>
<p d__="">A malicious user can feed you data that causes another command to be run.</p>
<h3 data-number="37.2.1" id="system-commands" d__=""><span class="header-section-number">37.2.1</span> System Commands</h3>
<p d__="">In many languages, there’s a feature that allows you to run a command via the shell.</p>
<p d__="">For example, in Python you can run the <code s__="13">ls</code> command to get a directory listing like this:</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb227-1" d__=""><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">import</span> os</span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-3" d__=""><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st" d__="">"ls"</span>)</span></code></pre></div>
<p d__="">Let’s say you write a server that receives some data from a user. The user will send <code s__="13">1</code>, <code s__="13">2</code> or <code s__="13">3</code> as data, depending on the function they want to select.</p>
<p d__="">You run some code in your server like this:</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb228-1" d__=""><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a>os.system(<span class="st" d__="">"mycommand "</span> <span class="op" d__="">+</span> user_input)</span></code></pre></div>
<p d__="">So if the user sends <code s__="13">2</code>, it will run <code s__="13">mycommand 2</code> as expected and return the output to the user.</p>
<p d__="">To be safe, the <code s__="13">mycommand</code> program verifies that the only allowable inputs are <code s__="13">1</code>, <code s__="13">2</code>, or <code s__="13">3</code> and returns an error if something else is passed.</p>
<p d__="">Are we safe?</p>
<p d__="">No.&nbsp;Do you see how?</p>
<p d__="">The user could pass the input:</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb229-1" d__=""><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>1; cat /etc/passwd</span></code></pre></div>
<p d__="">This would cause the following to be executed:</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb230-1" d__=""><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>mycommand 1; cat /etc/passwd</span></code></pre></div>
<p d__="">The semicolon is the command separator in bash. This causes the <code s__="13">mycommand</code> program to execute, followed by a command that shows the contents of the Unix password file.</p>
<p d__="">To be safe, all the special characters in the input need to be stripped or escaped so that the shell doesn’t interpret them.</p>
<h3 data-number="37.2.2" id="sql-commands" d__=""><span class="header-section-number">37.2.2</span> SQL Commands</h3>
<p d__="">There’s a similar attack called SQL Injection, where a 
non-carefully crafted SQL query can allow a malicious user to execute 
arbitrary SQL queries.</p>
<p d__="">Let’s say you build a SQL query in Python like this, where we get the variable <code s__="13">username</code> over the network in some way:</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb231-1" d__=""><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a>q <span class="op" d__="">=</span> <span class="ss" d__="">f"SELECT * FROM users WHERE name = '</span><span class="sc" d__="">{</span>username<span class="sc" d__="">}</span><span class="ss" d__="">'</span></span></code></pre></div>
<p d__="">So if I enter <code s__="13">Alice</code> for the user, we get the following perfectly valid query:</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode sql"><code class="sourceCode sql" s__="13"><span id="cb232-1" d__=""><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">SELECT</span> <span class="op" d__="">*</span> <span class="kw" d__="">FROM</span> users <span class="kw" d__="">WHERE</span> name <span class="op" d__="">=</span> <span class="st" d__="">'Alice'</span></span></code></pre></div>
<p d__="">And then I run it, no problem.</p>
<p d__="">But let’s <em>think like a villain</em>.</p>
<p d__="">What if we entered this:</p>
<div class="sourceCode" id="cb233"><pre class="sourceCode sql"><code class="sourceCode sql" s__="13"><span id="cb233-1" d__=""><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a>Alice<span class="st" d__="">' or 1=1 --</span></span></code></pre></div>
<p d__="">Now we get this:</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode sql"><code class="sourceCode sql" s__="13"><span id="cb234-1" d__=""><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">SELECT</span> <span class="op" d__="">*</span> <span class="kw" d__="">FROM</span> users <span class="kw" d__="">WHERE</span> name <span class="op" d__="">=</span> <span class="st" d__="">'Alice'</span> <span class="kw" d__="">or</span> <span class="dv" d__="">1</span><span class="op" d__="">=</span><span class="dv" d__="">1</span> <span class="co" d__="">-- '</span></span></code></pre></div>
<p d__="">The <code s__="13">--</code> is a comment delimiter in SQL. Now we’ve put together a query that shows all user information, not just Alice’s.</p>
<p d__="">Not only that, but a naive implementation might also support the <code s__="13">;</code> command separator. If so, an attacker could do something like this:</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode sql"><code class="sourceCode sql" s__="13"><span id="cb235-1" d__=""><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>Alice<span class="st" d__="">'; SELECT * FROM passwords --</span></span></code></pre></div>
<p d__="">Now we get this command:</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode sql"><code class="sourceCode sql" s__="13"><span id="cb236-1" d__=""><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">SELECT</span> <span class="op" d__="">*</span> <span class="kw" d__="">FROM</span> users <span class="kw" d__="">WHERE</span> name <span class="op" d__="">=</span> <span class="st" d__="">'Alice'</span>; <span class="kw" d__="">SELECT</span> <span class="op" d__="">*</span> <span class="kw" d__="">FROM</span> passwords <span class="co" d__="">-- '</span></span></code></pre></div>
<p d__="">And we get the output from the <code s__="13">passwords</code> table.</p>
<p d__="">To avoid this trap, use <em>parameterized query generators</em>. This will be something in the SQL library that allows you to safely build a query with any user input.</p>
<p d__="">Never try to build the SQL string yourself.</p>
<h3 data-number="37.2.3" id="cross-site-scripting" d__=""><span class="header-section-number">37.2.3</span> Cross-Site Scripting</h3>
<p d__="">This is something that happens with HTML/JS.</p>
<p d__="">Let’s say you have a form that accepts a user comment, and then the server appends that comment to the web page.</p>
<p d__="">So if the user enters:</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb237-1" d__=""><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>This site has significant problems. I feel uncomfortable using it.</span>
<span id="cb237-2"><a href="#cb237-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb237-3" d__=""><a href="#cb237-3" aria-hidden="true" tabindex="-1"></a>Love, FriendlyTroll</span></code></pre></div>
<p d__="">That gets added to the end of the page.</p>
<p d__="">But if the user enters:</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode html"><code class="sourceCode html" s__="13"><span id="cb238-1" d__=""><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>LOL</span>
<span id="cb238-2" d__=""><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">&lt;</span><span class="kw" d__="">script</span><span class="dt" d__="">&gt;</span><span class="fu" d__="">alert</span>(<span class="st" d__="">"Pwnd!"</span>)<span class="dt" d__="">&lt;/</span><span class="kw" d__="">script</span><span class="dt" d__="">&gt;</span></span></code></pre></div>
<p d__="">Now everyone will see that alert box whenever they view the comments!</p>
<p d__="">And that’s a pretty innocuous example. The JavaScript could be
 anything and will be executed on the remote site (meaning it can 
perform API calls and fetches as that domain). It could also rewrite the
 page so that the login/password input submitted that information to the
 attacker’s website.</p>
<blockquote>
<p d__="">“It would be bad.”</p>
<p d__="">Egon Spengler, <em>Ghostbusters</em></p>
</blockquote>
<p d__="">Most HTML-oriented libraries come with a function to sterilize
 strings so that the browser will render them and not interpret them 
(e.g.&nbsp;all <code s__="13">&lt;</code> replaced with <code s__="13">&amp;gt;</code> and so on).</p>
<p d__="">Definitely run any user-generated data through such a function before displaying it on a browser.</p>
<h2 data-number="37.3" id="reflect-20" d__=""><span class="header-section-number">37.3</span> Reflect</h2>
<ul>
<li><p d__="">In general terms, what’s the problem with trusting user input?</p></li>
<li><p d__="">Why aren’t buffer overflows as much of a problem with languages like Python, Go, or Rust as they are with C?</p></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<h1 data-number="38" id="project-port-scanning" d__=""><span class="header-section-number">38</span> Project: Port Scanning</h1>
<p d__="">We’re going to do some port scanning!</p>
<p><strong d__="">NOTE: We’re only going to run this on <code s__="13">localhost</code> to avoid any legal trouble.</strong></p>
<p d__="">To make this happen, we need to install the <code s__="13">nmap</code> too.</p>
<p d__="">MacOS:</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb239-1" d__=""><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install nmap</span></code></pre></div>
<p d__="">Windows WSL:</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb240-1" d__=""><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">sudo</span> apt-get update</span>
<span id="cb240-2" d__=""><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">sudo</span> apt-get install nmap</span></code></pre></div>
<ol type="1">
<li><p><strong d__="">Portscan All Common Ports</strong></p>
<p d__="">This command will portscan 1000 of the most common ports:</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb241-1" d__=""><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">nmap</span> localhost</span></code></pre></div>
<p d__="">What’s the output?</p></li>
<li><p><strong d__="">Portscan All Ports</strong></p>
<p d__="">This will scan all the ports–starting from <code s__="13">0</code> on:</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb242-1" d__=""><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">nmap</span> <span class="at" d__="">-p0-</span> localhost</span></code></pre></div>
<p d__="">What’s the output?</p></li>
<li><p><strong d__="">Run a Server and Portscan</strong></p>
<p d__="">Run any TCP server program that you wrote this quarter on some port.</p>
<p d__="">Run the all-port scan again (above).</p>
<ul>
<li><p d__="">Notice your server’s port in the output!</p></li>
<li><p d__="">Does your server crash with a “Connection reset” error? If
 so, why? If not, speculate on why this might happen even if you didn’t 
see it from your server. (See the <a href="#port-scanning" d__="">Port Scanning chapter</a> for this!)</p></li>
</ul></li>
</ol>
<!-- Rubric

20 points

5
Appropriate output from `nmap localhost`

5
Appropriate output from `nmap -p0- localhost`

5
Appropriate output from `nmap -p0- localhost` that shows your server's open port

5
Explanation of the possible "Connection reset" error

-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="39" id="project-multiuser-chat-client-and-server" d__=""><span class="header-section-number">39</span> Project: Multiuser Chat Client and Server</h1>
<p d__="">It’s time to put it all together into this, the final project!</p>
<p d__="">We’re going to build a multiuser chat server and a chat client to go along with it.</p>
<p d__="">The chat server should allow an arbitrary number of 
connections from clients. All the clients will see what the other ones 
are saying.</p>
<p d__="">Not only that, but there should be messages for when a user joins or leaves the chat.</p>
<p d__="">Here’s a sample screenshot. The prompt where this user (“pat” 
in this example) is typing what they’re about to say. The region above 
it is where all the output accumulates.</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb243-1" d__=""><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>*** pat has joined the chat</span>
<span id="cb243-2" d__=""><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>pat: Hello?</span>
<span id="cb243-3" d__=""><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>*** leslie has joined the chat</span>
<span id="cb243-4" d__=""><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a>leslie: hi everyone!</span>
<span id="cb243-5" d__=""><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a>pat: hows it going</span>
<span id="cb243-6" d__=""><a href="#cb243-6" aria-hidden="true" tabindex="-1"></a>*** chris has joined the chat</span>
<span id="cb243-7" d__=""><a href="#cb243-7" aria-hidden="true" tabindex="-1"></a>chris: OK, now we can start!</span>
<span id="cb243-8" d__=""><a href="#cb243-8" aria-hidden="true" tabindex="-1"></a>pat: lol</span>
<span id="cb243-9" d__=""><a href="#cb243-9" aria-hidden="true" tabindex="-1"></a>leslie: Why are you always last?</span>
<span id="cb243-10" d__=""><a href="#cb243-10" aria-hidden="true" tabindex="-1"></a>*** chris has left the chat</span>
<span id="cb243-11"><a href="#cb243-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-12" d__=""><a href="#cb243-12" aria-hidden="true" tabindex="-1"></a>pat&gt; oh no!! :)█</span></code></pre></div>
<h2 data-number="39.1" id="overall-architecture" d__=""><span class="header-section-number">39.1</span> Overall Architecture</h2>
<p d__="">There will be one server, and it will handle many simultaneous clients.</p>
<h3 data-number="39.1.1" id="server" d__=""><span class="header-section-number">39.1.1</span> Server</h3>
<p d__="">The server will run using <code s__="13">select()</code> to handle multiple connections to see which ones are ready to read.</p>
<p d__="">The listener socket itself will also be included in this set. 
When it shows “ready-to-read”, it means there’s a new connection to be <code s__="13">accept()</code>ed.&nbsp;If
 any of the other already-accepted sockets show “ready-to-read”, it 
means the client has sent some data that needs to be handled.</p>
<p d__="">When the server get a chat packet from one client, it rebroadcasts that chat message to every connected client.</p>
<blockquote>
<p d__="">Note: when we use the term “broadcast” here, we’re using it in the generic sense of sending a thing to a lot of people. We’re <strong>not</strong> talking about IP or Ethernet broadcast addresses. We won’t use those in this project.</p>
</blockquote>
<p d__="">When a new client connects or disconnects, the server broadcasts that to all the clients, as well.</p>
<p d__="">Since multiple clients will be sending data streams to the server, the server needs to maintain a packet buffer <em>for each client</em>.</p>
<blockquote>
<p d__="">You can put this is a Python <code s__="13">dict</code> that uses the client’s socket itself as the key, so it maps from a socket to a buffer.</p>
</blockquote>
<p d__="">The server will be launched by specifying a port number on the command line. This is mandatory; there is no default port.</p>
<div class="sourceCode" id="cb244"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb244-1" d__=""><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> chat_server.py 3490</span></code></pre></div>
<h3 data-number="39.1.2" id="client" d__=""><span class="header-section-number">39.1.2</span> Client</h3>
<p d__="">When the client is launched, the user specifies their nickname
 (AKA “nick”) on the command line along with the server information.</p>
<p d__="">The very first packet it sends is a “hello” packet that has 
the nickname in it. (This is how the server associates a connection with
 a nick and rebroadcasts the connection event to the other clients.)</p>
<p d__="">After that, every line the user types into the client gets sent to the server as a chat packet.</p>
<p d__="">Every chat packet (or connect or disconnect packet) the client gets from the server is shown on the output.</p>
<p d__="">The client has a <strong>text user interface</strong> (TUI) 
that helps keep the output clean. Since the output is happening 
asynchronously on a different part of the screen than the input, we need
 to do some terminal magic to keep them from overwriting each other. 
This TUI code will be supplied and is described in the next section.</p>
<p d__="">Since there can be data arriving while the user is typing something, we need a way to handle that. The client will be <strong>multithreaded</strong>. There will be two threads of execution.</p>
<ul>
<li d__="">The main sending thread will:
<ul>
<li>Read keyboard input</li>
<li>Send chat messages from the user to the server</li>
</ul></li>
<li d__="">The receiving thread will:
<ul>
<li>Receive packets from the server</li>
<li>Display those results on-screen</li>
</ul></li>
</ul>
<p d__="">Since there is no shared data between those threads, no synchronization (mutexes, etc.) will be required.</p>
<blockquote>
<p d__="">They do share the socket, but the OS makes sure that it’s OK 
for multiple threads to use that at the same time without an issue. It’s
 <em>threadsafe</em>.</p>
</blockquote>
<p d__="">If you need more information on threading in Python, see the <a href="#appendix-threading" d__="">Appendix: Threading</a> section.</p>
<p d__="">The client will be started by specifying the user’s nickname, 
the server address, and the server port on the command line. These are 
all required arguments; there are no defaults.</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb245-1" d__=""><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> chat_client.py chris localhost 3490</span></code></pre></div>
<h2 data-number="39.2" id="client-io" d__=""><span class="header-section-number">39.2</span> Client I/O</h2>
<p d__="">The client screen is split into two main regions:</p>
<ul>
<li d__="">The input section, the last row or two of the screen.</li>
<li d__="">The output section, the remaining top part of the screen.</li>
</ul>
<p d__="">(The Client TUI section, below, has details about how to do this I/O.)</p>
<p d__="">The client input line at the bottom of the screen should be the user’s nickname followed by <code s__="13">&gt;</code> and a space. The input takes place after that:</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb246-1" d__=""><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>alice&gt; this is some sample input</span></code></pre></div>
<p d__="">The output area of the screen has two main types of messages:</p>
<ul>
<li><p d__=""><strong>Chat messages</strong>: these show the speaker nickname followed by <code s__="13">:</code> and a space, and then the message.</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb247-1" d__=""><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>pat: hows it going</span></code></pre></div></li>
<li><p d__=""><strong>Informational messages</strong>: these show when a user has joined or left the chat, or any other information that needs printing. They consist of <code s__="13">***</code> followed by a space, then the message. Joining and leaving messages are shown here:</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb248-1" d__=""><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>*** leslie has joined the chat</span>
<span id="cb248-2" d__=""><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>*** chris has left the chat</span></code></pre></div></li>
</ul>
<h3 data-number="39.2.1" id="special-user-input" d__=""><span class="header-section-number">39.2.1</span> Special User Input</h3>
<p d__="">If the user input begins with <code s__="13">/</code>, it has special meaning and should be parsed farther to determine the action.</p>
<p d__="">Currently, the only special input defined is <code s__="13">/q</code>:</p>
<ul>
<li d__=""><strong><code s__="13">/q</code></strong>: if the user enters this, the client should exit. Nothing is sent to the server in this case.</li>
</ul>
<h2 data-number="39.3" id="the-client-tui" d__=""><span class="header-section-number">39.3</span> The Client TUI</h2>
<p d__=""><a href="https://beej.us/guide/bgnet0/source/exercises/chat/chatui.zip" d__="">Download the Chat UI code and demo here</a><a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup s__="13" d__="">16</sup></a>.</p>
<p d__="">In the file <code s__="13">chatui.py</code>, there are four functions you need, and you can get them with this import:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb249-1" d__=""><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">from</span> chatui <span class="im" d__="">import</span> init_windows, read_command, print_message, end_windows</span></code></pre></div>
<p d__="">The functions are:</p>
<ul>
<li><p d__=""><strong>init_windows()</strong>: call this first before 
doing any other UI-oriented I/O of any kind. It should also be called 
before you start the receiver thread since that thread does I/O.</p></li>
<li><p d__=""><strong>end_windows()</strong>: call this when your program completes to clean everything up.</p></li>
<li><p d__=""><strong>read_command()</strong>: this prints a prompt out 
at the bottom of the screen and accepts user input. It returns the line 
the user entered once they hit the <code s__="13">ENTER</code> key.</p>
<p d__="">For example:</p>
<div class="sourceCode" id="cb250"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb250-1" d__=""><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>s <span class="op" d__="">=</span> read_command(<span class="st" d__="">"Enter something&gt; "</span>)</span></code></pre></div>
<p d__="">The function takes care of screen placement of the element.</p></li>
<li><p d__=""><strong>print_message()</strong>: Prints a message to the 
output portion of the screen. This handle scrolling and making sure the 
output doesn’t interfere with the input from <code s__="13">read_command()</code>.</p>
<p d__="">Do not include a newline in your output. It will be added automatically.</p></li>
</ul>
<p d__=""><strong>Known Bug</strong>: on Mac, if something gets written by <code s__="13">print_message()</code>, then next backspace you type will show a <code s__="13">^R</code> and scroll down a line. It’s unclear why this happens.</p>
<h3 data-number="39.3.1" id="curses-variant-of-chatui" d__=""><span class="header-section-number">39.3.1</span> Curses Variant of <code>chatui</code></h3>
<p d__="">If the <code s__="13">chatui</code> library is causing you trouble, you could try the alternate version <code s__="13">chatuicurses</code>. It has the exact same functions and is used in the exact same way.</p>
<p d__="">Before you use it, you have to install the unicurses library:</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode sh"><code class="sourceCode bash" s__="13"><span id="cb251-1" d__=""><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at" d__="">-m</span> pip install uni-curses</span></code></pre></div>
<p d__="">After that installs, you should just be able to use <code s__="13">chatuicurses</code> instead of <code s__="13">chatui</code> in the import line.</p>
<p d__=""><strong>Known Mac Issue</strong>: my attempt complained that 
the curses library wasn’t installed when in fact it was. This doesn’t 
seem to affect Linux or Windows.</p>
<p d__=""><strong>One caveat</strong> here is that the input routine doesn’t obey <code s__="13">CRTL-C</code> to get out of the app. As such, you might have to hit <code s__="13">CTRL-C</code> followed by <code s__="13">RETURN</code> to actually break out. On Windows, you might try <code s__="13">CTRL-BREAK</code>.</p>
<h2 data-number="39.4" id="packet-structure" d__=""><span class="header-section-number">39.4</span> Packet Structure</h2>
<p d__="">The client and server will communicate over TCP (stream) sockets using a defined packet structure.</p>
<p d__="">In a nutshell, a packet is a 16-bit big-endian number 
representing the payload length. The payload is a string containing 
JSON-format data with UTF-8 encoding.</p>
<blockquote>
<p d__="">You can encode the JSON string to UTF-8 bytes by calling <code s__="13">.encode()</code> on the string. <code s__="13">.encode()</code> takes an argument to specify the encoding, but it defaults to <code s__="13">"UTF-8"</code>.</p>
</blockquote>
<p d__="">So the first thing you’ll have to do when looking at the data 
stream is make sure you have at least two bytes in your buffer so you 
can determine the JSON data length. And then after that, see if you have
 the length (plus 2 for the 2-byte header) in your buffer.</p>
<h2 data-number="39.5" id="json-payloads" d__=""><span class="header-section-number">39.5</span> JSON Payloads</h2>
<p d__="">If your JSON is rusty, check out the <a href="#appendix-json" d__="">Appendix: JSON</a> section.</p>
<p d__="">Each packet starts with the two-byte length of the payload, followed by the payload.</p>
<p d__="">The payload is a UTF-8 encoded string representing a JSON object.</p>
<p d__="">Each payload is an Object, and has a field in it named <code s__="13">"type"</code> that represents the type of the payload. The remaining fields vary based on the type.</p>
<p d__="">In the following examples, square brackets in strings are used
 to indicate a place where you need to put in the relevant information. 
The brackets are <strong>not</strong> to be included in the packet.</p>
<h3 data-number="39.5.1" id="hello-payload" d__=""><span class="header-section-number">39.5.1</span> “Hello” Payload</h3>
<p d__="">When a client first connects to a server, it sends a <code s__="13">hello</code> packet with the user’s nickname. This allows the server to associate a connection with a nick.</p>
<p d__="">This MUST be sent before any other packets.</p>
<p d__="">From client to server:</p>
<div class="sourceCode" id="cb252"><pre class="sourceCode json"><code class="sourceCode json" s__="13"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">{</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">"type"</span><span class="fu" d__="">:</span> <span class="st" d__="">"hello"</span></span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a>    <span class="st" d__="">"nick"</span><span class="er" d__="">:</span> <span class="st" d__="">"[user nickname]"</span></span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">}</span></span></code></pre></div>
<h3 data-number="39.5.2" id="chat-payload" d__=""><span class="header-section-number">39.5.2</span> “Chat” Payload</h3>
<p d__="">This represents a chat message. It has two forms depending on 
whether or not the chat message originated with the client 
(i.e.&nbsp;the user wants to send a message) or the server 
(i.e.&nbsp;the server is broadcasting someone else’s message).</p>
<p d__="">From client to server:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode json"><code class="sourceCode json" s__="13"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">{</span></span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">"type"</span><span class="fu" d__="">:</span> <span class="st" d__="">"chat"</span></span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a>    <span class="st" d__="">"message"</span><span class="er" d__="">:</span> <span class="st" d__="">"[message]"</span></span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">}</span></span></code></pre></div>
<p d__="">From server to clients:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode json"><code class="sourceCode json" s__="13"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">{</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">"type"</span><span class="fu" d__="">:</span> <span class="st" d__="">"chat"</span></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a>    <span class="st" d__="">"nick"</span><span class="er" d__="">:</span> <span class="st" d__="">"[sender nickname]"</span></span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a>    <span class="st" d__="">"message"</span><span class="er" d__="">:</span> <span class="st" d__="">"[message]"</span></span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">}</span></span></code></pre></div>
<p d__="">The client doesn’t need to send the sender’s nick along with 
the packet since the server can already make that association from the <code s__="13">hello</code> packet sent earlier.</p>
<h3 data-number="39.5.3" id="join-payload" d__=""><span class="header-section-number">39.5.3</span> “Join” Payload</h3>
<p d__="">The server sends this to all the clients when someone joins the chat.</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode json"><code class="sourceCode json" s__="13"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">{</span></span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">"type"</span><span class="fu" d__="">:</span> <span class="st" d__="">"join"</span></span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a>    <span class="st" d__="">"nick"</span><span class="er" d__="">:</span> <span class="st" d__="">"[joiner's nickname]"</span></span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">}</span></span></code></pre></div>
<h3 data-number="39.5.4" id="leave-payload" d__=""><span class="header-section-number">39.5.4</span> “Leave” Payload</h3>
<p d__="">The server sends this to all the clients when someone leaves the chat.</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode json"><code class="sourceCode json" s__="13"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">{</span></span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">"type"</span><span class="fu" d__="">:</span> <span class="st" d__="">"leave"</span></span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>    <span class="st" d__="">"nick"</span><span class="er" d__="">:</span> <span class="st" d__="">"[leaver's nickname]"</span></span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">}</span></span></code></pre></div>
<h2 data-number="39.6" id="extensions-2" d__=""><span class="header-section-number">39.6</span> Extensions</h2>
<p d__="">These aren’t worth any points, but if you want to push farther, here are some ideas. <strong>Caveat!</strong>
 Be sure whatever you turn in has the official functionality as already 
described. These mods can be a strict superset of that, or you can fork a
 new project to hold them.</p>
<p d__="">At the very least, I recommend branching from your working version so it doesn’t get accidentally messed up!</p>
<ul>
<li><p d__="">Add direct messaging–if the user “pat” sends:</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb257-1" d__=""><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>/message chris how's it going?</span></code></pre></div>
<p d__="">then “chris” will see:</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb258-1" d__=""><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>pat -&gt; chris: how's it going?</span></code></pre></div>
<p d__="">(What if the user doesn’t exist? Maybe you need to define an error packet to get back from the server!)</p></li>
<li><p d__="">Add a way to list the names of all the people in the chat</p></li>
<li><p d__="">Add emotes–if the user “pat” sends:</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb259-1" d__=""><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a>/me goes out to buy some snacky cakes</span></code></pre></div>
<p d__="">everyone else sees:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb260-1" d__=""><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>[pat goes out to buy some snacky cakes]</span></code></pre></div>
<p d__="">(The right way to do this is to add a new packet type!)</p></li>
<li><p d__="">Add chat rooms–there could be a default room everyone is 
in when they first join, but additions could be to add chat rooms, join 
or leave chat rooms, and list available chat rooms.</p></li>
<li><p d__="">Turn the whole thing into a <a href="https://en.wikipedia.org/wiki/MUD" d__="">MUD</a>. That should keep you busy!</p></li>
</ul>
<h2 data-number="39.7" id="some-recommendations" d__=""><span class="header-section-number">39.7</span> Some Recommendations</h2>
<p d__="">Here are some pointers that might help.</p>
<ul>
<li><p d__="">Have the server use the set of connected sockets that it passes to <code s__="13">select()</code> as its canonical list of everyone who is connected.</p>
<p d__="">If a client disconnects, remove them from the set.</p>
<p d__="">If a new client connects, add them to the set.</p>
<p d__="">The set will always reflect everyone who is connected at this time.</p></li>
<li><p d__="">Have a buffer per connection on the server. Remember how 
we had a buffer in earlier projects that would accumulate data until 
there was a complete packet? We need one of those buffers <em>per connection</em>. And in this project, we have a lot of connections.</p>
<p d__="">Use a <code s__="13">dict</code> to store the buffers. The key is the socket itself, and the value is a string with the buffer for that socket in it.</p></li>
<li><p d__="">Remember the project where we wrote code to extract packets from the bytestring buffer?</p>
<p d__="">Use that strategy again.</p></li>
<li><p d__="">You’ll want to use <code s__="13">.to_bytes()</code> and <code s__="13">.from_bytes()</code> to get and set the packet length.</p></li>
<li><p d__="">Use old projects as much as you can.</p></li>
</ul>
<!-- Rubric

5 points each

Client sends correct `chat` packet JSON (nickname not included)

Client sends correct `hello` packet JSON

Client handles `join` packet JSON

Client handles `leave` packet JSON

Client implements the text user interface from `chatui`

Client is multithreaded, one thread for receiving and one for input and sending

Client extracts len+JSON packets from stream correctly

Client JSON strings are UTF-8 encoded

Client encodes packets correctly with the length and JSON payload

Client accepts nickname, server, and port number on the command line

Client `/q` command implemented correctly

Server sends correct `chat` packet JSON

Server sends correct `join` packet JSON

Server sends correct `leave` packet JSON

Server handles `hello` packet JSON

Server uses select to handle multiple connections

Server extracts len+JSON packets from stream correctly

Server JSON strings are UTF-8 encoded

Server encodes packets correctly with the length and JSON payload

Server accepts port number on the command line
-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="40" id="appendix-bitwise" d__=""><span class="header-section-number">40</span> Appendix: Bitwise Operations</h1>
<p d__="">In this section, we’ll refresh on <em>bitwise operations</em>.</p>
<p d__="">The bitwise operators in a language manipulate the bits of 
numbers. These operators act as if a number is represented in binary, 
even if its not. They can work on numbers of any base in Python code, 
but it makes the most sense to us as humans in binary.</p>
<blockquote>
<p d__="">Protip: remember that different number bases like hex, binary,
 and decimal are just different ways of writing a value down. Kind of 
like different languages for representing the same numeric value.</p>
<p d__="">When a value is stored in a variable, it’s best to think of it
 as existing in a pure numeric sense–no base at all. It’s only when you 
write it down (in code or print it out) that the base matters.</p>
<p d__="">For instance, Python prints everything in decimal (base 10) by
 default. It has various methods to override that and output in another 
base.</p>
</blockquote>
<p d__="">We’ll look at:</p>
<ul>
<li d__="">Coding different bases in Python</li>
<li d__="">Printing different bases in Python</li>
<li d__="">Bitwise-AND</li>
<li d__="">Bitwise-OR</li>
<li d__="">Bitwise-NOT</li>
<li d__="">Bitwise shift</li>
<li d__="">Setting a given number of <code s__="13">1</code> bits</li>
</ul>
<h2 data-number="40.1" id="coding-different-bases-in-python" d__=""><span class="header-section-number">40.1</span> Coding Different Bases in Python</h2>
<p d__="">What value is <code s__="13">110101</code>?</p>
<p d__="">Your brain might think I’m asking “What is this binary number in decimal?” But you’d be wrong!</p>
<p d__="">I did not specify a number base along with that number, so you don’t know if it’s binary or decimal or hex!</p>
<p d__="">For the record, I meant it to be decimal, so it’s one hundred ten thousand one hundred one.</p>
<p d__="">Python and most other languages assume the numbers in your code are decimal unless you specify otherwise.</p>
<p d__="">If you wanted it to be a different base, you have to prefix the number to indicate the base.</p>
<p d__="">These prefixes are:</p>
<!-- CAPTION: Python Number Base Prefixes -->
<table>
<thead>
<tr>
<th d__="">Base</th>
<th d__="">Base name</th>
<th d__="">Prefix</th>
</tr>
</thead>
<tbody>
<tr>
<td d__="">2</td>
<td d__="">Binary</td>
<td><code s__="13" d__="">0b</code></td>
</tr>
<tr>
<td d__="">8</td>
<td d__="">Octal</td>
<td><code s__="13" d__="">0o</code></td>
</tr>
<tr>
<td d__="">10</td>
<td d__="">Decimal</td>
<td d__="">None</td>
</tr>
<tr>
<td d__="">16</td>
<td d__="">Hexadecimal</td>
<td><code s__="13" d__="">0x</code></td>
</tr>
</tbody>
</table>
<p d__="">So let’s write some numbers in different bases:</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb261-1" d__=""><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>  110101 decimal!</span>
<span id="cb261-2" d__=""><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>0b110101 binary!</span>
<span id="cb261-3" d__=""><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>0x110101 hex!</span></code></pre></div>
<p d__="">Let’s look at the decimal value <code s__="13">3490</code>. I can convert that to hex and get <code s__="13">0xda2</code>.</p>
<p d__="">It’s important to remember these two values are identical:</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">&gt;&gt;&gt;</span> <span class="dv" d__="">3490</span> <span class="op" d__="">==</span> <span class="bn" d__="">0xda2</span></span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a><span class="va" d__="">True</span></span></code></pre></div>
<p d__="">It’s just a different “language” for representing the same value.</p>
<h2 data-number="40.2" id="printing-and-converting" d__=""><span class="header-section-number">40.2</span> Printing and Converting</h2>
<p d__="">Remember that there’s no such thing as a value “stored in hex”
 or “stored in decimal” in a variable. The variable holds just a numeric
 value and we shouldn’t consider it to have a base.</p>
<p d__="">It only acquires a base when we write in our code or print it 
out. Then we have to specify the base. (Although Python uses decimal by 
default in all cases.)</p>
<p d__="">You can convert a value to a hex string with the <code s__="13">hex()</code> function. All “converted” values end up as strings. What else would they be?</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb263-1" d__=""><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">&gt;&gt;&gt;</span> <span class="bu" d__="">print</span>(<span class="bu" d__="">hex</span>(<span class="dv" d__="">3490</span>))</span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a><span class="bn" d__="">0xda2</span></span></code></pre></div>
<p d__="">You can convert a value to a binary string with the <code s__="13">bin()</code> function.</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb264-1" d__=""><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">&gt;&gt;&gt;</span> <span class="bu" d__="">print</span>(<span class="bu" d__="">bin</span>(<span class="dv" d__="">3490</span>))</span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a><span class="bn" d__="">0b110110100010</span></span></code></pre></div>
<p d__="">You can also use f-strings to get the job done:</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb265-1" d__=""><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">&gt;&gt;&gt;</span> <span class="bu" d__="">print</span>(<span class="ss" d__="">f"3490 is </span><span class="sc" d__="">{</span><span class="dv" d__="">3490</span><span class="sc" d__="">:x}</span><span class="ss" d__=""> in hex and </span><span class="sc" d__="">{</span><span class="dv" d__="">3490</span><span class="sc" d__="">:b}</span><span class="ss" d__=""> in binary"</span>)</span>
<span id="cb265-2" d__=""><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">3490</span> <span class="kw" d__="">is</span> da2 <span class="kw" d__="">in</span> <span class="bu" d__="">hex</span> <span class="kw" d__="">and</span> <span class="dv" d__="">110110100010</span> <span class="kw" d__="">in</span> binary</span></code></pre></div>
<p d__="">The f-strings have a nice feature of being able to pad to a 
field width with zeros. Let’s say you wanted an 8-digit hex number 
representation, you could do it like this:</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb266-1" d__=""><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">&gt;&gt;&gt;</span> <span class="bu" d__="">print</span>(<span class="ss" d__="">f"3490 is </span><span class="sc" d__="">{</span><span class="dv" d__="">3490</span><span class="sc" d__="">:08x}</span><span class="ss" d__=""> in hex"</span>)</span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">3490</span> <span class="kw" d__="">is</span> <span class="dv" d__="">00000</span><span class="er" d__="">da2</span> <span class="kw" d__="">in</span> <span class="bu" d__="">hex</span></span></code></pre></div>
<h2 data-number="40.3" id="bitwise-and" d__=""><span class="header-section-number">40.3</span> Bitwise-AND</h2>
<p d__="">Bitwise-AND mashes two numbers together with an AND operation. The result of an AND operation is <code s__="13">1</code> if both of the two input bits are <code s__="13">1</code>. Otherwise it’s <code s__="13">0</code>.</p>
<!-- CAPTION: Bitwise-AND Truth Table -->
<table>
<thead>
<tr>
<th style="text-align: center;" d__="">A</th>
<th style="text-align: center;" d__="">B</th>
<th style="text-align: center;" d__="">A AND B</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;" d__="">0</td>
<td style="text-align: center;" d__="">0</td>
<td style="text-align: center;" d__="">0</td>
</tr>
<tr>
<td style="text-align: center;" d__="">0</td>
<td style="text-align: center;" d__="">1</td>
<td style="text-align: center;" d__="">0</td>
</tr>
<tr>
<td style="text-align: center;" d__="">1</td>
<td style="text-align: center;" d__="">0</td>
<td style="text-align: center;" d__="">0</td>
</tr>
<tr>
<td style="text-align: center;" d__="">1</td>
<td style="text-align: center;" d__="">1</td>
<td style="text-align: center;" d__="">1</td>
</tr>
</tbody>
</table>
<p d__="">Let’s do an example and AND two binary numbers together. Bitwise-AND uses the ampersand operator (<code s__="13">&amp;</code>) in Python and many other languages.</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb267-1" d__=""><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>  0     0     1     1</span>
<span id="cb267-2" d__=""><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a>&amp; 0   &amp; 1   &amp; 0   &amp; 1</span>
<span id="cb267-3" d__=""><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a>---   ---   ---   ---</span>
<span id="cb267-4" d__=""><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a>  0     0     0     1</span></code></pre></div>
<p d__="">You see the result is <code s__="13">1</code> only if both of the two input bits are <code s__="13">1</code>.</p>
<p d__="">Larger inputs are AND’d by pairs of individual bits, which are
 what appears in each column of the large numbers below. (For 
completeness, the decimal result is shown on the right, but this is 
derived from the binary representation. It’s not easy to look at two 
decimal numbers and ascertain their bitwise-AND.)</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb268-1" d__=""><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>  0100011111000101010      146986</span>
<span id="cb268-2" d__=""><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a>&amp; 1001111001001111000    &amp; 324216</span>
<span id="cb268-3" d__=""><a href="#cb268-3" aria-hidden="true" tabindex="-1"></a>---------------------    --------</span>
<span id="cb268-4" d__=""><a href="#cb268-4" aria-hidden="true" tabindex="-1"></a>  0000011001000101000       12840</span></code></pre></div>
<p d__="">See how any particular output bit is <code s__="13">1</code> only if both bits in the column above it are <code s__="13">1</code>.</p>
<h2 data-number="40.4" id="bitwise-or" d__=""><span class="header-section-number">40.4</span> Bitwise-OR</h2>
<p d__="">Bitwise-OR mashes two numbers together with an OR operation. The result of an OR operation is <code s__="13">1</code> if either or both of the two input bits are <code s__="13">1</code>. Otherwise it’s <code s__="13">0</code>.</p>
<!-- CAPTION: Bitwise-OR Truth Table -->
<table>
<thead>
<tr>
<th style="text-align: center;" d__="">A</th>
<th style="text-align: center;" d__="">B</th>
<th style="text-align: center;" d__="">A OR B</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;" d__="">0</td>
<td style="text-align: center;" d__="">0</td>
<td style="text-align: center;" d__="">0</td>
</tr>
<tr>
<td style="text-align: center;" d__="">0</td>
<td style="text-align: center;" d__="">1</td>
<td style="text-align: center;" d__="">1</td>
</tr>
<tr>
<td style="text-align: center;" d__="">1</td>
<td style="text-align: center;" d__="">0</td>
<td style="text-align: center;" d__="">1</td>
</tr>
<tr>
<td style="text-align: center;" d__="">1</td>
<td style="text-align: center;" d__="">1</td>
<td style="text-align: center;" d__="">1</td>
</tr>
</tbody>
</table>
<p d__="">Let’s do an example and OR two binary numbers together. Bitwise-OR uses the pipe operator (<code s__="13">|</code>) in Python and many other languages.</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb269-1" d__=""><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>  0     0     1     1</span>
<span id="cb269-2" d__=""><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a>| 0   | 1   | 0   | 1</span>
<span id="cb269-3" d__=""><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a>---   ---   ---   ---</span>
<span id="cb269-4" d__=""><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a>  0     1     1     1</span></code></pre></div>
<p d__="">You see the result is <code s__="13">1</code> if either of the two input bits are <code s__="13">1</code>.</p>
<p d__="">Larger inputs are OR’d by pairs of individual bits, which are 
what appears in each column of the large numbers below. (For 
completeness, the decimal result is shown on the right, but this is 
derived from the binary representation. It’s not easy to look at two 
decimal numbers and ascertain their bitwise-OR.)</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb270-1" d__=""><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a>  0100011111000101010      146986</span>
<span id="cb270-2" d__=""><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a>| 1001111001001111000    | 324216</span>
<span id="cb270-3" d__=""><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a>---------------------    --------</span>
<span id="cb270-4" d__=""><a href="#cb270-4" aria-hidden="true" tabindex="-1"></a>  1101111111001111010      458362</span></code></pre></div>
<p d__="">See how any particular output bit is <code s__="13">1</code> if either or both bits in the column above it are <code s__="13">1</code>.</p>
<h2 data-number="40.5" id="bitwise-not" d__=""><span class="header-section-number">40.5</span> Bitwise-NOT</h2>
<p d__="">Bitwise-NOT <em>inverts</em> a value by changing all the <code s__="13">1</code> bits to <code s__="13">0</code> and all the <code s__="13">0</code> bits to <code s__="13">1</code> This is a unary operator–it just works on a single number.</p>
<!-- CAPTION: Bitwise-NOT Truth Table -->
<table>
<thead>
<tr>
<th style="text-align: center;" d__="">A</th>
<th style="text-align: center;" d__="">NOT A</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;" d__="">0</td>
<td style="text-align: center;" d__="">1</td>
</tr>
<tr>
<td style="text-align: center;" d__="">1</td>
<td style="text-align: center;" d__="">0</td>
</tr>
</tbody>
</table>
<p d__="">Let’s do an example and NOT a single bit number. Bitwise-NOT uses the tilde operator (<code s__="13">~</code>) in Python and many other languages.</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb271-1" d__=""><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>~ 0   ~ 1</span>
<span id="cb271-2" d__=""><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a>---   ---</span>
<span id="cb271-3" d__=""><a href="#cb271-3" aria-hidden="true" tabindex="-1"></a>  1     0</span></code></pre></div>
<p d__="">You see the result is simply flipped to the other bit value.</p>
<p d__="">Larger inputs are NOT’d by individual bits, which are what 
appears in each column of the large numbers below. (For completeness, 
the decimal result is shown on the right, but this is derived from the 
binary representation. It’s not easy to look at two decimal numbers and 
ascertain their bitwise-NOT.)</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb272-1" d__=""><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>~ 0100011111000101010    ~ 146986</span>
<span id="cb272-2" d__=""><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a>---------------------    --------</span>
<span id="cb272-3" d__=""><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a>  1011100000111010101      377301</span></code></pre></div>
<p d__="">See how any particular output bit is <code s__="13">1</code> only if both bits in the column above it are <code s__="13">1</code>.</p>
<p d__="">Python note: the bitwise-NOT of a number will frequently be 
negative because of Python’s arbitrary-precision arithmetic. If you need
 it to be positive, bitwise-AND the result with the number of <code s__="13">1</code> bits you need to represent the final value. For instance, to get a byte with <code s__="13">37</code> inverted, you can do any of these:</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb273-1" d__=""><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a>(<span class="op" d__="">~</span><span class="dv" d__="">37</span>) <span class="op" d__="">&amp;</span> <span class="dv" d__="">255</span></span>
<span id="cb273-2" d__=""><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a>(<span class="op" d__="">~</span><span class="dv" d__="">37</span>) <span class="op" d__="">&amp;</span> <span class="bn" d__="">0xff</span></span>
<span id="cb273-3" d__=""><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a>(<span class="op" d__="">~</span><span class="dv" d__="">37</span>) <span class="op" d__="">&amp;</span> <span class="bn" d__="">0b11111111</span></span></code></pre></div>
<p d__="">(Because, of course, those are all the same number in different bases!)</p>
<h2 data-number="40.6" id="bitwise-shift" d__=""><span class="header-section-number">40.6</span> Bitwise shift</h2>
<p d__="">This is an interesting one. Using this, you can move a number back and forth by a certain number of bits.</p>
<p d__="">Check out how we’re moving all the bits left by 2 in this example:</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb274-1" d__=""><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>000111000111  left shifted by 2 is:</span>
<span id="cb274-2" d__=""><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a>011100011100</span></code></pre></div>
<p d__="">Or we can shift right:</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb275-1" d__=""><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>000111000111  right shifted by 2 is:</span>
<span id="cb275-2" d__=""><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a>000001110001  </span></code></pre></div>
<p d__="">New bits on the left or right are set to zero, and bits that fall off the ends vanish forever.</p>
<blockquote>
<p d__="">I’m lying a little because of how a lot of languages handle 
right shifting of negative numbers. If you shift a negative number 
right, the new bits might be <code s__="13">1</code> instead of <code s__="13">0</code> depending on the language. Python uses arbitrary precision integer math, so there are actually an infinite number of <code s__="13">1</code> bits on the left of any negative number in Python, making things even weirder.</p>
<p d__="">For now, best to just think about positive numbers.</p>
</blockquote>
<p d__="">The operator is <code s__="13">&lt;&lt;</code> for left shift and <code s__="13">&gt;&gt;</code> for right shift in most languages (sorry, Ruby!). Let’s do an example:</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb276-1" d__=""><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">&gt;&gt;&gt;</span> v <span class="op" d__="">=</span> <span class="bn" d__="">0b00000101</span></span>
<span id="cb276-2" d__=""><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">&gt;&gt;&gt;</span> <span class="bu" d__="">print</span>(<span class="ss" d__="">f"</span><span class="sc" d__="">{</span>v <span class="op" d__="">&lt;&lt;</span> <span class="dv" d__="">2</span><span class="sc" d__="">:08b}</span><span class="ss" d__="">"</span>)</span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a><span class="dv" d__="">000</span><span class="er" d__="">10100</span></span></code></pre></div>
<p d__="">There we had a byte in binary and we left-shifted it by 2 with <code s__="13">v &lt;&lt; 2</code>. And you can see the <code s__="13">101</code> has moved over 2 bits to the left!</p>
<h2 data-number="40.7" id="setting-a-given-number-of-1-bits" d__=""><span class="header-section-number">40.7</span> Setting a Given Number of <code>1</code> bits</h2>
<p d__="">This is a little bit-hack we can do if we want to get a number with a certain number of contiguous bits set to <code s__="13">1</code>.</p>
<p d__="">For example, what if I want a number with 12 bits set to one, namely:</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="bn" d__="">0b111111111111</span></span></code></pre></div>
<p d__="">What would I have to do?</p>
<p d__="">We can make use of a couple tricks here. Let’s start with trick #1.</p>
<p d__="">If you want to set the nth bit to <code s__="13">1</code> (where the rightmost bit is bit number 0), you can raise 2 to that power and get there.</p>
<p d__="">Let’s set bit #5 to 1. We can take <code s__="13">2**5</code> which gives us <code s__="13">32</code>. And <code s__="13">32</code> in binary is <code s__="13">100000</code>. There we are.</p>
<p d__="">Another option is to left-shift a <code s__="13">1</code> by 5 bits: <code s__="13">1 &lt;&lt; 5</code> is <code s__="13">100000</code> in binary, which is <code s__="13">32</code> decimal.</p>
<p d__="">That works.</p>
<p d__="">But how do we get to our bit run of <code s__="13">1</code>s from there?</p>
<p d__="">Check this out: what’s 32 minus 1? 31. Not a trick question. But let’s look at those in binary:</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb278-1" d__=""><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>32   100000</span>
<span id="cb278-2" d__=""><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a>31   011111</span></code></pre></div>
<p d__="">Hey! It’s a run of <code s__="13">1</code>s! Not only that, but it’s a run of 5 <code s__="13">1</code>s, just like we wanted! (This is analogous to subtraction in decimal. 10,000 - 1 is 9,999. Just in binary we roll over to all <code s__="13">1</code>s, not <code s__="13">9</code>s.)</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb279-1" d__=""><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a>run_of_ones <span class="op" d__="">=</span> (<span class="dv" d__="">1</span> <span class="op" d__="">&lt;&lt;</span> count) <span class="op" d__="">-</span> <span class="dv" d__="">1</span></span></code></pre></div>
<p d__="">Here’s our run of 12 <code s__="13">1</code>s:</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb280-1" d__=""><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">&gt;&gt;&gt;</span> <span class="bu" d__="">bin</span>((<span class="dv" d__="">1</span> <span class="op" d__="">&lt;&lt;</span> <span class="dv" d__="">12</span>) <span class="op" d__="">-</span> <span class="dv" d__="">1</span>)</span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">'0b111111111111'</span></span></code></pre></div>
<p d__="">If you like these sorts of <em>bit-twiddling hacks</em>, you might enjoy the book <a href="https://en.wikipedia.org/wiki/Hacker%27s_Delight" d__="">Hacker’s Delight</a>.
 Chapter 2, which covers a lot of these techniques had historically been
 distributed for free; you might be able to find a PDF floating around.</p>
<h2 data-number="40.8" id="reflect-21" d__=""><span class="header-section-number">40.8</span> Reflect</h2>
<ul>
<li><p d__="">What is <code s__="13">2342 &amp; 2332</code>?</p></li>
<li><p d__="">What is <code s__="13">0b110101 | 112</code>?</p></li>
<li><p d__="">What is <code s__="13">~0b101010010101</code> in binary? (Python will show the result as a negative number, but you can turn it back positive by ANDing it with <code s__="13">0b111111111111</code>. And don’t forget that Python leaves off leading zeroes when it prints!)</p></li>
<li><p d__="">What is <code s__="13">16 &lt;&lt; 1</code>?</p></li>
<li><p d__="">What is <code s__="13">64 &lt;&lt; 1</code>?</p></li>
<li><p d__="">What is <code s__="13">4200 &lt;&lt; 1</code>? See the pattern?</p></li>
<li><p d__="">What is <code s__="13">16 &gt;&gt; 2</code>?</p></li>
<li><p d__="">What is <code s__="13">0b11100111 &lt;&lt; 3</code>?</p></li>
<li><p d__="">What is <code s__="13">(1 &lt;&lt; 8) - 1</code>?</p></li>
<li><p d__="">What is <code s__="13">0x01020304 &amp; ((1 &lt;&lt; 16) - 1)</code>?</p></li>
</ul>
<!--

Answers:

2342 & 2332
2308    0x904    0b100100000100

0b110101 | 112
117    0x75    0b1110101

(~0b101010010101)&0b111111111111
1386    0x56a    0b10101101010

16 << 1
32

64 << 1
128

4200 << 1
8400   Doubles

16 >> 2
4

0b11100111 << 3
1848    0x738    0b11100111000

 ~ %  (1 << 8) - 1
255    0xff    0b11111111

0x01020304 & ((1 << 16) - 1)
772    0x304    0b1100000100

-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="41" id="appendix-packettracer" d__=""><span class="header-section-number">41</span> Appendix: Installing Packet Tracer</h1>
<p d__="">This week we’re going to building a number of small networks in a simulator. This simulator, called <em>Packet Tracer</em> is provided for free by <a href="https://en.wikipedia.org/wiki/Cisco" d__="">Cisco</a> (as long as you sign up for a free class, which you don’t have to take–though it is useful).</p>
<p d__="">This project is to get an account set up at Cisco, download Packet Tracer, and run it.</p>
<h2 data-number="41.1" id="download-packet-tracer" d__=""><span class="header-section-number">41.1</span> Download Packet Tracer</h2>
<p d__="">How to get your download directly (if you want to go via the online Cisco courses interface, see below):</p>
<ol type="1">
<li><p d__="">Head to the <a href="https://skillsforall.com/resources/lab-downloads" d__="">Packet Tracer Download page</a>.</p></li>
<li><p d__="">Click “Log in”.</p></li>
<li><p d__="">Create an account.</p></li>
<li><p d__="">Click the download link for your OS.</p></li>
<li><p d__="">Install the software.</p></li>
</ol>
<p d__="">If you want to go through the free course, or if the above route isn’t working, try this:</p>
<ol type="1">
<li><p d__="">Head on to the <a href="https://skillsforall.com/topics/cisco-packet-tracer" d__="">Packet Tracer page at Cisco</a>.</p></li>
<li><p d__="">Click on the “Getting Started with Cisco Packet Tracer” course.</p></li>
<li><p d__="">Click “Get Started”.</p></li>
<li><p d__="">Create an account.</p></li>
<li><p d__="">Once you have your account, you should be able to follow 
the course material to the download link. (Or, if you’re logged in, you 
could <a href="https://skillsforall.com/resources/lab-downloads" d__="">try downloading from this link</a>.)</p></li>
</ol>
<h2 data-number="41.2" id="run-packet-tracer" d__=""><span class="header-section-number">41.2</span> Run Packet Tracer</h2>
<p d__="">Once installed, run it!</p>
<p d__="">If given the choice between “Net Academy” and “Skills for All” when logging in, choose “Skills for All”.</p>
<p d__="">After launching Packet Tracer, you should see a bunch of circular objects with numbers below them in the lower middle panel.</p>
<ul>
<li><p d__="">Drag any 3 of them onto the main workspace. (Any three items of any type will do.)</p></li>
<li><p d__="">Then click the “Place Note” icon (second row on top, 5th 
from the left, looks like a clipboard). Then click on the workspace and 
enter your name. Hit <code s__="13">ESC</code> when done.</p></li>
</ul>
<p d__="">You haven’t done much, but at least you’ve started getting a feel for the tool.</p>
<!--

Rubric

5
Screenshot contains name in main workspace.

5
Screenshot contains three items in the main workspace.

-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="42" id="appendix-threading" d__=""><span class="header-section-number">42</span> Appendix: Multithreading</h1>
<p d__=""><em>Multithreading</em> is the idea that a process can have multiple <em>threads</em> of execution. That is, it can be running a number of functions at the same time, as it were.</p>
<p d__="">This is really useful if you have a function that is waiting 
for something to happen, and you need another function to keep running 
at the same time.</p>
<p d__="">This would be useful in a multiuser chat client because it has to do two things at once, both of which block:</p>
<ul>
<li d__="">Wait for the user to type in their chat message.</li>
<li d__="">Wait for the server to send more messages.</li>
</ul>
<p d__="">If we didn’t use multithreading, we wouldn’t be able to 
receive messages from the server while we were waiting for user input 
and vice versa.</p>
<blockquote>
<p d__="">Side note: <code s__="13">select()</code> actually has the capability to add regular file descriptors to the set to listen for. So it technically <em>could</em> listen for data on the sockets <strong>and</strong> the keyboard. This doesn’t work in Windows, however. And the design of the client is simpler overall with multithreading.</p>
</blockquote>
<p d__="">Let’s take a look at how this works in Python.</p>
<h2 data-number="42.1" id="concepts" d__=""><span class="header-section-number">42.1</span> Concepts</h2>
<p d__="">There are a few terms we should get straight first.</p>
<ul>
<li><p d__=""><strong>Thread</strong>: a representation of a “thread of 
execution”, that is, a part of the program that is executing at this 
particular moment. If you want multiple parts of the program to execute 
at the same time, you can place them in separate threads.</p></li>
<li><p d__=""><strong>Main Thread</strong>: this is the thread that is 
running by default. We just never named it before. But the code that you
 run without thinking about threads is technically running in the main 
thread.</p></li>
<li><p d__=""><strong>Spawning</strong>: We say we “spawn” a new thread to run a particular function. If we do this, the function will execute <em>at the same time</em> as the main thread. They’ll both run at once!</p></li>
<li><p d__=""><strong>Join</strong>: A thread can wait for another to exit by calling that thread’s <code s__="13">join()</code> method. This conceptually joins the other thread back up to the calling thread. Usually this is the main thread <code s__="13">join()</code>ing the threads it spawned back to itself.</p></li>
<li><p d__=""><strong>Target</strong>: The thread target is a function that the thread will run. When this function returns, the thread exits.</p></li>
</ul>
<p d__="">It’s important to note that <em>global objects are shared between threads</em>!
 This means one thread can set the value in a global object and other 
threads will see those changes. You don’t have to worry about this if 
the shared data is read-only, but do have to consider this if it’s 
writable.</p>
<p d__="">We are about to get into the weeds with concurrency and 
synchronization here, so for this project, let’s just not use any global
 shared objects. Remember the old proverb:</p>
<blockquote>
<p d__="">Shared Nothing Is Happy Everybody</p>
</blockquote>
<p d__="">That’s not really an old proverb. I just made it up. And it sounds kind of selfish now that I read it again.</p>
<p d__="">Back on track to a related notion: local objects are <em>not</em>
 shared between threads. This means threads get their own local 
variables and parameter values. They can change them and those changes 
will not be visible to other threads.</p>
<p d__="">Also, if you have multiple threads running at the same time, 
the order in which they are executed is unpredictable. This really only 
gets to be a problem if there is some kind of timing or data dependency 
between threads, and again we’re starting to get out in the weeds. Let’s
 just be aware that the order of execution is unpredictable and that’ll 
be OK for this project.</p>
<p d__="">That should be enough to get started.</p>
<h2 data-number="42.2" id="multithreading-in-python" d__=""><span class="header-section-number">42.2</span> Multithreading In Python</h2>
<p d__="">Let’s write a program that spawns three threads.</p>
<p d__="">Each thread will run a function called <code s__="13">runner()</code> (you can call the function whatever you wish). This function takes two arguments: a <code s__="13">name</code> and a <code s__="13">count</code>. It loops and prints the <code s__="13">name</code> out <code s__="13">count</code> times.</p>
<p d__="">The thread exits when the <code s__="13">runner()</code> function returns.</p>
<p d__="">You can create a new thread by calling the <code s__="13">threading.Thread()</code> constructor.</p>
<p d__="">You can run a thread with its <code s__="13">.start()</code> method.</p>
<p d__="">And you can wait for the thread to complete with its <code s__="13">.join()</code> method.</p>
<p d__="">Let’s take a peek!</p>
<!-- read in the projects/threaddemo.py file here -->
<div class="sourceCode" id="cb281"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb281-1" d__=""><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">import</span> threading</span>
<span id="cb281-2" d__=""><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">import</span> time</span>
<span id="cb281-3"><a href="#cb281-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-4" d__=""><a href="#cb281-4" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">def</span> runner(name, count):</span>
<span id="cb281-5"><a href="#cb281-5" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__="">""" Thread running function. """</span></span>
<span id="cb281-6"><a href="#cb281-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-7" d__=""><a href="#cb281-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf" d__="">for</span> i <span class="kw" d__="">in</span> <span class="bu" d__="">range</span>(count):</span>
<span id="cb281-8" d__=""><a href="#cb281-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu" d__="">print</span>(<span class="ss" d__="">f"Running: </span><span class="sc" d__="">{</span>name<span class="sc" d__="">}</span><span class="ss"> </span><span class="sc" d__="">{</span>i<span class="sc" d__="">}</span><span class="ss" d__="">"</span>)</span>
<span id="cb281-9" d__=""><a href="#cb281-9" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="fl" d__="">0.2</span>)  <span class="co" d__=""># seconds</span></span>
<span id="cb281-10"><a href="#cb281-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-11"><a href="#cb281-11" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Launch this many threads</span></span>
<span id="cb281-12" d__=""><a href="#cb281-12" aria-hidden="true" tabindex="-1"></a>THREAD_COUNT <span class="op" d__="">=</span> <span class="dv" d__="">3</span></span>
<span id="cb281-13"><a href="#cb281-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-14"><a href="#cb281-14" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># We need to keep track of them so that we can join() them later. We'll</span></span>
<span id="cb281-15"><a href="#cb281-15" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># put all the thread references into this array</span></span>
<span id="cb281-16" d__=""><a href="#cb281-16" aria-hidden="true" tabindex="-1"></a>threads <span class="op" d__="">=</span> []</span>
<span id="cb281-17"><a href="#cb281-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-18"><a href="#cb281-18" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Launch all threads!!</span></span>
<span id="cb281-19" d__=""><a href="#cb281-19" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">for</span> i <span class="kw" d__="">in</span> <span class="bu" d__="">range</span>(THREAD_COUNT):</span>
<span id="cb281-20"><a href="#cb281-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-21"><a href="#cb281-21" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># Give them a name</span></span>
<span id="cb281-22" d__=""><a href="#cb281-22" aria-hidden="true" tabindex="-1"></a>    name <span class="op" d__="">=</span> <span class="ss" d__="">f"Thread</span><span class="sc" d__="">{</span>i<span class="sc" d__="">}</span><span class="ss" d__="">"</span></span>
<span id="cb281-23"><a href="#cb281-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-24"><a href="#cb281-24" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># Set up the thread object. We're going to run the function called</span></span>
<span id="cb281-25"><a href="#cb281-25" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># "runner" and pass it two arguments: the thread's name and count:</span></span>
<span id="cb281-26" d__=""><a href="#cb281-26" aria-hidden="true" tabindex="-1"></a>    t <span class="op" d__="">=</span> threading.Thread(target<span class="op" d__="">=</span>runner, args<span class="op" d__="">=</span>(name, i<span class="op" d__="">+</span><span class="dv" d__="">3</span>))</span>
<span id="cb281-27"><a href="#cb281-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-28"><a href="#cb281-28" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># The thread won't start executing until we call `start()`:</span></span>
<span id="cb281-29" d__=""><a href="#cb281-29" aria-hidden="true" tabindex="-1"></a>    t.start()</span>
<span id="cb281-30"><a href="#cb281-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-31"><a href="#cb281-31" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__=""># Keep track of this thread so we can join() it later.</span></span>
<span id="cb281-32" d__=""><a href="#cb281-32" aria-hidden="true" tabindex="-1"></a>    threads.append(t)</span>
<span id="cb281-33"><a href="#cb281-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-34"><a href="#cb281-34" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># Join all the threads back up to this, the main thread. The main thread</span></span>
<span id="cb281-35"><a href="#cb281-35" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># will block on the join() call until the thread is complete. If the</span></span>
<span id="cb281-36"><a href="#cb281-36" aria-hidden="true" tabindex="-1"></a><span class="co" d__=""># thread is already complete, the join() returns immediately.</span></span>
<span id="cb281-37"><a href="#cb281-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-38" d__=""><a href="#cb281-38" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">for</span> t <span class="kw" d__="">in</span> threads:</span>
<span id="cb281-39" d__=""><a href="#cb281-39" aria-hidden="true" tabindex="-1"></a>    t.join()</span></code></pre></div>
<p d__="">And here’s the output:</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb282-1" d__=""><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>Running: Thread0 0</span>
<span id="cb282-2" d__=""><a href="#cb282-2" aria-hidden="true" tabindex="-1"></a>Running: Thread1 0</span>
<span id="cb282-3" d__=""><a href="#cb282-3" aria-hidden="true" tabindex="-1"></a>Running: Thread2 0</span>
<span id="cb282-4" d__=""><a href="#cb282-4" aria-hidden="true" tabindex="-1"></a>Running: Thread1 1</span>
<span id="cb282-5" d__=""><a href="#cb282-5" aria-hidden="true" tabindex="-1"></a>Running: Thread0 1</span>
<span id="cb282-6" d__=""><a href="#cb282-6" aria-hidden="true" tabindex="-1"></a>Running: Thread2 1</span>
<span id="cb282-7" d__=""><a href="#cb282-7" aria-hidden="true" tabindex="-1"></a>Running: Thread1 2</span>
<span id="cb282-8" d__=""><a href="#cb282-8" aria-hidden="true" tabindex="-1"></a>Running: Thread0 2</span>
<span id="cb282-9" d__=""><a href="#cb282-9" aria-hidden="true" tabindex="-1"></a>Running: Thread2 2</span>
<span id="cb282-10" d__=""><a href="#cb282-10" aria-hidden="true" tabindex="-1"></a>Running: Thread1 3</span>
<span id="cb282-11" d__=""><a href="#cb282-11" aria-hidden="true" tabindex="-1"></a>Running: Thread2 3</span>
<span id="cb282-12" d__=""><a href="#cb282-12" aria-hidden="true" tabindex="-1"></a>Running: Thread2 4</span></code></pre></div>
<p d__="">They’re all running at the same time!</p>
<p d__="">Notice the execution order isn’t consistent. It might ever 
vary from run to run. And that’s OK for this program since the threads 
don’t depend on one another.</p>
<h2 data-number="42.3" id="daemon-threads" d__=""><span class="header-section-number">42.3</span> Daemon Threads</h2>
<p d__="">Python classifies threads in two different ways:</p>
<ul>
<li d__="">Regular, normal, run-of-the-mill threads</li>
<li d__="">Daemon threads (pronounced “DEE-mun” or “DAY-mun”)</li>
</ul>
<p d__="">The general idea is that a daemon thread will keep running 
forever and never return from its function. Unlike non-daemon threads, 
these threads will be automatically killed by Python once all the 
non-daemon threads are dead.</p>
<h3 data-number="42.3.1" id="this-is-somehow-related-to-ctrl-c" d__=""><span class="header-section-number">42.3.1</span> This is Somehow Related to <code>CTRL-C</code></h3>
<p d__="">If you kill the main thread with <code s__="13">CTRL-C</code> and there are no other non-daemon threads running, all daemon threads will also be killed.</p>
<p d__="">But if you have some non-daemon threads, you have to <code s__="13">CTRL-C</code> through all of them before you get back to the prompt.</p>
<p d__="">In the final project, we’ll be running a thread forever to 
listen for incoming messages from the server. So that should be a daemon
 thread.</p>
<p d__="">You can create a daemon thread like this:</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb283-1" d__=""><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a>t <span class="op" d__="">=</span> threading.Thread(target<span class="op" d__="">=</span>runner, daemon<span class="op" d__="">=</span><span class="va" d__="">True</span>)</span></code></pre></div>
<p d__="">Then at least <code s__="13">CTRL-C</code> will get you out of the client easily.</p>
<h2 data-number="42.4" id="reflect-22" d__=""><span class="header-section-number">42.4</span> Reflect</h2>
<ul>
<li><p d__="">Describe the type of problem using threads would solve.</p></li>
<li><p d__="">What’s the difference between a daemon and non-daemon thread in Python?</p></li>
<li><p d__="">What do you have to do to create the main thread in Python, if anything?</p></li>
</ul>
<h2 data-number="42.5" id="threading-project" d__=""><span class="header-section-number">42.5</span> Threading Project</h2>
<p d__="">If you’re looking to flex your muscles a bit, here’s a little project to work on.</p>
<h3 data-number="42.5.1" id="what-were-building-1" d__=""><span class="header-section-number">42.5.1</span> What We’re Building</h3>
<p d__="">The client who has hired us in this case has several ranges of
 numbers. They want the sum total of all the sums of all the ranges.</p>
<p d__="">For example, if the ranges are:</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb284-1" d__=""><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>[</span>
<span id="cb284-2" d__=""><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a>    [<span class="dv" d__="">1</span>,<span class="dv" d__="">5</span>],</span>
<span id="cb284-3" d__=""><a href="#cb284-3" aria-hidden="true" tabindex="-1"></a>    [<span class="dv" d__="">20</span>,<span class="dv" d__="">22</span>]</span>
<span id="cb284-4" d__=""><a href="#cb284-4" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<p d__="">We want to:</p>
<ul>
<li d__="">First add up <code s__="13">1+2+3+4+5</code> to get <code s__="13">15</code>.</li>
<li d__="">Then add up <code s__="13">20+21+22</code> to get <code s__="13">63</code>.</li>
<li d__="">Then add <code s__="13">15+63</code> to get <code s__="13">78</code>, the final answer.</li>
</ul>
<p d__="">They want the range sums and the total sum printed out. For the example above, they’d want it to print:</p>
<div class="sourceCode" id="cb285"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb285-1" d__=""><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a>[15, 63]</span>
<span id="cb285-2" d__=""><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a>78</span></code></pre></div>
<h3 data-number="42.5.2" id="overall-structure" d__=""><span class="header-section-number">42.5.2</span> Overall Structure</h3>
<p d__="">The program MUST use threads to solve the problem because the client really likes parallelism.</p>
<p d__="">You should write a function that adds up a range of numbers. 
Then you’ll spawn a thread for each range and have that thread work on 
that range. If there are 10 ranges of numbers, there will be 10 threads,
 one processing each range.</p>
<p d__="">The main thread will:</p>
<ul>
<li><p d__="">Allocate an array for the results. This array length 
should the same as the number of ranges (which is the same as the number
 of threads). Each thread has its own slot to store a result in the 
array.</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb286-1" d__=""><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a>result <span class="op" d__="">=</span> [<span class="dv" d__="">0</span>] <span class="op" d__="">*</span> n   <span class="co" d__=""># Create an array of `n` zeros</span></span></code></pre></div></li>
<li><p d__="">In a loop, launch all the threads. Thread arguments are:</p>
<ul>
<li><p d__="">The thread ID number <code s__="13">0..(n-1)</code>, where <code s__="13">n</code> is the number of threads. This is the index the thread will use to store its result in the result array.</p></li>
<li><p d__="">The starting value of the range.</p></li>
<li><p d__="">The ending value of the range.</p></li>
<li><p d__="">The result array, where the thread will store the result.</p></li>
<li><p d__="">The main thread should keep track of all the thread objects returned from <code s__="13">threading.Thread()</code> in an array. It’ll need them in the next step.</p></li>
</ul></li>
<li><p d__="">In another loop after that, call <code s__="13">.join()</code> on all the threads. This will cause the main thread to wait until all the subthreads have completed.</p></li>
<li><p d__="">Print out the results. After all the <code s__="13">join()</code>s, the result array will have all the sums in it.</p></li>
</ul>
<h3 data-number="42.5.3" id="useful-functions" d__=""><span class="header-section-number">42.5.3</span> Useful Functions</h3>
<ul>
<li><p d__=""><code s__="13">threading.Thread()</code>: create a thread.</p></li>
<li><p d__=""><code s__="13">range(a, b)</code>: produces all the integers in the range <code s__="13">[a, b)</code> as an iterable.</p></li>
<li><p d__=""><code s__="13">sum()</code>: compute the sum of an iterable.</p></li>
<li><p d__=""><code s__="13">enumerate()</code>: produces indexs and values over an iterable.</p></li>
</ul>
<h3 data-number="42.5.4" id="things-the-thread-running-function-needs" d__=""><span class="header-section-number">42.5.4</span> Things the Thread Running Function Needs</h3>
<p d__="">All the threads are going to write into a shared array. This 
array can be set up ahead of time to have zeros in all the elements. 
There should be one element per thread, so that each thread can fill in 
the proper one.</p>
<p d__="">To make this work, you’ll have to pass the thread’s index 
number to its run function so it knows which element in the shared array
 to put the result in!</p>
<h3 data-number="42.5.5" id="example-run-2" d__=""><span class="header-section-number">42.5.5</span> Example Run</h3>
<p d__="">Example input (you can just hardcode this in your program):</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb287-1" d__=""><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>ranges <span class="op" d__="">=</span> [</span>
<span id="cb287-2" d__=""><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a>    [<span class="dv" d__="">10</span>, <span class="dv" d__="">20</span>],</span>
<span id="cb287-3" d__=""><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a>    [<span class="dv" d__="">1</span>, <span class="dv" d__="">5</span>],</span>
<span id="cb287-4" d__=""><a href="#cb287-4" aria-hidden="true" tabindex="-1"></a>    [<span class="dv" d__="">70</span>, <span class="dv" d__="">80</span>],</span>
<span id="cb287-5" d__=""><a href="#cb287-5" aria-hidden="true" tabindex="-1"></a>    [<span class="dv" d__="">27</span>, <span class="dv" d__="">92</span>],</span>
<span id="cb287-6" d__=""><a href="#cb287-6" aria-hidden="true" tabindex="-1"></a>    [<span class="dv" d__="">0</span>, <span class="dv" d__="">16</span>]</span>
<span id="cb287-7" d__=""><a href="#cb287-7" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<p d__="">Corresponding output:</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb288-1" d__=""><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a>[165, 15, 825, 3927, 136]</span>
<span id="cb288-2" d__=""><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a>5068</span></code></pre></div>
<h3 data-number="42.5.6" id="extensions-3" d__=""><span class="header-section-number">42.5.6</span> Extensions</h3>
<ul>
<li><p d__="">If you’re using <code s__="13">sum()</code> or a <code s__="13">for</code>-loop, what’s your time complexity?</p></li>
<li><p d__="">The closed-form equation for the sum of integers from 1 to <em>n</em> is <code s__="13">n*(n+1)//2</code>. Can you use that to get a better time complexity? How much better?</p></li>
</ul>
<!-- Rubric:

10
Threads spawned, one thread per range

5
Main thread join()s will all spawned threads

5
Each thread properly populates a results array

5
Correct array of sums is outputted 

5
Correct complete total is outputted

-->
<!-- BG_NEW_CHAPTER -->
<h1 data-number="43" id="appendix-json" d__=""><span class="header-section-number">43</span> Appendix: JSON</h1>
<p d__="">For the final project, we need to be able to encode and decode JSON data.</p>
<p d__="">If you’re not familiar with that format, <a href="https://en.wikipedia.org/wiki/JSON" d__="">get a quick introduction at Wikipedia</a>.</p>
<p d__="">In this section, we’ll take a look at what it means to encode and decode JSON data.</p>
<h2 data-number="43.1" id="json-versus-native" d__=""><span class="header-section-number">43.1</span> JSON versus Native</h2>
<p d__="">Here’s a sample JSON object:</p>
<div class="sourceCode" id="cb289"><pre class="sourceCode json"><code class="sourceCode json" s__="13"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">{</span></span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">"name"</span><span class="fu" d__="">:</span> <span class="st" d__="">"Ada Lovelace"</span><span class="fu" d__="">,</span></span>
<span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">"country"</span><span class="fu" d__="">:</span> <span class="st" d__="">"England"</span><span class="fu" d__="">,</span></span>
<span id="cb289-4"><a href="#cb289-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">"years"</span><span class="fu" d__="">:</span> <span class="ot" d__="">[</span> <span class="dv" d__="">1815</span><span class="ot" d__="">,</span> <span class="dv" d__="">1852</span> <span class="ot" d__="">]</span></span>
<span id="cb289-5"><a href="#cb289-5" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">}</span></span></code></pre></div>
<p d__="">In Python, you can make a <code s__="13">dict</code> object that looks just like that:</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode json"><code class="sourceCode json" s__="13"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="er" d__="">d</span> <span class="er" d__="">=</span> <span class="fu" d__="">{</span></span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">"name"</span><span class="fu" d__="">:</span> <span class="st" d__="">"Ada Lovelace"</span><span class="fu" d__="">,</span></span>
<span id="cb290-3"><a href="#cb290-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">"country"</span><span class="fu" d__="">:</span> <span class="st" d__="">"England"</span><span class="fu" d__="">,</span></span>
<span id="cb290-4"><a href="#cb290-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">"years"</span><span class="fu" d__="">:</span> <span class="ot" d__="">[</span> <span class="dv" d__="">1815</span><span class="ot" d__="">,</span> <span class="dv" d__="">1852</span> <span class="ot" d__="">]</span></span>
<span id="cb290-5"><a href="#cb290-5" aria-hidden="true" tabindex="-1"></a><span class="fu" d__="">}</span></span></code></pre></div>
<p d__="">But here’s the key difference: <em>all JSON data are strings</em>. The JSON is a string representation of the data in question.</p>
<h2 data-number="43.2" id="converting-back-and-forth" d__=""><span class="header-section-number">43.2</span> Converting Back and Forth</h2>
<p d__="">If you have a JSON string, you can turn it into Python native data with the <code s__="13">json.loads()</code> function.</p>
<div class="sourceCode" id="cb291"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb291-1" d__=""><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">import</span> json</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-3" d__=""><a href="#cb291-3" aria-hidden="true" tabindex="-1"></a>data <span class="op" d__="">=</span> json.loads(<span class="st" d__="">'{ "name": "Ada" }'</span>)</span>
<span id="cb291-4"><a href="#cb291-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb291-5" d__=""><a href="#cb291-5" aria-hidden="true" tabindex="-1"></a><span class="bu" d__="">print</span>(data[<span class="st" d__="">"name"</span>])   <span class="co" d__=""># Prints Ada</span></span></code></pre></div>
<p d__="">Likewise, if you have Python data, you can convert it into JSON string format with <code s__="13">json.dumps()</code>:</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb292-1" d__=""><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="im" d__="">import</span> json</span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-3" d__=""><a href="#cb292-3" aria-hidden="true" tabindex="-1"></a>data <span class="op" d__="">=</span> { <span class="st" d__="">"name"</span>: <span class="st" d__="">"Ada"</span> }</span>
<span id="cb292-4"><a href="#cb292-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-5" d__=""><a href="#cb292-5" aria-hidden="true" tabindex="-1"></a>json_data <span class="op" d__="">=</span> json.dumps(data)</span>
<span id="cb292-6"><a href="#cb292-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb292-7" d__=""><a href="#cb292-7" aria-hidden="true" tabindex="-1"></a><span class="bu" d__="">print</span>(json_data)  <span class="co" d__=""># Prints {"name": "Ada"}</span></span></code></pre></div>
<h2 data-number="43.3" id="pretty-printing" d__=""><span class="header-section-number">43.3</span> Pretty Printing</h2>
<p d__="">If you have a complex object, <code s__="13">json.dumps()</code> will just stick it all together on one line.</p>
<p d__="">This code:</p>
<div class="sourceCode" id="cb293"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb293-1" d__=""><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a>d <span class="op" d__="">=</span> {</span>
<span id="cb293-2" d__=""><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a>    <span class="st" d__="">"name"</span>: <span class="st" d__="">"Ada Lovelace"</span>,</span>
<span id="cb293-3" d__=""><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a>    <span class="st" d__="">"country"</span>: <span class="st" d__="">"England"</span>,</span>
<span id="cb293-4" d__=""><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a>    <span class="st" d__="">"years"</span>: [ <span class="dv" d__="">1815</span>, <span class="dv" d__="">1852</span> ]</span>
<span id="cb293-5" d__=""><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb293-6"><a href="#cb293-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-7" d__=""><a href="#cb293-7" aria-hidden="true" tabindex="-1"></a>json.dumps(d)</span></code></pre></div>
<p d__="">outputs:</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb294-1" d__=""><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a>'{"name": "Ada Lovelace", "country": "England", "years": [1815, 1852]}'</span></code></pre></div>
<p d__="">You can clean it up a bit by passing the <code s__="13">indent</code> argument to <code s__="13">json.dumps()</code>, giving it an indentation level.</p>
<div class="sourceCode" id="cb295"><pre class="sourceCode py"><code class="sourceCode python" s__="13"><span id="cb295-1" d__=""><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a>json.dumps(d, indent<span class="op" d__="">=</span><span class="dv" d__="">4</span>)</span></code></pre></div>
<p d__="">outputs:</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb296-1" d__=""><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb296-2" d__=""><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>    "name": "Ada Lovelace",</span>
<span id="cb296-3" d__=""><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a>    "country": "England",</span>
<span id="cb296-4" d__=""><a href="#cb296-4" aria-hidden="true" tabindex="-1"></a>    "years": [</span>
<span id="cb296-5" d__=""><a href="#cb296-5" aria-hidden="true" tabindex="-1"></a>        1815,</span>
<span id="cb296-6" d__=""><a href="#cb296-6" aria-hidden="true" tabindex="-1"></a>        1852</span>
<span id="cb296-7" d__=""><a href="#cb296-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb296-8" d__=""><a href="#cb296-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p d__="">Much cleaner.</p>
<h2 data-number="43.4" id="double-quotes-are-important" d__=""><span class="header-section-number">43.4</span> Double Quotes are Important</h2>
<p d__="">JSON requires strings and key names to be in double quotes. Single quotes won’t cut it. Missing quotes <em>definitely</em> won’t cut it.</p>
<h2 data-number="43.5" id="reflect-23" d__=""><span class="header-section-number">43.5</span> Reflect</h2>
<ul>
<li><p d__="">What’s the difference between a JSON object and a Python dictionary?</p></li>
<li><p d__="">Looking at the Wikipedia article, what types of data can be represented in JSON?</p></li>
</ul>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p d__="">https://beej.us/guide/bgnet<a href="#fnref1" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn2"><p d__="">https://beej.us/guide/bgnet0/<a href="#fnref2" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn3"><p d__="">https://beej.us/guide/bgnet<a href="#fnref3" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn4"><p d__="">https://beej.us/guide/bgnet0/source/exercises/word/wordserver.py<a href="#fnref4" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn5"><p d__="">https://beej.us/guide/bgnet0/source/exercises/word/wordclient.py<a href="#fnref5" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn6"><p d__="">https://beej.us/guide/bgnet0/source/exercises/tcpcksum/tcp_data.zip<a href="#fnref6" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn7"><p d__="">https://beej.us/guide/bgnet0/source/exercises/tcpcksum/tcp_data.zip<a href="#fnref7" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn8"><p d__="">https://www.youtube.com/watch?v=A1KXPpqlNZ4<a href="#fnref8" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn9"><p d__="">https://beej.us/guide/bgnet0/source/examples/ip-routing-demo.pdf<a href="#fnref9" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn10"><p d__="">https://beej.us/guide/bgnet0/source/exercises/netfuncs/netfuncs.zip<a href="#fnref10" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn11"><p d__="">https://en.wikipedia.org/wiki/Dijkstra’s_algorithm<a href="#fnref11" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn12"><p d__="">https://beej.us/guide/bgnet0/source/exercises/dijkstra/dijkstra.zip<a href="#fnref12" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn13"><p d__="">https://www.wireshark.org/<a href="#fnref13" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn14"><p d__="">https://www.netacad.com/courses/packet-tracer<a href="#fnref14" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn15"><p d__="">https://beej.us/guide/bgnet0/source/exercises/select/select.zip<a href="#fnref15" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn16"><p d__="">https://beej.us/guide/bgnet0/source/exercises/chat/chatui.zip<a href="#fnref16" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
</ol>
</section>


</body><iframe class="cleanslate hidden" src="Beej's%20Guide%20to%20Network%20Concepts_files/commandline.html" id="cmdline_iframe" loading="lazy" style="height: 0px !important;"></iframe></html>