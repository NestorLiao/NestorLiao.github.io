<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="" class="TridactylThemeAuto icpchpwc idc0_343" style="scroll-behavior: unset;"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>Beej's Guide to Interprocess Communication</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    svg {
      height: auto;
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!-- BG custom styling -->
  <style type="text/css">
  /* Fix for line numbers not visible */
  pre.numberSource code > span {
      left: -1em;
  }
  pre.numberSource {
      margin-left: initial;
  }

  /* Put some space after the section numbers */
  span.toc-section-number::after {
      content: "\a0\a0\a0";  /* non-breaking whitespace */
  }

  /* Hide underlines on code number links */
  pre > code.sourceCode > span > a:first-child::before {
      text-decoration: none;
  }

  /* Color the source blocks */
  div.sourceCode {
      background-color: #f0f0f0;
  }

  /* Fix iOS big text rendering issue */
  pre > code.sourceCode > span {
      display: initial;
  }


  /* Color the inline code */
  code:not(.sourceCode) {
      background: #f0f0f0;
      padding-left: 0.2em;
      padding-right: 0.2em;
      border-radius: 0.2em;
  }

  pre.sourceCode {
      border: 1px solid #ccc;
      padding: 0.5em;
      border-radius: 0.2em;
  }

  /* Keep code tags from wrapping in tables */
  tbody code {
      white-space: nowrap;
  }

  /* Prevent hyphenation and hyphen breaks in code*/
  code {
      word-break: keep-all;
  }

  td {
      vertical-align: top;
  }

  body {
      font-size: 12pt;
      max-width: 43em;
      font-family: sans-serif;
  }

  html {
      background: #f9f9f9;
  }

  figure > embed {
      max-width: 100%;
  }

  figure {
      text-align: center;
      margin-top: 2em;
      margin-bottom: 2em;
  }

  figcaption {
      font-size: 0.9em;
      font-style: italic;
      margin-top: 0.6em;
  }

  body {
      counter-reset: figure-counter-major;
      counter-reset: figure-counter-minor;
  }

  figure {
      counter-increment: figure-counter-minor;
  }

  figcaption::before {
      content: "Figure " counter(figure-counter-major) "." counter(figure-counter-minor) ": ";
  }

  blockquote {
      border-left: 2px solid #bbb;
      color: #444;
  }

  /*
  In multipage, we need to reset the figure counter to the chapter
  number. Luckily, this is in the <h1 data-number> attribute. Unluckily,
  there is no way to get this in a general way.

  This doesn't work:

    h1[data-number] {
      counter-set: figure-counter-major attr(data-number);
    }

  Nor this:

    h1[data-number] {
      --figure-counter-major-value: attr(data-number);
      counter-set: figure-counter-major var(--figure-counter-major-value);
    }

  So, dumbly, we have a bunch of rules for all these sections, up to the
  maximum possible section.

  Here's a program to generate them:

    for (let i = 1; i < 100; i++)
        console.log(`h1[data-number="${i}"]{counter-set:figure-counter-major ${i};counter-reset:figure-counter-minor;}`);

  Note to self: never write a book with more than 99 frickin' chapters.
  */

  h1[data-number="1"]{counter-set:figure-counter-major 1;counter-reset:figure-counter-minor;}
  h1[data-number="2"]{counter-set:figure-counter-major 2;counter-reset:figure-counter-minor;}
  h1[data-number="3"]{counter-set:figure-counter-major 3;counter-reset:figure-counter-minor;}
  h1[data-number="4"]{counter-set:figure-counter-major 4;counter-reset:figure-counter-minor;}
  h1[data-number="5"]{counter-set:figure-counter-major 5;counter-reset:figure-counter-minor;}
  h1[data-number="6"]{counter-set:figure-counter-major 6;counter-reset:figure-counter-minor;}
  h1[data-number="7"]{counter-set:figure-counter-major 7;counter-reset:figure-counter-minor;}
  h1[data-number="8"]{counter-set:figure-counter-major 8;counter-reset:figure-counter-minor;}
  h1[data-number="9"]{counter-set:figure-counter-major 9;counter-reset:figure-counter-minor;}
  h1[data-number="10"]{counter-set:figure-counter-major 10;counter-reset:figure-counter-minor;}
  h1[data-number="11"]{counter-set:figure-counter-major 11;counter-reset:figure-counter-minor;}
  h1[data-number="12"]{counter-set:figure-counter-major 12;counter-reset:figure-counter-minor;}
  h1[data-number="13"]{counter-set:figure-counter-major 13;counter-reset:figure-counter-minor;}
  h1[data-number="14"]{counter-set:figure-counter-major 14;counter-reset:figure-counter-minor;}
  h1[data-number="15"]{counter-set:figure-counter-major 15;counter-reset:figure-counter-minor;}
  h1[data-number="16"]{counter-set:figure-counter-major 16;counter-reset:figure-counter-minor;}
  h1[data-number="17"]{counter-set:figure-counter-major 17;counter-reset:figure-counter-minor;}
  h1[data-number="18"]{counter-set:figure-counter-major 18;counter-reset:figure-counter-minor;}
  h1[data-number="19"]{counter-set:figure-counter-major 19;counter-reset:figure-counter-minor;}
  h1[data-number="20"]{counter-set:figure-counter-major 20;counter-reset:figure-counter-minor;}
  h1[data-number="21"]{counter-set:figure-counter-major 21;counter-reset:figure-counter-minor;}
  h1[data-number="22"]{counter-set:figure-counter-major 22;counter-reset:figure-counter-minor;}
  h1[data-number="23"]{counter-set:figure-counter-major 23;counter-reset:figure-counter-minor;}
  h1[data-number="24"]{counter-set:figure-counter-major 24;counter-reset:figure-counter-minor;}
  h1[data-number="25"]{counter-set:figure-counter-major 25;counter-reset:figure-counter-minor;}
  h1[data-number="26"]{counter-set:figure-counter-major 26;counter-reset:figure-counter-minor;}
  h1[data-number="27"]{counter-set:figure-counter-major 27;counter-reset:figure-counter-minor;}
  h1[data-number="28"]{counter-set:figure-counter-major 28;counter-reset:figure-counter-minor;}
  h1[data-number="29"]{counter-set:figure-counter-major 29;counter-reset:figure-counter-minor;}
  h1[data-number="30"]{counter-set:figure-counter-major 30;counter-reset:figure-counter-minor;}
  h1[data-number="31"]{counter-set:figure-counter-major 31;counter-reset:figure-counter-minor;}
  h1[data-number="32"]{counter-set:figure-counter-major 32;counter-reset:figure-counter-minor;}
  h1[data-number="33"]{counter-set:figure-counter-major 33;counter-reset:figure-counter-minor;}
  h1[data-number="34"]{counter-set:figure-counter-major 34;counter-reset:figure-counter-minor;}
  h1[data-number="35"]{counter-set:figure-counter-major 35;counter-reset:figure-counter-minor;}
  h1[data-number="36"]{counter-set:figure-counter-major 36;counter-reset:figure-counter-minor;}
  h1[data-number="37"]{counter-set:figure-counter-major 37;counter-reset:figure-counter-minor;}
  h1[data-number="38"]{counter-set:figure-counter-major 38;counter-reset:figure-counter-minor;}
  h1[data-number="39"]{counter-set:figure-counter-major 39;counter-reset:figure-counter-minor;}
  h1[data-number="40"]{counter-set:figure-counter-major 40;counter-reset:figure-counter-minor;}
  h1[data-number="41"]{counter-set:figure-counter-major 41;counter-reset:figure-counter-minor;}
  h1[data-number="42"]{counter-set:figure-counter-major 42;counter-reset:figure-counter-minor;}
  h1[data-number="43"]{counter-set:figure-counter-major 43;counter-reset:figure-counter-minor;}
  h1[data-number="44"]{counter-set:figure-counter-major 44;counter-reset:figure-counter-minor;}
  h1[data-number="45"]{counter-set:figure-counter-major 45;counter-reset:figure-counter-minor;}
  h1[data-number="46"]{counter-set:figure-counter-major 46;counter-reset:figure-counter-minor;}
  h1[data-number="47"]{counter-set:figure-counter-major 47;counter-reset:figure-counter-minor;}
  h1[data-number="48"]{counter-set:figure-counter-major 48;counter-reset:figure-counter-minor;}
  h1[data-number="49"]{counter-set:figure-counter-major 49;counter-reset:figure-counter-minor;}
  h1[data-number="50"]{counter-set:figure-counter-major 50;counter-reset:figure-counter-minor;}
  h1[data-number="51"]{counter-set:figure-counter-major 51;counter-reset:figure-counter-minor;}
  h1[data-number="52"]{counter-set:figure-counter-major 52;counter-reset:figure-counter-minor;}
  h1[data-number="53"]{counter-set:figure-counter-major 53;counter-reset:figure-counter-minor;}
  h1[data-number="54"]{counter-set:figure-counter-major 54;counter-reset:figure-counter-minor;}
  h1[data-number="55"]{counter-set:figure-counter-major 55;counter-reset:figure-counter-minor;}
  h1[data-number="56"]{counter-set:figure-counter-major 56;counter-reset:figure-counter-minor;}
  h1[data-number="57"]{counter-set:figure-counter-major 57;counter-reset:figure-counter-minor;}
  h1[data-number="58"]{counter-set:figure-counter-major 58;counter-reset:figure-counter-minor;}
  h1[data-number="59"]{counter-set:figure-counter-major 59;counter-reset:figure-counter-minor;}
  h1[data-number="60"]{counter-set:figure-counter-major 60;counter-reset:figure-counter-minor;}
  h1[data-number="61"]{counter-set:figure-counter-major 61;counter-reset:figure-counter-minor;}
  h1[data-number="62"]{counter-set:figure-counter-major 62;counter-reset:figure-counter-minor;}
  h1[data-number="63"]{counter-set:figure-counter-major 63;counter-reset:figure-counter-minor;}
  h1[data-number="64"]{counter-set:figure-counter-major 64;counter-reset:figure-counter-minor;}
  h1[data-number="65"]{counter-set:figure-counter-major 65;counter-reset:figure-counter-minor;}
  h1[data-number="66"]{counter-set:figure-counter-major 66;counter-reset:figure-counter-minor;}
  h1[data-number="67"]{counter-set:figure-counter-major 67;counter-reset:figure-counter-minor;}
  h1[data-number="68"]{counter-set:figure-counter-major 68;counter-reset:figure-counter-minor;}
  h1[data-number="69"]{counter-set:figure-counter-major 69;counter-reset:figure-counter-minor;}
  h1[data-number="70"]{counter-set:figure-counter-major 70;counter-reset:figure-counter-minor;}
  h1[data-number="71"]{counter-set:figure-counter-major 71;counter-reset:figure-counter-minor;}
  h1[data-number="72"]{counter-set:figure-counter-major 72;counter-reset:figure-counter-minor;}
  h1[data-number="73"]{counter-set:figure-counter-major 73;counter-reset:figure-counter-minor;}
  h1[data-number="74"]{counter-set:figure-counter-major 74;counter-reset:figure-counter-minor;}
  h1[data-number="75"]{counter-set:figure-counter-major 75;counter-reset:figure-counter-minor;}
  h1[data-number="76"]{counter-set:figure-counter-major 76;counter-reset:figure-counter-minor;}
  h1[data-number="77"]{counter-set:figure-counter-major 77;counter-reset:figure-counter-minor;}
  h1[data-number="78"]{counter-set:figure-counter-major 78;counter-reset:figure-counter-minor;}
  h1[data-number="79"]{counter-set:figure-counter-major 79;counter-reset:figure-counter-minor;}
  h1[data-number="80"]{counter-set:figure-counter-major 80;counter-reset:figure-counter-minor;}
  h1[data-number="81"]{counter-set:figure-counter-major 81;counter-reset:figure-counter-minor;}
  h1[data-number="82"]{counter-set:figure-counter-major 82;counter-reset:figure-counter-minor;}
  h1[data-number="83"]{counter-set:figure-counter-major 83;counter-reset:figure-counter-minor;}
  h1[data-number="84"]{counter-set:figure-counter-major 84;counter-reset:figure-counter-minor;}
  h1[data-number="85"]{counter-set:figure-counter-major 85;counter-reset:figure-counter-minor;}
  h1[data-number="86"]{counter-set:figure-counter-major 86;counter-reset:figure-counter-minor;}
  h1[data-number="87"]{counter-set:figure-counter-major 87;counter-reset:figure-counter-minor;}
  h1[data-number="88"]{counter-set:figure-counter-major 88;counter-reset:figure-counter-minor;}
  h1[data-number="89"]{counter-set:figure-counter-major 89;counter-reset:figure-counter-minor;}
  h1[data-number="90"]{counter-set:figure-counter-major 90;counter-reset:figure-counter-minor;}
  h1[data-number="91"]{counter-set:figure-counter-major 91;counter-reset:figure-counter-minor;}
  h1[data-number="92"]{counter-set:figure-counter-major 92;counter-reset:figure-counter-minor;}
  h1[data-number="93"]{counter-set:figure-counter-major 93;counter-reset:figure-counter-minor;}
  h1[data-number="94"]{counter-set:figure-counter-major 94;counter-reset:figure-counter-minor;}
  h1[data-number="95"]{counter-set:figure-counter-major 95;counter-reset:figure-counter-minor;}
  h1[data-number="96"]{counter-set:figure-counter-major 96;counter-reset:figure-counter-minor;}
  h1[data-number="97"]{counter-set:figure-counter-major 97;counter-reset:figure-counter-minor;}
  h1[data-number="98"]{counter-set:figure-counter-major 98;counter-reset:figure-counter-minor;}
  h1[data-number="99"]{counter-set:figure-counter-major 99;counter-reset:figure-counter-minor;}


  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
<style id="_fc_">[d__],[d__][style]{color:rgba(0, 0, 0, 1)!important}[s__='1']{font-size: calc(1px + 15%)!important}
[s__='2']{font-size: calc(2px + 15%)!important}
[s__='3']{font-size: calc(3px + 15%)!important}
[s__='4']{font-size: calc(4px + 15%)!important}
[s__='5']{font-size: calc(5px + 15%)!important}
[s__='6']{font-size: calc(6px + 15%)!important}
[s__='7']{font-size: calc(7px + 15%)!important}
[s__='8']{font-size: calc(8px + 15%)!important}
[s__='9']{font-size: calc(9px + 15%)!important}
[s__='10']{font-size: calc(10px + 15%)!important}
[s__='11']{font-size: calc(11px + 15%)!important}
[s__='12']{font-size: calc(12px + 15%)!important}
[s__='13']{font-size: calc(13px + 15%)!important}
[s__='14']{font-size: calc(14px + 15%)!important}
::placeholder{opacity:1!important;}[b__]{border:1px solid black!important}</style></head>
<body>
<header id="title-block-header">
<h1 class="title" d__="">Beej's Guide to Interprocess Communication</h1>
<p class="author" d__="">Brian “Beej Jorgensen” Hall</p>
<p class="date" d__="">v1.1.5, Copyright © November 2, 2024</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#intro" id="toc-intro" d__=""><span class="toc-section-number" d__="">1</span> Intro</a>
<ul>
<li><a href="#audience" id="toc-audience" d__=""><span class="toc-section-number" d__="">1.1</span> Audience</a></li>
<li><a href="#platform-and-compiler" id="toc-platform-and-compiler" d__=""><span class="toc-section-number" d__="">1.2</span> Platform and Compiler</a></li>
<li><a href="#official-homepage" id="toc-official-homepage" d__=""><span class="toc-section-number" d__="">1.3</span> Official Homepage</a></li>
<li><a href="#email-policy" id="toc-email-policy" d__=""><span class="toc-section-number" d__="">1.4</span> Email Policy</a></li>
<li><a href="#mirroring" id="toc-mirroring" d__=""><span class="toc-section-number" d__="">1.5</span> Mirroring</a></li>
<li><a href="#note-for-translators" id="toc-note-for-translators" d__=""><span class="toc-section-number" d__="">1.6</span> Note for Translators</a></li>
<li><a href="#copyright-and-distribution" id="toc-copyright-and-distribution" d__=""><span class="toc-section-number" d__="">1.7</span> Copyright and Distribution</a></li>
</ul></li>
<li><a href="#fork" id="toc-fork" d__=""><span class="toc-section-number" d__="">2</span> A <code s__="13" d__="">fork()</code> Primer</a>
<ul>
<li><a href="#seek-ye-the-gorge-of-eternal-peril" id="toc-seek-ye-the-gorge-of-eternal-peril" d__=""><span class="toc-section-number" d__="">2.1</span> “Seek ye the Gorge of Eternal Peril”</a></li>
<li><a href="#im-mentally-prepared-give-me-the-button" id="toc-im-mentally-prepared-give-me-the-button" d__=""><span class="toc-section-number" d__="">2.2</span> `“I’m mentally prepared! Give me <em d__="">The Button</em>!”</a></li>
<li><a href="#summary" id="toc-summary" d__=""><span class="toc-section-number" d__="">2.3</span> Summary</a></li>
</ul></li>
<li><a href="#signals" id="toc-signals" d__=""><span class="toc-section-number" d__="">3</span> Signals</a>
<ul>
<li><a href="#catching-signals-for-fun-and-profit" id="toc-catching-signals-for-fun-and-profit" d__=""><span class="toc-section-number" d__="">3.1</span> Catching Signals for Fun and Profit!</a></li>
<li><a href="#the-handler-is-not-omnipotent" id="toc-the-handler-is-not-omnipotent" d__=""><span class="toc-section-number" d__="">3.2</span> The Handler is not Omnipotent</a></li>
<li><a href="#what-about-signal" id="toc-what-about-signal" d__=""><span class="toc-section-number" d__="">3.3</span> What about <code s__="13" d__="">signal()</code></a></li>
<li><a href="#some-signals-to-make-you-popular" id="toc-some-signals-to-make-you-popular" d__=""><span class="toc-section-number" d__="">3.4</span> Some signals to make you popular</a></li>
<li><a href="#what-i-have-glossed-over" id="toc-what-i-have-glossed-over" d__=""><span class="toc-section-number" d__="">3.5</span> What I have Glossed Over</a></li>
</ul></li>
<li><a href="#pipes" id="toc-pipes" d__=""><span class="toc-section-number" d__="">4</span> Pipes</a>
<ul>
<li><a href="#these-pipes-are-clean" id="toc-these-pipes-are-clean" d__=""><span class="toc-section-number" d__="">4.1</span> “These pipes are clean!”</a></li>
<li><a href="#fork-and-pipeyou-have-the-power" id="toc-fork-and-pipeyou-have-the-power" d__=""><span class="toc-section-number" d__="">4.2</span> <code s__="13" d__="">fork()</code> and <code s__="13" d__="">pipe()</code>—you have the power!</a></li>
<li><a href="#the-search-for-pipe-as-we-know-it" id="toc-the-search-for-pipe-as-we-know-it" d__=""><span class="toc-section-number" d__="">4.3</span> The search for Pipe as we know it</a></li>
<li><a href="#summary-1" id="toc-summary-1" d__=""><span class="toc-section-number" d__="">4.4</span> Summary</a></li>
</ul></li>
<li><a href="#fifos" id="toc-fifos" d__=""><span class="toc-section-number" d__="">5</span> FIFOs</a>
<ul>
<li><a href="#a-new-fifo-is-born" id="toc-a-new-fifo-is-born" d__=""><span class="toc-section-number" d__="">5.1</span> A New FIFO is Born</a></li>
<li><a href="#producers-and-consumers" id="toc-producers-and-consumers" d__=""><span class="toc-section-number" d__="">5.2</span> Producers and Consumers</a></li>
<li><a href="#fifondelay" id="toc-fifondelay" d__=""><span class="toc-section-number" d__="">5.3</span> <code s__="13" d__="">O_NDELAY</code>! I’m UNSTOPPABLE!</a></li>
<li><a href="#concluding-notes" id="toc-concluding-notes" d__=""><span class="toc-section-number" d__="">5.4</span> Concluding Notes</a></li>
</ul></li>
<li><a href="#flocking" id="toc-flocking" d__=""><span class="toc-section-number" d__="">6</span> File Locking</a>
<ul>
<li><a href="#setting-a-lock" id="toc-setting-a-lock" d__=""><span class="toc-section-number" d__="">6.1</span> Setting a lock</a></li>
<li><a href="#clearing-a-lock" id="toc-clearing-a-lock" d__=""><span class="toc-section-number" d__="">6.2</span> Clearing a lock</a></li>
<li><a href="#a-demo-program" id="toc-a-demo-program" d__=""><span class="toc-section-number" d__="">6.3</span> A demo program</a></li>
<li><a href="#summary-2" id="toc-summary-2" d__=""><span class="toc-section-number" d__="">6.4</span> Summary</a></li>
</ul></li>
<li><a href="#mq" id="toc-mq" d__=""><span class="toc-section-number" d__="">7</span> Message Queues</a>
<ul>
<li><a href="#wheres-my-queue" id="toc-wheres-my-queue" d__=""><span class="toc-section-number" d__="">7.1</span> Where’s my queue?</a></li>
<li><a href="#mqftok" id="toc-mqftok" d__=""><span class="toc-section-number" d__="">7.2</span> “Are you the Key Master?”</a></li>
<li><a href="#sending-to-the-queue" id="toc-sending-to-the-queue" d__=""><span class="toc-section-number" d__="">7.3</span> Sending to the queue</a></li>
<li><a href="#receiving-from-the-queue" id="toc-receiving-from-the-queue" d__=""><span class="toc-section-number" d__="">7.4</span> Receiving from the queue</a></li>
<li><a href="#destroying-a-message-queue" id="toc-destroying-a-message-queue" d__=""><span class="toc-section-number" d__="">7.5</span> Destroying a message queue</a></li>
<li><a href="#sample-programs-anyone" id="toc-sample-programs-anyone" d__=""><span class="toc-section-number" d__="">7.6</span> Sample programs, anyone?</a></li>
<li><a href="#summary-3" id="toc-summary-3" d__=""><span class="toc-section-number" d__="">7.7</span> Summary</a></li>
</ul></li>
<li><a href="#semaphores" id="toc-semaphores" d__=""><span class="toc-section-number" d__="">8</span> Semaphores</a>
<ul>
<li><a href="#grabbing-some-semaphores" id="toc-grabbing-some-semaphores" d__=""><span class="toc-section-number" d__="">8.1</span> Grabbing some semaphores</a></li>
<li><a href="#controlling-your-semaphores-with-semctl" id="toc-controlling-your-semaphores-with-semctl" d__=""><span class="toc-section-number" d__="">8.2</span> Controlling your semaphores with <code s__="13" d__="">semctl()</code></a></li>
<li><a href="#semop-atomic-power" id="toc-semop-atomic-power" d__=""><span class="toc-section-number" d__="">8.3</span> <code s__="13" d__="">semop()</code>: Atomic power!</a></li>
<li><a href="#destroying-a-semaphore" id="toc-destroying-a-semaphore" d__=""><span class="toc-section-number" d__="">8.4</span> Destroying a semaphore</a></li>
<li><a href="#sample-programs" id="toc-sample-programs" d__=""><span class="toc-section-number" d__="">8.5</span> Sample Programs</a></li>
<li><a href="#summary-4" id="toc-summary-4" d__=""><span class="toc-section-number" d__="">8.6</span> Summary</a></li>
</ul></li>
<li><a href="#shm" id="toc-shm" d__=""><span class="toc-section-number" d__="">9</span> Shared Memory Segments</a>
<ul>
<li><a href="#creating-the-segment-and-connecting" id="toc-creating-the-segment-and-connecting" d__=""><span class="toc-section-number" d__="">9.1</span> Creating the segment and connecting</a></li>
<li><a href="#attach-megetting-a-pointer-to-the-segment" id="toc-attach-megetting-a-pointer-to-the-segment" d__=""><span class="toc-section-number" d__="">9.2</span> Attach me—getting a pointer to the segment</a></li>
<li><a href="#reading-and-writing" id="toc-reading-and-writing" d__=""><span class="toc-section-number" d__="">9.3</span> Reading and Writing</a></li>
<li><a href="#detaching-from-and-deleting-segments" id="toc-detaching-from-and-deleting-segments" d__=""><span class="toc-section-number" d__="">9.4</span> Detaching from and deleting segments</a></li>
<li><a href="#shmcon" id="toc-shmcon" d__=""><span class="toc-section-number" d__="">9.5</span> Concurrency</a></li>
<li><a href="#sample-code" id="toc-sample-code" d__=""><span class="toc-section-number" d__="">9.6</span> Sample code</a></li>
</ul></li>
<li><a href="#mmap" id="toc-mmap" d__=""><span class="toc-section-number" d__="">10</span> Memory Mapped Files</a>
<ul>
<li><a href="#mapmake" id="toc-mapmake" d__=""><span class="toc-section-number" d__="">10.1</span> Mapmake</a></li>
<li><a href="#unmapping-the-file" id="toc-unmapping-the-file" d__=""><span class="toc-section-number" d__="">10.2</span> Unmapping the file</a></li>
<li><a href="#concurrency-again" id="toc-concurrency-again" d__=""><span class="toc-section-number">10.3</span> Concurrency, again?!</a></li>
<li><a href="#a-simple-sample" id="toc-a-simple-sample" d__=""><span class="toc-section-number">10.4</span> A simple sample</a></li>
<li><a href="#observations-on-memory-mapping" id="toc-observations-on-memory-mapping" d__=""><span class="toc-section-number">10.5</span> Observations on memory mapping</a></li>
<li><a href="#summary-5" id="toc-summary-5" d__=""><span class="toc-section-number">10.6</span> Summary</a></li>
</ul></li>
<li><a href="#unixsock" id="toc-unixsock" d__=""><span class="toc-section-number">11</span> Unix Sockets</a>
<ul>
<li><a href="#overview" id="toc-overview" d__=""><span class="toc-section-number">11.1</span> Overview</a></li>
<li><a href="#what-to-do-to-be-a-server" id="toc-what-to-do-to-be-a-server" d__=""><span class="toc-section-number">11.2</span> What to do to be a Server</a></li>
<li><a href="#what-to-do-to-be-a-client" id="toc-what-to-do-to-be-a-client" d__=""><span class="toc-section-number">11.3</span> What to do to be a client</a></li>
<li><a href="#socketpairquick-full-duplex-pipes" id="toc-socketpairquick-full-duplex-pipes" d__=""><span class="toc-section-number">11.4</span> <code s__="13">socketpair()</code>—quick full-duplex pipes</a></li>
</ul></li>
<li><a href="#references" id="toc-references" d__=""><span class="toc-section-number">12</span> More IPC Resources</a>
<ul>
<li><a href="#books" id="toc-books" d__=""><span class="toc-section-number">12.1</span> Books</a></li>
<li><a href="#other-online-documentation" id="toc-other-online-documentation" d__=""><span class="toc-section-number">12.2</span> Other online documentation</a></li>
<li><a href="#linux-man-pages" id="toc-linux-man-pages" d__=""><span class="toc-section-number">12.3</span> Linux man pages</a></li>
</ul></li>
</ul>
</nav>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- No hyphenation -->
<!-- ======================================================= -->
<!-- Introduction -->
<!-- ======================================================= -->
<h1 data-number="1" id="intro" d__=""><span class="header-section-number">1</span> Intro</h1>
<p d__="">You know what’s easy? <code s__="13">fork()</code> is easy. 
You can fork off new processes all day and have them deal with 
individual chunks of a problem in parallel. Of course, its easiest if 
the processes don’t have to communicate with one another while they’re 
running and can just sit there doing their own thing.</p>
<p d__="">However, when you start <code s__="13">fork()</code>’ing 
processes, you immediately start to think of the neat multi-user things 
you could do if the processes could talk to each other easily. So you 
try making a global array and then <code s__="13">fork()</code>’ing to 
see if it is shared. (That is, see if both the child and parent process 
use the same array.) Soon, of course, you find that the child process 
has its own copy of the array and the parent is oblivious to whatever 
changes the child makes to it.</p>
<p d__="">How do you get these guys to talk to one another, share data 
structures, and be generally amicable? This document discusses several 
methods of <em>Interprocess Communication</em> (IPC) that can accomplish this, some of which are better suited to certain tasks than others.</p>
<!-- ======================================================= -->
<!-- Audience -->
<!-- ======================================================= -->
<h2 data-number="1.1" id="audience" d__=""><span class="header-section-number">1.1</span> Audience</h2>
<p d__="">If you know C or C++ and are pretty good using a Unix 
environment (or other POSIXey environment that supports these system 
calls) these documents are for you. If you aren’t that good, well, don’t
 sweat it—you’ll be able to figure it out. I make the assumption, 
however, that you have a fair smattering of C programming experience.</p>
<p d__="">As with <a href="https://beej.us/guide/bgnet" d__="">Beej’s Guide to Network Programming Using Internet Sockets</a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup s__="13" d__="">1</sup></a>,
 these documents are meant to springboard the aforementioned user into 
the realm of IPC by delivering a concise overview of various IPC 
techniques. This is not the definitive set of documents that cover this 
subject, by any means. Like I said, it is designed to simply give you a 
foothold in this, the exciting world of IPC.</p>
<!-- ======================================================= -->
<!-- Platform and Compiler -->
<!-- ======================================================= -->
<h2 data-number="1.2" id="platform-and-compiler" d__=""><span class="header-section-number">1.2</span> Platform and Compiler</h2>
<p d__="">The examples in this document were compiled under Linux using <code s__="13">gcc</code>. They should compile anywhere a good Unix compiler is available.</p>
<!-- ======================================================= -->
<!-- Homepage -->
<!-- ======================================================= -->
<h2 data-number="1.3" id="official-homepage" d__=""><span class="header-section-number">1.3</span> Official Homepage</h2>
<p d__="">This official location of this document is <a href="https://beej.us/guide/bgipc"><code s__="13" d__="">https://beej.us/guide/bgipc/</code></a><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup s__="13" d__="">2</sup></a>.</p>
<!-- ======================================================= -->
<!-- Email policy -->
<!-- ======================================================= -->
<h2 data-number="1.4" id="email-policy" d__=""><span class="header-section-number">1.4</span> Email Policy</h2>
<p d__="">I’m generally available to help out with email questions so 
feel free to write in, but I can’t guarantee a response. I lead a pretty
 busy life and there are times when I just can’t answer a question you 
have. When that’s the case, I usually just delete the message. It’s 
nothing personal; I just won’t ever have the time to give the detailed 
answer you require.</p>
<p d__="">As a rule, the more complex the question, the less likely I am
 to respond. If you can narrow down your question before mailing it and 
be sure to include any pertinent information (like platform, compiler, 
error messages you’re getting, and anything else you think might help me
 troubleshoot), you’re much more likely to get a response.</p>
<p d__="">If you don’t get a response, hack on it some more, try to find
 the answer, and if it’s still elusive, then write me again with the 
information you’ve found and hopefully it will be enough for me to help 
out.</p>
<p d__="">Now that I’ve badgered you about how to write and not write me, I’d just like to let you know that I <em>fully</em>
 appreciate all the praise the guide has received over the years. It’s a
 real morale boost, and it gladdens me to hear that it is being used for
 good! <code s__="13">:-)</code> Thank you!</p>
<!-- ======================================================= -->
<!-- Mirroring -->
<!-- ======================================================= -->
<h2 data-number="1.5" id="mirroring" d__=""><span class="header-section-number">1.5</span> Mirroring</h2>
<p d__="">You are more than welcome to mirror this site, whether 
publicly or privately. If you publicly mirror the site and want me to 
link to it from the main page, drop me a line at <a href="mailto:beej@beej.us"><code s__="13" d__="">beej@beej.us</code></a>.</p>
<!-- ======================================================= -->
<!-- Translators -->
<!-- ======================================================= -->
<h2 data-number="1.6" id="note-for-translators" d__=""><span class="header-section-number">1.6</span> Note for Translators</h2>
<p d__="">If you want to translate the guide into another language, write me at [<code s__="13">beej@beej.us</code>] and I’ll link to your translation from the main page. Feel free to add your name and contact info to the translation.</p>
<p d__="">Please note the license restrictions in the Copyright and Distribution section, below.</p>
<!-- ======================================================= -->
<!-- Copyright -->
<!-- ======================================================= -->
<h2 data-number="1.7" id="copyright-and-distribution" d__=""><span class="header-section-number">1.7</span> Copyright and Distribution</h2>
<p d__="">Beej’s Guide to Network Programming is Copyright © 2021 Brian “Beej Jorgensen” Hall.</p>
<p d__="">With specific exceptions for source code and translations, 
below, this work is licensed under the Creative Commons 
Attribution-Noncommercial-No Derivative Works 3.0 License. To view a 
copy of this license, visit <a href="https://creativecommons.org/licenses/by-nc-nd/3.0/"><code s__="13" d__="">https://creativecommons.org/licenses/by-nc-nd/3.0/</code></a> or send a letter to Creative Commons, 171 Second Street, Suite 300, San Francisco, California, 94105, USA.</p>
<p d__="">One specific exception to the “No Derivative Works” portion of
 the license is as follows: this guide may be freely translated into any
 language, provided the translation is accurate, and the guide is 
reprinted in its entirety. The same license restrictions apply to the 
translation as to the original guide. The translation may also include 
the name and contact information for the translator.</p>
<p d__="">The C source code presented in this document is hereby granted
 to the public domain, and is completely free of any license 
restriction.</p>
<p d__="">Educators are freely encouraged to recommend or supply copies of this guide to their students.</p>
<p d__="">Contact <a href="mailto:beej@beej.us"><code s__="13" d__="">beej@beej.us</code></a> for more information.</p>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- ======================================================= -->
<!-- Fork -->
<!-- ======================================================= -->
<h1 data-number="2" id="fork" d__=""><span class="header-section-number">2</span> A <code>fork()</code> Primer</h1>
<p d__="">“Fork”, aside from being one of those words that begins to 
appear very strange after you’ve typed it repeatedly, refers to the way 
Unix creates new processes. This document gives a quick and dirty <code s__="13">fork()</code> primer, since use of that system call will pop up in other IPC documents. If you already know all about <code s__="13">fork()</code>, you might as well skip this document.</p>
<!-- ======================================================= -->
<!-- "Seek ye the Gorge of Eternal Peril" -->
<!-- ======================================================= -->
<h2 data-number="2.1" id="seek-ye-the-gorge-of-eternal-peril" d__=""><span class="header-section-number">2.1</span> “Seek ye the Gorge of Eternal Peril”</h2>
<p d__=""><code s__="13">fork()</code> can be thought of as a ticket to 
power. Power can sometimes be thought of as a ticket to destruction. 
Therefore, you should be careful while messing with <code s__="13">fork()</code>
 on your system, especially while people are cranking their nearly-late 
semester projects and are ready to nuke the first organism that brings 
the system to a halt. It’s not that you should never play with <code s__="13">fork()</code>, you just have to be cautious. It’s kind of like sword—swallowing; if you’re careful, you won’t disembowel yourself.</p>
<p d__="">Since you’re still here, I suppose I’d better deliver the goods. Like I said, <code s__="13">fork()</code> is how Unix starts new processes. Basically, how it works is this: the parent process (the one that already exists) <code s__="13">fork()</code>’s a child process (the new one). The child process gets a <em>copy</em> of the parent’s data. <em>Voila!</em> You have two processes where there was only one!</p>
<p d__="">Of course, there are all kinds of gotchas you must deal with when <code s__="13">fork()</code>ing
 processes or else your sysadmin will get irate with you when you fill 
of the system process table and they have to punch the reset button on 
the machine.</p>
<p d__="">First of all, you should know something of process behavior 
under Unix. When a process dies, it doesn’t really go away completely. 
It’s dead, so it’s no longer running, but a small remnant is waiting 
around for the parent process to pick up. This remnant contains the 
return value from the child process and some other goop. So after a 
parent process <code s__="13">fork()</code>s a child process, it must <code s__="13">wait()</code> (or <code s__="13">waitpid()</code>) for that child process to exit. It is this act of <code s__="13">wait()</code>ing that allows all remnants of the child to vanish.</p>
<p d__="">Naturally, there is an exception to the above rule: the parent can ignore the <code s__="13">SIGCHLD</code> signal (<code s__="13">SIGCLD</code> on some older systems) and then it won’t have to <code s__="13">wait()</code>. This can be done (on systems that support it) like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb1-1" d__=""><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>main<span class="op" d__="">()</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">{</span></span>
<span id="cb1-3" d__=""><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    signal<span class="op" d__="">(</span>SIGCHLD<span class="op" d__="">,</span> SIG_IGN<span class="op" d__="">);</span>  <span class="co" d__="">/* now I don't have to wait()! */</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">.</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">.</span></span>
<span id="cb1-6" d__=""><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    fork<span class="op" d__="">();</span>fork<span class="op" d__="">();</span>fork<span class="op" d__="">();</span>  <span class="co" d__="">/* Rabbits, rabbits, rabbits! */</span></span></code></pre></div>
<p d__="">Now, when a child process dies and has not been <code s__="13">wait()</code>ed on, it will usually show up in a <code s__="13">ps</code> listing as “<code s__="13">&lt;defunct&gt;</code>”. It will remain this way until the parent <code s__="13">wait()</code>s on it, or it is dealt with as mentioned below.</p>
<p d__="">Now there is another rule you must learn: when the parent dies before it <code s__="13">wait()</code>s for the child (assuming it is not ignoring <code s__="13">SIGCHLD</code>), the child is reparented to the <code s__="13">init</code>
 process (PID 1). This is not a problem if the child is still living 
well and under control. However, if the child is already defunct, we’re 
in a bit of a bind. See, the original parent can no longer <code s__="13">wait()</code>, since it’s dead. So how does <code s__="13">init</code> know to <code s__="13">wait()</code> for these <em>zombie processes</em>?</p>
<p d__="">The answer: it’s magic! Well, on some systems, <code s__="13">init</code>
 periodically destroys all the defunct processes it owns. On other 
systems, it outright refuses to become the parent of any defunct 
processes, instead destroying them immediately. If you’re using one of 
the former systems, you could easily write a loop that fills up the 
process table with defunct processes owned by <code s__="13">init</code>. Wouldn’t that make your sysadmin happy?</p>
<p d__="">Your mission: make sure your parent process either ignores <code s__="13">SIGCHLD</code>, or <code s__="13">wait()</code>s for all the children it <code s__="13">fork()</code>s. Well, you don’t <em>always</em> have to do that (like if you’re starting a daemon or something), but you code with caution if you’re a <code s__="13">fork()</code> novice. Otherwise, feel free to blast off into the stratosphere.</p>
<p d__="">To summerize: children become defunct until the parent <code s__="13">wait()</code>s, unless the parent is ignoring <code s__="13">SIGCHLD</code>. Furthermore, children (living or defunct) whose parents die without <code s__="13">wait()</code>ing for them (again assuming the parent is not ignoring <code s__="13">SIGCHLD</code>) become children of the <code s__="13">init</code> process, which deals with them heavy-handedly.</p>
<!-- ======================================================= -->
<!-- "I'm mentally prepared! Give me The Button!" -->
<!-- ======================================================= -->
<h2 data-number="2.2" id="im-mentally-prepared-give-me-the-button" d__=""><span class="header-section-number">2.2</span> `“I’m mentally prepared! Give me <em>The Button</em>!”</h2>
<p d__="">Right! Here’s an <a href="https://beej.us/guide/bgipc/source/examples/fork1.c" d__="">example</a><a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup s__="13" d__="">3</sup></a> of how to use <code s__="13">fork()</code>:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb2-1"><a href="#cb2-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/wait.h&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8" d__=""><a href="#cb2-8"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="op" d__="">{</span></span>
<span id="cb2-10" d__=""><a href="#cb2-10"></a>    pid_t pid<span class="op" d__="">;</span></span>
<span id="cb2-11" d__=""><a href="#cb2-11"></a>    <span class="dt" d__="">int</span> rv<span class="op" d__="">;</span></span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13" d__=""><a href="#cb2-13"></a>    <span class="cf" d__="">switch</span><span class="op" d__="">(</span>pid <span class="op" d__="">=</span> fork<span class="op" d__="">())</span> <span class="op" d__="">{</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>    <span class="cf" d__="">case</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">:</span></span>
<span id="cb2-15" d__=""><a href="#cb2-15"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"fork"</span><span class="op" d__="">);</span>  <span class="co" d__="">/* something went wrong */</span></span>
<span id="cb2-16" d__=""><a href="#cb2-16"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span>         <span class="co" d__="">/* parent exits */</span></span>
<span id="cb2-17"><a href="#cb2-17"></a></span>
<span id="cb2-18"><a href="#cb2-18"></a>    <span class="cf" d__="">case</span> <span class="dv" d__="">0</span><span class="op" d__="">:</span></span>
<span id="cb2-19" d__=""><a href="#cb2-19"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">" CHILD: This is the child process!</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb2-20" d__=""><a href="#cb2-20"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">" CHILD: My PID is </span><span class="sc" d__="">%d\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> getpid<span class="op" d__="">());</span></span>
<span id="cb2-21" d__=""><a href="#cb2-21"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">" CHILD: My parent's PID is </span><span class="sc" d__="">%d\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> getppid<span class="op" d__="">());</span></span>
<span id="cb2-22" d__=""><a href="#cb2-22"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">" CHILD: Enter my exit status (make it small): "</span><span class="op" d__="">);</span></span>
<span id="cb2-23" d__=""><a href="#cb2-23"></a>        scanf<span class="op" d__="">(</span><span class="st" d__="">" </span><span class="sc" d__="">%d</span><span class="st" d__="">"</span><span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>rv<span class="op" d__="">);</span></span>
<span id="cb2-24" d__=""><a href="#cb2-24"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">" CHILD: I'm outta here!</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb2-25" d__=""><a href="#cb2-25"></a>        exit<span class="op" d__="">(</span>rv<span class="op" d__="">);</span></span>
<span id="cb2-26"><a href="#cb2-26"></a></span>
<span id="cb2-27"><a href="#cb2-27"></a>    <span class="cf" d__="">default</span><span class="op" d__="">:</span></span>
<span id="cb2-28" d__=""><a href="#cb2-28"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"PARENT: This is the parent process!</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb2-29" d__=""><a href="#cb2-29"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"PARENT: My PID is </span><span class="sc" d__="">%d\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> getpid<span class="op" d__="">());</span></span>
<span id="cb2-30" d__=""><a href="#cb2-30"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"PARENT: My child's PID is </span><span class="sc" d__="">%d\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> pid<span class="op" d__="">);</span></span>
<span id="cb2-31" d__=""><a href="#cb2-31"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"PARENT: I'm now waiting for my child to exit()...</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb2-32" d__=""><a href="#cb2-32"></a>        wait<span class="op" d__="">(&amp;</span>rv<span class="op" d__="">);</span></span>
<span id="cb2-33" d__=""><a href="#cb2-33"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"PARENT: My child's exit status is: </span><span class="sc" d__="">%d\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> WEXITSTATUS<span class="op" d__="">(</span>rv<span class="op" d__="">));</span></span>
<span id="cb2-34" d__=""><a href="#cb2-34"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"PARENT: I'm outta here!</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>    <span class="op" d__="">}</span></span>
<span id="cb2-36"><a href="#cb2-36"></a></span>
<span id="cb2-37"><a href="#cb2-37"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb2-38"><a href="#cb2-38"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">There is a ton of stuff to note from this example, so we’ll just start from the top, shall we?</p>
<p d__=""><code s__="13">pid_t</code> is the generic process type. Under Unix, this is a <code s__="13">short</code>. So, I call <code s__="13">fork()</code> and save the return value in the <code s__="13">pid</code> variable. <code s__="13">fork()</code> is easy, since it can only return three things:</p>
<table>
<colgroup>
<col style="width: 16%">
<col style="width: 83%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;" d__="">Return Value</th>
<th d__="">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">0</code></td>
<td d__="">If it returns <code s__="13">0</code>, you are the child process. You can get the parent’s PID by calling <code s__="13">getppid()</code>. Of course, you can get your own PID by calling <code s__="13">getpid()</code>.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">-1</code></td>
<td d__="">If it returns <code s__="13">-1</code>, something went wrong, and no child was created. Use <code s__="13">perror()</code>
 to see what happened. You’ve probably filled the process table—if you 
turn around you’ll see your sysadmin coming at you with a fireaxe.</td>
</tr>
<tr class="odd">
<td style="text-align: center;" d__="">Anthing else</td>
<td d__="">Any other value returned by <code s__="13">fork()</code> 
means that you’re the parent and the value returned is the PID of your 
child. This is the only way to get the PID of your child, since there is
 no <code s__="13">getcpid()</code> call (obviously due to the one-to-many relationship between parents and children.)</td>
</tr>
</tbody>
</table>
<p d__="">When the child finally calls <code s__="13">exit()</code>, the return value passed will arrive at the parent when it <code s__="13">wait()</code>s. As you can see from the <code s__="13">wait()</code> call, there’s some weirdness coming into play when we print the return value. What’s this <code s__="13">WEXITSTATUS()</code> stuff, anyway? Well, that is a macro that extracts the child’s actual return value from the value <code s__="13">wait()</code> returns. Yes, there is more information buried in that <code s__="13">int</code>. I’ll let you look it up on your own.</p>
<p d__="">“How,” you ask, “does <code s__="13">wait()</code> know which process to wait for? I mean, since the parent can have multiple children, which one does <code s__="13">wait()</code>
 actually wait for?” The answer is simple, my friends: it waits for 
whichever one happens to exit first. If you must, you can specify 
exactly which child to wait for by calling <code s__="13">waitpid()</code> with your child’s PID as an argument.</p>
<p d__="">Another interesting thing to note from the above example is that both parent and child use the <code s__="13">rv</code> variable. Does this mean that it is shared between the processes? <em>NO!</em> If it was, I wouldn’t have written all this IPC stuff. <em>Each process has its own copy of all variables.</em> There is a lot of other stuff that is copied, too, but you’ll have to read the <code s__="13">man</code> page to see what.</p>
<p d__="">A final note about the above program: I used a switch statement to handle the <code s__="13">fork()</code>, and that’s not exactly typical. Most often you’ll see an <statement>if</statement> statement there; sometimes it’s as short as:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb3-1" d__=""><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">if</span> <span class="op" d__="">(!</span>fork<span class="op" d__="">())</span> <span class="op" d__="">{</span></span>
<span id="cb3-2" d__=""><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"I'm the child!</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb3-3" d__=""><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">0</span><span class="op" d__="">);</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">}</span> <span class="cf" d__="">else</span> <span class="op" d__="">{</span></span>
<span id="cb3-5" d__=""><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"I'm the parent!</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb3-6" d__=""><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        wait<span class="op" d__="">(</span>NULL<span class="op" d__="">);</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">}</span></span></code></pre></div>
<p d__="">Oh yeah—the above example also demonstrates how to <code s__="13">wait()</code> if you don’t care what the return value of the child is: you just call it with <code s__="13">NULL</code> as the argument.</p>
<!-- ======================================================= -->
<!-- Fork summary -->
<!-- ======================================================= -->
<h2 data-number="2.3" id="summary" d__=""><span class="header-section-number">2.3</span> Summary</h2>
<p d__="">Now you know all about the mighty <code s__="13">fork()</code>
 function! It’s more useful than a wet bag of worms in most 
computationally intensive situations, and you can amaze your friends at 
parties. I swear. Try it.</p>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- ======================================================= -->
<!-- Signals -->
<!-- ======================================================= -->
<h1 data-number="3" id="signals" d__=""><span class="header-section-number">3</span> Signals</h1>
<p d__="">There is a sometimes useful method for one process to bug 
another: signals. Basically, one process can “raise” a signal and have 
it delivered to another process. The destination process’s signal 
handler (just a function) is invoked and the process can handle it.</p>
<p d__="">The devil’s in the details, of course, and in actuality what 
you are permitted to do safely inside your signal handler is rather 
limited. Nevertheless, signals provide a useful service.</p>
<p d__="">For example, one process might want to stop another one, and this can be done by sending the signal <code s__="13">SIGSTOP</code> to that process. To continue, the process has to receive signal <code s__="13">SIGCONT</code>.
 How does the process know to do this when it receives a certain signal?
 Well, many signals are predefined and the process has a default signal 
handler to deal with it.</p>
<p d__="">A default handler? Yes. Take <code s__="13">SIGINT</code> for example. This is the interrupt signal that a process receives when the user hits <code s__="13">^C</code>. The default signal handler for <code s__="13">SIGINT</code> causes the process to exit! Sound familiar? Well, as you can imagine, you can override the <code s__="13">SIGINT</code> to do whatever you want (or nothing at all!) You could have your process <code s__="13">printf()</code> “Interrupt?! No way, Jose!” and go about its merry business.</p>
<p d__="">So now you know that you can have your process respond to just
 about any signal in just about any way you want. Naturally, there are 
exceptions because otherwise it would be too easy to understand. Take 
the ever popular <code s__="13">SIGKILL</code>, signal #9. Have you ever typed “<code s__="13">kill -9 _nnnn_</code>” to kill a runaway process? You were sending it <code s__="13">SIGKILL</code>. Now you might also remember that no process can get out of a “<code s__="13">kill -9</code>”, and you would be correct. <code s__="13">SIGKILL</code> is one of the signals you <code s__="13">can't</code> add your own signal handler for. The aforementioned <code s__="13">SIGSTOP</code> is also in this category.</p>
<p d__="">(Aside: you often use the Unix “<code s__="13">kill</code>” command without specifying a signal to send…so what signal is it? The answer: <code s__="13">SIGTERM</code>. You can write your own handler for <code s__="13">SIGTERM</code> so your process won’t respond to a regular “<code s__="13">kill</code>”, and the user must then use “<code s__="13">kill -9</code>” to destroy the process.)</p>
<p d__="">Are all the signals predefined? What if you want to send a 
signal that has significance that only you understand to a process? 
There are two signals that aren’t reserved: <code s__="13">SIGUSR1</code> and <code s__="13">SIGUSR2</code>.
 You are free to use these for whatever you want and handle them in 
whatever way you choose. (For example, my cd player program might 
respond to <code s__="13">SIGUSR1</code> by advancing to the next track. In this way, I could control it from the command line by typing “<code s__="13">kill -SIGUSR1</code>nnnn``”.)</p>
<h2 data-number="3.1" id="catching-signals-for-fun-and-profit" d__=""><span class="header-section-number">3.1</span> Catching Signals for Fun and Profit!</h2>
<p d__="">As you can guess the Unix “kill” command is one way to send 
signals to a process. By sheer unbelievable coincidence, there is a 
system call called <code s__="13">kill()</code> which does the same thing. It takes for its argument a signal number (as defined in <code s__="13">signal.h</code>) and a process ID. Also, there is a library routine called <code s__="13">raise()</code> which can be used to raise a signal within the same process.</p>
<p d__="">The burning question remains: how do you catch a speeding <code s__="13">SIGTERM</code>? You need to call <code s__="13">sigaction()</code> and tell it all the gritty details about which signal you want to catch and which function you want to call to handle it.</p>
<p d__="">Here’s the <code s__="13">sigaction()</code> breakdown:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb4-1" d__=""><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> sigaction<span class="op" d__="">(</span><span class="dt" d__="">int</span> sig<span class="op" d__="">,</span> <span class="dt" d__="">const</span> <span class="kw" d__="">struct</span> sigaction <span class="op" d__="">*</span>act<span class="op" d__="">,</span></span>
<span id="cb4-2" d__=""><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>              <span class="kw" d__="">struct</span> sigaction <span class="op" d__="">*</span>oact<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">The first parameter, <code s__="13">sig</code> is which signal to catch. This can be (probably “should” be) a symbolic name from <code s__="13">signal.h</code> along the lines of <code s__="13">SIGINT</code>. That’s the easy bit.</p>
<p d__="">The next field, <code s__="13">act</code> is a pointer to a <code s__="13">struct sigaction</code>
 which has a bunch of fields that you can fill in to control the 
behavior of the signal handler. (A pointer to the signal handler 
function itself included in the <code s__="13">struct</code>.)</p>
<p d__="">Lastly <code s__="13">oact</code> can be <code s__="13">NULL</code>, but if not, it returns the <em>old</em>
 signal handler information that was in place before. This is useful if 
you want to restore the previous signal handler at a later time.</p>
<p d__="">We’ll focus on these three fields in the <code s__="13">struct sigaction</code>:</p>
<table>
<colgroup>
<col style="width: 17%">
<col style="width: 82%">
</colgroup>
<thead>
<tr class="header">
<th d__="">Signal</th>
<th d__="">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code s__="13" d__="">sa_handler</code></td>
<td d__="">The signal handler function (or <code s__="13">SIG_IGN</code> to ignore the signal)</td>
</tr>
<tr class="even">
<td><code s__="13" d__="">sa_mask</code></td>
<td d__="">A set of signals to block while this one is being handled</td>
</tr>
<tr class="odd">
<td><code s__="13" d__="">sa_flags</code></td>
<td d__="">Flags to modify the behavior of the handler, or <code s__="13">0</code></td>
</tr>
</tbody>
</table>
<p d__="">What about that <code s__="13">sa_mask</code> field? When 
you’re handling a signal, you might want to block other signals from 
being delivered, and you can do this by adding them to the <code s__="13">sa_mask</code> It’s a “set”, which means you can do normal set operations to manipulate them: <code s__="13">sigemptyset()</code>, <code s__="13">sigfillset()</code>, <code s__="13">sigaddset()</code>, <code s__="13">sigdelset()</code>, and <code s__="13">sigismember()</code>. In this example, we’ll just clear the set and not block any other signals.</p>
<p d__="">Examples always help! Here’s one that handled <code s__="13">SIGINT</code>, which can be delivered by hitting <code s__="13">^C</code>, called <a href="https://beej.us/guide/bgipc/source/examples/sigint.c"><code s__="13" d__="">sigint.c</code></a><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup s__="13" d__="">4</sup></a>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb5-1"><a href="#cb5-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;signal.h&gt;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7" d__=""><a href="#cb5-7"></a><span class="dt" d__="">void</span> sigint_handler<span class="op" d__="">(</span><span class="dt" d__="">int</span> sig<span class="op" d__="">)</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="op" d__="">{</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>        <span class="co" d__="">/* using a char[] so that sizeof will work */</span></span>
<span id="cb5-10" d__=""><a href="#cb5-10"></a>    <span class="dt" d__="">const</span> <span class="dt" d__="">char</span> msg<span class="op" d__="">[]</span> <span class="op" d__="">=</span> <span class="st" d__="">"Ahhh! SIGINT!</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">;</span></span>
<span id="cb5-11" d__=""><a href="#cb5-11"></a>    write<span class="op" d__="">(</span><span class="dv" d__="">0</span><span class="op" d__="">,</span> msg<span class="op" d__="">,</span> <span class="kw" d__="">sizeof</span><span class="op" d__="">(</span>msg<span class="op" d__="">));</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="op" d__="">}</span></span>
<span id="cb5-13"><a href="#cb5-13"></a></span>
<span id="cb5-14" d__=""><a href="#cb5-14"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="op" d__="">{</span></span>
<span id="cb5-16" d__=""><a href="#cb5-16"></a>    <span class="dt" d__="">char</span> s<span class="op" d__="">[</span><span class="dv" d__="">200</span><span class="op" d__="">];</span></span>
<span id="cb5-17" d__=""><a href="#cb5-17"></a>        <span class="kw" d__="">struct</span> sigaction sa <span class="op" d__="">=</span> <span class="op" d__="">{</span></span>
<span id="cb5-18" d__=""><a href="#cb5-18"></a>            <span class="op" d__="">.</span>sa_handler <span class="op" d__="">=</span> sigint_handler<span class="op" d__="">,</span></span>
<span id="cb5-19" d__=""><a href="#cb5-19"></a>            <span class="op" d__="">.</span>sa_flags <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span> <span class="co" d__="">// or SA_RESTART</span></span>
<span id="cb5-20" d__=""><a href="#cb5-20"></a>            <span class="op" d__="">.</span>sa_mask <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>        <span class="op" d__="">};</span></span>
<span id="cb5-22"><a href="#cb5-22"></a></span>
<span id="cb5-23" d__=""><a href="#cb5-23"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>sigaction<span class="op" d__="">(</span>SIGINT<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>sa<span class="op" d__="">,</span> NULL<span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb5-24" d__=""><a href="#cb5-24"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"sigaction"</span><span class="op" d__="">);</span></span>
<span id="cb5-25" d__=""><a href="#cb5-25"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb5-26"><a href="#cb5-26"></a>    <span class="op" d__="">}</span></span>
<span id="cb5-27"><a href="#cb5-27"></a></span>
<span id="cb5-28" d__=""><a href="#cb5-28"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Enter a string:</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb5-29"><a href="#cb5-29"></a></span>
<span id="cb5-30" d__=""><a href="#cb5-30"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>fgets<span class="op" d__="">(</span>s<span class="op" d__="">,</span> <span class="kw" d__="">sizeof</span> s<span class="op" d__="">,</span> stdin<span class="op" d__="">)</span> <span class="op" d__="">==</span> NULL<span class="op" d__="">)</span></span>
<span id="cb5-31" d__=""><a href="#cb5-31"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"fgets"</span><span class="op" d__="">);</span></span>
<span id="cb5-32"><a href="#cb5-32"></a>    <span class="cf" d__="">else</span> </span>
<span id="cb5-33" d__=""><a href="#cb5-33"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"You entered: </span><span class="sc" d__="">%s\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> s<span class="op" d__="">);</span></span>
<span id="cb5-34"><a href="#cb5-34"></a></span>
<span id="cb5-35"><a href="#cb5-35"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb5-36"><a href="#cb5-36"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">This program has two functions: <code s__="13">main()</code> which sets up the signal handler (using the <code s__="13">sigaction()</code> call), and <code s__="13">sigint_handler()</code> which is the signal handler, itself.</p>
<p d__="">What happens when you run it? If you are in the midst of entering a string and you hit <code s__="13">^C</code>, the call to <code s__="13">gets()</code> fails and sets the global variable <code s__="13">errno</code> to <code s__="13">EINTR</code>. Additionally, <code s__="13">sigint_handler()</code> is called and does its routine, so you actually see:</p>
<pre><code s__="13" d__="">Enter a string:
the quick brown fox jum^CAhhh! SIGINT!
fgets: Interrupted system call</code></pre>
<p d__="">And then it exits. Hey—what kind of handler is this, if it just exits anyway?</p>
<p d__="">Well, we have a couple things at play, here. First, you’ll 
notice that the signal handler was called, because it printed “Ahhh! 
SIGINT!” But then <code s__="13">fgets()</code> returns an error, namely <code s__="13">EINTR</code>,
 or “Interrupted system call”. See, some system calls can be interrupted
 by signals, and when this happens, they return an error. You might see 
code like this (sometimes cited as an excusable use of <code s__="13">goto</code>):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb7-1" d__=""><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>restart<span class="op" d__="">:</span></span>
<span id="cb7-2" d__=""><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>some_system_call<span class="op" d__="">()</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb7-3" d__=""><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf" d__="">if</span> <span class="op" d__="">(</span>errno <span class="op" d__="">==</span> EINTR<span class="op" d__="">)</span> <span class="cf" d__="">goto</span> restart<span class="op" d__="">;</span></span>
<span id="cb7-4" d__=""><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"some_system_call"</span><span class="op" d__="">);</span></span>
<span id="cb7-5" d__=""><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">}</span></span></code></pre></div>
<p d__="">Instead of using <code s__="13">goto</code> like that, you might be able to set your <code s__="13">sa_flags</code> to include <code s__="13">SA_RESTART</code>. For example, if we change our <code s__="13">SIGINT</code> handler code to look like this:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb8-1" d__=""><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    sa<span class="op" d__="">.</span>sa_flags <span class="op" d__="">=</span> SA_RESTART<span class="op" d__="">;</span></span></code></pre></div>
<p d__="">Then our run looks more like this:</p>
<pre><code s__="13" d__="">Enter a string:
Hello^CAhhh! SIGINT!
Er, hello!^CAhhh! SIGINT!
This time fer sure!
You entered: This time fer sure!</code></pre>
<p d__="">Some system calls are interruptible, and some can be restarted. It’s system dependent.</p>
<h2 data-number="3.2" id="the-handler-is-not-omnipotent" d__=""><span class="header-section-number">3.2</span> The Handler is not Omnipotent</h2>
<p d__="">You have to be careful when you make function calls in your 
signal handler. Those functions must be “async safe”, so they can be 
called without invoking undefined behavior.</p>
<p d__="">You might be curious, for instance, why my signal handler, above, called <code s__="13">write()</code> to output the message instead of <code s__="13">printf()</code>. Well, the answer is that POSIX says that <code s__="13">write()</code> is async-safe (so is safe to call from within the handler), while <code s__="13">printf()</code> is not.</p>
<p d__="">The library functions and system calls that are async-safe and can be called from within your signal handlers are (breath):</p>
<p d__=""><code s__="13">_Exit()</code>, <code s__="13">_exit()</code>, <code s__="13">abort()</code>, <code s__="13">accept()</code>, <code s__="13">access()</code>, <code s__="13">aio_error()</code>, <code s__="13">aio_return()</code>, <code s__="13">aio_suspend()</code>, <code s__="13">alarm()</code>, <code s__="13">bind()</code>, <code s__="13">cfgetispeed()</code>, <code s__="13">cfgetospeed()</code>, <code s__="13">cfsetispeed()</code>, <code s__="13">cfsetospeed()</code>, <code s__="13">chdir()</code>, <code s__="13">chmod()</code>, <code s__="13">chown()</code>, <code s__="13">clock_gettime()</code>, <code s__="13">close()</code>, <code s__="13">connect()</code>, <code s__="13">creat()</code>, <code s__="13">dup()</code>, <code s__="13">dup2()</code>, <code s__="13">execle()</code>, <code s__="13">execve()</code>, <code s__="13">fchmod()</code>, <code s__="13">fchown()</code>, <code s__="13">fcntl()</code>, <code s__="13">fdatasync()</code>, <code s__="13">fork()</code>, <code s__="13">fpathconf()</code>, <code s__="13">fstat()</code>, <code s__="13">fsync()</code>, <code s__="13">ftruncate()</code>, <code s__="13">getegid()</code>, <code s__="13">geteuid()</code>, <code s__="13">getgid()</code>, <code s__="13">getgroups()</code>, <code s__="13">getpeername()</code>, <code s__="13">getpgrp()</code>, <code s__="13">getpid()</code>, <code s__="13">getppid()</code>, <code s__="13">getsockname()</code>, <code s__="13">getsockopt()</code>, <code s__="13">getuid()</code>, <code s__="13">kill()</code>, <code s__="13">link()</code>, <code s__="13">listen()</code>, <code s__="13">lseek()</code>, <code s__="13">lstat()</code>, <code s__="13">mkdir()</code>, <code s__="13">mkfifo()</code>, <code s__="13">open()</code>, <code s__="13">pathconf()</code>, <code s__="13">pause()</code>, <code s__="13">pipe()</code>, <code s__="13">poll()</code>, <code s__="13">posix_trace_event()</code>, <code s__="13">pselect()</code>, <code s__="13">raise()</code>, <code s__="13">read()</code>, <code s__="13">readlink()</code>, <code s__="13">recv()</code>, <code s__="13">recvfrom()</code>, <code s__="13">recvmsg()</code>, <code s__="13">rename()</code>, <code s__="13">rmdir()</code>, <code s__="13">select()</code>, <code s__="13">sem_post()</code>, <code s__="13">send()</code>, <code s__="13">sendmsg()</code>, <code s__="13">sendto()</code>, <code s__="13">setgid()</code>, <code s__="13">setpgid()</code>, <code s__="13">setsid()</code>, <code s__="13">setsockopt()</code>, <code s__="13">setuid()</code>, <code s__="13">shutdown()</code>, <code s__="13">sigaction()</code>, <code s__="13">sigaddset()</code>, <code s__="13">sigdelset()</code>, <code s__="13">sigemptyset()</code>, <code s__="13">sigfillset()</code>, <code s__="13">sigismember()</code>, <code s__="13">sleep()</code>, <code s__="13">signal()</code>, <code s__="13">sigpause()</code>, <code s__="13">sigpending()</code>, <code s__="13">sigprocmask()</code>, <code s__="13">sigqueue()</code>, <code s__="13">sigset()</code>, <code s__="13">sigsuspend()</code>, <code s__="13">sockatmark()</code>, <code s__="13">socket()</code>, <code s__="13">socketpair()</code>, <code s__="13">stat()</code>, <code s__="13">symlink()</code>, <code s__="13">sysconf()</code>, <code s__="13">tcdrain()</code>, <code s__="13">tcflow()</code>, <code s__="13">tcflush()</code>, <code s__="13">tcgetattr()</code>, <code s__="13">tcgetpgrp()</code>, <code s__="13">tcsendbreak()</code>, <code s__="13">tcsetattr()</code>, <code s__="13">tcsetpgrp()</code>, <code s__="13">time()</code>, <code s__="13">timer_getoverrun()</code>, <code s__="13">timer_gettime()</code>, <code s__="13">timer_settime()</code>, <code s__="13">times()</code>, <code s__="13">umask()</code>, <code s__="13">uname()</code>, <code s__="13">unlink()</code>, <code s__="13">utime()</code>, <code s__="13">wait()</code>, <code s__="13">waitpid()</code>, and <code s__="13">write()</code>.</p>
<p d__="">Of course, you can call your own functions from within your 
signal handler (as long they don’t call any non-async-safe functions.)</p>
<p d__="">But wait—there’s more!</p>
<p d__="">You also cannot safely alter any shared (e.g.&nbsp;global) 
data, with one notable exception: variables that are declared to be of 
storage class and type <code s__="13">volatile sig_atomic_t</code>.</p>
<p d__="">Here’s an example that handles <code s__="13">SIGUSR1</code> by setting a global flag, which is then examined in the main loop to see if the handler was called. This is <a href="https://beej.us/guide/bgipc/source/examples/sigusr.c"><code s__="13" d__="">sigusr.c</code></a><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup s__="13" d__="">5</sup></a>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb10-1"><a href="#cb10-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;signal.h&gt;</span></span>
<span id="cb10-6"><a href="#cb10-6"></a></span>
<span id="cb10-7" d__=""><a href="#cb10-7"></a><span class="dt" d__="">volatile</span> <span class="dt" d__="">sig_atomic_t</span> got_usr1<span class="op" d__="">;</span></span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9" d__=""><a href="#cb10-9"></a><span class="dt" d__="">void</span> sigusr1_handler<span class="op" d__="">(</span><span class="dt" d__="">int</span> sig<span class="op" d__="">)</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="op" d__="">{</span></span>
<span id="cb10-11" d__=""><a href="#cb10-11"></a>    got_usr1 <span class="op" d__="">=</span> <span class="dv" d__="">1</span><span class="op" d__="">;</span></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="op" d__="">}</span></span>
<span id="cb10-13"><a href="#cb10-13"></a></span>
<span id="cb10-14" d__=""><a href="#cb10-14"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="op" d__="">{</span></span>
<span id="cb10-16" d__=""><a href="#cb10-16"></a>        <span class="kw" d__="">struct</span> sigaction sa <span class="op" d__="">=</span> <span class="op" d__="">{</span></span>
<span id="cb10-17" d__=""><a href="#cb10-17"></a>            <span class="op" d__="">.</span>sa_handler <span class="op" d__="">=</span> sigusr1_handler<span class="op" d__="">,</span></span>
<span id="cb10-18" d__=""><a href="#cb10-18"></a>            <span class="op" d__="">.</span>sa_flags <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span> <span class="co" d__="">// or SA_RESTART</span></span>
<span id="cb10-19" d__=""><a href="#cb10-19"></a>            <span class="op" d__="">.</span>sa_mask <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span></span>
<span id="cb10-20"><a href="#cb10-20"></a>        <span class="op" d__="">};</span></span>
<span id="cb10-21"><a href="#cb10-21"></a></span>
<span id="cb10-22" d__=""><a href="#cb10-22"></a>    got_usr1 <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb10-23"><a href="#cb10-23"></a></span>
<span id="cb10-24" d__=""><a href="#cb10-24"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>sigaction<span class="op" d__="">(</span>SIGUSR1<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>sa<span class="op" d__="">,</span> NULL<span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb10-25" d__=""><a href="#cb10-25"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"sigaction"</span><span class="op" d__="">);</span></span>
<span id="cb10-26" d__=""><a href="#cb10-26"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb10-27"><a href="#cb10-27"></a>    <span class="op" d__="">}</span></span>
<span id="cb10-28"><a href="#cb10-28"></a></span>
<span id="cb10-29" d__=""><a href="#cb10-29"></a>    <span class="cf" d__="">while</span> <span class="op" d__="">(!</span>got_usr1<span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb10-30" d__=""><a href="#cb10-30"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"PID </span><span class="sc" d__="">%d</span><span class="st" d__="">: working hard...</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> getpid<span class="op" d__="">());</span></span>
<span id="cb10-31" d__=""><a href="#cb10-31"></a>        sleep<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb10-32"><a href="#cb10-32"></a>    <span class="op" d__="">}</span></span>
<span id="cb10-33"><a href="#cb10-33"></a></span>
<span id="cb10-34" d__=""><a href="#cb10-34"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Done in by SIGUSR1!</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb10-35"><a href="#cb10-35"></a></span>
<span id="cb10-36"><a href="#cb10-36"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb10-37"><a href="#cb10-37"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">Fire it it up in one window, and then use the <code s__="13">kill -USR1</code> in another window to kill it. The <code s__="13">sigusr</code> program conveniently prints out its process ID so you can pass it to <code s__="13">kill</code>:</p>
<pre><code s__="13" d__="">$ sigusr
PID 5023: working hard...
PID 5023: working hard...
PID 5023: working hard...</code></pre>
<p d__="">Then in the other window, send it the signal <code s__="13">SIGUSR1</code>:</p>
<pre><code s__="13" d__="">$ kill -USR1 5023</code></pre>
<p d__="">And the program should respond:</p>
<pre><code s__="13" d__="">PID 5023: working hard...
PID 5023: working hard...
Done in by SIGUSR1!</code></pre>
<p d__="">(And the response should be immediate even if <code s__="13">sleep()</code> has just been called—<code s__="13">sleep()</code> gets interrupted by signals.)</p>
<h2 data-number="3.3" id="what-about-signal" d__=""><span class="header-section-number">3.3</span> What about <code>signal()</code></h2>
<p d__="">ANSI C defines a function called <code s__="13">signal()</code> that can be used to catch signals. It’s not as reliable or as full-featured as <code s__="13">sigaction()</code>, so use of <code s__="13">signal()</code>is generally discouraged.</p>
<h2 data-number="3.4" id="some-signals-to-make-you-popular" d__=""><span class="header-section-number">3.4</span> Some signals to make you popular</h2>
<p d__="">Here is a list of signals you (most likely) have at your disposal:</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;" d__="">Signal</th>
<th d__="">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGABRT</code></td>
<td d__="">Process abort signal.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGALRM</code></td>
<td d__="">Alarm clock.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGFPE</code></td>
<td d__="">Erroneous arithmetic operation.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGHUP</code></td>
<td d__="">Hangup.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGILL</code></td>
<td d__="">Illegal instruction.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGINT</code></td>
<td d__="">Terminal interrupt signal.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGKILL</code></td>
<td d__="">Kill (cannot be caught or ignored).</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGPIPE</code></td>
<td d__="">Write on a pipe with no one to read it.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGQUIT</code></td>
<td d__="">Terminal quit signal.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGSEGV</code></td>
<td d__="">Invalid memory reference.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGTERM</code></td>
<td d__="">Termination signal.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGUSR1</code></td>
<td d__="">User-defined signal 1.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGUSR2</code></td>
<td d__="">User-defined signal 2.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGCHLD</code></td>
<td d__="">Child process terminated or stopped.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGCONT</code></td>
<td d__="">Continue executing, if stopped.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGSTOP</code></td>
<td d__="">Stop executing (cannot be caught or ignored).</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGTSTP</code></td>
<td d__="">Terminal stop signal.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGTTIN</code></td>
<td d__="">Background process attempting read.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGTTOU</code></td>
<td d__="">Background process attempting write.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGBUS</code></td>
<td d__="">Bus error.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGPOLL</code></td>
<td d__="">Pollable event.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGPROF</code></td>
<td d__="">Profiling timer expired.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGSYS</code></td>
<td d__="">Bad system call.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGTRAP</code></td>
<td d__="">Trace/breakpoint trap.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGURG</code></td>
<td d__="">High bandwidth data is available at a socket.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGVTALRM</code></td>
<td d__="">Virtual timer expired.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SIGXCPU</code></td>
<td d__="">CPU time limit exceeded.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">SIGXFSZ</code></td>
<td d__="">File size limit exceeded.</td>
</tr>
</tbody>
</table>
<p d__="">Each signal has its own default signal handler, the behavior of which is defined in your local man pages.</p>
<h2 data-number="3.5" id="what-i-have-glossed-over" d__=""><span class="header-section-number">3.5</span> What I have Glossed Over</h2>
<p d__="">Nearly all of it. There are tons of flags, realtime signals, mixing signals with threads, masking signals, <code s__="13">longjmp()</code> and signals, and more.</p>
<p d__="">Of course, this is just a “getting started” guide, but in a 
last-ditch effort to give you more information, here is a list of man 
pages with more information:</p>
<p d__="">Handling signals:</p>
<ul>
<li><a href="https://man.archlinux.org/man/sigaction.2"><code s__="13" d__="">sigaction()</code></a><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup s__="13" d__="">6</sup></a></li>
<li><a href="https://man.archlinux.org/man/sigwait.3"><code s__="13" d__="">sigwait()</code></a><a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup s__="13" d__="">7</sup></a></li>
<li><a href="https://man.archlinux.org/man/sigwaitinfo.2"><code s__="13" d__="">sigwaitinfo()</code></a><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup s__="13" d__="">8</sup></a></li>
<li><a href="https://man.archlinux.org/man/sigtimedwait.2"><code s__="13" d__="">sigtimedwait()</code></a><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup s__="13" d__="">9</sup></a></li>
<li><a href="https://man.archlinux.org/man/sigsuspend.2"><code s__="13" d__="">sigsuspend()</code></a><a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup s__="13" d__="">10</sup></a></li>
<li><a href="https://man.archlinux.org/man/sigpending.2"><code s__="13" d__="">sigpending()</code></a><a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup s__="13" d__="">11</sup></a></li>
</ul>
<p d__="">Delivering signals:</p>
<ul>
<li><a href="https://man.archlinux.org/man/kill.2"><code s__="13" d__="">kill()</code></a><a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup s__="13" d__="">12</sup></a></li>
<li><a href="https://man.archlinux.org/man/raise.3"><code s__="13" d__="">raise()</code></a><a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup s__="13" d__="">13</sup></a></li>
<li><a href="https://man.archlinux.org/man/sigqueue.3"><code s__="13" d__="">sigqueue()</code></a><a href="#fn14" class="footnote-ref" id="fnref14" role="doc-noteref"><sup s__="13" d__="">14</sup></a></li>
</ul>
<p d__="">Set operations:</p>
<ul>
<li><a href="https://man.archlinux.org/man/sigemptyset.3"><code s__="13" d__="">sigemptyset()</code></a><a href="#fn15" class="footnote-ref" id="fnref15" role="doc-noteref"><sup s__="13" d__="">15</sup></a></li>
<li><a href="https://man.archlinux.org/man/sigfillset.3"><code s__="13" d__="">sigfillset()</code></a><a href="#fn16" class="footnote-ref" id="fnref16" role="doc-noteref"><sup s__="13" d__="">16</sup></a></li>
<li><a href="https://man.archlinux.org/man/sigaddset.3"><code s__="13" d__="">sigaddset()</code></a><a href="#fn17" class="footnote-ref" id="fnref17" role="doc-noteref"><sup s__="13" d__="">17</sup></a></li>
<li><a href="https://man.archlinux.org/man/sigdelset.3"><code s__="13" d__="">sigdelset()</code></a><a href="#fn18" class="footnote-ref" id="fnref18" role="doc-noteref"><sup s__="13" d__="">18</sup></a></li>
<li><a href="https://man.archlinux.org/man/sigismember.3"><code s__="13" d__="">sigismember()</code></a><a href="#fn19" class="footnote-ref" id="fnref19" role="doc-noteref"><sup s__="13" d__="">19</sup></a></li>
</ul>
<p d__="">Other:</p>
<ul>
<li><a href="https://man.archlinux.org/man/sigprocmask.2"><code s__="13" d__="">sigprocmask()</code></a><a href="#fn20" class="footnote-ref" id="fnref20" role="doc-noteref"><sup s__="13" d__="">20</sup></a></li>
<li><a href="https://man.archlinux.org/man/sigaltstack.2"><code s__="13" d__="">sigaltstack()</code></a><a href="#fn21" class="footnote-ref" id="fnref21" role="doc-noteref"><sup s__="13" d__="">21</sup></a></li>
<li><a href="https://man.archlinux.org/man/siginterrupt.3"><code s__="13" d__="">siginterrupt()</code></a><a href="#fn22" class="footnote-ref" id="fnref22" role="doc-noteref"><sup s__="13" d__="">22</sup></a></li>
<li><a href="https://man.archlinux.org/man/sigsetjmp.3"><code s__="13" d__="">sigsetjmp()</code></a><a href="#fn23" class="footnote-ref" id="fnref23" role="doc-noteref"><sup s__="13" d__="">23</sup></a></li>
<li><a href="https://man.archlinux.org/man/siglongjmp.3"><code s__="13" d__="">siglongjmp()</code></a><a href="#fn24" class="footnote-ref" id="fnref24" role="doc-noteref"><sup s__="13" d__="">24</sup></a></li>
<li><a href="https://man.archlinux.org/man/signal.2"><code s__="13" d__="">signal()</code></a><a href="#fn25" class="footnote-ref" id="fnref25" role="doc-noteref"><sup s__="13" d__="">25</sup></a></li>
</ul>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- ======================================================= -->
<!-- Pipes -->
<!-- ======================================================= -->
<h1 data-number="4" id="pipes" d__=""><span class="header-section-number">4</span> Pipes</h1>
<p d__="">There is no form of IPC that is simpler than pipes. Implemented on every flavor of Unix, <code s__="13">pipe()</code> and <a href="#fork"><code s__="13" d__="">fork()</code></a> make up the functionality behind the “<code s__="13">|</code>” in “<code s__="13">ls | more</code>”. They are marginally useful for cool things, but are a good way to learn about basic methods of IPC.</p>
<p d__="">Since they’re so very very easy, I shant spent much time on them. We’ll just have some examples and stuff.</p>
<h2 data-number="4.1" id="these-pipes-are-clean" d__=""><span class="header-section-number">4.1</span> “These pipes are clean!”</h2>
<p d__="">Wait! Not so fast. I might need to define a “file descriptor” at this point. Let me put it this way: you know about “<code s__="13">FILE*</code>” from <code s__="13">stdio.h</code>, right? You know how you have all those nice functions like <code s__="13">fopen()</code>, <code s__="13">fclose()</code>, <code s__="13">fwrite()</code>, and so on? Well, those are actually high level functions that are implemented using <em>file descriptors</em>, which use system calls such as <code s__="13">open()</code>, <code s__="13">creat()</code>, <code s__="13">close()</code>, and <code s__="13">write()</code>. File descriptors are simply <code s__="13">ints</code> that are analogous to <code s__="13">FILE*</code>’s in <code s__="13">stdio.h</code>.</p>
<p d__="">For example, <code s__="13">stdin</code> is file descriptor “0”, <code s__="13">stdout</code> is “1”, and <code s__="13">stderr</code> is “2”. Likewise, any files you open using <code s__="13">fopen()</code> get their own file descriptor, although this detail is hidden from you. (This file descriptor can be retrived from the <code s__="13">FILE*</code> by using the <code s__="13">fileno()</code> macro from <code s__="13">stdio.h</code>.)</p>
<figure>
<embed src="Beej's%20Guide%20to%20Interprocess%20Communication_files/pipe1.svg" title="[How a pipe is organized]">
<figcaption aria-hidden="true" s__="14" d__="">How a pipe is organized.</figcaption>
</figure>
<p d__="">Basically, a call to the <code s__="13">pipe()</code> function
 returns a pair of file descriptors. One of these descriptors is 
connected to the write end of the pipe, and the other is connected to 
the read end. Anything can be written to the pipe, and read from the 
other end in the order it came in. On many systems, pipes will fill up 
after you write about 10K to them without reading anything out.</p>
<p d__="">As a <a href="https://beej.us/guide/bgipc/source/examples/pipe1.c" d__="">useless example</a><a href="#fn26" class="footnote-ref" id="fnref26" role="doc-noteref"><sup s__="13" d__="">26</sup></a>, the following program creates, writes to, and reads from a pipe.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb14-1"><a href="#cb14-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb14-5"><a href="#cb14-5"></a></span>
<span id="cb14-6" d__=""><a href="#cb14-6"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="op" d__="">{</span></span>
<span id="cb14-8" d__=""><a href="#cb14-8"></a>    <span class="dt" d__="">int</span> pfds<span class="op" d__="">[</span><span class="dv" d__="">2</span><span class="op" d__="">];</span></span>
<span id="cb14-9" d__=""><a href="#cb14-9"></a>    <span class="dt" d__="">char</span> buf<span class="op" d__="">[</span><span class="dv" d__="">30</span><span class="op" d__="">];</span></span>
<span id="cb14-10"><a href="#cb14-10"></a></span>
<span id="cb14-11" d__=""><a href="#cb14-11"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>pipe<span class="op" d__="">(</span>pfds<span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb14-12" d__=""><a href="#cb14-12"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"pipe"</span><span class="op" d__="">);</span></span>
<span id="cb14-13" d__=""><a href="#cb14-13"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb14-14"><a href="#cb14-14"></a>    <span class="op" d__="">}</span></span>
<span id="cb14-15"><a href="#cb14-15"></a></span>
<span id="cb14-16" d__=""><a href="#cb14-16"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"writing to file descriptor #</span><span class="sc" d__="">%d\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> pfds<span class="op" d__="">[</span><span class="dv" d__="">1</span><span class="op" d__="">]);</span></span>
<span id="cb14-17" d__=""><a href="#cb14-17"></a>    write<span class="op" d__="">(</span>pfds<span class="op" d__="">[</span><span class="dv" d__="">1</span><span class="op" d__="">],</span> <span class="st" d__="">"test"</span><span class="op" d__="">,</span> <span class="dv" d__="">5</span><span class="op" d__="">);</span></span>
<span id="cb14-18" d__=""><a href="#cb14-18"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"reading from file descriptor #</span><span class="sc" d__="">%d\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> pfds<span class="op" d__="">[</span><span class="dv" d__="">0</span><span class="op" d__="">]);</span></span>
<span id="cb14-19" d__=""><a href="#cb14-19"></a>    read<span class="op" d__="">(</span>pfds<span class="op" d__="">[</span><span class="dv" d__="">0</span><span class="op" d__="">],</span> buf<span class="op" d__="">,</span> <span class="dv" d__="">5</span><span class="op" d__="">);</span></span>
<span id="cb14-20" d__=""><a href="#cb14-20"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"read </span><span class="sc" d__="">\"%s\"\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> buf<span class="op" d__="">);</span></span>
<span id="cb14-21"><a href="#cb14-21"></a></span>
<span id="cb14-22"><a href="#cb14-22"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb14-23"><a href="#cb14-23"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">As you can see, <code s__="13">pipe()</code> takes an array of two <code s__="13">int</code>s
 as an argument. Assuming no errors, it connects two file descriptors 
and returns them in the array. The first element of the array is the 
reading-end of the pipe, the second is the writing end.</p>
<h2 data-number="4.2" id="fork-and-pipeyou-have-the-power" d__=""><span class="header-section-number">4.2</span> <code>fork()</code> and <code>pipe()</code>—you have the power!</h2>
<p d__="">From the above example, it’s pretty hard to see how these 
would even be useful. Well, since this is an IPC document, let’s put a <code s__="13">fork()</code>
 in the mix and see what happens. Pretend that you are a top federal 
agent assigned to get a child process to send the word “test” to the 
parent. Not very glamorous, but no one ever said computer science would 
be the X-Files, Mulder.</p>
<p d__="">First, we’ll have the parent make a pipe. Secondly, we’ll <code s__="13">fork()</code>. Now, the <code s__="13">fork()</code>
 man page tells us that the child will receive a copy of all the 
parent’s file descriptors, and this includes a copy of the pipe’s file 
descriptors. <em>Alors</em>, the child will be able to send stuff to the write-end of the pipe, and the parent will get it off the read-end. <a href="https://beej.us/guide/bgipc/source/examples/pipe2.c" d__="">Like this</a><a href="#fn27" class="footnote-ref" id="fnref27" role="doc-noteref"><sup s__="13" d__="">27</sup></a>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb15-1"><a href="#cb15-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb15-6"><a href="#cb15-6"></a></span>
<span id="cb15-7" d__=""><a href="#cb15-7"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="op" d__="">{</span></span>
<span id="cb15-9" d__=""><a href="#cb15-9"></a>    <span class="dt" d__="">int</span> pfds<span class="op" d__="">[</span><span class="dv" d__="">2</span><span class="op" d__="">];</span></span>
<span id="cb15-10" d__=""><a href="#cb15-10"></a>    <span class="dt" d__="">char</span> buf<span class="op" d__="">[</span><span class="dv" d__="">30</span><span class="op" d__="">];</span></span>
<span id="cb15-11"><a href="#cb15-11"></a></span>
<span id="cb15-12" d__=""><a href="#cb15-12"></a>    pipe<span class="op" d__="">(</span>pfds<span class="op" d__="">);</span></span>
<span id="cb15-13"><a href="#cb15-13"></a></span>
<span id="cb15-14" d__=""><a href="#cb15-14"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(!</span>fork<span class="op" d__="">())</span> <span class="op" d__="">{</span></span>
<span id="cb15-15" d__=""><a href="#cb15-15"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">" CHILD: writing to the pipe</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb15-16" d__=""><a href="#cb15-16"></a>        write<span class="op" d__="">(</span>pfds<span class="op" d__="">[</span><span class="dv" d__="">1</span><span class="op" d__="">],</span> <span class="st" d__="">"test"</span><span class="op" d__="">,</span> <span class="dv" d__="">5</span><span class="op" d__="">);</span></span>
<span id="cb15-17" d__=""><a href="#cb15-17"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">" CHILD: exiting</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb15-18" d__=""><a href="#cb15-18"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">0</span><span class="op" d__="">);</span></span>
<span id="cb15-19"><a href="#cb15-19"></a>    <span class="op" d__="">}</span> <span class="cf" d__="">else</span> <span class="op" d__="">{</span></span>
<span id="cb15-20" d__=""><a href="#cb15-20"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"PARENT: reading from pipe</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb15-21" d__=""><a href="#cb15-21"></a>        read<span class="op" d__="">(</span>pfds<span class="op" d__="">[</span><span class="dv" d__="">0</span><span class="op" d__="">],</span> buf<span class="op" d__="">,</span> <span class="dv" d__="">5</span><span class="op" d__="">);</span></span>
<span id="cb15-22" d__=""><a href="#cb15-22"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"PARENT: read </span><span class="sc" d__="">\"%s\"\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> buf<span class="op" d__="">);</span></span>
<span id="cb15-23" d__=""><a href="#cb15-23"></a>        wait<span class="op" d__="">(</span>NULL<span class="op" d__="">);</span></span>
<span id="cb15-24"><a href="#cb15-24"></a>    <span class="op" d__="">}</span></span>
<span id="cb15-25"><a href="#cb15-25"></a></span>
<span id="cb15-26"><a href="#cb15-26"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb15-27"><a href="#cb15-27"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">Please note, your programs should have a lot more error 
checking than mine do. I leave it out on occasion to help keep things 
clear.</p>
<p d__="">Anyway, this example is just like the previous one, except now we <code s__="13">fork()</code>
 of a new process and have it write to the pipe, while the parent reads 
from it. The resultant output will be something similar to the 
following:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb16-1" d__=""><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>PARENT: reading from pipe</span>
<span id="cb16-2" d__=""><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a> CHILD: writing to the pipe</span>
<span id="cb16-3" d__=""><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a> CHILD: exiting</span>
<span id="cb16-4" d__=""><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>PARENT: read "test"</span></code></pre></div>
<p d__="">In this case, the parent tried to read from the pipe before the child writes to it. When this happens, the parent is said to <em>block</em>,
 or sleep, until data arrives to be read. It seems that the parent tried
 to read, went to sleep, the child wrote and exited, and the parent woke
 up and read the data.</p>
<p d__="">Hurrah!! You’ve just done some interprocess communication! 
That was dreadfully simple, huh? I’ll bet you are still thinking that 
there aren’t many uses for <code s__="13">pipe()</code> and, well, you’re probably right. The other forms of IPC are generally more useful and are often more exotic.</p>
<h2 data-number="4.3" id="the-search-for-pipe-as-we-know-it" d__=""><span class="header-section-number">4.3</span> The search for Pipe as we know it</h2>
<p d__="">In an effort to make you think that pipes are actually reasonable beasts, I’ll give you an example of using <code s__="13">pipe()</code> in a more familiar situation. The challenge: implement “<code s__="13">ls | wc -l</code>” in C.</p>
<p d__="">This requires usage of a couple more functions you may never have heard of: <code s__="13">exec()</code> and <code s__="13">dup()</code>. The <code s__="13">exec()</code> family of functions replaces the currently running process with whichever one is passed to <code s__="13">exec()</code>. This is the function that we will use to run <code s__="13">ls</code> and <code s__="13">wc -l</code>. <code s__="13">dup()</code> takes an open file descriptor and makes a clone (a duplicate) of it. This is how we will connect the standard output of the <code s__="13">ls</code> to the standard input of <code s__="13">wc</code>. See, stdout of <code s__="13">ls</code> flows into the pipe, and the stdin of <code s__="13">wc</code> flows in from the pipe. The pipe fits right there in the middle!</p>
<p d__="">Anyway, <a href="https://beej.us/guide/bgipc/source/examples/pipe3.c" d__="">here is the code</a><a href="#fn28" class="footnote-ref" id="fnref28" role="doc-noteref"><sup s__="13" d__="">28</sup></a>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb17-1"><a href="#cb17-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4"></a></span>
<span id="cb17-5" d__=""><a href="#cb17-5"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="op" d__="">{</span></span>
<span id="cb17-7" d__=""><a href="#cb17-7"></a>    <span class="dt" d__="">int</span> pfds<span class="op" d__="">[</span><span class="dv" d__="">2</span><span class="op" d__="">];</span></span>
<span id="cb17-8"><a href="#cb17-8"></a></span>
<span id="cb17-9" d__=""><a href="#cb17-9"></a>    pipe<span class="op" d__="">(</span>pfds<span class="op" d__="">);</span></span>
<span id="cb17-10"><a href="#cb17-10"></a></span>
<span id="cb17-11" d__=""><a href="#cb17-11"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(!</span>fork<span class="op" d__="">())</span> <span class="op" d__="">{</span></span>
<span id="cb17-12" d__=""><a href="#cb17-12"></a>        close<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span>       <span class="co" d__="">/* close normal stdout */</span></span>
<span id="cb17-13" d__=""><a href="#cb17-13"></a>        dup<span class="op" d__="">(</span>pfds<span class="op" d__="">[</span><span class="dv" d__="">1</span><span class="op" d__="">]);</span>   <span class="co" d__="">/* make stdout same as pfds[1] */</span></span>
<span id="cb17-14" d__=""><a href="#cb17-14"></a>        close<span class="op" d__="">(</span>pfds<span class="op" d__="">[</span><span class="dv" d__="">0</span><span class="op" d__="">]);</span> <span class="co" d__="">/* we don't need this */</span></span>
<span id="cb17-15" d__=""><a href="#cb17-15"></a>        execlp<span class="op" d__="">(</span><span class="st" d__="">"ls"</span><span class="op" d__="">,</span> <span class="st" d__="">"ls"</span><span class="op" d__="">,</span> NULL<span class="op" d__="">);</span></span>
<span id="cb17-16"><a href="#cb17-16"></a>    <span class="op" d__="">}</span> <span class="cf" d__="">else</span> <span class="op" d__="">{</span></span>
<span id="cb17-17" d__=""><a href="#cb17-17"></a>        close<span class="op" d__="">(</span><span class="dv" d__="">0</span><span class="op" d__="">);</span>       <span class="co" d__="">/* close normal stdin */</span></span>
<span id="cb17-18" d__=""><a href="#cb17-18"></a>        dup<span class="op" d__="">(</span>pfds<span class="op" d__="">[</span><span class="dv" d__="">0</span><span class="op" d__="">]);</span>   <span class="co" d__="">/* make stdin same as pfds[0] */</span></span>
<span id="cb17-19" d__=""><a href="#cb17-19"></a>        close<span class="op" d__="">(</span>pfds<span class="op" d__="">[</span><span class="dv" d__="">1</span><span class="op" d__="">]);</span> <span class="co" d__="">/* we don't need this */</span></span>
<span id="cb17-20" d__=""><a href="#cb17-20"></a>        execlp<span class="op" d__="">(</span><span class="st" d__="">"wc"</span><span class="op" d__="">,</span> <span class="st" d__="">"wc"</span><span class="op" d__="">,</span> <span class="st" d__="">"-l"</span><span class="op" d__="">,</span> NULL<span class="op" d__="">);</span></span>
<span id="cb17-21"><a href="#cb17-21"></a>    <span class="op" d__="">}</span></span>
<span id="cb17-22"><a href="#cb17-22"></a></span>
<span id="cb17-23"><a href="#cb17-23"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb17-24"><a href="#cb17-24"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">I’m going to make another note about the <code s__="13">close()</code>/<code s__="13">dup()</code> combination since it’s pretty weird. <code s__="13">close(1)</code> frees up file descriptor 1 (standard output). <code s__="13">dup(pfds[1])</code>
 makes a copy of the write-end of the pipe in the first available file 
descriptor, which is “1”, since we just closed that. In this way, 
anything that <code s__="13">ls</code> writes to standard output (file descriptor 1) will instead go to <code s__="13">pfds[1]</code> (the write end of the pipe). The <code s__="13">wc</code> section of code works the same way, except in reverse.</p>
<h2 data-number="4.4" id="summary-1" d__=""><span class="header-section-number">4.4</span> Summary</h2>
<p d__="">There aren’t many of these for such a simple topic. In fact, 
there are nearly just about none. Probably the best use for pipes is the
 one you’re most accustomed to: sending the standard output of one 
command to the standard input of another. For other uses, it’s pretty 
limiting and there are often other IPC techniques that work better.</p>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- ======================================================= -->
<!-- FIFOs -->
<!-- ======================================================= -->
<h1 data-number="5" id="fifos" d__=""><span class="header-section-number">5</span> FIFOs</h1>
<p d__="">A FIFO (“First In, First Out”, pronounced “Fy-Foh”) is sometimes known as a <em>named pipe</em>. That is, it’s like a <a href="#pipes" d__="">pipe</a>, except that it has a name! In this case, the name is that of a file that multiple processes can <code s__="13">open()</code> and read and write to.</p>
<p d__="">This latter aspect of FIFOs is designed to let them get around
 one of the shortcomings of normal pipes: you can’t grab one end of a 
normal pipe that was created by an unrelated process. See, if I run two 
individual copies of a program, they can both call <code s__="13">pipe()</code> all they want and still not be able to speak to one another. (This is because you must <code s__="13">pipe()</code>, then <code s__="13">fork()</code> to get a child process that can communicate to the parent via the pipe.) With FIFOs, though, each unrelated process can simply <code s__="13">open()</code> the pipe and transfer data through it.</p>
<h2 data-number="5.1" id="a-new-fifo-is-born" d__=""><span class="header-section-number">5.1</span> A New FIFO is Born</h2>
<p d__="">Since the FIFO is actually a file on disk, you have to do some
 fancy-schmancy stuff to create it. It’s not that hard. You just have to
 call <code s__="13">mknod()</code> with the proper arguments. Here is a <code s__="13">mknod()</code> call that creates a FIFO:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb18-1" d__=""><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>mknod<span class="op" d__="">(</span><span class="st" d__="">"myfifo"</span><span class="op" d__="">,</span> S_IFIFO <span class="op" d__="">|</span> <span class="bn" d__="">0644</span> <span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span></code></pre></div>
<p d__="">In the above example, the FIFO file will be called “<code s__="13">myfifo</code>”. The second argument is the creation mode, which is used to tell <code s__="13">mknod()</code> to make a FIFO (the <code s__="13">S_IFIFO</code> part of the OR) and sets access permissions to that file (octal 644, or <code s__="13">rw-r--r--</code>) which can also be set by ORing together macros from <code s__="13">sys/stat.h</code>. This permission is just like the one you’d set using the <code s__="13">chmod</code> command. Finally, a device number is passed. This is ignored when creating a FIFO, so you can put anything you want in there.</p>
<p d__="">(An aside: a FIFO can also be created from the command line using the Unix <code s__="13">mknod</code> command.)</p>
<h2 data-number="5.2" id="producers-and-consumers" d__=""><span class="header-section-number">5.2</span> Producers and Consumers</h2>
<p d__="">Once the FIFO has been created, a process can start up and open it for reading or writing using the standard <code s__="13">open()</code> system call.</p>
<p d__="">Since the process is easier to understand once you get some 
code in your belly, I’ll present here two programs which will send data 
through a FIFO. One is <code s__="13">speak.c</code> which sends data through the FIFO, and the other is called <code s__="13">tick.c</code>, as it sucks data out of the FIFO.</p>
<p d__="">Here is <a href="https://beej.us/guide/bgipc/source/examples/speak.c"><code s__="13" d__="">speak.c</code></a><a href="#fn29" class="footnote-ref" id="fnref29" role="doc-noteref"><sup s__="13" d__="">29</sup></a>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb19-1"><a href="#cb19-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;string.h&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;fcntl.h&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/stat.h&gt;</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb19-9"><a href="#cb19-9"></a></span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="pp" d__="">#define FIFO_NAME </span><span class="st" d__="">"american_maid"</span></span>
<span id="cb19-11"><a href="#cb19-11"></a></span>
<span id="cb19-12" d__=""><a href="#cb19-12"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="op" d__="">{</span></span>
<span id="cb19-14" d__=""><a href="#cb19-14"></a>    <span class="dt" d__="">char</span> s<span class="op" d__="">[</span><span class="dv" d__="">300</span><span class="op" d__="">];</span></span>
<span id="cb19-15" d__=""><a href="#cb19-15"></a>    <span class="dt" d__="">int</span> num<span class="op" d__="">,</span> fd<span class="op" d__="">;</span></span>
<span id="cb19-16"><a href="#cb19-16"></a></span>
<span id="cb19-17" d__=""><a href="#cb19-17"></a>    mknod<span class="op" d__="">(</span>FIFO_NAME<span class="op" d__="">,</span> S_IFIFO <span class="op" d__="">|</span> <span class="bn" d__="">0666</span><span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span>
<span id="cb19-18"><a href="#cb19-18"></a></span>
<span id="cb19-19" d__=""><a href="#cb19-19"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"waiting for readers...</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb19-20" d__=""><a href="#cb19-20"></a>    fd <span class="op" d__="">=</span> open<span class="op" d__="">(</span>FIFO_NAME<span class="op" d__="">,</span> O_WRONLY<span class="op" d__="">);</span></span>
<span id="cb19-21" d__=""><a href="#cb19-21"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"got a reader--type some stuff</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb19-22"><a href="#cb19-22"></a></span>
<span id="cb19-23" d__=""><a href="#cb19-23"></a>    <span class="cf" d__="">while</span> <span class="op" d__="">(</span>gets<span class="op" d__="">(</span>s<span class="op" d__="">),</span> <span class="op" d__="">!</span>feof<span class="op" d__="">(</span>stdin<span class="op" d__="">))</span> <span class="op" d__="">{</span></span>
<span id="cb19-24" d__=""><a href="#cb19-24"></a>        <span class="cf" d__="">if</span> <span class="op" d__="">((</span>num <span class="op" d__="">=</span> write<span class="op" d__="">(</span>fd<span class="op" d__="">,</span> s<span class="op" d__="">,</span> strlen<span class="op" d__="">(</span>s<span class="op" d__="">)))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span></span>
<span id="cb19-25" d__=""><a href="#cb19-25"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"write"</span><span class="op" d__="">);</span></span>
<span id="cb19-26"><a href="#cb19-26"></a>        <span class="cf" d__="">else</span></span>
<span id="cb19-27" d__=""><a href="#cb19-27"></a>            printf<span class="op" d__="">(</span><span class="st" d__="">"speak: wrote </span><span class="sc" d__="">%d</span><span class="st" d__=""> bytes</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> num<span class="op" d__="">);</span></span>
<span id="cb19-28"><a href="#cb19-28"></a>    <span class="op" d__="">}</span></span>
<span id="cb19-29"><a href="#cb19-29"></a></span>
<span id="cb19-30"><a href="#cb19-30"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb19-31"><a href="#cb19-31"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">What <code s__="13">speak</code> does is create the FIFO, then try to <code s__="13">open()</code> it. Now, what will happen is that the <code s__="13">open()</code> call will <em>block</em> until some other process opens the other end of the pipe for reading. (There is a way around this—see <a href="#fifondelay"><code s__="13" d__="">O_NDELAY</code></a>, below.) That process is <a href="https://beej.us/guide/bgipc/source/examples/tick.c"><code s__="13" d__="">tick.c</code></a><a href="#fn30" class="footnote-ref" id="fnref30" role="doc-noteref"><sup s__="13" d__="">30</sup></a>, shown here:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb20-1"><a href="#cb20-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;string.h&gt;</span></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;fcntl.h&gt;</span></span>
<span id="cb20-6"><a href="#cb20-6"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/stat.h&gt;</span></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb20-9"><a href="#cb20-9"></a></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="pp" d__="">#define FIFO_NAME </span><span class="st" d__="">"american_maid"</span></span>
<span id="cb20-11"><a href="#cb20-11"></a></span>
<span id="cb20-12" d__=""><a href="#cb20-12"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="op" d__="">{</span></span>
<span id="cb20-14" d__=""><a href="#cb20-14"></a>    <span class="dt" d__="">char</span> s<span class="op" d__="">[</span><span class="dv" d__="">300</span><span class="op" d__="">];</span></span>
<span id="cb20-15" d__=""><a href="#cb20-15"></a>    <span class="dt" d__="">int</span> num<span class="op" d__="">,</span> fd<span class="op" d__="">;</span></span>
<span id="cb20-16"><a href="#cb20-16"></a></span>
<span id="cb20-17" d__=""><a href="#cb20-17"></a>    mknod<span class="op" d__="">(</span>FIFO_NAME<span class="op" d__="">,</span> S_IFIFO <span class="op" d__="">|</span> <span class="bn" d__="">0666</span><span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span>
<span id="cb20-18"><a href="#cb20-18"></a></span>
<span id="cb20-19" d__=""><a href="#cb20-19"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"waiting for writers...</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb20-20" d__=""><a href="#cb20-20"></a>    fd <span class="op" d__="">=</span> open<span class="op" d__="">(</span>FIFO_NAME<span class="op" d__="">,</span> O_RDONLY<span class="op" d__="">);</span></span>
<span id="cb20-21" d__=""><a href="#cb20-21"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"got a writer</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb20-22"><a href="#cb20-22"></a></span>
<span id="cb20-23"><a href="#cb20-23"></a>    <span class="cf" d__="">do</span> <span class="op" d__="">{</span></span>
<span id="cb20-24" d__=""><a href="#cb20-24"></a>        <span class="cf" d__="">if</span> <span class="op" d__="">((</span>num <span class="op" d__="">=</span> read<span class="op" d__="">(</span>fd<span class="op" d__="">,</span> s<span class="op" d__="">,</span> <span class="dv" d__="">300</span><span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span></span>
<span id="cb20-25" d__=""><a href="#cb20-25"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"read"</span><span class="op" d__="">);</span></span>
<span id="cb20-26"><a href="#cb20-26"></a>        <span class="cf" d__="">else</span> <span class="op" d__="">{</span></span>
<span id="cb20-27" d__=""><a href="#cb20-27"></a>            s<span class="op" d__="">[</span>num<span class="op" d__="">]</span> <span class="op" d__="">=</span> <span class="ch" d__="">'</span><span class="sc" d__="">\0</span><span class="ch" d__="">'</span><span class="op" d__="">;</span></span>
<span id="cb20-28" d__=""><a href="#cb20-28"></a>            printf<span class="op" d__="">(</span><span class="st" d__="">"tick: read </span><span class="sc" d__="">%d</span><span class="st" d__=""> bytes: </span><span class="sc" d__="">\"%s\"\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> num<span class="op" d__="">,</span> s<span class="op" d__="">);</span></span>
<span id="cb20-29"><a href="#cb20-29"></a>        <span class="op" d__="">}</span></span>
<span id="cb20-30" d__=""><a href="#cb20-30"></a>    <span class="op" d__="">}</span> <span class="cf" d__="">while</span> <span class="op" d__="">(</span>num <span class="op" d__="">&gt;</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span>
<span id="cb20-31"><a href="#cb20-31"></a></span>
<span id="cb20-32"><a href="#cb20-32"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb20-33"><a href="#cb20-33"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">Like <code s__="13">speak.c</code>, <code s__="13">tick</code> will block on the <code s__="13">open()</code> if there is no one writing to the FIFO. As soon as someone opens the FIFO for writing, <code s__="13">tick</code> will spring to life.</p>
<p d__="">Try it! Start <code s__="13">speak</code> and it will block until you start <code s__="13">tick</code> in another window. (Conversely, if you start <code s__="13">tick</code>, it will block until you start <code s__="13">speak</code> in another window.) Type away in the <code s__="13">speak</code> window and <code s__="13">tick</code> will suck it all up.</p>
<p d__="">Now, break out of <code s__="13">speak</code>. Notice what happens: the <code s__="13">read()</code> in <code s__="13">tick</code>
 returns 0, signifying EOF. In this way, the reader can tell when all 
writers have closed their connection to the FIFO. “What?” you ask “There
 can be multiple writers to the same pipe?” Sure! That can be very 
useful, you know. Perhaps I’ll show you later in the document how this 
can be exploited.</p>
<p d__="">But for now, lets finish this topic by seeing what happens when you break out of <code s__="13">tick</code> while <code s__="13">speak</code>
 is running. “Broken Pipe”! What does this mean? Well, what has happened
 is that when all readers for a FIFO close and the writer is still open,
 the writer will receiver the signal SIGPIPE the next time it tries to <code s__="13">write()</code>.
 The default signal handler for this signal prints “Broken Pipe” and 
exits. Of course, you can handle this more gracefully by catching 
SIGPIPE through the <code s__="13">signal()</code> call.</p>
<p d__="">Finally, what happens if you have multiple readers? Well, 
strange things happen. Sometimes one of the readers get everything. 
Sometimes it alternates between readers. Why do you want to have 
multiple readers, anyway?</p>
<h2 data-number="5.3" id="fifondelay" d__=""><span class="header-section-number">5.3</span> <code>O_NDELAY</code>! I’m UNSTOPPABLE!</h2>
<p d__="">Earlier, I mentioned that you could get around the blocking <code s__="13">open()</code> call if there was no corresponding reader or writer. The way to do this is to call <code s__="13">open()</code> with the <code s__="13">O_NDELAY</code> flag set in the mode argument:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb21-1" d__=""><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fd <span class="op" d__="">=</span> open<span class="op" d__="">(</span>FIFO_NAME<span class="op" d__="">,</span> O_WRONLY <span class="op" d__="">|</span> O_NDELAY<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">This will cause <code s__="13">open()</code> to return <code s__="13">-1</code> if there are no processes that have the file open for reading.</p>
<p d__="">Likewise, you can open the reader process using the <code s__="13">O_NDELAY</code> flag, but this has a different effect: all attempts to <code s__="13">read()</code> from the pipe will simply return <code s__="13">0</code> bytes read if there is no data in the pipe. (That is, the <code s__="13">read()</code> will no longer block until there is some data in the pipe.) Note that you can no longer tell if <code s__="13">read()</code> is returning <code s__="13">0</code>
 because there is no data in the pipe, or because the writer has exited.
 This is the price of power, but my suggestion is to try to stick with 
blocking whenever possible.</p>
<h2 data-number="5.4" id="concluding-notes" d__=""><span class="header-section-number">5.4</span> Concluding Notes</h2>
<p d__="">Having the name of the pipe right there on disk sure makes it 
easier, doesn’t it? Unrelated processes can communicate via pipes! (This
 is an ability you will find yourself wishing for if you use normal 
pipes for too long.) Still, though, the functionality of pipes might not
 be quite what you need for your applications. <a href="#mq" d__="">Message queues</a> might be more your speed, if your system supports them.</p>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- ======================================================= -->
<!-- File Locking -->
<!-- ======================================================= -->
<h1 data-number="6" id="flocking" d__=""><span class="header-section-number">6</span> File Locking</h1>
<p d__="">File locking provides a very simple yet incredibly useful 
mechanism for coordinating file accesses. Before I begin to lay out the 
details, let me fill you in on some file locking secrets:</p>
<p d__="">There are two types of locking mechanisms: mandatory and advisory. Mandatory systems will actually prevent <code s__="13">read()</code>s and <code s__="13">write()</code>s
 to file. Several Unix systems support them. Nevertheless, I’m going to 
ignore them throughout this document, preferring instead to talk solely 
about advisory locks. With an advisory lock system, processes can still 
read and write from a file while it’s locked. Useless? Not quite, since 
there is a way for a process to check for the existence of a lock before
 a read or write. See, it’s a kind of <em>cooperative</em> locking system. This is easily sufficient for almost all cases where file locking is necessary.</p>
<p d__="">Since that’s out of the way, whenever I refer to a lock from now on in this document, I’m referring to advisory locks. So there.</p>
<p d__="">Now, let me break down the concept of a lock a little bit 
more. There are two types of (advisory!) locks: read locks and write 
locks (also referred to as shared locks and exclusive locks, 
respectively.) The way read locks work is that they don’t interfere with
 other read locks. For instance, multiple processes can have a file 
locked for reading at the same. However, when a process has an write 
lock on a file, no other process can activate either a read or write 
lock until it is relinquished. One easy way to think of this is that 
there can be multiple readers simultaneously, but there can only be one 
writer at a time.</p>
<p d__="">One last thing before beginning: there are many ways to lock files in Unix systems. System V likes <code s__="13">lockf()</code>, which, personally, I think sucks. Better systems support <code s__="13">flock()</code>
 which offers better control over the lock, but still lacks in certain 
ways. For portability and for completeness, I’ll be talking about how to
 lock files using <code s__="13">fcntl()</code>. I encourage you, though, to use one of the higher-level <code s__="13">flock()</code>-
style functions if it suits your needs, but I want to portably 
demonstrate the full range of power you have at your fingertips. (If 
your System V Unix doesn’t support the POSIX-y <code s__="13">fcntl()</code>, you’ll have to reconcile the following information with your <code s__="13">lockf()</code> man page.)</p>
<h2 data-number="6.1" id="setting-a-lock" d__=""><span class="header-section-number">6.1</span> Setting a lock</h2>
<p d__="">The <code s__="13">fcntl()</code> function does just about 
everything on the planet, but we’ll just use it for file locking. 
Setting the lock consists of filling out a <code s__="13">struct flock</code> (declared in <code s__="13">fcntl.h</code>) that describes the type of lock needed, <code s__="13">open()</code>ing the file with the matching mode, and calling <code s__="13">fcntl()</code> with the proper arguments, <em>comme ça</em>:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb22-1" d__=""><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">struct</span> flock fl <span class="op" d__="">=</span> <span class="op" d__="">{</span></span>
<span id="cb22-2" d__=""><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">.</span>l_type   <span class="op" d__="">=</span> F_WRLCK<span class="op" d__="">,</span>  <span class="co" d__="">/* F_RDLCK, F_WRLCK, F_UNLCK      */</span></span>
<span id="cb22-3" d__=""><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">.</span>l_whence <span class="op" d__="">=</span> SEEK_SET<span class="op" d__="">,</span> <span class="co" d__="">/* SEEK_SET, SEEK_CUR, SEEK_END   */</span></span>
<span id="cb22-4" d__=""><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">.</span>l_start  <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span>        <span class="co" d__="">/* Offset from l_whence           */</span></span>
<span id="cb22-5" d__=""><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">.</span>l_len    <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span>        <span class="co" d__="">/* length, 0 = to EOF             */</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__="">// .l_pid             /* PID holding lock; F_RDLCK only */</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">};</span></span>
<span id="cb22-8" d__=""><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> fd<span class="op" d__="">;</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10" d__=""><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>fd <span class="op" d__="">=</span> open<span class="op" d__="">(</span><span class="st" d__="">"filename"</span><span class="op" d__="">,</span> O_WRONLY<span class="op" d__="">);</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12" d__=""><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>fcntl<span class="op" d__="">(</span>fd<span class="op" d__="">,</span> F_SETLKW<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>fl<span class="op" d__="">);</span>  <span class="co" d__="">/* F_GETLK, F_SETLK, F_SETLKW */</span></span></code></pre></div>
<p d__="">What just happened? Let’s start with the <code s__="13">struct flock</code> since the fields in it are used to <em>describe</em> the locking action taking place. Here are some field definitions:</p>
<table>
<colgroup>
<col style="width: 11%">
<col style="width: 88%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;" d__="">Field</th>
<th d__="">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">l_type</code></td>
<td d__="">This is where you signify the type of lock you want to set. It’s either <code s__="13">F_RDLCK</code>, <code s__="13">F_WRLCK</code>, or <code s__="13">F_UNLCK</code> if you want to set a read lock, write lock, or clear the lock, respectively.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">l_whence</code></td>
<td d__="">This field determines where the <code s__="13">l_start</code> field starts from (it’s like an offset for the offset). It can be either <code s__="13">SEEK_SET</code>, <code s__="13">SEEK_CUR</code>, or <code s__="13">SEEK_END</code>, for beginning of file, current file position, or end of file.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">l_start</code></td>
<td d__="">This is the starting offset in bytes of the lock, relative to <code s__="13">l_whence</code>.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">l_len</code></td>
<td d__="">This is the length of the lock region in bytes (which starts from <code s__="13">l_start</code> which is relative to <code s__="13">l_whence</code>.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">l_pid</code></td>
<td d__="">The process ID of the process holding the lock. This is set by the kernel when using the F_RDLCK command.</td>
</tr>
</tbody>
</table>
<p d__="">In our example, we told it make a lock of type <code s__="13">F_WRLCK</code> (a write lock), starting relative to <code s__="13">SEEK_SET</code> (the beginning of the file), offset <code s__="13">0</code>, length <code s__="13">0</code> (a zero value means “lock to end-of-file), with the PID set to <code s__="13">getpid()</code>.</p>
<p d__="">The next step is to <code s__="13">open()</code> the file, since <code s__="13">flock()</code> needs a file descriptor of the file that’s being locked. Note that when you open the file, you need to open it in the same <em>mode</em> as you have specified in the lock, as shown in the table, below. If you open the file in the wrong mode for a given lock type, <code s__="13">fcntl()</code> will return <code s__="13">-1</code> and <code s__="13">errno</code> will be set to <code s__="13">EBADF</code>.</p>
<table>
<thead>
<tr class="header">
<th style="text-align: center;"><code s__="13" d__="">.l_type</code></th>
<th d__="">Mode</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">F_RDLCK</code></td>
<td d__=""><code s__="13">O_RDONLY</code> or <code s__="13">O_RDWR</code></td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">F_WRLCK</code></td>
<td d__=""><code s__="13">O_WRONLY</code> or <code s__="13">O_RDWR</code></td>
</tr>
</tbody>
</table>
<p d__="">Finally, the call to <code s__="13">fcntl()</code> actually sets, clears, or gets the lock. See, the second argument (the <code s__="13">cmd</code>) to <code s__="13">fcntl()</code> tells it what to do with the data passed to it in the <code s__="13">struct flock</code>. The following list summarizes what each <code s__="13">fcntl()</code> <code s__="13">cmd</code> does:</p>
<table>
<colgroup>
<col style="width: 15%">
<col style="width: 84%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><code s__="13" d__="">cmd</code></th>
<th d__="">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">F_SETLKW</code></td>
<td d__="">This argument tells <code s__="13">fcntl()</code> to attempt to obtain the lock requested in the <code s__="13">struct flock</code> structure. If the lock cannot be obtained (since someone else has it locked already), <code s__="13">fcntl()</code> will wait (block) until the lock has cleared, then will set it itself. This is a very useful command. I use it all the time.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">F_SETLK</code></td>
<td d__="">This function is almost identical to <code s__="13">F_SETLKW</code>. The only difference is that this one will not wait if it cannot obtain a lock. It will return immediately with <code s__="13">-1</code>. This function can be used to clear a lock by setting the <code s__="13">l_type</code> field in the <code s__="13">struct flock</code> to <code s__="13">F_UNLCK</code>.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">F_GETLK</code></td>
<td d__="">If you want to only check to see if there is a lock, but 
don’t want to set one, you can use this command. It looks through all 
the file locks until it finds one that conflicts with the lock you 
specified in the <code s__="13">struct flock</code>. It then copies the conflicting lock’s information into the <code s__="13">struct</code> and returns it to you. If it can’t find a conflicting lock, <code s__="13">fcntl()</code> returns the <code s__="13">struct</code> as you passed it, except it sets the <code s__="13">l_type</code> field to <code s__="13">F_UNLCK</code>.</td>
</tr>
</tbody>
</table>
<p d__="">In our above example, we call <code s__="13">fcntl()</code> with <code s__="13">F_SETLKW</code> as the argument, so it blocks until it can set the lock, then sets it and continues.</p>
<h2 data-number="6.2" id="clearing-a-lock" d__=""><span class="header-section-number">6.2</span> Clearing a lock</h2>
<p d__="">Whew! After all the locking stuff up there, it’s time for 
something easy: unlocking! Actually, this is a piece of cake in 
comparison. I’ll just reuse that first example and add the code to 
unlock it at the end:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb23-1" d__=""><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">struct</span> flock fl <span class="op" d__="">=</span> <span class="op" d__="">{</span></span>
<span id="cb23-2" d__=""><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">.</span>l_type   <span class="op" d__="">=</span> F_WRLCK<span class="op" d__="">,</span>  <span class="co" d__="">/* F_RDLCK, F_WRLCK, F_UNLCK      */</span></span>
<span id="cb23-3" d__=""><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">.</span>l_whence <span class="op" d__="">=</span> SEEK_SET<span class="op" d__="">,</span> <span class="co" d__="">/* SEEK_SET, SEEK_CUR, SEEK_END   */</span></span>
<span id="cb23-4" d__=""><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">.</span>l_start  <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span>        <span class="co" d__="">/* Offset from l_whence           */</span></span>
<span id="cb23-5" d__=""><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">.</span>l_len    <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span>        <span class="co" d__="">/* length, 0 = to EOF             */</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__="">// .l_pid             /* PID holding lock; F_RDLCK only */</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">};</span></span>
<span id="cb23-8" d__=""><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> fd<span class="op" d__="">;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10" d__=""><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>fd <span class="op" d__="">=</span> open<span class="op" d__="">(</span><span class="st" d__="">"filename"</span><span class="op" d__="">,</span> O_WRONLY<span class="op" d__="">);</span>  <span class="co" d__="">/* get the file descriptor */</span></span>
<span id="cb23-11" d__=""><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>fcntl<span class="op" d__="">(</span>fd<span class="op" d__="">,</span> F_SETLKW<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>fl<span class="op" d__="">);</span>  <span class="co" d__="">/* set the lock, waiting if necessary */</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">.</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">.</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">.</span></span>
<span id="cb23-15" d__=""><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>fl<span class="op" d__="">.</span>l_type   <span class="op" d__="">=</span> F_UNLCK<span class="op" d__="">;</span>  <span class="co" d__="">/* tell it to unlock the region */</span></span>
<span id="cb23-16" d__=""><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>fcntl<span class="op" d__="">(</span>fd<span class="op" d__="">,</span> F_SETLK<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>fl<span class="op" d__="">);</span> <span class="co" d__="">/* set the region to unlocked */</span></span></code></pre></div>
<p d__="">Now, I left the old locking code in there for high contrast, but you can tell that I just changed the <code s__="13">l_type</code> field to <code s__="13">F_UNLCK</code> (leaving the others completely unchanged!) and called <code s__="13">fcntl()</code> with <code s__="13">F_SETLK</code> as the command. Easy!</p>
<h2 data-number="6.3" id="a-demo-program" d__=""><span class="header-section-number">6.3</span> A demo program</h2>
<p d__="">Here, I will include a demo program, <code s__="13">lockdemo.c</code>,
 that waits for the user to hit return, then locks its own source, waits
 for another return, then unlocks it. By running this program in two (or
 more) windows, you can see how programs interact while waiting for 
locks.</p>
<p d__="">Basically, usage is this: if you run <code s__="13">lockdemo</code> with no command line arguments, it tries to grab a write lock (<code s__="13">F_WRLCK</code>) on its source (<code s__="13">lockdemo.c</code>). If you start it with any command line arguments at all, it tries to get a read lock (<code s__="13">F_RDLCK</code>) on it.</p>
<p d__=""><a href="https://beej.us/guide/bgipc/source/examples/lockdemo.c" d__="">Here’s the source</a><a href="#fn31" class="footnote-ref" id="fnref31" role="doc-noteref"><sup s__="13" d__="">31</sup></a>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb24-1"><a href="#cb24-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb24-2"><a href="#cb24-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;fcntl.h&gt;</span></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb24-6"><a href="#cb24-6"></a></span>
<span id="cb24-7" d__=""><a href="#cb24-7"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">int</span> argc<span class="op" d__="">,</span> <span class="dt" d__="">char</span> <span class="op" d__="">*</span>argv<span class="op" d__="">[])</span></span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="op" d__="">{</span></span>
<span id="cb24-9" d__=""><a href="#cb24-9"></a>        <span class="kw" d__="">struct</span> flock fl <span class="op" d__="">=</span> <span class="op" d__="">{</span></span>
<span id="cb24-10" d__=""><a href="#cb24-10"></a>            <span class="op" d__="">.</span>l_type <span class="op" d__="">=</span> F_WRLCK<span class="op" d__="">,</span></span>
<span id="cb24-11" d__=""><a href="#cb24-11"></a>            <span class="op" d__="">.</span>l_whence <span class="op" d__="">=</span> SEEK_SET<span class="op" d__="">,</span></span>
<span id="cb24-12" d__=""><a href="#cb24-12"></a>            <span class="op" d__="">.</span>l_start <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span></span>
<span id="cb24-13" d__=""><a href="#cb24-13"></a>            <span class="op" d__="">.</span>l_len <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span></span>
<span id="cb24-14"><a href="#cb24-14"></a>        <span class="op" d__="">};</span></span>
<span id="cb24-15" d__=""><a href="#cb24-15"></a>    <span class="dt" d__="">int</span> fd<span class="op" d__="">;</span></span>
<span id="cb24-16"><a href="#cb24-16"></a></span>
<span id="cb24-17" d__=""><a href="#cb24-17"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>argc <span class="op" d__="">&gt;</span> <span class="dv" d__="">1</span><span class="op" d__="">)</span> </span>
<span id="cb24-18" d__=""><a href="#cb24-18"></a>        fl<span class="op" d__="">.</span>l_type <span class="op" d__="">=</span> F_RDLCK<span class="op" d__="">;</span></span>
<span id="cb24-19"><a href="#cb24-19"></a></span>
<span id="cb24-20" d__=""><a href="#cb24-20"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>fd <span class="op" d__="">=</span> open<span class="op" d__="">(</span><span class="st" d__="">"lockdemo.c"</span><span class="op" d__="">,</span> O_RDWR<span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb24-21" d__=""><a href="#cb24-21"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"open"</span><span class="op" d__="">);</span></span>
<span id="cb24-22" d__=""><a href="#cb24-22"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb24-23"><a href="#cb24-23"></a>    <span class="op" d__="">}</span></span>
<span id="cb24-24"><a href="#cb24-24"></a></span>
<span id="cb24-25" d__=""><a href="#cb24-25"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Press &lt;RETURN&gt; to try to get lock: "</span><span class="op" d__="">);</span></span>
<span id="cb24-26" d__=""><a href="#cb24-26"></a>    getchar<span class="op" d__="">();</span></span>
<span id="cb24-27" d__=""><a href="#cb24-27"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Trying to get lock..."</span><span class="op" d__="">);</span></span>
<span id="cb24-28"><a href="#cb24-28"></a></span>
<span id="cb24-29" d__=""><a href="#cb24-29"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>fcntl<span class="op" d__="">(</span>fd<span class="op" d__="">,</span> F_SETLKW<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>fl<span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb24-30" d__=""><a href="#cb24-30"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"fcntl"</span><span class="op" d__="">);</span></span>
<span id="cb24-31" d__=""><a href="#cb24-31"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb24-32"><a href="#cb24-32"></a>    <span class="op" d__="">}</span></span>
<span id="cb24-33"><a href="#cb24-33"></a></span>
<span id="cb24-34" d__=""><a href="#cb24-34"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"got lock</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb24-35" d__=""><a href="#cb24-35"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Press &lt;RETURN&gt; to release lock: "</span><span class="op" d__="">);</span></span>
<span id="cb24-36" d__=""><a href="#cb24-36"></a>    getchar<span class="op" d__="">();</span></span>
<span id="cb24-37"><a href="#cb24-37"></a></span>
<span id="cb24-38" d__=""><a href="#cb24-38"></a>    fl<span class="op" d__="">.</span>l_type <span class="op" d__="">=</span> F_UNLCK<span class="op" d__="">;</span>  <span class="co" d__="">/* set to unlock same region */</span></span>
<span id="cb24-39"><a href="#cb24-39"></a></span>
<span id="cb24-40" d__=""><a href="#cb24-40"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>fcntl<span class="op" d__="">(</span>fd<span class="op" d__="">,</span> F_SETLK<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>fl<span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb24-41" d__=""><a href="#cb24-41"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"fcntl"</span><span class="op" d__="">);</span></span>
<span id="cb24-42" d__=""><a href="#cb24-42"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb24-43"><a href="#cb24-43"></a>    <span class="op" d__="">}</span></span>
<span id="cb24-44"><a href="#cb24-44"></a></span>
<span id="cb24-45" d__=""><a href="#cb24-45"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Unlocked.</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb24-46"><a href="#cb24-46"></a></span>
<span id="cb24-47" d__=""><a href="#cb24-47"></a>    close<span class="op" d__="">(</span>fd<span class="op" d__="">);</span></span>
<span id="cb24-48"><a href="#cb24-48"></a></span>
<span id="cb24-49"><a href="#cb24-49"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb24-50"><a href="#cb24-50"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">Compile that puppy up and start messing with it in a couple windows. Notice that when one <code s__="13">lockdemo</code>
 has a read lock, other instances of the program can get their own read 
locks with no problem. It’s only when a write lock is obtained that 
other processes can’t get a lock of any kind.</p>
<p d__="">Another thing to notice is that you can’t get a write lock if 
there are any read locks on the same region of the file. The process 
waiting to get the write lock will wait until all the read locks are 
cleared. One upshot of this is that you can keep piling on read locks 
(because a read lock doesn’t stop other processes from getting read 
locks) and any processes waiting for a write lock will sit there and 
starve. There isn’t a rule anywhere that keeps you from adding more read
 locks if there is a process waiting for a write lock. You must be 
careful.</p>
<p d__="">Practically, though, you will probably mostly be using write 
locks to guarantee exclusive access to a file for a short amount of time
 while it’s being updated; that is the most common use of locks as far 
as I’ve seen. And I’ve seen them all…well, I’ve seen one…a small one…a 
picture—well, I’ve heard about them.</p>
<h2 data-number="6.4" id="summary-2" d__=""><span class="header-section-number">6.4</span> Summary</h2>
<p d__="">Locks rule. Sometimes, though, you might need more control 
over your processes in a producer-consumer situation. For this reason, 
if no other, you should see the document on System V <a href="#semaphores" d__="">semaphores</a>
 (or POSIX, for that matter; they aren’t identical) if your system 
supports such a beast. They provide a more extensive and at least 
equally function equivalent to file locks.</p>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- ======================================================= -->
<!-- Message Queues -->
<!-- ======================================================= -->
<h1 data-number="7" id="mq" d__=""><span class="header-section-number">7</span> Message Queues</h1>
<p d__="">Those people who brought us System V have seen fit to include 
some IPC goodies that have been implemented on various platforms 
(including Linux, of course.) This document describes the usage and 
functionality of the extremely groovy System V Message Queues! Linux 
also supports a POSIX version of each of these; see <em>mq_overview</em>, <em>sem_overview</em>, and <em>shm_overview</em> in the man pages.</p>
<p d__="">As usual, I want to spew some overview at you before getting into the nitty-gritty. A message queue works kind of like a <a href="#fifos" d__="">FIFO</a>,
 but supports some additional functionality. Generally, see, messages 
are taken off the queue in the order they are put on. Specifically, 
however, there are ways to pull certain messages out of the queue before
 they reach the front. It’s like cutting in line. (Incidentally, don’t 
try to cut in line while visiting the Great America amusement park in 
Silicon Valley, as you can be arrested for it. They take cutting <em>very</em> seriously down there.)</p>
<p d__="">In terms of usage, a process can create a new message queue, 
or it can connect to an existing one. In this, the latter, way two 
processes can exchange information through the same message queue. 
Score.</p>
<p d__="">One more thing about System V IPC: when you create a message 
queue, it doesn’t go away until you destroy it, just like how files 
don’t go away until you explicitly remove them. All the processes that 
have ever used it can quit, but the queue will still exist. A good 
practice is to use the <code s__="13">ipcs</code> command to check if any of your unused message queues are just floating around out there. You can destroy them with the <code s__="13">ipcrm</code>
 command, which is preferable to getting a visit from the sysadmin 
telling you that you’ve grabbed every available message queue on the 
system.</p>
<h2 data-number="7.1" id="wheres-my-queue" d__=""><span class="header-section-number">7.1</span> Where’s my queue?</h2>
<p d__="">Let’s get something going! First of all, you want to connect 
to a queue, or create it if it doesn’t exist. The call to accomplish 
this is the <code s__="13">msgget()</code> system call:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb25-1" d__=""><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> msgget<span class="op" d__="">(</span>key_t key<span class="op" d__="">,</span> <span class="dt" d__="">int</span> msgflg<span class="op" d__="">);</span></span></code></pre></div>
<p d__=""><code s__="13">msgget()</code> returns the message queue ID on success, or <code s__="13">-1</code> on failure (and it sets <code s__="13">errno</code>, of course.)</p>
<p d__="">The arguments are a little weird, but can be understood with a little brow-beating. The first, <code s__="13">key</code>
 is a system-wide unique identifier describing the queue you want to 
connect to (or create). Every other process that wants to connect to 
this queue will have to use the same <code s__="13">key</code>.</p>
<p d__="">The other argument, <code s__="13">msgflg</code> tells <code s__="13">msgget()</code> what to do with queue in question. To create a queue, this field must be set equal to <code s__="13">IPC_CREAT</code>
 bit-wise OR’d with the permissions for this queue. (The queue 
permissions are the same as standard file permissions—queues take on the
 user-id and group-id of the program that created them.)</p>
<p d__="">A sample call is given in the following section.</p>
<h2 data-number="7.2" id="mqftok" d__=""><span class="header-section-number">7.2</span> “Are you the Key Master?”</h2>
<p d__="">What about this <code s__="13">key</code> nonsense? How do we create one? Well, since the type <code s__="13">key_t</code> is actually just a <code s__="13">long</code>,
 you can use any number you want. But what if you hard-code the number 
and some other unrelated program hardcodes the same number but wants 
another queue? The solution is to use the <code s__="13">ftok()</code> function which generates a key from two arguments:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb26-1" d__=""><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>key_t ftok<span class="op" d__="">(</span><span class="dt" d__="">const</span> <span class="dt" d__="">char</span> <span class="op" d__="">*</span>`path`<span class="op" d__="">,</span> <span class="dt" d__="">int</span> `id`<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">Ok, this is getting weird. Basically, <code s__="13">path</code>
 just has to be a path to a file that uniquely identifies this 
application; the pathname to the application’s configuration file is a 
common string to use (what are the odds that two applications will use 
the same configuration file?). The other argument, <code s__="13">id</code> is usually just set to some arbitrary char, like ‘A’. The <code s__="13">ftok()</code> function uses information about the named file (like inode number, etc.) and the <code s__="13">id</code> to generate a probably-unique <code s__="13">key</code> for <code s__="13">msgget()</code>. Programs that want to use the same queue must generate the same <code s__="13">key</code>, so they must pass the same parameters to <code s__="13">ftok()</code>.</p>
<p d__="">Finally, it’s time to make the call:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/msg.h&gt;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3" d__=""><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>key <span class="op" d__="">=</span> ftok<span class="op" d__="">(</span><span class="st" d__="">"/home/beej/somefile"</span><span class="op" d__="">,</span> <span class="ch" d__="">'b'</span><span class="op" d__="">);</span></span>
<span id="cb27-4" d__=""><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>msqid <span class="op" d__="">=</span> msgget<span class="op" d__="">(</span>key<span class="op" d__="">,</span> <span class="bn" d__="">0666</span> <span class="op" d__="">|</span> IPC_CREAT<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">In the above example, I set the permissions on the queue to <code s__="13">666</code> (or <code s__="13">rw-rw-rw-</code>, if that makes more sense to you). And now we have <code s__="13">msqid</code> which will be used to send and receive messages from the queue.</p>
<h2 data-number="7.3" id="sending-to-the-queue" d__=""><span class="header-section-number">7.3</span> Sending to the queue</h2>
<p d__="">Once you’ve connected to the message queue using <code s__="13">msgget()</code>, you are ready to send and receive messages. First, the sending:</p>
<p d__="">Each message is made up of two parts, which are defined in the template structure <code s__="13">struct msgbuf</code>, as defined in <code s__="13">sys/msg.h</code>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb28-1" d__=""><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">struct</span> msgbuf <span class="op" d__="">{</span></span>
<span id="cb28-2" d__=""><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">long</span> mtype<span class="op" d__="">;</span></span>
<span id="cb28-3" d__=""><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">char</span> mtext<span class="op" d__="">[</span><span class="dv" d__="">1</span><span class="op" d__="">];</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">};</span></span></code></pre></div>
<p d__="">The field <code s__="13">mtype</code> is used later when retrieving messages from the queue, and can be set to any positive number. <code s__="13">mtext</code> is the data this will be added to the queue.</p>
<p d__="">“What?! You can only put one byte arrays onto a message 
queue?! Worthless!!” Well, not exactly. You can use any structure you 
want to put messages on the queue, as long as the first element is a 
long. For instance, we could use this structure to store all kinds of 
goodies:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb29-1" d__=""><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">struct</span> pirate_msgbuf <span class="op" d__="">{</span></span>
<span id="cb29-2" d__=""><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">long</span> mtype<span class="op" d__="">;</span>  <span class="co" d__="">/* must be positive */</span></span>
<span id="cb29-3" d__=""><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw" d__="">struct</span> pirate_info <span class="op" d__="">{</span></span>
<span id="cb29-4" d__=""><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt" d__="">char</span> name<span class="op" d__="">[</span><span class="dv" d__="">30</span><span class="op" d__="">];</span></span>
<span id="cb29-5" d__=""><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt" d__="">char</span> ship_type<span class="op" d__="">;</span></span>
<span id="cb29-6" d__=""><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt" d__="">int</span> notoriety<span class="op" d__="">;</span></span>
<span id="cb29-7" d__=""><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt" d__="">int</span> cruelty<span class="op" d__="">;</span></span>
<span id="cb29-8" d__=""><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt" d__="">int</span> booty_value<span class="op" d__="">;</span></span>
<span id="cb29-9" d__=""><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">}</span> info<span class="op" d__="">;</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">};</span></span></code></pre></div>
<p d__="">Ok, so how do we pass this information to a message queue? The answer is simple, my friends: just use <code s__="13">msgsnd()</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb30-1" d__=""><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> msgsnd<span class="op" d__="">(</span><span class="dt" d__="">int</span> msqid<span class="op" d__="">,</span> <span class="dt" d__="">const</span> <span class="dt" d__="">void</span> <span class="op" d__="">*</span>msgp<span class="op" d__="">,</span></span>
<span id="cb30-2" d__=""><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>           <span class="dt" d__="">size_t</span> msgsz<span class="op" d__="">,</span> <span class="dt" d__="">int</span> msgflg<span class="op" d__="">);</span></span></code></pre></div>
<p d__=""><code s__="13">msqid</code> is the message queue identifier returned by <code s__="13">msgget()</code>. The pointer <code s__="13">msgp</code> is a pointer to the data you want to put on the queue. <code s__="13">msgsz</code> is the size in bytes of the data to add to the queue (not counting the size of the <code s__="13">mtype</code> member). Finally, <code s__="13">msgflg</code> allows you to set some optional flag parameters, which we’ll ignore for now by setting it to <code s__="13">0</code>.</p>
<p d__="">The best way to get the size of the data to send is by setting it up correctly to begin with. The first field of the <code s__="13">struct</code> should be a <code s__="13">long</code>, as we’ve seen. To be safe and portable, there should only be one additional field. If you need more than one, wrap it up in a <code s__="13">struct</code> like with <code s__="13">struct pirate_msgbuf</code>, above.</p>
<p d__="">When to get the size of the data to send, just take the size of the second field:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb31-1" d__=""><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">struct</span> cheese_msgbuf <span class="op" d__="">{</span></span>
<span id="cb31-2" d__=""><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">long</span> mtype<span class="op" d__="">;</span></span>
<span id="cb31-3" d__=""><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">char</span> name<span class="op" d__="">[</span><span class="dv" d__="">20</span><span class="op" d__="">];</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">};</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">/* calculate the size of the data to send: */</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8" d__=""><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">struct</span> cheese_msgbuf mbuf<span class="op" d__="">;</span></span>
<span id="cb31-9" d__=""><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> size<span class="op" d__="">;</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11" d__=""><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>size <span class="op" d__="">=</span> <span class="kw" d__="">sizeof</span> mbuf<span class="op" d__="">.</span>name<span class="op" d__="">;</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">/* Or, without a declared variable: */</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-15" d__=""><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>size <span class="op" d__="">=</span> <span class="kw" d__="">sizeof</span> <span class="op" d__="">((</span><span class="kw" d__="">struct</span> cheese_msgbuf<span class="op" d__="">*)</span><span class="dv" d__="">0</span><span class="op" d__="">)-&gt;</span>name<span class="op" d__="">;</span></span></code></pre></div>
<p d__="">Or, if you have a lot of different fields, put them in a <code s__="13">struct</code> and use the <operator>sizeof</operator>
 operator on that. It can be extra convenient to do this, because now 
the substructure can have a name to reference. Here is a code snippet 
that shows one of our pirate structures being added to the message 
queue:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/msg.h&gt;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stddef.h&gt;</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4" d__=""><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>key_t key<span class="op" d__="">;</span></span>
<span id="cb32-5" d__=""><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> msqid<span class="op" d__="">;</span></span>
<span id="cb32-6" d__=""><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">struct</span> pirate_msgbuf pmb <span class="op" d__="">=</span> <span class="op" d__="">{</span><span class="dv" d__="">2</span><span class="op" d__="">,</span> <span class="op" d__="">{</span> <span class="st" d__="">"L'Olonais"</span><span class="op" d__="">,</span> <span class="ch" d__="">'S'</span><span class="op" d__="">,</span> <span class="dv" d__="">80</span><span class="op" d__="">,</span> <span class="dv" d__="">10</span><span class="op" d__="">,</span> <span class="dv" d__="">12035</span> <span class="op" d__="">}</span> <span class="op" d__="">};</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8" d__=""><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>key <span class="op" d__="">=</span> ftok<span class="op" d__="">(</span><span class="st" d__="">"/home/beej/somefile"</span><span class="op" d__="">,</span> <span class="ch" d__="">'b'</span><span class="op" d__="">);</span></span>
<span id="cb32-9" d__=""><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>msqid <span class="op" d__="">=</span> msgget<span class="op" d__="">(</span>key<span class="op" d__="">,</span> <span class="bn" d__="">0666</span> <span class="op" d__="">|</span> IPC_CREAT<span class="op" d__="">);</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">/* stick him on the queue */</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">/* struct pirate_info is the sub-structure */</span></span>
<span id="cb32-13" d__=""><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>msgsnd<span class="op" d__="">(</span>msqid<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>pmb<span class="op" d__="">,</span> <span class="kw" d__="">sizeof</span><span class="op" d__="">(</span><span class="kw" d__="">struct</span> pirate_info<span class="op" d__="">),</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span></code></pre></div>
<p d__="">Aside from remembering to error-check the return values from 
all these functions, this is all there is to it. Oh, yeah: note that I 
arbitrarily set the <code s__="13">mtype</code> field to <code s__="13">2</code> up there. That’ll be important in the next section.</p>
<h2 data-number="7.4" id="receiving-from-the-queue" d__=""><span class="header-section-number">7.4</span> Receiving from the queue</h2>
<p d__="">Now that we have the dreaded pirate <a href="https://beej.us/pirates/pirate_view.php?file=lolonais.jpg" d__="">Francis L’Olonais</a> stuck in our message queue, how do we get him out? As you can imagine, there is a counterpart to <code s__="13">msgsnd()</code>: it is <code s__="13">msgrcv()</code>. How imaginative.</p>
<p d__="">A call to <code s__="13">msgrcv()</code> that would do it looks something like this:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/msg.h&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stddef.h&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4" d__=""><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>key_t key<span class="op" d__="">;</span></span>
<span id="cb33-5" d__=""><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> msqid<span class="op" d__="">;</span></span>
<span id="cb33-6" d__=""><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">struct</span> pirate_msgbuf pmb<span class="op" d__="">;</span> <span class="co" d__="">/* where L'Olonais is to be kept */</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8" d__=""><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>key <span class="op" d__="">=</span> ftok<span class="op" d__="">(</span><span class="st" d__="">"/home/beej/somefile"</span><span class="op" d__="">,</span> <span class="ch" d__="">'b'</span><span class="op" d__="">);</span></span>
<span id="cb33-9" d__=""><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>msqid <span class="op" d__="">=</span> msgget<span class="op" d__="">(</span>key<span class="op" d__="">,</span> <span class="bn" d__="">0666</span> <span class="op" d__="">|</span> IPC_CREAT<span class="op" d__="">);</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">/* get him off the queue! */</span></span>
<span id="cb33-12" d__=""><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>msgrcv<span class="op" d__="">(</span>msqid<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>pmb<span class="op" d__="">,</span> <span class="kw" d__="">sizeof</span><span class="op" d__="">(</span><span class="kw" d__="">struct</span> pirate_info<span class="op" d__="">),</span> <span class="dv" d__="">2</span><span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span></code></pre></div>
<p d__="">There is something new to note in the <code s__="13">msgrcv()</code> call: the <code s__="13">2</code>! What does it mean? Here’s the synopsis of the call:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb34-1" d__=""><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> msgrcv<span class="op" d__="">(</span><span class="dt" d__="">int</span> msqid<span class="op" d__="">,</span> <span class="dt" d__="">void</span> <span class="op" d__="">*</span>msgp<span class="op" d__="">,</span> <span class="dt" d__="">size_t</span> msgsz<span class="op" d__="">,</span> <span class="dt" d__="">long</span> msgtyp<span class="op" d__="">,</span> <span class="dt" d__="">int</span> msgflg<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">The <code s__="13">2</code> we specified in the call is the requested <code s__="13">msgtyp</code>. Recall that we set the <code s__="13">mtype</code> arbitrarily to <code s__="13">2</code> in the <code s__="13">msgsnd()</code> section of this document, so that will be the one that is retrieved from the queue.</p>
<p d__="">Actually, the behavior of <code s__="13">msgrcv()</code> can be modified drastically by choosing a <code s__="13">msgtyp</code> that is positive, negative, or zero:</p>
<table>
<colgroup>
<col style="width: 11%">
<col style="width: 88%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><code s__="13" d__="">msgtyp</code></th>
<th d__="">Effect on <code s__="13">msgrcv()</code></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;" d__="">Zero</td>
<td d__="">Retrieve the next message on the queue, regardless of its <code s__="13">mtype</code>.</td>
</tr>
<tr class="even">
<td style="text-align: center;" d__="">Positive</td>
<td d__="">Get the next message with an <code s__="13">mtype</code> <em>equal to</em> the specified <code s__="13">msgtyp</code>.</td>
</tr>
<tr class="odd">
<td style="text-align: center;" d__="">Negative</td>
<td d__="">Retrieve the first message on the queue whose <code s__="13">mtype</code> field is less than or equal to the absolute value of the <code s__="13">msgtyp</code> argument.</td>
</tr>
</tbody>
</table>
<p d__="">So, what will often be the case is that you’ll simply want the next message on the queue, no matter what <code s__="13">mtype</code> it is. As such, you’d set the <code s__="13">msgtyp</code> parameter to <code s__="13">0</code>.</p>
<h2 data-number="7.5" id="destroying-a-message-queue" d__=""><span class="header-section-number">7.5</span> Destroying a message queue</h2>
<p d__="">There comes a time when you have to destroy a message queue. 
Like I said before, they will stick around until you explicitly remove 
them; it is important that you do this so you don’t waste system 
resources. Ok, so you’ve been using this message queue all day, and it’s
 getting old. You want to obliterate it. There are two ways:</p>
<ol type="1">
<li><p d__="">Use the Unix command <code s__="13">ipcs</code> to get a list of defined message queues, then use the command <code s__="13">ipcrm</code> to delete the queue.</p></li>
<li><p d__="">Write a program to do it for you.</p></li>
</ol>
<p d__="">Often, the latter choice is the most appropriate, since you 
might want your program to clean up the queue at some time or another. 
To do this requires the introduction of another function: <code s__="13">msgctl()</code>.</p>
<p d__="">The synopsis of <code s__="13">msgctl()</code> is:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb35-1" d__=""><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> msgctl<span class="op" d__="">(</span><span class="dt" d__="">int</span> msqid<span class="op" d__="">,</span> <span class="dt" d__="">int</span> cmd<span class="op" d__="">,</span></span>
<span id="cb35-2" d__=""><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>           <span class="kw" d__="">struct</span> msqid_ds <span class="op" d__="">*</span>buf<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">Of course, <code s__="13">msqid</code> is the queue identifier obtained from <code s__="13">msgget()</code>. The important argument is <code s__="13">cmd</code> which tells <code s__="13">msgctl()</code> how to behave. It can be a variety of things, but we’re only going to talk about <code s__="13">IPC_RMID</code>, which is used to remove the message queue. The <code s__="13">buf</code> argument can be set to <code s__="13">NULL</code> for the purposes of <code s__="13">IPC_RMID</code>.</p>
<p d__="">Say that we have the queue we created above to hold the pirates. You can destroy that queue by issuing the following call:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/msg.h&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">.</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">.</span></span>
<span id="cb36-4" d__=""><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>msgctl<span class="op" d__="">(</span>msqid<span class="op" d__="">,</span> IPC_RMID<span class="op" d__="">,</span> NULL<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">And the message queue is no more. (Of course, error checking of these return values is always appropriate!)</p>
<!-- ======================================================= -->
<!-- Message queues: Sample programs, anyone? -->
<!-- ======================================================= -->
<h2 data-number="7.6" id="sample-programs-anyone" d__=""><span class="header-section-number">7.6</span> Sample programs, anyone?</h2>
<p d__="">For the sake of completeness, I’ll include a brace of programs that will communicate using message queues. The first, <code s__="13">kirk.c</code> adds messages to the message queue, and <code s__="13">spock.c</code> retrieves them.</p>
<p d__="">Here is the source for <a href="https://beej.us/guide/bgipc/source/examples/kirk.c"><code s__="13" d__="">kirk.c</code></a><a href="#fn32" class="footnote-ref" id="fnref32" role="doc-noteref"><sup s__="13" d__="">32</sup></a>:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb37-1"><a href="#cb37-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb37-2"><a href="#cb37-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;string.h&gt;</span></span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/ipc.h&gt;</span></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/msg.h&gt;</span></span>
<span id="cb37-8"><a href="#cb37-8"></a></span>
<span id="cb37-9" d__=""><a href="#cb37-9"></a><span class="kw" d__="">struct</span> my_msgbuf <span class="op" d__="">{</span></span>
<span id="cb37-10" d__=""><a href="#cb37-10"></a>    <span class="dt" d__="">long</span> mtype<span class="op" d__="">;</span></span>
<span id="cb37-11" d__=""><a href="#cb37-11"></a>    <span class="dt" d__="">char</span> mtext<span class="op" d__="">[</span><span class="dv" d__="">200</span><span class="op" d__="">];</span></span>
<span id="cb37-12"><a href="#cb37-12"></a><span class="op" d__="">};</span></span>
<span id="cb37-13"><a href="#cb37-13"></a></span>
<span id="cb37-14" d__=""><a href="#cb37-14"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb37-15"><a href="#cb37-15"></a><span class="op" d__="">{</span></span>
<span id="cb37-16" d__=""><a href="#cb37-16"></a>    <span class="kw" d__="">struct</span> my_msgbuf buf<span class="op" d__="">;</span></span>
<span id="cb37-17" d__=""><a href="#cb37-17"></a>    <span class="dt" d__="">int</span> msqid<span class="op" d__="">;</span></span>
<span id="cb37-18" d__=""><a href="#cb37-18"></a>    key_t key<span class="op" d__="">;</span></span>
<span id="cb37-19"><a href="#cb37-19"></a></span>
<span id="cb37-20" d__=""><a href="#cb37-20"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>key <span class="op" d__="">=</span> ftok<span class="op" d__="">(</span><span class="st" d__="">"kirk.c"</span><span class="op" d__="">,</span> <span class="ch" d__="">'B'</span><span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb37-21" d__=""><a href="#cb37-21"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"ftok"</span><span class="op" d__="">);</span></span>
<span id="cb37-22" d__=""><a href="#cb37-22"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb37-23"><a href="#cb37-23"></a>    <span class="op" d__="">}</span></span>
<span id="cb37-24"><a href="#cb37-24"></a></span>
<span id="cb37-25" d__=""><a href="#cb37-25"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>msqid <span class="op" d__="">=</span> msgget<span class="op" d__="">(</span>key<span class="op" d__="">,</span> <span class="bn" d__="">0644</span> <span class="op" d__="">|</span> IPC_CREAT<span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb37-26" d__=""><a href="#cb37-26"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"msgget"</span><span class="op" d__="">);</span></span>
<span id="cb37-27" d__=""><a href="#cb37-27"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb37-28"><a href="#cb37-28"></a>    <span class="op" d__="">}</span></span>
<span id="cb37-29"><a href="#cb37-29"></a>    </span>
<span id="cb37-30" d__=""><a href="#cb37-30"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Enter lines of text, ^D to quit:</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb37-31"><a href="#cb37-31"></a></span>
<span id="cb37-32" d__=""><a href="#cb37-32"></a>    buf<span class="op" d__="">.</span>mtype <span class="op" d__="">=</span> <span class="dv" d__="">1</span><span class="op" d__="">;</span> <span class="co" d__="">/* we don't really care in this case */</span></span>
<span id="cb37-33"><a href="#cb37-33"></a></span>
<span id="cb37-34" d__=""><a href="#cb37-34"></a>    <span class="cf" d__="">while</span><span class="op" d__="">(</span>fgets<span class="op" d__="">(</span>buf<span class="op" d__="">.</span>mtext<span class="op" d__="">,</span> <span class="kw" d__="">sizeof</span> buf<span class="op" d__="">.</span>mtext<span class="op" d__="">,</span> stdin<span class="op" d__="">)</span> <span class="op" d__="">!=</span> NULL<span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb37-35" d__=""><a href="#cb37-35"></a>        <span class="dt" d__="">int</span> len <span class="op" d__="">=</span> strlen<span class="op" d__="">(</span>buf<span class="op" d__="">.</span>mtext<span class="op" d__="">);</span></span>
<span id="cb37-36"><a href="#cb37-36"></a></span>
<span id="cb37-37"><a href="#cb37-37"></a>        <span class="co" d__="">/* ditch newline at end, if it exists */</span></span>
<span id="cb37-38" d__=""><a href="#cb37-38"></a>        <span class="cf" d__="">if</span> <span class="op" d__="">(</span>buf<span class="op" d__="">.</span>mtext<span class="op" d__="">[</span>len<span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">]</span> <span class="op" d__="">==</span> <span class="ch" d__="">'</span><span class="sc" d__="">\n</span><span class="ch" d__="">'</span><span class="op" d__="">)</span> buf<span class="op" d__="">.</span>mtext<span class="op" d__="">[</span>len<span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">]</span> <span class="op" d__="">=</span> <span class="ch" d__="">'</span><span class="sc" d__="">\0</span><span class="ch" d__="">'</span><span class="op" d__="">;</span></span>
<span id="cb37-39"><a href="#cb37-39"></a></span>
<span id="cb37-40" d__=""><a href="#cb37-40"></a>        <span class="cf" d__="">if</span> <span class="op" d__="">(</span>msgsnd<span class="op" d__="">(</span>msqid<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>buf<span class="op" d__="">,</span> len<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span></span>
<span id="cb37-41" d__=""><a href="#cb37-41"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"msgsnd"</span><span class="op" d__="">);</span></span>
<span id="cb37-42"><a href="#cb37-42"></a>    <span class="op" d__="">}</span></span>
<span id="cb37-43"><a href="#cb37-43"></a></span>
<span id="cb37-44" d__=""><a href="#cb37-44"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>msgctl<span class="op" d__="">(</span>msqid<span class="op" d__="">,</span> IPC_RMID<span class="op" d__="">,</span> NULL<span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb37-45" d__=""><a href="#cb37-45"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"msgctl"</span><span class="op" d__="">);</span></span>
<span id="cb37-46" d__=""><a href="#cb37-46"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb37-47"><a href="#cb37-47"></a>    <span class="op" d__="">}</span></span>
<span id="cb37-48"><a href="#cb37-48"></a></span>
<span id="cb37-49"><a href="#cb37-49"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb37-50"><a href="#cb37-50"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">The way <code s__="13">kirk</code> works is that it allows you
 to enter lines of text. Each line is bundled into a message and added 
to the message queue. The message queue is then read by <code s__="13">spock</code>.</p>
<p d__="">Here is the source for <a href="https://beej.us/guide/bgipc/source/examples/spock.c"><code s__="13" d__="">spock.c</code></a><a href="#fn33" class="footnote-ref" id="fnref33" role="doc-noteref"><sup s__="13" d__="">33</sup></a>:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb38-1"><a href="#cb38-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/ipc.h&gt;</span></span>
<span id="cb38-6"><a href="#cb38-6"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/msg.h&gt;</span></span>
<span id="cb38-7"><a href="#cb38-7"></a></span>
<span id="cb38-8" d__=""><a href="#cb38-8"></a><span class="kw" d__="">struct</span> my_msgbuf <span class="op" d__="">{</span></span>
<span id="cb38-9" d__=""><a href="#cb38-9"></a>    <span class="dt" d__="">long</span> mtype<span class="op" d__="">;</span></span>
<span id="cb38-10" d__=""><a href="#cb38-10"></a>    <span class="dt" d__="">char</span> mtext<span class="op" d__="">[</span><span class="dv" d__="">200</span><span class="op" d__="">];</span></span>
<span id="cb38-11"><a href="#cb38-11"></a><span class="op" d__="">};</span></span>
<span id="cb38-12"><a href="#cb38-12"></a></span>
<span id="cb38-13" d__=""><a href="#cb38-13"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb38-14"><a href="#cb38-14"></a><span class="op" d__="">{</span></span>
<span id="cb38-15" d__=""><a href="#cb38-15"></a>    <span class="kw" d__="">struct</span> my_msgbuf buf<span class="op" d__="">;</span></span>
<span id="cb38-16" d__=""><a href="#cb38-16"></a>    <span class="dt" d__="">int</span> msqid<span class="op" d__="">;</span></span>
<span id="cb38-17" d__=""><a href="#cb38-17"></a>    key_t key<span class="op" d__="">;</span></span>
<span id="cb38-18"><a href="#cb38-18"></a></span>
<span id="cb38-19" d__=""><a href="#cb38-19"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>key <span class="op" d__="">=</span> ftok<span class="op" d__="">(</span><span class="st" d__="">"kirk.c"</span><span class="op" d__="">,</span> <span class="ch" d__="">'B'</span><span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span>  <span class="co" d__="">/* same key as kirk.c */</span></span>
<span id="cb38-20" d__=""><a href="#cb38-20"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"ftok"</span><span class="op" d__="">);</span></span>
<span id="cb38-21" d__=""><a href="#cb38-21"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb38-22"><a href="#cb38-22"></a>    <span class="op" d__="">}</span></span>
<span id="cb38-23"><a href="#cb38-23"></a></span>
<span id="cb38-24" d__=""><a href="#cb38-24"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>msqid <span class="op" d__="">=</span> msgget<span class="op" d__="">(</span>key<span class="op" d__="">,</span> <span class="bn" d__="">0644</span><span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span> <span class="co" d__="">/* connect to the queue */</span></span>
<span id="cb38-25" d__=""><a href="#cb38-25"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"msgget"</span><span class="op" d__="">);</span></span>
<span id="cb38-26" d__=""><a href="#cb38-26"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb38-27"><a href="#cb38-27"></a>    <span class="op" d__="">}</span></span>
<span id="cb38-28"><a href="#cb38-28"></a>    </span>
<span id="cb38-29" d__=""><a href="#cb38-29"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"spock: ready to receive messages, captain.</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb38-30"><a href="#cb38-30"></a></span>
<span id="cb38-31"><a href="#cb38-31"></a>    <span class="cf" d__="">for</span><span class="op" d__="">(;;)</span> <span class="op" d__="">{</span> <span class="co" d__="">/* Spock never quits! */</span></span>
<span id="cb38-32" d__=""><a href="#cb38-32"></a>        <span class="cf" d__="">if</span> <span class="op" d__="">(</span>msgrcv<span class="op" d__="">(</span>msqid<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>buf<span class="op" d__="">,</span> <span class="kw" d__="">sizeof</span> buf<span class="op" d__="">.</span>mtext<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb38-33" d__=""><a href="#cb38-33"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"msgrcv"</span><span class="op" d__="">);</span></span>
<span id="cb38-34" d__=""><a href="#cb38-34"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb38-35"><a href="#cb38-35"></a>        <span class="op" d__="">}</span></span>
<span id="cb38-36" d__=""><a href="#cb38-36"></a>        printf<span class="op" d__="">(</span><span class="st" d__="">"spock: </span><span class="sc" d__="">\"%s\"\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> buf<span class="op" d__="">.</span>mtext<span class="op" d__="">);</span></span>
<span id="cb38-37"><a href="#cb38-37"></a>    <span class="op" d__="">}</span></span>
<span id="cb38-38"><a href="#cb38-38"></a></span>
<span id="cb38-39"><a href="#cb38-39"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb38-40"><a href="#cb38-40"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">Notice that <code s__="13">spock</code>, in the call to <code s__="13">msgget()</code>, doesn’t include the <code s__="13">IPC_CREAT</code> option. We’ve left it up to <code s__="13">kirk</code> to create the message queue, and <code s__="13">spock</code> will return an error if he hasn’t done so.</p>
<p d__="">Notice what happens when you’re running both in separate windows and you kill one or the other. Also try running two copies of <code s__="13">kirk</code> or two copies of <code s__="13">spock</code> to get an idea of what happens when you have two readers or two writers. Another interesting demonstration is to run <code s__="13">kirk</code>, enter a bunch of messages, then run <code s__="13">spock</code>
 and see it retrieve all the messages in one swoop. Just messing around 
with these toy programs will help you gain an understanding of what is 
really going on.</p>
<h2 data-number="7.7" id="summary-3" d__=""><span class="header-section-number">7.7</span> Summary</h2>
<p d__="">There is more to message queues than this short tutorial can 
present. Be sure to look in the man pages to see what else you can do, 
especially in the area of <code s__="13">msgctl()</code>. Also, there are more options you can pass to other functions to control how <code s__="13">msgsnd()</code> and <code s__="13">msgrcv()</code> handle if the queue is full or empty, respectively.</p>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- ======================================================= -->
<!-- Semaphores -->
<!-- ======================================================= -->
<h1 data-number="8" id="semaphores" d__=""><span class="header-section-number">8</span> Semaphores</h1>
<p d__="">Remember <a href="#flocking" d__="">file locking</a>? Well, 
semaphores can be thought of as really generic advisory locking 
mechanisms. You can use them to control access to files, <a href="#shm" d__="">shared memory</a>,
 and, well, just about anything you want. The basic functionality of a 
semaphore is that you can either set it, check it, or wait until it 
clears then set it (“test-n-set”). No matter how complex the stuff that 
follows gets, remember those three operations.</p>
<p d__="">This document will provide an overview of semaphore 
functionality, and will end with a program that uses semaphores to 
control access to a file. (This task, admittedly, could easily be 
handled with file locking, but it makes a good example since it’s easier
 to wrap your head around than, say, shared memory.)</p>
<!-- ======================================================= -->
<!-- Grabbing some semaphores -->
<!-- ======================================================= -->
<h2 data-number="8.1" id="grabbing-some-semaphores" d__=""><span class="header-section-number">8.1</span> Grabbing some semaphores</h2>
<p d__="">With System V IPC, you don’t grab single semaphores; you grab <em>sets</em>
 of semaphores. You can, of course, grab a semaphore set that only has 
one semaphore in it, but the point is you can have a whole slew of 
semaphores just by creating a single semaphore set.</p>
<p d__="">How do you create the semaphore set? It’s done with a call to <code s__="13">semget()</code>, which returns the semaphore id (hereafter referred to as the <code s__="13">semid</code>):</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/sem.h&gt;</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3" d__=""><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> semget<span class="op" d__="">(</span>key_t key<span class="op" d__="">,</span> <span class="dt" d__="">int</span> nsems<span class="op" d__="">,</span> <span class="dt" d__="">int</span> semflg<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">What’s the <code s__="13">key</code>? It’s a unique identifier that is used by different processes to identify this semaphore set. (This <code s__="13">key</code> will be generated using <code s__="13">ftok()</code>, described in the <a href="#mqftok" d__="">Message Queues section</a>.)</p>
<p d__="">The next argument, <code s__="13">nsems</code>, is (you 
guessed it!) the number of semaphores in this semaphore set. The maximum
 number is system dependent, but it’s probably around 32000. If you’re 
needing more (greedy wretch!), just get another semaphore set. You may 
pass <code s__="13">0</code> if you’re connecting to an existing 
semaphore set, but you must specify a positive number if you’re creating
 a new semaohore set.</p>
<p d__="">Finally, there’s the <code s__="13">semflg</code> argument. This tells <code s__="13">semget()</code>
 what the permissions should be on the new semaphore set, whether you’re
 creating a new set or just want to connect to an existing one, and 
other things that you can look up. For creating a new set, permissions 
can be bitwise-OR’d with <code s__="13">IPC_CREAT</code>.</p>
<p d__="">Here’s an example call that generates the <code s__="13">key</code> with <code s__="13">ftok()</code> and creates a 10 semaphore set, with 666 (<code s__="13">rw-rw-rw-</code>) permissions:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/ipc.h&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/sem.h&gt;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4" d__=""><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>key_t key<span class="op" d__="">;</span></span>
<span id="cb40-5" d__=""><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> semid<span class="op" d__="">;</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7" d__=""><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>key <span class="op" d__="">=</span> ftok<span class="op" d__="">(</span><span class="st" d__="">"/home/beej/somefile"</span><span class="op" d__="">,</span> <span class="ch" d__="">'E'</span><span class="op" d__="">);</span></span>
<span id="cb40-8" d__=""><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>semid <span class="op" d__="">=</span> semget<span class="op" d__="">(</span>key<span class="op" d__="">,</span> <span class="dv" d__="">10</span><span class="op" d__="">,</span> <span class="bn" d__="">0666</span> <span class="op" d__="">|</span> IPC_CREAT<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">Congrats! You’ve created a new semaphore set! After running the program you can check it out with the <code s__="13">ipcs</code> command. (Don’t forget to remove it when you’re done with it with <code s__="13">ipcrm</code>!)</p>
<p d__="">Wait! Warning! <em>¡Advertencia! ¡No pongas las manos en la tolva!</em> (That’s the only Spanish I learned while working at Pizza Hut in 1990. It was printed on the dough roller.) Look here:</p>
<p d__="">When you first create some semaphores, they’re all uninitialized; it takes another call to mark them as free (namely to <code s__="13">semop()</code> or <code s__="13">semctl()</code>—see the following sections.) What does this mean? Well, it means that creation of a semaphore is not <em>atomic</em>
 (in other words, it’s not a one-step process). If two processes are 
trying to create, initialize, and use a semaphore at the same time, a 
race condition might develop.</p>
<p d__="">One way to get around this difficulty is by having a single 
init process that creates and initializes the semaphore long before the 
main processes begin to run. The main process just accesses it, but 
never creates nor destroys it.</p>
<p d__="">Stevens refers to this problem as the semaphore’s “fatal flaw”. He solves it by creating the semaphore set with the <code s__="13">IPC_EXCL</code> flag. If process 1 creates it first, process 2 will return an error on the call (with <code s__="13">errno</code> set to <code s__="13">EEXIST</code>.)
 At that point, process 2 will have to wait until the semaphore is 
initialized by process 1. How can it tell? Turns out, it can repeatedly 
call <code s__="13">semctl()</code> with the <code s__="13">IPC_STAT</code> flag, and look at the <code s__="13">sem_otime</code> member of the returned <code s__="13">struct semid_ds</code> structure. If that’s non-zero, it means process 1 has performed an operation on the semaphore with <code s__="13">semop()</code>, presumably to initialize it.</p>
<p d__="">For an example of this, see the demonstration program <a href="https://beej.us/guide/bgipc/source/examples/semdemo.c"><code s__="13" d__="">semdemo.c</code></a><a href="#fn34" class="footnote-ref" id="fnref34" role="doc-noteref"><sup s__="13" d__="">34</sup></a>, below, in which I generally reimplement <a href="http://www.kohala.com/start/unpv22e/unpv22e.html" d__="">Stevens’s code</a>.</p>
<p d__="">In the meantime, let’s hop to the next section and take a look at how to initialize our freshly-minted semaphores.</p>
<!-- ======================================================= -->
<!-- Controlling semaphores -->
<!-- ======================================================= -->
<h2 data-number="8.2" id="controlling-your-semaphores-with-semctl" d__=""><span class="header-section-number">8.2</span> Controlling your semaphores with <code>semctl()</code></h2>
<p d__="">Once you have created your semaphore sets, you have to 
initialize them to a positive value to show that the resource is 
available to use. The function <code s__="13">semctl()</code> allows you to do atomic value changes to individual semaphores or complete sets of semaphores.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb41-1" d__=""><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> semctl<span class="op" d__="">(</span><span class="dt" d__="">int</span> semid<span class="op" d__="">,</span> <span class="dt" d__="">int</span> semnum<span class="op" d__="">,</span> <span class="dt" d__="">int</span> cmd<span class="op" d__="">,</span> <span class="op" d__="">...</span> <span class="co" d__="">/*arg*/</span><span class="op" d__="">);</span></span></code></pre></div>
<p d__=""><code s__="13">semid</code> is the semaphore set id that you get from your call to <code s__="13">semget()</code>, earlier. <code s__="13">semnum</code> is the ID of the semaphore that you wish to manipulate the value of. <code s__="13">cmd</code> is what you wish to do with the semaphore in question. The last “argument”, “<code s__="13">arg</code>”, if required, needs to be a <code s__="13">union semun</code>, which will be defined by you in your code to be one of these:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb42-1" d__=""><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">union</span> semun <span class="op" d__="">{</span></span>
<span id="cb42-2" d__=""><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">int</span> val<span class="op" d__="">;</span>               <span class="co" d__="">/* used for SETVAL only */</span></span>
<span id="cb42-3" d__=""><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw" d__="">struct</span> semid_ds <span class="op" d__="">*</span>buf<span class="op" d__="">;</span>  <span class="co" d__="">/* used for IPC_STAT and IPC_SET */</span></span>
<span id="cb42-4" d__=""><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    ushort <span class="op" d__="">*</span>array<span class="op" d__="">;</span>         <span class="co" d__="">/* used for GETALL and SETALL */</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">};</span></span></code></pre></div>
<p d__="">(Note that <code s__="13">union semun</code> is now defined in
 the header files of modern Linux systems. However, I don’t know what 
feature test macro to use to determine this, so only define this union 
if your system doesn’t already. Read the docs for <code s__="13">semctl()</code> for more information.)</p>
<p d__="">The various fields in the <code s__="13">union semun</code> are used depending on the value of the <code s__="13">cmd</code> parameter to <code s__="13">semctl()</code> (a partial list follows—see your local man page for more):</p>
<table>
<colgroup>
<col style="width: 14%">
<col style="width: 85%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><code s__="13" d__="">cmd</code></th>
<th d__="">Effect</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SETVAL</code></td>
<td d__="">Set the value of the specified semaphore to the value in the <code s__="13">val</code> member of the passed-in <code s__="13">union semun</code>.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">GETVAL</code></td>
<td d__="">Return the value of the given semaphore.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">SETALL</code></td>
<td d__="">Set the values of all the semaphores in the set to the values in the array pointed to by the <code s__="13">array</code> member of the passed-in <code s__="13">union semun</code>. The <code s__="13">semnum</code> parameter to <code s__="13">semctl()</code> isn’t used.&lt;</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">GETALL</code></td>
<td d__="">Gets the values of all the semaphores in the set and stores them in the array pointed to by the <code s__="13">array</code> member of the passed-in <code s__="13">union semun</code>. The <code s__="13">semnum</code> parameter to <code s__="13">semctl()</code> isn’t used.</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><code s__="13" d__="">IPC_RMID</code></td>
<td d__="">Remove the specified semaphore set from the system. The <code s__="13">semnum</code> parameter is ignored.</td>
</tr>
<tr class="even">
<td style="text-align: center;"><code s__="13" d__="">IPC_STAT</code></td>
<td d__="">Load status information about the semaphore set into the <code s__="13">struct semid_ds</code> structure pointed to by the <code s__="13">buf</code> member of the <code s__="13">union semun</code>.</td>
</tr>
</tbody>
</table>
<p d__="">For the curious, here are the (abbreviated) contents of the <code s__="13">struct semid_ds</code> that is used in the <code s__="13">union semun</code>:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb43-1" d__=""><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">struct</span> semid_ds <span class="op" d__="">{</span></span>
<span id="cb43-2" d__=""><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw" d__="">struct</span> ipc_perm sem_perm<span class="op" d__="">;</span>  <span class="co" d__="">/* Ownership and permissions</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">    time_t          sem_otime; /* Last semop time */</span></span>
<span id="cb43-4" d__=""><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">time_t</span>          sem_ctime<span class="op" d__="">;</span> <span class="co" d__="">/* Last change time */</span></span>
<span id="cb43-5" d__=""><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">unsigned</span> <span class="dt" d__="">short</span>  sem_nsems<span class="op" d__="">;</span> <span class="co" d__="">/* No. of semaphores in set */</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">};</span></span></code></pre></div>
<p d__="">We’ll use that <code s__="13">sem_otime</code> member later on when we write our <code s__="13">initsem()</code> in the sample code, below.</p>
<!-- ======================================================= -->
<!-- semop(): Atomic power! -->
<!-- ======================================================= -->
<h2 data-number="8.3" id="semop-atomic-power" d__=""><span class="header-section-number">8.3</span> <code>semop()</code>: Atomic power!</h2>
<p d__="">All operations that set, get, or test-n-set a semaphore use the <code s__="13">semop()</code> system call. This system call is general purpose, and its functionality is dictated by a structure that is passed to it, <code s__="13">struct sembuf</code>:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">/* Warning! Members might not be in this order! */</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3" d__=""><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">struct</span> sembuf <span class="op" d__="">{</span></span>
<span id="cb44-4" d__=""><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    ushort sem_num<span class="op" d__="">;</span></span>
<span id="cb44-5" d__=""><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">short</span> sem_op<span class="op" d__="">;</span></span>
<span id="cb44-6" d__=""><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt" d__="">short</span> sem_flg<span class="op" d__="">;</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">};</span></span></code></pre></div>
<p d__="">Of course, <code s__="13">sem_num</code> is the number of the semaphore in the set that you want to manipulate. Then, <code s__="13">sem_op</code> is what you want to do with that semaphore. This takes on different meanings, depending on whether <code s__="13">sem_op</code> is positive, negative, or zero, as shown in the following table:</p>
<table>
<colgroup>
<col style="width: 11%">
<col style="width: 88%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;"><code s__="13" d__="">sem_op</code></th>
<th d__="">What happens</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;" d__="">Negative</td>
<td d__="">Allocate resources. Block the calling process until the value
 of the semaphore is greater than or equal to the absolute value of <code s__="13">sem_op</code>.
 (That is, wait until enough resources have been freed by other 
processes for this one to allocate.) Then add (effectively subtract, 
since it’s negative) the value of <code s__="13">sem_op</code> to the semaphore’s value.</td>
</tr>
<tr class="even">
<td style="text-align: center;" d__="">Positive</td>
<td d__="">Release resources. The value of <code s__="13">sem_op</code> is added to the semaphore’s value.</td>
</tr>
<tr class="odd">
<td style="text-align: center;" d__="">Zero</td>
<td d__="">This process will wait until the semaphore in question reaches 0.</td>
</tr>
</tbody>
</table>
<p d__="">So, basically, what you do is load up a <code s__="13">struct sembuf</code> with whatever values you want, then call <code s__="13">semop()</code>, like this:</p>
<!-- BOOKMARK -->
<div class="sourceCode" id="cb45"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb45-1" d__=""><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> semop<span class="op" d__="">(</span><span class="dt" d__="">int</span> semid<span class="op" d__="">,</span> <span class="kw" d__="">struct</span> sembuf <span class="op" d__="">*</span>sops<span class="op" d__="">,</span></span>
<span id="cb45-2" d__=""><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>          <span class="dt" d__="">unsigned</span> <span class="dt" d__="">int</span> nsops<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">The <code s__="13">semid</code> argument is the number obtained from the call to <code s__="13">semget()</code>. Next is <code s__="13">sops</code>, which is a pointer to the <code s__="13">struct sembuf</code> that you filled with your semaphore commands. If you want, though, you can make an array of <code s__="13">struct sembuf</code>s in order to do a whole bunch of semaphore operations at the same time. The way <code s__="13">semop()</code> knows that you’re doing this is the <code s__="13">nsop</code> argument, which tells how many <code s__="13">struct sembuf</code>s you’re sending it. If you only have one, well, put <code s__="13">1</code> as this argument.</p>
<p d__="">One field in the <code s__="13">struct sembuf</code> that I haven’t mentioned is the <code s__="13">sem_flg</code> field which allows the program to specify flags to further modify the effects of the <code s__="13">semop()</code> call.</p>
<p d__="">One of these flags is <code s__="13">IPC_NOWAIT</code> which, as the name suggests, causes the call to <code s__="13">semop()</code> to return with error <code s__="13">EAGAIN</code>
 if it encounters a situation where it would normally block. This is 
good for situations where you might want to “poll” to see if you can 
allocate a resource.</p>
<p d__="">Another very useful flag is the <code s__="13">SEM_UNDO</code> flag. This causes <code s__="13">semop()</code>
 to record, in a way, the change made to the semaphore. When the program
 exits, the kernel will automatically undo all changes that were marked 
with the <code s__="13">SEM_UNDO</code> flag. Of course, your program 
should do its best to deallocate any resources it marks using the 
semaphore, but sometimes this isn’t possible when your program gets a <code s__="13">SIGKILL</code> or some other awful crash happens.</p>
<!-- ======================================================= -->
<!-- Destroying a semaphore -->
<!-- ======================================================= -->
<h2 data-number="8.4" id="destroying-a-semaphore" d__=""><span class="header-section-number">8.4</span> Destroying a semaphore</h2>
<p d__="">There are two ways to get rid of a semaphore: one is to use the Unix command <code s__="13">ipcrm</code>. The other is through a call to <code s__="13">semctl()</code> with the <code s__="13">cmd</code> set to <code s__="13">IPC_RMID</code>.</p>
<p d__="">Basically, you want to call <code s__="13">semctl()</code> and set <code s__="13">semid</code> to the semaphore ID you want to axe. The <code s__="13">cmd</code> should be set to <code s__="13">IPC_RMID</code>, which tells <code s__="13">semctl()</code> to remove this semaphore set. The parameter <code s__="13">semnum</code> has no meaning in the <code s__="13">IPC_RMID</code> context and can just be set to zero.</p>
<p d__="">Here’s an example call to torch a semaphore set:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb46-1" d__=""><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> semid<span class="op" d__="">;</span> </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">.</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">.</span></span>
<span id="cb46-4" d__=""><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>semid <span class="op" d__="">=</span> semget<span class="op" d__="">(...);</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">.</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">.</span></span>
<span id="cb46-7" d__=""><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>semctl<span class="op" d__="">(</span>semid<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span> IPC_RMID<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">Easy peasy.</p>
<!-- ======================================================= -->
<!-- Semaphore: Sample Programs -->
<!-- ======================================================= -->
<h2 data-number="8.5" id="sample-programs" d__=""><span class="header-section-number">8.5</span> Sample Programs</h2>
<p d__="">There are two of them. The first, <code s__="13">semdemo.c</code>, creates the semaphore if necessary, and performs some pretend file locking on it in a demo very much like that in the <a href="#flocking" d__="">File Locking</a> document. The second program, <code s__="13">semrm.c</code> is used to destroy the semaphore (again, <code s__="13">ipcrm</code> could be used to accomplish this.)</p>
<p d__="">The idea is to run run <code s__="13">semdemo.c</code> in a few windows and see how all the processes interact. When you’re done, use <code s__="13">semrm.c</code> to remove the semaphore. You could also try removing the semaphore while running <code s__="13">semdemo.c</code> just to see what kinds of errors are generated.</p>
<p d__="">Here’s <a href="https://beej.us/guide/bgipc/source/examples/semdemo.c"><code s__="13" d__="">semdemo.c</code></a><a href="#fn35" class="footnote-ref" id="fnref35" role="doc-noteref"><sup s__="13" d__="">35</sup></a>, including a function named <code s__="13">initsem()</code> that gets around the semaphore race conditions, Stevens-style:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb47-1"><a href="#cb47-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb47-2"><a href="#cb47-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb47-3"><a href="#cb47-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb47-4"><a href="#cb47-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb47-5"><a href="#cb47-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/ipc.h&gt;</span></span>
<span id="cb47-6"><a href="#cb47-6"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/sem.h&gt;</span></span>
<span id="cb47-7"><a href="#cb47-7"></a></span>
<span id="cb47-8"><a href="#cb47-8"></a><span class="pp" d__="">#define MAX_RETRIES </span><span class="dv" d__="">10</span></span>
<span id="cb47-9"><a href="#cb47-9"></a></span>
<span id="cb47-10"><a href="#cb47-10"></a><span class="pp" d__="">#ifdef NEED_SEMUN</span></span>
<span id="cb47-11"><a href="#cb47-11"></a><span class="co" d__="">/* Defined in sys/sem.h as required by POSIX now */</span></span>
<span id="cb47-12" d__=""><a href="#cb47-12"></a><span class="kw" d__="">union</span> semun <span class="op" d__="">{</span></span>
<span id="cb47-13" d__=""><a href="#cb47-13"></a>    <span class="dt" d__="">int</span> val<span class="op" d__="">;</span></span>
<span id="cb47-14" d__=""><a href="#cb47-14"></a>    <span class="kw" d__="">struct</span> semid_ds <span class="op" d__="">*</span>buf<span class="op" d__="">;</span></span>
<span id="cb47-15" d__=""><a href="#cb47-15"></a>    ushort <span class="op" d__="">*</span>array<span class="op" d__="">;</span></span>
<span id="cb47-16"><a href="#cb47-16"></a><span class="op" d__="">};</span></span>
<span id="cb47-17"><a href="#cb47-17"></a><span class="pp" d__="">#endif</span></span>
<span id="cb47-18"><a href="#cb47-18"></a></span>
<span id="cb47-19"><a href="#cb47-19"></a><span class="co" d__="">/*</span></span>
<span id="cb47-20"><a href="#cb47-20"></a><span class="co" d__="">** initsem() -- more-than-inspired by W. Richard Stevens' UNIX Network</span></span>
<span id="cb47-21"><a href="#cb47-21"></a><span class="co" d__="">** Programming 2nd edition, volume 2, lockvsem.c, page 295.</span></span>
<span id="cb47-22"><a href="#cb47-22"></a><span class="co" d__="">*/</span></span>
<span id="cb47-23" d__=""><a href="#cb47-23"></a><span class="dt" d__="">int</span> initsem<span class="op" d__="">(</span>key_t key<span class="op" d__="">,</span> <span class="dt" d__="">int</span> nsems<span class="op" d__="">)</span>  <span class="co" d__="">/* key from ftok() */</span></span>
<span id="cb47-24"><a href="#cb47-24"></a><span class="op" d__="">{</span></span>
<span id="cb47-25" d__=""><a href="#cb47-25"></a>    <span class="dt" d__="">int</span> i<span class="op" d__="">;</span></span>
<span id="cb47-26" d__=""><a href="#cb47-26"></a>    <span class="kw" d__="">union</span> semun arg<span class="op" d__="">;</span></span>
<span id="cb47-27" d__=""><a href="#cb47-27"></a>    <span class="kw" d__="">struct</span> semid_ds buf<span class="op" d__="">;</span></span>
<span id="cb47-28" d__=""><a href="#cb47-28"></a>    <span class="kw" d__="">struct</span> sembuf sb<span class="op" d__="">;</span></span>
<span id="cb47-29" d__=""><a href="#cb47-29"></a>    <span class="dt" d__="">int</span> semid<span class="op" d__="">;</span></span>
<span id="cb47-30"><a href="#cb47-30"></a></span>
<span id="cb47-31" d__=""><a href="#cb47-31"></a>    semid <span class="op" d__="">=</span> semget<span class="op" d__="">(</span>key<span class="op" d__="">,</span> nsems<span class="op" d__="">,</span> IPC_CREAT <span class="op" d__="">|</span> IPC_EXCL <span class="op" d__="">|</span> <span class="bn" d__="">0666</span><span class="op" d__="">);</span></span>
<span id="cb47-32"><a href="#cb47-32"></a></span>
<span id="cb47-33" d__=""><a href="#cb47-33"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>semid <span class="op" d__="">&gt;=</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> <span class="op" d__="">{</span> <span class="co" d__="">/* we got it first */</span></span>
<span id="cb47-34" d__=""><a href="#cb47-34"></a>            sb<span class="op" d__="">.</span>sem_op <span class="op" d__="">=</span> <span class="dv" d__="">1</span><span class="op" d__="">;</span> sb<span class="op" d__="">.</span>sem_flg <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb47-35" d__=""><a href="#cb47-35"></a>            arg<span class="op" d__="">.</span>val <span class="op" d__="">=</span> <span class="dv" d__="">1</span><span class="op" d__="">;</span></span>
<span id="cb47-36"><a href="#cb47-36"></a></span>
<span id="cb47-37" d__=""><a href="#cb47-37"></a>            printf<span class="op" d__="">(</span><span class="st" d__="">"press return</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span> getchar<span class="op" d__="">();</span></span>
<span id="cb47-38"><a href="#cb47-38"></a></span>
<span id="cb47-39" d__=""><a href="#cb47-39"></a>            <span class="cf" d__="">for</span><span class="op" d__="">(</span>sb<span class="op" d__="">.</span>sem_num <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span> sb<span class="op" d__="">.</span>sem_num <span class="op" d__="">&lt;</span> nsems<span class="op" d__="">;</span> sb<span class="op" d__="">.</span>sem_num<span class="op" d__="">++)</span> <span class="op" d__="">{</span> </span>
<span id="cb47-40"><a href="#cb47-40"></a>                    <span class="co" d__="">/* do a semop() to "free" the semaphores. */</span></span>
<span id="cb47-41"><a href="#cb47-41"></a>                    <span class="co" d__="">/* this sets the sem_otime field, as needed below. */</span></span>
<span id="cb47-42" d__=""><a href="#cb47-42"></a>                    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>semop<span class="op" d__="">(</span>semid<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>sb<span class="op" d__="">,</span> <span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb47-43" d__=""><a href="#cb47-43"></a>                            <span class="dt" d__="">int</span> e <span class="op" d__="">=</span> errno<span class="op" d__="">;</span></span>
<span id="cb47-44" d__=""><a href="#cb47-44"></a>                            semctl<span class="op" d__="">(</span>semid<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span> IPC_RMID<span class="op" d__="">);</span> <span class="co" d__="">/* clean up */</span></span>
<span id="cb47-45" d__=""><a href="#cb47-45"></a>                            errno <span class="op" d__="">=</span> e<span class="op" d__="">;</span></span>
<span id="cb47-46"><a href="#cb47-46"></a>                            <span class="cf" d__="">return</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">;</span> <span class="co" d__="">/* error, check errno */</span></span>
<span id="cb47-47"><a href="#cb47-47"></a>                    <span class="op" d__="">}</span></span>
<span id="cb47-48"><a href="#cb47-48"></a>            <span class="op" d__="">}</span></span>
<span id="cb47-49"><a href="#cb47-49"></a></span>
<span id="cb47-50" d__=""><a href="#cb47-50"></a>    <span class="op" d__="">}</span> <span class="cf" d__="">else</span> <span class="cf" d__="">if</span> <span class="op" d__="">(</span>errno <span class="op" d__="">==</span> EEXIST<span class="op" d__="">)</span> <span class="op" d__="">{</span> <span class="co" d__="">/* someone else got it first */</span></span>
<span id="cb47-51" d__=""><a href="#cb47-51"></a>            <span class="dt" d__="">int</span> ready <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb47-52"><a href="#cb47-52"></a></span>
<span id="cb47-53" d__=""><a href="#cb47-53"></a>            semid <span class="op" d__="">=</span> semget<span class="op" d__="">(</span>key<span class="op" d__="">,</span> nsems<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span> <span class="co" d__="">/* get the id */</span></span>
<span id="cb47-54" d__=""><a href="#cb47-54"></a>            <span class="cf" d__="">if</span> <span class="op" d__="">(</span>semid <span class="op" d__="">&lt;</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> <span class="cf" d__="">return</span> semid<span class="op" d__="">;</span> <span class="co" d__="">/* error, check errno */</span></span>
<span id="cb47-55"><a href="#cb47-55"></a></span>
<span id="cb47-56"><a href="#cb47-56"></a>            <span class="co" d__="">/* wait for other process to initialize the semaphore: */</span></span>
<span id="cb47-57" d__=""><a href="#cb47-57"></a>            arg<span class="op" d__="">.</span>buf <span class="op" d__="">=</span> <span class="op" d__="">&amp;</span>buf<span class="op" d__="">;</span></span>
<span id="cb47-58" d__=""><a href="#cb47-58"></a>            <span class="cf" d__="">for</span><span class="op" d__="">(</span>i <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span> i <span class="op" d__="">&lt;</span> MAX_RETRIES <span class="op" d__="">&amp;&amp;</span> <span class="op" d__="">!</span>ready<span class="op" d__="">;</span> i<span class="op" d__="">++)</span> <span class="op" d__="">{</span></span>
<span id="cb47-59" d__=""><a href="#cb47-59"></a>                    semctl<span class="op" d__="">(</span>semid<span class="op" d__="">,</span> nsems<span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">,</span> IPC_STAT<span class="op" d__="">,</span> arg<span class="op" d__="">);</span></span>
<span id="cb47-60" d__=""><a href="#cb47-60"></a>                    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>arg<span class="op" d__="">.</span>buf<span class="op" d__="">-&gt;</span>sem_otime <span class="op" d__="">!=</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb47-61" d__=""><a href="#cb47-61"></a>                            ready <span class="op" d__="">=</span> <span class="dv" d__="">1</span><span class="op" d__="">;</span></span>
<span id="cb47-62"><a href="#cb47-62"></a>                    <span class="op" d__="">}</span> <span class="cf" d__="">else</span> <span class="op" d__="">{</span></span>
<span id="cb47-63" d__=""><a href="#cb47-63"></a>                            sleep<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb47-64"><a href="#cb47-64"></a>                    <span class="op" d__="">}</span></span>
<span id="cb47-65"><a href="#cb47-65"></a>            <span class="op" d__="">}</span></span>
<span id="cb47-66" d__=""><a href="#cb47-66"></a>            <span class="cf" d__="">if</span> <span class="op" d__="">(!</span>ready<span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb47-67" d__=""><a href="#cb47-67"></a>                    errno <span class="op" d__="">=</span> ETIME<span class="op" d__="">;</span></span>
<span id="cb47-68"><a href="#cb47-68"></a>                    <span class="cf" d__="">return</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">;</span></span>
<span id="cb47-69"><a href="#cb47-69"></a>            <span class="op" d__="">}</span></span>
<span id="cb47-70"><a href="#cb47-70"></a>    <span class="op" d__="">}</span> <span class="cf" d__="">else</span> <span class="op" d__="">{</span></span>
<span id="cb47-71" d__=""><a href="#cb47-71"></a>            <span class="cf" d__="">return</span> semid<span class="op" d__="">;</span> <span class="co" d__="">/* error, check errno */</span></span>
<span id="cb47-72"><a href="#cb47-72"></a>    <span class="op" d__="">}</span></span>
<span id="cb47-73"><a href="#cb47-73"></a></span>
<span id="cb47-74" d__=""><a href="#cb47-74"></a>    <span class="cf" d__="">return</span> semid<span class="op" d__="">;</span></span>
<span id="cb47-75"><a href="#cb47-75"></a><span class="op" d__="">}</span></span>
<span id="cb47-76"><a href="#cb47-76"></a></span>
<span id="cb47-77" d__=""><a href="#cb47-77"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb47-78"><a href="#cb47-78"></a><span class="op" d__="">{</span></span>
<span id="cb47-79" d__=""><a href="#cb47-79"></a>    key_t key<span class="op" d__="">;</span></span>
<span id="cb47-80" d__=""><a href="#cb47-80"></a>    <span class="dt" d__="">int</span> semid<span class="op" d__="">;</span></span>
<span id="cb47-81" d__=""><a href="#cb47-81"></a>    <span class="kw" d__="">struct</span> sembuf sb<span class="op" d__="">;</span></span>
<span id="cb47-82"><a href="#cb47-82"></a>    </span>
<span id="cb47-83" d__=""><a href="#cb47-83"></a>    sb<span class="op" d__="">.</span>sem_num <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb47-84" d__=""><a href="#cb47-84"></a>    sb<span class="op" d__="">.</span>sem_op <span class="op" d__="">=</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">;</span>  <span class="co" d__="">/* set to allocate resource */</span></span>
<span id="cb47-85" d__=""><a href="#cb47-85"></a>    sb<span class="op" d__="">.</span>sem_flg <span class="op" d__="">=</span> SEM_UNDO<span class="op" d__="">;</span></span>
<span id="cb47-86"><a href="#cb47-86"></a></span>
<span id="cb47-87" d__=""><a href="#cb47-87"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>key <span class="op" d__="">=</span> ftok<span class="op" d__="">(</span><span class="st" d__="">"semdemo.c"</span><span class="op" d__="">,</span> <span class="ch" d__="">'J'</span><span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb47-88" d__=""><a href="#cb47-88"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"ftok"</span><span class="op" d__="">);</span></span>
<span id="cb47-89" d__=""><a href="#cb47-89"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb47-90"><a href="#cb47-90"></a>    <span class="op" d__="">}</span></span>
<span id="cb47-91"><a href="#cb47-91"></a></span>
<span id="cb47-92"><a href="#cb47-92"></a>    <span class="co" d__="">/* grab the semaphore set created by seminit.c: */</span></span>
<span id="cb47-93" d__=""><a href="#cb47-93"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>semid <span class="op" d__="">=</span> initsem<span class="op" d__="">(</span>key<span class="op" d__="">,</span> <span class="dv" d__="">1</span><span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb47-94" d__=""><a href="#cb47-94"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"initsem"</span><span class="op" d__="">);</span></span>
<span id="cb47-95" d__=""><a href="#cb47-95"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb47-96"><a href="#cb47-96"></a>    <span class="op" d__="">}</span></span>
<span id="cb47-97"><a href="#cb47-97"></a></span>
<span id="cb47-98" d__=""><a href="#cb47-98"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Press return to lock: "</span><span class="op" d__="">);</span></span>
<span id="cb47-99" d__=""><a href="#cb47-99"></a>    getchar<span class="op" d__="">();</span></span>
<span id="cb47-100" d__=""><a href="#cb47-100"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Trying to lock...</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb47-101"><a href="#cb47-101"></a></span>
<span id="cb47-102" d__=""><a href="#cb47-102"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>semop<span class="op" d__="">(</span>semid<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>sb<span class="op" d__="">,</span> <span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb47-103" d__=""><a href="#cb47-103"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"semop"</span><span class="op" d__="">);</span></span>
<span id="cb47-104" d__=""><a href="#cb47-104"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb47-105"><a href="#cb47-105"></a>    <span class="op" d__="">}</span></span>
<span id="cb47-106"><a href="#cb47-106"></a></span>
<span id="cb47-107" d__=""><a href="#cb47-107"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Locked.</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb47-108" d__=""><a href="#cb47-108"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Press return to unlock: "</span><span class="op" d__="">);</span></span>
<span id="cb47-109" d__=""><a href="#cb47-109"></a>    getchar<span class="op" d__="">();</span></span>
<span id="cb47-110"><a href="#cb47-110"></a></span>
<span id="cb47-111" d__=""><a href="#cb47-111"></a>    sb<span class="op" d__="">.</span>sem_op <span class="op" d__="">=</span> <span class="dv" d__="">1</span><span class="op" d__="">;</span> <span class="co" d__="">/* free resource */</span></span>
<span id="cb47-112" d__=""><a href="#cb47-112"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>semop<span class="op" d__="">(</span>semid<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>sb<span class="op" d__="">,</span> <span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb47-113" d__=""><a href="#cb47-113"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"semop"</span><span class="op" d__="">);</span></span>
<span id="cb47-114" d__=""><a href="#cb47-114"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb47-115"><a href="#cb47-115"></a>    <span class="op" d__="">}</span></span>
<span id="cb47-116"><a href="#cb47-116"></a></span>
<span id="cb47-117" d__=""><a href="#cb47-117"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Unlocked</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb47-118"><a href="#cb47-118"></a></span>
<span id="cb47-119"><a href="#cb47-119"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb47-120"><a href="#cb47-120"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">Here’s <a href="https://beej.us/guide/bgipc/source/examples/semrm.c"><code s__="13" d__="">semrm.c</code></a><a href="#fn36" class="footnote-ref" id="fnref36" role="doc-noteref"><sup s__="13" d__="">36</sup></a> for removing the semaphore when you’re done:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb48-1"><a href="#cb48-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb48-2"><a href="#cb48-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb48-3"><a href="#cb48-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb48-4"><a href="#cb48-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/ipc.h&gt;</span></span>
<span id="cb48-5"><a href="#cb48-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/sem.h&gt;</span></span>
<span id="cb48-6"><a href="#cb48-6"></a></span>
<span id="cb48-7" d__=""><a href="#cb48-7"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb48-8"><a href="#cb48-8"></a><span class="op" d__="">{</span></span>
<span id="cb48-9" d__=""><a href="#cb48-9"></a>    key_t key<span class="op" d__="">;</span></span>
<span id="cb48-10" d__=""><a href="#cb48-10"></a>    <span class="dt" d__="">int</span> semid<span class="op" d__="">;</span></span>
<span id="cb48-11" d__=""><a href="#cb48-11"></a>    <span class="kw" d__="">union</span> semun arg<span class="op" d__="">;</span></span>
<span id="cb48-12"><a href="#cb48-12"></a></span>
<span id="cb48-13" d__=""><a href="#cb48-13"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>key <span class="op" d__="">=</span> ftok<span class="op" d__="">(</span><span class="st" d__="">"semdemo.c"</span><span class="op" d__="">,</span> <span class="ch" d__="">'J'</span><span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb48-14" d__=""><a href="#cb48-14"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"ftok"</span><span class="op" d__="">);</span></span>
<span id="cb48-15" d__=""><a href="#cb48-15"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb48-16"><a href="#cb48-16"></a>    <span class="op" d__="">}</span></span>
<span id="cb48-17"><a href="#cb48-17"></a></span>
<span id="cb48-18"><a href="#cb48-18"></a>    <span class="co" d__="">/* grab the semaphore set created by seminit.c: */</span></span>
<span id="cb48-19" d__=""><a href="#cb48-19"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>semid <span class="op" d__="">=</span> semget<span class="op" d__="">(</span>key<span class="op" d__="">,</span> <span class="dv" d__="">1</span><span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb48-20" d__=""><a href="#cb48-20"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"semget"</span><span class="op" d__="">);</span></span>
<span id="cb48-21" d__=""><a href="#cb48-21"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb48-22"><a href="#cb48-22"></a>    <span class="op" d__="">}</span></span>
<span id="cb48-23"><a href="#cb48-23"></a></span>
<span id="cb48-24"><a href="#cb48-24"></a>    <span class="co" d__="">/* remove it: */</span></span>
<span id="cb48-25" d__=""><a href="#cb48-25"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>semctl<span class="op" d__="">(</span>semid<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span> IPC_RMID<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb48-26" d__=""><a href="#cb48-26"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"semctl"</span><span class="op" d__="">);</span></span>
<span id="cb48-27" d__=""><a href="#cb48-27"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb48-28"><a href="#cb48-28"></a>    <span class="op" d__="">}</span></span>
<span id="cb48-29"><a href="#cb48-29"></a></span>
<span id="cb48-30"><a href="#cb48-30"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb48-31"><a href="#cb48-31"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">Isn’t that fun! I’m sure you’ll give up Quake<a href="#fn37" class="footnote-ref" id="fnref37" role="doc-noteref"><sup s__="13" d__="">37</sup></a> just to play with this semaphore stuff all day long!</p>
<!-- ======================================================= -->
<!-- Semaphore summary -->
<!-- ======================================================= -->
<h2 data-number="8.6" id="summary-4" d__=""><span class="header-section-number">8.6</span> Summary</h2>
<p d__="">I might have understated the usefulness of semaphores. I 
assure you, they’re very very very useful in a concurrency situation. 
They’re often faster than regular file locks, too. Also, you can use 
them on other things that aren’t files, such as <a href="#shm" d__="">Shared Memory Segments</a>! In fact, it is sometimes hard to live without them, quite frankly.</p>
<p d__="">Whenever you have multiple processes running through a 
critical section of code, man, you need semaphores. You have zillions of
 them—you might as well use ’em.</p>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- ======================================================= -->
<!-- Shared Memory Segments -->
<!-- ======================================================= -->
<h1 data-number="9" id="shm" d__=""><span class="header-section-number">9</span> Shared Memory Segments</h1>
<p d__="">The cool thing about shared memory segments is that they are 
what they sound like: a segment of memory that is shared between 
processes. I mean, think of the potential of this! You could allocate a 
block of player information for a multi-player game and have each 
process access it at will! Fun, fun, fun. (Of course, memory-mapped 
files accomplish the same thing and have the added advantage of 
persistence, albeit with the same caveats that apply to shared memory.)</p>
<p d__="">There are, as usual, more gotchas to watch out for, but it’s 
all pretty easy in the long run. See, you just connect to the shared 
memory segment, and get a pointer to the memory. You can read and write 
to this pointer and all changes you make will be visible to everyone 
else connected to the segment. There is nothing simpler. Well, there is,
 actually, but I was just trying to make you more comfortable.</p>
<h2 data-number="9.1" id="creating-the-segment-and-connecting" d__=""><span class="header-section-number">9.1</span> Creating the segment and connecting</h2>
<p d__="">Similarly to other forms of System V IPC, a shared memory segment is created and connected to via the <code s__="13">shmget()</code> call:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb49-1" d__=""><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> shmget<span class="op" d__="">(</span>key_t key<span class="op" d__="">,</span> <span class="dt" d__="">size_t</span> size<span class="op" d__="">,</span> <span class="dt" d__="">int</span> shmflg<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">Upon successful completion, <code s__="13">shmget()</code> returns an identifier for the shared memory segment. The <code s__="13">key</code> argument should be created the same was as shown in the <a href="#mqftok" d__="">Message Queues</a> document, using <code s__="13">ftok()</code>. The next argument, <code s__="13">size</code>, is the size in bytes of the shared memory segment. Finally, the <code s__="13">shmflg</code> should be set to the permissions of the segment bitwise-OR’d with <code s__="13">IPC_CREAT</code> if you want to create the segment, but can be <code s__="13">0</code> otherwise. (It doesn’t hurt to specify <code s__="13">IPC_CREAT</code> every time—it will simply connect you if the segment already exists.)</p>
<p d__="">Here’s an example call that creates a 1K segment with <code s__="13">644</code> permissions (<code s__="13">rw-r--r--</code>):</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb50-1" d__=""><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>key_t key<span class="op" d__="">;</span></span>
<span id="cb50-2" d__=""><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> shmid<span class="op" d__="">;</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4" d__=""><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>key <span class="op" d__="">=</span> ftok<span class="op" d__="">(</span><span class="st" d__="">"/home/beej/somefile3"</span><span class="op" d__="">,</span> <span class="ch" d__="">'R'</span><span class="op" d__="">);</span></span>
<span id="cb50-5" d__=""><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>shmid <span class="op" d__="">=</span> shmget<span class="op" d__="">(</span>key<span class="op" d__="">,</span> <span class="dv" d__="">1024</span><span class="op" d__="">,</span> <span class="bn" d__="">0644</span> <span class="op" d__="">|</span> IPC_CREAT<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">(It may not be possible to actually create a 1K segment, as 
the operating system is allowed to increase the size to fit any internal
 constraints it may have. For example, on a system with 4K virtual 
pages, it’s likely the size will be increased to 4K. Of course, your 
program won’t know or care; this is just an implementation detail.)</p>
<p d__="">But how do you get a pointer to that data from the <code s__="13">shmid</code> handle? The answer is in the call <code s__="13">shmat()</code>, in the following section.</p>
<h2 data-number="9.2" id="attach-megetting-a-pointer-to-the-segment" d__=""><span class="header-section-number">9.2</span> Attach me—getting a pointer to the segment</h2>
<p d__="">Before you can use a shared memory segment, you have to attach yourself to it using the <code s__="13">shmat()</code> call:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb51-1" d__=""><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">void</span> <span class="op" d__="">*</span>shmat<span class="op" d__="">(</span><span class="dt" d__="">int</span> `shmid`<span class="op" d__="">,</span> <span class="dt" d__="">void</span> <span class="op" d__="">*</span>`shmaddr`<span class="op" d__="">,</span> <span class="dt" d__="">int</span> `shmflg`<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">What does it all mean? Well, <code s__="13">shmid</code> is the shared memory ID you got from the call to <code s__="13">shmget()</code>. Next is <code s__="13">shmaddr</code>, which you can use to tell <code s__="13">shmat()</code> which specific address to use but you should just set it to <code s__="13">0</code> and let the OS choose the address for you. Finally, the <code s__="13">shmflg</code> can be set to <code s__="13">SHM_RDONLY</code> if you only want to read from it, <code s__="13">0</code> otherwise. (Check the man pages for other useful flags that can be included.)</p>
<p d__="">Here’s a more complete example of how to get a pointer to a shared memory segment:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb52-1" d__=""><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>key_t key<span class="op" d__="">;</span></span>
<span id="cb52-2" d__=""><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> shmid<span class="op" d__="">;</span></span>
<span id="cb52-3" d__=""><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">char</span> <span class="op" d__="">*</span>data<span class="op" d__="">;</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5" d__=""><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>key <span class="op" d__="">=</span> ftok<span class="op" d__="">(</span><span class="st" d__="">"/home/beej/somefile3"</span><span class="op" d__="">,</span> <span class="ch" d__="">'R'</span><span class="op" d__="">);</span></span>
<span id="cb52-6" d__=""><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>shmid <span class="op" d__="">=</span> shmget<span class="op" d__="">(</span>key<span class="op" d__="">,</span> <span class="dv" d__="">1024</span><span class="op" d__="">,</span> <span class="bn" d__="">0644</span> <span class="op" d__="">|</span> IPC_CREAT<span class="op" d__="">);</span></span>
<span id="cb52-7" d__=""><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>data <span class="op" d__="">=</span> shmat<span class="op" d__="">(</span>shmid<span class="op" d__="">,</span> <span class="op" d__="">(</span><span class="dt" d__="">void</span> <span class="op" d__="">*)</span><span class="dv" d__="">0</span><span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span></code></pre></div>
<p d__="">And <em>bammo</em>! You have the pointer to the shared memory segment! Notice that <code s__="13">shmat()</code> returns a <code s__="13">void</code> pointer, and we’re treating it, in this case, as a <code s__="13">char</code>
 pointer. You can treat it as anything you like, depending on what kind 
of data you have in there. Pointers to arrays of structures are just as 
acceptable as anything else.</p>
<p d__="">Also, it’s interesting to note that <code s__="13">shmat()</code> returns <code s__="13">-1</code> on failure (as does <code s__="13">mmap()</code>). But how do you get <code s__="13">-1</code> in a <code s__="13">void</code> pointer? Just do a cast during the comparison to check for errors:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb53-1" d__=""><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>data <span class="op" d__="">=</span> shmat<span class="op" d__="">(</span>shmid<span class="op" d__="">,</span> <span class="op" d__="">(</span><span class="dt" d__="">void</span> <span class="op" d__="">*)</span><span class="dv" d__="">0</span><span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span>
<span id="cb53-2" d__=""><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">if</span> <span class="op" d__="">(</span>data <span class="op" d__="">==</span> MAP_FAILED<span class="op" d__="">)</span></span>
<span id="cb53-3" d__=""><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    perror<span class="op" d__="">(</span><span class="st" d__="">"shmat"</span><span class="op" d__="">);</span></span></code></pre></div>
<p d__="">(It’s important to note that the integer is being cast to a 
pointer, and not the pointer return value being cast to an integer. It’s
 a subtle difference, but the latter is not always portable between 
architectures. Also note that the cast is to <code s__="13">void*</code> and not <code s__="13">char*</code>, as you might expect. Since the language guarantees that implicit casts from <code s__="13">void*</code> to any other kind of pointer are always safe and reliable, it’s better to use <code s__="13">void*</code> and let the compiler to the work.)</p>
<p d__="">All you have to do now is change the data it points to normal pointer-style. There are some samples in the next section.</p>
<h2 data-number="9.3" id="reading-and-writing" d__=""><span class="header-section-number">9.3</span> Reading and Writing</h2>
<p d__="">Lets say you have the <code s__="13">data</code> pointer from the above example. It is a <code s__="13">char</code>
 pointer, so we’ll be reading and writing chars from it. Furthermore, 
for the sake of simplicity, lets say the 1K shared memory segment 
contains a null-terminated string.</p>
<p d__="">It couldn’t be easier. Since it’s just a string in there, we can print it like this:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb54-1" d__=""><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>printf<span class="op" d__="">(</span><span class="st" d__="">"shared contents: </span><span class="sc" d__="">%s\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> data<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">And we could store something in it as easily as this:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb55-1" d__=""><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>printf<span class="op" d__="">(</span><span class="st" d__="">"Enter a string: "</span><span class="op" d__="">);</span></span>
<span id="cb55-2" d__=""><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>fgets<span class="op" d__="">(</span>data<span class="op" d__="">,</span> <span class="dv" d__="">1024</span><span class="op" d__="">,</span> stdin<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">Of course, like I said earlier, you can have other data in there besides just <code s__="13">char</code>s.
 I’m just using them as an example. I’ll just make the assumption that 
you’re familiar enough with pointers in C that you’ll be able to deal 
with whatever kind of data you stick in there.</p>
<h2 data-number="9.4" id="detaching-from-and-deleting-segments" d__=""><span class="header-section-number">9.4</span> Detaching from and deleting segments</h2>
<p d__="">When you’re done with the shared memory segment, your program should detach itself from it using the <code s__="13">shmdt()</code> call (if you don’t, this will happen automatically when the process terminates):</p>
<p><code s__="13" d__="">{.c{ int shmdt(void *`shmaddr`);</code></p>
<p d__="">The only argument, <code s__="13">shmaddr</code>, is the address you got from <code s__="13">shmat()</code>. The function returns <code s__="13">-1</code> on error, <code s__="13">0</code> on success.</p>
<p d__="">When you detach from the segment, it isn’t destroyed. Nor is it removed when <em>everyone</em> detaches from it. You have to specifically destroy it using a call to <code s__="13">shmctl()</code>, similar to the control calls for the other System V IPC functions:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb56-1" d__=""><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>shmctl<span class="op" d__="">(</span>shmid<span class="op" d__="">,</span> IPC_RMID<span class="op" d__="">,</span> NULL<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">The above call deletes the shared memory segment, assuming no one else is attached to it. The <code s__="13">shmctl()</code>
 function does a lot more than this, though, and is worth looking into. 
(On your own, of course, since this is only an overview!)</p>
<p d__="">As always, you can destroy the shared memory segment from the command line using the <code s__="13">ipcrm</code>
 Unix command. Also, be sure that you don’t leave any unused shared 
memory segments sitting around wasting system resources. All the System V
 IPC objects you own can be viewed using the <code s__="13">ipcs</code> command.</p>
<h2 data-number="9.5" id="shmcon" d__=""><span class="header-section-number">9.5</span> Concurrency</h2>
<p d__="">What are concurrency issues? Well, since you have multiple 
processes modifying the shared memory segment, it is possible that 
certain errors could crop up when updates to the segment occur 
simultaneously. This <em>concurrent</em> access is almost always a problem when you have multiple writers to a shared object.</p>
<p d__="">The way to get around this is to use <a href="#semaphores" d__="">Semaphores</a>
 to lock the shared memory segment while a process is writing to it. 
(Sometimes the lock will encompass both a read and write to the shared 
memory, depending on what you’re doing.)</p>
<p d__="">A true discussion of concurrency is beyond the scope of this paper, and you might want to check out the <a href="https://en.wikipedia.org/wiki/Concurrency" d__="">Wikipedia article on the matter</a><a href="#fn38" class="footnote-ref" id="fnref38" role="doc-noteref"><sup s__="13" d__="">38</sup></a>.
 I’ll just leave it with this: if you start getting weird 
inconsistencies in your shared data when you connect two or more 
processes to it, you could very well have a concurrency problem.</p>
<h2 data-number="9.6" id="sample-code" d__=""><span class="header-section-number">9.6</span> Sample code</h2>
<p d__="">Now that I’ve primed you on all the dangers of concurrent 
access to a shared memory segment without using semaphores, I’ll show 
you a demo that does just that. Since this isn’t a mission-critical 
application, and it’s unlikely that you’ll be accessing the shared data 
at the same time as any other process, I’ll just leave the semaphores 
out for the sake of simplicity.</p>
<p d__="">This program does one of two things: if you run it with no 
command line parameters, it prints the contents of the shared memory 
segment. If you give it one command line parameter, it stores that 
parameter in the shared memory segment.</p>
<p d__="">Here’s the code for <a href="https://beej.us/guide/bgipc/source/examples/shmdemo.c"><code s__="13" d__="">shmdemo.c</code></a><a href="#fn39" class="footnote-ref" id="fnref39" role="doc-noteref"><sup s__="13" d__="">39</sup></a>:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb57-1"><a href="#cb57-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb57-2"><a href="#cb57-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb57-3"><a href="#cb57-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;string.h&gt;</span></span>
<span id="cb57-4"><a href="#cb57-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb57-5"><a href="#cb57-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/ipc.h&gt;</span></span>
<span id="cb57-6"><a href="#cb57-6"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/shm.h&gt;</span></span>
<span id="cb57-7"><a href="#cb57-7"></a></span>
<span id="cb57-8"><a href="#cb57-8"></a><span class="pp" d__="">#define SHM_SIZE </span><span class="dv" d__="">1024</span><span class="pp">  </span><span class="co" d__="">/* make it a 1K shared memory segment */</span></span>
<span id="cb57-9"><a href="#cb57-9"></a></span>
<span id="cb57-10" d__=""><a href="#cb57-10"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">int</span> argc<span class="op" d__="">,</span> <span class="dt" d__="">char</span> <span class="op" d__="">*</span>argv<span class="op" d__="">[])</span></span>
<span id="cb57-11"><a href="#cb57-11"></a><span class="op" d__="">{</span></span>
<span id="cb57-12" d__=""><a href="#cb57-12"></a>    key_t key<span class="op" d__="">;</span></span>
<span id="cb57-13" d__=""><a href="#cb57-13"></a>    <span class="dt" d__="">int</span> shmid<span class="op" d__="">;</span></span>
<span id="cb57-14" d__=""><a href="#cb57-14"></a>    <span class="dt" d__="">char</span> <span class="op" d__="">*</span>data<span class="op" d__="">;</span></span>
<span id="cb57-15" d__=""><a href="#cb57-15"></a>    <span class="dt" d__="">int</span> mode<span class="op" d__="">;</span></span>
<span id="cb57-16"><a href="#cb57-16"></a></span>
<span id="cb57-17" d__=""><a href="#cb57-17"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>argc <span class="op" d__="">&gt;</span> <span class="dv" d__="">2</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb57-18" d__=""><a href="#cb57-18"></a>            fprintf<span class="op" d__="">(</span>stderr<span class="op" d__="">,</span> <span class="st" d__="">"usage: shmdemo [data_to_write]</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb57-19" d__=""><a href="#cb57-19"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb57-20"><a href="#cb57-20"></a>    <span class="op" d__="">}</span></span>
<span id="cb57-21"><a href="#cb57-21"></a></span>
<span id="cb57-22"><a href="#cb57-22"></a>    <span class="co" d__="">/* make the key: */</span></span>
<span id="cb57-23" d__=""><a href="#cb57-23"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>key <span class="op" d__="">=</span> ftok<span class="op" d__="">(</span><span class="st" d__="">"shmdemo.c"</span><span class="op" d__="">,</span> <span class="ch" d__="">'R'</span><span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb57-24" d__=""><a href="#cb57-24"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"ftok"</span><span class="op" d__="">);</span></span>
<span id="cb57-25" d__=""><a href="#cb57-25"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb57-26"><a href="#cb57-26"></a>    <span class="op" d__="">}</span></span>
<span id="cb57-27"><a href="#cb57-27"></a></span>
<span id="cb57-28"><a href="#cb57-28"></a>    <span class="co" d__="">/* connect to (and possibly create) the segment: */</span></span>
<span id="cb57-29" d__=""><a href="#cb57-29"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>shmid <span class="op" d__="">=</span> shmget<span class="op" d__="">(</span>key<span class="op" d__="">,</span> SHM_SIZE<span class="op" d__="">,</span> <span class="bn" d__="">0644</span> <span class="op" d__="">|</span> IPC_CREAT<span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb57-30" d__=""><a href="#cb57-30"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"shmget"</span><span class="op" d__="">);</span></span>
<span id="cb57-31" d__=""><a href="#cb57-31"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb57-32"><a href="#cb57-32"></a>    <span class="op" d__="">}</span></span>
<span id="cb57-33"><a href="#cb57-33"></a></span>
<span id="cb57-34"><a href="#cb57-34"></a>    <span class="co" d__="">/* attach to the segment to get a pointer to it: */</span></span>
<span id="cb57-35" d__=""><a href="#cb57-35"></a>    data <span class="op" d__="">=</span> shmat<span class="op" d__="">(</span>shmid<span class="op" d__="">,</span> <span class="op" d__="">(</span><span class="dt" d__="">void</span> <span class="op" d__="">*)</span><span class="dv" d__="">0</span><span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span>
<span id="cb57-36"><a href="#cb57-36"></a></span>
<span id="cb57-37"><a href="#cb57-37"></a>    <span class="co" d__="">/* we _could_ use MAP_FAILED, but technically that's not */</span></span>
<span id="cb57-38"><a href="#cb57-38"></a>    <span class="co" d__="">/* the defined return value. System V failed on this one! */</span></span>
<span id="cb57-39" d__=""><a href="#cb57-39"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>data <span class="op" d__="">==</span> <span class="op" d__="">(</span><span class="dt" d__="">void</span> <span class="op" d__="">*)(-</span><span class="dv" d__="">1</span><span class="op" d__="">))</span> <span class="op" d__="">{</span></span>
<span id="cb57-40" d__=""><a href="#cb57-40"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"shmat"</span><span class="op" d__="">);</span></span>
<span id="cb57-41" d__=""><a href="#cb57-41"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb57-42"><a href="#cb57-42"></a>    <span class="op" d__="">}</span></span>
<span id="cb57-43"><a href="#cb57-43"></a></span>
<span id="cb57-44"><a href="#cb57-44"></a>    <span class="co" d__="">/* read or modify the segment, based on the command line: */</span></span>
<span id="cb57-45" d__=""><a href="#cb57-45"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>argc <span class="op" d__="">==</span> <span class="dv" d__="">2</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb57-46" d__=""><a href="#cb57-46"></a>            printf<span class="op" d__="">(</span><span class="st" d__="">"writing to segment: </span><span class="sc" d__="">\"%s\"\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> argv<span class="op" d__="">[</span><span class="dv" d__="">1</span><span class="op" d__="">]);</span></span>
<span id="cb57-47" d__=""><a href="#cb57-47"></a>            strncpy<span class="op" d__="">(</span>data<span class="op" d__="">,</span> argv<span class="op" d__="">[</span><span class="dv" d__="">1</span><span class="op" d__="">],</span> SHM_SIZE<span class="op" d__="">);</span></span>
<span id="cb57-48" d__=""><a href="#cb57-48"></a>            data<span class="op" d__="">[</span>SHM_SIZE<span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">]</span> <span class="op" d__="">=</span> <span class="ch" d__="">'</span><span class="sc" d__="">\0</span><span class="ch" d__="">'</span><span class="op" d__="">;</span></span>
<span id="cb57-49"><a href="#cb57-49"></a>    <span class="op" d__="">}</span> <span class="cf" d__="">else</span></span>
<span id="cb57-50" d__=""><a href="#cb57-50"></a>            printf<span class="op" d__="">(</span><span class="st" d__="">"segment contains: </span><span class="sc" d__="">\"%s\"\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> data<span class="op" d__="">);</span></span>
<span id="cb57-51"><a href="#cb57-51"></a></span>
<span id="cb57-52"><a href="#cb57-52"></a>    <span class="co" d__="">/* detach from the segment: */</span></span>
<span id="cb57-53" d__=""><a href="#cb57-53"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>shmdt<span class="op" d__="">(</span>data<span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb57-54" d__=""><a href="#cb57-54"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"shmdt"</span><span class="op" d__="">);</span></span>
<span id="cb57-55" d__=""><a href="#cb57-55"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb57-56"><a href="#cb57-56"></a>    <span class="op" d__="">}</span></span>
<span id="cb57-57"><a href="#cb57-57"></a></span>
<span id="cb57-58"><a href="#cb57-58"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb57-59"><a href="#cb57-59"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">More commonly, a process will attach to the segment and run 
for a bit while other programs are changing and reading the shared 
segment. It’s neat to watch one process update the segment and see the 
changes appear to other processes. Again, for simplicity, the sample 
code doesn’t do that, but you can see how the data is shared between 
independent processes.</p>
<p d__="">Also, there’s no code in here for removing the segment—be sure to do that when you’re done messing with it.</p>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- ======================================================= -->
<!-- Memory Mapped Files -->
<!-- ======================================================= -->
<h1 data-number="10" id="mmap" d__=""><span class="header-section-number">10</span> Memory Mapped Files</h1>
<p d__="">There comes a time when you want to read and write to and from
 files so that the information is shared between processes. Think of it 
this way: two processes both open the same file and both read and write 
from it, thus sharing the information. The problem is, sometimes it’s a 
pain to do all those <code s__="13">fseek()</code>s and stuff to get 
around. Wouldn’t it be easier if you could just map a section of the 
file to memory, and get a pointer to it? Then you could simply use 
pointer arithmetic to get (and set) data in the file.</p>
<p d__="">Well, this is exactly what a memory mapped file is. And it’s 
really easy to use, too. A few simple calls, mixed with a few simple 
rules, and you’re mapping like a mad-person.</p>
<h2 data-number="10.1" id="mapmake" d__=""><span class="header-section-number">10.1</span> Mapmake</h2>
<p d__="">Before mapping a file to memory, you need to get a file descriptor for it by using the <code s__="13">open()</code> system call:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb58-1" d__=""><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> fd<span class="op" d__="">;</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3" d__=""><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>fd <span class="op" d__="">=</span> open<span class="op" d__="">(</span><span class="st" d__="">"mapdemofile"</span><span class="op" d__="">,</span> O_RDWR<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">In this example, we’ve opened the file for read/write access. 
You can open it in whatever mode you want, but it has to match the mode 
specified in the <code s__="13">prot</code> parameter to the <code s__="13">mmap()</code> call, below.</p>
<p d__="">To memory map a file, you use the <code s__="13">mmap()</code> system call, which is defined as follows:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb59-1" d__=""><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">void</span> <span class="op" d__="">*</span>mmap<span class="op" d__="">(</span><span class="dt" d__="">void</span> <span class="op" d__="">*</span>addr<span class="op" d__="">,</span> <span class="dt" d__="">size_t</span> len<span class="op" d__="">,</span> <span class="dt" d__="">int</span> prot<span class="op" d__="">,</span></span>
<span id="cb59-2" d__=""><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>           <span class="dt" d__="">int</span> flags<span class="op" d__="">,</span> <span class="dt" d__="">int</span> fildes<span class="op" d__="">,</span> off_t off<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">What a slew of parameters! Here they are, one at a time:</p>
<table>
<colgroup>
<col style="width: 12%">
<col style="width: 87%">
</colgroup>
<thead>
<tr class="header">
<th d__="">Parameter</th>
<th d__="">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code s__="13" d__="">addr</code></td>
<td d__="">This is the address we want the file mapped into. The best way to use this is to set it to <code s__="13">NULL</code>
 and let the OS choose it for you. If you tell it to use an address the 
OS doesn’t like (for instance, if it’s not a multiple of the virtual 
memory page size), it’ll give you an error.</td>
</tr>
<tr class="even">
<td><code s__="13" d__="">len</code></td>
<td d__="">This parameter is the length of the data we want to map into memory. This can be any length you want. (Aside: if <code s__="13">len</code>
 not a multiple of the virtual memory page size, you will get a 
blocksize that is rounded up to that size. The extra bytes will be 0, 
and any changes you make to them will not modify the file.)</td>
</tr>
<tr class="odd">
<td><code s__="13" d__="">prot</code></td>
<td d__="">The “protection” argument allows you to specify what kind of 
access this process has to the memory mapped region. This can be a 
bitwise-ORd mixture of the following values: <code s__="13">PROT_READ</code>, <code s__="13">PROT_WRITE</code>, and <code s__="13">PROT_EXEC</code>,
 for read, write, and execute permissions, respectively. The value 
specified here must be equivalent to or a subset of the modes specified 
in the <code s__="13">open()</code> system call that is used to get the file descriptor.</td>
</tr>
<tr class="even">
<td><code s__="13" d__="">flags</code></td>
<td d__="">These are just miscellaneous flags that can be set for the system call. You’ll want to set it to <code s__="13">MAP_SHARED</code> if you’re planning to share your changes to the file with other processes, or <code s__="13">MAP_PRIVATE</code>
 otherwise. If you set it to the latter, your process will get a copy of
 the mapped region, so any changes you make to it will not be reflected 
in the original file—thus, other processes will not be able to see them.
 We won’t talk about <code s__="13">MAP_PRIVATE</code> here at all, since it doesn’t have much to do with IPC.</td>
</tr>
<tr class="odd">
<td><code s__="13" d__="">fildes</code></td>
<td d__="">This is where you put that file descriptor you opened earlier.</td>
</tr>
<tr class="even">
<td><code s__="13" d__="">off</code></td>
<td d__="">This is the offset in the file that you want to start mapping from. A restriction: this <em>must</em> be a multiple of the virtual memory page size. This page size can be obtained with a call to <code s__="13">getpagesize()</code>.
 Note that 32-bit systems may support files with sizes that cannot be 
expressed by 32-bit unsigned integers, so this type is often a 64-bit 
type on such systems.</td>
</tr>
</tbody>
</table>
<p d__="">As for return values, as you might have guessed, <code s__="13">mmap()</code> returns <code s__="13">MAP_FAILED</code> on error (the value <code s__="13">-1</code> properly cast to be compared), and sets <code s__="13">errno</code>. Otherwise, it returns a pointer to the start of the mapped data.</p>
<p d__="">Anyway, without any further ado, we’ll do a short demo that maps the second “page” of a file into memory. First we’ll <code s__="13">open()</code> it to get the file descriptor, then we’ll use <code s__="13">getpagesize()</code> to get the size of a virtual memory page and use this value for both the <code s__="13">len</code> and the <code s__="13">off</code>. In this way, we’ll start mapping at the second page, and map for one page’s length. (On my Linux box, the page size is 4K.)</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/mman.h&gt;</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5" d__=""><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> fd<span class="op" d__="">,</span> pagesize<span class="op" d__="">;</span></span>
<span id="cb60-6" d__=""><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">char</span> <span class="op" d__="">*</span>data<span class="op" d__="">;</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8" d__=""><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>fd <span class="op" d__="">=</span> open<span class="op" d__="">(</span><span class="st" d__="">"foo"</span><span class="op" d__="">,</span> O_RDONLY<span class="op" d__="">);</span></span>
<span id="cb60-9" d__=""><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>pagesize <span class="op" d__="">=</span> getpagesize<span class="op" d__="">();</span></span>
<span id="cb60-10" d__=""><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>data <span class="op" d__="">=</span> mmap<span class="op" d__="">((</span><span class="dt" d__="">void</span><span class="op" d__="">*)</span><span class="dv" d__="">0</span><span class="op" d__="">,</span> pagesize<span class="op" d__="">,</span> PROT_READ<span class="op" d__="">,</span> MAP_SHARED<span class="op" d__="">,</span> fd<span class="op" d__="">,</span> pagesize<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">Once this code stretch has run, you can access the first byte of the mapped section of file using <code s__="13">data[0]</code>. Notice there’s a lot of type conversion going on here. For instance, <code s__="13">mmap()</code> returns <code s__="13">void*</code>, but we treat it as a <code s__="13">char*</code>.</p>
<p d__="">Also notice that we’ve mapped the file <code s__="13">PROT_READ</code> so we have read-only access. Any attempt to write to the data (<code s__="13">data[0] = 'B'</code>, for example) will cause a segmentation violation. Open the file <code s__="13">O_RDWR</code> with <code s__="13">prot</code> set to <code s__="13">PROT_READ|PROT_WRITE</code> if you want read-write access to the data.</p>
<h2 data-number="10.2" id="unmapping-the-file" d__=""><span class="header-section-number">10.2</span> Unmapping the file</h2>
<p d__="">There is, of course, a <code s__="13">munmap()</code> function to un-memory map a file:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb61-1" d__=""><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> munmap<span class="op" d__="">(</span><span class="dt" d__="">void</span> <span class="op" d__="">*</span>addr<span class="op" d__="">,</span> <span class="dt" d__="">size_t</span> len<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">This simply unmaps the region pointed to by <code s__="13">addr</code> (returned from <code s__="13">mmap()</code>) with length <code s__="13">len</code> (same as the <code s__="13">len</code> passed to <code s__="13">mmap()</code>). <code s__="13">munmap()</code> returns <code s__="13">-1</code> on error and sets the <code s__="13">errno</code> variable.</p>
<p d__="">Once you’ve unmapped a file, any attempts to access the data 
through the old pointer will result in a segmentation fault. You have 
been warned!</p>
<p d__="">A final note: the file will automatically unmap if your program exits, of course.</p>
<h2 data-number="10.3" id="concurrency-again" d__=""><span class="header-section-number">10.3</span> Concurrency, again?!</h2>
<p d__="">If you have multiple processes manipulating the data in the 
same file concurrently, you could be in for troubles. You might have to <a href="#flocking" d__="">lock the file</a> or use <a href="#semaphores" d__="">semaphores</a> to regulate access to the file while a process messes with it. Look at the <a href="#shmcon" d__="">Shared Memory</a> document for a (very little bit) more concurrency information.</p>
<h2 data-number="10.4" id="a-simple-sample" d__=""><span class="header-section-number">10.4</span> A simple sample</h2>
<p d__="">Well, it’s code time again. I’ve got here a demo program that 
maps its own source to memory and prints the byte that’s found at 
whatever offset you specify on the command line.</p>
<p d__="">The program restricts the offsets you can specify to the range
 0 through the file length. The file length is obtained through a call 
to <code s__="13">stat()</code> which you might not have seen before. It
 returns a structure full of file info, one field of which is the size 
in bytes. Easy enough.</p>
<p d__="">Here is the source for <a href="https://beej.us/guide/bgipc/source/examples/mmapdemo.c"><code s__="13" d__="">mmapdemo.c</code></a><a href="#fn40" class="footnote-ref" id="fnref40" role="doc-noteref"><sup s__="13" d__="">40</sup></a>:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb62-1"><a href="#cb62-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb62-2"><a href="#cb62-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb62-3"><a href="#cb62-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;fcntl.h&gt;</span></span>
<span id="cb62-4"><a href="#cb62-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb62-5"><a href="#cb62-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb62-6"><a href="#cb62-6"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/mman.h&gt;</span></span>
<span id="cb62-7"><a href="#cb62-7"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/stat.h&gt;</span></span>
<span id="cb62-8"><a href="#cb62-8"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb62-9"><a href="#cb62-9"></a></span>
<span id="cb62-10" d__=""><a href="#cb62-10"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">int</span> argc<span class="op" d__="">,</span> <span class="dt" d__="">char</span> <span class="op" d__="">*</span>argv<span class="op" d__="">[])</span></span>
<span id="cb62-11"><a href="#cb62-11"></a><span class="op" d__="">{</span></span>
<span id="cb62-12" d__=""><a href="#cb62-12"></a>    <span class="dt" d__="">int</span> fd<span class="op" d__="">;</span></span>
<span id="cb62-13" d__=""><a href="#cb62-13"></a>    off_t offset<span class="op" d__="">;</span></span>
<span id="cb62-14" d__=""><a href="#cb62-14"></a>    <span class="dt" d__="">char</span> <span class="op" d__="">*</span>data<span class="op" d__="">;</span></span>
<span id="cb62-15" d__=""><a href="#cb62-15"></a>    <span class="kw" d__="">struct</span> stat sbuf<span class="op" d__="">;</span></span>
<span id="cb62-16"><a href="#cb62-16"></a></span>
<span id="cb62-17" d__=""><a href="#cb62-17"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>argc <span class="op" d__="">!=</span> <span class="dv" d__="">2</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb62-18" d__=""><a href="#cb62-18"></a>            fprintf<span class="op" d__="">(</span>stderr<span class="op" d__="">,</span> <span class="st" d__="">"usage: mmapdemo offset</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb62-19" d__=""><a href="#cb62-19"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb62-20"><a href="#cb62-20"></a>    <span class="op" d__="">}</span></span>
<span id="cb62-21"><a href="#cb62-21"></a></span>
<span id="cb62-22" d__=""><a href="#cb62-22"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>fd <span class="op" d__="">=</span> open<span class="op" d__="">(</span><span class="st" d__="">"mmapdemo.c"</span><span class="op" d__="">,</span> O_RDONLY<span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb62-23" d__=""><a href="#cb62-23"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"open"</span><span class="op" d__="">);</span></span>
<span id="cb62-24" d__=""><a href="#cb62-24"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb62-25"><a href="#cb62-25"></a>    <span class="op" d__="">}</span></span>
<span id="cb62-26"><a href="#cb62-26"></a></span>
<span id="cb62-27" d__=""><a href="#cb62-27"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>stat<span class="op" d__="">(</span><span class="st" d__="">"mmapdemo.c"</span><span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>sbuf<span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb62-28" d__=""><a href="#cb62-28"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"stat"</span><span class="op" d__="">);</span></span>
<span id="cb62-29" d__=""><a href="#cb62-29"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb62-30"><a href="#cb62-30"></a>    <span class="op" d__="">}</span></span>
<span id="cb62-31"><a href="#cb62-31"></a></span>
<span id="cb62-32"><a href="#cb62-32"></a></span>
<span id="cb62-33" d__=""><a href="#cb62-33"></a>    offset <span class="op" d__="">=</span> atoi<span class="op" d__="">(</span>argv<span class="op" d__="">[</span><span class="dv" d__="">1</span><span class="op" d__="">]);</span></span>
<span id="cb62-34" d__=""><a href="#cb62-34"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>offset <span class="op" d__="">&lt;</span> <span class="dv" d__="">0</span> <span class="op" d__="">||</span> offset <span class="op" d__="">&gt;</span> sbuf<span class="op" d__="">.</span>st_size<span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb62-35" d__=""><a href="#cb62-35"></a>        fprintf<span class="op" d__="">(</span>stderr<span class="op" d__="">,</span> <span class="st" d__="">"mmapdemo: offset must be in the range 0-</span><span class="sc" d__="">%d\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> \</span>
<span id="cb62-36" d__=""><a href="#cb62-36"></a>                                                          sbuf<span class="op" d__="">.</span>st_size<span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb62-37" d__=""><a href="#cb62-37"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb62-38"><a href="#cb62-38"></a>    <span class="op" d__="">}</span></span>
<span id="cb62-39"><a href="#cb62-39"></a>    </span>
<span id="cb62-40" d__=""><a href="#cb62-40"></a>    data <span class="op" d__="">=</span> mmap<span class="op" d__="">((</span>caddr_t<span class="op" d__="">)</span><span class="dv" d__="">0</span><span class="op" d__="">,</span> sbuf<span class="op" d__="">.</span>st_size<span class="op" d__="">,</span> PROT_READ<span class="op" d__="">,</span> MAP_SHARED<span class="op" d__="">,</span> fd<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span>
<span id="cb62-41" d__=""><a href="#cb62-41"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>data <span class="op" d__="">==</span> MAP_FAILED<span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb62-42" d__=""><a href="#cb62-42"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"mmap"</span><span class="op" d__="">);</span></span>
<span id="cb62-43" d__=""><a href="#cb62-43"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb62-44"><a href="#cb62-44"></a>    <span class="op" d__="">}</span></span>
<span id="cb62-45"><a href="#cb62-45"></a></span>
<span id="cb62-46" d__=""><a href="#cb62-46"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"byte at offset </span><span class="sc" d__="">%ld</span><span class="st" d__=""> is '</span><span class="sc" d__="">%c</span><span class="st" d__="">'</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> offset<span class="op" d__="">,</span> data<span class="op" d__="">[</span>offset<span class="op" d__="">]);</span></span>
<span id="cb62-47"><a href="#cb62-47"></a></span>
<span id="cb62-48"><a href="#cb62-48"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb62-49"><a href="#cb62-49"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">That’s all there is to it. Compile that sucker up and run it with some command line like:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode default"><code class="sourceCode default" s__="13"><span id="cb63-1" d__=""><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>$ mmapdemo 30</span>
<span id="cb63-2" d__=""><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>byte at offset 30 is 'e'</span></code></pre></div>
<p d__="">I’ll leave it up to you to write some really cool programs using this system call.</p>
<h2 data-number="10.5" id="observations-on-memory-mapping" d__=""><span class="header-section-number">10.5</span> Observations on memory mapping</h2>
<p d__="">I would be remiss if I didn’t point out a few interesting 
aspects of using mapped files on Linux. First, the memory that the 
operating system allocates to use as the storage for the mapped file 
data is <em>the same memory</em> used to perform file buffering operations when other processes perform <code s__="13">read()</code> and <code s__="13">write()</code> operations! While <code s__="13">read()</code>s and <code s__="13">write()</code>s
 are guaranteed atomic by POSIX up to a certain size, that goes out the 
window when some processes bypass the POSIX functions entirely!</p>
<p d__="">Second, because we’re bypassing those POSIX functions, we can 
read and write the buffer contents without regard to record locking that
 might be applied to the file descriptor (as discussed in a previous 
section). Normally, this isn’t a big deal—who’s going to use memory 
mapped files in one application while using record locking in another, 
when both access the same file? If the file is documented to require 
record locking, then all applications should use it. That said, there’s 
nothing stopping an application from using the read and write locking we
 discussed previously immediately before updating the memory that 
belongs to the mapped file.</p>
<p d__="">Third, because we’re bypassing those POSIX functions (do I 
sound like a broken record yet?), the system is not capable of providing
 meaningful readahead or writebehind strategies. As of this writing, 
Linux kernel versions 4.x and later <em>do</em> implement an algorithm 
that detects when two adjacent page faults occur within a memory mapped 
file, and it performs a minimal amount of readahead (just two pages, 
compared to the readahead configurable at the file system layer, which 
can be upwards of 256KB). There is no writebehind whatsoever, as there’s
 no practical way to detect when adjacent pages are written to under 
current hardware configurations.</p>
<p d__="">Last, given all of the above, there are still very compelling 
reasons to use memory mapped files. The primary one being that such 
files are, by definition, “persistent storage”, meaning applications do 
not have to create lengthy <code s__="13">load()</code>/<code s__="13">save()</code>
 functions for their data if they use memory mapped files. However, any 
binary data will be written in a platform dependent manner (such as 
endianness) so those files are likely not portable.</p>
<h2 data-number="10.6" id="summary-5" d__=""><span class="header-section-number">10.6</span> Summary</h2>
<p d__="">Memory mapped files can be very useful, especially on systems 
that don’t support shared memory segments. In fact, the two are very 
similar in most respects. (Memory mapped files are committed to disk, 
too, so this could even be an advantage, yes?) With file locking or 
semaphores, data in a memory mapped file can easily be shared between 
multiple processes.</p>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- ======================================================= -->
<!-- Unix Sockets -->
<!-- ======================================================= -->
<h1 data-number="11" id="unixsock" d__=""><span class="header-section-number">11</span> Unix Sockets</h1>
<p d__="">Remember <a href="#fifos" d__="">FIFOs</a>? Remember how they can only send data in one direction, just like <a href="#pipes" d__="">Pipes</a>? Wouldn’t it be grand if you could send data in both directions like you can with a socket?</p>
<p d__="">Well, hope no longer, because the answer is here: Unix Domain 
Sockets! In case you’re still wondering what a socket is, well, it’s a 
two-way communications pipe, which can be used to communicate in a wide 
variety of <em>domains</em>. One of the most common domains sockets 
communicate over is the Internet, but we won’t discuss that here. We 
will, however, be talking about sockets in the Unix domain; that is, 
sockets that can be used between processes on the same Unix system.</p>
<p d__="">Unix sockets use many of the same function calls that Internet
 sockets do, and I won’t be describing all of the calls I use in detail 
within this document. If the description of a certain call is too vague 
(or if you just want to learn more about Internet sockets anyway), I 
arbitrarily suggest <a href="https://beej.us/guide/bgnet" d__="">Beej’s Guide to Network Programming using Internet Sockets</a><a href="#fn41" class="footnote-ref" id="fnref41" role="doc-noteref"><sup s__="13" d__="">41</sup></a>. I know the author personally.</p>
<h2 data-number="11.1" id="overview" d__=""><span class="header-section-number">11.1</span> Overview</h2>
<p d__="">Like I said before, Unix sockets are just like two-way FIFOs. 
However, all data communication will be taking place through the sockets
 interface, instead of through the file interface. Although Unix sockets
 are a special file in the file system (just like FIFOs), you won’t be 
using <code s__="13">open()</code> and <code s__="13">read()</code>—you’ll be using <code s__="13">socket()</code>, <code s__="13">bind()</code>, <code s__="13">recv()</code>, etc.</p>
<p d__="">When programming with sockets, you’ll usually create server 
and client programs. The server will sit listening for incoming 
connections from clients and handle them. This is very similar to the 
situation that exists with Internet sockets, but with some fine 
differences.</p>
<p d__="">For instance, when describing which Unix socket you want to 
use (that is, the path to the special file that is the socket), you use a
 <code s__="13">struct sockaddr_un</code>, which has the following fields:</p>
<pre><code s__="13" d__="">struct sockaddr_un {
    unsigned short sun_family;  /* AF_UNIX */
    char sun_path[108];
}</code></pre>
<p d__="">This is the structure you will be passing to the <code s__="13">bind()</code> function, which associates a socket descriptor (a file descriptor) with a certain file (the name for which is in the <code s__="13">sun_path</code> field).</p>
<h2 data-number="11.2" id="what-to-do-to-be-a-server" d__=""><span class="header-section-number">11.2</span> What to do to be a Server</h2>
<p d__="">Without going into too much detail, I’ll outline the steps a 
server program usually has to go through to do it’s thing. While I’m at 
it, I’ll be trying to implement an “echo server” which just echos back 
everything it gets on the socket.</p>
<p d__="">Here are the server steps:</p>
<ol type="1">
<li><p d__=""><strong>Call <code s__="13">socket()</code>:</strong> A call to <code s__="13">socket()</code> with the proper arguments creates the Unix socket:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb65-1" d__=""><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">unsigned</span> <span class="dt" d__="">int</span> s<span class="op" d__="">,</span> s2<span class="op" d__="">;</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3" d__=""><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="kw" d__="">struct</span> sockaddr_un remote<span class="op" d__="">,</span> local <span class="op" d__="">=</span> <span class="op" d__="">{</span></span>
<span id="cb65-4" d__=""><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="op" d__="">.</span>sun_family <span class="op" d__="">=</span> AF_UNIX<span class="op" d__="">,</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="co" d__="">// .sun_path = SOCK_PATH,   // Can't do assignment to an array</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="op" d__="">};</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-8" d__=""><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="dt" d__="">int</span> len<span class="op" d__="">;</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-10" d__=""><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>s <span class="op" d__="">=</span> socket<span class="op" d__="">(</span>_AF_UNIX_<span class="op" d__="">,</span> SOCK_STREAM<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span></code></pre></div>
<p d__="">The second argument, <code s__="13">SOCK_STREAM</code>, tells <code s__="13">socket()</code> to create a stream socket. Yes, datagram sockets (<code s__="13">SOCK_DGRAM</code>) are supported in the Unix domain, but I’m only going to cover stream sockets here. For the curious, see <a href="https://beej.us/guide/bgnet" d__="">Beej’s Guide to Network Programming</a><a href="#fn42" class="footnote-ref" id="fnref42" role="doc-noteref"><sup s__="13" d__="">42</sup></a>
 for a good description of unconnected datagram sockets that applies 
perfectly well to Unix sockets. The only thing that changes is that 
you’re now using a <code s__="13">struct sockaddr_un</code> instead of a <code s__="13">struct sockaddr_in</code>.</p>
<p d__="">One more note: all these calls return <code s__="13">-1</code> on error and set the global variable <code s__="13">errno</code> to reflect whatever went wrong. Be sure to do your error checking.</p></li>
<li><p d__=""><strong>Call <code s__="13">bind()</code>:</strong> You got a socket descriptor from the call to <code s__="13">socket()</code>, now you want to bind that to an address in the Unix domain. (That address, as I said before, is a special file on disk.)</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb66-1" d__=""><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>strcpy<span class="op" d__="">(</span>local<span class="op" d__="">.</span>sun_path<span class="op" d__="">,</span> <span class="st" d__="">"/home/beej/mysocket"</span><span class="op" d__="">);</span></span>
<span id="cb66-2" d__=""><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>unlink<span class="op" d__="">(</span>local<span class="op" d__="">.</span>sun_path<span class="op" d__="">);</span></span>
<span id="cb66-3" d__=""><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>len <span class="op" d__="">=</span> strlen<span class="op" d__="">(</span>local<span class="op" d__="">.</span>sun_path<span class="op" d__="">)</span> <span class="op" d__="">+</span> <span class="kw" d__="">sizeof</span><span class="op" d__="">(</span>local<span class="op" d__="">.</span>sun_family<span class="op" d__="">);</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5" d__=""><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>bind<span class="op" d__="">(</span>s<span class="op" d__="">,</span> <span class="op" d__="">(</span><span class="kw" d__="">struct</span> sockaddr <span class="op" d__="">*)&amp;</span>local<span class="op" d__="">,</span> len<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">This associates the socket descriptor “<code s__="13">s</code>” with the Unix socket address “<code s__="13">/home/beej/mysocket</code>”. Notice that we called <code s__="13">unlink()</code> before <code s__="13">bind()</code> to remove the socket if it already exists. You will get an <code s__="13">EINVAL</code> error if the file is already there.</p></li>
<li><p d__=""><strong>Call <code s__="13">listen()</code>:</strong> This instructs the socket to listen for incoming connections from client programs:</p>
<pre><code s__="13" d__="">listen(s, 5);</code></pre>
<p d__="">The second argument, <code s__="13">5</code>, is the number of incoming connections that can be queued before you call <code s__="13">accept()</code>, below. If there are this many connections waiting to be accepted, additional clients will generate the error <code s__="13">ECONNREFUSED</code>.</p></li>
<li><p d__=""><strong>Call <code s__="13">accept()</code>:</strong> This will accept a connection from a client. This function returns <em>another socket descriptor</em>! The old descriptor is still listening for new connections, but this new one is connected to the client:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb68-1" d__=""><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>len <span class="op" d__="">=</span> <span class="kw" d__="">sizeof</span><span class="op" d__="">(</span>remote<span class="op" d__="">);</span></span>
<span id="cb68-2" d__=""><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>s2 <span class="op" d__="">=</span> accept<span class="op" d__="">(</span>s<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>remote<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>len<span class="op" d__="">);</span></span></code></pre></div>
<p d__="">When <code s__="13">accept()</code> returns, the <code s__="13">remote</code> variable will be filled with the remote side’s <code s__="13">struct sockaddr_un</code>, and <code s__="13">len</code> will be set to its length. The descriptor <code s__="13">s2</code> is connected to the client, and is ready for <code s__="13">send()</code> and <code s__="13">recv()</code>, as described in the <a href="https://beej.us/guide/bgnet" d__="">Network Programming Guide</a><a href="#fn43" class="footnote-ref" id="fnref43" role="doc-noteref"><sup s__="13" d__="">43</sup></a>.</p></li>
<li><p d__=""><strong>Handle the connection and loop back to <code s__="13">accept()</code>:</strong>
 Usually you’ll want to communicate to the client here (we’ll just echo 
back everything it sends us), close the connection, then <code s__="13">accept()</code> a new one.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode c"><code class="sourceCode c" s__="13"><span id="cb69-1" d__=""><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="cf" d__="">while</span> <span class="op" d__="">(</span>len <span class="op" d__="">=</span> recv<span class="op" d__="">(</span>s2<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>buf<span class="op" d__="">,</span> <span class="dv" d__="">100</span><span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">),</span> len <span class="op" d__="">&gt;</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span></span>
<span id="cb69-2" d__=""><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    send<span class="op" d__="">(</span>s2<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>buf<span class="op" d__="">,</span> len<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="co" d__="">/* loop back to accept() from here */</span></span></code></pre></div></li>
<li><p d__=""><strong>Close the connection:</strong> You can close the connection either by calling <code s__="13">close()</code>, or by calling <a href="https://man.archlinux.org/man/shutdown.2"><code s__="13" d__="">shutdown</code></a><a href="#fn44" class="footnote-ref" id="fnref44" role="doc-noteref"><sup s__="13" d__="">44</sup></a>.</p></li>
</ol>
<p d__="">With all that said, here is some source for an echoing server, <a href="https://beej.us/guide/bgipc/source/examples/echos.c"><code s__="13" d__="">echos.c</code></a><a href="#fn45" class="footnote-ref" id="fnref45" role="doc-noteref"><sup s__="13" d__="">45</sup></a>. All it does is wait for a connection on a Unix socket (named, in this case, “echo_socket”).</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb70-1"><a href="#cb70-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb70-2"><a href="#cb70-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb70-3"><a href="#cb70-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb70-4"><a href="#cb70-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;string.h&gt;</span></span>
<span id="cb70-5"><a href="#cb70-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb70-6"><a href="#cb70-6"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/socket.h&gt;</span></span>
<span id="cb70-7"><a href="#cb70-7"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/un.h&gt;</span></span>
<span id="cb70-8"><a href="#cb70-8"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb70-9"><a href="#cb70-9"></a></span>
<span id="cb70-10"><a href="#cb70-10"></a><span class="pp" d__="">#define SOCK_PATH </span><span class="st" d__="">"echo_socket"</span></span>
<span id="cb70-11"><a href="#cb70-11"></a></span>
<span id="cb70-12" d__=""><a href="#cb70-12"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb70-13"><a href="#cb70-13"></a><span class="op" d__="">{</span></span>
<span id="cb70-14" d__=""><a href="#cb70-14"></a>    <span class="dt" d__="">int</span> s<span class="op" d__="">,</span> s2<span class="op" d__="">,</span> len<span class="op" d__="">;</span></span>
<span id="cb70-15" d__=""><a href="#cb70-15"></a>    <span class="kw" d__="">struct</span> sockaddr_un remote<span class="op" d__="">,</span> local <span class="op" d__="">=</span> <span class="op" d__="">{</span></span>
<span id="cb70-16" d__=""><a href="#cb70-16"></a>            <span class="op" d__="">.</span>sun_family <span class="op" d__="">=</span> AF_UNIX<span class="op" d__="">,</span></span>
<span id="cb70-17"><a href="#cb70-17"></a>            <span class="co" d__="">// .sun_path = SOCK_PATH,   // Can't do assignment to an array</span></span>
<span id="cb70-18"><a href="#cb70-18"></a>    <span class="op" d__="">};</span></span>
<span id="cb70-19" d__=""><a href="#cb70-19"></a>    <span class="dt" d__="">char</span> str<span class="op" d__="">[</span><span class="dv" d__="">100</span><span class="op" d__="">];</span></span>
<span id="cb70-20"><a href="#cb70-20"></a></span>
<span id="cb70-21" d__=""><a href="#cb70-21"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>s <span class="op" d__="">=</span> socket<span class="op" d__="">(</span>AF_UNIX<span class="op" d__="">,</span> SOCK_STREAM<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb70-22" d__=""><a href="#cb70-22"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"socket"</span><span class="op" d__="">);</span></span>
<span id="cb70-23" d__=""><a href="#cb70-23"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb70-24"><a href="#cb70-24"></a>    <span class="op" d__="">}</span></span>
<span id="cb70-25"><a href="#cb70-25"></a></span>
<span id="cb70-26" d__=""><a href="#cb70-26"></a>    strcpy<span class="op" d__="">(</span>local<span class="op" d__="">.</span>sun_path<span class="op" d__="">,</span> SOCK_PATH<span class="op" d__="">);</span></span>
<span id="cb70-27" d__=""><a href="#cb70-27"></a>    unlink<span class="op" d__="">(</span>local<span class="op" d__="">.</span>sun_path<span class="op" d__="">);</span></span>
<span id="cb70-28" d__=""><a href="#cb70-28"></a>    len <span class="op" d__="">=</span> strlen<span class="op" d__="">(</span>local<span class="op" d__="">.</span>sun_path<span class="op" d__="">)</span> <span class="op" d__="">+</span> <span class="kw" d__="">sizeof</span><span class="op" d__="">(</span>local<span class="op" d__="">.</span>sun_family<span class="op" d__="">);</span></span>
<span id="cb70-29" d__=""><a href="#cb70-29"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>bind<span class="op" d__="">(</span>s<span class="op" d__="">,</span> <span class="op" d__="">(</span><span class="kw" d__="">struct</span> sockaddr <span class="op" d__="">*)&amp;</span>local<span class="op" d__="">,</span> len<span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb70-30" d__=""><a href="#cb70-30"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"bind"</span><span class="op" d__="">);</span></span>
<span id="cb70-31" d__=""><a href="#cb70-31"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb70-32"><a href="#cb70-32"></a>    <span class="op" d__="">}</span></span>
<span id="cb70-33"><a href="#cb70-33"></a></span>
<span id="cb70-34" d__=""><a href="#cb70-34"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>listen<span class="op" d__="">(</span>s<span class="op" d__="">,</span> <span class="dv" d__="">5</span><span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb70-35" d__=""><a href="#cb70-35"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"listen"</span><span class="op" d__="">);</span></span>
<span id="cb70-36" d__=""><a href="#cb70-36"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb70-37"><a href="#cb70-37"></a>    <span class="op" d__="">}</span></span>
<span id="cb70-38"><a href="#cb70-38"></a></span>
<span id="cb70-39"><a href="#cb70-39"></a>    <span class="cf" d__="">for</span><span class="op" d__="">(;;)</span> <span class="op" d__="">{</span></span>
<span id="cb70-40" d__=""><a href="#cb70-40"></a>            <span class="dt" d__="">int</span> done<span class="op" d__="">,</span> n<span class="op" d__="">;</span></span>
<span id="cb70-41" d__=""><a href="#cb70-41"></a>            printf<span class="op" d__="">(</span><span class="st" d__="">"Waiting for a connection...</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb70-42" d__=""><a href="#cb70-42"></a>            socklen_t slen <span class="op" d__="">=</span> <span class="kw" d__="">sizeof</span><span class="op" d__="">(</span>remote<span class="op" d__="">);</span></span>
<span id="cb70-43" d__=""><a href="#cb70-43"></a>            <span class="cf" d__="">if</span> <span class="op" d__="">((</span>s2 <span class="op" d__="">=</span> accept<span class="op" d__="">(</span>s<span class="op" d__="">,</span> <span class="op" d__="">(</span><span class="kw" d__="">struct</span> sockaddr <span class="op" d__="">*)&amp;</span>remote<span class="op" d__="">,</span> <span class="op" d__="">&amp;</span>slen<span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb70-44" d__=""><a href="#cb70-44"></a>                    perror<span class="op" d__="">(</span><span class="st" d__="">"accept"</span><span class="op" d__="">);</span></span>
<span id="cb70-45" d__=""><a href="#cb70-45"></a>                    exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb70-46"><a href="#cb70-46"></a>            <span class="op" d__="">}</span></span>
<span id="cb70-47"><a href="#cb70-47"></a></span>
<span id="cb70-48" d__=""><a href="#cb70-48"></a>            printf<span class="op" d__="">(</span><span class="st" d__="">"Connected.</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb70-49"><a href="#cb70-49"></a></span>
<span id="cb70-50" d__=""><a href="#cb70-50"></a>            done <span class="op" d__="">=</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb70-51"><a href="#cb70-51"></a>            <span class="cf" d__="">do</span> <span class="op" d__="">{</span></span>
<span id="cb70-52" d__=""><a href="#cb70-52"></a>                    n <span class="op" d__="">=</span> recv<span class="op" d__="">(</span>s2<span class="op" d__="">,</span> str<span class="op" d__="">,</span> <span class="kw" d__="">sizeof</span><span class="op" d__="">(</span>str<span class="op" d__="">),</span> <span class="dv" d__="">0</span><span class="op" d__="">);</span></span>
<span id="cb70-53" d__=""><a href="#cb70-53"></a>                    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>n <span class="op" d__="">&lt;=</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb70-54" d__=""><a href="#cb70-54"></a>                            <span class="cf" d__="">if</span> <span class="op" d__="">(</span>n <span class="op" d__="">&lt;</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> perror<span class="op" d__="">(</span><span class="st" d__="">"recv"</span><span class="op" d__="">);</span></span>
<span id="cb70-55" d__=""><a href="#cb70-55"></a>                            done <span class="op" d__="">=</span> <span class="dv" d__="">1</span><span class="op" d__="">;</span></span>
<span id="cb70-56"><a href="#cb70-56"></a>                    <span class="op" d__="">}</span></span>
<span id="cb70-57"><a href="#cb70-57"></a></span>
<span id="cb70-58" d__=""><a href="#cb70-58"></a>                    <span class="cf" d__="">if</span> <span class="op" d__="">(!</span>done<span class="op" d__="">)</span> </span>
<span id="cb70-59" d__=""><a href="#cb70-59"></a>                            <span class="cf" d__="">if</span> <span class="op" d__="">(</span>send<span class="op" d__="">(</span>s2<span class="op" d__="">,</span> str<span class="op" d__="">,</span> n<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> <span class="op" d__="">&lt;</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb70-60" d__=""><a href="#cb70-60"></a>                                    perror<span class="op" d__="">(</span><span class="st" d__="">"send"</span><span class="op" d__="">);</span></span>
<span id="cb70-61" d__=""><a href="#cb70-61"></a>                                    done <span class="op" d__="">=</span> <span class="dv" d__="">1</span><span class="op" d__="">;</span></span>
<span id="cb70-62"><a href="#cb70-62"></a>                            <span class="op" d__="">}</span></span>
<span id="cb70-63" d__=""><a href="#cb70-63"></a>            <span class="op" d__="">}</span> <span class="cf" d__="">while</span> <span class="op" d__="">(!</span>done<span class="op" d__="">);</span></span>
<span id="cb70-64"><a href="#cb70-64"></a></span>
<span id="cb70-65" d__=""><a href="#cb70-65"></a>            close<span class="op" d__="">(</span>s2<span class="op" d__="">);</span></span>
<span id="cb70-66"><a href="#cb70-66"></a>    <span class="op" d__="">}</span></span>
<span id="cb70-67"><a href="#cb70-67"></a></span>
<span id="cb70-68"><a href="#cb70-68"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb70-69"><a href="#cb70-69"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">As you can see, all the aforementioned steps are included in this program: call <code s__="13">socket()</code>, call <code s__="13">bind()</code>, call <code s__="13">listen()</code>, call <code s__="13">accept()</code>, and do some network <code s__="13">send()</code>s and <code s__="13">recv()</code>s.</p>
<h2 data-number="11.3" id="what-to-do-to-be-a-client" d__=""><span class="header-section-number">11.3</span> What to do to be a client</h2>
<p d__="">There needs to be a program to talk to the above server, 
right? Except with the client, it’s a lot easier because you don’t have 
to do any pesky <code s__="13">listen()</code>ing or <code s__="13">accept()</code>ing. Here are the steps:</p>
<ol type="1">
<li><p d__="">Call <code s__="13">socket()</code> to get a Unix domain socket to communicate through.</p></li>
<li><p d__="">Set up a <code s__="13">struct sockaddr_un</code> with the remote address (where the server is listening) and call <code s__="13">connect()</code> with that as an argument.</p></li>
<li><p d__="">Assuming no errors, you’re connected to the remote side! Use <code s__="13">send()</code> and <code s__="13">recv()</code> to your heart’s content!</p></li>
</ol>
<p d__="">How about code to talk to the echo server, above? No sweat, friends, here is <a href="https://beej.us/guide/bgipc/source/examples/echoc.c"><code s__="13" d__="">echoc.c</code></a><a href="#fn46" class="footnote-ref" id="fnref46" role="doc-noteref"><sup s__="13" d__="">46</sup></a>:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb71-1"><a href="#cb71-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb71-2"><a href="#cb71-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb71-3"><a href="#cb71-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb71-4"><a href="#cb71-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;string.h&gt;</span></span>
<span id="cb71-5"><a href="#cb71-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb71-6"><a href="#cb71-6"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/socket.h&gt;</span></span>
<span id="cb71-7"><a href="#cb71-7"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/un.h&gt;</span></span>
<span id="cb71-8"><a href="#cb71-8"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb71-9"><a href="#cb71-9"></a></span>
<span id="cb71-10"><a href="#cb71-10"></a><span class="pp" d__="">#define SOCK_PATH </span><span class="st" d__="">"echo_socket"</span></span>
<span id="cb71-11"><a href="#cb71-11"></a></span>
<span id="cb71-12" d__=""><a href="#cb71-12"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb71-13"><a href="#cb71-13"></a><span class="op" d__="">{</span></span>
<span id="cb71-14" d__=""><a href="#cb71-14"></a>    <span class="dt" d__="">int</span> s<span class="op" d__="">,</span> len<span class="op" d__="">;</span></span>
<span id="cb71-15" d__=""><a href="#cb71-15"></a>    <span class="kw" d__="">struct</span> sockaddr_un remote <span class="op" d__="">=</span> <span class="op" d__="">{</span></span>
<span id="cb71-16" d__=""><a href="#cb71-16"></a>        <span class="op" d__="">.</span>sun_family <span class="op" d__="">=</span> AF_UNIX<span class="op" d__="">,</span></span>
<span id="cb71-17"><a href="#cb71-17"></a>        <span class="co" d__="">// .sun_path = SOCK_PATH,   // Can't do assignment to an array</span></span>
<span id="cb71-18"><a href="#cb71-18"></a>    <span class="op" d__="">};</span></span>
<span id="cb71-19" d__=""><a href="#cb71-19"></a>    <span class="dt" d__="">char</span> str<span class="op" d__="">[</span><span class="dv" d__="">100</span><span class="op" d__="">];</span></span>
<span id="cb71-20"><a href="#cb71-20"></a></span>
<span id="cb71-21" d__=""><a href="#cb71-21"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">((</span>s <span class="op" d__="">=</span> socket<span class="op" d__="">(</span>AF_UNIX<span class="op" d__="">,</span> SOCK_STREAM<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">))</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb71-22" d__=""><a href="#cb71-22"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"socket"</span><span class="op" d__="">);</span></span>
<span id="cb71-23" d__=""><a href="#cb71-23"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb71-24"><a href="#cb71-24"></a>    <span class="op" d__="">}</span></span>
<span id="cb71-25"><a href="#cb71-25"></a></span>
<span id="cb71-26" d__=""><a href="#cb71-26"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Trying to connect...</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb71-27"><a href="#cb71-27"></a></span>
<span id="cb71-28" d__=""><a href="#cb71-28"></a>    strcpy<span class="op" d__="">(</span>remote<span class="op" d__="">.</span>sun_path<span class="op" d__="">,</span> SOCK_PATH<span class="op" d__="">);</span></span>
<span id="cb71-29" d__=""><a href="#cb71-29"></a>    len <span class="op" d__="">=</span> strlen<span class="op" d__="">(</span>remote<span class="op" d__="">.</span>sun_path<span class="op" d__="">)</span> <span class="op" d__="">+</span> <span class="kw" d__="">sizeof</span><span class="op" d__="">(</span>remote<span class="op" d__="">.</span>sun_family<span class="op" d__="">);</span></span>
<span id="cb71-30" d__=""><a href="#cb71-30"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>connect<span class="op" d__="">(</span>s<span class="op" d__="">,</span> <span class="op" d__="">(</span><span class="kw" d__="">struct</span> sockaddr <span class="op" d__="">*)&amp;</span>remote<span class="op" d__="">,</span> len<span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb71-31" d__=""><a href="#cb71-31"></a>        perror<span class="op" d__="">(</span><span class="st" d__="">"connect"</span><span class="op" d__="">);</span></span>
<span id="cb71-32" d__=""><a href="#cb71-32"></a>        exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb71-33"><a href="#cb71-33"></a>    <span class="op" d__="">}</span></span>
<span id="cb71-34"><a href="#cb71-34"></a></span>
<span id="cb71-35" d__=""><a href="#cb71-35"></a>    printf<span class="op" d__="">(</span><span class="st" d__="">"Connected.</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb71-36"><a href="#cb71-36"></a></span>
<span id="cb71-37"><a href="#cb71-37"></a>    <span class="co" d__="">/* size in fgets() includes the null byte */</span></span>
<span id="cb71-38" d__=""><a href="#cb71-38"></a>    <span class="cf" d__="">while</span><span class="op" d__="">(</span>printf<span class="op" d__="">(</span><span class="st" d__="">"&gt; "</span><span class="op" d__="">),</span> fgets<span class="op" d__="">(</span>str<span class="op" d__="">,</span> <span class="kw" d__="">sizeof</span><span class="op" d__="">(</span>str<span class="op" d__="">),</span> stdin<span class="op" d__="">),</span> <span class="op" d__="">!</span>feof<span class="op" d__="">(</span>stdin<span class="op" d__="">))</span> <span class="op" d__="">{</span></span>
<span id="cb71-39" d__=""><a href="#cb71-39"></a>        <span class="cf" d__="">if</span> <span class="op" d__="">(</span>send<span class="op" d__="">(</span>s<span class="op" d__="">,</span> str<span class="op" d__="">,</span> strlen<span class="op" d__="">(</span>str<span class="op" d__="">)+</span><span class="dv" d__="">1</span><span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb71-40" d__=""><a href="#cb71-40"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"send"</span><span class="op" d__="">);</span></span>
<span id="cb71-41" d__=""><a href="#cb71-41"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb71-42"><a href="#cb71-42"></a>        <span class="op" d__="">}</span></span>
<span id="cb71-43"><a href="#cb71-43"></a></span>
<span id="cb71-44" d__=""><a href="#cb71-44"></a>        <span class="cf" d__="">if</span> <span class="op" d__="">((</span>len<span class="op" d__="">=</span>recv<span class="op" d__="">(</span>s<span class="op" d__="">,</span> str<span class="op" d__="">,</span> <span class="kw" d__="">sizeof</span><span class="op" d__="">(</span>str<span class="op" d__="">)-</span><span class="dv" d__="">1</span><span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">))</span> <span class="op" d__="">&gt;</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb71-45" d__=""><a href="#cb71-45"></a>            str<span class="op" d__="">[</span>len<span class="op" d__="">]</span> <span class="op" d__="">=</span> <span class="ch" d__="">'</span><span class="sc" d__="">\0</span><span class="ch" d__="">'</span><span class="op" d__="">;</span></span>
<span id="cb71-46" d__=""><a href="#cb71-46"></a>            printf<span class="op" d__="">(</span><span class="st" d__="">"echo&gt; </span><span class="sc" d__="">%s</span><span class="st" d__="">"</span><span class="op" d__="">,</span> str<span class="op" d__="">);</span></span>
<span id="cb71-47"><a href="#cb71-47"></a>        <span class="op" d__="">}</span> <span class="cf" d__="">else</span> <span class="op" d__="">{</span></span>
<span id="cb71-48" d__=""><a href="#cb71-48"></a>            <span class="cf" d__="">if</span> <span class="op" d__="">(</span>len <span class="op" d__="">&lt;</span> <span class="dv" d__="">0</span><span class="op" d__="">)</span> perror<span class="op" d__="">(</span><span class="st" d__="">"recv"</span><span class="op" d__="">);</span></span>
<span id="cb71-49" d__=""><a href="#cb71-49"></a>            <span class="cf" d__="">else</span> printf<span class="op" d__="">(</span><span class="st" d__="">"Server closed connection</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb71-50" d__=""><a href="#cb71-50"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb71-51"><a href="#cb71-51"></a>        <span class="op" d__="">}</span></span>
<span id="cb71-52"><a href="#cb71-52"></a>    <span class="op" d__="">}</span></span>
<span id="cb71-53"><a href="#cb71-53"></a></span>
<span id="cb71-54" d__=""><a href="#cb71-54"></a>    close<span class="op" d__="">(</span>s<span class="op" d__="">);</span></span>
<span id="cb71-55"><a href="#cb71-55"></a></span>
<span id="cb71-56"><a href="#cb71-56"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb71-57"><a href="#cb71-57"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">In the client code, of course you’ll notice that there are only a few system calls used to set things up: <code s__="13">socket()</code> and <code s__="13">connect()</code>. Since the client isn’t going to be <code s__="13">accept()</code>ing any incoming connections, there’s no need for it to <code s__="13">listen()</code>. Of course, the client still uses <code s__="13">send()</code> and <code s__="13">recv()</code> for transferring data. That about sums it up.</p>
<h2 data-number="11.4" id="socketpairquick-full-duplex-pipes" d__=""><span class="header-section-number">11.4</span> <code>socketpair()</code>—quick full-duplex pipes</h2>
<p d__="">What if you wanted a <a href="#pipes"><code s__="13" d__="">pipe()</code></a>, but you wanted to use a single pipe to send and recieve data from <em>both sides</em>?
 Since pipes are unidirectional (with exceptions in SYSV), you can’t do 
it! There is a solution, though: use a Unix domain socket, since they 
can handle bi-directional data.</p>
<p d__="">What a pain, though! Setting up all that code with <code s__="13">listen()</code> and <code s__="13">connect()</code> and all that just to pass data both ways! But guess what! You don’t have to!</p>
<p d__="">That’s right, there’s a beauty of a system call known as <code s__="13">socketpair()</code> this is nice enough to return to you a pair of <em>already connected sockets</em>! No extra work is needed on your part; you can immediately use these socket descriptors for interprocess communication.</p>
<p d__="">For instance, lets set up two processes. The first sends a <code s__="13">char</code>
 to the second, and the second changes the character to uppercase and 
returns it. Here is some simple code to do just that, called <a href="https://beej.us/guide/bgipc/source/examples/spair.c"><code s__="13" d__="">spair.c</code></a><a href="#fn47" class="footnote-ref" id="fnref47" role="doc-noteref"><sup s__="13" d__="">47</sup></a> (with no error checking for clarity):</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c" s__="13"><span id="cb72-1"><a href="#cb72-1"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdio.h&gt;</span></span>
<span id="cb72-2"><a href="#cb72-2"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;stdlib.h&gt;</span></span>
<span id="cb72-3"><a href="#cb72-3"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;ctype.h&gt;</span></span>
<span id="cb72-4"><a href="#cb72-4"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;errno.h&gt;</span></span>
<span id="cb72-5"><a href="#cb72-5"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;unistd.h&gt;</span></span>
<span id="cb72-6"><a href="#cb72-6"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/types.h&gt;</span></span>
<span id="cb72-7"><a href="#cb72-7"></a><span class="pp" d__="">#include </span><span class="im" d__="">&lt;sys/socket.h&gt;</span></span>
<span id="cb72-8"><a href="#cb72-8"></a></span>
<span id="cb72-9" d__=""><a href="#cb72-9"></a><span class="dt" d__="">int</span> main<span class="op" d__="">(</span><span class="dt" d__="">void</span><span class="op" d__="">)</span></span>
<span id="cb72-10"><a href="#cb72-10"></a><span class="op" d__="">{</span></span>
<span id="cb72-11" d__=""><a href="#cb72-11"></a>    <span class="dt" d__="">int</span> sv<span class="op" d__="">[</span><span class="dv" d__="">2</span><span class="op" d__="">];</span> <span class="co" d__="">/* the pair of socket descriptors */</span></span>
<span id="cb72-12" d__=""><a href="#cb72-12"></a>    <span class="dt" d__="">char</span> buf<span class="op" d__="">;</span> <span class="co" d__="">/* for data exchange between processes */</span></span>
<span id="cb72-13"><a href="#cb72-13"></a></span>
<span id="cb72-14" d__=""><a href="#cb72-14"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(</span>socketpair<span class="op" d__="">(</span>AF_UNIX<span class="op" d__="">,</span> SOCK_STREAM<span class="op" d__="">,</span> <span class="dv" d__="">0</span><span class="op" d__="">,</span> sv<span class="op" d__="">)</span> <span class="op" d__="">==</span> <span class="op" d__="">-</span><span class="dv" d__="">1</span><span class="op" d__="">)</span> <span class="op" d__="">{</span></span>
<span id="cb72-15" d__=""><a href="#cb72-15"></a>            perror<span class="op" d__="">(</span><span class="st" d__="">"socketpair"</span><span class="op" d__="">);</span></span>
<span id="cb72-16" d__=""><a href="#cb72-16"></a>            exit<span class="op" d__="">(</span><span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb72-17"><a href="#cb72-17"></a>    <span class="op" d__="">}</span></span>
<span id="cb72-18"><a href="#cb72-18"></a></span>
<span id="cb72-19" d__=""><a href="#cb72-19"></a>    <span class="cf" d__="">if</span> <span class="op" d__="">(!</span>fork<span class="op" d__="">())</span> <span class="op" d__="">{</span>  <span class="co" d__="">/* child */</span></span>
<span id="cb72-20" d__=""><a href="#cb72-20"></a>            read<span class="op" d__="">(</span>sv<span class="op" d__="">[</span><span class="dv" d__="">1</span><span class="op" d__="">],</span> <span class="op" d__="">&amp;</span>buf<span class="op" d__="">,</span> <span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb72-21" d__=""><a href="#cb72-21"></a>            printf<span class="op" d__="">(</span><span class="st" d__="">"child: read '</span><span class="sc" d__="">%c</span><span class="st" d__="">'</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> buf<span class="op" d__="">);</span></span>
<span id="cb72-22" d__=""><a href="#cb72-22"></a>            buf <span class="op" d__="">=</span> toupper<span class="op" d__="">(</span>buf<span class="op" d__="">);</span>  <span class="co" d__="">/* make it uppercase */</span></span>
<span id="cb72-23" d__=""><a href="#cb72-23"></a>            write<span class="op" d__="">(</span>sv<span class="op" d__="">[</span><span class="dv" d__="">1</span><span class="op" d__="">],</span> <span class="op" d__="">&amp;</span>buf<span class="op" d__="">,</span> <span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb72-24" d__=""><a href="#cb72-24"></a>            printf<span class="op" d__="">(</span><span class="st" d__="">"child: sent '</span><span class="sc" d__="">%c</span><span class="st" d__="">'</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> buf<span class="op" d__="">);</span></span>
<span id="cb72-25"><a href="#cb72-25"></a></span>
<span id="cb72-26"><a href="#cb72-26"></a>    <span class="op" d__="">}</span> <span class="cf" d__="">else</span> <span class="op" d__="">{</span> <span class="co" d__="">/* parent */</span></span>
<span id="cb72-27" d__=""><a href="#cb72-27"></a>            write<span class="op" d__="">(</span>sv<span class="op" d__="">[</span><span class="dv" d__="">0</span><span class="op" d__="">],</span> <span class="st" d__="">"b"</span><span class="op" d__="">,</span> <span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb72-28" d__=""><a href="#cb72-28"></a>            printf<span class="op" d__="">(</span><span class="st" d__="">"parent: sent 'b'</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">);</span></span>
<span id="cb72-29" d__=""><a href="#cb72-29"></a>            read<span class="op" d__="">(</span>sv<span class="op" d__="">[</span><span class="dv" d__="">0</span><span class="op" d__="">],</span> <span class="op" d__="">&amp;</span>buf<span class="op" d__="">,</span> <span class="dv" d__="">1</span><span class="op" d__="">);</span></span>
<span id="cb72-30" d__=""><a href="#cb72-30"></a>            printf<span class="op" d__="">(</span><span class="st" d__="">"parent: read '</span><span class="sc" d__="">%c</span><span class="st" d__="">'</span><span class="sc" d__="">\n</span><span class="st" d__="">"</span><span class="op" d__="">,</span> buf<span class="op" d__="">);</span></span>
<span id="cb72-31" d__=""><a href="#cb72-31"></a>            wait<span class="op" d__="">(</span>NULL<span class="op" d__="">);</span> <span class="co" d__="">/* wait for child to die */</span></span>
<span id="cb72-32"><a href="#cb72-32"></a>    <span class="op" d__="">}</span></span>
<span id="cb72-33"><a href="#cb72-33"></a></span>
<span id="cb72-34"><a href="#cb72-34"></a>    <span class="cf" d__="">return</span> <span class="dv" d__="">0</span><span class="op" d__="">;</span></span>
<span id="cb72-35"><a href="#cb72-35"></a><span class="op" d__="">}</span></span></code></pre></div>
<p d__="">Sure, it’s an expensive way to change a character to 
uppercase, but it’s the fact that you have simple communication going on
 here that really matters.</p>
<p d__="">One more thing to notice is that <code s__="13">socketpair()</code> takes both a domain (<code s__="13">AF_UNIX</code>) and socket type (<code s__="13">SOCK_STREAM</code>).
 These can be any legal values at all, depending on which routines in 
the kernel you want to handle your code, and whether you want stream or 
datagram sockets. I chose <code s__="13">AF_UNIX</code> sockets because this is a Unix sockets document and they’re a bit faster than <code s__="13">AF_INET</code> sockets, I hear.</p>
<p d__="">Finally, you might be curious as to why I’m using <code s__="13">write()</code> and <code s__="13">read()</code> instead of <code s__="13">send()</code> and <code s__="13">recv()</code>. Well, in short, I was being lazy. See, by using these system calls, I don’t have to enter the <code s__="13">flags</code> argument that <code s__="13">send()</code> and <code s__="13">recv()</code>
 use, and I always set it to zero anyway. Of course, socket descriptors 
are just file descriptors like any other, so they respond just fine to 
many file manipulation system calls.</p>
<!-- BG_NEW_CHAPTER -->
<!-- Beej's guide to IPC

# vim: ts=4:sw=4:nosi:et:tw=72
-->
<!-- ======================================================= -->
<!-- References -->
<!-- ======================================================= -->
<h1 data-number="12" id="references" d__=""><span class="header-section-number">12</span> More IPC Resources</h1>
<h2 data-number="12.1" id="books" d__=""><span class="header-section-number">12.1</span> Books</h2>
<p d__="">Here are some books that describe some of the procedures I’ve discussed in this guide, as well as Unix details in specific:</p>
<p d__="">Bach, Maurice J. <em>The Design of the UNIX Operating System</em>. Published by Prentice-Hall, 1986. ISBN <a href="https://beej.us/guide/url/unixdesign" d__="">0132017997</a><a href="#fn48" class="footnote-ref" id="fnref48" role="doc-noteref"><sup s__="13" d__="">48</sup></a>.</p>
<p d__="">W. Richard Stevens. <em>Unix Network Programming, volumes 1-2</em>. Published by Prentice Hall. ISBNs for volumes 1-2: <a href="https://beej.us/guide/url/unixnet1" d__="">0131411551</a><a href="#fn49" class="footnote-ref" id="fnref49" role="doc-noteref"><sup s__="13" d__="">49</sup></a>, <a href="https://beej.us/guide/url/unixnet2" d__="">0130810819</a><a href="#fn50" class="footnote-ref" id="fnref50" role="doc-noteref"><sup s__="13" d__="">50</sup></a>.</p>
<p d__="">W. Richard Stevens. <em>Advanced Programming in the UNIX Environment</em>. Published by Addison Wesley. ISBN <a href="https://beej.us/guide/url/advunix" d__="">0201433079</a><a href="#fn51" class="footnote-ref" id="fnref51" role="doc-noteref"><sup s__="13" d__="">51</sup></a>.</p>
<h2 data-number="12.2" id="other-online-documentation" d__=""><span class="header-section-number">12.2</span> Other online documentation</h2>
<p d__=""><a href="http://www.kohala.com/start/unpv22e/unpv22e.html"><strong d__="">UNIX Network Programming Volume 2 home page</strong></a><a href="#fn52" class="footnote-ref" id="fnref52" role="doc-noteref"><sup s__="13" d__="">52</sup></a>—includes source code from Stevens’ superfine book.</p>
<p d__=""><a href="http://tldp.org/LDP/lpg/node7.html"><strong d__="">The Linux Programmer’s Guide</strong></a><a href="#fn53" class="footnote-ref" id="fnref53" role="doc-noteref"><sup s__="13" d__="">53</sup></a>—in-depth section on IPC.</p>
<p d__=""><a href="https://users.cs.cf.ac.uk/Dave.Marshall/C/"><strong d__="">UNIX System Calls and Subroutines using C</strong></a><a href="#fn54" class="footnote-ref" id="fnref54" role="doc-noteref"><sup s__="13" d__="">54</sup></a>—contains modest IPC information.</p>
<p d__=""><a href="https://tldp.org/LDP/tlk/ipc/ipc.html"><strong d__="">The Linux Kernel</strong></a><a href="#fn55" class="footnote-ref" id="fnref55" role="doc-noteref"><sup s__="13" d__="">55</sup></a>—how the Linux kernel implements IPC.</p>
<!-- ======================================================= -->
<!-- Linux man pages -->
<!-- ======================================================= -->
<h2 data-number="12.3" id="linux-man-pages" d__=""><span class="header-section-number">12.3</span> Linux man pages</h2>
<p d__="">There are Linux manual pages. If you run another flavor of 
Unix, please look at your own man pages, as these might not work on your
 system.</p>
<ul>
<li d__=""><a href="https://man.archlinux.org/man/accept.2"><code s__="13" d__="">accept()</code></a><a href="#fn56" class="footnote-ref" id="fnref56" role="doc-noteref"><sup s__="13" d__="">56</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/bind.2"><code s__="13" d__="">bind()</code></a><a href="#fn57" class="footnote-ref" id="fnref57" role="doc-noteref"><sup s__="13" d__="">57</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/connect.2"><code s__="13" d__="">connect()</code></a><a href="#fn58" class="footnote-ref" id="fnref58" role="doc-noteref"><sup s__="13" d__="">58</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/dup.2"><code s__="13" d__="">dup()</code></a><a href="#fn59" class="footnote-ref" id="fnref59" role="doc-noteref"><sup s__="13" d__="">59</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/exec.2"><code s__="13" d__="">exec()</code></a><a href="#fn60" class="footnote-ref" id="fnref60" role="doc-noteref"><sup s__="13" d__="">60</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/exit.2"><code s__="13" d__="">exit()</code></a><a href="#fn61" class="footnote-ref" id="fnref61" role="doc-noteref"><sup s__="13" d__="">61</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/fcntl.2"><code s__="13" d__="">fcntl()</code></a><a href="#fn62" class="footnote-ref" id="fnref62" role="doc-noteref"><sup s__="13" d__="">62</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/fileno.3"><code s__="13" d__="">fileno()</code></a><a href="#fn63" class="footnote-ref" id="fnref63" role="doc-noteref"><sup s__="13" d__="">63</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/fork.2"><code s__="13" d__="">fork()</code></a><a href="#fn64" class="footnote-ref" id="fnref64" role="doc-noteref"><sup s__="13" d__="">64</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/ftok.3"><code s__="13" d__="">ftok()</code></a><a href="#fn65" class="footnote-ref" id="fnref65" role="doc-noteref"><sup s__="13" d__="">65</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/getpagesize.2"><code s__="13" d__="">getpagesize()</code></a><a href="#fn66" class="footnote-ref" id="fnref66" role="doc-noteref"><sup s__="13" d__="">66</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/ipcrm.8"><code s__="13" d__="">ipcrm</code></a><a href="#fn67" class="footnote-ref" id="fnref67" role="doc-noteref"><sup s__="13" d__="">67</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/ipcs.8"><code s__="13" d__="">ipcs</code></a><a href="#fn68" class="footnote-ref" id="fnref68" role="doc-noteref"><sup s__="13" d__="">68</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/kill.1"><code s__="13" d__="">kill</code></a><a href="#fn69" class="footnote-ref" id="fnref69" role="doc-noteref"><sup s__="13" d__="">69</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/kill.2"><code s__="13" d__="">kill()</code></a><a href="#fn70" class="footnote-ref" id="fnref70" role="doc-noteref"><sup s__="13" d__="">70</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/listen.2"><code s__="13" d__="">listen()</code></a><a href="#fn71" class="footnote-ref" id="fnref71" role="doc-noteref"><sup s__="13" d__="">71</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/lockf.2"><code s__="13" d__="">lockf()</code></a><a href="#fn72" class="footnote-ref" id="fnref72" role="doc-noteref"><sup s__="13" d__="">72</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/lseek.2"><code s__="13" d__="">lseek()</code></a><a href="#fn73" class="footnote-ref" id="fnref73" role="doc-noteref"><sup s__="13" d__="">73</sup></a> (for the <code s__="13">l_whence</code> field in <code s__="13">struct flock</code>),</li>
<li d__=""><a href="https://man.archlinux.org/man/mknod.1"><code s__="13" d__="">mknod</code></a><a href="#fn74" class="footnote-ref" id="fnref74" role="doc-noteref"><sup s__="13" d__="">74</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/mknod.2"><code s__="13" d__="">mknod()</code></a><a href="#fn75" class="footnote-ref" id="fnref75" role="doc-noteref"><sup s__="13" d__="">75</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/mmap.2"><code s__="13" d__="">mmap()</code></a><a href="#fn76" class="footnote-ref" id="fnref76" role="doc-noteref"><sup s__="13" d__="">76</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/msgctl.2"><code s__="13" d__="">msgctl()</code></a><a href="#fn77" class="footnote-ref" id="fnref77" role="doc-noteref"><sup s__="13" d__="">77</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/msgget.2"><code s__="13" d__="">msgget()</code></a><a href="#fn78" class="footnote-ref" id="fnref78" role="doc-noteref"><sup s__="13" d__="">78</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/msgsnd.2"><code s__="13" d__="">msgsnd()</code></a><a href="#fn79" class="footnote-ref" id="fnref79" role="doc-noteref"><sup s__="13" d__="">79</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/munmap.2"><code s__="13" d__="">munmap()</code></a><a href="#fn80" class="footnote-ref" id="fnref80" role="doc-noteref"><sup s__="13" d__="">80</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/open.2"><code s__="13" d__="">open()</code></a><a href="#fn81" class="footnote-ref" id="fnref81" role="doc-noteref"><sup s__="13" d__="">81</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/pipe.2"><code s__="13" d__="">pipe()</code></a><a href="#fn82" class="footnote-ref" id="fnref82" role="doc-noteref"><sup s__="13" d__="">82</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/ps.1"><code s__="13" d__="">ps</code></a><a href="#fn83" class="footnote-ref" id="fnref83" role="doc-noteref"><sup s__="13" d__="">83</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/raise.3"><code s__="13" d__="">raise()</code></a><a href="#fn84" class="footnote-ref" id="fnref84" role="doc-noteref"><sup s__="13" d__="">84</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/read.2"><code s__="13" d__="">read()</code></a><a href="#fn85" class="footnote-ref" id="fnref85" role="doc-noteref"><sup s__="13" d__="">85</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/recv.2"><code s__="13" d__="">recv()</code></a><a href="#fn86" class="footnote-ref" id="fnref86" role="doc-noteref"><sup s__="13" d__="">86</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/semctl.2"><code s__="13" d__="">semctl()</code></a><a href="#fn87" class="footnote-ref" id="fnref87" role="doc-noteref"><sup s__="13" d__="">87</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/semget.2"><code s__="13" d__="">semget()</code></a><a href="#fn88" class="footnote-ref" id="fnref88" role="doc-noteref"><sup s__="13" d__="">88</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/semop.2"><code s__="13" d__="">semop()</code></a><a href="#fn89" class="footnote-ref" id="fnref89" role="doc-noteref"><sup s__="13" d__="">89</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/send.2"><code s__="13" d__="">send()</code></a><a href="#fn90" class="footnote-ref" id="fnref90" role="doc-noteref"><sup s__="13" d__="">90</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/shmat.2"><code s__="13" d__="">shmat()</code></a><a href="#fn91" class="footnote-ref" id="fnref91" role="doc-noteref"><sup s__="13" d__="">91</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/shmctl.2"><code s__="13" d__="">shmctl()</code></a><a href="#fn92" class="footnote-ref" id="fnref92" role="doc-noteref"><sup s__="13" d__="">92</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/shmdt.2"><code s__="13" d__="">shmdt()</code></a><a href="#fn93" class="footnote-ref" id="fnref93" role="doc-noteref"><sup s__="13" d__="">93</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/shmget.2"><code s__="13" d__="">shmget()</code></a><a href="#fn94" class="footnote-ref" id="fnref94" role="doc-noteref"><sup s__="13" d__="">94</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/sigaction.2"><code s__="13" d__="">sigaction()</code></a><a href="#fn95" class="footnote-ref" id="fnref95" role="doc-noteref"><sup s__="13" d__="">95</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/signal.2"><code s__="13" d__="">signal()</code></a><a href="#fn96" class="footnote-ref" id="fnref96" role="doc-noteref"><sup s__="13" d__="">96</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/signal.7" d__="">signals</a><a href="#fn97" class="footnote-ref" id="fnref97" role="doc-noteref"><sup s__="13" d__="">97</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/sigpending.2"><code s__="13" d__="">sigpending()</code></a><a href="#fn98" class="footnote-ref" id="fnref98" role="doc-noteref"><sup s__="13" d__="">98</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/sigprocmask.2"><code s__="13" d__="">sigprocmask()</code></a><a href="#fn99" class="footnote-ref" id="fnref99" role="doc-noteref"><sup s__="13" d__="">99</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/sigsetopts.2" d__="">sigsetops</a><a href="#fn100" class="footnote-ref" id="fnref100" role="doc-noteref"><sup s__="13" d__="">100</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/sigsuspend.2"><code s__="13" d__="">sigsuspend()</code></a><a href="#fn101" class="footnote-ref" id="fnref101" role="doc-noteref"><sup s__="13" d__="">101</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/socket.2"><code s__="13" d__="">socket()</code></a><a href="#fn102" class="footnote-ref" id="fnref102" role="doc-noteref"><sup s__="13" d__="">102</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/socketpair.2"><code s__="13" d__="">socketpair()</code></a><a href="#fn103" class="footnote-ref" id="fnref103" role="doc-noteref"><sup s__="13" d__="">103</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/stat.2"><code s__="13" d__="">stat()</code></a><a href="#fn104" class="footnote-ref" id="fnref104" role="doc-noteref"><sup s__="13" d__="">104</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/wait.2"><code s__="13" d__="">wait()</code></a><a href="#fn105" class="footnote-ref" id="fnref105" role="doc-noteref"><sup s__="13" d__="">105</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/waitpid.2"><code s__="13" d__="">waitpid()</code></a><a href="#fn106" class="footnote-ref" id="fnref106" role="doc-noteref"><sup s__="13" d__="">106</sup></a>,</li>
<li d__=""><a href="https://man.archlinux.org/man/write.2"><code s__="13" d__="">write()</code></a><a href="#fn107" class="footnote-ref" id="fnref107" role="doc-noteref"><sup s__="13" d__="">107</sup></a>.</li>
</ul>
<aside id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p d__="">https://beej.us/guide/bgnet<a href="#fnref1" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn2"><p d__="">https://beej.us/guide/bgipc<a href="#fnref2" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn3"><p d__="">https://beej.us/guide/bgipc/source/examples/fork1.c<a href="#fnref3" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn4"><p d__="">https://beej.us/guide/bgipc/source/examples/sigint.c<a href="#fnref4" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn5"><p d__="">https://beej.us/guide/bgipc/source/examples/sigusr.c<a href="#fnref5" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn6"><p d__="">https://man.archlinux.org/man/sigaction.2<a href="#fnref6" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn7"><p d__="">https://man.archlinux.org/man/sigwait.3<a href="#fnref7" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn8"><p d__="">https://man.archlinux.org/man/sigwaitinfo.2<a href="#fnref8" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn9"><p d__="">https://man.archlinux.org/man/sigtimedwait.2<a href="#fnref9" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn10"><p d__="">https://man.archlinux.org/man/sigsuspend.2<a href="#fnref10" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn11"><p d__="">https://man.archlinux.org/man/sigpending.2<a href="#fnref11" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn12"><p d__="">https://man.archlinux.org/man/kill.2<a href="#fnref12" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn13"><p d__="">https://man.archlinux.org/man/raise.3<a href="#fnref13" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn14"><p d__="">https://man.archlinux.org/man/sigqueue.3<a href="#fnref14" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn15"><p d__="">https://man.archlinux.org/man/sigemptyset.3<a href="#fnref15" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn16"><p d__="">https://man.archlinux.org/man/sigfillset.3<a href="#fnref16" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn17"><p d__="">https://man.archlinux.org/man/sigaddset.3<a href="#fnref17" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn18"><p d__="">https://man.archlinux.org/man/sigdelset.3<a href="#fnref18" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn19"><p d__="">https://man.archlinux.org/man/sigismember.3<a href="#fnref19" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn20"><p d__="">https://man.archlinux.org/man/sigprocmask.2<a href="#fnref20" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn21"><p d__="">https://man.archlinux.org/man/sigaltstack.2<a href="#fnref21" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn22"><p d__="">https://man.archlinux.org/man/siginterrupt.3<a href="#fnref22" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn23"><p d__="">https://man.archlinux.org/man/sigsetjmp.3<a href="#fnref23" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn24"><p d__="">https://man.archlinux.org/man/siglongjmp.3<a href="#fnref24" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn25"><p d__="">https://man.archlinux.org/man/signal.2<a href="#fnref25" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn26"><p d__="">https://beej.us/guide/bgipc/source/examples/pipe1.c<a href="#fnref26" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn27"><p d__="">https://beej.us/guide/bgipc/source/examples/pipe2.c<a href="#fnref27" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn28"><p d__="">https://beej.us/guide/bgipc/source/examples/pipe3.c<a href="#fnref28" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn29"><p d__="">https://beej.us/guide/bgipc/source/examples/speak.c<a href="#fnref29" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn30"><p d__="">https://beej.us/guide/bgipc/source/examples/tick.c<a href="#fnref30" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn31"><p d__="">https://beej.us/guide/bgipc/source/examples/lockdemo.c<a href="#fnref31" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn32"><p d__="">https://beej.us/guide/bgipc/source/examples/kirk.c<a href="#fnref32" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn33"><p d__="">https://beej.us/guide/bgipc/source/examples/spock.c<a href="#fnref33" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn34"><p d__="">https://beej.us/guide/bgipc/source/examples/semdemo.c<a href="#fnref34" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn35"><p d__="">https://beej.us/guide/bgipc/source/examples/semdemo.c<a href="#fnref35" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn36"><p d__="">https://beej.us/guide/bgipc/source/examples/semrm.c<a href="#fnref36" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn37"><p d__="">Or whatever the current addictive FPS game is these days.<a href="#fnref37" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn38"><p d__="">https://en.wikipedia.org/wiki/Concurrency<a href="#fnref38" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn39"><p d__="">https://beej.us/guide/bgipc/source/examples/shmdemo.c<a href="#fnref39" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn40"><p d__="">https://beej.us/guide/bgipc/source/examples/mmapdemo.c<a href="#fnref40" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn41"><p d__="">https://beej.us/guide/bgnet<a href="#fnref41" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn42"><p d__="">https://beej.us/guide/bgnet<a href="#fnref42" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn43"><p d__="">https://beej.us/guide/bgnet<a href="#fnref43" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn44"><p d__="">https://man.archlinux.org/man/shutdown.2<a href="#fnref44" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn45"><p d__="">https://beej.us/guide/bgipc/source/examples/echos.c<a href="#fnref45" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn46"><p d__="">https://beej.us/guide/bgipc/source/examples/echoc.c<a href="#fnref46" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn47"><p d__="">https://beej.us/guide/bgipc/source/examples/spair.c<a href="#fnref47" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn48"><p d__="">https://beej.us/guide/url/unixdesign<a href="#fnref48" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn49"><p d__="">https://beej.us/guide/url/unixnet1<a href="#fnref49" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn50"><p d__="">https://beej.us/guide/url/unixnet2<a href="#fnref50" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn51"><p d__="">https://beej.us/guide/url/advunix<a href="#fnref51" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn52"><p d__="">http://www.kohala.com/start/unpv22e/unpv22e.html<a href="#fnref52" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn53"><p d__="">http://tldp.org/LDP/lpg/node7.html<a href="#fnref53" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn54"><p d__="">https://users.cs.cf.ac.uk/Dave.Marshall/C/<a href="#fnref54" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn55"><p d__="">https://tldp.org/LDP/tlk/ipc/ipc.html<a href="#fnref55" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn56"><p d__="">https://man.archlinux.org/man/accept.2<a href="#fnref56" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn57"><p d__="">https://man.archlinux.org/man/bind.2<a href="#fnref57" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn58"><p d__="">https://man.archlinux.org/man/connect.2<a href="#fnref58" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn59"><p d__="">https://man.archlinux.org/man/dup.2<a href="#fnref59" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn60"><p d__="">https://man.archlinux.org/man/exec.2<a href="#fnref60" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn61"><p d__="">https://man.archlinux.org/man/exit.2<a href="#fnref61" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn62"><p d__="">https://man.archlinux.org/man/fcntl.2<a href="#fnref62" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn63"><p d__="">https://man.archlinux.org/man/fileno.3<a href="#fnref63" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn64"><p d__="">https://man.archlinux.org/man/fork.2<a href="#fnref64" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn65"><p d__="">https://man.archlinux.org/man/ftok.3<a href="#fnref65" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn66"><p d__="">https://man.archlinux.org/man/getpagesize.2<a href="#fnref66" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn67"><p d__="">https://man.archlinux.org/man/ipcrm.8<a href="#fnref67" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn68"><p d__="">https://man.archlinux.org/man/ipcs.8<a href="#fnref68" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn69"><p d__="">https://man.archlinux.org/man/kill.1<a href="#fnref69" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn70"><p d__="">https://man.archlinux.org/man/kill.2<a href="#fnref70" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn71"><p d__="">https://man.archlinux.org/man/listen.2<a href="#fnref71" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn72"><p d__="">https://man.archlinux.org/man/lockf.2<a href="#fnref72" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn73"><p d__="">https://man.archlinux.org/man/lseek.2<a href="#fnref73" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn74"><p d__="">https://man.archlinux.org/man/mknod.1<a href="#fnref74" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn75"><p d__="">https://man.archlinux.org/man/mknod.2<a href="#fnref75" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn76"><p d__="">https://man.archlinux.org/man/mmap.2<a href="#fnref76" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn77"><p d__="">https://man.archlinux.org/man/msgctl.2<a href="#fnref77" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn78"><p d__="">https://man.archlinux.org/man/msgget.2<a href="#fnref78" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn79"><p d__="">https://man.archlinux.org/man/msgsnd.2<a href="#fnref79" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn80"><p d__="">https://man.archlinux.org/man/munmap.2<a href="#fnref80" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn81"><p d__="">https://man.archlinux.org/man/open.2<a href="#fnref81" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn82"><p d__="">https://man.archlinux.org/man/pipe.2<a href="#fnref82" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn83"><p d__="">https://man.archlinux.org/man/ps.1<a href="#fnref83" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn84"><p d__="">https://man.archlinux.org/man/raise.3<a href="#fnref84" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn85"><p d__="">https://man.archlinux.org/man/read.2<a href="#fnref85" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn86"><p d__="">https://man.archlinux.org/man/recv.2<a href="#fnref86" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn87"><p d__="">https://man.archlinux.org/man/semctl.2<a href="#fnref87" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn88"><p d__="">https://man.archlinux.org/man/semget.2<a href="#fnref88" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn89"><p d__="">https://man.archlinux.org/man/semop.2<a href="#fnref89" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn90"><p d__="">https://man.archlinux.org/man/send.2<a href="#fnref90" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn91"><p d__="">https://man.archlinux.org/man/shmat.2<a href="#fnref91" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn92"><p d__="">https://man.archlinux.org/man/shmctl.2<a href="#fnref92" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn93"><p d__="">https://man.archlinux.org/man/shmdt.2<a href="#fnref93" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn94"><p d__="">https://man.archlinux.org/man/shmget.2<a href="#fnref94" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn95"><p d__="">https://man.archlinux.org/man/sigaction.2<a href="#fnref95" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn96"><p d__="">https://man.archlinux.org/man/signal.2<a href="#fnref96" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn97"><p d__="">https://man.archlinux.org/man/signal.7<a href="#fnref97" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn98"><p d__="">https://man.archlinux.org/man/sigpending.2<a href="#fnref98" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn99"><p d__="">https://man.archlinux.org/man/sigprocmask.2<a href="#fnref99" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn100"><p d__="">https://man.archlinux.org/man/sigsetopts.2<a href="#fnref100" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn101"><p d__="">https://man.archlinux.org/man/sigsuspend.2<a href="#fnref101" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn102"><p d__="">https://man.archlinux.org/man/socket.2<a href="#fnref102" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn103"><p d__="">https://man.archlinux.org/man/socketpair.2<a href="#fnref103" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn104"><p d__="">https://man.archlinux.org/man/stat.2<a href="#fnref104" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn105"><p d__="">https://man.archlinux.org/man/wait.2<a href="#fnref105" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn106"><p d__="">https://man.archlinux.org/man/waitpid.2<a href="#fnref106" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
<li id="fn107"><p d__="">https://man.archlinux.org/man/write.2<a href="#fnref107" class="footnote-back" role="doc-backlink" d__="">↩︎</a></p></li>
</ol>
</aside>


</body><iframe class="cleanslate hidden" src="Beej's%20Guide%20to%20Interprocess%20Communication_files/commandline.html" id="cmdline_iframe" loading="lazy" style="height: 0px !important;"></iframe></html>